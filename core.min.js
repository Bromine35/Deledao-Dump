(function(){var k;function ba(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function t(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:ba(a)}}function ca(a){if(!(a instanceof Array)){a=t(a);for(var b,c=[];!(b=a.next()).done;)c.push(b.value);a=c}return a}
var da="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},ea="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
function fa(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var ia=fa(this);function ja(a,b){if(b)a:{var c=ia;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&ea(c,a,{configurable:!0,writable:!0,value:b})}}var ka;
if("function"==typeof Object.setPrototypeOf)ka=Object.setPrototypeOf;else{var oa;a:{var pa={a:!0},qa={};try{qa.__proto__=pa;oa=qa.a;break a}catch(a){}oa=!1}ka=oa?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ra=ka;
function x(a,b){a.prototype=da(b.prototype);a.prototype.constructor=a;if(ra)ra(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.Ly=b.prototype}function sa(){this.J=!1;this.o=null;this.j=void 0;this.h=1;this.v=this.D=0;this.aa=this.l=null}function ta(a){if(a.J)throw new TypeError("Generator is already running");a.J=!0}sa.prototype.S=function(a){this.j=a};
function ua(a,b){a.l={Yo:b,up:!0};a.h=a.D||a.v}sa.prototype.return=function(a){this.l={return:a};this.h=this.v};function y(a,b,c){a.h=c;return{value:b}}sa.prototype.m=function(a){this.h=a};function A(a){a.h=0}function C(a,b,c){a.D=b;void 0!=c&&(a.v=c)}function F(a,b,c){a.h=b;a.D=c||0}function H(a,b){a.D=b||0;b=a.l.Yo;a.l=null;return b}function va(a){a.aa=[a.l];a.D=0;a.v=0}
function wa(a,b){var c=a.aa.splice(0)[0];(c=a.l=a.l||c)?c.up?a.h=a.D||a.v:void 0!=c.m&&a.v<c.m?(a.h=c.m,a.l=null):a.h=a.v:a.h=b}function ya(a){this.h=new sa;this.j=a}function Aa(a,b){ta(a.h);var c=a.h.o;if(c)return Ba(a,"return"in c?c["return"]:function(d){return{value:d,done:!0}},b,a.h.return);a.h.return(b);return Ca(a)}
function Ba(a,b,c,d){try{var e=b.call(a.h.o,c);if(!(e instanceof Object))throw new TypeError("Iterator result "+e+" is not an object");if(!e.done)return a.h.J=!1,e;var f=e.value}catch(g){return a.h.o=null,ua(a.h,g),Ca(a)}a.h.o=null;d.call(a.h,f);return Ca(a)}function Ca(a){for(;a.h.h;)try{var b=a.j(a.h);if(b)return a.h.J=!1,{value:b.value,done:!1}}catch(c){a.h.j=void 0,ua(a.h,c)}a.h.J=!1;if(a.h.l){b=a.h.l;a.h.l=null;if(b.up)throw b.Yo;return{value:b.return,done:!0}}return{value:void 0,done:!0}}
function Fa(a){this.next=function(b){ta(a.h);a.h.o?b=Ba(a,a.h.o.next,b,a.h.S):(a.h.S(b),b=Ca(a));return b};this.throw=function(b){ta(a.h);a.h.o?b=Ba(a,a.h.o["throw"],b,a.h.S):(ua(a.h,b),b=Ca(a));return b};this.return=function(b){return Aa(a,b)};this[Symbol.iterator]=function(){return this}}function Ga(a){function b(d){return a.next(d)}function c(d){return a.throw(d)}return new Promise(function(d,e){function f(g){g.done?d(g.value):Promise.resolve(g.value).then(b,c).then(f,e)}f(a.next())})}
function J(a){return Ga(new Fa(new ya(a)))}ja("Reflect",function(a){return a?a:{}});ja("Symbol",function(a){function b(f){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new c(d+(f||"")+"_"+e++,f)}function c(f,g){this.h=f;ea(this,"description",{configurable:!0,writable:!0,value:g})}if(a)return a;c.prototype.toString=function(){return this.h};var d="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",e=0;return b});
ja("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=ia[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&ea(d.prototype,a,{configurable:!0,writable:!0,value:function(){return Ha(ba(this))}})}return a});function Ha(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
ja("Promise",function(a){function b(g){this.j=0;this.l=void 0;this.h=[];this.J=!1;var h=this.o();try{g(h.resolve,h.reject)}catch(l){h.reject(l)}}function c(){this.h=null}function d(g){return g instanceof b?g:new b(function(h){h(g)})}if(a)return a;c.prototype.j=function(g){if(null==this.h){this.h=[];var h=this;this.l(function(){h.v()})}this.h.push(g)};var e=ia.setTimeout;c.prototype.l=function(g){e(g,0)};c.prototype.v=function(){for(;this.h&&this.h.length;){var g=this.h;this.h=[];for(var h=0;h<g.length;++h){var l=
g[h];g[h]=null;try{l()}catch(m){this.o(m)}}}this.h=null};c.prototype.o=function(g){this.l(function(){throw g;})};b.prototype.o=function(){function g(m){return function(n){l||(l=!0,m.call(h,n))}}var h=this,l=!1;return{resolve:g(this.qb),reject:g(this.v)}};b.prototype.qb=function(g){if(g===this)this.v(new TypeError("A Promise cannot resolve to itself"));else if(g instanceof b)this.nc(g);else{a:switch(typeof g){case "object":var h=null!=g;break a;case "function":h=!0;break a;default:h=!1}h?this.ya(g):
this.D(g)}};b.prototype.ya=function(g){var h=void 0;try{h=g.then}catch(l){this.v(l);return}"function"==typeof h?this.Bc(h,g):this.D(g)};b.prototype.v=function(g){this.S(2,g)};b.prototype.D=function(g){this.S(1,g)};b.prototype.S=function(g,h){if(0!=this.j)throw Error("Cannot settle("+g+", "+h+"): Promise already settled in state"+this.j);this.j=g;this.l=h;2===this.j&&this.Rb();this.aa()};b.prototype.Rb=function(){var g=this;e(function(){if(g.ga()){var h=ia.console;"undefined"!==typeof h&&h.error(g.l)}},
1)};b.prototype.ga=function(){if(this.J)return!1;var g=ia.CustomEvent,h=ia.Event,l=ia.dispatchEvent;if("undefined"===typeof l)return!0;"function"===typeof g?g=new g("unhandledrejection",{cancelable:!0}):"function"===typeof h?g=new h("unhandledrejection",{cancelable:!0}):(g=ia.document.createEvent("CustomEvent"),g.initCustomEvent("unhandledrejection",!1,!0,g));g.promise=this;g.reason=this.l;return l(g)};b.prototype.aa=function(){if(null!=this.h){for(var g=0;g<this.h.length;++g)f.j(this.h[g]);this.h=
null}};var f=new c;b.prototype.nc=function(g){var h=this.o();g.lj(h.resolve,h.reject)};b.prototype.Bc=function(g,h){var l=this.o();try{g.call(h,l.resolve,l.reject)}catch(m){l.reject(m)}};b.prototype.then=function(g,h){function l(u,r){return"function"==typeof u?function(p){try{m(u(p))}catch(v){n(v)}}:r}var m,n,q=new b(function(u,r){m=u;n=r});this.lj(l(g,m),l(h,n));return q};b.prototype.catch=function(g){return this.then(void 0,g)};b.prototype.lj=function(g,h){function l(){switch(m.j){case 1:g(m.l);
break;case 2:h(m.l);break;default:throw Error("Unexpected state: "+m.j);}}var m=this;null==this.h?f.j(l):this.h.push(l);this.J=!0};b.resolve=d;b.reject=function(g){return new b(function(h,l){l(g)})};b.race=function(g){return new b(function(h,l){for(var m=t(g),n=m.next();!n.done;n=m.next())d(n.value).lj(h,l)})};b.all=function(g){var h=t(g),l=h.next();return l.done?d([]):new b(function(m,n){function q(p){return function(v){u[p]=v;r--;0==r&&m(u)}}var u=[],r=0;do u.push(void 0),r++,d(l.value).lj(q(u.length-
1),n),l=h.next();while(!l.done)})};return b});function Ia(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""}
ja("String.prototype.startsWith",function(a){return a?a:function(b,c){var d=Ia(this,b,"startsWith"),e=d.length,f=b.length;c=Math.max(0,Math.min(c|0,d.length));for(var g=0;g<f&&c<e;)if(d[c++]!=b[g++])return!1;return g>=f}});ja("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}});
ja("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=d[c];if(f===b||Object.is(f,b))return!0}return!1}});ja("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==Ia(this,b,"includes").indexOf(b,c||0)}});function Ja(a,b){return Object.prototype.hasOwnProperty.call(a,b)}
var Ka="function"==typeof Object.assign?Object.assign:function(a,b){for(var c=1;c<arguments.length;c++){var d=arguments[c];if(d)for(var e in d)Ja(d,e)&&(a[e]=d[e])}return a};ja("Object.assign",function(a){return a||Ka});ja("String.prototype.endsWith",function(a){return a?a:function(b,c){var d=Ia(this,b,"endsWith");void 0===c&&(c=d.length);c=Math.max(0,Math.min(c|0,d.length));for(var e=b.length;0<e&&0<c;)if(d[--c]!=b[--e])return!1;return 0>=e}});
function Ma(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e}ja("Array.prototype.keys",function(a){return a?a:function(){return Ma(this,function(b){return b})}});
ja("Promise.prototype.finally",function(a){return a?a:function(b){return this.then(function(c){return Promise.resolve(b()).then(function(){return c})},function(c){return Promise.resolve(b()).then(function(){throw c;})})}});
ja("WeakMap",function(a){function b(l){this.h=(h+=Math.random()+1).toString();if(l){l=t(l);for(var m;!(m=l.next()).done;)m=m.value,this.set(m[0],m[1])}}function c(){}function d(l){var m=typeof l;return"object"===m&&null!==l||"function"===m}function e(l){if(!Ja(l,g)){var m=new c;ea(l,g,{value:m})}}function f(l){var m=Object[l];m&&(Object[l]=function(n){if(n instanceof c)return n;Object.isExtensible(n)&&e(n);return m(n)})}if(function(){if(!a||!Object.seal)return!1;try{var l=Object.seal({}),m=Object.seal({}),
n=new a([[l,2],[m,3]]);if(2!=n.get(l)||3!=n.get(m))return!1;n.delete(l);n.set(m,4);return!n.has(l)&&4==n.get(m)}catch(q){return!1}}())return a;var g="$jscomp_hidden_"+Math.random();f("freeze");f("preventExtensions");f("seal");var h=0;b.prototype.set=function(l,m){if(!d(l))throw Error("Invalid WeakMap key");e(l);if(!Ja(l,g))throw Error("WeakMap key fail: "+l);l[g][this.h]=m;return this};b.prototype.get=function(l){return d(l)&&Ja(l,g)?l[g][this.h]:void 0};b.prototype.has=function(l){return d(l)&&Ja(l,
g)&&Ja(l[g],this.h)};b.prototype.delete=function(l){return d(l)&&Ja(l,g)&&Ja(l[g],this.h)?delete l[g][this.h]:!1};return b});
ja("Map",function(a){function b(){var h={};return h.previous=h.next=h.head=h}function c(h,l){var m=h.h;return Ha(function(){if(m){for(;m.head!=h.h;)m=m.previous;for(;m.next!=m.head;)return m=m.next,{done:!1,value:l(m)};m=null}return{done:!0,value:void 0}})}function d(h,l){var m=l&&typeof l;"object"==m||"function"==m?f.has(l)?m=f.get(l):(m=""+ ++g,f.set(l,m)):m="p_"+l;var n=h.j[m];if(n&&Ja(h.j,m))for(h=0;h<n.length;h++){var q=n[h];if(l!==l&&q.key!==q.key||l===q.key)return{id:m,list:n,index:h,entry:q}}return{id:m,
list:n,index:-1,entry:void 0}}function e(h){this.j={};this.h=b();this.size=0;if(h){h=t(h);for(var l;!(l=h.next()).done;)l=l.value,this.set(l[0],l[1])}}if(function(){if(!a||"function"!=typeof a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var h=Object.seal({x:4}),l=new a(t([[h,"s"]]));if("s"!=l.get(h)||1!=l.size||l.get({x:4})||l.set({x:4},"t")!=l||2!=l.size)return!1;var m=l.entries(),n=m.next();if(n.done||n.value[0]!=h||"s"!=n.value[1])return!1;n=m.next();return n.done||4!=n.value[0].x||
"t"!=n.value[1]||!m.next().done?!1:!0}catch(q){return!1}}())return a;var f=new WeakMap;e.prototype.set=function(h,l){h=0===h?0:h;var m=d(this,h);m.list||(m.list=this.j[m.id]=[]);m.entry?m.entry.value=l:(m.entry={next:this.h,previous:this.h.previous,head:this.h,key:h,value:l},m.list.push(m.entry),this.h.previous.next=m.entry,this.h.previous=m.entry,this.size++);return this};e.prototype.delete=function(h){h=d(this,h);return h.entry&&h.list?(h.list.splice(h.index,1),h.list.length||delete this.j[h.id],
h.entry.previous.next=h.entry.next,h.entry.next.previous=h.entry.previous,h.entry.head=null,this.size--,!0):!1};e.prototype.clear=function(){this.j={};this.h=this.h.previous=b();this.size=0};e.prototype.has=function(h){return!!d(this,h).entry};e.prototype.get=function(h){return(h=d(this,h).entry)&&h.value};e.prototype.entries=function(){return c(this,function(h){return[h.key,h.value]})};e.prototype.keys=function(){return c(this,function(h){return h.key})};e.prototype.values=function(){return c(this,
function(h){return h.value})};e.prototype.forEach=function(h,l){for(var m=this.entries(),n;!(n=m.next()).done;)n=n.value,h.call(l,n[1],n[0],this)};e.prototype[Symbol.iterator]=e.prototype.entries;var g=0;return e});ja("Array.prototype.entries",function(a){return a?a:function(){return Ma(this,function(b,c){return[b,c]})}});ja("Object.entries",function(a){return a?a:function(b){var c=[],d;for(d in b)Ja(b,d)&&c.push([d,b[d]]);return c}});
ja("Array.from",function(a){return a?a:function(b,c,d){c=null!=c?c:function(h){return h};var e=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof f){b=f.call(b);for(var g=0;!(f=b.next()).done;)e.push(c.call(d,f.value,g++))}else for(f=b.length,g=0;g<f;g++)e.push(c.call(d,b[g],g));return e}});ja("Array.prototype.values",function(a){return a?a:function(){return Ma(this,function(b,c){return c})}});ja("Number.parseInt",function(a){return a||parseInt});
ja("Number.isNaN",function(a){return a?a:function(b){return"number"===typeof b&&isNaN(b)}});
ja("Set",function(a){function b(c){this.h=new Map;if(c){c=t(c);for(var d;!(d=c.next()).done;)this.add(d.value)}this.size=this.h.size}if(function(){if(!a||"function"!=typeof a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var c=Object.seal({x:4}),d=new a(t([c]));if(!d.has(c)||1!=d.size||d.add(c)!=d||1!=d.size||d.add({x:4})!=d||2!=d.size)return!1;var e=d.entries(),f=e.next();if(f.done||f.value[0]!=c||f.value[1]!=c)return!1;f=e.next();return f.done||f.value[0]==c||4!=f.value[0].x||
f.value[1]!=f.value[0]?!1:e.next().done}catch(g){return!1}}())return a;b.prototype.add=function(c){c=0===c?0:c;this.h.set(c,c);this.size=this.h.size;return this};b.prototype.delete=function(c){c=this.h.delete(c);this.size=this.h.size;return c};b.prototype.clear=function(){this.h.clear();this.size=0};b.prototype.has=function(c){return this.h.has(c)};b.prototype.entries=function(){return this.h.entries()};b.prototype.values=function(){return this.h.values()};b.prototype.keys=b.prototype.values;b.prototype[Symbol.iterator]=
b.prototype.values;b.prototype.forEach=function(c,d){var e=this;this.h.forEach(function(f){return c.call(d,f,f,e)})};return b});ja("Array.prototype.find",function(a){return a?a:function(b,c){a:{var d=this;d instanceof String&&(d=String(d));for(var e=d.length,f=0;f<e;f++){var g=d[f];if(b.call(c,g,f,d)){b=g;break a}}b=void 0}return b}});
ja("Object.fromEntries",function(a){return a?a:function(b){var c={};if(!(Symbol.iterator in b))throw new TypeError(""+b+" is not iterable");b=b[Symbol.iterator].call(b);for(var d=b.next();!d.done;d=b.next()){d=d.value;if(Object(d)!==d)throw new TypeError("iterable for fromEntries should yield objects");c[d[0]]=d[1]}return c}});ja("Reflect.getOwnPropertyDescriptor",function(a){return a||Object.getOwnPropertyDescriptor});ja("Reflect.getPrototypeOf",function(a){return a||Object.getPrototypeOf});
ja("Reflect.get",function(a){return a?a:function(b,c,d){if(2>=arguments.length)return b[c];var e;a:{for(e=b;e;){var f=Reflect.getOwnPropertyDescriptor(e,c);if(f){e=f;break a}e=Reflect.getPrototypeOf(e)}e=void 0}if(e)return e.get?e.get.call(d):e.value}});ja("Object.values",function(a){return a?a:function(b){var c=[],d;for(d in b)Ja(b,d)&&c.push(b[d]);return c}});
ja("Array.prototype.fill",function(a){return a?a:function(b,c,d){var e=this.length||0;0>c&&(c=Math.max(0,e+c));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(c=Number(c||0);c<d;c++)this[c]=b;return this}});function Na(a){return a?a:Array.prototype.fill}ja("Int8Array.prototype.fill",Na);ja("Uint8Array.prototype.fill",Na);ja("Uint8ClampedArray.prototype.fill",Na);ja("Int16Array.prototype.fill",Na);ja("Uint16Array.prototype.fill",Na);ja("Int32Array.prototype.fill",Na);
ja("Uint32Array.prototype.fill",Na);ja("Float32Array.prototype.fill",Na);ja("Float64Array.prototype.fill",Na);ja("String.prototype.repeat",function(a){return a?a:function(b){var c=Ia(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var d="";b;)if(b&1&&(d+=c),b>>>=1)c+=c;return d}});
ja("String.prototype.padEnd",function(a){return a?a:function(b,c){var d=Ia(this,null,"padStart");b-=d.length;c=void 0!==c?String(c):" ";c=0<b&&c?c.repeat(Math.ceil(b/c.length)).substring(0,b):"";return d+c}});ja("String.prototype.trimLeft",function(a){function b(){return this.replace(/^[\s\xa0]+/,"")}return a||b});ja("String.prototype.trimStart",function(a){return a||String.prototype.trimLeft});var Oa="deledao.com",Pa="775655569459-pnf25hlg4i8l1223e9mdq0ttvrbrnetb.apps.googleusercontent.com",Qa="8ee78a85-56aa-400c-a8e6-629280837763";try{importScripts("/util/vendor.js")}catch(a){}
var K,Q={sb:"2019.3.1.1",za:12,Mc:"/default",Ku:"",dn:"",platform:12,os:"",Hd:!1,wa:!1,Ic:!1,ce:!0,Eb:Oa,sa:!1,bi:!1,features:{},Jg:function(a){var b=!a;Q.bi&&(a={a:33,f:"2023.1.14.1",d:12,g:12,k:""});if(a){Q.sb=a.f;""!==a.k&&(Q.Mc="/"+a.k);12==a.a?Oa.startsWith("dev.")||(Oa="dev."+Oa):Q.sa=!0;[12,99].includes(a.d)&&(Q.za=a.d);a.g&&(Q.platform=a.g);77==Q.platform&&(Q.platform=99,Q.os="android");switch(Q.platform){case 33:Q.wa=!0;break;case 99:case 88:Q.wa=!0,Q.Ic=!0,Q.ce=!1}b||(Q.Hd=!0)}else Oa.startsWith("dev.")||
(Oa="dev."+Oa);Q.wa&&(Q.Di=!0);Q.sa||(Pa="359396887564-m7cscdj5ab7gi49d6qldbuda8sttcrn2.apps.googleusercontent.com",Qa="20366fa6-3e09-4f98-a4f0-fcecb84ebb61");Q.pt();Q.ot();Q.fh=Q.Fd[0].toUpperCase()+Q.Fd.slice(1)},Jd:"dld://",dt:"/homeblock.html",No:"/downtime.html",Zu:"/teacher/#/student-signin",Dy:"/#/register",Hr:"/GetCategory",Ir:"/GetCategoryNames",Qs:"/GetQuickStartList",Ay:"/SendViolationLogs",bv:"/UploadData",wt:"/IsImageSafe",Os:"/GetImageContent",At:"/GetTextCategory",Js:"/GetAuthToken",
Ks:"/GetAuthTokenHome",Is:"/GetAnonymousToken",Tq:"/IsTextCyberBully",Ls:"/Config/GetConfig",Ns:"/Config/GetHomeConfig",Ps:"/IsOffCampus",Rs:"/AnalyzeVideo",at:"/HomeUnblockRequest",Ew:"/BonusFunTimeRequest",Ky:"/SubmitAppleReceipt",Pi:90,Zr:0,Vb:2,px:118,jx:121,xx:5E3,$r:60,Ql:86400,Qa:"1",Pa:"2",ea:"3",Oj:"http://",yx:"https://",rv:"violation_logs",cp:"flagged_events",Cu:"debug_logs",zw:"blackList",dz:"whiteList",zv:"BlockAds",Dv:"BlockTracking",lw:"YoutubeFiltering",Kv:"ClickToZoom",Qv:"GoogleSafeSearch",
Bv:"BlockGGTracking",Cv:"BlockLocalStorage",Ev:"blockingPage",Pv:"gsuitegroup",Wq:"auth.oumap",Vk:"/default",Gq:!1,Lv:!1,Rq:!1,Dq:!1,Fq:!1,ar:!1,Hq:!1,Pd:"Anonymous",qd:"anonymous",mx:"facebook.com",pt:function(){Object.assign(Q,{Fd:"deledao",mu:"com.deledao",xi:"https://static."+Oa,Fa:"https://static."+Oa+Q.Mc,kf:"https://static."+Oa+Q.Vk,Yb:"https://cc."+Oa,oc:"https://auth."+Oa,Gt:"https://up."+Oa,su:"https://portals."+Oa+Q.dn,rl:"/blockCom.html",Bw:"/blockClass.html",jm:"https://im."+Oa,Yu:"https://tx."+
Oa,Vt:"https://tx."+Oa,ei:"https://static."+Oa+"/mobile",zm:"https://static."+Q.Eb+"/mobile",sx:"https://static."+Oa+Q.Mc+"/homeagent.html",hm:"https://static."+Oa+Q.Mc+"/homewelcome.html",bz:"https://static."+Oa+Q.Mc+"/waitForSignIn2.html",zx:"https://static."+Oa+Q.Mc+"/iap.html",Et:"/lockdown.html"});88==Q.platform&&(Q.sa?(Q.oc="http://auth.in.deledao.com",Q.Yb="http://cc.in.deledao.com"):(Q.oc="http://auth.dev-in.deledao.com",Q.Yb="http://cc.dev-in.deledao.com"))},ot:function(){Q.features.La={enabled:12==
Q.za&&(12==Q.platform||99==Q.platform&&"android"!=Q.os)};Q.features.proxy={zr:99==Q.platform,Dt:99==Q.za&&99==Q.platform&&"android"!=Q.os};Q.features.ra={xc:88==Q.platform||99==Q.platform&&"android"==Q.os};Q.features.Sl={enabled:99!=Q.platform||"android"!=Q.os}},Kg:function(){return 99===Q.za},vt:function(){return 99===Q.za?!0:!1},zt:function(){return 12===Q.za?!0:!1},Sj:function(){return!{nx:1}.hasOwnProperty("foobar")},Bt:function(a){return a.endsWith(Oa)||"localhost"===a?!0:!1},Cg:function(a,b){"function"==
typeof importScripts?WorkerGlobalScope[a]=b:"undefined"!=typeof module&&module.exports?global[a]=b:window[a]=b},Bx:function(a){if("function"==typeof importScripts){var b=WorkerGlobalScope[a];WorkerGlobalScope[a]=void 0}else"undefined"!=typeof module&&module.exports?(b=global[a],global[a]=void 0):(b=window[a],window[a]=void 0);return b},ux:function(){return Q.Fa+"/homesetup.html"},wx:function(){return Q.Fa+"/homeCustSignIn.html"},vx:function(){return Q.Fa+"/signup.html"},rr:function(){return Q.oc+
"/GetAuthWhiteList"},$s:function(){return Q.Fa+"/homeCustSignIn.html"},bt:function(){return Q.Fa+"/homeSignIn.html"},Tx:function(){return Q.Fa+"/mindex.html"},Ux:function(){return Q.Fa+"/mhomeplan.html"},wu:function(){return Q.Fa+"/qr.html"},bs:function(){return Q.kf+"/qr.html"},wo:function(){return Q.Fa+"/chat.html"},Ts:function(a){return a!==Q.Vk?"https://"+Q.Mc+"."+Oa+Q.dn:Q.su}};function Ra(){this.h={};this.j=[]}var Ta;Ra.prototype.addListener=function(a,b){if(b&&0!=b.length){b=t(b);for(var c=b.next();!c.done;c=b.next())c=c.value,this.h[c]||(this.h[c]=[]),this.h[c].push(a)}else this.j.push(a)};Ra.prototype.removeListener=function(a){var b=!1,c=this.j.indexOf(a);-1!=c&&(b=!0,this.j.splice(c,1));for(var d in this.h){var e=this.h[d];c=e.indexOf(a);-1!=c&&(b=!0,e.splice(c,1))}return b};
Ra.prototype.sendMessage=function(a){var b=this.h[a.type]||[];b=b.concat(this.j);b=t(b);for(var c=b.next();!c.done;c=b.next()){c=c.value;try{c(a)}catch(d){K.warn("While dispatching "+a.type+" event: "+d),K.warn(d.stack)}}};Ra.prototype.destroy=function(){this.h={};this.j=[]};function S(a,b,c,d){this.debug=!1;this.j=void 0===b?"Obfuscator":b;this.l=void 0===c?!1:c;this.o=void 0===d?!1:d;this.v=a;this.h={};for(var e in a)this.h[a[e]]=e}
S.prototype.translate=function(a,b){if(null===b||void 0===b)var c=b;else if(Array.isArray(b)){c=[];for(var d=0;d<b.length;d++)c.push(this.translate(a,b[d]))}else if("object"===typeof b)if(c={},0==Object.keys(b).length)c=b;else for(d in b){var e=a[d];e?c[e]=this.translate(a,b[d]):this.l?(c[d]=this.translate(a,b[d]),this.o&&this.debug&&K.warn("Obfuscator: allow missing prop "+d+"; "+this.j)):(e="Obfuscator: cannot find mapping for "+d+"; "+this.j+", value="+JSON.stringify(b[d]),"undefined"!=typeof Ua&&
Va?Wa(e):K.error(e),c[d]=this.translate(a,b[d]))}else c=b;return c};function U(a,b){return a.translate(a.h,b)}function Xa(a,b){return a.translate(a.v,b)}
function Ya(){S.call(this,{W:"attachments",G:"auth",ko:"authMethod",td:"cat",T:"category",Nr:"cookieExp",data:"data",debug:"debug",Da:"desc",duration:"duration",tc:"eventType",from:"from",Af:"imageBlurredInfo",images:"images",jt:"iat",Pj:"immutable",vp:"isFamily",yp:"issuedAt",name:"name",Ba:"pageTitle",recipient:"recipient",ta:"sections",Nb:"sid",kb:"ses",timestamp:"timestamp",oe:"to",type:"type",url:"url",Z:"userId",un:"validUntil",value:"value",ov:"ver",A:"verbose",Ve:"videoBlurredInfo",We:"videoSrc"},
"GlobalObfusctor")}x(Ya,S);var Za=new Ya;function $a(){S.call(this,{Vy:"useremail",G:"auth"},"GetUserInfoReqObf")}x($a,S);new $a;function ab(){S.call(this,{Nn:"Ou",Ac:"Email",O:"Name",il:"UserToken",Ah:"UserId",fg:"Groups",Error:"Error"},"GetUserInfoRespObf")}x(ab,S);var bb=new ab;
function cb(){S.call(this,{name:"name",version:"version",inputs:"inputs",zl:"c32",xl:"c28",Bl:"c44",Dl:"c64",El:"c96",vl:"c160",wl:"c224",yl:"c299",Al:"c331",Ja:"jpg",cm:"g32",Cl:"c480",format:"format",width:"width",height:"height",rc:"containImage",filter:"filter",Uh:"filterArg",Hh:"cloudAssistance",Gj:"engineType"},"EngineInfoObf")}x(cb,S);new cb;
function eb(){S.call(this,{hv:"userProfile",gv:"userContent",Pt:"medias",Lr:"comments",rj:"classroom",bb:"classUUID",sj:"clmTeacherId",tu:"postedByOwner",mv:"utime",sv:"violationVideo",Cr:"bullyContent",Ax:"imgMap",Qb:"videos",Ny:"texts",Zy:"violationContent",url:"url",L:"engine",label:"label",T:"category",V:"prob",time:"time",Dc:"cached",Fc:"dataUrl",mw:"actorName",content:"content",Tw:"contentNode"},"FBPostObf")}x(eb,S);new eb;
function fb(){S.call(this,{enabled:"enabled",debug:"debug",da:"blockedCats",frameId:"frameId"},"FBConfObf")}x(fb,S);new fb;function gb(){S.call(this,{recipient:"recipient",type:"type",data:"data",text:"text",options:"options",url:"url",Ba:"pageTitle",na:"trigger",context:"context",wb:"seqOnPage",Qe:"subject",Of:"recipients",body:"body",Eh:"bodyHtml",ro:"bypassTextEngine",Wf:"userIsOwner",hostname:"hostname"},"ABClassifyReqObf")}x(gb,S);var hb=new gb;
function ib(){S.call(this,{type:"type",data:"data",Ju:"seq",time:"time",result:"result",lang:"lang",label:"label",V:"prob",error:"error",text:"text",Fp:"ModelVersion",pb:"SubCategories",yb:"subCategoryInfo",id:"id",Mf:"probs"},"ABClassifyResultObf")}x(ib,S);var jb=new ib;
function kb(){S.call(this,{zl:"c32",xl:"c28",Bl:"c44",Dl:"c64",El:"c96",vl:"c160",wl:"c224",yl:"c299",Al:"c331",Ja:"jpg",cm:"g32",Cl:"c480",format:"format",width:"width",height:"height",rc:"containImage",filter:"filter",Uh:"filterArg"},"DynIAInputsObf")}x(kb,S);var lb=new kb;function mb(){S.call(this,{enabled:"enabled",Hw:"byWebpage",Dr:"byEmail",debug:"debug",jc:"skipDomains",da:"blockedCats",F:"ruleName",Rd:"ccCats",fq:"searchFilter",frameId:"frameId"},"DynTAConfRespObf")}x(mb,S);var nb=new mb;
function ob(){S.call(this,{jj:"blockAllVideos",enabled:"enabled",So:"enableCanvas",debug:"debug",tb:"devMode",Pc:"useRekog",da:"blockedCats",F:"ruleName",sampleRate:"sampleRate",ee:"maxSampleRate",Yh:"inputDefs",width:"width",height:"height",format:"format",Ja:"jpg",zl:"c32",xl:"c28",Bl:"c44",Dl:"c64",El:"c96",vl:"c160",wl:"c224",yl:"c299",Al:"c331",cm:"g32",Cl:"c480",rc:"containImage",filter:"filter",Uh:"filterArg",ny:"png",qy:"raster",canvas:"canvas",frameId:"frameId",Tm:"rekogInputDefs",Kk:"useServerAssist",
time:"time",error:"error",version:"version",frames:"frames",timestamp:"timestamp",image:"image",Dc:"cached",result:"result",label:"label",V:"prob",L:"engine",sg:"blockYoutubePreview"},"DynVAConfRespObf")}x(ob,S);var pb=new ob;function qb(){S.call(this,{recipient:"recipient",type:"type",data:"data",message:"message",ui:"sesToken",level:"level"},"FrontendLogObf")}x(qb,S);var rb=new qb;
function sb(){S.call(this,{recipient:"recipient",type:"type",data:"data",cb:"cmd",path:"path",Kx:"logNow",vm:"logAtRestart",Lh:"debugModules",Fy:"startLogging",yg:"dcmTaSensi",hf:"dcmIaSensi",jf:"dcmVaSensi"},"DebugToolCmdObf")}x(sb,S);var tb=new sb;function ub(){S.call(this,{ij:"bhr",yw:"bhrVerbose",ra:"dia",sc:"dva",Vd:"dta",vw:"atb",Rc:"ytf",ax:"dfb",frameId:"frameId"},"PageDebugStatusObf")}x(ub,S);new ub;
function vb(){S.call(this,{my:"plantCookieSites",nw:"adSites",Df:"isBlockCookie",De:"isBlockAds",data:"data"},"CookieStatusObf",!0,!0)}x(vb,S);new vb;
function wb(){S.call(this,{ow:"adblocking",sw:"antitracking",G:"auth",B:"config",Zb:"custName",Xw:"custVerified",data:"data",email:"email",error:"error",tx:"homeConfig",op:"homeMode",it:"iap",Fx:"isSetup",Jx:"localActivation",locked:"locked",qq:"transaction_id",pa:"pass",iy:"passcode",password:"password",jy:"paying",ky:"paymentProcessor",oy:"policyMode",pending:"pending",li:"prodID",ty:"receipt",recipient:"recipient",sy:"reSetup",By:"setupComplete",state:"state",rq:"transaction_receipt",type:"type",
Ty:"uploadActivity",Uy:"uploadOthers",url:"url",Z:"userId",userName:"userName",Xy:"verified",version:"version"},"HomeConfObf")}x(wb,S);new wb;
function xb(){S.call(this,{zg:"devAreaLocked",runtime:"runtime",Nx:"login",Va:"loginUserId",group:"group",ba:"ipList",version:"version",uuid:"uuid",policy:"policy",F:"ruleName",Zb:"custName",Ex:"isHomeUser",console:"console",Lx:"logging",Cy:"showLogButton",sc:"dva",N:"stats",model:"model",jf:"dcmVaSensi",ra:"dia",hf:"dcmIaSensi",debug:"debug",en:"serverPath"},"DiagInfoObf")}x(xb,S);new xb;function yb(){S.call(this,{type:"Type",details:"Details"},"ServerPushObf")}x(yb,S);var zb=new yb;
function Ab(){S.call(this,{qw:"alertFront",G:"auth",Fw:"bonusFuntime",T:"category",Xb:"catIDs",Gr:"catIDsOrg",data:"data",Ur:"dayEndTimestamp",error:"error",ok:"ok",Ba:"pageTitle",reason:"reason",recipient:"recipient",timestamp:"timestamp",Qy:"timezone",type:"type",url:"url",user:"user",Pb:"userID",version:"version"},"HomeUnblockReqObf")}x(Ab,S);var Bb=new Ab;function Cb(){}Cb.prototype.lc=function(a,b,c){for(var d=2;d<arguments.length;++d);return J(function(){throw Error("writeLog() unimplemented on abstract class");})};Cb.prototype.stop=function(){};function Db(a){this.options=a=void 0===a?{}:a;this.j=[]}var Eb;function Fb(a,b){a.j.includes(b)||a.j.push(b)}function Gb(a,b){b=a.j.indexOf(b);-1!=b&&(a.j[b].stop(),a.j.splice(b,1))}
Db.prototype.lc=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];try{d="";if(!this.options.Kp){var e=new Date;d+=e.getMonth()+1+"/"+e.getDate()+" "+e.toTimeString().split(" ")[0]+"."+e.getMilliseconds()+" "}this.options.Lp||("warn"==a?d+="WARN ":"error"==a&&(d+="ERROR "));var f=c.map(function(u){return u instanceof Error?u.toString():"object"==typeof u?JSON.stringify(u):u}).join("| ");d+=f;d=d.substr(0,1024);for(var g=t(this.j),h=g.next();!h.done;h=g.next()){var l=h.value;
try{l.lc.apply(l,[a,d].concat(ca(c)))}catch(u){for(var m=t(this.j),n=m.next();!n.done;n=m.next()){var q=n.value;if(q!=l)try{q.lc("error"," ERROR "+u.toString()),q.lc("error"," ERROR "+u.stack)}catch(r){}}}}}catch(u){Eb&&Eb.error(u)}};Db.prototype.log=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];this.lc.apply(this,["log"].concat(ca(b)))};Db.prototype.warn=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];this.lc.apply(this,["warn"].concat(ca(b)))};
Db.prototype.error=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];this.lc.apply(this,["error"].concat(ca(b)))};
function Hb(a){function b(c){if(c.message)a.error("Unhandled exception: "+c),a.error(c.stack);else{var d="",e=c.reason;e&&(d=e.toString(),(c=c.reason.stack)&&(d+="\n"+c));a.error("Unhandled rejection: "+d)}}Q.Ic?(process.on("uncaughtException",b),process.on("unhandledRejection",b)):(window.addEventListener("error",function(c){b(c.error)}),window.addEventListener("unhandledrejection",function(c){b(c)}))}
function Ib(a){Eb||(Eb=Q.Ic?global.console:window.console);var b={log:function(c){for(var d=[],e=0;e<arguments.length;++e)d[e]=arguments[e];a.log.apply(a,ca(d))},warn:function(c){for(var d=[],e=0;e<arguments.length;++e)d[e]=arguments[e];a.warn.apply(a,ca(d))},error:function(c){for(var d=[],e=0;e<arguments.length;++e)d[e]=arguments[e];a.error.apply(a,ca(d))}};Q.Ic?global.console=b:window.console=b}function Jb(a){this.j=[];this.D=void 0===a?2E3:a}x(Jb,Cb);
Jb.prototype.lc=function(a,b,c){for(var d=2;d<arguments.length;++d);this.j.push(b);this.j.length>this.D&&this.j.shift()};Jb.prototype.Lj=function(){return this.j};function Kb(a,b){Jb.call(this);this.i=a;this.v=b||this.i.s["debug.mobile.consoleUrl"];this.h=this.l=!1;this.o=[]}x(Kb,Jb);
Kb.prototype.lc=function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];var f=this;this.i.sa()||(Jb.prototype.lc.call.apply(Jb.prototype.lc,[this,a,b].concat(ca(d))),this.h||(setTimeout(function(){f.h=!1;f.flush()},100),this.h=!0))};
Kb.prototype.flush=function(){var a=this,b,c;return J(function(d){switch(d.h){case 1:a.o.push(a.j);a.j=[];if(a.l){d.m(0);break}a.l=!0;case 3:if(!(0<a.o.length)){d.m(4);break}b=a.o.shift().join("\n");c={method:"POST",body:b};if(!a.v){d.m(3);break}C(d,5);return y(d,fetch(a.v,c),7);case 7:F(d,3);break;case 5:H(d);d.m(3);break;case 4:a.l=!1,A(d)}})};function Lb(a){this.h=a||(Q.Ic?global.console:window.console)}x(Lb,Cb);
Lb.prototype.lc=function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];this.h[a].apply(this.h,ca(d))};function Mb(a){Lb.call(this,a)}x(Mb,Lb);Mb.prototype.lc=function(a,b,c){for(var d=2;d<arguments.length;++d);this.h[a](b)};
function Nb(a,b){b=void 0===b?{}:b;Db.call(this,b);var c=this;this.i=a;b=(this.v=this.i.sa())||this.i.s["debug.dCon.logAtStart"];this.D={idaas:{Wa:"idaas"},policy:{Wa:"policy"},policyv:{kk:"verbose",Kj:"debug.policy.verbose"},"class":{Wa:"class"},iap:{Wa:"iap"},dia:{Wa:"dia"},diav:{kk:"verbose",Kj:"debug.dia.verbose"},dta:{Wa:"dta"},dau:{Wa:"dau"},dva:{Wa:"dva"},dab:{Wa:"dab"},dgm:{Wa:"dgm"},atb:{Wa:"atb"},cookie:{Wa:"cookie"},auth:{Wa:"auth"},bhr:{Wa:"bhr"},bhv:{kk:"verbose",Kj:"debug.bhr.verbose"},
cnf:{Wa:"cnf"},ytf:{Wa:"ytf"},runtime:{Wa:"runtime"},act:{Da:"user activities",Wa:"act"},acv:{kk:"verbose",Kj:"debug.act.verbose"},clm:{Da:"classroom mgmt",Wa:"clm"},dev:{Da:"device control",Wa:"dev"}};this.o="idaas,policy,bhr,auth,runtime";this.buffer=new Jb;Fb(this,this.buffer);this.options.eu||Q.sb.startsWith("test_")||(this.J=new Ob(this.i),Fb(this,this.J));this.v&&!this.i.bi()||Fb(this,Q.wa?new Mb:new Lb);this.l=new Pb(this.i);Fb(this,this.l);a=!this.options.gu&&void 0!=this.i.s["debug.console.remoteLogging"];
if(b){b=a?this.i.s["debug.console.remoteLogging"]:this.i.s["debug.dCon.logAtStart"];b||(b=this.o);if("default"==b||-1!=b.indexOf("default,"))b=b.replace("default",this.o);b=b.split(",");b=b.map(function(g){return g.trim()});var d={};b=t(b);for(var e=b.next();!e.done;e=b.next()){e=e.value;var f=Qb(this,e,!0,!0);f.error||(d[e]=f.Mp)}this.h=d;setTimeout(function(){if(c.h)for(var g=t(Object.keys(c.h)),h=g.next();!h.done;h=g.next())h=h.value,Qb(c,h,d[h],!0)},2E4)}a?Fb(this,this.l):delete this.i.s["debug.dCon.logAtStart"];
(function(){return J(function(g){c.i.H.addListener(function(h){if("remoteLoggingStatus"==h.type)if("on"==h.data.status)K.log("turning on remote logging: "+h.data.Jo),Rb(c,!0,h.data.Jo),c.i.s["debug.console.remoteLoggingStart"]=Date.now();else{var l=parseInt(c.i.s["debug.console.remoteLoggingStart"]);if(!isNaN(l)&&6048E5<=Date.now()-l||"undefined"!=typeof c.i.runtime&&c.i.runtime.va())K.log("turning off remote logging"),Rb(c,!1)}else if("postUserSignedIn"==h.type)!h.data.lf&&Q.zt()&&Sb(c.i.policy);
else if("uploadProxyLog"==h.type)try{var m=new nodeMods.admzip;h="/";process.platform.toLowerCase().startsWith("win")&&(h="\\");var n=nodeMods.path.resolve(Tb,"..")+h;try{m.addLocalFile(n+"proxy"+h+"log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"proxy-1"+h+"log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"proxy"+h+"napaDivert-log-80.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"proxy-1"+h+"napaDivert-log-80.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+
"proxy"+h+"napaDivert-log-443.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"proxy-1"+h+"napaDivert-log-443.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"watchDog"+h+"scriptServer-log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"watchDog-1"+h+"scriptServer-log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"watchDog"+h+"watchdog-log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"watchDog-1"+h+"watchdog-log.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+
"starterLog.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"browserlog.txt")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"updates-info"+h+"runningDir.json")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"updates-info"+h+"versions.json")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"script-config"+h+"userSession.json")}catch(p){K.log(JSON.stringify(p))}try{m.addLocalFile(n+"script-config"+h+"runtime.info")}catch(p){K.log(JSON.stringify(p))}l=c.i.runtime.env.Ha;
if(process.platform.toLowerCase().startsWith("win"))try{m.addLocalFile("c:\\Users\\"+l+"\\AppData\\Local\\Temp\\napalog.txt")}catch(p){K.log(JSON.stringify(p))}else if("darwin"==process.platform.toLowerCase())if(Q.sa)try{m.addLocalFile("/Users/"+l+"/Library/Application Support/DeledaoFamily/napalog.txt")}catch(p){K.log(JSON.stringify(p))}else try{m.addLocalFile("/Users/"+l+"/Library/Application Support/DeledaoFamilyDev/napalog.txt")}catch(p){K.log(JSON.stringify(p))}var q=btoa(m.toBuffer()),u=Math.ceil(q.length/
1E6);for(m=0;m<u;m++){n=1E6*(m+1);m==u-1&&(n=q.length);var r="data:application/zip;base64,"+q.substring(1E6*m,n);K.log("uploadProxyLog "+(m+1)+": len="+r.length);n=[];n.push({name:"proxyDebugLog",Da:l+" part"+(m+1),value:r});c.i.I.Sa("misc",{timestamp:Date.now(),type:"ProxyDebugInfo",W:n})}}catch(p){K.warn("uploadProxyLog fail: "+JSON.stringify(p))}},["remoteLoggingStatus","postUserSignedIn","uploadProxyLog"]);A(g)})})();this.i.addListener(function(g,h,l){if("debugConsole"==g.recipient&&"frontEndLog"==
g.type){g=U(rb,g);g=t(g.data);for(h=g.next();!h.done;h=g.next())h=h.value,"warn"==h.level?c.warn("FR: "+h.message):"error"==h.level?c.error("FR: "+h.message):c.log("FR: "+h.message);l&&l({consoleResponse:!0})}})}x(Nb,Db);
function Rb(a,b,c){if(b){if(c){if("default"==c||-1!=c.indexOf("default,"))c=c.replace("default",a.o);a.i.s["debug.console.remoteLogging"]=c;c=c.split(",");c=c.map(function(f){return f.trim()});b={};c=t(c);for(var d=c.next();!d.done;d=c.next()){d=d.value;var e=Qb(a,d,!0,!1);e.error||(b[d]=e.Mp)}a.h=b}a.l.setEnabled(!0);Fb(a,a.l)}else if(delete a.i.s["debug.console.remoteLogging"],delete a.i.s["debug.console.uploadQ"],a.l.setEnabled(!1),Gb(a,a.l),a.v)for(b=t(Object.keys(a.D)),d=b.next();!d.done;d=b.next())c=
d.value,Qb(a,c,!1,!0),Qb(a,c,!1,!1);else if(a.h){b=t(Object.keys(a.h));for(d=b.next();!d.done;d=b.next())c=d.value,Qb(a,c,a.h[c],!0),Qb(a,c,a.h[c],!1);a.h=void 0}}Nb.prototype.Lj=function(){return this.buffer.Lj()};
function Qb(a,b,c,d){K.log("[DBG] Set module debug flag. moduleName="+b+", status="+c+", permanent="+d+".");var e=a.D[b],f={};if(e){if(d){b=e.Kj||"debug."+e.Wa+".debug";var g="true"==a.i.s[b];c?a.i.s[b]="true":delete a.i.s[b]}else if(e.object)if(a=e.object,void 0==a)f.error=b+": object "+e.object.className+" not found",K.error(f.error);else{g=e.kk||"debug";b=Za.h[g];if(!b)return K.error("setModuleDebugFlag: cannot find obf mapping for "+g),{error:"cannot find obf mapping for attribute"};g=a[b];a[b]=
c}f.Mp=g}else K.error("debug module not found: "+b),f.error=b+" not supported",a.i.H.sendMessage({type:"setDebugFlag",data:{module:b,status:c}});return f}function Ub(a,b,c){(a=a.D[b])?a.object=c:K.error("debug console module not found: "+b)}
function Pb(a,b){b=void 0===b?30:b;Jb.call(this);this.i=a;this.I=a.I;try{this.o=!1,delete this.i.s["debug.console.uploadQ"],this.o?this.pending=JSON.parse(this.i.s["debug.console.uploadQ"]):delete this.i.s["debug.console.uploadQ"]}catch(d){}this.pending||(this.pending=[]);this.h=0;a=t(this.pending);for(var c=a.next();!c.done;c=a.next())this.h+=c.value.size;this.flush();this.enabled=!1;this.v=b;Vb(this)}x(Pb,Jb);
function Vb(a){var b;J(function(c){1==c.h&&(b=0);if(4!=c.h)return a.i.Yc?c.m(0):y(c,new Promise(function(d){setTimeout(d,1E3*a.v)}),4);b++;a.enabled&&(0==b%10&&0<a.j.length||50<a.j.length)&&(Wb(a,a.j),a.j=[]);return c.m(2)})}Pb.prototype.setEnabled=function(a){this.enabled=a};
function Wb(a,b){var c,d,e,f,g,h,l,m,n;J(function(q){switch(q.h){case 1:c={timestamp:Date.now(),userId:a.i.runtime.env.Va,text:b.join("\n")+"\n"};d=c.text;c.size=d.length;a.h+=c.size;a.pending.push(c);if(a.l){for(K.warn("Remote logs upload in progress: new logs queued for next batch");3145728<a.h&&0<a.pending.length;)e=a.pending.shift(),a.h-=e.size;a.o&&(a.i.s["debug.console.uploadQ"]=JSON.stringify(a.pending));q.m(0);break}f=3;case 3:if(!(0<a.pending.length)){q.m(0);break}for(;3145728<a.h&&0<a.pending.length;)g=
a.pending.shift(),a.h-=g.size;a.o&&(a.i.s["debug.console.uploadQ"]=JSON.stringify(a.pending));h=a.pending.length;C(q,5);return y(q,a.flush(),7);case 7:for(l=0;l<h;l++)m=a.pending.shift(),a.h-=m.size;a.o&&(a.i.s["debug.console.uploadQ"]=JSON.stringify(a.pending));F(q,3);break;case 5:return n=H(q),K.log("remote uploading logs failed: "+n+", retry in "+f+" seconds"),y(q,new Promise(function(u){setTimeout(u,1E3*f)}),8);case 8:f=Math.min(2*f,30),q.m(3)}})}
Pb.prototype.flush=function(){var a=this,b;return J(function(c){if(0==a.pending.length||!a.I)return c.return();a.l=!0;b=a.I.Sa(Q.Cu,a.pending,1).finally(function(){a.l=!1});return c.return(b)})};function Ob(a){var b=this;this.i=a;this.cache={};this.h=this.i.setInterval(function(){b.flush()},3E5)}x(Ob,Cb);Ob.prototype.stop=function(){this.i.clearInterval(this.h)};
Ob.prototype.lc=function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];if("error"==a){try{throw Error("get stack trace");}catch(h){e=h.stack}try{b=d.map(function(h){return h instanceof Error?h.toString():"object"==typeof h?JSON.stringify(h):h}).join("| ");""==b&&(b="Empty error message");var f=b.substring(0,256);if(this.cache[f])this.cache[f].Xo++;else{var g={timestamp:Date.now(),type:"extensionError",digest:b.substr(0,10),Qg:b+"\n"+e,version:this.i.ob(),Xo:1};this.i.runtime&&
Xb(this.i.runtime,g,!0);this.cache[f]=g}}catch(h){}}};Ob.prototype.flush=function(){var a=this,b,c,d,e,f;return J(function(g){b=Object.keys(a.cache);if(0<b.length){c=[];d=t(b);for(e=d.next();!e.done;e=d.next())f=e.value,c.push(a.cache[f]);a.i.I.Sa("misc",c);a.cache={}}A(g)})};function Yb(a){Nb.call(this,a);Hb(this);Ib(this)}x(Yb,Nb);function Zb(a,b){b=void 0===b?{}:b;Nb.call(this,a,Object.assign(b,{eu:!0,gu:!0}));88==Q.platform&&process.env.GIT_META&&Object.assign(this.options,{Kp:!0,Lp:!0})}
x(Zb,Nb);try{importScripts("/util/vendor.js")}catch(a){}
var $b=/^https?:\/\/(www\.)?google\.(com|co|[a-z][a-z]|((com|co)\.[a-z][a-z]))(\/search\?).*/g,ac=/^https?:\/\/www\.bing\.com(\/search\?).*/g,bc=/^https?:\/\/www\.dogpile\.com(\/serp\?).*/g,cc=/^https?:\/\/(.*\.)?search\.yahoo\.com(\/(search|web)(\?|;)).*/g,dc=/^https?:\/\/www\.youtube\.com(\/results\?).*/g,ec=/^https?:\/\/(.*\.)?facebook\.com(\/search\?).*/g,fc=/^https?:\/\/twitter\.com(\/(search|search-advanced)\?).*/g,gc=/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()+,\-.\/:;<=>?@\[\]^_`{|}~]/g,hc=/\s+/g,
ic="a an the is was were of as to".split(" ");function jc(a){return a.split(".").reduce(function(b,c){return(b<<8)+parseInt(c,10)},0)>>>0}function kc(a){return(a>>24&255)+"."+(a>>16&255)+"."+(a>>8&255)+"."+(a&255)}function lc(a){a=a.split(":");var b=a[0],c="00";2===a.length&&(c=a[1]);1===b.length&&(b="0"+a[0]);1===c.length&&(c="0"+a[1]);return b+":"+c}function mc(a){var b="";try{b=CryptoJS.AES.decrypt(a,atob("OFlNSWIwTGdHdHlQeVZacw==")).toString(CryptoJS.enc.Utf8)}catch(c){}return b}
function nc(a){var b="";try{b=CryptoJS.AES.encrypt(a,atob("OFlNSWIwTGdHdHlQeVZacw==")).toString()}catch(c){}return b}function pc(a){return"about:blank"===a||a.startsWith("chrome://")?!0:!1}function qc(a,b,c,d,e){a="earth:"+a+":"+b+":"+c+":"+d+":"+e+":quake";b=0;if(0!=a.length)for(d=0;d<a.length;d++)c=a.charCodeAt(d),b=(b<<5)-b+c,b&=b;return b}
function rc(a,b){if(!a&&!b)return 0;if(!a)return-1;if(!b)return 1;if(a===b)return 0;if("low"===a)return-1;if("medium"===a)return"low"===b?1:-1;if("high"===a)return"low"===b||"medium"===b?1:-1;if("veryhigh"===a)return 1}function sc(a){try{var b=new URL(a);b.hash="";a=b.toString()}catch(c){K.warn("Parse url failed.",a)}return a}
function tc(a,b){if(a){var c;if(a.startsWith("."))var d="http://"+a.substring(1);else if(a.includes("://")){if(a.startsWith("chrome://")&&"chrome://newtab/"!==a||a.startsWith("chrome-extension://")||a.startsWith("chrome-devtools://")||pc(a))return c;d=a}else d="http://"+a;try{var e=new URL(d);(c=psl.get(e.hostname))?b&&!e.hostname.endsWith(c)&&(this.debug&&K.log(this.gb+"domain "+e.hostname+" diff from psl domain: "+c),c=e.hostname):c=e.hostname}catch(f){K.log(this.gb+"failed to getDomainFromUrl: "+
a+"; "+f)}return c}}function uc(a){for(var b="",c,d=0;d<a.requestHeaders.length;++d)if("Referer"===a.requestHeaders[d].name){b=a.requestHeaders[d].value;this.debug&&K.log(this.gb+" reqId="+a.requestId+" save referer="+b+" url="+a.url);break}""!==b&&(c=tc(b,0));return c}function xc(a){return(a=a.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&\?]*).*/))&&11==a[7].length?a[7]:!1}function yc(){return new Promise(function(a){setTimeout(function(){a()},5E3)})}
function zc(a,b,c){try{var d=new URLSearchParams(a.search.slice(1)),e=new URLSearchParams;if(d.get(c)){var f=d.get(c).toLowerCase().split(" ").sort();e.append(c,f.toString().replace(/,/g," "));if(a.hostname.endsWith("yahoo.com")&&a.pathname.startsWith("/search;")){var g=b.indexOf(";");var h=b.substring(0,g)+"?"}else g=b.indexOf("?"),h=b.substring(0,g+1);var l=h+e.toString()}}catch(m){}return l}
function Ac(a){if(a)try{a.startsWith("https://")||a.startsWith("http://")||a.startsWith("ftp://")||(a="http://"+a);try{var b=new URL(decodeURIComponent(a))}catch(c){b=new URL(a)}b.hostname.endsWith(".")&&(b.hostname=b.hostname.substring(0,b.hostname.length-1),K.warn("Converting url from "+a+" to "+b.toString()),a=b.toString());return a.match($b)?zc(b,a,"q"):a.match(dc)?zc(b,a,"search_query"):a.match(ac)?zc(b,a,"q"):a.match(bc)?zc(b,a,"q"):a.match(cc)?zc(b,a,"p"):a.match(ec)?zc(b,a,"q"):a.match(fc)?
zc(b,a,"q"):a}catch(c){}}function Bc(a,b){b=void 0===b?0:b;var c=new Date(a);0<b&&c.setDate(a.getDate()+b);a=c.getDay();return 0==a?1:1<<a&127}function Cc(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})}
function Dc(a,b){var c,d,e;J(function(f){if(1==f.h)return C(f,2),c="http://localhost:8080/store?prefix=dgim&url="+a,y(f,fetch(c,{method:"POST",body:b}),4);if(2!=f.h){d=f.j;if(!d.ok)throw Error("Failed to save dgim/"+a+". Status: "+d.status+" ("+d.statusText+").");return F(f,0)}e=H(f);K.warn("saveDataToFile error:",e);A(f)})}
function Ec(a,b){for(var c=!0,d=a.split(" "),e=t(b),f=e.next();!f.done;f=e.next())if(ele=f.value,!(-1<ic.indexOf(ele)||d.includes(ele))){c=!1;break}return c?c:a.replace(/ /g,"")==b.join("")?!0:!1}
function Fc(a,b){b=void 0===b?0:b;if("object"!=typeof a)return a;var c={},d;for(d in a)if("string"==typeof a[d]&&43<a[d].length)c[d]=a[d].substring(0,20)+"..."+a[d].substring(a[d].length-20,a[d].length)+("(len:"+a[d].length+")");else if("object"==typeof a[d]&&5>b)if(Array.isArray(a[d])){c[d]=[];for(var e in a[d])c[d][e]=Fc(a[d][e],b+1)}else c[d]=Fc(a[d],b+1);else c[d]=a[d];return c}function Gc(a){a=Fc(a);return JSON.stringify(a)}
function Hc(a){"string"==typeof a&&(a=a.replace(/\s+/g," ").trim());return a}
function Ic(a,b,c){if(a&&0!=a.trim().length)if(a.startsWith('"')&&a.endsWith('"')){var d=a.substring(1,a.length-1);if(b==d||b.replace(/ /g,"")==d)return c&&K.log("fuzz exact match matched target="+d+"; query="+b),a;c&&K.log("fuzz exact match NOT match target="+d+"; query="+b)}else if(b=b.replace(gc,"").replace(hc," ").trim(),0!=b.length){d=stringSimilarity.compareTwoStrings(a,b);c&&K.log("fuzz simi="+d+"; src="+b+"; target="+a);if(.7<d){var e=b.trim().split(" ").length;c=a.trim().split(" ").length;
if(3<=e&&3<=c)return a;if(1==e&&1==c&&b.substring(0,1)!==a.substring(0,1)&&!b.startsWith("*"))return;e=Ec(b,a.split(" "));if(1==c&&7>a.length&&!e)return;if(.9<=d||e||.8<=d&&b.includes("*"))return a}if(Ec(b,a.trim().split(" ")))return a}}
function Jc(){var a=document.URL;try{var b=new URL(a.toLowerCase());if("webcache.googleusercontent.com"==b.hostname){var c=":"==b.search.charAt(8)&&":"==b.search.charAt(21)?22:9;var d=b.search.indexOf("+&cd=",9);-1==d&&(d=b.search.length);var e=b.search.substring(c,d)}else if("cc.bingj.com"!=b.hostname)if("web.archive.org"==b.hostname)!b.pathname.startsWith("/web/")||b.pathname.startsWith("/web/collections/")||b.pathname.startsWith("/web/changes/")||b.pathname.startsWith("/web/*/")||(e=b.pathname.substring(20),
e.startsWith("f_/")&&(e=e.substring(3)));else if("wayback.archive-it.org"==b.hostname)c=b.pathname.indexOf("/",1),-1!=c&&(e="*"==b.pathname.charAt(c+1)?b.pathname.substring(c+3):b.pathname.substring(c+16));else if("archive.is"==b.hostname||"archive.vn"==b.hostname)b.pathname.indexOf(".")&&(e=b.pathname.substring(1));else if("startpage.com"!=b.hostname&&"www.browserling.com"==b.hostname&&b.pathname.startsWith("/browse/"))if(b.pathname.startsWith("/browse/android/"))c=b.pathname.indexOf("/",16),-1!=
c&&(e=b.pathname.substring(c+1));else{var f=b.pathname.substring(8).split("/");c=f[0].length+f[1].length+f[2].length+f[3].length+12;e=b.pathname.substring(c)}}catch(g){}return e?decodeURIComponent(e):a}function Kc(a){for(var b=!1,c=Date.now(),d=0;d<a.length;d++)if(!(c<a[d].from||c>a[d].oe)){b=!0;break}return b}function Lc(){return J(function(a){return a.return(new Promise(function(b){chrome.cookies.get({url:Q.xi,name:"auth.fam.userId"},function(c){c?b(c.value):b(null)})}))})}
function Mc(a){if(Q.ce){a=atob(a);for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b.buffer}return Buffer.from(a,"base64").buffer}function Nc(a){return Q.ce?btoa(String.fromCharCode.apply(null,new Uint8Array(a))):Buffer.from(a).toString("base64")}function Oc(a){return(new TextEncoder).encode(a)}function Pc(a){for(var b=new Uint8Array(a.length/2),c=0;c<a.length;c+=2)b[c/2]=parseInt(a.substr(c,2),16);return b}function Qc(){this.h=[]}
Qc.prototype.wait=function(){var a=this;return J(function(b){return b.return(new Promise(function(c){a.h.push(c)}))})};Qc.prototype.signal=function(){for(;0<this.h.length;)this.h.shift()()};
function Rc(a){var b=a.toLowerCase().match(/^([\w\/\.]+) +\(([^\)]+)\)( +([\w\/\.]+) +(\([^\)]+\) +)?(.*))?$/);if(b){a=b[2];b=b[6];var c={};a.includes("cros")?c.system="chrome":a.includes("macintosh")?c.system="undefined"!=typeof navigator&&1<navigator.maxTouchPoints?"ipad":"mac":a.includes("windows")?c.system="windows":a.includes("linux")?c.system="linux":a.includes("android")?c.system="android":a.includes("iphone")?c.system="iphone":a.includes("ipad")?c.system="ipad":c.system="unknown "+a;b.includes("firefox")?
c.browser="firefox":b.includes(Q.Fd)?c.browser=Q.Fd:b.includes("opr")?c.browser="opera":b.includes("chrome")?c.browser="chrome":b.includes("safari")?c.browser="safari":c.browser="unknown "+b;return c}return{system:"unknown",browser:"unknown"}}function Sc(a){return(a=a.runtime.getAuthToken())&&!a.startsWith("anon-")}function Tc(a){return"youtube.com"===a||a.endsWith(".youtube.com")||"youtube-nocookie.com"==a||a.endsWith(".youtube-nocookie.com")?!0:!1}
function Uc(){var a=location;return"www.google.com"==a.hostname&&"/search"==a.pathname}function Vc(a){for(var b={},c=[],d=a.length,e=0,f=0;f<d;f++){var g=a[f];1!==b[g]&&(b[g]=1,c[e++]=g)}return c}var Wc=setInterval,Xc=clearInterval;
function Yc(){var a="undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0;a?(a.setInterval=function(b){for(var c=[],d=0;d<arguments.length;++d)c[d]=arguments[d];try{throw Error();}catch(e){K.error("Use this.bSession.setInterval() or sysSetInterval() instead"),K.error(e.stack.toString())}return Wc.apply(null,ca(c))},a.clearInterval=function(b){for(var c=[],d=0;d<arguments.length;++d)c[d]=arguments[d];try{throw Error();}catch(e){K.error("Use this.bSession.clearInterval() or sysClearInterval() instead"),
K.error(e.stack.toString())}return Xc.apply(null,ca(c))}):K.error("setupIntervalTimers(): cannot find the global object")};function Zc(a){try{var b=a.split("."),c=parseInt(b[1],10);return 100==parseInt(b[0],10)&&64<=c&&127>=c}catch(d){K.warn("Check CGNAT IP error.",d)}return!1}var cd=/^([^:\/?#]+:\/\/)(.*)/;function dd(a){this.i=a}var ed;function fd(a,b,c,d){gd(a,b,c,d,2)}function gd(a,b,c,d,e){e=void 0===e?3:e;var f=tc(b,0);hd(a,b,"POST",JSON.stringify(c),f!=Q.Eb).then(d).catch(function(g){K.log("Async POST failed: "+g+". Retry after "+e+" seconds "+b);var h=2*e;60<h&&(h=60);setTimeout(function(){gd(a,b,c,d,h)},1E3*e)})}
function id(a,b,c,d,e,f,g){var h=!0;h=void 0===h?!1:h;e=void 0===e?3:e;f=void 0===f?5:f;g=void 0===g?60:g;var l,m,n,q;return J(function(u){switch(u.h){case 1:l=f,m="",n=e;case 2:if(!n){u.m(3);break}n--;C(u,4);return y(u,hd(a,c,b,d,h),6);case 6:m=u.j;n=0;F(u,2);break;case 4:return q=H(u),m=JSON.stringify({Error:q}),K.warn("Query server failed. Retry later. err="+q+", url="+c+", paramStr="+d),y(u,new Promise(function(r){setTimeout(r,1E3*l)}),7);case 7:l=Math.min(2*l,g);u.m(2);break;case 3:return u.return(m)}})}
function jd(a){var b,c,d;return J(function(e){switch(e.h){case 1:return y(e,a.arrayBuffer(),2);case 2:a=e.j;C(e,3);if(dd.Hb){e.m(5);break}b=dd;return y(e,crypto.subtle.importKey("raw",Pc("7FD514E3CA9CE3D9D0F3C10A0D406C5F6EB590113F1F8A837D778DAF487DE4EC"),{name:"AES-CBC"},!1,["encrypt","decrypt"]),6);case 6:b.Hb=e.j;case 5:return ed||(ed=Pc("7DC44F14419162030E3DB0AADD94C108")),y(e,crypto.subtle.decrypt({name:"AES-CBC",iv:ed},dd.Hb,a),7);case 7:return c=e.j,e.return("undefined"==typeof Response?new fetch.Response(c):
new Response(c));case 3:throw d=H(e),"Decryption failure: "+d;}})}
function hd(a,b,c,d,e){var f,g,h,l,m;return J(function(n){if(1==n.h)return 99==Q.platform||88==Q.platform?(g=fetch,f=new g.Headers):f=new Headers,88==Q.platform&&(h=a.i.Tb.Kc.wd)&&f.append("x-forwarded-for",h),y(n,fetch(b,{method:c,headers:f,body:d}),2);if(4!=n.h){l=n.j;403!==l.status||e||a.i.G.wi("fetchInternal");if(!l.ok)throw Error("Failed to fetch "+b+". Status: "+l.status+" ("+l.statusText+").");return y(n,l.text(),4)}m=n.j;return n.return(m)})}
function kd(a,b,c,d,e,f){var g;return J(function(h){g=new Promise(function(l,m){setTimeout(function(){m(Error("Request timed out after "+e+"ms"))},e)});return h.return(Promise.race([g,hd(a,b,c,d,f)]))})}function ld(a,b){var c=void 0===c?"GET":c;var d=void 0===d?null:d;return J(function(e){return e.return(kd(a,b,c,d,3E4,!0))})}function md(a,b,c,d){c=void 0===c?"GET":c;d=void 0===d?null:d;return J(function(e){return e.return(kd(a,b,c,d,3E4,!1))})};function nd(a){var b=this;this.i=a;this.debug="true"==localStorage["debug.iap.debug"];this.j=new Map;this.li=this.h="com.deledao.family.premium.monthly";this.i.addListener(function(c,d,e){if(c&&"iap"===c.recipient)if("InAppGetProdsReq"===c.type)b.debug&&K.log("iap InAppGetProdsReq: "+JSON.stringify(c.data)),e&&e({type:"InAppGetProdsReq",recipient:"native",data:c.data});else if("InAppGetProdsResp"===c.type)for(c=c.data,e=0;e<c.length;e++)b.j.set(c[e].li,c[e]),b.debug&&K.log("iap InAppGetProdsResp "+
JSON.stringify(c[e]));else if("InAppBuyProdReq"===c.type)b.debug&&K.warn("iap InAppBuyProdReq="+JSON.stringify(c)),b.li=c.data.prodID,e&&e({type:"InAppBuyProdReq",recipient:"native",data:c.data});else if("InAppBuyProdResp"===c.type){if(b.debug&&K.warn("iap InAppBuyProdResp="+JSON.stringify(c)),c.data){d=c.data.state;var f=c.data.prodID,g=c.data.original_transaction_id,h=c.data.transaction_receipt;b.debug&&K.log("iap InAppBuyProdResp state="+d+"; prodID="+f+"; otid="+g+" "+JSON.stringify(c));1===d?
(b.i.Zs.Gu({type:"iap",li:f,qq:g,rq:h},!0),e&&e({type:"InAppBuyResult",recipient:"native",data:{ok:!0}})):e&&e({type:"InAppBuyResult",recipient:"native",data:{ok:!1}})}}else"InAppTransUpdate"===c.type&&(b.debug&&K.log("iap InAppTransUpdate="+JSON.stringify(c)),c.data&&(e=c.data.prodID,d=c.data.original_transaction_id,f=c.data.transaction_receipt,1===c.data.state&&b.i.Zs.Gu({type:"iap",li:e,qq:d,rq:f},!1)))})};function od(a,b,c,d,e){this.debug=a;this.F=d;this.la=e;this.Ub=[];this.Za=[];this.l=[];this.j=[];this.h={};this.Ub=pd(b);if(c){a=t(c);for(b=a.next();!b.done;b=a.next())b=b.value,b=b.trim(),b.startsWith("+")?-1==this.l.indexOf(b)&&this.l.push(b.substring(1)):b.startsWith("-")?-1==this.j.indexOf(b)&&this.j.push(b.substring(1)):-1==this.Za.indexOf(b)&&this.Za.push(b);this.Za=pd(this.Za);this.l=pd(this.l);this.j=pd(this.j)}b=[];c=t(this.Za);for(a=c.next();!a.done;a=c.next())a=a.value,-1==this.l.indexOf(a)&&
-1==this.j.indexOf(a)&&b.push(a);this.Za=b;b=[];c=t(this.Ub);for(a=c.next();!a.done;a=c.next())a=a.value,-1==this.Za.indexOf(a)&&-1==this.l.indexOf(a)&&-1==this.j.indexOf(a)&&b.push(a);this.Ub=b;this.debug&&(K.log("whitelist: "+this.Za.toString()),K.log("graylist: "+this.l.toString()),K.log("cyanlist: "+this.j.toString()),K.log("blacklist: "+this.Ub.toString()));qd(this,this.l,Q.ea,!0);qd(this,this.j,Q.ea,!1,!0);qd(this,this.Za,Q.ea);qd(this,this.Ub,Q.Pa)}
function pd(a){if(!a)return[];var b=[];a=t(a);for(var c=a.next();!c.done;c=a.next())(c=c.value)&&0!==c.trim().length&&"+"!=c.trim()&&(c=Ac(c),(c=(c=cd.exec(c))?c[2]:"")&&(c=c.replace(/\/$/,""))&&b.push(c));return b}
function qd(a,b,c,d,e){if(b&&0!=b.length){b=t(b);for(var f=b.next();!f.done;f=b.next()){var g=f.value;f=g;var h=g.match(/^([0-9]{1,3}\.){3}[0-9]{1,3}\/(([0-9]|[1-2][0-9]|3[0-2]))$/)?!0:!1,l=null;if(!h){f=(new URL(Q.Oj+g)).hostname;if((l=g)&&l.includes("*")&&"*"!==l){var m=l.replace(/([.+?^=!:${}()|[\]/\\])/g,"\\$1").replace(/\*/g,"[^.]*");m=l.startsWith("*")&&!l.startsWith("*.")?"^.*"+m.slice(5,m.length):"^"+m;m=l.endsWith("*")&&!l.endsWith(".*")?m.slice(0,m.length-5)+".*$":m+"$";l=new RegExp(m)}else l=
null;a.debug&&l&&K.log("[BWL] wildcard_regex=",l)}g=new rd(g,c,f,h,l);void 0!=d&&1==d&&(g.Xl=!0);void 0!=e&&1==e&&(g.Ag=!0);a.h[f]?a.h[f].push(g):a.h[f]=[g]}}}
function sd(a,b,c){var d=0,e=new Map;b=t(b.entries());for(var f=b.next();!f.done;f=b.next())if(f=f.value,d++,e.has(f[0])){var g=e.get(f[0]);g.push(f[1]);e.set(f[0],g)}else e.set(f[0],[f[1]]);if(a&&"\uff0f"!=a||0!=d){b=0;if(0!=d){d=t(c);for(f=d.next();!f.done;f=d.next())if(g=f.value,f=new URL(Q.Oj+g.url),f.pathname.replace(/\/$/,"")==a.replace(/\/$/,"")&&!f.hash){var h=0,l=t(f.searchParams.entries());for(f=l.next();!f.done;f=l.next()){f=f.value;if(!e.has(f[0])||-1==e.get(f[0]).indexOf(f[1])){h=0;break}h++}if(h>
b){b=h;var m=g}}if(m)return m}for(;;){e=t(c);for(f=e.next();!f.done;f=e.next())if(m=f.value,b=new URL(Q.Oj+m.url),!b.hash&&"/"!=b.pathname){d=0;f=t(b.searchParams.entries());for(g=f.next();!g.done;g=f.next())d++;if(!(0<d)&&b.pathname.replace(/\/$/,"")===a.replace(/\/$/,""))return m}e=a.lastIndexOf("/");if(-1==e||0==e)break;a=a.slice(0,e)}}}
function td(a,b){var c=0,d=void 0;b=t(b);for(var e=b.next();!e.done;e=b.next()){e=e.value;var f=new URL(Q.Oj+e.url);if(!e.qm){if(f.hash)continue;if("/"!==f.pathname)continue;for(var g=0,h=t(f.searchParams.entries()),l=h.next();!l.done;l=h.next())g++;if(0<g)continue}ud(a,e.et,e.qm)&&(f=f.hostname.split(".").length,f>c&&(c=f,d=e))}return d}
function vd(a,b){if(!a.h)return K.error("specDefMap error"),{xm:!1};for(var c in a.h){var d=a.h[c].filter(function(e){return e.xn});if(0<d.length&&d[0].xn.test(b))return{xm:!0,ft:c}}return{xm:!1}}function wd(a,b){if(!a.h)return K.error("specDefMap error"),[];var c=[],d;for(d in a.h){var e=a.h[d].filter(function(f){return!f.xn});0<e.length&&ud(b,d,e[0].qm)&&c.push(d)}return c}
function ud(a,b,c){if(c){try{var d=b.split("/"),e=-1<<32-d[1],f=jc(a)&e,g=jc(d[0])&e;var h=0!=f&&f==g}catch(l){K.error("Match CIDR error.",l),h=!1}return h}a=a.split(".");for(b=b.split(".");0<b.length&&0<a.length;)if(c=a.pop(),h=b.pop(),"%2A"!=h&&"*"!=h&&c!=h)return!1;return 0==b.length}
od.prototype.Yg=function(a){function b(r,p){r.T==Q.Pa&&(l=" is in blocked list");xd(d,r.T,p,r.url+l,r.url);d.Xl=r.Xl;d.Ag=r.Ag}function c(r){return r==Q.ea?"allowed":r==Q.Pa?"blocked":r==Q.Qa?"default":"unknown"}var d=new yd(a,void 0,this.F,this.la);xd(d,Q.Qa,"BW list");if(1>this.Za.length&&1>this.l.length&&1>this.Ub.length&&1>this.j.length||!a)return d;try{var e=new URL(a)}catch(r){return K.warn("Bad URL: "+a+": "+r),d}var f=e.hostname,g=e.pathname,h=e.searchParams;e=this.Ub.includes("*");var l=
" is in allowed list",m=vd(this,f),n=null;m.xm&&(m=this.h[m.ft],Array.isArray(m)&&0<m.length&&(n=m[0]));var q=wd(this,f);if(1>q.length&&!e)return n&&b(n,"BW list match hostname"),d;m=[];q=t(q);for(var u=q.next();!u.done;u=q.next())m.push.apply(m,ca(this.h[u.value]));if(g=sd(g,h,m))return this.debug&&K.log("Match path("+c(g.T)+") for "+a),b(g,"BW list match path"),d;if((f=td(f,m))&&n)return f.T==Q.ea?b(f,"BW list match hostname"):b(n,"BW list match hostname"),this.debug&&K.log("Match both hostname("+
c(f.T)+") and wildcard("+c(n.T)+") for "+a),d;if(f)return this.debug&&K.log("Match hostname("+c(f.T)+") for "+a),b(f,"BW list match hostname"),d;if(n)return this.debug&&K.log("Match wildcard("+c(n.T)+") for "+a),b(n,"BW list match hostname"),d;if(e)return this.debug&&K.log("Match * "+a),xd(d,Q.Pa,"BW list match *","* is in blocked list","*"),d;this.debug&&K.log("No blackwhiteList found for "+a);return d};function zd(a,b){this.h=a;this.list=[];this.fj=b}
zd.prototype.Yg=function(a){for(var b=this.h.Yg(a),c,d=t(this.list),e=d.next();!e.done&&(c=e.value.Yg(a),!Ad(c));e=d.next());return c&&Ad(c)?Ad(b)?b.Gd()?b:this.fj?b:c:c:b};function rd(a,b,c,d,e){this.T=b;this.url=a;this.et=c;this.qm=d;this.xn=e};function Bd(a,b,c){this.debug=a;this.h={};this.j={};this.S=[];this.v={};this.l={};this.o={};this.D=[];this.J={};Cd(this,c,b)}
function Cd(a,b,c){if(b){if(b.vg)for(var d=t(b.vg),e=d.next();!e.done;e=d.next()){e=e.value;var f=a.h[e.title];void 0===f?e.from?Kc([e])&&(a.h[e.title]=[e]):a.h[e.title]=null:null!==f&&Kc([e])&&f.push(e)}if(b.channels)for(d=t(b.channels),e=d.next();!e.done;e=d.next())e=e.value,f=a.j[e.id],void 0===f?e.from?Kc([e])&&(a.j[e.id]=[e]):a.j[e.id]=null:null!==f&&Kc([e])&&f.push(e);b.Wj&&(a.S=b.Wj);if(b.Qb)for(b=t(b.Qb),d=b.next();!d.done;d=b.next())d=d.value,e=a.v[d.id],void 0===e?d.from?Kc([d])&&(a.v[d.id]=
[d]):a.v[d.id]=null:null!==e&&Kc([d])&&e.push(d)}if(c){if(c.vg)for(b=t(c.vg),e=b.next();!e.done;e=b.next())d=e.value,void 0===a.l[d.title]&&(a.l[d.title]=null);if(c.channels)for(b=t(c.channels),e=b.next();!e.done;e=b.next())d=e.value,void 0===a.o[d.id]&&(a.o[d.id]=null);c.Wj&&(a.D=c.Wj);if(c.Qb)for(c=t(c.Qb),d=c.next();!d.done;d=c.next())b=d.value,void 0===a.J[b.id]&&(a.J[b.id]=null)}}
function Dd(a,b){return!b.T&&(0<Object.keys(a.h).length||0<Object.keys(a.l).length)||!b.channelId&&(0<Object.keys(a.j).length||0<Object.keys(a.o).length)||!b.title&&(0<a.S.length||0<a.D.length)?!0:!1}
function Ed(a,b,c,d,e,f,g){var h={state:Q.Qa},l=!1;if(void 0!==c["*"])return h.state=g,h.qa="channel *",h;if(void 0!==c[b.channelId]&&(c=c[b.channelId],void 0!==c&&(null===c?l=!0:l=Kc(c)),l))return h.state=g,h.qa="channel "+b.channelId,a.debug&&K.log("[YTF] Meta match found by channelList.",h),h;if(void 0!==d["*"])return h.state=g,h.qa="category *",h;if(void 0!==d[b.T]&&(d=d[b.T],void 0!==d&&(null===d?l=!0:l=Kc(d)),l))return h.state=g,h.qa="category "+b.T,a.debug&&K.log("[YTF] Meta match found by categoryList.",
h),h;if(e.includes("*"))return h.state=g,h.qa="title *",h;a:if(d=b.title)if(d=d.toLowerCase().toLowerCase().match(/\b\w\w+\b/g),null!=d){e=t(e);for(c=e.next();!c.done;c=e.next()){c=c.value.toLowerCase().match(/\b\w\w+\b/g);var m=!1,n=-1;if(c){for(var q=0;q<c.length&&-1!==d.indexOf(c[q])&&(0===q||d.indexOf(c[q])===n+1);q++)if(n=d.indexOf(c[q]),q==c.length-1){m=!0;break}if(m){d=!0;break a}}}d=!1}else d=void 0;else d=!1;if(d)return h.state=g,h.qa="title "+b.title,a.debug&&K.log("[YTF] Meta match found by titleKeywordList.",
h),h;void 0!==f["*"]?(h.state=g,h.qa="id *"):void 0!==f[b.ld]&&(f=f[b.ld],void 0!==f&&(null===f?l=!0:l=Kc(f)),l&&(h.state=g,h.qa="id "+b.ld,a.debug&&K.log("[YTF] Meta match found by video ID.",h)));return h}function Fd(a,b){var c=Ed(a,b,a.j,a.h,a.S,a.v,Q.ea);c.state===Q.Qa&&(c=Ed(a,b,a.o,a.l,a.D,a.J,Q.Pa));return c};function Gd(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.auth.debug"];this.h=Q.oc+"/family/";this.i.H.addListener(function(c){"sendUserInfoToProxy"==c.type?(c=c.data,Hd(b,c.rd,c.Z,c.userName,c.Bu)):"sendLogoutToProxy"==c.type?Id(b):"sendReloadPolicyToProxy"==c.type&&Jd(b)});this.i.addListener(function(c,d,e){"authUtil"==c.recipient&&"uploadProxyLog"==c.type&&(Sc(b.i)&&Kd(b),e&&e({ok:!0}))})}
function Hd(a,b,c,d,e){var f,g,h,l;J(function(m){switch(m.h){case 1:return a.debug&&K.log("authUtil ...sendUserInfoToProxy"),C(m,2),y(m,Ld(a),4);case 4:f=m.j;if(!f){m.m(5);break}a.debug&&K.log("authUtil ...sendUserInfoToProxy .. uuid="+f);return y(m,Md(a,b,f,c,d,e),6);case 6:g=m.j;if(!g)return m.return(!1);h={recipient:"proxy",type:"setUserInfo",data:{jwt:g}};a.debug&&K.log("authUtil ...sendUserInfoToProxy...jwt msg="+JSON.stringify(h));return y(m,Nd(a,h,"setUserInfo"),8);case 8:return(l=m.j)?m.return(!0):
m.return(!1);case 5:F(m,0);break;case 2:return H(m),m.return(!1)}})}function Id(a){var b;J(function(c){if(1==c.h)return b={recipient:"proxy",type:"userLogout"},y(c,Nd(a,b,"userLogout"),2);A(c)})}function Jd(a){var b;J(function(c){b={recipient:"proxy",type:"reloadPolicy"};return y(c,Nd(a,b,"reloadPolicy"),0)})}function Kd(a){var b;J(function(c){b={recipient:"proxy",type:"uploadProxyLog"};return y(c,Nd(a,b,"uploadProxyLog"),0)})}
function Ld(a){var b,c;return J(function(d){if(1==d.h)return b={recipient:"proxy",type:"getUuid"},y(d,Nd(a,b,"getUuid",!0),2);if((c=d.j)&&c.response)return c.response.error?(a.debug&&K.log("getUuid error: "+c.response.error),d.return(null)):d.return(c.response.uuid);throw Error("getScriptServerUUID no resp");})}
function Od(){J(function(a){setTimeout(function(){var b=require("child_process");process.platform.toLowerCase().startsWith("win")&&b.exec("Deledao.exe --notify",{cwd:"..\\"},function(c,d,e){if(c||e)return!1})},15E3);A(a)})}
function Md(a,b,c,d,e,f){var g,h,l,m,n;return J(function(q){if(1==q.h)return g=a.h+"signAuthInfo",h={version:"1.0",info:{authToken:b,uuid:c,userId:d,userName:e,rememberMe:f}},C(q,2),y(q,id(a.i.http,"POST",g,JSON.stringify(h),2),4);if(2!=q.h)return l=q.j,a.debug&&K.log("signAuthInfo resp="+l),m=JSON.parse(l),m.error?(a.debug&&K.log("signAuthInfo error: Invalid auth token"),q.return(null)):q.return(m.jwt);n=H(q);a.debug&&K.log("signAuthInfo error: "+n);return q.return(null)})}
function Nd(a,b,c,d){d=void 0===d?!1:d;var e,f,g,h;return J(function(l){if(1==l.h)return a.debug&&K.log("sendMsgToScriptServer msgOrg="+JSON.stringify(b)),e={message:b},C(l,2),y(l,id(a.i.http,"POST","https://dldss.deledao.com/sendMessage",JSON.stringify(e),2,1),4);if(2!=l.h){f=l.j;a.debug&&K.log("sendMsgToScriptServer msg="+JSON.stringify(e)+"; resp="+f);g=JSON.parse(f);if(d)return l.return(g);if(g&&g.response)return g.response.error?(a.debug&&K.log("sendMsgToScriptServer type="+c+"; err="+g.response.error),
l.return(!1)):l.return(!0);throw Error("sendMsgToScriptServer no resp: type="+c);}h=H(l);a.debug&&K.log("sendMsgToScriptServer type="+c+" error: "+h);return l.return(!1)})};function Pd(a){this.i=a;this.u=this.i.u;this.C=this.i.C;this.debug="true"===this.i.s["debug.runtime.debug"];this.trace="true"==this.i.s["debug.runtime.trace"];this.l=this.init()}k=Pd.prototype;
k.init=function(){var a=this,b,c,d,e,f,g,h,l,m,n,q,u,r,p,v,w;return J(function(z){switch(z.h){case 1:a.ic={};a.ready=!1;a.v=Cc();a.i.H.addListener(function(B){if("userSignedIn"==B.type){a.debug&&K.log("[RT] User signed in as "+B.data.Pb+" ("+B.data.userName+"), OU: "+B.data.jb+", groups:"+B.data.groups);var D=B.data.Pb,E=B.data.userName;D==a.env.Va&&D==a.env.zj||K.warn("["+a.u+"]["+a.C+"][RT] Setting user ID.",D);a.env.Va=D;a.env.username=E;a.env.zj=D;a.env.gh=B.data.gh;a.env.jb=B.data.jb;a.env.groups=
B.data.groups;a.env.Xj=Date.now();a.i.I&&Qd(a.i.I,"userSignedIn "+a.env.Va+(" ("+B.data.ae+"). OU="+a.env.jb+", groups="+a.env.groups+"."));B=Object.assign({},B);B.type="postUserSignedIn";a.i.H.sendMessage(B)}else"userSignedOut"==B.type?(a.debug&&K.log("[RT] User signed out."),a.i.I&&Qd(a.i.I,"userSignedOut "+a.env.Va),Rd(a),a.env.jb=void 0,a.env.groups=void 0,a.env.Xj=void 0):"customerSignedIn"==B.type?(a.debug&&K.log("[RT] Customer signed in."),a.i.I&&Qd(a.i.I,"customerSignedIn "+a.env.Va)):"customerSignedOut"==
B.type?(a.debug&&K.log("[RT] Customer signed out."),a.i.I&&Qd(a.i.I,"customerSignedOut "+a.env.Va),Rd(a),a.env.jb=void 0,a.env.groups=void 0):"computerSleepDetected"==B.type?a.h&&a.h():"localIpAddressChanged"==B.type?(Sd(a),Td(a,B.data.ba)):"policyChanged"==B.type&&(Sd(a),Ud(a))});a.i.addListener(function(B,D,E){a.i.disabled||"runtime"!=B.recipient||("deviceInfo"==B.type?(D=B.data,K.log("["+a.u+"]["+a.C+"][RT] Got device info: "+JSON.stringify(B.data)),B=!1,a.env.ba&&JSON.stringify(a.env.ba)==JSON.stringify(D.ba)||
(B=!0),a.env.ba=D.ba,a.env.deviceName=D.deviceName,D.userAgent&&(D=Rc(D.userAgent),a.env.browser=D.browser,D=D.system,88==Q.platform&&(D="cloud-"+D),D!=a.env.platform&&(a.env.platform=D,K.log("["+a.u+"]["+a.C+"][RT] Set env.platform=",a.env.platform))),E&&E({ok:!0}),B&&a.i.H.sendMessage({type:"localIpAddressChanged",data:{ba:a.env.ba}})):"getSessionKey"==B.type?E({key:a.v}):"cloudClientIpChanged"==B.type&&88==Q.platform&&12==Q.za&&(K.log("["+a.u+"]["+a.C+"][RT] Cloud client IP address changed. Update off campus from remote."),
Vd(a.i.policy,!1)))});a.env={uuid:a.i.s["env.uuid"],rd:a.i.s["env.authToken"],lo:a.i.s["env.authToken.expire"],Va:Q.qd,username:Q.Pd,xa:!1};switch(Q.platform){case 12:a.env.Oh="ext";break;case 33:a.env.Oh="ipad";break;case 99:a.env.Oh="proxy";break;case 88:a.env.Oh="cloud"}if(12==Q.platform){md(a.i.http,chrome.runtime.getURL("env.json")).then(function(B){try{var D=JSON.parse(B);a.i.I&&a.i.I.Ya&&a.i.I.Ya("Get OS user ID from env.json. "+D.login);Wd(a,D.login,D.username)}catch(E){K.error("env.json is not a valid JSON")}}).catch(function(B){K.warn("env.json: "+
B)});md(a.i.http,chrome.runtime.getURL("lstore.json")).then(function(B){try{K.log("Loading custom local storage variables from lstore.json");for(var D=JSON.parse(B),E=t(Object.keys(D)),G=E.next();!G.done;G=E.next()){var M=G.value;a.i.s[M]=D[M];K.log("Set lstore "+M+" = "+D[M])}}catch(T){K.error("Loading lstore.json: "+T)}}).catch(function(){});z.m(2);break}if(99!=Q.platform){z.m(2);break}try{b=nodeMods.os.userInfo().username,a.i.I&&a.i.I.Ya&&a.i.I.Ya("Get OS user ID from node os user info. "+b),Wd(a,
b)}catch(B){K.error("Node.js: os.userInfo(): "+B)}a.env.deviceName=nodeMods.os.hostname();if("win32"==process.platform&&"system"==a.env.Ha.toLowerCase())return K.log("Running as Windows SYSTEM user ..."),f=function(){return J(function(B){return B.return(new Promise(function(D,E){var G=nodeMods.os.release(),M=G.indexOf(".");-1!=M&&(G=G.substr(0,M));G=parseInt(G);nodeMods.child_process.execFile("powershell.exe",["get-wmiobject -Class Win32_Computersystem | select "+(10>G?"PrimaryOwnerName":"Username")],
function(T,O,R){if(T)E(T);else if(O){for(R=O.split("\r\n");0<R.length;)if(T=R.pop().trim()){T.startsWith("-----")?D(""):(R=T.indexOf("\\"),-1!=R&&(T=T.substring(R+1)),D(T));break}E("stdout: "+O)}else R?E("stderr: "+R):E("empty powershell output")}).stdin.end()}))})},C(z,10),y(z,f(),12);if("darwin"!=process.platform||"root"!=a.env.Ha.toLowerCase()){z.m(5);break}c=function(){return J(function(B){return B.return(new Promise(function(D,E){nodeMods.child_process.execFile("bash",["-c","who | awk '{ if ($2 == \"console\") print $1 }'"],
function(G,M,T){G?E(G):M?(G=M.split("\n"),G[0]?D(G[0]):E("empty console user name")):T?E("stderr: "+T):E("empty console user name")}).stdin.end()}))})};C(z,7);return y(z,c(),9);case 9:d=z.j;a.i.I&&a.i.I.Ya&&a.i.I.Ya("Get OS user ID from who. "+d);Wd(a,d);F(z,5);break;case 7:e=H(z);Xd(a);K.error("Can't get Mac username: "+e);z.m(5);break;case 12:g=z.j;a.i.I&&a.i.I.Ya&&a.i.I.Ya("Get OS user ID from powershell. "+g);Wd(a,g);F(z,5);break;case 10:h=H(z),Xd(a),K.error("Can't get Windows username: "+h);
case 5:l=Yd;if(99==Q.za)try{m=nodeMods.fs.readFileSync(l),n=JSON.parse(m),a.i.I&&a.i.I.Ya&&a.i.I.Ya("Get OS user ID from family user session. "+n.username),Wd(a,n.username),a.env.uid=n.uid,a.env.Us=n.gid,a.env.Ng=n.isadmin}catch(B){K.error("userSession.json is not a valid JSON")}try{nodeMods.fs.existsSync(l)||nodeMods.fs.writeFileSync(l,""),nodeMods.fs.watch(l,function(){try{var B=nodeMods.fs.readFileSync(l);K.log("OS user logon/logoff event detected: "+B);var D=JSON.parse(B)}catch(E){return}D.time==
q&&K.log("Event already processed, skipping ...");q=D.time;B=D.reason;if("logoff"==B)K.log("System event: "+B+": signing out current user"),a.i.I&&a.i.I.Ya&&a.i.I.Ya("Clear OS user ID on "+B+" event."),Xd(a),a.i.G.jd(),a.i.H.sendMessage({type:"osLogonEvent",data:{event:"logoff"}});else if("logon"==B||"unlock"==B)if(D.username!=a.env.Ha&&(a.i.I&&a.i.I.Ya&&a.i.I.Ya("Update OS user ID on "+B+" event. "+D.username),Wd(a,D.username),K.log("System event: "+B+": signing off current user,  new user: "+a.env.Ha),
a.i.G.jd(),a.i.H.sendMessage({type:"osLogonEvent",data:{event:"logon"}})),"logon"==B&&99==Q.za&&(a.i.I&&a.i.I.Ya&&a.i.I.Ya("Update OS user ID on family "+B+" event. "+D.username),Wd(a,D.username),a.env.uid=D.uid,a.env.Us=D.gid,a.env.Ng=D.isadmin))D=a.i.policy,D.debug&&K.log("policy live disabled due to admin login."),D.Un=!0,D.yh=D.zn,D.i.H.sendMessage({type:"policyLiveDisabled"}),Od()})}catch(B){K.error("Error watching user Session file: "+l+": "+B)}case 2:a.env.Ha&&K.log("["+a.u+"]["+a.C+"][RT] OS user: "+
a.env.Ha+" ("+a.env.Wg+").");switch(Q.platform){case 12:case 33:K.log("User Agent: "+navigator.userAgent);try{if(u=Rc(navigator.userAgent))a.env.platform=u.system,a.env.browser=u.browser}catch(B){}break;case 99:r=process.platform;r="win32"==r?"windows":"darwin"==r?"mac":"linux"==r?"linux":"other-"+r;a.env.platform=r;K.log("OS version: "+nodeMods.os.release());break;case 88:a.env.platform="cloud"}K.log("Platform: "+a.env.platform);12==Q.platform&&chrome.runtime.onMessageExternal.addListener(function(B,
D,E){"HealthCheck"==B.type?E({success:!a.i.disabled}):"refreshPolicy"==B.type&&(!a.o||1E4<Date.now()-a.o?(a.debug&&K.log("[1568] Got refresh policy message."),a.o=Date.now(),Sb(a.i.policy),E({error:void 0})):(K.warn("[1568] Throttle refresh policy message."),E({error:"throttled"})))});88!=Q.platform&&(p=Date.now(),a.i.setInterval(function(){var B=Date.now(),D=B-p;6E3<D&&(a.debug&&K.error("[RT] Computer sleep detected. sleep time=",Math.floor(D/1E3),"s. Now=",(new Date).toLocaleString("en-US")),a.i.H.sendMessage({type:"computerSleepDetected",
data:{Gx:p,Ey:D}}),D=Math.floor(D/1E3/60),5<=D&&a.i.I&&Qd(a.i.I,"Computer slept "+D+" minutes."));p=B},5E3));a.env.uuid||(a.env.uuid=a.i.s["env.uuid"]=Cc());a.env.version=a.i.ob();a.env.Hc=a.i.Hc();K.log("["+a.u+"]["+a.C+"][RT] Env version=",a.env.version,", isManifestV3OrLater=",a.env.Hc);v=[];if(12==Q.platform||99==Q.platform)w=Zd(a),v.push(w),a.i.setInterval(function(){Zd(a)},6E4),a.h=function(){setTimeout(function(){Zd(a)},5E3);setTimeout(function(){Zd(a)},2E4)},12==Q.platform&&chrome.idle.onStateChanged.addListener(function(B){"active"==
B&&(a.debug&&K.log("[RT] chrome.idle new state is active."),a.h())});if(12==Q.platform||33==Q.platform)setTimeout(function(){$d(a)},15E3),a.i.setInterval(function(){$d(a)},36E5);return z.return(Promise.all(v).then(function(){a.ready=!0;a.debug&&K.log("["+a.u+"]["+a.C+"][RT] Initialization completed. env=",a.env);a.i.H.sendMessage({type:"runtimeInitDone"})}).catch(function(B){K.error("["+a.u+"]["+a.C+"][RT] Init error: "+B)}))}})};
function ae(a,b){var c=a.env.groups;b.group=a.env.jb;b.groups=c;b.groups&&0!=b.groups.length||!b.group||(b.groups=[b.group]);a.i&&a.i.policy&&a.i.policy.Ms&&(a=a.i.policy.we)&&(b.group=a)}function ce(a,b){var c=a.env.xa;void 0!==a.i.s["debug.offcampus.debug"]?a.env.xa="true"===a.i.s["debug.offcampus.debug"]:a.env.xa=b;K.log("["+a.u+"]["+a.C+"][RT] Set off campus="+a.env.xa);return a.env.xa!=c}function Xb(a,b,c){b.user=a.env.username;b.Z=a.env.Va;c&&(b.zj=a.env.zj,b.fk=a.env.fk)}
function Rd(a){a.env.Va=void 0;a.env.username=Q.Pd}k.va=function(){return this.env.Va==Q.qd?void 0:this.env.Va};function Wd(a,b,c){b==a.env.Ha&&b==a.env.fk||K.warn("["+a.u+"]["+a.C+"][RT] Setting OS user ID.",b);a.env.Ha=b;a.env.Wg=c;a.env.fk=b}function Xd(a){a.env.Ha=Q.qd;a.env.Wg=Q.Pd}k.ob=function(){return this.env.version};k.Lg=function(){return void 0!=this.va()};function de(a){return"chrome"==a.env.platform}
function ee(a,b){if(a.i.policy){var c=a.i.policy.M;c?0!==Object.keys(c).length&&(a.j=c.Ko):delete a.j}if(a.j)return fe(a.j,b)}function fe(a,b){a=t(a.split(";"));for(var c=a.next();!c.done;c=a.next())if(c=c.value.trim().split("=",2),c[0]==b)return c[1].trim()}
function ge(a,b){function c(f){for(var g=0;g<f.length;g++)if(void 0!=f[g])return"string"==typeof f[g]?"true"==f[g]:f[g]}var d=a.i.policy&&he(a.i.policy)||{},e=a.i.policy&&a.i.policy.M||{};switch(b){case "ganon":return c([a.ic.rx,a.i.s["debug.ganon"],d.setting&&d.setting.Wc,e.Wc]);case "dynta":return c([a.ic.hx,a.i.s["debug.dta.enabled"],d.setting&&d.setting.bd,e.bd]);case "dynia":return c([a.ic.fx,a.i.s["debug.dia.enabled"],d.setting&&d.setting.ad,e.ad]);case "dynva":return c([a.ic.ix,a.i.s["debug.dva.enabled"],
d.setting&&d.setting.cd,e.cd]);case "dynab":return c([a.ic.dx,a.i.s["debug.dab.enabled"],1==e.Rh&&d.setting&&0!=d.setting.Rh,!0]);case "class":return c([a.ic.Nw,a.i.s["debug.clm.enabled"],ee(a,"clm.connect"),e.Ro]);case "dynfb":return c([a.ic.ex,a.i.s["debug.dfb.enabled"],e.Yl]);case "dynsf":return c([a.ic.gx,a.i.s["debug.dsf.enabled"],d.setting&&d.setting.Fj,e.Fj]);case "dyngm":return ie(a.i.policy)&&33!=Q.platform&&c([d.setting&&d.setting.us,!0]);case "dtaSensi":return a.ic.ls||d.setting&&d.setting.Wd||
e.Wd||"medium";case "diaSensi":return a.ic.ds||d.setting&&d.setting.Ud||e.Ud||"medium";case "dvaSensi":return a.ic.ms||d.setting&&d.setting.Xd||e.Xd||"medium";case "basicAssetTracking":return c([a.i.s["debug.basicAssetTracking.enabled"],e.Zo?e.Zo.yr:void 0]);case "recordGeolocation":return c([ee(a,"rt.recordGeoloc"),e.xu])}}k.getAuthToken=function(){return this.env.rd};function je(a){return a.env.rd?a.env.rd:a.env.vu}
function ke(a,b,c){a.trace&&K.log("Set auth token:",b&&b.substring(0,5),"... . Expire at:",c);a.env.rd&&(a.env.vu=a.env.rd);(a.env.rd=b)?a.i.s["env.authToken"]=b:a.i.s.removeItem("env.authToken");c?(a.env.lo=c,a.i.s["env.authToken.expire"]=c):(a.env.lo=void 0,a.i.s.removeItem("env.authToken.expire"))}
function le(){var a,b;return J(function(c){if(1==c.h)return C(c,2),y(c,fetch("https://google.com",{method:"GET",cache:"no-cache"}),4);if(2!=c.h)return a=c.j,c.return(a.ok);b=H(c);K.error("[Runtime] Check Internet error.",b);A(c)})}
function me(){fetch("https://google.com",{method:"GET",cache:"no-cache"}).then(function(a){a.ok?K.error("CGNAT pass Internet check. status="+a.status+", ok="+a.ok):K.error("CGNAT fail Internet check. status="+a.status+", ok="+a.ok)}).catch(function(a){K.error("CGNAT error Internet check.",a)})}function Td(a,b){if("true"==ee(a,"internet.check")){a=!0;b=t(b);for(var c=b.next();!c.done;c=b.next())Zc(c.value)||(a=!1);a&&(me(),setTimeout(function(){me()},1E4),setTimeout(function(){me()},2E4))}}
function Sd(a){if(12==Q.platform)try{ge(a,"recordGeolocation")||ge(a,"basicAssetTracking")?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){a.env.bc={Ct:b.coords.latitude,Jt:b.coords.longitude}},function(b){K.error("Get geolocation error.",b.code,b.message)},{timeout:15E3,enableHighAccuracy:!0}):K.warn("Geolocation is not supported."):delete a.env.bc}catch(b){K.warn("Get geolocation exception.",b)}}
function Ud(a){a.env.device={};if(12==Q.platform)try{ge(a,"basicAssetTracking")&&(chrome.enterprise?(chrome.enterprise.deviceAttributes.getDeviceAssetId(function(b){a.env.device.qr=b}),chrome.enterprise.deviceAttributes.getDirectoryDeviceId(function(b){a.env.device.deviceId=b}),chrome.enterprise.deviceAttributes.getDeviceAnnotatedLocation(function(b){a.env.device.nr=b}),chrome.enterprise.deviceAttributes.getDeviceSerialNumber(function(b){a.env.device.serialNumber=b})):K.error("Device attribtes not supported."))}catch(b){K.error("Get device attributes error.",
b)}}function ne(){return J(function(a){return a.return(new Promise(function(b){var c=[],d=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.Xx;d||b(c);var e=new d({iceServers:[]});e.onicecandidate=function(f){f.candidate&&f.candidate.candidate?(f=/^candidate:.+ (\S+) \d+ typ/.exec(f.candidate.candidate)[1],/^(\d{1,3}\.){3}\d{1,3}$/.test(f)&&-1==c.indexOf(f)&&c.push(f)):(e.close(),b(c))};e.createDataChannel("");e.createOffer(function(f){e.setLocalDescription(f)},function(){})}))})}
function Zd(a){var b,c,d,e,f,g,h,l;return J(function(m){if(1==m.h)return b=function(){if(12==Q.platform)return ne();if(99==Q.platform){for(var n=[],q=nodeMods.os.networkInterfaces(),u=t(Object.keys(q)),r=u.next();!r.done;r=u.next()){r=t(q[r.value]);for(var p=r.next();!p.done;p=r.next())p=p.value,"IPv4"!=p.family||p.Dx||n.push(p.address)}return n}},C(m,2),a.debug&&K.log("[RT] About to get local IP address."),y(m,b(),4);if(2!=m.h){c=m.j;d=!1;c||(c=[]);a.debug&&K.log("[RT] Got local IP address: "+c.join(", "));
a.env.ba||(a.env.ba=[]);if(c.length!=a.env.ba.length)d=!0;else for(e=t(c),f=e.next();!f.done;f=e.next())if(g=f.value,-1==a.env.ba.indexOf(g)){d=!0;break}a.env.ba=c;a.env.ba&&0!=a.env.ba.length?a.env.be=a.env.ba[0]:(a.env.be=null,a.env.Hc?a.debug&&K.log("[RT] Cannot get IP, no retry."):(a.debug&&K.log("[RT] Cannot get IP, retry after 1 second."),setTimeout(function(){Zd(a)},1E3)));d&&(a.debug&&K.log("[RT] IP address changed to: "+a.env.ba.join(", ")),h={type:"localIpAddressChanged",data:{ba:a.env.ba}},
a.i.H.sendMessage(h));return F(m,0)}l=H(m);K.warn("[RT] Failed to get local IP address: "+l);A(m)})}
function $d(a){for(var b=0,c={},d=0;d<a.i.s.length;d++){var e=a.i.s.key(d),f=e.length+a.i.s[e].length;b+=f;e.startsWith("cache-storage.")?(e="CACHE."+e.split(".")[1],c[e]||(c[e]=0),c[e]+=f):c[e]=f}if(.95<b/5242880){d=Object.keys(c).sort(function(h,l){return c[l]-c[h]});f="local storage almost full: "+Math.round(b/1024)+" KB used ("+Math.round(b/5242880*100)+"%)\n";for(var g=e=0;10>e||.9>g/b;e++)g+=c[d[e]],f+=d[e]+": "+c[d[e]]+" bytes.\n";K.error(f);b=[];for(d=0;d<a.i.s.length;d++)a.i.s.key(d).startsWith("cache-storage.default.")&&
b.push(a.i.s.key(d));b=t(b);for(d=b.next();!d.done;d=b.next())delete a.i.s[d.value]}};function oe(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.class.debug"];this.enable=!1;this.zc=["accounts.google.com","accounts.youtube.com","login.microsoftonline.com"];this.l=[];this.j=void 0;this.o=0;this.h=void 0;this.gg=function(c){return J(function(d){if(b.i.disabled)return d.return();"changeClassroomSession"==c.type?(b.debug&&K.log("changeClassroomSession.",c.data),b.h=new pe(b.debug,c.data),c.data.Y!=b.D&&qe(b),b.D=c.data.Y):"classDisconnected"==c.type&&(b.debug&&K.log("classDisconnected.",
c.data),"control"==c.data.mode&&(b.h=void 0,qe(b)));A(d)})};this.i.H.addListener(function(c){b.gg(c)})}
function qe(a){var b,c,d,e,f,g;J(function(h){if(1==h.h){K.log("[CLM] Blocking guideline changed.");b={recipient:"blockingPageFront",nn:!0,type:"blockingGuidelineChanged"};if(12==Q.platform)return chrome.tabs.query({},function(l){a.debug&&K.log("[CLM] Notify frontend of blocking guideline change.");if(l){l=t(l);for(var m=l.next();!m.done;m=l.next())chrome.tabs.sendMessage(m.value.id,b)}}),h.m(0);if(99!=Q.platform)return h.m(0);c=a.i.ja.Ad();return y(h,c.cc(),4)}d=h.j;e=t(d);for(f=e.next();!f.done;f=
e.next())(g=f.value)&&c.Mb(g.id,b);A(h)})}function re(a,b,c){try{if(a.l=[],a.timeZone=c,a.j=void 0,b){a.debug&&K.log("setclass:",b);for(c=0;c<b.length;c++)if(b[c].name&&""!==b[c].name.trim()&&b[c].ol)try{var d=b[c];if(d.wk&&!d.wk.name)throw Error("Session has no name. "+d.name);var e=new pe(a.debug,d);a.l.push(e)}catch(f){K.error("Create classroom fail.",f)}se(a)}else a.debug&&K.log("setclass empty")}catch(f){K.error("Set class fail.",f)}}oe.prototype.Qh=function(a){this.enable=a};
oe.prototype.wf=function(){if(this.h)return this.h.B.eh;if(0!=this.l.length&&(te(this),this.j))return this.j.B.eh};oe.prototype.Ig=function(){if(this.h)return this.h.Hg();if(0!=this.l.length&&(te(this),this.j))return this.j.Hg()};oe.prototype.ze=function(){if(this.h)return this.h.B.bb;if(0!=this.l.length&&(te(this),this.j))return this.j.B.bb};
function se(a){a.j=void 0;a.o=Date.now();var b=new Date,c=(a.timeZone?b.toLocaleString("en-GB",{timeZone:a.timeZone}):b.toLocaleString("en-GB")).slice(12,17);b=a.timeZone?new Date(b.toLocaleString("en-US",{timeZone:a.timeZone})):new Date(b.toLocaleString("en-US"));c={Ww:b.getTime(),Rr:c,Wr:b.getDay()};a.debug&&K.log("getNowInSZone:",c);for(b=0;b<a.l.length;b++){a:{var d=a.l[b];for(var e=c.Rr,f=c.Wr,g=(new Date).toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"numeric"}),h=0;h<d.B.ol.length;h++){var l=
d.B.ol[h],m;if(m=l.Vr==f){m=lc(l.startTime);var n=lc(l.endTime);if(m=n>=m?e>=m&&e<=n?!0:!1:e>=m&&"23:59">=e?!0:"00:00"<=e&&e<=n?!0:!1){m=(new Date(g+" "+l.startTime)).getTime();n=(new Date(g+" "+l.endTime)).getTime();var q=d.B;m=q&&Array.isArray(q.history)?(q=q.history[q.history.length-1])?n>q.end&&m<=q.end?!0:!1:!1:!1;m=!m}}if(m){d.debug&&K.log("getCurClass: found",l);d=!0;break a}}d.debug&&K.log("getCurClass: not found.");d=void 0}if(d){a.j=a.l[b];a.debug&&K.log("refreshCurrentClass: found "+a.j.Hg());
break}}!a.j&&a.debug&&K.log("refreshCurrentClass: not found.")}function te(a){6E4<Date.now()-a.o&&se(a)}
function pe(a,b){this.debug=a;if(b.wk){var c=b.wk;b.Y=c.name;b.cf=c.cf;b.wc=c.mr;b.Wb=c.Wb}if(b.wc)for(c=0;c<b.wc.length;c++){var d=b.wc[c];-1==d.search(/^http[s]?:\/\//)&&-1==d.search(/^ftp:\/\//)&&(b.wc[c]="https://"+d);b.wc[c]=Ac(b.wc[c])}if(b.Wb)for(c=0;c<b.Wb.length;c++)d=b.Wb[c],-1==d.search(/^http[s]?:\/\//)&&-1==d.search(/^ftp:\/\//)&&(b.Wb[c]="https://"+d),b.Wb[c]=Ac(b.Wb[c]);this.B=b;this.h="classroom: "+b.eh+" "+b.name;b.Y&&(this.h+=". session: "+b.Y);this.qc=new od(a,this.B.Wb,this.B.wc,
void 0,"classroom")}pe.prototype.Hg=function(){return this.B.name};function ue(a,b){b=a.qc.Yg(b);var c=a.B&&a.B.Y?a.B.Y:"";Ad(b)||a.B.cf||!c?b.X=a.h+", "+b.X:xd(b,Q.Pa,"classroom rule",'Site bank "'+c+'" in classroom "'+a.Hg()+'" blocks all websites by default');return b};function ve(){S.call(this,{ol:"agenda",fj:"allowBlacklistOverride",xv:"ApproveTime",yv:"Approver",Wb:"blockedUrls",Ab:"ConfigString",Tk:"Classrooms",Mv:"CustID",Oq:"DynWhiteList",Mq:"DebugFlags",Error:"Error",Qq:"ExpirationTime",On:"ParentRule",Xv:"PaymentProcessor",$q:"RemoteDebug",aw:"Requester",pd:"Version",Hu:"Scope",Ci:"Url",bf:"actionID",io:"actionName",actions:"actions",jr:"adDomain",pw:"adminSetting",dj:"adWhitelist",Hk:"trackingWhitelist",kr:"alerts",cf:"allowAllSites",jo:"allowClassroomOffHours",
mr:"allowedUrls",tw:"approveTime",uw:"approver",pg:"azure",Ub:"blacklist",rg:"blacklistIDs",Vc:"blacklists",Aw:"blacklistToggle",yr:"basicAssetTracking",Ar:"blackOutFoulWordsOnWebpages",ef:"blockAds",ib:"blockCategory",Wc:"blockGoogleSearchTracking",ff:"blockTracking",Dw:"blockingPage",Fr:"cannotUnblockInBlockList",vg:"categories",channels:"channels",Pw:"classobj",bb:"classUUID",Jr:"clickToZoom",$:"condition",Sw:"conditionName",K:"configObj",content:"content",Fo:"created",Zb:"custName",Vr:"dayOfWeek",
xe:"dateRange",xg:"daysOfWeek",Ko:"debugString",Yw:"defact",Nh:"defActionID",Zw:"defrule",Yr:"defRuleID",Rl:"desktopView",Ud:"diaSensitivity",Lo:"diaRestrictiveMode",cs:"diaModestyMode",Tl:"disableExtNonCbooks",Cj:"disableUnblockLink",bx:"disabledUntil",domain:"domain",Wd:"dtaSensitivity",Xd:"dvaSensitivity",cx:"dynWhitelist",Wl:"dynWhitelistConf",email:"email",kx:"emailTemplate",enable:"enable",enabled:"enabled",qs:"enableAddBlacklist",Qo:"enableAddCategories",rs:"enableAddWhitelist",Qh:"enableClassroom",
To:"enableConfVA",Ro:"enableCLM",Rh:"enableDAB",Yl:"enableDFB",us:"enableDGM",ad:"enableDIA",bd:"enableDTA",cd:"enableDVA",Fj:"enableDSF",vs:"enableDynWhitelist",end:"end",endTime:"endTime",Uo:"endDate",Vo:"endIP",Wo:"enforceClassroomOffCampus",Jj:"exclusiveTimeRange",Zo:"experimental",expires:"expires",lx:"expirationTime",fp:"forcedSignIn",frequency:"frequency",from:"from",M:"globalSettings",Ae:"googleSafeSearch",groups:"groups",ku:"ous",Dd:"gsuite",zf:"homePage",pp:"homePlan",eb:"homeUsers",http:"http",
https:"https",id:"id",ec:"idaas",Zh:"ipad",U:"ipRange",xa:"isOffCampus",Wj:"keywords",Hx:"listID",Ix:"listName",localStorage:"localStorage",location:"location",Ox:"maxExpiration",message:"message",Hp:"needUploadActivity",name:"name",Tg:"netmask",network:"network",fu:"noIPDomain",order:"order",Kb:"parentPortalConf",Ie:"passhash",Le:"policyTypeGroup",py:"policyToggle",vb:"policyVersion",xu:"recordGeoLocations",Wm:"remoteLearning",ge:"removeYtSuggestions",Yp:"report",vy:"requester",qk:"reserved",wc:"restrictions",
Fu:"restrictSignInDomains",wy:"restrictionToggle",result:"result",sk:"ruleID",F:"ruleName",rules:"rules",$m:"ruleSet",$p:"ruleTemplateIds",si:"ruleTemplates",yy:"schedule",an:"schoolHours",scope:"scope",hw:"ScopeType",eq:"seAllowWords",ti:"seBlockWords",wk:"sessionStartsWith",setting:"setting",bh:"spec",start:"start",startTime:"startTime",Ak:"startDate",Kd:"startIP",status:"status",Jy:"students",Qe:"subject",eh:"teacher",My:"templateID",Vu:"templateName",Py:"theclass",mn:"timedWhitelist",nq:"timedYoutubeWhitelist",
yi:"timeRange",timeZone:"timeZone",timestamp:"timestamp",title:"title",oe:"to",qn:"trustWindowsLogon",type:"type",tq:"upgradable",url:"url",urls:"urls",uq:"UrlScopeType",username:"username",Te:"users",Wy:"validDates",Qb:"videos",wn:"webpageScope",jh:"whitelistIDs",zc:"whitelists",Za:"whitelist",ez:"whitelistToggle",yq:"wpBlackOutFoulWords",lh:"youtubeBlacklist",mh:"youtubeBlacklistIDs",Nd:"youtubeBlacklists",qe:"youtubeFiltering",Aq:"youtubeFilteringMode",nh:"youtubeWhitelist",oh:"youtubeWhitelistIDs",
Od:"youtubeWhitelists",wj:"customBlockingPage",ts:"enableCBP",Vg:"oem",ng:"allowChatInClassConfig",Bh:"allowChatInClass",lr:"allowOnlyT2SChat",bp:"fcAlert",am:"filterCategories",yt:"isPenaltyBoxRule",jv:"usersWithExpiration",Z:"userId",Br:"blockYtShorts",Ow:"classLink",history:"history"},"PolicyObfuscator",!0,!0)}x(ve,S);function we(){S.call(this,{G:"auth",Ke:"policyTimestamp",Pb:"userID",uuid:"uuid",version:"version"},"GetConfigReqObf")}x(we,S);var xe=new we;
function ye(){S.call(this,{version:"version",G:"auth"},"GetOffCampusReqObf")}x(ye,S);var ze=new ye;function Ae(){S.call(this,{Error:"Error",Mn:"OffCampus"},"GetOffCampusRespObf")}x(Ae,S);var Be=new Ae;function Ce(a,b,c,d,e,f,g){this.debug=a;this.location=b;this.U=c;this.yi=d;this.Jj=e;this.groups=f;this.Te=g}
function De(a,b){if(!a.U||0===a.U.length||1==a.U.length&&void 0!==a.U[0].network&&""===a.U[0].network.trim()||1==a.U.length&&void 0!==a.U[0].Kd&&""===a.U[0].Kd.trim())return!0;if(!b||0===b.length){a=t(a.U);for(var c=a.next();!c.done;c=a.next())if(c=c.value,c.network&&c.network.trim()||c.le||c.nf)return!1;return!0}c=!1;b=t(b);for(var d=b.next();!d.done;d=b.next()){d=d.value;a.debug&&K.log("inIPRange checking ip "+kc(d));for(var e=0;e<a.U.length;e++)if(a.U[e].network&&""!==a.U[e].network.trim()){if(a.debug&&
K.log("inIPRange ip "+e+" "+kc(a.U[e].gi)+"; mask="+a.U[e].Tg),d>>>32-a.U[e].Tg>>>0===a.U[e].gi>>>32-a.U[e].Tg>>>0){c=!0;break}}else if(a.debug&&K.log("inIPRange "+e+" startip"+kc(a.U[e].le)+"; endip="+kc(a.U[e].nf)),void 0===a.U[e].le||d>=a.U[e].le&&d<=a.U[e].nf){c=!0;break}if(1==c){a.debug&&K.log("inIPRange ip "+kc(d)+" is in range");break}}return c}
function Ee(a,b,c,d){if(!b||0===b.length)return c?{result:!1}:{result:!0};a=new Date(a);a=new Date(d?a.toLocaleString("en-US",{timeZone:d}):a.toLocaleString("en-US"));for(var e=!1,f=Bc(a),g=lc(a.getHours()+":"+a.getMinutes()),h,l,m,n,q=0;q<b.length;q++){if(b[q].from&&0<b[q].from.length)if(h=lc(b[q].from),l=lc(b[q].oe),h<l){if(g>l||g<h)continue}else if(g>l&&g<h)continue;if(void 0!==b[q].xg){if(0===(f&b[q].xg))if(h>l){if(0===(Bc(a,-1)&b[q].xg)||g>l)continue}else continue;else if(h>l&&g<l&&0===(Bc(a,
-1)&b[q].xg))continue;d=void 0;if(b[q].xe&&b[q].xe.Ak){var u=new Date(b[q].xe.Ak.concat(" 00:00:00"));d=new Date(b[q].xe.Uo.concat(" 23:59:59"));if(a>d||a<u)continue}else if(c)continue;l&&(b=a.getMonth()+1+"/"+a.getDate()+"/"+a.getFullYear()+" ",n=new Date(b+h),m=new Date(b+l+":59"),l<h&&(h=new Date(a),h.setDate(a.getDate()+1),!d||d&&d>=h?(b=h.getMonth()+1+"/"+h.getDate()+"/"+h.getFullYear()+" ",m=new Date(b+l+":59")):m=new Date(b+" 23:59:59")));e=!0;break}}return{result:e,startTime:n,endTime:m}}
function Fe(a,b){if(void 0==b)return!0;for(var c=!1,d=b.toLowerCase().trim(),e=t(a.groups),f=e.next();!f.done;f=e.next())if(f=f.value,d.startsWith(f.toLowerCase().trim())){a.debug&&K.log("ou "+b+" matches group "+f);c=!0;break}return c}function Ge(a,b){var c=!1;b=b.toLowerCase().trim();a=t(a.Te);for(var d=a.next();!d.done;d=a.next())if(b===d.value.toLowerCase().trim()){c=!0;break}return c}
Ce.prototype.Mg=function(a,b,c,d,e,f,g){d=De(this,d);a:{if(this.Jj){var h=Ee(f,this.Jj,!0,g);if(h&&h.result){f={result:!1};break a}}f=Ee(f,this.yi,!1,g)}g=f&&f.result;a=c?this.Te&&0!==this.Te.length?this.groups&&0!==this.groups.length?b&&Fe(this,b)||a&&Ge(this,a)?!0:!1:!this.Te||0===this.Te.length||a&&Ge(this,a)?!0:!1:!this.groups||0===this.groups.length||b&&Fe(this,b)?!0:!1:!0;b=this.location&&"allLocations"!==this.location?void 0===e||null===e?!1:!0===e&&"atHome"===this.location||!1===e&&"onCampus"===
this.location?!0:!1:!0;this.debug&&K.log("ipr="+d+" tr="+g+" ur="+a+" lr="+b+"; env.isOffCampus="+e);return b&&d&&g&&a?{result:!0,startTime:f.startTime,endTime:f.endTime}:{result:!1}};function He(a,b){this.debug=a;this.rules=[];if(a=Ie(b))for(a=t(a),b=a.next();!b.done;b=a.next())if((b=b.value)&&2==b.length&&(2!==Object.keys(b[1]).length||b[1].constructor!==Object)&&void 0!==b[1].action){if(b[1].action.setting&&(b[1].action.setting.Pe=[],b[1].action.setting.ti))try{for(var c=b[1].action.setting.ti.trim().split(","),d=0;d<c.length;d++)b[1].action.setting.Pe.includes(c[d].toLowerCase().trim())||b[1].action.setting.Pe.push(c[d].toLowerCase().trim())}catch(e){K.warn(e)}d=void 0;b[1].$&&
(d=new Ce(this.debug,b[1].$.location,b[1].$.U,b[1].$.yi,b[1].$.Jj,b[1].$.groups,b[1].$.Te));b=new Je(b[1].F,b[1].enabled,d,b[1].action);this.rules.push(b);this.debug&&K.log("RuleSet rule="+JSON.stringify(b))}}
function Ie(a){var b=new Map;if(a){a=t(Object.entries(a));for(var c=a.next();!c.done;c=a.next()){var d=t(c.value);c=d.next().value;d=d.next().value;if(d.$&&d.$.U)for(var e=0;e<d.$.U.length;e++)d.$.U[e].network&&""!==d.$.U[e].network?d.$.U[e].gi=jc(d.$.U[e].network):d.$.U[e].Kd&&7<=d.$.U[e].Kd.trim().length&&(d.$.U[e].le=jc(d.$.U[e].Kd),d.$.U[e].nf=jc(d.$.U[e].Vo));d.name=c;b.set(d.order,d)}b=Array.from(b);b.sort(function(f,g){return f[0]-g[0]});return b}}
He.prototype.Mg=function(a,b,c,d,e,f,g){if(this.rules&&0!=this.rules.length)for(var h=t(this.rules),l=h.next();!l.done;l=h.next()){l=l.value;var m=l.F;if(!m||"fun time"!=m.toLowerCase()&&"funtime"!=m.toLowerCase())try{var n=l.Mg(a,b,c,d,e,f,g);if(n&&n.result){var q={F:l.F,action:l.action};n.startTime&&(q.startTime=n.startTime);n.endTime&&(q.endTime=n.endTime);this.debug&&K.log("matched rule "+JSON.stringify(q));return q}}catch(u){K.log("bad rule "+l.F+" "+u)}}};
function Ke(a){return a?"down time"==a.toLowerCase()||"downtime"==a.toLowerCase()?!0:!1:!1}function Je(a,b,c,d){this.F=a;this.enabled=void 0==b?!0:b;this.$=c;this.action=d}Je.prototype.Mg=function(a,b,c,d,e,f,g){return this.enabled?this.$?this.$.Mg(a,b,c,d,e,f,g):{result:!0}:{result:!1}};var Le=!1;
function Me(a,b){this.i=a;this.debug="true"===this.i.s["debug.policy.debug"];this.nc="true"==this.i.s["debug.bwl.debug"];this.Rb="true"==this.i.s["debug.ytf.debug"];this.A="true"==this.i.s["debug.policy.verbose"];this.trace="true"==this.i.s["debug.policy.trace"];this.u=this.i.u;this.C=this.i.C;Le=this.trace;this.debug&&K.log("[Policy] Constructor start.");delete this.i.s["cache-storage.rbpolicy.rbpolicy"];this.Ti=Q.Fd;this.Gn="azure-ad";this.K;this.$b="";this.M={};this.hl=this.Un=!1;this.l=void 0;
this.h;this.S;this.ga=new ve;this.wh;this.fl;this.xh;this.oo=36E5;this.zn=288E5;this.yh=this.oo;this.Fa=Q.Fa;this.Ho=Q.Mc;this.Fs=/youtube.com\/shorts/;this.Cs=/facebook.com\/reel/;b&&(Ne(this),Oe(this));this.debug&&K.log("[Policy] Constructor done.")}k=Me.prototype;k.ri=function(){this.K=void 0;this.$b="";this.M={};this.S=this.h=this.l=void 0};
function Oe(a){a.i.addListener(function(b,c,d){if(!a.i.disabled&&"policy"===b.recipient&&"HomePage"===b.type){a.debug&&K.log("policy getting homepage");b=he(a);if(void 0!==b&&void 0!==b.setting)try{var e=b.setting.zf;e.startsWith("http")||(e="http://"+b.setting.zf);var f=(new URL(e)).href}catch(g){a.debug&&K.log("failed to get homepage from action")}void 0!==f&&a.debug&&K.log("policy return homepage "+f+"; actionid="+b.bf+"; actionname="+b.io);d({HomePage:f})}});a.gg=function(b){var c,d,e,f,g,h;return J(function(l){switch(l.h){case 1:if(a.i.disabled)return l.return();
if("customerSignedIn"==b.type){l.m(0);break}if("customerSignedOut"==b.type){delete a.i.s["policy.cache"];delete a.i.s["policy.obj.cache"];a.i.policy.ri();a.gl&&a.i.H.removeListener(a.gl);a.i.H.removeListener(a.gg);l.m(0);break}if("userSignedOut"==b.type){a.Qf(!0);l.m(0);break}if("serverPushEvents"!=b.type){if("computerSleepDetected"==b.type){if(!a.wh||Date.now()-a.wh>=a.yh)a.debug&&K.log("Refresh policy after computer sleep ..."),Sb(a)}else"reloadPolicy"==b.type?(a.debug&&K.log("sync reloadPolicy"),
Sb(a)):"postUserSignedIn"==b.type&&(a.debug&&K.log("sync postUserSignedIn"),a.Qf());l.m(0);break}c=b.data.As;d=t(c);e=d.next();case 6:if(e.done){l.m(0);break}f=e.value;switch(f.type){case "policyChanged":return l.m(9)}l.m(7);break;case 9:if(!f.details){l.m(11);break}C(l,12);g=JSON.parse(f.details);h=g.timestamp;if(a.fl&&!(a.fl<h)){l.m(14);break}a.fl=h;(a.debug||a.trace)&&K.log("Refresh policy based on server push event ...");return y(l,Sb(a),14);case 14:F(l,11);break;case 12:H(l),K.error("Malformed push event details: "+
f.details);case 11:l.m(7);break;case 7:e=d.next(),l.m(6)}})};a.i.H.addListener(function(b){a.gg(b)})}function Pe(a){a.i.runtime.getAuthToken()&&(Qe(a),a.debug&&K.log("[Policy] Query policy at startup."),setTimeout(function(){Sb(a)},1E3));void 0===a.K&&(a.xk(),a.Lf())}function Ne(a){a.i.setInterval(function(){if(!a.wh||Date.now()-a.wh>=a.yh)a.debug&&K.log("[Policy] Refresh policy periodically."),Sb(a)},3E5)}k.Qi=function(){};k.wf=function(){};k.Ig=function(){};k.ze=function(){};k.em=function(){};
k.Qf=function(){this.S=this.h=this.l=void 0;this.debug&&K.log("currentAction reset")};function Re(a,b){a.debug&&K.log("[Policy] Save policy.",b);a.i.s.removeItem("policy.cache");b=JSON.stringify(Xa(a.ga,b));b=nc(b);a.i.s["policy.obj.cache"]=b}function Qe(a){var b=a.i.s["policy.cache"];b||(b=a.i.s["policy.obj.cache"]);if(b)try{var c=mc(b);Se(a,c,0)}catch(d){K.warn("[Policy] Bad policy from localStorage.")}else K.warn("[Policy] No local cached policy.")}
function Sb(a){var b;return J(function(c){b=function(){var d,e,f,g,h,l,m,n,q;return J(function(u){switch(u.h){case 1:if(!Sc(a.i))return u.return();d=a.Qn;e=a.Sk;f=Q.Yb+Te(a.i)+""+d+"?uuid="+a.i.runtime.env.uuid;C(u,2);if(!ie(a)){u.m(4);break}g=5;case 5:if(a.i.Yc){u.m(6);break}l={};l.version=e;l.G=a.i.runtime.getAuthToken();l.uuid=a.i.runtime.env.uuid;l.Pb=a.i.runtime.env.Va;a.Ke&&(l.Ke=a.Ke);a.debug&&K.log("[Policy] Query policy param=",l);C(u,7);m=JSON.stringify(Xa(xe,l));return y(u,md(a.i.http,
f,"POST",m),9);case 9:h=u.j;if(!h)throw Error("empty JSON policy string");u.m(6);break;case 7:return n=H(u,2),K.warn("/GetConfig: "+n+", will retry in "+g+" seconds"),y(u,new Promise(function(r){setTimeout(r,1E3*g)}),10);case 10:g=Math.min(2*g,120);u.m(5);break;case 6:Se(a,h,2);case 4:F(u,0);break;case 2:q=H(u),K.error("[Policy] Abort /GetConfig:",q),A(u)}})};a.xh?a.debug&&K.warn("[Policy] /GetConfig is in progress. Skip."):(a.debug&&K.log("[Policy] Call server /GetConfig."),a.xh=b(),a.xh.finally(function(){a.xh=
void 0}));return c.return(a.xh)})}
function Se(a,b,c){c=void 0===c?1:c;if(b&&0!=b.trim().length)try{var d=U(a.ga,JSON.parse(b));if(d)if(a.debug&&K.log("[Policy] populatePolicyFromStr. Source="+c+", policyObj=",d),d.error&&(d.Error=d.error),d.Error)K.error("[Policy] populatePolicyFromStr source="+c+", error="+d.Error);else if(d.disabled)a.debug&&K.log("[Policy] policy disabled."),a.yh=a.zn,a.i.H.sendMessage({type:"policyDisabled"}),0!=c&&Re(a,d);else{if(!a.Un){a.i.Zl&&a.i.H.sendMessage({type:"policyReEnabled"});a.yh=a.oo;if(c&&(!d.Ab||
!d.Ab.Ab))if(2==c&&a.Ke)a.debug&&K.log("[Policy] No policy change.");else{K.error("[Policy] populatePolicyFromStr source="+c+". Bad config string.");return}try{if(d.Ab&&d.Ab.Ab){var e=JSON.parse(d.Ab.Ab),f=U(a.ga,e);b=!1;a.trace&&K.log("[Policy] populatePolicyFromStr. configObject=",f);c&&a instanceof Ue&&(a.Ke=f.timestamp);f.vb>a.aa?(b=a.hl=!0,12==Q.platform&&(K.warn("[Policy] server policy version is newer, upgrade now."),!0===Ve?(K.warn("[Policy] server policy version is newer, auIsRunning is true."),
We()):(K.warn("[Policy] server policy version is newer, auIsRunning is false."),Xe()))):f.vb==a.aa?(d.K=f,d.Ab=void 0):b=!0;b&&!a.K&&(f.M&&f.M.Zb&&(a.$b=f.M.Zb),a.xk())}d.K||(d.K=a.K);Re(a,d)}catch(h){K.error("[Policy] Invalid JSON config string.",d.Ab);return}a.K=d.K;a.cl=d.Oq;try{d.On?(a.D=U(a.ga,JSON.parse(d.On)),a.debug&&K.log("[Policy] Parent rule:",a.D)):a.D=void 0}catch(h){K.error("[Policy] Invalid JSON parentRule string.",h)}try{d.Tk?(a.bl=U(a.ga,d.Tk),a.debug&&K.log("[Policy] Got classrooms: ",
d.Tk)):(a.bl=void 0,a.debug&&K.log("[Policy] Empty classrooms."))}catch(h){K.error("[Policy] Invalid JSON Classrooms string.",h)}if(d.Vg){if(a.Vg=d.Vg,a.$k("[3155] Got oem: ",d.Vg),"/hapara"===Q.Mc&&"deledao"===a.Vg){a.Fa=Q.kf;a.Ho=Q.Vk;if(12===Q.platform){var g;a.i.Hc()?g=chrome.action:g=chrome.browserAction;a.$k("[3155] updateExtensionIconToDeledao");g.setIcon({path:"icons/deledao-icon-128.png"})}a.$k("[3155] hapara expired, send mbus message: 'haparaSubscriptionExpired'");a.i.H.sendMessage({type:"haparaSubscriptionExpired"})}}else a.Vg=
void 0,a.debug&&K.log("[Policy] Empty oem.");a.Lf();g={type:"remoteLoggingStatus",data:{status:"off"}};d.$q&&(g.data.status="on",g.data.Jo=d.Mq||"default");a.i.H.sendMessage(g);c&&(a.i.H.sendMessage({type:"gotRemotePolicy"}),a.wh=Date.now(),Q.vt()&&12==Q.platform&&a.i.H.sendMessage({type:"sendReloadPolicyToProxy"}))}}else K.error("[Policy] policyObj is null.")}catch(h){K.warn("[Policy] populatePolicyFromStr error.",h)}else a.debug&&K.log("[Policy] populatePolicyFromStr empty policyStr.")}
k.Ft=function(){this.trace&&K.log.apply(K,["[Policy] "].concat(ca(arguments)))};k.$k=function(){this.debug&&K.log.apply(K,["[Policy] "].concat(ca(arguments)))};k.Lf=function(){throw Error("You have to implement the method populatePolicy!");};function Ye(a){a.i.H.sendMessage({type:"policyChanged"});he(a,!0)}function Ze(a){if(a.Ke)return(new Date(a.Ke)).toLocaleString("en-US",{timeZone:a.M.timeZone})}
function ie(a){return a.i.runtime.getAuthToken()&&0<a.i.runtime.getAuthToken().trim().length&&!a.i.runtime.getAuthToken().startsWith("anon-")?!0:!1}k.so=function(){return"not school version"};k.Sg=function(){throw Error("You have to implement the method needImmediateSignIn!");};k.xk=function(){throw Error("You have to implement the method setBlockAllPolicy!");};k.Gc=function(){throw Error("You have to implement the method getSignInMethod!");};k.lp=function(){};k.jp=function(){};k.va=function(){};
k.Ib=function(){he(this);return this.l};k.Ms=function(){return this.we};function he(a,b){b=void 0===b?!1:b;if((99==Q.za||Sc(a.i))&&void 0!==a.K){var c=6E4*Math.floor((new Date).getTime()/1E3/60);if(!b&&a.h&&a.S&&c===a.S)return a.h;if(a=a.ye(c))return a.action}}k.Df=function(){if(!this.i.G||this.i.G.hb)return!1;var a=Q.Fq,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.ff&&(a=b.setting.ff);return a};
function $e(a,b){try{var c=he(a);if(c&&c.dj&&0<c.dj.length){a.debug&&K.log("action.adWhitelist = "+JSON.stringify(c.dj));for(var d=new URL(b),e=t(c.dj),f=e.next();!f.done;f=e.next()){var g=f.value,h=g.toLowerCase();h.startsWith("https://")||h.startsWith("http://")||h.startsWith("ftp://")||(g="https://"+g);if(af(d,g))return a.debug&&K.log("In AD Whitelist. url = "+b),Q.ea}}}catch(l){K.error("Error while checking AD whitelist. "+l)}return Q.Qa}
function bf(a,b){try{var c=he(a);if(c&&c.Hk&&0<c.Hk.length){a.debug&&K.log("action.trackingWhitelist = "+JSON.stringify(c.Hk));for(var d=new URL(b),e=t(c.Hk),f=e.next();!f.done;f=e.next()){var g=f.value,h=g.toLowerCase();h.startsWith("https://")||h.startsWith("http://")||h.startsWith("ftp://")||(g="https://"+g);if(af(d,g))return a.debug&&K.log("In tracking whitelist. url = "+b),Q.ea}}}catch(l){K.error("Error while checking tracking whitelist. "+l)}return Q.Qa}
k.De=function(){var a=Q.Dq,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.ef&&(a=b.setting.ef);return a};k.om=function(){var a=Q.Gq,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.Wc&&(a=b.setting.Wc);return a};k.Vj=function(){var a=Q.ar,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.qe&&(a=b.setting.qe);return a};k.Rj=function(){var a=Q.Rq,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.Ae&&(a=b.setting.Ae);return a};
k.pm=function(){var a=Q.Hq,b=he(this);b&&b.setting&&"boolean"===typeof b.setting.localStorage&&(a=b.setting.localStorage);return a};k.gm=function(){var a=[],b=he(this);b&&b.setting&&b.setting.Pe&&(a=b.setting.Pe);return a};k.mp=function(){var a=he(this);return a&&a.setting&&a.setting.kh?a.setting.kh:[]};k.xp=function(){};k.kp=function(){return-1};function cf(a){a=a.M;return a.ng&&void 0!==a.ng.Bh?a.ng.Bh:!0}function df(a){return a.K&&a.K.timestamp}k.Zg=function(){};
k.uf=function(){throw Error("You have to implement the method getBlockingPage!");};k.sf=function(){var a=[],b=he(this);b&&b.setting&&b.setting.ib&&(a=b.setting.ib);return a};function ef(a,b){var c=[];a=t(a);for(var d=a.next();!d.done;d=a.next())d=d.value,-1!=b.indexOf(d)&&c.push(d);return c}k.$h=function(){return!1};
function ff(a,b,c){var d=new yd(b,c,a.l,a.la);try{if(a.h&&a.h.setting){if(a.h.setting.Br&&(a.Fs.test(b)||a.Cs.test(b)))return xd(d,Q.Pa,"Block short videos","Block short videos"),gf(d,[Q.Vb]),d;if(a.h.setting.bn){var e=hf(a.i.kq,b,a.h.setting.bn);if(e)return xd(d,Q.ea,"SE allow list","search keyword '"+e+"' is in SE allow list"),K.log("[Policy] SE allow list decision.",d),d}if(a.h.qc){var f=a.h.qc.Yg(b);if(Ad(f))return f.Xb=c,f.Gd()&&gf(f,[Q.Vb]),f}if(c){var g=ef(c,a.h.setting.ib);if(0<g.length){a.debug&&
K.log("decisionFromCurrentAction in blockedcat: "+b);var h=g.map(function(l){return jf(a.i.Aa,l)}).join(",");gf(d,g);xd(d,Q.Qa,"Blocked by cat","blocked by category: "+h);return d}}}}catch(l){K.warn("[Policy] decisionFromCurrentAction err:",l?l.toString():"")}xd(d,Q.Qa,"No decision");return d}
k.rb=function(a,b,c){c=void 0===c?!0:c;b=b?b:kf(this.i.Aa,a);var d=new yd(a,b,this.l,this.la);try{var e=new URL(a);he(this);if(!this.h)xd(d,Q.Qa,"No action"),d.F=void 0;else if("localhost"==e.hostname&&!Q.sa)xd(d,Q.ea,"Localhost");else if(this.$h())xd(d,Q.Pa,"Down time");else if(Q.Bt(e.hostname))xd(d,Q.ea,"Whitelist domain");else if(!0===c)if(Tc(e.hostname)){if(e.pathname)if(e.pathname.startsWith("/channel/")){var f=lf(this.i.Rc,a);xd(d,f.state,"Youtube channel",f.qa);gf(d,f.da);d.la=f.la;d.F=f.F;
d.qa=f.qa}else("/watch"==e.pathname||e.pathname.startsWith("/embed/")||e.pathname.startsWith("/get_video_info")||e.pathname.startsWith("/s/_/")||e.pathname.endsWith(".js")||e.pathname.endsWith(".css")||e.pathname.startsWith("/api/stats")||"/iframe_api"==e.pathname)&&xd(d,Q.ea,"Youtube video")}else(e.hostname.endsWith(".googlevideo.com")&&("/videoplayback"==e.pathname||"/videogoodput"==e.pathname)||"s.ytimg.com"===e.hostname&&e.pathname.endsWith(".js"))&&xd(d,Q.ea,"Google video")}catch(g){this.debug&&
K.log("[Policy] GetUrlDecision error:",g)}return d.ab?{Mh:d}:{Mh:void 0,url:a,Xb:b}};
function mf(a,b,c){var d=a.i.kq;c=void 0===c?!1:c;nf(d,b)?(c=of(d,b,"main_frame",c),d.debug&&K.log("seSafeSearch.",b,"main_frame",c),d=c):d={};if(!0===d.sl)return c=kf(a.i.Aa,b),a=new yd(b,c,a.l,a.la),xd(a,Q.Pa,"Blocked due to search"),gf(a,[Q.Vb]),pf(a,d.redirectUrl,"block"),a;b=a.rb(b,void 0,!0);if(b.Gd())return b;!1===d.sl&&(void 0!==d.redirectUrl?(pf(b,d.redirectUrl,"redirect"),b.F=a.l,b.la=a.la):void 0!==d.Oc&&(b.Oc=d.Oc,b.action&&"proxy"!=b.action&&K.error("Changing action from",b.action,"to",
"proxy"),b.action="proxy",b.F=a.l,b.la=a.la));return b}k.Gl=function(){};function qf(a){var b=he(a);if(b&&b.setting)try{var c=b.setting.zf;c.startsWith("http")||(c="http://"+b.setting.zf);var d=(new URL(c)).href}catch(e){}else a.debug&&K.log("action undefined");return d}function yd(a,b,c,d){this.da=this.ab=void 0;this.h=a;this.F=c;this.la=d;this.X=void 0;this.Xb=b;this.debug=Le}function xd(a,b,c,d,e){a.ab=b;a.description=c;a.X=d;a.Bi=e;a.Gd()&&(a.action="block");rf(a)}
function gf(a,b){a.da=b;a.Gd()&&(a.action="block");rf(a)}yd.prototype.Gd=function(){return this.ab==Q.Pa||this.da&&0<this.da.length};function Ad(a){return a.ab!=Q.Qa||a.da&&0<a.da.length}function pf(a,b,c){a.redirectUrl=b;a.action&&c!=a.action&&K.error("Changing action from",a.action,"to",c);a.action=c}function rf(a){Ad(a)&&a.debug&&K.log("URL decided.",a.h,a)};function sf(a){Me.call(this,a,!0);var b=this;this.aa="1.4";this.Sk="1.0";this.Qn=Q.Ns;this.la="parent";this.eb;this.j;this.J=this.i.s["cache-storage.rbpolicy.lastAlerted"];this.wg;this.ya={};this.ya.vb=this.aa;this.ya.Pl={setting:{ef:!0,ff:!0,qe:!1,Ae:!1,ge:!1,ib:[],localStorage:!0,Wc:!0,bd:!1,ad:!1,cd:!1,Rh:!1,Yl:!1}};this.ya.M={Hp:!1,tq:!1,Cj:!0,ss:!1,ws:!1,Zb:Q.Pd};this.v={};this.v.vb=this.aa;this.v.Pl={setting:{ef:!0,ff:!0,qe:!0,Ae:!0,ge:!0,ib:[41,101,103,105,106,107,109,110,111,112,115,116,120],
localStorage:!0,Wc:!0,bd:!0,ad:!1,cd:!1,Rh:!1,Yl:!1}};this.v.M={Hp:!1,tq:!0,Cj:!0,ss:!1,ws:!1,Zb:Q.Pd};this.o=this.Ti;this.qb=!0;this.i.addListener(function(c,d,e){if(!b.i.disabled&&"homeUnblock"===c.type)return c=U(Bb,c.data),uf(b,c.url,c.Ba,c.T,c.Xb,c.reason).then(function(f){f.error?e({error:f.error}):e({ok:!0})}),!0});Pe(this);this.i.setInterval(function(){if(!b.i.disabled&&Sc(b.i)){var c=Date.now();b.ye(c);b.debug&&K.log("GetActionNow periodically ...curRule="+b.l+" end in "+(b.wg-c)/1E3);var d=
(new Date(c+6E5)).getTime();b.rf=void 0;b.Yd=void 0;b.ye(d,!0);d=!1;Ke(b.rf)&&b.Yd&&10==Math.ceil((b.Yd-c)/6E4)&&(d=!0);d&&alert("Down Time will begin in 10 minutes.")}},6E4)}x(sf,Me);k=sf.prototype;k.ri=function(){Me.prototype.ri.call(this);this.o=this.Ti;this.qb=!0};k.$h=function(){he(this);return this.l&&"Down Time"==this.l?!0:!1};k.Gc=function(){return{method:this.o,Lk:this.dl}};k.xk=function(){this.K=this.v};k.Zg=function(){};
k.uf=function(a,b,c,d,e,f,g){if(this.$h())return Q.Fa+Q.No+"?cname="+encodeURIComponent(this.$b)+"&orgurl="+encodeURIComponent(a)+"&left="+this.wg.getTime();f=Q.Fa+Q.dt;f+="?category="+encodeURIComponent(c);f=g?f+("&cids="+encodeURIComponent(g)):f+("&cids="+encodeURIComponent(d));Q.Kg()&&this.i.runtime.getAuthToken()&&!this.i.runtime.getAuthToken().startsWith("anon-")&&!this.M.Cj&&e&&(f+="&uburl=bk");f+="&site="+encodeURIComponent(a)+"&cname="+encodeURIComponent(this.$b)+"&title="+b;f+="&source="+
encodeURIComponent("");f+="&anony=0";if(Q.Kg()&&this.i.runtime.getAuthToken()&&!this.i.runtime.getAuthToken().startsWith("anon-")&&!this.M.Cj&&e){var h=this.i.runtime.env.username;f+="&uid="+encodeURIComponent(h)}this.hl&&12!=Q.platform&&(f+="&upgrade=true");this.debug&&K.log("home userid="+h+" getBlockingPage "+f);return f};
function uf(a,b,c,d,e,f){var g,h,l,m;return J(function(n){if(1==n.h){if(!a.i.runtime.getAuthToken())return n.return();g=Q.Yb+Te(a.i)+""+Q.at;h={};h.G=a.i.runtime.getAuthToken();h.version="1.0";h.user=a.i.runtime.env.username;h.url=b;h.Ba=c?c:"";h.T=d;h.Gr=e.toString();h.reason=f;h.timestamp=(new Date).getTime();l=new Date;l.setDate((new Date).getDate()+1);l.setHours(0,0,0,0);h.Ur=l.getTime();return y(n,new Promise(function(q){fd(a.i.http,g,Xa(Bb,h),function(u){var r;try{u&&(r=U(Bb,JSON.parse(u))),
r&&!r.error&&r.ok||K.warn("homeUnblockRequest from remote fail")}catch(p){K.warn("homeUnblockRequest from remote fail "+p)}q(r)})}),2)}m=n.j;return n.return(m)})}k.va=function(a){if(this.eb)return this.eb.get(a).id};function vf(a,b){return a.j&&a.j[b]}function wf(a,b){return a.j&&a.j[b]&&a.j[b].name}
k.xp=function(a,b){this.debug&&K.log("homeuser isValidHomeUser: userName="+a+"; password="+b+" size="+this.eb.size);var c=!1;if(this.eb){if(1===this.eb.size){var d=this.eb.values().next().value;d.Ie&&""!==d.Ie||(this.debug&&K.log("single user no pass"),a=this.eb.keys().next().value,c=!0)}if(!c&&a&&(d=this.eb.get(a)))if(b){var e=void 0;try{var f=forge.util.hexToBytes("2c8128fb64b358597af00da030dbb89e6e5611bbde5847928c597f066161f677a488fccab17a49449c67980f186b315b29ab51b4908d75d814c3e21d40551582");
var g=forge.pkcs5.pbkdf2(b,f,5E3,32);e=forge.util.bytesToHex(g)}catch(h){K.log("hashPassword failed: password="+b+"; "+h)}f=e;d.Ie===f?c=!0:this.debug&&K.log("homeuser passhash not match: "+b+" "+f+" "+d.Ie)}else d.Ie?c=!1:(this.debug&&K.log("homeuser empty passhash"),c=!0)}if(c)return a};function xf(a){if(a.eb&&1===a.eb.size){var b=a.eb.values().next().value;if(!b.Ie||""===b.Ie){a.debug&&K.log("single user no pass");var c=a.eb.keys().next().value}}return c}k.kp=function(){return xf(this)?1:2};
k.Sg=function(){return!0};
k.Lf=function(){K.log("homePolicy populatePolicy");if(this.K){if(this.K.vb&&"1.3"===this.K.vb){this.Vc=new Map;if(this.K.Vc)for(var a=Object.entries(this.K.Vc),b=0;b<a.length;b++)this.Vc.set(a[b][0],a[b][1]);this.zc=new Map;if(this.K.zc)for(a=Object.entries(this.K.zc),b=0;b<a.length;b++)this.zc.set(a[b][0],a[b][1]);this.Nd=new Map;if(this.K.Nd)for(a=Object.entries(this.K.Nd),b=0;b<a.length;b++)this.Nd.set(a[b][0],a[b][1]);this.Od=new Map;if(this.K.Od)for(a=Object.entries(this.K.Od),b=0;b<a.length;b++)this.Od.set(a[b][0],
a[b][1]);this.actions=new Map;if(this.K.actions)for(a=Object.entries(this.K.actions),b=0;b<a.length;b++)this.actions.set(a[b][0],a[b][1]);this.rules=new Map;if(this.K.rules)for(a=Object.entries(this.K.rules),b=0;b<a.length;b++)this.rules.set(a[b][0],a[b][1])}this.M={};this.K.M&&(this.M=Object.assign({},this.K.M),a=this.M.Zb,this.debug&&K.log("custName="+a),this.$b===Q.Pd&&(this.$b=a),a&&(this.$b=a));this.eb=new Map;this.dl=[];this.j={};if(this.K.eb){a=this.K.eb;for(var c in a){b=a[c];var d=b.name;
b.id=c;var e=d,f=b,g=this.K.vb;g&&"1.3"===g||(f.Rf=new He(this.debug,f.$m));this.eb.set(e,f);this.dl.push(d+":"+b.Ie);this.j[c]=b}if(33!=Q.platform&&this.i.runtime.env.username&&this.i.runtime.env.username!=Q.Pd&&(c=this.eb.get(this.i.runtime.env.username))&&(c=c.kr)){b=(new Date).getTime();d=!1;for(a=0;a<c.length;a++)c[a].expires&&c[a].expires<b||this.J&&this.J>=c[a].Fo||(alert(c[a].message),this.J=c[a].Fo,d=!0);d&&(this.i.s["cache-storage.rbpolicy.lastAlerted"]=this.J)}}Ye(this)}else this.debug&&
K.log("can't populatePolicy since this.configObj is undefined")};
k.ye=function(a,b){b=void 0===b?!1:b;if(this.i.runtime.env.username&&this.i.runtime.env.username!==Q.Pd){var c=this.eb.get(this.i.runtime.env.username);if(c){var d;if(this.K.vb&&"1.3"===this.K.vb){if(c.sk&&(c=this.rules.get(c.sk),c.bf&&(d=this.actions.get(c.bf)))){var e=c.F;c=[];d.jh&&0<d.jh.length&&(c=this.zc.get(d.jh[0]).urls);var f=[];d.rg&&0<d.rg.length&&(f=this.Vc.get(d.rg[0]).urls);d.Ub=f;d.Za=c;c={};d.oh&&0<d.oh.length&&(c=this.Od.get(d.oh[0]));f={};d.mh&&0<d.mh.length&&(f=this.Nd.get(d.mh[0]));
d.nh=c;d.lh=f}d=d?{action:d,F:e}:void 0}else c.Rf&&0<c.Rf.rules.length&&(f=c.Rf.Mg(c.name,void 0,this.Ti,void 0,void 0,a)),d=f;if(d&&d.action){if(b){this.rf=d.F;this.Yd=d.startTime;this.debug&&K.log("getActionNow forecast "+this.rf+" at "+this.Yd);return}d.action.qc=new od(this.nc,d.action.Ub,d.action.Za);b=new Bd(this.Rb,d.action.lh,d.action.nh);d.action.nq&&Cd(b,d.action.nq,null);this.i.Rc.Yf=[b];this.h=d.action;this.S=a;this.wg=d.endTime;this.l=d.F;this.l||(this.l="Default Rule");this.debug&&K.log("getActionNow "+
this.l);return{action:d.action,F:this.l}}this.debug&&K.log("No matched rule for "+this.i.runtime.env.username)}}if(this.K.Pl)return this.h=this.K.Pl,this.h.qc=new od(this.nc,this.h.Ub,this.h.Za),b=new Bd(this.Rb,this.h.lh,this.h.nh),this.i.Rc.Yf=[b],this.S=a,this.l="Built-in Default Rule",this.debug&&K.log("got default rule "+JSON.stringify(this.h)),{action:this.h,F:this.l}};k.Ib=function(){Me.prototype.Ib.call(this)||(this.l="Built-in Default Rule");return this.l};
k.rb=function(a,b,c){c=void 0===c?!0:c;a=Ac(a);he(this);if(this.h&&this.h.mn&&0<this.h.mn.length){a:{var d=this.h.mn;try{for(var e=new URL(a),f=Date.now(),g=0;g<d.length;g++)if(!(f<d[g].from||f>d[g].oe)&&af(e,Ac(d[g].url))){var h=d[g].url+" is in temporary allowed list";break a}}catch(l){this.debug&&K.log("checkTimedWhitelist: "+l)}h=void 0}if(h)return b=b?b:kf(this.i.Aa,a),a=new yd(a,b,this.l,this.la),xd(a,Q.ea,"timed whitelist",h),a}h=Me.prototype.rb.call(this,a,b,c);if(h.Mh)return h.Mh;a=h.url;
return ff(this,a,h.Xb)};function yf(a,b,c,d){Me.call(this,a,!1);this.aa="1.4";this.K=b;this.Kb=c;this.timeZone=d}x(yf,Me);yf.prototype.Lf=function(){this.K&&this.K.$m&&(this.Rf=new He(this.debug,this.K.$m),he(this,!0))};
yf.prototype.ye=function(a,b){b=void 0===b?!1:b;if(this.Rf&&0<this.Rf.rules.length){var c=this.Rf.Mg(void 0,void 0,void 0,void 0,void 0,a,this.timeZone);if(c&&c.action)if(b)this.rf=c.F,this.Yd=c.startTime,this.debug&&K.log("getActionNow forecast "+this.rf+" at "+this.Yd);else return this.l=c.F,this.h=c.action,this.S=a,this.wg=c.endTime,this.h&&(this.Kb&&(!1===this.Kb.qs&&(this.h.Ub=[]),!1===this.Kb.rs&&(this.h.Za=[])),this.h.qc=new od(this.nc,this.h.Ub,this.h.Za),a=new Bd(this.Rb,this.h.lh,this.h.nh),
this.i.Rc.Fi=a),this.debug&&K.log("got rule "+this.l+" for parent rule"),this.Kb&&!1===this.Kb.Qo&&this.h.setting&&(this.h.setting.ib=[]),{action:this.h,F:this.l}}};yf.prototype.Ib=function(){return this.l};function zf(a,b,c){Me.call(this,a,!1);this.aa="1.3";this.K=b;this.Kb=c;K.log("ParentPolicy13")}x(zf,Me);zf.prototype.Lf=function(){this.K&&he(this,!0)};zf.prototype.ye=function(a){if(this.K)return this.l="parent",this.h=this.K,this.S=a,this.h.qc=new od(this.nc,this.h.Ub,this.h.Za),a=new Bd(this.Rb,this.h.lh,this.h.nh),this.i.Rc.Fi=a,this.Kb&&!1===this.Kb.Qo&&(this.h.setting.ib=[]),{action:this.h,F:this.l}};function Ue(a){Me.call(this,a,!0);var b=this;this.aa="1.3";this.Sk="1.5";this.Qn=Q.Ls;this.la="school";this.ya={};this.ya.vb=this.aa;this.ya.Yr="1";this.ya.Nh="1";this.ya.actions={1:{bf:"1",io:"Default Action",setting:{zf:"",ef:!0,ff:!0,Wc:!0,bd:!0,Wd:"high",ad:!0,Ud:"high",cd:!0,Xd:"high",qe:!0,Jr:!0,Ae:!0,ti:"",Fj:!1,ge:!0,To:!1,ib:[105,107,109],localStorage:!0}}};this.ya.rules={1:{sk:"1",F:"Built-in Default Rule",order:99999,status:"enabled",bf:"1"}};this.ya.M={Wc:!0,bd:!0,ad:!0,cd:!0,ec:{type:"gsuite",
fp:!0},xa:!0,Fj:!0,Rh:!1,Zh:{Rl:!1},Qh:!0,fu:!0,Tl:!1};this.J=new oe(this.i);this.v;this.j;this.Bc;this.Ke;this.gl=function(c){return J(function(d){if(b.i.disabled)return d.return();"localIpAddressChanged"!=c.type||Q.Kg()||(Af(b),b.Qf(),K.log("["+b.u+"]["+b.C+"][Policy] Local IP address changed. Update off campus from remote."),Vd(b,!1));A(d)})};this.i.H.addListener(function(c){b.gl(c)});Pe(this);Af(this);Vd(this,!1);this.i.setInterval(function(){b.i.disabled||Sc(b.i)&&Vd(b,!0)},3E5);this.i.setInterval(function(){if(!b.i.disabled&&
Sc(b.i)&&b.D&&"1.4"<=b.D.vb){var c=Date.now();b.ye(c);if(Bf(b)){b.debug&&K.log("[Policy] GetActionNow periodically ...curRule="+b.l+" end in "+(b.v.wg-c)/1E3);var d=(new Date(c+6E5)).getTime(),e=b.v;e.rf=void 0;e.Yd=void 0;b.v.ye(d,!0);d=!1;Ke(b.v.rf)&&b.v.Yd&&10==Math.ceil((b.v.Yd-c)/6E4)&&(d=!0);d&&alert("Down Time will begin in 10 minutes.")}}},6E4)}x(Ue,Me);k=Ue.prototype;k.Qf=function(a){a=void 0===a?!1:a;Me.prototype.Qf.call(this);a&&(this.J=new oe(this.i),this.Bc=this.j=this.v=void 0)};
function Af(a){var b=a.i.runtime.env.ba;if(void 0!==b&&0<b.length){a.trace&&K.log("[Policy] RBP got ipList="+b);var c=[];b=t(b);for(var d=b.next();!d.done;d=b.next())c.push(jc(d.value));a.ba=c;a.trace&&K.log("[Policy] RBP got ipList.length="+a.ba.length)}else a.debug&&K.log("[Policy] RBP cannot get ipList")}k.so=function(){return Cf(this,this.M.an)||this.M.jo?!this.i.runtime.env.xa||Df(this,!0)||this.M.Wo?"":"Student is off-campus and classroom is disabled for off-campus.":"School doesn't allow off school hour classes."};
k.Qi=function(){var a=this.J;a=a.h?a.h.Hg():void 0;return a};k.wf=function(){return this.J.wf()};k.Ig=function(){return this.J.Ig()};k.ze=function(){return this.J.ze()};k.em=function(){return this.Sn};k.ri=function(){Me.prototype.ri.call(this);this.qb=this.o=void 0};k.Sg=function(){return 88==Q.platform?!1:"gsuite"!=this.o&&"azure-ad"!=this.o&&"classLink"!=this.o||this.qb};
k.Gc=function(){if(!this.o)return{method:"none"};var a={method:this.o};"gsuite"==a.method||"azure-ad"==a.method||"classLink"==a.method?(a.$w=!this.qb,a.Nk=this.Tn):a.method==this.Ti&&(a.Lk=this.dl);return a};
function Vd(a,b){if(a.i.runtime.getAuthToken()){var c=Q.oc+Te(a.i)+""+Q.Ps,d=a.i.runtime.env.uuid;d&&(c+="?uuid="+d);d={};d.G=a.i.runtime.getAuthToken();d.version="1.0";fd(a.i.http,c,Xa(ze,d),function(e){var f;e&&(f=U(Be,JSON.parse(e)));f&&""===f.Error?(K.log("["+a.u+"]["+a.C+"][Policy] Off campus status changed from "+a.i.runtime.env.xa+" to "+f.Mn+"."),!ce(a.i.runtime,f.Mn)&&b||a.Qf()):K.warn("["+a.u+"]["+a.C+"][Policy] Get off campus status from remote failed. Error=",f&&f.Error)})}else K.warn("["+
a.u+"]["+a.C+"][Policy] Get off campus status from remote cancelled due to no auth token.")}k.Zg=function(a,b){var c=this.Qi();c&&this.i.H.sendMessage({type:"classroomViolation",data:{timestamp:(new Date).getTime(),url:a,title:b,Y:c}})};
k.uf=function(a,b,c,d,e,f){f=void 0===f?"school":f;this.trace&&K.log("[Policy] getBlockingPage.",c,d,e,f,a);var g=this.Fa+Q.rl;this.h&&this.h.setting&&this.h.setting.ts&&this.h.setting.wj&&(g=this.h.setting.wj,this.Ft("customBlockingPage: ",g));var h=this.Qi();if(this.$h())return g=this.Fa+Q.No+"?cname="+encodeURIComponent(this.$b)+"&orgurl="+encodeURIComponent(a),this.v&&this.D&&"1.4"<=this.D.vb&&(g=g+"&left="+this.v.wg.getTime(),88==Q.platform&&(g+="&isCloudProxy=true")),g;c="Blacklist"===c?"Blocked list":
"LGBT"===c?"Sexuality":"Violence, hate, racism"===c?"Violence":"Violence, hate, racism (detected by real-time wellness analysis)"===c?"Violence (detected by real-time wellness analysis)":c;g+="?site="+encodeURIComponent(a)+"&category="+encodeURIComponent(c)+"&cname="+encodeURIComponent(this.$b)+"&title="+b;"/hapara"===Q.Mc&&(g+="&vendor=hapara");g+="&pgroup="+f;b=!1;d.includes(Q.Vb)&&(b=!0);"classroom"===f&&(b=!0);b&&(g+="&norc=true");"parent"!==f&&(b=!0,"classroom"!==f&&this.M&&this.M.Wl&&this.M.Wl.Fr&&
d.includes(Q.Vb)&&(b=!1),this.i.runtime.Lg()&&!0===this.Rn&&e&&b?(d=this.i.runtime.va(),e=this.i.runtime.env.jb,f=this.i.runtime.env.groups,g=g+"&type=unblock&uid="+encodeURIComponent(d),g+="&ou="+encodeURIComponent(e),g+="&groups="+encodeURIComponent(f),g+="&uburl="+encodeURIComponent(Q.Ts(this.Ho)+Te(this.i)+Q.Zu),g+="&intchk="+qc(d,e,f,a,c)):g+="&nodwl=true");this.hl&&12!=Q.platform&&(g+="&upgrade=true");h&&(a=this.J,a.h?(a=a.h,a=!a.B||a.B.cf||!a.B.wc||a.B.Wb&&0!=a.B.Wb.length?void 0:a.B.wc):a=
void 0,a&&(g+="&allowed="+a),g+="&liveClass=true");this.debug&&K.log("[Policy] getBlockingPageSchool: "+g);return g};k.sf=function(){var a=Me.prototype.sf.call(this);Bf(this)&&this.j.setting&&this.j.setting.ib&&(a=a.concat(this.j.setting.ib),a=Vc(a));return a};k.gm=function(){var a=Me.prototype.gm.call(this);Bf(this)&&this.j.setting&&this.j.setting.Pe&&(a=a.concat(this.j.setting.Pe));this.debug&&K.log("[Policy] SE block word array=",a);return a};k.Ib=function(){he(this);return Bf(this)?this.Bc:this.l};
k.Gl=function(a){this.A&&K.log("[Policy] GetUrlDecision checkDynWhitelist.",a);try{var b=["all"],c=this.i.runtime.va();c&&b.push(c);if("azure-ad"!=this.o&&"classLink"!=this.o){var d=this.i.runtime.env.jb;d&&b.push(d)}var e=this.ze();if(e)b.push(e);else try{c=Ef;d=[];try{e=!1;for(var f in c.h){var g=c.h[f];g.timestamp+2592E6<Date.now()?(delete c.h[g.bb],e=!0):d.push(g.bb)}e&&Ff(c)}catch(z){K.error("[CH] readClassHistory error.",z)}b=b.concat(d)}catch(z){K.error("[Policy] readClassHistory error.",z)}if("gsuite"!=
this.o||"OU"!=this.Le){var h=this.i.runtime.env.groups;h&&0<h.length&&(b=b.concat(h))}for(var l=t(b),m=l.next();!m.done;m=l.next()){var n=m.value;if(n){a:{var q=this.Ui.get(n);b=a;if(q){if(!b||0===b.trim().length){var u="";break a}var r=tc(b,0);if(r){f=b;if("youtu.be"===r||r.startsWith("youtube.")){var p=xc(b);!1!==p&&(f="https://www.youtube.com/watch?v="+p,r="youtube.com")}var v=new URL(f),w=q.get(r);if(w)for(b=0;b<w.length;b++)if(w[b].bh.Qq>(new Date).getTime()/1E3)if(!w[b].bh.uq||"url"==w[b].bh.uq){if(Gf(v,
w[b].url)){u=w[b].bh.Ci;break a}}else if(af(v,w[b].url)){u=w[b].bh.Ci;break a}}}u=void 0}this.A&&K.log("checkDynWhitelistByDomainMap. id=",n,", result=",u);if(void 0!=u)return u}}}catch(z){K.warn("[Policy] checkDynWhitelist err: "+(z?z.toString():""))}};k.xk=function(){this.K=this.ya;this.cl=this.bl=this.D=void 0};
function Hf(a){if(a&&0<a.size)for(var b=t(a.keys()),c=b.next();!c.done;c=b.next()){c=c.value;K.log("-- "+c);c=a.get(c);for(var d=t(c.keys()),e=d.next();!e.done;e=d.next()){e=e.value;K.log("+++ "+e);e=c.get(e);for(var f=0;f<e.length;f++)K.log("*** "+JSON.stringify(e[f]))}}}
k.Lf=function(){this.debug&&K.log("[Policy] populatePolicy. this.configObj=",Xa(this.ga,this.K));this.K.M&&this.K.M.ec&&(this.o=this.K.M.ec.type,this.qb=this.K.M.ec.fp,1==de(this.i.runtime)?(this.debug&&K.log("[Policy] force idaas for chromebook"),this.qb=!0):this.debug&&K.log("[Policy] no force idaas for non-chromebook"),this.Tn=this.K.M.ec.Fu,this.debug&&K.log("[Policy] idaas in policy: "+this.o+"; force="+this.qb+"; domains="+this.Tn),this.Le="OU",this.K.M.ec.Dd&&this.K.M.ec.Dd.Le&&0!=this.K.M.ec.Dd.Le.length&&
(this.Le=this.K.M.ec.Dd.Le));If(this)};
function If(a){a.Vc=new Map;if(a.K.Vc)for(var b=Object.entries(a.K.Vc),c=0;c<b.length;c++)a.Vc.set(b[c][0],b[c][1]);a.zc=new Map;if(a.K.zc)for(b=Object.entries(a.K.zc),c=0;c<b.length;c++)a.zc.set(b[c][0],b[c][1]);a.Nd=new Map;if(a.K.Nd)for(b=Object.entries(a.K.Nd),c=0;c<b.length;c++)a.Nd.set(b[c][0],b[c][1]);a.Od=new Map;if(a.K.Od)for(b=Object.entries(a.K.Od),c=0;c<b.length;c++)a.Od.set(b[c][0],b[c][1]);a.actions=new Map;if(a.K.actions)for(b=Object.entries(a.K.actions),c=0;c<b.length;c++)a.actions.set(b[c][0],
b[c][1]);a.si=new Map;if(a.K.si)for(b=Object.entries(a.K.si),c=0;c<b.length;c++)a.si.set(b[c][0],b[c][1]);a.rules=new Map;if(a.K.rules)for(b=Object.entries(a.K.rules),c=0;c<b.length;c++)a.rules.set(b[c][0],b[c][1]);a.M={};if(a.K.M){a.M=Object.assign({},a.K.M);b=a.M.Zb;a.debug&&K.log("[Policy] custName="+b);a.$b===Q.Pd&&(a.$b=b);b&&(a.$b=b);if(b=a.M.Wl)a.Rn=b.vs,a.ns=b.scope,a.wn=b.wn,a.debug&&K.log("[Policy] from policy: enableDynWL="+a.Rn+"; dynWLScope="+a.ns+"; webpageScope="+a.wn);void 0!==a.M.Qh&&
a.J.Qh(a.M.Qh)}if(a.D)try{"1.4"===a.D.vb?a.v=new yf(a.i,a.D,a.M.Kb,a.M.timeZone):a.D.setting&&void 0!=a.D.setting.Ae&&(a.v=new zf(a.i,a.D,a.M.Kb)),a.v&&a.v.Lf()}catch(v){K.warn(v)}var d=a.K;a.Sn=new Map;var e=a.Sn;(function(){if(d.bp){var v=d.bp,w;for(w in v){var z=v[w].am.map(function(B){return+B});z.includes(115)&&!z.includes(119)&&v[w].am.push(119);e.set(w,v[w])}}})();try{re(a.J,a.bl,a.M.timeZone)}catch(v){K.warn(v)}a.Ui=new Map;if(a.cl)try{var f=a.cl;for(b=0;b<f.length;b++){f[b].Ci=Ac(f[b].Ci);
var g=f[b].Ci;c=g;var h=tc(g,0);if(h){if("youtu.be"===h||h.startsWith("youtube.")){var l=xc(g);!1!==l&&(c="https://www.youtube.com/watch?v="+l,h="youtube.com")}for(var m=t(f[b].Hu.split("$$")),n=m.next();!n.done;n=m.next()){var q=n.value;if(q){var u=a.Ui.get(q);u||(u=new Map,a.Ui.set(q,u));var r=u.get(h);r||(r=[]);r.push({url:c,bh:f[b]});u.set(h,r)}}}}a.A&&(K.log("[Policy] Filled dynWhitelists: "),Hf(a.Ui))}catch(v){K.warn(v)}a.qk={};a.K.qk&&(a.qk=Object.assign({},a.K.qk));a.Nh=a.K.Nh;var p=new Map;
a.rules&&(a.rules.forEach(function(v){if(v.$&&v.$.U)for(var w=0;w<v.$.U.length;w++)v.$.U[w].network&&""!==v.$.U[w].network?v.$.U[w].gi=jc(v.$.U[w].network):v.$.U[w].Kd&&7<=v.$.U[w].Kd.trim().length&&(v.$.U[w].le=jc(v.$.U[w].Kd),v.$.U[w].nf=jc(v.$.U[w].Vo));"enabled"===v.status&&p.set(v.order,v)}),a.ho=new Map(Array.from(p).sort(function(v,w){return v[0]-w[0]})));a.actions&&a.actions.forEach(function(v){if(v&&v.setting){v=v.setting;try{v.Pe=[];v.kh=[];v.ti&&Jf(v.ti,v.Pe);if(v.eq){var w={},z=[];try{for(var B=
t(v.eq.split(",")),D=B.next();!D.done;D=B.next()){var E=D.value;E=E.trim().toLowerCase();if(0!=E.length){var G=!1;E.startsWith('"')&&E.endsWith('"')&&(G=!0,E=E.substring(1,E.length-1));E=Hc(E);E=E.split(" ").sort().join(" ");E=" "+E+" ";G&&(E='"'+E+'"');w[E]||(z.push(E),w[E]=!0)}}}catch(M){K.error("[Policy] processSeAllowWords error.",M)}v.bn=z;a.debug&&K.log("[Policy] Get SE allow word list.",v.bn)}v.Ar&&v.yq&&Jf(v.yq,v.kh)}catch(M){K.error("[Policy] Process setting error.",M)}}});Ye(a)}
function Jf(a,b){var c={};a=a.trim().split(",");for(var d=0;d<a.length;d++){var e=a[d].trim().toLowerCase();0==e.length||c[e]||(b.push(e),c[e]=!0)}}
function Kf(a,b){if(!b||0===b.length||1==b.length&&void 0!==b[0].network&&""===b[0].network.trim()||1==b.length&&void 0!==b[0].Kd&&""===b[0].Kd.trim())return!0;if(!a.ba||0===a.ba.length){a=t(b);for(b=a.next();!b.done;b=a.next())if(b=b.value,b.network&&b.network.trim()||b.le||b.nf)return!1;return!0}for(var c=!1,d=t(a.ba),e=d.next();!e.done;e=d.next()){e=e.value;a.debug&&K.log("[Policy] inIPRange checking ip "+kc(e));for(var f=0;f<b.length;f++)if(b[f].network&&""!==b[f].network.trim()){if(a.debug&&
K.log("[Policy] inIPRange ip "+f+" "+kc(b[f].gi)+"; mask="+b[f].Tg),e>>>32-b[f].Tg>>>0===b[f].gi>>>32-b[f].Tg>>>0){c=!0;break}}else if(a.debug&&K.log("[Policy] inIPRange "+f+" startip"+kc(b[f].le)+"; endip="+kc(b[f].nf)),void 0===b[f].le||e>=b[f].le&&e<=b[f].nf){c=!0;break}if(1==c){a.debug&&K.log("[Policy] inIPRange ip "+kc(e)+" is in range");break}}return c}
function Cf(a,b){if(!b||0===b.length)return!0;var c=!1,d=new Date;var e=a.M.timeZone?d.toLocaleString("en-US",{timeZone:a.M.timeZone}):d.toLocaleString("en-US");d=new Date(e);var f=lc(d.getHours()+":"+d.getMinutes()),g=Bc(d);a.A&&K.log("[Policy] curDateString="+e+"; curDate="+d+"; curDayOfWeekBit="+g+"; curHM="+f);for(a=0;a<b.length;a++){if(b[a].from&&0<b[a].from.length){e=lc(b[a].from);var h=lc(b[a].oe);if(e<h){if(f>h||f<e)continue}else if(f>h&&f<e)continue}if(void 0!==b[a].xg&&0!==(g&b[a].xg)){if(b[a].xe&&
b[a].xe.Ak&&(e=new Date(b[a].xe.Ak.concat(" 00:00:00")),h=new Date(b[a].xe.Uo.concat(" 23:59:59")),d>h||d<e))continue;c=!0;break}}return c}k.lp=function(){try{if("azure-ad"!=this.o&&"classLink"!=this.o)return this.i.runtime.env.jb}catch(a){K.error("getOuInformative error.",a)}};
k.jp=function(){var a=this;try{if("gsuite"!=this.o||"OU"!=this.Le){var b=this.i.runtime.env.groups;return b&&0<b.length&&b.toSorted&&this.we?b.toSorted(function(c,d){return c==a.we?-1:d==a.we?1:0}):b}}catch(c){K.error("getGroupsInformative error.",c)}};
function Lf(a,b){if(!b||0===b.length)return!0;var c=a.i.runtime.env.jb;if(!c)return!1;var d=c.toLowerCase().trim();b=t(b);for(var e=b.next();!e.done;e=b.next())if(e=e.value,e=e.toLowerCase().trim(),d.startsWith(e)&&(d.length==e.length||"/"==d[e.length]))return a.we=c,!0;return!1}function Mf(a,b){if(!b||0===b.length)return!0;var c=a.i.runtime.env.groups;if(c&&0<c.length){c=t(c);for(var d=c.next();!d.done;d=c.next())if(d=d.value,b.includes(d))return a.we=d,!0}return!1}
function Nf(a,b,c){return"gsuite"==a.o?"OU"==a.Le?Lf(a,b):b&&0!==b.length?c&&0!==c.length?Mf(a,b)||Lf(a,c):Mf(a,b):Lf(a,c):Mf(a,b)}function Of(a,b){if(!b||0===b.length)return!0;a=a.i.runtime.va();if(!a)return!1;a=a.toLowerCase().trim();b=t(b);for(var c=b.next();!c.done;c=b.next())if(a===c.value.toLowerCase().trim())return!0;return!1}
function Pf(a,b){if(!Qf(b))return!1;a=a.i.runtime.va();if(!a)return!1;a=a.toLowerCase().trim();var c=Date.now();b=t(b);for(var d=b.next();!d.done;d=b.next())if(d=d.value,a===d.Z.toLowerCase().trim()&&(!d.endTime||d.endTime>c&&d.startTime<=c))return!0;return!1}function Qf(a){return Array.isArray(a)&&0<a.length}
k.ye=function(a){this.we=void 0;if(void 0!==this.ho){Af(this);for(var b=t(this.ho.values()),c=b.next();!c.done;c=b.next())if(c=c.value,"enabled"===c.status)if(c.$){var d=Kf(this,c.$.U),e=Cf(this,c.$.yi);var f=c.$;var g=f.Te;var h=f.groups,l=f.ku,m=f.yt;f=f.jv;if(this.o){var n=!Qf(h),q=!Qf(l),u=!Qf(g),r=!Qf(f);g=m&&r&&n&&q?!1:m&&r||!m&&u?Nf(this,h,l):n&&q?!m&&Of(this,g)||m&&Pf(this,f):Nf(this,h,l)||!m&&Of(this,g)||m&&Pf(this,f)}else g=!0;h=(h=c.$.location)&&"allLocations"!==h?void 0===this.i.runtime.env.xa||
null===this.i.runtime.env.xa?!1:!0===this.i.runtime.env.xa&&"atHome"===h||!1===this.i.runtime.env.xa&&"onCampus"===h?!0:!1:!0;this.A&&K.log("[Policy] ruleName="+c.F+" ipr="+d+" tr="+e+" ur="+g+" lr="+h+"; env.isOffCampus="+this.i.runtime.env.xa);if(h&&d&&e&&g||99999===c.order){this.A&&K.log("[Policy] Hit ruleID="+c.sk+" ruleName="+c.F);var p=c.F;var v=c.bf;break}else this.we=void 0}else{p=c.F;v=c.bf;break}}else this.debug&&K.log("[Policy] getAction, no rules yet");void 0!==v?v=this.actions.get(v):
this.Nh?(p="Default Rule",v=this.actions.get(this.Nh)):v=p=void 0;this.debug&&K.log("[Policy] Update action rule name:",p);this.l=p;this.h=v;this.S=a;if(v){a=[];this.h.jh&&0<this.h.jh.length&&(a=this.zc.get(this.h.jh[0]).urls);b=[];this.h.rg&&0<this.h.rg.length&&(b=this.Vc.get(this.h.rg[0]).urls);this.h.qc=new od(this.nc,b,a,this.l,this.la);a={};this.h.oh&&0<this.h.oh.length&&(a=this.Od.get(this.h.oh[0]));b={};this.h.mh&&0<this.h.mh.length&&(b=this.Nd.get(this.h.mh[0]));a=new Bd(this.Rb,b,a);this.i.Rc.Yf=
[a];try{if(this.h.$p){this.h.qc=new zd(this.h.qc,this.h.fj);for(var w=t(this.h.$p),z=w.next();!z.done;z=w.next()){var B=this.si.get(z.value);this.trace&&K.log("[Policy] populateCurAction. ruleTemplate=",B);var D=new od(this.nc,B.Vc,B.zc,B.Vu,this.la);this.h.qc.list.push(D);var E=new Bd(this.Rb,B.lh,B.nh),G=this.i.Rc;a=E;this.h.fj?G.Yf.push(a):G.Yf.unshift(a);var M=this.h.setting.ib.concat(B.ib);this.h.setting.ib=Vc(M)}}}catch(T){K.error("[Policy] Populate rule template error.",T)}try{this.h.setting.ib.includes(115)&&
!this.h.setting.ib.includes(119)&&(this.debug&&K.log("[Policy] Adding category 119."),this.h.setting.ib.push(119))}catch(T){K.error("[Policy] Process block categories error.",T)}Bf(this,!1)&&this.v?(this.j=he(this.v,!0),this.Bc=this.v.Ib(),this.debug&&K.log("[Policy] Current parent rule:",this.Bc,this.j),this.h.setting?this.j&&this.j.setting&&(this.h.setting.bd||(this.h.setting.bd=this.j.setting.bd),this.h.setting.ad||(this.h.setting.ad=this.j.setting.ad),this.h.setting.cd||(this.h.setting.cd=this.j.setting.cd),
this.h.setting.ge||(this.h.setting.ge=this.j.setting.ge),1===rc(this.j.setting.Ud,this.h.setting.Ud)&&(this.h.setting.Ud=this.j.setting.Ud),1===rc(this.j.setting.Xd,this.h.setting.Xd)&&(this.h.setting.Xd=this.j.setting.Xd),1===rc(this.j.setting.Wd,this.h.setting.Wd)&&(this.h.setting.Wd=this.j.setting.Wd)):this.j&&this.j.setting&&(this.h.setting={},this.h.setting.bd=this.j.setting.bd,this.h.setting.ad=this.j.setting.ad,this.h.setting.cd=this.j.setting.cd,this.h.setting.ge=this.j.setting.ge,this.h.setting.Ud=
this.j.setting.Ud,this.h.setting.Xd=this.j.setting.Xd,this.h.setting.Wd=this.j.setting.Wd),this.h.setting.Wc=this.om()):(w=new Bd(this.Rb,void 0,void 0),this.i.Rc.Fi=w)}return{action:v,F:p}};function Df(a,b){return a.M.Kb&&a.M.Kb.Wm&&a.M.Kb.Wm.enable?(void 0===b?0:b)&&a.M.jo?!0:a.M.an?Cf(a,a.M.an)?!0:!1:Cf(a,a.M.Kb.Wm.yi)?!0:!1:!1}
k.Df=function(){if(!this.i.G||this.i.G.hb)return!1;var a=Me.prototype.Df.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.ff&&!1===this.j.setting.ff&&(a=!1);return a};k.De=function(){var a=Me.prototype.De.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.ef&&!1===this.j.setting.ef&&(a=!1);return a};k.om=function(){var a=Me.prototype.om.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.Wc&&!1===this.j.setting.Wc&&(a=!1);return a};
k.Vj=function(){var a=Me.prototype.Vj.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.qe&&!0===this.j.setting.qe&&(a=!0);return a};k.Rj=function(){var a=Me.prototype.Rj.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.Ae&&!0===this.j.setting.Ae&&(a=!0);return a};k.pm=function(){var a=Me.prototype.pm.call(this);Bf(this)&&this.j.setting&&void 0!==this.j.setting.localStorage&&!0===this.j.setting.localStorage&&(a=!0);return a};
function Bf(a,b){b=void 0===b?!0:b;return!(a.v&&a.i&&a.i.runtime&&a.i.runtime.env&&a.i.runtime.env.xa)||Df(a)||a.Qi()||b&&!a.j?!1:!0}k.$h=function(){return!Bf(this)||"Down Time"!=this.Bc&&"downtime"!=this.Bc.toLowerCase()?!1:!0};k.rb=function(a,b,c){return Rf(this,a,b,void 0===c?!0:c)};
function Rf(a,b,c,d){d=void 0===d?!0:d;var e=Ac(b);if(!e)return a.trace&&K.error("[Policy] Cannot normalize url.",b),a=new yd(b),xd(a,Q.Qa,"cannot analyze"),a;b=e;c=Me.prototype.rb.call(a,b,c,d);if(c.Mh)return c.Mh;c=c.Xb;a.A&&K.log("[Policy] GetUrlDecision: url="+b);if(Bf(a)){a.A&&K.log("[Policy] GetUrlDecision isParentTime.");if(a.j.qc&&(d=a.j.qc.Yg(b),Ad(d)))return a=d.Gd()?"parent blocked list":"parent allowed list",d.Xb=c,d.F=a,d.la="parent",d.Gd()&&gf(d,[Q.Vb]),d;if(c&&a.j.setting&&a.j.setting.ib&&
(d=ef(c,a.j.setting.ib))&&0<d.length)return a=new yd(b,c,"category blocked by parent","parent"),gf(a,d),xd(a,Q.Qa,"Blocked by parent cat"),a}d=ff(a,b,c);if(!d.Gd()){a.A&&K.log("[Policy] GetUrlDecision check classroom");e=a.J;var f=b,g=a.i.runtime.env.xa;var h=Df(a,!0)||a.M.Wo?!0:!1;a:{var l=a.M.Ro;try{if(f)if(e.enable)if(!h&&g)e.debug&&K.log("class: offCampus class not enforced");else{try{var m=new URL(f);if(e.zc.includes(m.hostname)){var n=new yd(f,void 0,void 0,"classroom");xd(n,Q.ea,"classrooms whitelist",
"classroom: always allow sign-in domains");var q=n;break a}}catch(p){K.error("Check classroom whitelist error.",p)}if(l){if(e.h)var u=ue(e.h,f);else b:{if(0!==e.l.length&&(te(e),e.j)){u=ue(e.j,f);break b}u=void 0}var r=u}else r=void 0;q=r;break a}else e.debug&&K.log("class: not enabled");else K.error("url is null.")}catch(p){K.error("Check is URL allowed fail. url=",f,", err=",p)}q=void 0}if(q&&Ad(q))return q.Xb=c,q.F=a.l,q}q=a.Gl(b);a.A&&q&&K.log("[Policy] GetUrlDecision checkDynWhitelist, dbw="+
JSON.stringify(q));return void 0!=q?(a=new yd(b,c,a.l,"teacher"),xd(a,Q.ea,"teacher allowedlist",q+" is in teacher unblocked list",q),a):d};function Sf(){this.cache=new Tf}Sf.prototype.Na=function(){return{name:"abstract",version:"1.0",inputs:{}}};
Sf.prototype.hc=function(a,b){var c=this,d,e,f,g,h,l,m,n,q;return J(function(u){switch(u.h){case 1:d=Date.now();b||(b={});if(!b.Ed){u.m(2);break}C(u,3);if(Q.Ic&&"undefined"!=typeof Buffer){h=b.Ed.indexOf(",");g=Buffer.from(b.Ed.substr(h+1),"base64").buffer;u.m(5);break}return y(u,fetch(b.Ed),6);case 6:return l=u.j,y(u,l.arrayBuffer(),7);case 7:g=u.j;case 5:e=new Float32Array(g);m=c.cache.get(e);if(m.error)f=m.gs;else return m.Dc=!0,m.time=Date.now()-d,b.A&&K.log("[IA]["+b.Ga+"] DynIAEngine reuse cache result ("+
m.Ga+"). label="+m.label+", time="+m.time+"."),u.return(m);F(u,2);break;case 3:n=H(u),K.warn("Error getting histogram: "+n),e=null;case 2:return y(u,c.Qd(a,b),8);case 8:return q=u.j,q.Ga=b.Ga,e&&!q.error&&c.cache.add(e,q),f&&(q.Iw=f),q.time=Date.now()-d,u.return(q)}})};Sf.prototype.Qd=function(){return Promise.reject("_predict() not implemented in abstract base class")};Sf.prototype.hj=function(){return J(function(a){return a.return(Promise.reject("benchmark() not supported in abstract base class"))})};
var Uf={Ja:{format:"jpg",width:640,height:480},zl:{format:"raster",width:32,height:32,rc:!0},xl:{format:"raster",width:28,height:28},Bl:{format:"raster",width:44,height:44,rc:!0},Dl:{format:"raster",width:64,height:64,rc:!0},El:{format:"raster",width:96,height:96,rc:!0},vl:{format:"raster",width:160,height:160,rc:!0},wl:{format:"raster",width:224,height:224,rc:!0},yl:{format:"raster",width:299,height:299,rc:!0},Al:{format:"raster",width:331,height:331,rc:!0},Cl:{format:"raster",width:480,height:480,
rc:!0},cm:{format:"raster",width:32,height:32,rc:!0,filter:"grayscale",Uh:100}};function Tf(){this.cache=[];this.h=5}Tf.prototype.add=function(a,b){a&&(this.cache.push({Ed:a,expires:Date.now()+1E4,result:b}),20<this.cache.length&&this.cache.shift())};
Tf.prototype.get=function(a){if(!a)return null;for(var b,c=t(this.cache),d=c.next();!d.done;d=c.next()){d=d.value;var e=d.Ed;if(a.length!=e.length)throw"Wrong histogram dimensions";for(var f=0,g=0;g<a.length;g++)f+=(a[g]-e[g])*(a[g]-e[g]);e=Math.sqrt(f);if(!b||b>e)b=e;if(e<=this.h)return d.result}return{error:"not found in cache",gs:b}};function Vf(a,b){this.cache=new Tf;this.i=a;b||(b={});this.h=Q.jm+Te(this.i)+(b.Sr||Q.wt)}x(Vf,Sf);
Vf.prototype.Na=function(){return{name:"cloud",version:"1.0",Ee:!0,inputs:{Ja:Uf.Ja}}};
Vf.prototype.Qd=function(a,b){var c=this,d,e,f,g,h,l,m,n,q,u;return J(function(r){if(1==r.h){C(r,2);if(!a.Ja&&!a.url)throw"No jpeg or url input found";e=(d=a.Ja)?d.substring(d.indexOf(",")+1):void 0;f=b.sensitivity||"medium";delete b.sensitivity;g={version:"1.5",G:c.i.runtime.getAuthToken(),image:e,Iu:"veryhigh"==f?"xh":f.substring(0,1),metadata:b};g.Xt=b.Se?b.Qp?["skin"]:b.Rp?["regular"]:["regular","skin"]:["regular"];e||(g.fv=!0,g.url=a.url);h=Xa(Wf,g);b.A&&K.log("[IA]["+b.Ga+"] CloudIAEngine is posting "+
c.h+".",Fc(g));l=g.G?md(c.i.http,c.h,"POST",JSON.stringify(h)):Promise.reject("No auth token");return y(r,l,4)}if(2!=r.h){m=r.j;try{n=U(Xf,JSON.parse(m)),b.A&&K.log("[IA]["+b.Ga+"] CloudIAEngine gets response.",n)}catch(p){throw"Invalid Cloud IA JSON response: "+m;}if(n.Error)throw n.Error;"white"==n.zh&&(n.zh="ok");q={label:n.zh,L:n.En,V:n.Dn,oa:!0};b.A&&K.log("[IA]["+b.Ga+"] CloudIAEngine result.",q);return r.return(q)}u=H(r);return r.return({L:"cloud",error:u||"unknown error"})})};
function Yf(){this.cache=new Tf;var a=this;tf.ready().then(function(){K.warn("[IAEng] tfjs version: "+tf.version.tfjs)});this.v=new Promise(function(b){a.l=b})}x(Yf,Sf);k=Yf.prototype;k.ready=function(){var a=this;return J(function(b){return b.return(a.v)})};function Zf(){var a;return J(function(b){if(1==b.h)return y(b,tf.ready(),2);a=tf.getBackend();return b.return(a.startsWith("webgl")||Q.Ic&&("tensorflow"==a||"wasm"==a||"cpu"==a))})}
k.ub=function(a,b,c){var d=this,e,f,g;return J(function(h){if(!Zf())throw"WebGL not supported";e=a+"/"+b;f=[];g=Date.now();$f[e]?K.log("CNN model "+b+" already loading ..."):$f[e]=new Promise(function(l){var m,n,q,u,r,p,v,w,z,B,D,E,G,M;return J(function(T){switch(T.h){case 1:return n=[],C(T,2),y(T,c(e),4);case 4:return q=T.j,y(T,q.text(),5);case 5:u=T.j;m=U(ag,JSON.parse(u));F(T,3);break;case 2:throw r=H(T),"Error loading engine manifest: "+b+": "+r;case 3:try{if(p=m,"linear"==p.Eg){if(p.xq.length!=
p.Ep.length)throw"# of weights doesn't match # of models";p.uo.sort(function(O,R){return O.value-R.value})}else if("stairs"==p.Eg)for(v=t(p.vo),w=v.next();!w.done;w=v.next())z=w.value,z.sort(function(O,R){return O.value-R.value});else throw"Unknown formula: "+p.Eg;}catch(O){throw"Malformed manifest file "+b+": "+O;}B={Th:c};D=t(m.Ep);for(E=D.next();!E.done;E=D.next())G=E.value,M=new bg(tf),n.push(M),f.push(M.ub(a+"/"+G,B));Promise.all(f).then(function(){l({Jc:m,xd:n})});A(T)}})});return h.return($f[e].then(function(l){d.Jc=
l.Jc;d.xd=l.xd;d.j=!0;d.h={version:d.xd.map(function(u){return u.Da.name}).join("/")};l={version:d.h.version,loadTime:Date.now()-g};(Q.ce&&"undefined"==typeof importScripts||!Q.ce&&nodeMods.worker.isMainThread&&!cg)&&K.log("Main thread image analysis model ("+l.version+") loaded in "+l.loadTime+"ms");for(var m={},n=t(d.xd),q=n.next();!q.done;q=n.next())q=q.value.Da.vc,m[q]||(m[q]=Uf[q]);d.h.inputs=m;d.l&&(d.l(),d.l=void 0);return l}).catch(function(l){K.error("Failed to load IA model: "+l)}))})};
k.ih=function(){if(this.o)return Promise.resolve();this.o=!0;K.log("Warming up CNN model ...");for(var a={},b=t(Object.keys(this.h.inputs)),c=b.next();!c.done;c=b.next()){c=c.value;var d=Uf[c];if(d&&"raster"==d.format){for(var e=[],f=0;f<d.width*d.height;f++)e.push(0,0,0);a[c]=e}}return Object.keys(a).length?dg(this,a):Promise.resolve()};
k.Na=function(){var a={name:"dld",version:"model not loaded"};this.j&&Object.assign(a,{version:this.h.version,inputs:this.h.inputs,Hh:this.Jc.Hh,Gj:this.Jc.Gj});return a};
k.Qd=function(a,b){var c=this,d,e,f;return J(function(g){if(1==g.h){if(!c.j)return g.return({error:"model not loaded"});C(g,2);return y(g,dg(c,a),4)}if(2!=g.h)return d=g.j,e={L:"dld",label:d.label,V:d.ki,ki:d.Qm?d.Qm:void 0,oa:d.oa,ka:d},b.A&&K.log("[IA]["+b.Ga+"] DLDIAEngine result. label="+d.label+", time="+d.time+"."),g.return(e);f=H(g);b.A&&K.log("[IA]["+b.Ga+"] DLDIAEngine error.",f);return g.return({L:"dld",error:f.toString()})})};
function dg(a,b){var c,d,e,f,g,h,l,m,n,q,u,r;return J(function(p){if(1==p.h){if(!a.j)return p.return({error:"model not loaded"});a.o=!0;c=function(v,w){var z;for(z=0;z<w.length-1&&!(v<w[z].value);z++);return w[z]};d=Date.now();if("linear"==a.Jc.Eg){e=[];for(f={$f:0};f.$f<a.xd.length;f={$f:f.$f},f.$f++)g=a.xd[f.$f],h=g.kj(b[g.Da.vc]).then(function(v){return function(w){return{Am:v.$f,V:w}}}(f)),e.push(h);return p.return(Promise.all(e).then(function(v){var w={Mf:[],label:"explicit",time:Date.now()-
d};v=t(v);for(var z=v.next();!z.done;z=v.next())z=z.value,w.Mf[z.Am]=z.V,0===z.Am?w.ki=z.V:1===z.Am&&(w.Qm=z.V);for(z=v=0;z<a.xd.length;z++)v+=w.Mf[z]*a.Jc.xq[z];v=c(v,a.Jc.uo);w.label=v.label;w.oa=v.oa;return w}))}if("stairs"!=a.Jc.Eg)throw"Unknown IAEngine formula: "+a.Jc.Eg;l={Mf:[]};m=0}if(7!=p.h){if(!(m<a.xd.length))return p.m(0);n=a.xd[m];return y(p,n.kj(b[n.Da.vc]),7)}q=p.j;l.Mf.push(q);0===m?l.ki=q:1===m&&(l.Qm=q);u=c(q,a.Jc.vo[m]);r=u.label;if("next"!=r)return l.time=Date.now()-d,l.label=
r,l.oa=u.oa,p.return(l);m++;return p.m(4)})}
k.hj=function(){var a=this,b,c,d,e,f,g;return J(function(h){switch(h.h){case 1:return b=function(){return new Promise(function(l){try{chrome.system.cpu.getInfo(function(m){l(m)})}catch(m){l(null)}})},c=function(l){l=Uf[l.Da.vc];if(!l||"raster"!=l.format)throw"DLD: unexpected non-raster input format";for(var m=[],n=0;n<l.width*l.height;n++)m.push(0,0,0);return m},d=function(l){var m,n,q,u,r,p,v,w,z,B,D;return J(function(E){switch(E.h){case 1:m=20;n={};q=t(a.xd);for(u=q.next();!u.done;u=q.next())r=
u.value,n[r.Da.vc]||(n[r.Da.vc]=c(r));p=[];return y(E,b(),2);case 2:v=E.j,w=Date.now(),z={},B=0;case 3:if(!(B<m)){E.m(5);break}z.Mi=Date.now();D=void 0;if(l){D=dg(a,n).then(function(G){return function(){return Date.now()-G.Mi}}(z));E.m(6);break}return y(E,dg(a,n),7);case 7:D=Promise.resolve(Date.now()-z.Mi);case 6:p.push(D);z={Mi:z.Mi};B++;E.m(3);break;case 5:return E.return(Promise.all(p).then(function(G){var M,T,O,R,N,Y,W;return J(function(X){if(1==X.h)return M={by:G.length,rw:Date.now()-w},y(X,
b(),2);T=X.j;G=G.sort(function(L,I){return L-I});M.Sx=G[0];M.Qx=G[G.length-1];M.bk=G[Math.ceil(G.length/2)];M.xw=G.reduce(function(L,I){return L+I})/G.length;if(v){O={lv:[],gj:0,Cp:0};for(R=0;R<T.numOfProcessors;R++)N=T.processors[R].usage,Y=v.processors[R].usage,W=(N.user-Y.user+(N.kernel-Y.kernel))/(N.total-Y.total),O.lv.push(W),O.gj+=W,W>O.Cp&&(O.Cp=W);O.gj/=T.numOfProcessors;M.Vw=O}return X.return(M)})}))}})},e={},y(h,b(),2);case 2:if(f=h.j)K.log("Found "+f.modelName+": "+f.numOfProcessors+" cores"),
e.Uw=f.modelName+", "+f.numOfProcessors+" cores";if(!Zf())return e.error="WebGL not supported",h.return(e);K.log("Starting CNN sequential test ...");return y(h,d(!1),3);case 3:return g=h.j,K.log("CNN sequential test finished ..."),K.log(JSON.stringify(g,null,2)),e.vk=g,K.log("Starting CNN parallel test ..."),y(h,d(!0),4);case 4:return g=h.j,K.log("CNN parallel test finished ..."),K.log(JSON.stringify(g,null,2)),e.hy=g,h.return(e)}})};var $f={};function eg(a){Yf.call(this);this.L=a}x(eg,Yf);k=eg.prototype;
k.ready=function(){var a=this;return J(function(b){return b.return(a.L.ready())})};k.ub=function(a,b,c){var d=this;return J(function(e){return e.return(d.L.ub(a,b,c))})};k.ih=function(){return this.L.ih()};k.Na=function(){return this.L.Na()};k.hc=function(a,b){var c=this;return J(function(d){return d.return(c.L.hc(a,b))})};k.Qd=function(a,b){var c=this;return J(function(d){return d.return(c.L.Qd(a,b))})};k.hj=function(){var a=this;return J(function(b){return b.return(a.L.hj())})};
function fg(){this.cache=new Tf;var a=this;gg();this.h=function(){var b,c;return J(function(d){if(1==d.h)return b={type:"createEngine"},Q.wa||(b.data={xr:chrome.runtime.getURL("")}),y(d,hg.sendRequest(b),2);c=d.j;a.ac=c.ac;A(d)})}()}x(fg,Sf);
function gg(){if(33!=Q.platform){if(Q.features.ra.xc)throw Error("IA worker not supported in current config (cloud or android)");if(!ig){switch(Q.platform){case 12:try{ig=new Worker(chrome.runtime.getURL(Q.Sj()?"/iaWorker.js":"/stubs/iaWorker.js"))}catch(b){K.error("Failed to create IA worker engine.",b)}break;case 99:cg?(ig=nodeMods.child_process.fork(__filename,["--mode","ia"]),ig.on("exit",function(){K.error("IA process unexpectedly died, re-spawning ...");ig=void 0;var b=jg;jg=[];b=t(b);for(var c=
b.next();!c.done;c=b.next())c=c.value,c()})):ig=new nodeMods.worker.Worker(__filename,{workerData:{wr:Tb}});break;default:throw Error("Don't know how to create IA worker on current platform");}if(ig){K.log("Image analysis worker created");var a=function(){};x(a,kg);a.prototype.sendMessage=function(b){12!=Q.platform&&cg?ig.send(b):ig.postMessage(b)};a.prototype.Tf=function(b){if(12==Q.platform)ig.onmessage=function(c){b(c.data)};else if(99==Q.platform)ig.on("message",function(c){b(c)})};hg=new lg(new a)}else K.error("Failed to create image analysis worker")}}}
fg.prototype.Na=function(){return this.dd||{}};fg.prototype.ub=function(a,b){var c=this,d,e,f;return J(function(g){switch(g.h){case 1:return y(g,c.h,2);case 2:return d={type:"loadModel",data:{zs:Q.Hd,ac:c.ac,vr:a,Jc:b}},y(g,hg.sendRequest(d),3);case 3:return e=g.j,K.warn("[IAEng] Worker image analysis model ("+e.version+") loaded in "+e.loadTime+"ms"),y(g,hg.sendRequest({type:"getEngineInfo",data:{ac:c.ac}}),4);case 4:return f=g.j,c.dd=f,g.return(e)}})};
fg.prototype.Qd=function(a,b){var c=this,d;return J(function(e){d={type:"predict",data:{ac:c.ac,inputs:a,ka:b}};return e.return(hg.sendRequest(d,4E3))})};fg.prototype.ih=function(){hg.sendRequest({type:"warmUpModel",data:{ac:this.ac}})};function mg(){var a;return J(function(b){if(1==b.h)return 33==Q.platform?b.return(!1):void 0!=ng?b.m(2):y(b,hg.sendRequest({type:"isWebGLSupported"}),3);2!=b.h&&(ng=a=b.j,K.log("Got response from image worker: webGL support: "+ng));return b.return(ng)})}
var ng=void 0,ig=void 0,hg=void 0,jg=[];
function og(a,b){this.cache=new Tf;var c=this;this.i=b;this.I=this.i.I;this.ed=a;delete this.i.s["debug.dia.dldStats"];this.timeout=12E3;this.h=[];a=t(this.ed);for(var d=a.next();!d.done;d=a.next())b=d.value,b instanceof Array?this.h=this.h.concat(b):this.h.push(b);a=[];b=[];var e={};this.Ee=!1;var f=t(this.h);for(d=f.next();!d.done;d=f.next()){d=d.value;var g=d.Na();a.push(g.name);b.push(g.name+":"+g.version);this.Ee=this.Ee||d.Ee;Object.assign(e,g.inputs)}this.name=a.join("+");this.version=b.join("+");
this.inputs=e;if(this.i.s["debug.dia.engineStats"])try{this.N=U(pg,JSON.parse(this.i.s["debug.dia.engineStats"])),qg(this)}catch(h){}rg(this);this.i.setInterval(function(){c.i.s["debug.dia.engineStats"]=JSON.stringify(Xa(pg,c.N))},1E4);this.i.setInterval(function(){qg(c);rg(c)},6E5)}x(og,Sf);
function rg(a){a.N={};a.N.Hf=0;a.i.s["debug.dia.engineStats"]="";for(var b=t(a.h),c=b.next();!c.done;c=b.next()){c=c.value;var d=a.N,e=c.Na().name;d[pg.h[e]]={version:c.Na().version,Hf:0,Im:0,Fm:0,Hm:0,Gm:0}}}function qg(a){if(0!=a.N.Hf){var b={timestamp:Date.now(),type:"IAEngineStats",xa:a.i.runtime.env.xa};Xb(a.i.runtime,b);ae(a.i.runtime,b);b=Object.assign(b,a.N);a.I.Sa("misc",b)}}og.prototype.Na=function(){return{name:this.name,version:this.version,Ee:this.Ee,inputs:this.inputs}};
og.prototype.setTimeout=function(a){this.timeout=a};
og.prototype.Qd=function(a,b){var c=this,d,e,f,g,h,l,m,n,q;return J(function(u){switch(u.h){case 1:c.N.Hf++,d={Ju:c.N.Hf,oq:new Promise(function(r){setTimeout(function(){r({timeout:!0,error:"timed out",L:c.name})},c.timeout)})},g="",h=t(c.ed),l=h.next();case 2:if(l.done){u.m(4);break}m=l.value;n=void 0;q=m.Na();return m instanceof Array?y(u,sg(c,m,a,b,d),8):y(u,Promise.race([d.oq,tg(c,m,a,b)]),7);case 7:n=u.j;u.m(6);break;case 8:n=u.j;case 6:if(n.error){if(b.A&&K.log("[IA]["+b.Ga+"] ChainedIAEngine loop error.",
n),"dld"==n.L&&a.url||(K.warn("[IA]["+b.Ga+"] Predict ("+n.L+") error.",n.error),g+=n.L+": "+n.error+". "),n.timeout){u.m(4);break}}else if(b.A&&K.log("[IA]["+b.Ga+"] ChainedIAEngine loop result. label="+n.label+", time="+(n.time||(n.ka?n.ka.time:"?"))+"."),b.Se){if(q.Ee)return u.return(n);n.oa&&("skin"==q.Gj?b.Rp=!0:b.Qp=!0);if("ok"==n.label){if(e)return u.return(n);e=n}else f=n}else{if(n.oa)return u.return(n);"ok"==n.label?e=n:f=n}l=h.next();u.m(2);break;case 4:return b.Se?u.return(f||e||{L:c.j,
error:g}):u.return(e||f||{L:c.j,error:g})}})};
function sg(a,b,c,d,e){var f,g,h,l,m,n,q,u,r,p,v,w,z,B;return J(function(D){switch(D.h){case 1:f=[];g={};h=t(b);for(l=h.next();!l.done;g={Ki:g.Ki},l=h.next())m=l.value,g.Ki=tg(a,m,c,d).then(function(E){return function(G){return{promise:E.Ki,result:G}}}(g)),f.push(g.Ki);u=[];r=e.oq.then(function(E){return{result:E}});case 2:if(!(0<f.length)){D.m(3);break}return y(D,Promise.race(f.concat([r])),4);case 4:p=D.j;v=p.result;w=p.promise;if(v.error){if(K.warn("DIA: "+v.L+": "+v.error),u.push(v.L+": "+v.error),
v.timeout){D.m(3);break}}else{if(v.oa)return D.return(v);"ok"==v.label?q=v:n=v}z=!1;for(B=0;B<f.length;B++)if(f[B]==w){f.splice(B,1);z=!0;break}if(!z){K.error("SERIOUS PROBLEM: cannot find promise in array");D.m(3);break}D.m(2);break;case 3:return D.return(q||n||{L:a.j,error:u})}})}
function tg(a,b,c,d){var e=b.Na(),f=e.name;return(e.Ee?b.hc(c,d):b.Qd(c,d)).then(function(g){if(!g.error){var h=a.N[pg.h[f]];h.Hf++;"ok"==g.label?h.Im++:"suggestive"==g.label?h.Hm++:"explicit"==g.label?h.Fm++:"immodest"==g.label&&h.Gm++}g.L||(g.L=f);return g}).catch(function(g){K.error("[IA]["+d.Ga+"] Predict with stats ("+f+") error:",g);return{L:f,error:g}})}
function ug(){S.call(this,{version:"version",G:"auth",Ga:"debugSn",image:"image",Iu:"sensiString",Xt:"models",metadata:"metadata",width:"width",height:"height",Ed:"histo",url:"url",fv:"useLWModel",Se:"useSkinModel",Qp:"previousModelSaysConclusive",Rp:"previousSkinModelSaysConclusive",A:"verbose"},"CloudImgReqObf")}x(ug,S);var Wf=new ug;function vg(){S.call(this,{Error:"Error",zh:"Label",En:"Engine",Dn:"Details",pd:"Version",Vi:"Prob"},"CloudImgRespObf")}x(vg,S);var Xf=new vg;
function wg(){S.call(this,{Ne:"requests",image:"image",content:"content",features:"features",type:"type"},"GcviaImgReqObf")}x(wg,S);new wg;function xg(){S.call(this,{error:"error",xy:"safeSearchAnnotation",En:"Engine",Dn:"Details"},"GcviaImgRespObf")}x(xg,S);new xg;function yg(){S.call(this,{Eg:"formula",xq:"weights",Ep:"modelDirs",uo:"chart",vo:"charts",Hh:"cloudAssistance",Gj:"engineType",value:"value",label:"label",oa:"conclusive"},"IAEngineManifestObf")}x(yg,S);var ag=new yg;
function zg(){S.call(this,{version:"version",Hf:"nAnalyzed",Im:"nWhite",Fm:"nExplicit",Gm:"nImmodest",Hm:"nSuggestive",hs:"dld",Gh:"cloud",Hs:"gcv"},"IAEngineStatsObf")}x(zg,S);var pg=new zg;function Ag(a){var b=this;this.i=a;this.i.addListener(function(c,d,e){if(!b.i.disabled)return b.onMessage(c,d,e)});this.Yj=function(c){for(var d=[],e=0;e<arguments.length;++e)d[e]=arguments[e];var f;return J(function(g){if(1==g.h)return y(g,b.i.vf(d[0]),2);f=g.j;return Q.Hd?g.return(jd(f)):g.return(f)})};this.h={};this.debug="true"==this.i.s["debug.dau.debug"];Bg(this,!0);this.i.sa()?this.j=3E5:this.j=6E4;this.i.setInterval(function(){Bg(b)},this.j/2+15E3);Ag.h&&Ag.h!=Cg&&Dg(this)}var Eg,Fg;
function Dg(a){if(Zf()){var b=Ag.h;a.i.s["debug.dia.lastKnownLargeModel"]&&a.i.s["debug.dia.lastKnownLargeModel"]==b||(delete a.i.s["debug.dia.model"],delete a.i.s["debug.dva.model"],delete a.i.s["debug.dva.benchmark"],a.i.s["debug.dia.lastKnownLargeModel"]=b);if(!a.i.s["debug.dia.model"]||!a.i.s["debug.dva.model"]){var c=function(d){var e,f,g,h,l,m,n;return J(function(q){switch(q.h){case 1:if("idle"!=d){q.m(0);break}Q.wa||chrome.idle.onStateChanged.removeListener(c);try{e=JSON.parse(a.i.s["debug.dva.benchmark"])}catch(u){e=
[]}f=3;if(e.length>=f)return a.i.s["debug.dva.model"]=Cg,a.i.s["debug.dia.model"]||(a.i.s["debug.dia.model"]=Cg),q.return();g=new Yf(tf);C(q,3);return y(q,g.ub(Gg(a),b,a.Yj),5);case 5:F(q,4);break;case 3:return h=H(q),K.error("Error loading model for benchmark: "+h),q.return();case 4:return y(q,g.hj(),6);case 6:l=q.j,e.push(l),a.i.s["debug.dva.benchmark"]=JSON.stringify(e),100>l.vk.bk?(K.log("Mean time in sequential test is "+l.vk.bk+"ms, switching to bigger model for image and video"),a.i.s["debug.dva.model"]=
b,a.i.s["debug.dia.model"]=b,m={type:"betterCNNModelFound",data:{vn:b,km:b}},a.i.H.sendMessage(m)):250>l.vk.bk?(K.log("Mean time in sequential test is "+l.vk.bk+"ms, switching to bigger model for image"),a.i.s["debug.dia.model"]=b,n={type:"betterCNNModelFound",data:{km:b}},a.i.H.sendMessage(n)):e.length>=f&&(a.i.s["debug.dva.model"]=Cg,a.i.s["debug.dia.model"]||(a.i.s["debug.dia.model"]=Cg)),A(q)}})};chrome.idle.onStateChanged.addListener(c)}}}
function Gg(a){if(!a.i.sa()&&a.i.s["debug.dia.modelPath"])return Q.Hd=!1,a.i.s["debug.dia.modelPath"];a="dyncc/IAmodel";Q.Hd&&(a+="-enc");return Q.Jd+a}
Ag.prototype.onMessage=function(a,b,c){if("dynccUtils"==a.recipient){if("badContentsDetected"==a.type)return Hg(this,a,b,c);if("flaggedEvent"==a.type){a=a.data;b=this.i.runtime.env;Xb(this.i.runtime,a,!0);ae(this.i.runtime,a);b.ba&&(a.$j=b.ba.join(", "));b.bc&&(a.bc=b.bc);if(!a.host)try{var d=new URL(a.url);a.host=d.hostname}catch(f){}if(this.i.La){if(d=Ig(this.i.La))a.rj=d;if(d=Jg(this.i.La))a.sj=d}d=a.url;if(this.h[d]){b=!1;c=t(this.h[d]);for(var e=c.next();!e.done;e=c.next())e=e.value,e.tc==a.tc&&
("imageBlurred"==e.tc?(this.debug&&K.log("merging imageBlurred events for "+d),e.Af.images=e.Af.images.concat(a.Af.images),e.Af.count=e.Af.images.length,a.W&&(e.W=e.W?e.W.concat(a.W):a.W),b=!0):"videoBlurred"==e.tc&&(this.debug&&K.log("merging videoBlurred events for "+d),e.Ve.ta=e.Ve.ta.concat(a.Ve.ta),e.Ve.duration+=a.Ve.duration,a.W&&(e.W=e.W?e.W.concat(a.W):a.W),b=!0));b||this.h[d].push(a)}else this.h[d]=[a]}else if("simpleWhitelistCheck"==a.type)return this.hn(a,c)}};
Ag.prototype.hn=function(a,b){try{var c=a.data.url;new URL(c);var d=this.i.policy.rb(c);b(d.ab==Q.ea)}catch(e){K.warn("[DAU] Simple whitelist check ("+a.data.url+") error.",e),b(!0)}};
function Hg(a,b,c,d){var e=b.data.url;a.debug&&K.log("bad contents found in "+e+" by "+b.data.info.L);if(Kg(a,e))d&&d(null);else{var f=b.data.info,g=b.data.Ua;if(b=Lg(a.i.Np,e)){a.debug&&K.log("override list match found, new cats ID: ",b);if(0==(a.i.policy.rb(e,b).da||[]).length){a.debug&&K.log("No need to block this url: "+e);d&&d(null);return}f.lu=!0;f.Fb=g;g=b}Mg(a.i.Aa,e,g,f);var h={type:"main_frame",url:e,tabId:c&&c.tab.id};b=Promise.resolve();try{var l="true"==ee(a.i.runtime,"dta.uploadScreenshot");
12==Q.platform&&c&&"dynta"==f.L&&l&&(b=Ng(a.i.ja.Xa).then(function(n){n&&(f.W||(f.W=[]),f.W.push({name:"screenshot",value:n}))}))}catch(n){K.log("[DynUtil] processBadContents capture SS failed.",n)}if(c=a.h[e]){for(l=0;l<c.length;l++){var m=c[l];if("imageBlurred"==m.tc||"videoBlurred"==m.tc)"videoBlurred"==m.tc&&"dynva"==f.L&&m.W&&0<m.W.length&&(a.debug&&K.warn("moving trigger images to violation logs"),f.W=f.W?f.W.concat(m.W):m.W),a.debug&&K.log("removing "+m.tc+" flagged events for "+e),c.splice(l,
1),l--}0==c.length&&delete a.h[e]}b.then(function(){a.debug&&K.log("[DynUtil] violation log upload size = "+JSON.stringify(f).length);var n=kf(a.i.Aa,h.url.split("?")[0]);n=Q.Di?Og(a.i.filter,h,g,f).redirectUrl:Pg(a.i.ij,h,g,f,n).redirectUrl;d&&d({redirectUrl:n})});return!0}}
function Bg(a,b){for(var c=a.j,d=[],e=Date.now(),f=a.i.runtime.env.xa,g=t(Object.keys(a.h)),h=g.next();!h.done;h=g.next()){h=h.value;for(var l=0;l<a.h[h].length;l++){var m=a.h[h][l];if(b||e-m.timestamp>c)m.xa=f,d.push(m),a.h[h].splice(l,1),l--}0==a.h[h].length&&delete a.h[h]}0<d.length&&(a.debug&&K.log("uploading "+d.length+" flagged events"),a.i.I.Sa(Q.cp,d),a.i.H.sendMessage({type:"flaggedEventsUploaded"}))}function Kg(a,b){return Qg(a,b,!0)?(K.log("[DAU] Should not be blocked.",b),!0):!1}
function Qg(a,b,c){try{var d=new URL(b);if("youtube.com"==d.hostname||d.hostname.endsWith(".youtube.com")){if(c&&"/"==d.pathname&&["youtube.com","www.youtube.com","m.youtube.com"].includes(d.hostname))return a.debug&&K.log("[IUE]("+b+") Youtube homepage exempted."),!0;var e=lf(a.i.Rc,b);if(e.state==Q.ea){if(e.Ag)return a.debug&&K.log("[IUE]("+b+") Youtube URL is whitelisted and disable AI is true. Exempted."),!0;var f=e.qa;if(f&&f.startsWith("url ")){f=f.substr(4);f.startsWith("http")||(f="http://"+
f);var g=new URL(f),h=!("/"!=g.pathname||"youtube.com"!=g.hostname&&"www.youtube.com"!=g.hostname),l=!h;a.debug&&K.log("[IUE]("+b+") Youtube URL is whitelisted. Spec is "+(h?"":"not")+" Youtube homepage. "+(l?"Exempted":"Not exempted")+".",e.qa,f);return l}a.debug&&K.log("[IUE]("+b+") Youtube URL is whitelisted. Exempted.",e.qa);return!0}}if("mail.google.com"==d.hostname&&"/mail/u/0/"==d.pathname&&!d.hash.includes("/")&&c)return a.debug&&K.log("[IUE]("+b+") Gmail exempted."),!0;l=a.i.policy.rb(b,
void 0,!1);var m=Rg(a.i.Aa,d.hostname)||[];if(l.ab==Q.ea&&l.Xl)return a.debug&&K.log("[IUE]("+b+") URL is whitelisted but enable AI is true. Not exempted."),!1;if(m.includes(21))return a.debug&&K.log("[IUE]("+b+") Violation is ignored on educational sites. Exempted."),!0;if(m.includes(42)||m.includes(117)||m.includes(30)){var n=psl.get(d.hostname)||d.hostname,q=d.pathname||"";if("duckduckgo.com"==d.hostname||"www.qwant.com"==d.hostname)q+=d.search||"";if(q&&"/"!=q){if(l.ab!=Q.ea)return a.debug&&K.log("[IUE]("+
b+") URL is search engine, streaming media, or social network and is not whitelisted. Not exempted."),!1;try{if(l.Ag)return a.debug&&K.log("[IUE]("+b+") URL is search engine, streaming media, or social network, whitelisted and disabled AI is true. Exempted."),!0;if(!l.Bi)return!0;var u=l.Bi;a.debug&&K.log("matching urlSpec spec is "+u);u.startsWith("http")||(u="http://"+u);var r=new URL(u),p=!("/"!=r.pathname||n!=r.hostname&&"www."+n!=r.hostname);e=!p;a.debug&&K.log("[IUE]("+b+") URL is search engine, streaming media, or social network and whitelisted. Spec is "+
(p?"":"not")+" homepage. "+(e?"Exempted":"Not exempted")+".",l.Bi,l.X,u);return e}catch(w){return a.debug&&K.log("[IUE]("+b+") URL is search engine, streaming media, or social network and whitelisted. Failed to process spec. Not exempted.",l.Bi,l.X,String(w)),!0}}else{if(c)return a.debug&&K.log("[IUE]("+b+") Do not block homepage of search engine, streaming media, or social network."),!0;a.debug&&K.log("[IUE]("+b+") Do not exempt homepage of search engine, streaming media, or social network.");return!1}}else{var v=
l.ab==Q.ea;a.debug&&K.log("[IUE]("+b+") URL is not search engine, streaming media, or social network. "+(v?"Exempted":"Not exempted")+".");return v}}catch(w){return K.error("[IUE]("+b+") isUrlExempted error. Not exempted.",w),!1}}function Sg(a){var b,c;return J(function(d){if(1==d.h)return b=Tg,y(d,Ug(a,b),2);c=d.j;c instanceof fg&&jg.push(function(){Sg(a)});Eg?Eg.L=c:Eg=new eg(c);return d.return(Eg)})}
function Vg(a,b){var c,d;return J(function(e){if(1==e.h)return c=b||Cg,a.i.sa()&&c!=Cg&&c!=Ag.h&&(c=Cg),y(e,Ug(a,c),2);d=e.j;d instanceof fg&&jg.push(function(){Vg(a,b)});Fg?Fg.L=d:Fg=new eg(d);return e.return(Fg)})}
function Ug(a,b){var c,d,e,f;return J(function(g){switch(g.h){case 1:if(Q.features.ra.xc)throw Error("Cannot create DLD IA engine in current config (cloud or android)");if(33==Q.platform||a.i.Hc()){c=!1;g.m(2);break}gg();return y(g,mg(),3);case 3:c=g.j;case 2:if(d=c){g.m(4);break}return y(g,Zf(),5);case 5:d=g.j;case 4:e=d;if(!e)return g.return(void 0);f=c?new fg:new Yf;return y(g,new Promise(function(h){setTimeout(h,500)}),6);case 6:return y(g,f.ub(Gg(a),b,a.Yj),7);case 7:return g.return(f)}})}
function Wg(a,b,c,d,e){var f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:if(12!=Q.platform)return r.return(void 0);C(r,2);return y(r,new Promise(function(p){chrome.tabs.get(a,function(v){p(v)})}),4);case 4:f=r.j;if(!f)throw Error("Invalid tab ID "+a);if(!f.active)throw Error("Tab is not active: "+a);g=f.windowId;return y(r,new Promise(function(p){chrome.tabs.captureVisibleTab(g,{format:"png"},function(v){if(!v){var w="no dataUrl.";chrome.runtime.lastError&&(w=chrome.runtime.lastError.message);
K.error("[DAU] Capture tab error.",w)}p(v)})}),5);case 5:h=r.j;if(!h)throw Error("Cannot get screenshot");C(r,6);l=document.createElement("img");return y(r,new Promise(function(p){l.onload=p;l.src=h}),8);case 8:m=document.createElement("canvas");m.width=640;m.height=480;n=m.getContext("2d");n.drawImage(l,b,c,d,e,0,0,640,480);h=m.toDataURL("image/jpeg");F(r,7,2);break;case 6:throw q=H(r,2),Error("Canvas drawing: "+q);case 7:return r.return(h);case 2:return u=H(r),K.error("getScreenArea: "+u),r.return(void 0)}})}
function Xg(a,b){a.debug&&K.warn("[DynUtil] preanalysisCapture. text=",b?b.substring(0,50):b);for(var c=t("kill suicid die dead death gun weapon shoot violen aggress intimidat feroci".split(" ")),d=c.next();!d.done;d=c.next())if(-1!=b.indexOf(d.value)){Ng(a.i.ja.Xa);return}a.debug&&K.log("[DynUtil] preanalysisCapture. No high risk words.")}var Cg="G44-020720.json",Tg="sk-230718.json";function Yg(a,b,c){this.tf=a;this.h=this.ub(b,c)}Yg.prototype.ready=function(){var a=this;return J(function(b){return b.return(a.h)})};
Yg.prototype.ub=function(a,b){var c=this,d,e,f,g,h,l;return J(function(m){switch(m.h){case 1:return C(m,2),d=a+"/model.json",y(m,b.Th(d),4);case 4:return e=m.j,y(m,e.json(),5);case 5:return f=m.j,c.j="layers-model"==f.format,g={requestInit:{method:"GET"},fetchFunc:b.Th},h=c,y(m,c.j?tf.loadLayersModel(d,g):tf.loadGraphModel(d,g),6);case 6:h.model=m.j;F(m,0);break;case 2:throw l=H(m),Error("Error loading model "+a+": "+l);}})};
Yg.prototype.hc=function(a){var b=this,c,d;return J(function(e){c=b.model;d=tf.tidy(function(){return c.predict(a)});return e.return(d.data())})};function Zg(a,b){var c,d;return J(function(e){c=a.model;d=tf.tidy(function(){return c.predict(b)});return e.return(d)})}function bg(a){this.tf=a}bg.prototype.ready=function(){return this.h};
bg.prototype.ub=function(a,b){var c=this,d,e;return J(function(f){d=[];c.model=new Yg(c.tf,a,b);d.push(c.model.ready());e=b.Th(a+"/desc.json").then(function(g){var h;return J(function(l){if(1==l.h)return y(l,g.text(),2);h=l.j;c.Da=U($g,JSON.parse(h));if(!c.Da.vc)return l.return(Promise.reject("no inputDef found"));c.Da.vc=lb.h[c.Da.vc];A(l)})}).catch(function(g){return Promise.reject("Error loading IAmodel desc.json: "+g)});d.push(e);c.h=Promise.all(d).then(function(){c.j=!0;return c.Da.name});return f.return(c.h)})};
bg.prototype.kj=function(a){var b=this,c,d,e,f,g,h,l;return J(function(m){switch(m.h){case 1:"string"==typeof a&&(a=new Uint8Array(Mc(a)),a=Float32Array.from(a));c=Uf[b.Da.vc];if(!c)throw"DLD model: cannot find input def "+b.Da.vc;d=tf.tensor(a,[1,c.width,c.height,3]);return"skin"==b.Da.Wt?y(m,Zg(b.model,{x:tf.div(d,255)}),5):y(m,b.model.hc({input_layer:d}),4);case 4:return e=m.j,m.return(e[0]);case 5:f=m.j;g=f.slice([0,0,0],[-1,4,-1]).squeeze();var n=g=tf.transpose(g,[1,0]);n=[tf.sub(n.slice([0,
0],[-1,1]),n.slice([0,2],[-1,1]).div(tf.scalar(2))),tf.sub(n.slice([0,1],[-1,1]),n.slice([0,3],[-1,1]).div(tf.scalar(2))),tf.add(n.slice([0,0],[-1,1]),n.slice([0,2],[-1,1]).div(tf.scalar(2))),tf.add(n.slice([0,1],[-1,1]),n.slice([0,3],[-1,1]).div(tf.scalar(2)))];g=tf.concat(n,1);h=f.slice([0,4,0],[-1,1,-1]).squeeze();return y(m,tf.image.nonMaxSuppressionAsync(g,h,10,.7,.2),6);case 6:return l=m.j,m.return(0<l.shape?1:0)}})};
function ah(){S.call(this,{vc:"inputDef",name:"name",Wt:"modelType"},"DLDCnnRespObf")}x(ah,S);var $g=new ah;function bh(a,b){this.tf=a;this.path="dyncc/IAmodel";Q.Hd&&(this.path+="-enc");this.path=Q.Jd+this.path+"/G28-100001";this.l=this.ub(this.path,b)}var ch;x(bh,bg);bh.prototype.ready=function(){return this.l};
bh.prototype.kj=function(a){var b=this,c,d,e,f;return J(function(g){switch(g.h){case 1:if(!b.j)throw K.warn("DLDCNNTokenModel not loaded yet"),"DLDCNNTokenModel not loaded";C(g,2);return y(g,b.ready(),4);case 4:c=Uf[b.Da.vc];if(!c)throw"DLDToken model: cannot find input def "+b.Da.vc;d=b.tf.tensor(a,[1,c.width,c.height,1]);return y(g,b.model.hc({new_input:d}),5);case 5:return e=g.j,g.return(e);case 2:throw f=H(g),K.warn("model cal failed "+f),f;}})};function dh(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.auth.debug"];this.u=this.i.u;this.C=this.i.C;this.Ka;this.o=Q.oc+Q.Is;a=this.i.runtime.env;a.uuid&&(this.o+="?uuid="+a.uuid);this.aa=88!=Q.platform?"-----BEGIN PUBLIC KEY-----MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAniCRGw+hHmCDepxOBTyjovwHiunnQqwzb8KXeXBIwD1MOoEizqcV5x7sfE+ucMrzNCOFaB7uBDxaLseY4py7ITWwUtaY6/u5uZQAhtLQOII1SPAktdydLKJ/jP1Y9OxTem5f8Ss67HATUCNs6zCjUEQJ1Z1ZrHy+RxgRV+af8D2z76w7CzT9qAeiXq6Ytn9IpvKoAL7dAUrN/c8+jfOP7lkUt1fHze/4k+jgvaS2nv3Ya0Xs9vFVO93glJf9KHSUB3y34c122Pqdf6v8iPDWGhGgJFFMxP+8VVAnYNhQtElPq8SN0BskoSPafnlgseCPnNBuGm7/NB6I9ac/pyPKXfSVpD3k6y0G1H7ffoQDu8FiSUjOBPiLxBmHskD2ZH+FlCsNVd76sShna4ULoQ3WyYrMckOm8sGzUtp22MPkzOAfD72LeuDUSexZ8k4uo5ge6HQb+y/h+ElQsxwNgjE98cY3EsCuhCLab7lezT1uCHwpSaovexJjlrtSOI7A6eE+TdUHkqp2yvCpC3sA1CLSlitbhi2Gybhwl09/IEP4j+hbmQY57ykM1qUCuOKaeYllZH6cjOW2Tz1fYCuCQ5I+Fge6h+2leFVAkQZlw4Ln46ZrKNydQSQXajZgxZjBSwroHXmOarR4bOp8+pzsZZf2nW8lKUj9ckMZK0LgKZCgFeUCAwEAAQ==-----END PUBLIC KEY-----":
"-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAniCRGw+hHmCDepxOBTyj\novwHiunnQqwzb8KXeXBIwD1MOoEizqcV5x7sfE+ucMrzNCOFaB7uBDxaLseY4py7\nITWwUtaY6/u5uZQAhtLQOII1SPAktdydLKJ/jP1Y9OxTem5f8Ss67HATUCNs6zCj\nUEQJ1Z1ZrHy+RxgRV+af8D2z76w7CzT9qAeiXq6Ytn9IpvKoAL7dAUrN/c8+jfOP\n7lkUt1fHze/4k+jgvaS2nv3Ya0Xs9vFVO93glJf9KHSUB3y34c122Pqdf6v8iPDW\nGhGgJFFMxP+8VVAnYNhQtElPq8SN0BskoSPafnlgseCPnNBuGm7/NB6I9ac/pyPK\nXfSVpD3k6y0G1H7ffoQDu8FiSUjOBPiLxBmHskD2ZH+FlCsNVd76sShna4ULoQ3W\nyYrMckOm8sGzUtp22MPkzOAfD72LeuDUSexZ8k4uo5ge6HQb+y/h+ElQsxwNgjE9\n8cY3EsCuhCLab7lezT1uCHwpSaovexJjlrtSOI7A6eE+TdUHkqp2yvCpC3sA1CLS\nlitbhi2Gybhwl09/IEP4j+hbmQY57ykM1qUCuOKaeYllZH6cjOW2Tz1fYCuCQ5I+\nFge6h+2leFVAkQZlw4Ln46ZrKNydQSQXajZgxZjBSwroHXmOarR4bOp8+pzsZZf2\nnW8lKUj9ckMZK0LgKZCgFeUCAwEAAQ==\n-----END PUBLIC KEY-----";
this.i.addListener(function(c,d,e){if("authBackend"==c.recipient)return b.onMessage(c,d,function(f){b.debug&&K.log("["+b.u+"]["+b.C+"][AbsAuth] On message. sender=",d&&d.url,", msg=",Gc(c),", result=",Gc(f));e&&e(f)})});this.i.H.addListener(function(c){return b.Mm(c)})}dh.prototype.he=function(a){K.log("["+this.u+"]["+this.C+"][AbsAuth] Reset auth. reason="+a+".");this.bm=void 0;eh(this,"reset auth - "+a)};
dh.prototype.onMessage=function(a,b,c){"authBackend"==a.recipient&&(b=a.data,"isAuthNeeded"==a.type?c&&c({Ia:!1}):"saveState"==a.type&&(this.bm=b.state,c&&c({ok:!0})))};dh.prototype.Mm=function(){};function eh(a,b){a.trace&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Restart user auth. Reason="+b+".");a.Qc=!1;fh(a,b)}function gh(a){a.trace&&K.log("["+a.u+"]["+a.C+"][AbsAuth] User auth finished.");a.Qc=!0;a.hb=!1}
function fh(a,b){if(a.Qc)a.trace&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Not setting user auth in progress due to "+b+".");else{var c=Sc(a.i),d=a.i.policy.Sg();hh(a,c&&d,b)}}function ih(a,b){a.i.disabled||a.Qc||!a.i.policy.Sg()?a.trace&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Not setting user auth in progress 2 due to "+b+"."):hh(a,!0,b)}function hh(a,b,c){a.hb=b;a.trace&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Setting user auth in progress to "+b+" due to "+c+".")}
function jh(a,b){var c,d,e,f;return J(function(g){if(1==g.h)return C(g,2),c={inputs:[{b64:b}]},d="http://tf-lwm.in.deledao.com/v1/models/anon:predict",a.i.sa()||(d="http://tf-lwm.dev-in.deledao.com/v1/models/anon:predict"),y(g,kd(a.i.http,d,"POST",JSON.stringify(c),2E4,!0),4);if(2!=g.h)return e=g.j,(e=JSON.parse(e))&&e.outputs&&e.outputs[0]?g.return(e.outputs[0]):g.return(void 0);f=H(g);K.error("["+a.u+"]["+a.C+"][AbsAuth]<3535> Predict by TF LWM server error.",f);A(g)})}
function kh(a,b,c){var d,e,f,g,h,l,m,n,q,u,r,p;return J(function(v){switch(v.h){case 1:return a.debug&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Send anonymous request. url="+b+", d_post="+JSON.stringify(c)+"."),y(v,kd(a.i.http,b,"POST",JSON.stringify(c),1E4,!0),2);case 2:d=v.j;d=JSON.parse(d);if(!d||!d.Challenge)return v.return(d);e=d.Challenge;C(v,3);if(88!=Q.platform){g=new KJUR.jws.JWS;g.parseJWS(e);if(KJUR.jws.JWS.verifyJWT(e,a.aa,{alg:["RS256"]}))a.debug&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Challenge header="+
g.parsedJWS.headS+", payload="+g.parsedJWS.payloadS);else return K.error("["+a.u+"]["+a.C+"][AbsAuth] Challenge invalid: "+e),d.Error="Invalid challenge JWT",v.return(d);f=JSON.parse(g.parsedJWS.payloadS);v.m(5);break}return y(v,new Promise(function(w,z){nodeMods.jwt.verify(e,a.aa,{algorithm:"RS256"},function(B,D){B?z(B):w(D)})}),6);case 6:f=v.j;case 5:F(v,4);break;case 3:return h=H(v),K.error("["+a.u+"]["+a.C+"][AbsAuth] Challenge invalid: "+h+", "+e),d.Error="Invalid challenge JWT",v.return(d);
case 4:if(88!=Q.platform){v.m(7);break}return y(v,jh(a,f.data),8);case 8:l=v.j,K.log("["+a.u+"]["+a.C+"][AbsAuth]<3535> Challenge response by TF LWM=",JSON.stringify(l));case 7:if(l){v.m(9);break}ch||(ch=new bh(tf,{Th:a.i.Gb.Yj}));return y(v,ch.ready(),10);case 10:if(88==Q.platform||99==Q.platform)for(n=Uint8Array.from(Buffer.from(f.data,"base64")),m=new Float32Array(n.length),q=0;q<n.length;q++)m[q]=n[q]/255;else for(u=atob(f.data),m=new Float32Array(u.length),r=0;r<u.length;r++)m[r]=u.charCodeAt(r)/
255;return y(v,ch.kj(m),11);case 11:p=v.j,a.debug&&K.log("["+a.u+"]["+a.C+"][AbsAuth] Challenge response: "+p),l=Array.from(p);case 9:return c.Challenge=e,c.ChallengeResponse=l,y(v,kd(a.i.http,b,"POST",JSON.stringify(c),1E4,!0),12);case 12:return d=v.j,v.return(JSON.parse(d))}})}function lh(a){if(a.i&&a.i.policy)return a.i.policy.Sk}
function mh(a,b){dh.call(this,a);var c=this;b&&(this.h=b);this.l=function(e){try{this.i=e,this.map=JSON.parse(mc(this.i.s["auth.oumap"]))}catch(f){this.map={}}};this.l.prototype.get=function(e){return this.map[e]};this.l.prototype.add=function(e,f){if(!this.map[e])for(var g=Object.keys(this.map),h=g.length;20<=h;)delete this.map[g.shift()],h--;this.map[e]=f;this.flush()};this.l.prototype.flush=function(){this.i.s["auth.oumap"]=nc(JSON.stringify(this.map))};this.j=function(e){try{this.i=e,this.map=
JSON.parse(mc(this.i.s["auth.groupsmap"]))}catch(f){this.map={}}};this.j.prototype.get=function(e){return this.map[e]};this.j.prototype.add=function(e,f){if(!this.map[e])for(var g=Object.keys(this.map),h=g.length;20<=h;)delete this.map[g.shift()],h--;this.map[e]=f;this.flush()};this.j.prototype.flush=function(){this.i.s["auth.groupsmap"]=nc(JSON.stringify(this.map))};this.$c=Q.Fa+"/eduSignIn.html";this.J=Q.oc+Q.Js;this.zd="https://www.google.com/accounts/Logout?continue=https://appengine.google.com/_ah/logout?continue=";
this.he("Edu auth init.");if(a=this.i.s["auth.qrToken"])if(a=a.trim(),0<a.length)try{this.debug&&K.log("[Auth] Try auto sign in qr code "+a);var d=mc(a);nh(this,d)}catch(e){this.debug&&K.error("[Auth] Auto qr code sign in failed: "+e)}99==Q.platform&&(setTimeout(function(){return oh(c)},200),this.i.setInterval(function(){return oh(c)},3E5))}x(mh,dh);
function oh(a){a.debug&&K.log("[Auth] Send internal auth msg.");a.onMessage({recipient:"authBackend",type:"isAuthNeeded",data:{na:"Internal"}},null,function(){})}k=mh.prototype;k.Mm=function(a){"policyChanged"==a.type?fh(this,"policy changed"):"haparaSubscriptionExpired"===a.type&&this.Lm()};k.Lm=function(){this.$c=Q.kf+"/eduSignIn.html"};
k.he=function(a){this.i.I&&Qd(this.i.I,"Reset auth: "+a);dh.prototype.he.call(this,a);this.Lc=new this.l(this.i);this.Cd=new this.j(this.i);this.Mj=!1;this.Dg=!Sc(this.i);this.Me=this.ke()};
k.ke=function(){var a=this;return J(function(b){return 1==b.h?(a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Sign in customer."),y(b,ph(a),2)):a.i.runtime.getAuthToken()?(K.warn("["+a.u+"]["+a.C+"][EduAuth] Already has auth token. No need to do sign in customer again."),ih(a,"sign in customer"),b.m(0)):y(b,qh(a,!1),0)})};
function qh(a,b){var c,d,e,f;return J(function(g){switch(g.h){case 1:return a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Get auth token by IP."),C(g,2),c={},88!=Q.platform?(d={credential:"none"},y(g,a.getAuthToken(d),7)):y(g,rh(a),6);case 6:c=g.j;g.m(5);break;case 7:c=g.j;case 5:a.ga=Date.now();a.trace&&K.log("["+a.u+"]["+a.C+"][EduAuth] Customer sign-in via public IP: "+JSON.stringify(c));if(c.Error){if(b)throw"getAuthTokenByIp error: "+c.Error;K.error("["+a.u+"]["+a.C+"][EduAuth] Get auth token by IP error: "+
c.Error)}else{if(88!==Q.platform)e=!1;else try{var h=a.i.policy;try{var l=U(h.ga,JSON.parse(c.Uk)),m=l.Ab&&l.Ab.Ab&&JSON.parse(l.Ab.Ab);var n=U(h.ga,m).M.Ko}catch(q){K.warn("[Policy] getDebugStringFromPolicyString failed, err: ",q),n=""}e="true"==fe(n,"auth.askSignInCloud")}catch(q){K.warn("["+a.u+"]["+a.C+'][CloudAuth] auth by email failed, auth by ip succeed, not able to get debugString "auth.askSignInCloud, err: ',q),e=!1}if(e)return K.warn("["+a.u+"]["+a.C+'][CloudAuth] auth by email failed, auth by ip succeed, but debugString "auth.askSignInCloud" is on, ask user to signin'),
g.return(!0);sh(a,c)}F(g,0);break;case 2:f=H(g);K.error("["+a.u+"]["+a.C+"][EduAuth] Get auth token by IP exception: "+f);try{88==Q.platform&&String(f).includes("memory access out of bounds")&&(K.error("Fatal error happened. "+f),process.exit(1))}catch(q){}if(b)throw f;A(g)}})}
function th(a){var b,c,d,e;return J(function(f){switch(f.h){case 1:b=10,c=300;case 2:if(a.i.Yc||a.i.disabled){f.m(0);break}C(f,4);return y(f,qh(a,!0),6);case 6:if(d=f.j)return f.return(!0);f.m(0);break;case 4:e=H(f);K.error("["+a.u+"]["+a.C+"][EduAuth] Get auth token by IP failed. delay="+b+", err="+e);if(!((String(e).includes("Request timed out")||String(e).includes("Failed to fetch"))&&b<c)){f.m(7);break}return y(f,new Promise(function(g){setTimeout(g,1E3*b)}),8);case 8:b=Math.min(2*b,c);f.m(2);
break;case 7:throw e;}})}k.hq=function(){return Sc(this.i)||this.ga&&!(Date.now()>this.ga+3E5)?!1:!0};
function sh(a,b,c){a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Handle sign-in: "+Gc(b));a.i.I&&Qd(a.i.I,"Handle sign-in "+b.Ac);if(b.Ac&&a.i.runtime.getAuthToken()){var d=a.i.policy.Gc(),e=c||d&&d.method;if(d&&"gsuite"==e&&d.Nk){var f=d.Nk.split(",").map(function(h){return h.trim()});e=!1;f=t(f);for(var g=f.next();!g.done;g=f.next())if(b.Ac.endsWith("@"+g.value)){e=!0;break}if(!e&&(K.error("["+a.u+"]["+a.C+"][EduAuth] "+b.Ac+" doesn't belong to "+d.Nk),void 0===a.i.Xg))throw Error("You must log into one of these domains: "+
d.Nk.substring(0,100));}}ke(a.i.runtime,b.Rk,b.Xi);K.log("["+a.u+"]["+a.C+"][EduAuth] Handle auth token response. IsOffCampus="+b.Zk);void 0!=b.Zk&&ce(a.i.runtime,b.Zk);a.i.H.sendMessage({type:"customerSignedIn"});b.Ac&&(d=a.i.policy.Gc(),c=c||d&&d.method,a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] User signed in. method="+c+"."),a.i.I&&Qd(a.i.I,c+" user signed in "+b.Ac),gh(a),c={type:"userSignedIn",data:{ae:c,Pb:b.Ac,userName:b.Pn,gh:b.il,jb:b.Yk||a.Lc.get(b.Ac),groups:b.fg||a.Cd.get(b.Ac)||[],
lf:!0}},a.i.H.sendMessage(c),b.Yk&&a.Lc.add(b.Ac,b.Yk),b.fg&&0<b.fg.length&&a.Cd.add(b.Ac,b.fg),a.mb&&(a.mb.notify(!0),a.mb=void 0));try{Se(a.i.policy,b.Uk)}catch(h){K.error("["+a.u+"]["+a.C+"][EduAuth] Error parsing policy config: "+h)}ih(a,"handle auth token")}
k.wi=function(a,b){this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] Sign out customer. reason="+a+".");this.jd();b&&(this.h=void 0);this.i.s.removeItem("auth.oumap");this.i.s.removeItem("auth.groupsmap");this.i.s.removeItem("auth.qrToken");this.i.s.removeItem(Q.Wq);ke(this.i.runtime,void 0);this.he(a);this.i.H.sendMessage({type:"customerSignedOut"})};
k.jd=function(){this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] Sign out user.");eh(this,"sign out user");uh&&(this.Dg=!0);this.i.s.removeItem("auth.qrToken");this.i.H.sendMessage({type:"userSignedOut"})};
function vh(a,b){return J(function(c){K.log("["+a.u+"]["+a.C+"][EduAuth] Start user auth. url="+b+".");if(a.Qc)return c.return(Promise.resolve());a.mb||(a.mb={},a.mb.promise=new Promise(function(d,e){K.log("["+a.u+"]["+a.C+"][EduAuth] User auth notify begin.");a.hb=!0;a.mb.ma={};a.mb.ma.lk=b;a.mb.notify=function(f){K.log("["+a.u+"]["+a.C+"][EduAuth] User auth notify finish. status="+f+".");f?d():e()}}));return c.return(a.mb.promise)})}k.Xh=function(){};
k.onMessage=function(a,b,c){var d=this;if("authBackend"==a.recipient){var e=a.data;if("isAuthNeeded"==a.type){if(this.i.disabled){c&&c({Ia:!1});return}this.Me.then(function(){function f(B,D,E){var G=this;this.Ka&&(g.Ka=this.Ka.list,this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] "+B+" config.authAllowList="+g.Ka));var M=this.i.policy.M.ec;if(["windows","mac"].includes(this.i.runtime.env.platform)&&M&&M[B]&&M[B].qn&&!this.Mj){var T=function(){var O=G.i.runtime.env;if(O.Ha){var R=wh(G,O.Ha,M[B].domain);
G.debug&&K.log("["+G.u+"]["+G.C+"][EduAuth] Windows user "+O.Ha+(" => "+B+" user: ")+R);void 0!==G.i.Xg&&(R=G.i.Xg,K.log("Pretending user:",R));O={type:"userSignedIn",data:{ae:D,Pb:R,userName:O.Wg,jb:G.Lc.get(R),groups:G.Cd.get(R),lf:!0}};G.i.H.sendMessage(O);xh(G,R)}else K.error("["+G.u+"]["+G.C+"][EduAuth] No OS user ID found.");gh(G);g.Ia=!1};this.i.H.addListener(function(O){"logon"==O.data.event&&T()},["osLogonEvent"]);T()}else g.df=[this.$c],g.Ta=this.$c+(E?"?idp="+E:""),g.di=this.Dg}var g,h,
l,m,n,q,u,r,p,v,w,z;return J(function(B){if(1==B.h){if(d.i.disabled)return c&&c({Ia:!1}),B.return();if(!d.hq())return B.m(2);K.warn("["+d.u+"]["+d.C+"][EduAuth] Retry auth by ip as previous attempt failed.");d.Me=d.ke();return y(B,d.Me,2)}g={state:d.bm,df:[d.$c],zd:d.zd,It:uh,debug:d.debug,enabled:!0,Au:!Q.Di};d.Sd&&d.Ih&&Date.now()<d.Ih?(h=d.Xh(),g={enabled:!0,Cc:"cloudError",Ia:!0,Ta:h}):Sc(d.i)?d.hb&&(g.Ia=!0,l=d.i.policy.Gc(),m=l.method,g.Cc=m,d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] User auth in progress. SignInMethod="+
JSON.stringify(l)+", platform="+d.i.runtime.env.platform+"."),d.mb&&d.mb.ma.lk&&(g.Fh=d.mb.ma.lk),"gsuite"==m?(d.Ka&&(g.Ka=d.Ka.list,d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] Gsuite config.authAllowList="+g.Ka)),n=d.i.policy.M.ec,["windows","mac"].includes(d.i.runtime.env.platform)&&n&&n.Dd&&n.Dd.qn&&!d.Mj?(q=function(){var D=d.i.runtime.env;if(D.Ha){var E=wh(d,D.Ha,n.Dd.domain);d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] Windows user "+D.Ha+" => G suite user: "+E);D={type:"userSignedIn",data:{ae:"gsuite",
Pb:E,userName:D.Wg,jb:d.Lc.get(E),groups:d.Cd.get(E),lf:!0}};d.i.H.sendMessage(D);xh(d,E)}else K.error("["+d.u+"]["+d.C+"][EduAuth] No OS user ID found.");gh(d);g.Ia=!1},d.i.H.addListener(function(D){"logon"==D.data.event&&q()},["osLogonEvent"]),q()):(g.df=[d.$c],g.Ta=d.$c+"?idp=google",g.di=!de(d.i.runtime)&&d.Dg)):m==d.i.policy.Gn?(d.Ka&&(g.Ka=d.Ka.list,d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] Azure config.authAllowList="+g.Ka)),u=d.i.policy.M.ec,["windows","mac"].includes(d.i.runtime.env.platform)&&
u&&u.pg&&u.pg.qn&&!d.Mj?(r=function(){var D=d.i.runtime.env;if(D.Ha){var E=wh(d,D.Ha,u.pg.domain);d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] Windows user "+D.Ha+" => Azure user: "+E);void 0!==d.i.Xg&&(E=d.i.Xg,K.log("Pretending user:",E));D={type:"userSignedIn",data:{ae:d.i.policy.Gn,Pb:E,userName:D.Wg,jb:d.Lc.get(E),groups:d.Cd.get(E),lf:!0}};d.i.H.sendMessage(D);xh(d,E)}else K.error("["+d.u+"]["+d.C+"][EduAuth] No OS user ID found.");gh(d);g.Ia=!1},d.i.H.addListener(function(D){"logon"==D.data.event&&
r()},["osLogonEvent"]),r()):(g.df=[d.$c],g.Ta=d.$c+"?idp=azure",g.di=d.Dg)):"ad"==m?(p=d.i.runtime.env,p.Ha?(v=p.Ha,w=void 0,d.i.policy.M&&d.i.policy.M.ec&&(w=d.i.policy.M.ec.jr),d.i.I&&d.i.I.Ya&&d.i.I.Ya("Local AD user signed in "+w+"\\"+v+"."),w&&(v=w+"\\"+v),d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] Local AD user: "+v),z={type:"userSignedIn",data:{ae:"ad",Pb:v,userName:p.Wg,jb:d.Lc.get(p.Ha),groups:d.Cd.get(p.Ha),lf:!0}},d.i.H.sendMessage(z),xh(d,v)):K.error("["+d.u+"]["+d.C+"][EduAuth] No user ID found from env.json."),
gh(d),g.Ia=!1):"classLink"===m?f.apply(d,["classLink","classLink"]):("none"!=m&&K.error("["+d.u+"]["+d.C+"][EduAuth] Unknown user auth method in policy: "+m),d.debug&&K.warn("["+d.u+"]["+d.C+"][EduAuth] No user auth method."),d.hb=!1,g.Ia=!1)):(g.Ia=!0,g.Cc="customer",g.df=[d.$c],g.Ta=d.$c,g.di=d.Dg,d.Ka&&(g.Ka=d.Ka.list,d.debug&&K.log("["+d.u+"]["+d.C+"][EduAuth] config.authAllowList="+g.Ka)));c&&c(g);A(B)})}).catch(function(f){K.error("["+d.u+"]["+d.C+"][EduAuth] Ready to answer content script throws error. err="+
f+".")});return!0}if("custUserPass"==a.type)return this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] Customer sign-in via user/pass received."),this.getAuthToken({credential:"password",username:e.user,password:e.pa}).then(function(f){if(f.Error)c({error:f.Error});else try{sh(d,f),c&&c({ok:!0})}catch(g){c({error:g.toString()})}}).catch(function(f){c({error:f})}),!0;if("gsuiteToken"==a.type)return this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] Customer combo/gsuite sign-in received."),this.getAuthToken({credential:"gsuiteToken",
np:e.token,uuid:this.i.runtime.env.uuid}).then(function(f){if(f.Error)c({error:f.Error});else try{sh(d,f,"gsuite"),c({ok:!0})}catch(g){K.error("["+d.u+"]["+d.C+"][EduAuth] Gsuite token error: "+g),K.error(g.stack),c({error:g.toString()})}}).catch(function(f){c({error:f})}),!0;if("azureToken"==a.type)return this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] Customer combo/Azure Ad sign-in received."),this.getAuthToken({credential:"azureToken",sr:e.token,uuid:this.i.runtime.env.uuid}).then(function(f){if(f.Error)c({error:f.Error});
else try{sh(d,f,"azure-ad"),c({ok:!0})}catch(g){c({error:g.toString()})}}).catch(function(f){c({error:f})}),!0;if("jwtToken"==a.type)return this.Qc?(a=this.i.runtime.env.username,this.i.s["auth.qrToken"]?c({error:"This device is locked to "+a+". Please contact your school admin to remove this lock."}):c({error:"This device is already logged in as "+a+". Please restart the browser app if you want to log in as a different person."})):nh(this,e.token).then(function(f){if(f.Error)c({error:f.Error});else{if(e.oi){var g=
nc(e.token);d.i.s["auth.qrToken"]=g}c({rp:qf(d.i.policy),user:f.Pn})}}).catch(function(f){c({error:f})}),!0;"loginCancelled"==a.type?(this.debug&&K.log("["+this.u+"]["+this.C+"][EduAuth] User cancelled sign-in process."),this.hb=!1,this.mb&&(this.mb.notify(!1),this.mb=void 0),c&&c({ok:!0})):"userSignedOut"==a.type?(this.Dg=!1,c({ok:!0})):dh.prototype.onMessage.call(this,a,b,c)}};
function rh(a){var b,c;return J(function(d){if(1==d.h){a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Anonymous auth by IP.");if(88!=Q.platform)throw Error("anonAuthByIp() shouldn't have been called in non-cloud mode");b={version:"1.0",GCVersion:lh(a),clientVersion:a.i.ob(),ipAddr:a.i.Tb.Kc.wd,uuid:a.i.runtime.env.uuid};return y(d,kh(a,Q.oc+"/GetAuthTokenByIp",b),2)}c=d.j;return d.return(U(yh,c))})}
function wh(a,b,c){var d=b,e=b;c&&(d=b.indexOf("\\"),-1!=d?b=b.substr(d+1):(d=b.indexOf("@"),-1!=d&&(b=b.substr(0,d))),d=b+"@"+c);a.i.I&&Qd(a.i.I,"Convert Windows logon ("+e+") to email ("+d+").");return d}
function ph(a){var b,c,d;return J(function(e){if(1==e.h)return!a.Ka&&a.i.s["auth.allow"]&&(a.Ka=U(zh,JSON.parse(a.i.s["auth.allow"]))),C(e,2),y(e,id(a.i.http,"GET",Q.rr(),null,3,3,20),4);if(2!=e.h)return(b=e.j)&&""!==b.trim()&&(a.trace&&K.log("["+a.u+"]["+a.C+"][EduAuth] Got auth allow list: "+b),c=U(zh,JSON.parse(b)),c.Error||(a.Ka=c,1024>b.trim().length&&(a.i.s["auth.allow"]=b))),F(e,0);d=H(e);K.error("["+a.u+"]["+a.C+"][EduAuth] Failed to get auth allow list: "+d);A(e)})}
k.getAuthToken=function(a){var b=this,c,d,e,f,g;return J(function(h){if(1==h.h)return a.version||(a.version="1.0"),a.Xk=lh(b),b.debug&&(c=JSON.parse(JSON.stringify(a)),c.password="***",K.log("["+b.u+"]["+b.C+"][EduAuth] Get auth token. req="+JSON.stringify(c))),d=Xa(Ah,a),y(h,kd(b.i.http,b.J,"POST",JSON.stringify(d),4E3),2);e=h.j;b.debug&&K.log("["+b.u+"]["+b.C+"][EduAuth] Get auth token. resp="+e);f=JSON.parse(e);g=U(yh,f);return h.return(g)})};
function Bh(a,b,c){var d,e,f,g,h;return J(function(l){if(1==l.h)return a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Get auth token by email. loginUserId="+b+", authMethod="+c+"."),d=a.i.runtime.env,e={version:"1.1",GCVersion:lh(a),credential:"email",userID:b,clientVersion:a.i.ob(),uuid:d.uuid},f=Q.oc+"/GetAuthTokenByEmail?v=1.1",y(l,kh(a,f,e),2);g=l.j;h=U(yh,g);if(h.Error)throw"no entitlement"==h.Error.toLowerCase()&&88!=Q.platform&&a.i.H.sendMessage({type:"policyDisabled"}),"/GetAuthTokenByEmail: "+
h.Error;try{sh(a,h,c)}catch(m){throw"handleAuthTokenResponse: "+m;}A(l)})}
function Ch(a,b,c){var d,e,f;return J(function(g){switch(g.h){case 1:d=10,e=300;case 2:if(a.i.Yc||a.i.disabled){g.m(0);break}C(g,4);return y(g,Bh(a,b,c),6);case 6:g.m(0);break;case 4:f=H(g);K.error("["+a.u+"]["+a.C+"][EduAuth] Get auth token by email failed. delay="+d+", err="+f);if(!((String(f).includes("Request timed out")||String(f).includes("Failed to fetch"))&&d<e)){g.m(7);break}return y(g,new Promise(function(h){setTimeout(h,1E3*d)}),8);case 8:d=Math.min(2*d,e);g.m(2);break;case 7:throw f;}})}
function nh(a,b){var c,d,e,f,g,h,l,m;return J(function(n){switch(n.h){case 1:a.debug&&K.log("["+a.u+"]["+a.C+"][EduAuth] Get auth token by token. "+JSON.stringify(b));if(!b)return n.return({Error:"Empty token."});c={};a.hb=!0;C(n,2);d=a.i.runtime.env;e={token:b,uuid:d.uuid};e.version||(e.version="1.0");e.Xk=lh(a);f=a.J+"ByToken";g=Xa(Ah,e);return y(n,id(a.i.http,"POST",f,JSON.stringify(g)),4);case 4:h=n.j;l=JSON.parse(h);c=U(yh,l);c.Error?(K.error("["+a.u+"]["+a.C+"][EduAuth] getAuthTokenByToken query error: "+
c.Error),c.Error="Authentication error.",a.i.s.removeItem("auth.qrToken")):sh(a,c);F(n,3);break;case 2:m=H(n),K.error("["+a.u+"]["+a.C+"][EduAuth] getAuthTokenByToken exception: "+m),c.Error="Authentication error.";case 3:return c.Error||gh(a),n.return(c)}})}
function xh(a,b){var c,d,e,f,g,h,l,m,n,q;J(function(u){switch(u.h){case 1:if(!a.i.runtime.getAuthToken())return K.error("[Auth] getOuFromServer: no auth token"),u.return();c=Q.oc+"/getUserInfo";a.debug&&K.log("[Auth] Getting OU from server for "+b);d={useremail:b,suggestUserId:!0,auth:a.i.runtime.getAuthToken()};if(a.S)return K.warn("[Auth] getOuFromServer: loop already running."),u.return();a.S=!0;g=e=5;case 2:if(a.i.Yc||!(0<g)){u.m(3);break}g--;C(u,4);return y(u,kd(a.i.http,c,"POST",JSON.stringify(d),
4E3),6);case 6:f=u.j;f=U(bb,JSON.parse(f));g=0;F(u,2);break;case 4:return h=H(u),K.warn("[Auth] Cannot get OU from server, retry later: "+h+"\n"+h.stack),"404"==h?y(u,new Promise(function(r){setTimeout(r,36E5)}),2):y(u,new Promise(function(r){setTimeout(r,1E3*e)}),9);case 9:e=Math.min(2*e,60);u.m(2);break;case 3:a.S=!1;if(!f)return K.error("[Auth] getOuFromServer: cannot get response from server."),u.return();if(f.Error)return K.error("[Auth] getOuFromServer: got error in response:",f.Error),a.Mj=
!0,a.jd(),u.return();if(a.i.runtime.env.Va!=b)return K.error("[Auth] User ID changed while getting OU: "+b+" => "+a.i.runtime.env.Va),u.return();l=f.Nn&&f.Nn.trim()||"";m=f.fg;n=f.O;a.debug&&K.log("[Auth] Got OU and name from server: "+l+", "+n+"; groups="+m);a.i.I&&a.i.I.Ya&&a.i.I.Ya("Got OU from server. UserId="+f.Ah+". OU="+JSON.stringify(l)+". Groups="+JSON.stringify(m)+".");l?a.Lc.add(b,l):(K.error("[Auth] Empty OU string, continue to use cached value."),l=a.Lc.get(b)||"");m?a.Cd.add(b,m):m=
a.Cd.get(b)||[];f.Ah&&f.Ah!=b&&(K.warn("[Auth] User ID overriden by server: "+b+" => "+f.Ah),b=f.Ah,a.Lc.add(b,l),m&&0<m.length&&a.Cd.add(b,m));q={type:"userSignedIn",data:{ae:a.i.policy.Gc().method,Pb:b,userName:n,gh:f.il,jb:l,groups:m,lf:!0}};a.i.H.sendMessage(q);a.i.policy.Qf();A(u)}})}var uh=!0;function Dh(a){mh.call(this,a)}x(Dh,mh);Dh.prototype.ke=function(){var a=this;return J(function(b){if(1==b.h)return C(b,2),y(b,Eh(a),4);if(2!=b.h)return F(b,0);H(b);return y(b,mh.prototype.ke.call(a),0)})};
function Fh(a){var b,c;return J(function(d){switch(d.h){case 1:b=0;case 2:if(!(5>b)){d.m(4);break}return y(d,new Promise(function(e){if(void 0!==a.i.Xg){var f=a.i.Xg;K.log("Pretending user:",f);e({email:f,id:""})}else chrome.identity.getProfileUserInfo(function(g){K.log("[Auth] Chrome identity user info: "+JSON.stringify(g));if(g){var h=g.email;""==g.email&&""==g.id?(K.log("[Auth] Set managed guest session."),a.D=!0):a.D=!1}g&&void 0!==h&&""!==h.trim()?e(g):e(null)})}),5);case 5:return(c=d.j)?d.return(c):
y(d,new Promise(function(e){setTimeout(e,1E3)}),3);case 3:b++;d.m(2);break;case 4:return d.return(null)}})}
function Eh(a){var b,c,d,e,f,g,h,l,m;return J(function(n){switch(n.h){case 1:return y(n,Fh(a),2);case 2:b=n.j;if(!b)throw K.error("[Auth] Failed to get Chrome identity.",chrome.runtime.lastError),Error("Failed to get Chrome identity."+chrome.runtime.lastError);c=b.email;a.i.I&&Qd(a.i.I,"Chrome identity "+c);a.debug&&a.Lc.get(c)&&K.log("[Auth] Got cached OU: "+a.Lc.get(c));d={type:"userSignedIn",data:{ae:"gsuite",Pb:c,jb:a.Lc.get(c),groups:a.Cd.get(c)}};a.i.H.sendMessage(d);e={interactive:!1,account:{id:b.id}};
return y(n,new Promise(function(q){chrome.identity.getAuthToken(e,function(u){q(u)})}),3);case 3:if(f=n.j)return a.debug&&K.log("[Auth] Got access token via identify API: "+f),g=a.i.runtime.env,h={credential:"chromeToken",np:f,uuid:g.uuid},C(n,7),y(n,a.getAuthToken(h),9);K.error("[ChromeAuth] identity.getAuthToken() failed: "+JSON.stringify(chrome.runtime.lastError));return y(n,Bh(a,c,"gsuite"),0);case 9:l=n.j;if(l.Error)throw"no entitlement"==l.Error.toLowerCase()&&a.i.H.sendMessage({type:"policyDisabled"}),
l.Error;sh(a,l);F(n,0);break;case 7:throw m=H(n),"/GetAuthToken: "+m;}})}function Gh(a){mh.call(this,a);this.i.s.removeItem("env.authToken")}x(Gh,Dh);
Gh.prototype.ke=function(){var a=this,b,c;return J(function(d){switch(d.h){case 1:if(a.v)return d.return();a.v=!0;b=300;case 2:return C(d,4),y(d,Eh(a),6);case 6:a.v=!1;d.m(0);break;case 4:c=H(d);if(a.D)return K.error("[Auth] /GetAuthToken on Chromebook failed. Use base sign in.",c),y(d,Dh.prototype.ke.call(a),10);K.error("[Auth] /GetAuthToken on Chromebook failed, will retry later: ",c);if(a.i.disabled){d.m(0);break}return y(d,new Promise(function(e){setTimeout(e,b)}),9);case 9:b=Math.min(2*b,5E3);
d.m(2);break;case 10:a.v=!1,d.m(0)}})};Gh.prototype.onMessage=function(a,b,c){"authBackend"==a.recipient&&("isAuthNeeded"==a.type?this.i.disabled?c({Ia:!1}):this.D?c({Ia:!1}):this.hb?c({retry:1}):c({enabled:!1}):Dh.prototype.onMessage.call(this,a,b,c))};Gh.prototype.wi=function(a){K.warn("[Auth] crbk signout customer ignored: "+a)};Gh.prototype.jd=function(){K.warn("[Auth] crbk signout user ignored")};function Hh(a,b){mh.call(this,a,b);this.v=Q.Fa+"/cloudAuthError.html"}x(Hh,mh);k=Hh.prototype;
k.Lm=function(){mh.prototype.Lm.call(this);this.v=Q.kf+"/cloudAuthError.html"};k.save=function(){return this.h&&this.h.Z&&this.h.Z!=Q.qd&&this.h.Pj?this.h:{ko:this.i.policy.Gc().method,Z:this.i.runtime.env.Va}};
k.ke=function(){var a=this,b,c,d,e;return J(function(f){switch(f.h){case 1:return a.debug&&K.log("["+a.u+"]["+a.C+"][CloudAuth] Sign in customer. savedState="+JSON.stringify(a.h)),a.D=Date.now(),a.Sd=void 0,a.Ih=void 0,C(f,2),y(f,ph(a),4);case 4:F(f,3);break;case 2:b=H(f),K.error("["+a.u+"]["+a.C+"][CloudAuth] Get auth allow list failed. err="+b);case 3:if(!a.h||!a.h.Z||a.h.Z==Q.qd){f.m(5);break}C(f,6);return y(f,Ch(a,a.h.Z,a.h.ko),8);case 8:return K.log("["+a.u+"]["+a.C+"][CloudAuth] Restore session succeeded. savedState="+
JSON.stringify(a.h)),f.return();case 6:c=H(f),K.error("["+a.u+"]["+a.C+"][CloudAuth] Restore session failed. savedState="+JSON.stringify(a.h)+", err="+c);case 5:if(a.i.runtime.getAuthToken()){K.warn("["+a.u+"]["+a.C+"][CloudAuth] Already has auth token. No need to do sign in customer again.");f.m(0);break}C(f,10);return y(f,th(a),12);case 12:if(d=f.j)return f.return();K.warn("["+a.u+"]["+a.C+"][CloudAuth] Restore session anonymously. savedState="+JSON.stringify(a.h));if(!a.Qc&&a.h&&a.h.Z&&a.h.Z!=
Q.qd){var g=a.h.Z;K.log("["+a.u+"]["+a.C+"][CloudAuth] Claimed user signed in. user_id="+g+".");a.i.H.sendMessage({type:"userSignedIn",data:{Pb:g,lf:!0}});gh(a)}return f.return();case 10:e=H(f),K.error("["+a.u+"]["+a.C+"][CloudAuth] Cannot restore session. savedState="+JSON.stringify(a.h)+", err="+e),a.h&&a.h.Pj&&(a.Sd="Configuration error: unknown user ID: "+a.h.Z+". Please contact your IT administrator. ",a.Ih=Date.now()+36E4),A(f)}})};
k.hq=function(){return this.Qc?!1:!this.D||Date.now()>this.D+3E5?(K.log("["+this.u+"]["+this.C+"][CloudAuth] Should try sign in again. expiration=300000."),!0):!1};k.restore=function(){return J(function(a){A(a)})};k.ready=function(){var a=this;return J(function(b){return y(b,a.Me,0)})};k.Xh=function(){return this.Sd&&this.Ih&&Date.now()<this.Ih?this.v+"?msg="+encodeURIComponent(this.Sd):void 0};
function Lh(){S.call(this,{version:"version",Xk:"GCVersion",Qw:"clientVersion",credential:"credential",username:"username",password:"password",np:"gsuiteToken",uuid:"uuid",Kq:"Challenge",Iv:"ChallengeResponse",method:"method",data:"data",expiration:"expiration",Xi:"TokenExpiration",sr:"azureToken",token:"token",Pb:"userID"},"GetAuthTokenReqObf")}x(Lh,S);var Ah=new Lh;
function Mh(){S.call(this,{pd:"Version",Error:"Error",Rk:"AuthToken",il:"UserToken",Zk:"IsOffCampus",Ac:"Email",Pn:"UserName",Yk:"Group",fg:"Groups",Uk:"Config",Kq:"Challenge",expiration:"expiration",Xi:"TokenExpiration",method:"method",data:"data"},"GetAuthTokenRespObf")}x(Mh,S);var yh=new Mh;function Nh(){S.call(this,{list:"list",Error:"Error"},"GetAuthAllowListObf")}x(Nh,S);var zh=new Nh;function Oh(a){dh.call(this,a);this.v=Q.$s();this.h=Q.bt();this.j=Q.oc+Q.Ks;this.he("Family auth init.");Ph(this)}x(Oh,dh);k=Oh.prototype;k.he=function(a){dh.prototype.he.call(this,a);this.Me=Qh(this)};function Qh(a){var b;return J(function(c){switch(c.h){case 1:if(!Sc(a.i)){c.m(2);break}C(c,3);return y(c,Sb(a.i.policy),5);case 5:F(c,2);break;case 3:b=H(c),K.warn("family auth init() failed to query policy: "+b);case 2:if(Sc(a.i))return y(c,Rh(a),0);c.m(0)}})}
k.Mm=function(a){if("signOutUser"==a.type)this.debug&&K.log("sync signOutUser"),this.jd();else if("familySignInUserFromExt"==a.type&&99==Q.platform)this.debug&&K.log("sync signInUser: "+JSON.stringify(a.data)),a=a.data,ke(this.i.runtime,a.rd),this.i.H.sendMessage({type:"customerSignedIn"}),Sh(this,a.Z,a.oi,"sync sign-in");else if("policyChanged"==a.type&&(a=this.i.runtime.va()))if(vf(this.i.policy,a)){var b=wf(this.i.policy,a),c=this.i.runtime.env.username;b!=c&&(K.warn("User name changed from "+
c+" to "+b),this.i.H.sendMessage({type:"userSignedIn",data:{ae:Q.Fd,Pb:a,userName:b}}))}else K.error("User ID no longer exists, signing out user: "+a+", "+this.i.runtime.env.username),this.jd()};
k.ke=function(a,b){var c=this,d,e;return J(function(f){if(1==f.h)return d={credential:"password",username:a,password:b},y(f,c.getAuthToken(d),2);e=f.j;if(e.Error)throw Error(e.Error);var g=e;c.debug&&K.log("handle sign-in: "+JSON.stringify(g).substring(0,256));ke(c.i.runtime,g.Rk,g.Xi);c.i.H.sendMessage({type:"customerSignedIn"});Ph(c);try{Se(c.i.policy,g.Uk)}catch(h){K.error("auth: error parsing config file: "+h)}c.i.disabled||c.Qc||(c.debug&&K.log("invoking user auth procedure"),c.hb=!0);A(f)})};
function Sh(a,b,c,d){if(b&&Sc(a.i)&&vf(a.i.policy,b)){var e=wf(a.i.policy,b);if(12==Q.platform){var f={type:"sendUserInfoToProxy",data:{rd:a.i.runtime.getAuthToken(),Z:b,userName:e,Bu:c}};a.i.H.sendMessage(f);chrome.cookies.set({url:Q.xi,name:"auth.fam.userId",value:b},function(){})}c?a.i.s["auth.fam.userId"]=b:a.i.s.removeItem(["auth.fam.userId"]);a.Qc=!0;a.hb=!1;K.log("user signed in: "+e+": "+d);a.i.H.sendMessage({type:"userSignedIn",data:{ae:Q.Fd,Pb:b,userName:e}})}}
k.jd=function(){this.debug&&K.log("signOutUser");this.Qc=!1;this.hb=Sc(this.i);this.i.s.removeItem("auth.fam.userId");12==Q.platform&&(chrome.cookies.remove({url:Q.xi,name:"auth.fam.userId"}),this.i.H.sendMessage({type:"sendLogoutToProxy"}));this.i.H.sendMessage({type:"userSignedOut"})};k.wi=function(a){this.debug&&K.log("re-auth: "+a);this.jd();this.i.s.removeItem("home.conf");ke(this.i.runtime,void 0);this.he(a);this.i.H.sendMessage({type:"customerSignedOut"})};
function Ph(a){if(Sc(a.i)&&12==Q.platform)try{var b={authtoken:a.i.runtime.getAuthToken()};chrome.runtime.sendNativeMessage(Q.mu+".msghost",b)}catch(c){K.warn("sendAuthTokenToNative err "+c)}}
k.onMessage=function(a,b,c){var d=this,e=a&&a.data;if("authBackend"==a.recipient){if("isAuthNeeded"==a.type)return this.Me.then(function(){if(d.i.disabled)c&&c({Ia:!1});else if(d.Qc)c&&c({Ia:!1});else{var f={debug:d.debug,enabled:!0};if(!Sc(d.i))f={state:d.bm,Ia:!0,Cc:"home-customer",df:[],Ta:d.v,di:void 0,uy:d.h,debug:d.debug,enabled:!0,Au:!Q.Di};else if(d.hb){f.Ia=!0;var g=d.i.policy.Gc(),h=g.method;f.Cc=h;d.mb&&d.mb.ma.lk&&(f.Fh=d.mb.ma.lk);if(h==Q.Fd){f.Cc=Q.Fd;f.Ta=d.h;f.Lk=g.Lk;c&&c(f);return}"none"!=
h&&K.error("Unknown user auth method in policy: "+h);d.hb=!1;f.Ia=!1}c&&c(f)}}),!0;if("homeUser"==a.type)a=a.data,this.i.policy.xp(a.user,a.password)?(Sh(this,this.i.policy.va(a.user),a.oi,"interactive"),c({ok:!0})):c({error:"Invalid password. \n\nIf you forget your password, please ask your parent to reset your password on "+Q.fh+" parent portal."});else{if("anonAuthToken"==a.type)return this.debug&&K.log("anonAuthToken request received"),this.i.ob(),Th(this).then(function(f){f.error?c({error:f.error}):
c({ok:!0})}),!0;if("custUserPass"==a.type)return this.debug&&K.log("customer sign-in via user/pass received"),this.ke(e.user,e.pa).then(function(){c({ok:!0})}).catch(function(f){c({error:f})}),!0;dh.prototype.onMessage.call(this,a,b,c)}}};
function Th(a){var b,c,d,e;return J(function(f){if(1==f.h)return b={},c={version:"1.0",clientVersion:a.i.ob()},y(f,kh(a,a.o,c),2);d=f.j;a.debug&&K.log("anonAuthToken challengeRespAccepted="+JSON.stringify(d));if(!d||d.Error)return b.error=d.Error,f.return(b);e=U(yh,d);Sc(a.i)||ke(a.i.runtime,e.Rk,e.Xi);b.ok=!0;return f.return(b)})}
k.getAuthToken=function(a){var b=this,c,d,e,f,g;return J(function(h){if(1==h.h)return a.version||(a.version="1.0"),a.Xk=lh(b),c=Xa(Ah,a),y(h,kd(b.i.http,b.j,"POST",JSON.stringify(c),4E3),2);d=h.j;b.debug&&(e=JSON.parse(JSON.stringify(a)),e.password="***",K.log("getAuthToken req="+JSON.stringify(e)),K.log("getAuthToken respStr="+d));f=JSON.parse(d);g=U(yh,f);return h.return(g)})};
function Rh(a){var b,c;return J(function(d){if(1==d.h)return!Sc(a.i)||(b=a.i.runtime.va())&&vf(a.i.policy,b)?d.return():(b=a.i.s["auth.fam.userId"])&&vf(a.i.policy,b)?(Sh(a,b,!0,"remembered persistently"),d.return()):12!=Q.platform?d.m(2):y(d,Lc(),3);if(2!=d.h&&(b=d.j)&&vf(a.i.policy,b))return Sh(a,b,!1,"remembered by session"),d.return();if(c=xf(a.i.policy))return b=a.i.policy.va(c),Sh(a,b,!1,"single user no password"),d.return();(b=a.i.runtime.va())&&!vf(a.i.policy,b)&&(K.error("The current user ID is no longer valid per policy: "+
b+", "+a.i.runtime.env.username),a.jd());A(d)})}function Uh(a){Oh.call(this,a);this.l=Q.Fa+"/cloudAuthError.html"}x(Uh,Oh);k=Uh.prototype;k.save=function(){return{vp:!0,G:this.i.runtime.getAuthToken(),Z:this.i.runtime.va()}};k.ready=function(){return J(function(a){A(a)})};
k.restore=function(a){var b=this,c;return J(function(d){switch(d.h){case 1:if(!a.vp||!a.G){d.m(2);break}C(d,3);ke(b.i.runtime,a.G);b.Me=Sb(b.i.policy);return y(d,b.Me,5);case 5:b.Sd=void 0;if(!Sc(b.i))throw Error("Fam auth backend restore: invalid auth token: "+a.G);a.Z&&vf(b.i.policy,a.Z)&&Sh(b,a.Z,!1,"cloud restore");return d.return();case 3:c=H(d),K.warn("restore session failed: "+a.G+", "+a.Z+", "+c),a.Pj&&(b.Sd="Configuration error: unknown user ID: "+a.Z+". Please contact your IT administrator. ");
case 2:ke(b.i.runtime,void 0),b.he("Family cloud auth restore."),A(d)}})};k.onMessage=function(a,b,c){if("authBackend"==a.recipient)if("isAuthNeeded"==a.type)if(this.Sd)c({enabled:!0,Cc:"cloudError",Ia:!0,Ta:this.Xh()});else return Oh.prototype.onMessage.call(this,a,b,c);else return Oh.prototype.onMessage.call(this,a,b,c)};k.Xh=function(){return this.Sd?this.l+"?msg="+encodeURIComponent(this.Sd):void 0};function Vh(a){this.i=a;this.debug="true"===this.i.s["debug.uldt.debug"];this.u=this.i.u;this.C=this.i.C}
Vh.prototype.Sa=function(a,b,c){c=void 0===c?3:c;var d=this,e,f,g,h,l,m,n,q,u,r,p,v,w,z;return J(function(B){switch(B.h){case 1:if(d.i.disabled)return B.return();if(d.i.cv)return K.log("Upload disabled. q=",a,", data=",b),B.return();d.debug&&K.log("Upload data. q=",a,", data=",b);C(B,2);e=180;f=je(d.i.runtime);if(!f||f.startsWith("anon-")){K.warn("[UP] Generic upload: no auth token found.");B.m(4);break}g=b instanceof Array?b:[b];h=d.i.runtime.env;l=t(g);for(m=l.next();!m.done;m=l.next())n=m.value,
"object"==typeof n&&(n.ru=df(d.i.policy),n.Bs=d.i.ob(),n.deviceName=h.deviceName,n.platform=h.Oh,n.browser=h.browser,n.os=h.platform,n.device=h.device,n.Ng=h.Ng);g=g.map(function(D){return JSON.stringify(Xa(Wh,D))});q=Q.Gt+Te(d.i)+Q.bv;u={Version:"1.3",Auth:f,Envelope:{BrowserID:d.i.runtime.env.uuid},Objects:[{Queue:a,DataArray:g}]};u=JSON.stringify(u);case 5:if(!(0<c)){B.m(6);break}C(B,7);return y(B,md(d.i.http,q,"POST",u),9);case 9:if(r=B.j)try{if(p=JSON.parse(r).Events)v={type:"serverPushEvents",
data:{As:U(zb,p)}},d.i.H.sendMessage(v)}catch(D){K.error("Malformed gen upload response")}d.debug&&K.log("upload data done: "+b.type+"; resp="+r);return B.return(!0);case 7:w=H(B,2);c--;if(!(0<c)){B.m(5);break}K.warn("generic upload failed, retrying after "+e+" seconds. "+w);return y(B,new Promise(function(D){setTimeout(D,1E3*e)}),5);case 6:K.warn("[UP] Generic upload failed, giving up.");case 4:F(B,3);break;case 2:z=H(B),K.error("[UP] Upload data error: "+z);case 3:return B.return(!1)}})};
Vh.prototype.Ya=function(a){var b=this;try{setTimeout(function(){Qd(b,a)},0)}catch(c){K.error("["+this.u+"]["+this.C+"][USS] Upload system state error.",c)}};function Qd(a,b){var c,d,e;J(function(f){if(!a.i.runtime)return f.return();K.log("["+a.u+"]["+a.C+"][USS] System state message:",b);c="true"==ee(a.i.runtime,"auth.uploadSystemState");if(!c)return f.return();d={};Xb(a.i.runtime,d,!0);e={timestamp:Date.now(),type:"system",Qg:b,kv:d};a.Sa("misc",e);A(f)})}
function Xh(a,b){try{var c=new URL(b);c.hash="";b=c.toString()}catch(d){return K.warn("Parse url failed.",b),!1}a.h||(a.h={},a.i.setInterval(function(){a.h={}},6E4));return b?(b in a.h||(a.h[b]=0),a.h[b]+=1,3<a.h[b]):!1}
function Yh(a,b,c,d){function e(){if(q.policy&&q.policy.em){var u=q.policy.em();if(u){g.$l||(g.$l=[]);u=t(u);for(var r=u.next();!r.done;r=u.next()){var p=r.value;r=p[0];p=p[1];"fc"===p.type&&p.am.map(function(v){return+v}).includes(+g.T)&&g.$l.push(r)}}}}function f(){var u=this,r,p,v;return J(function(w){if(1==w.h){if(!b.map(function(z){return+z}).includes(105)||Array.isArray(g.W)&&0<g.W.filter(function(z){return"screenshot"===z.name}).length)return w.return();C(w,2);return y(w,Ng(u.i.ja.Xa),4)}if(2!=
w.h){r=w.j;if(!r)return w.return();g.W||(g.W=[]);p={name:"screenshot",value:r};g.W.push(p);return F(w,0)}v=H(w);K.error("reportViolation adult content screenshot capture failed.",v);A(w)})}var g,h,l,m,n,q;J(function(u){if(1==u.h){a.debug&&K.log("reportViolation. url=",c,", details=",d);if(Xh(a,c))return a.debug&&K.log("Filter out duplicated violation. url=",c),u.return();if("true"==a.i.s["debug.vio.noFeedback"])return u.return();d.F||(d.F="undefined");g={};g.timestamp=g.Tr=new Date;g.url=c;g.host=
(new URL(c)).hostname;g.domain=psl.get(g.host)||g.host;g.Rd=Rg(a.i.Aa,g.host);Zh(a.i.te,c);h=a.i.runtime.env;if(h.be){var r=h.be.split(".");g.tt=256*(256*(256*+r[0]+ +r[1])+ +r[2])+ +r[3]}h.ba&&(g.$j=h.ba.join(", "));Xb(a.i.runtime,g,!0);ae(a.i.runtime,g);h.bc&&(g.bc=h.bc);!0===h.xa&&(g.xa=!0);g.vg=b.toString();g.T=b[0];d||(d={});Object.assign(g,d);delete g.iconUrl;d.L||(K.warn(c+": missing detection engine, using cc as default"),g.L="cc");if(a.i.La){if(l=Ig(a.i.La))g.rj=l;if(m=Jg(a.i.La))g.sj=m}a.i.policy&&
a.i.policy.ze&&(n=a.i.policy.ze())&&(g.bb=n);q=a.i;e();return y(u,f.apply(a),2)}a.Sa(Q.rv,g);A(u)})}
function $h(){S.call(this,{pd:"Version",An:"Auth",Ov:"Envelope",Fv:"BrowserID",Vv:"Objects",$v:"Queue",Nv:"DataArray",Tr:"date",url:"url",host:"host",tt:"ipaddr",$j:"localIps",user:"user",Z:"userId",zj:"debugUserId",fk:"osDebugUserId",group:"group",groups:"groups",bc:"geoloc",Ct:"lat",Jt:"lon",xa:"isOffCampus",os:"os",platform:"platform",vg:"categories",T:"category",rj:"classroom",bb:"classUUID",sj:"clmTeacherId",iconUrl:"iconUrl",L:"engine",Bs:"extVer",context:"context",Ba:"pageTitle",ru:"policyTs",
zy:"screenShot",policy:"policy",lu:"overriddenByGOL",Fb:"dynTACats",Rd:"ccCats",F:"ruleName",X:"ruleSpec",wv:"youtubeRuleName",Qg:"msg",kv:"uss",digest:"digest",Xo:"errorCount",es:"discoverResults",$l:"fcAlertIds",dh:"taResult",nv:"vaResult",We:"videoSrc",ta:"sections",W:"attachments",name:"name",Da:"desc",value:"value",ht:"iaResult",Fc:"dataUrl",Jb:"imgElem",currentSrc:"currentSrc",oa:"conclusive",src:"src",style:"style",filter:"filter",border:"border",text:"text",V:"prob",Mf:"probs",tj:"cloudResult",
ni:"regexResult",time:"time",label:"label",id:"id",lang:"lang",error:"error",Ua:"cats",Fp:"modelVersion",pb:"subCategories",yb:"subCategoryInfo",Vs:"gmResult",mt:"imageProb",rt:"inputProb",st:"inputStats",tc:"eventType",Af:"imageBlurredInfo",images:"images",Ve:"videoBlurredInfo",from:"from",oe:"to",td:"cat",duration:"duration",pv:"videoStats",zi:"totalDuration",qx:"gameData",details:"details",Gs:"gameInputStats",key:"key",N:"stats",Vx:"mousedown",Wx:"mousemove",elapsedTime:"elapsedTime",domain:"domain",
startTime:"startTime",timestamp:"timestamp",uv:"youtubeID",Be:"imageBlurred",Ue:"videoBlurred",tg:"catId",title:"title",recipient:"recipient",Ma:"envelope",userAgent:"userAgent",deviceName:"deviceName",device:"device",qr:"assetId",deviceId:"deviceId",nr:"annotatedLocation",serialNumber:"serialNumber",data:"data",yj:"debugInfo",Vd:"dta",hv:"userProfile",gv:"userContent",Pt:"medias",Lr:"comments",tu:"postedByOwner",mv:"utime",sv:"violationVideo",Cr:"bullyContent",Xf:"wellnessInfo",search:"search",frameUrl:"frameUrl",
na:"trigger",Xm:"riskLevel",Qe:"subject",Of:"recipients",body:"body",Eh:"bodyHtml",type:"type",version:"version",Hf:"nAnalyzed",Im:"nWhite",Fm:"nExplicit",Gm:"nImmodest",Hm:"nSuggestive",hs:"dld",Gh:"cloud",Hs:"gcv",cy:"nTotal",gd:"nCloudQueries",Yx:"nBlackCloudQueries",ir:"adData",yu:"refDomains",event:"event",Zm:"rtcStats",R:"teacherId",address:"address",to:"candidates",protocol:"protocol",port:"port",qo:"bwstats",total:"total",Dp:"mbytes",Pu:"snippet",kc:"terms",proxy:"proxy",uj:"connType",zu:"relayProtocol",
Ym:"rtcIpHandle",Ng:"isadmin",bq:"screenMode",Co:"connMode",xt:"isInbound",className:"className",mode:"mode",message:"message",Ck:"tConnId",Po:"durationSec",hk:"pingLatencies"},"GenUploadReqObf",!0,!0)}x($h,S);var Wh=new $h;function ai(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.ytf.debug"];this.o=Q.Yb+Te(this.i)+"/GetYTMetaData?plat="+this.i.runtime.env.platform;this.j=function(){S.call(this,{version:"version",error:"error",data:"data",title:"title",channelId:"channelId",Mw:"channelTitle",Jw:"categoryId",T:"category",tags:"tags",description:"description"},"getYTMetaDataObf")};x(this.j,S);this.l=new this.j;this.h={};this.Yf=[new Bd(this.debug,void 0,void 0)];this.Fi=new Bd(this.debug,void 0,void 0);this.i.addListener(function(c,
d,e){if("youtubeMetaProcess"==c.recipient)return b.onMessage(c,d,function(f){b.debug&&K.log("[YTF] On message. msg=",c,", result=",f);e&&e(f)})});this.debug&&K.log("[YTF] YT backend started.")}
function lf(a,b){try{var c=new URL(b),d=c.searchParams,e;if("/watch"==c.pathname){var f=d.get("v");if(!f)throw Error("no video id found");(e=a.h[f])||(e={ld:f})}else if(c.pathname.startsWith("/channel/"))e={channelId:c.pathname.substr(9)};else if(c.pathname.startsWith("/embed/")){var g=c.pathname.substring(7);if(!g)throw Error("no video id found");(e=a.h[g])||(e={ld:g})}else return{state:Q.Qa};return bi(a,e,b)}catch(h){return K.error("[YTF] Classify Youtube url ("+b+") error.",h),{state:Q.Qa}}}
function bi(a,b,c){var d={state:Q.Qa,da:[],la:void 0,F:a.i.policy.Ib(),qa:void 0},e=Fd(a.Fi,b);e.state!==Q.Qa&&(d.la="parent",d.state=e.state,d.qa=e.qa);if(d.state===Q.Qa){var f=a.i.policy.Gl(c);void 0!=f&&(d.la="teacher",d.state=Q.ea,d.qa="url "+f)}if(d.state===Q.Qa)for(f=t(a.Yf),e=f.next();!e.done;e=f.next())if(e=Fd(e.value,b),e.state!==Q.Qa){d.la=Q.Kg()?"parent":"school";d.state=e.state;d.qa=e.qa;break}if(d.state===Q.Qa){b=a.i.policy.rb(c,void 0,!1);d.la=b.la;d.da=b.da;d.Ag=b.Ag;d.da||(d.da=[]);
d.state=b.ab;d.state!==Q.Qa&&(d.qa="url "+(b.Bi||""),b.F&&(d.F=b.F));if(b.ab===Q.Pa||0<d.da.length)d.state=Q.Pa;a.debug&&K.log("[YTF] URL ("+c+") decided.",d)}else a.debug&&K.log("[YTF] URL ("+c+") decided by meta.",d);d.state!==Q.Pa||d.da&&0!==d.da.length||(d.da=[Q.Vb],a.debug&&K.log("[YTF] URL ("+c+") decided by blacklist.",d));return d}
function ci(a,b){var c,d,e,f;return J(function(g){if(1==g.h){if(a.h[b])return g.m(2);c=a.o;d={version:"1.0",auth:a.i.runtime.getAuthToken(),videoId:b};e=d.auth?md(a.i.http,c,"POST",JSON.stringify(d)):Promise.reject("No auth token");return y(g,e,3)}if(2!=g.h){f=g.j;f=U(a.l,JSON.parse(f));a.debug&&K.log("[YTF] Get metadata from server. resp=",f);if(f.error)throw K.warn("[YTF] /GetYTMetaData. videoId="+b+". resp.error=",f.error),b+":"+f.error;f.data.ld=b;a.h[b]=f.data}return g.return(a.h[b])})}
ai.prototype.onMessage=function(a,b,c){var d=this;if("youtubeMetaProcess"==a.recipient&&"checkBlackWhiteList"==a.type)return function(){var e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R;return J(function(N){switch(N.h){case 1:e=a.data.vv;f=a.data.source;if(e.error){K.error("[YTF] Check black white list. youtubeMeta.error=",e.error);N.m(2);break}if(!e.ld){N.m(2);break}g=Dd(d.Fi,e);h=t(d.Yf);for(l=h.next();!l.done;l=h.next())if(m=l.value,Dd(m,e)){g=!0;break}if(!g){N.m(2);break}d.debug&&K.log("[YTF] Need more metadata from server: "+
Object.keys(e).join(","));C(N,5);return y(N,ci(d,e.ld),7);case 7:e=N.j;f="api";F(N,2);break;case 5:n=H(N),K.warn("[YTF] /GetYTMetaData error.",n);case 2:q=a.data.url;u=a.data.title;r=a.data.pu;d.debug&&(p={title:"title",T:"category",channelId:"channelId",ld:"videoId"},v=Object.keys(p).map(function(Y){return p[Y]+": "+e[Y]}).join(", "),d.debug&&K.log("[YTF] "+f+" metadata for "+q.substr(0,256)+" is "+v));he(d.i.policy);r&&r!=q&&(z=d.i.policy.rb(r),z.ab===Q.ea&&(w={state:Q.ea,da:[],la:void 0,F:z.F?
z.F:d.i.policy.Ib(),qa:void 0}));w||(w=bi(d,e,q));w.qa&&(w.state==Q.ea?B="youtube "+w.qa+" is in allowed list":w.state==Q.Pa&&(B="youtube "+w.qa+" is in blocked list"));w.state==Q.Pa&&(D={L:"yf",context:"main_frame",Ba:u,policy:w.policy,F:w.F,wv:w.qa,X:B},Yh(d.i.I,w.da,q,D),d.i.policy.Zg(q,u));M=!1;E=w.state==Q.ea?"white":w.state==Q.Pa?"black":"default";try{T=w.da.map(function(Y){return jf(d.i.Aa,Y)}).join(","),O=new URL(q),O.pathname.startsWith("/embed/")&&(M=!0),w.state!=Q.Pa?G="about:blank":("Blacklist"==
T&&B&&(T=B),G=d.i.policy.uf(q,u,T,w.da,!0,w.la))}catch(Y){}R={type:E,data:{yn:q,url:G,qa:w.qa,X:B,F:w.F,ut:M,metadata:e}};return N.return(R)}})}().then(function(e){c(e)}).catch(function(e){c({error:e.toString()})}),!0};ai.prototype.fd=function(){var a=he(this.i.policy);return{Du:a&&a.setting&&a.setting.ge}};function di(a){this.i=a;try{this.debug="true"==this.i.s["debug.cnf.debug"],this.J=this.i.s["debug.cnf.cacheExpiration"],this.ga="true"==this.i.s["debug.cnf.discardExpiredCache"],this.S="1.3",this.v="1.2",this.D=Q.Yb+Te(this.i)+Q.Hr,this.initial()}catch(b){K.error("[CNF] ERROR in CloudFilteringEngine constructor: "+b)}}var ei,fi;
di.prototype.initial=function(){var a;try{this.i.s["debug.cnf.idNameMapVer"]!=this.S?a=void 0:a=U(gi,JSON.parse(this.i.s.catIdNameMap))}catch(c){a=void 0}a||(hi(this),a=[{P:0,O:"Unclassified"},{P:1,O:"Test"},{P:2,O:"Blocked list"},{P:3,O:"Reserved"},{P:4,O:"White"},{P:20,O:"Business"},{P:21,O:"Education"},{P:22,O:"Reference"},{P:23,O:"Entertainment"},{P:24,O:"News and media"},{P:25,O:"Government"},{P:26,O:"Military"},{P:27,O:"Political organizations"},{P:28,O:"Health"},{P:29,O:"Information technology"},
{P:30,O:"Search engines and portals"},{P:31,O:"Religion"},{P:32,O:"Shopping"},{P:34,O:"Real estate"},{P:35,O:"Society and lifestyles"},{P:36,O:"Brokerage and trading"},{P:37,O:"Sports"},{P:38,O:"Sports hunting and gun clubs"},{P:39,O:"Personal web sites and blogs"},{P:40,O:"Emails"},{P:41,O:"Content servers"},{P:42,O:"Streaming media and download"},{P:43,O:"File sharing and storage"},{P:44,O:"Travel"},{P:45,O:"Vehicles"},{P:46,O:"Finance and banking"},{P:47,O:"Parked domain"},{P:51,O:"Proxy and VPN services"},
{P:53,O:"Generative AI"},{P:90,O:"Advertisement"},{P:101,O:"Abortion"},{P:102,O:"Reserved"},{P:103,O:"Intimate apparel and swimsuit"},{P:104,O:"Nudity"},{P:105,O:"Adult content"},{P:106,O:"Sex education"},{P:107,O:"Drugs"},{P:108,O:"Marijuana"},{P:109,O:"Gambling"},{P:110,O:"Illegal or questionable"},{P:111,O:"Cult and extremist groups"},{P:112,O:"Alcohol and tobacco"},{P:113,O:"Sexuality"},{P:114,O:"Tasteless"},{P:115,O:"Violence"},{P:116,O:"Dating"},{P:117,O:"Social networking"},{P:118,O:"Games"},
{P:119,O:"Weapons"},{P:120,O:"Self-harm"},{P:121,O:"Educational games"}]);this.h=[];a=t(a);for(var b=a.next();!b.done;b=a.next())b=b.value,this.h[b.P]=b.O;88==Q.platform?(ei=function(c){this.h=new nodeMods.LRU(c)},ei.prototype.setItem=function(c,d,e){var f;e&&e.$o&&(f=e.$o-Date.now());this.h.set(c,d,f)},ei.prototype.getItem=function(c){return this.h.get(c)},ei.prototype.clear=function(){this.h.reset()}):ei=function(){};fi||(88==Q.platform?fi=new ei(4E3):fi=new DLDCache(1800,!1,new DLDCache.LocalStorageCacheStorage("default",
this.i.s)));this.cache=fi;88==Q.platform||this.i.s.ccCacheVersion&&"1.1"==this.i.s.ccCacheVersion&&"true"!=this.i.s["debug.cnf.clearCache"]||(this.cache.clear(),this.i.s.ccCacheVersion="1.1",delete this.i.s.QSLTimestamp);this.Ej=88!=Q.platform?new DLDCache(200):new ei(200);"true"!=this.i.s["debug.cnf.skipQSL"]&&ii(this);ji(this);this.l={};this.j={bu:0,gd:0,$t:0,Rm:[]}};
function Mg(a,b,c,d){c&&!Array.isArray(c)&&(K.error("[CNF] addDynUrl cats not an array: "+c+", "+b),c=[c]);a.Ej.setItem(b,{Ua:c,details:d},{$o:new Date(Date.now()+3E5)})}
function ki(a,b,c){var d=c.vh,e=0;c.Tc&&!Array.isArray(c.Tc)&&(K.error("[CNF] setCacheItem cats not an array: "+c.Tc+", "+c.od),c.Tc=[c.Tc]);a.J&&(d=a.J);d&&(e=Number.parseInt(d),e=Number.isNaN(e)?0:d.endsWith("s")?Date.now()+1E3*e:d.endsWith("m")?Date.now()+6E4*e:d.endsWith("h")?Date.now()+36E5*e:d.endsWith("d")?Date.now()+864E5*e:1E3*e);e<=Date.now()&&(e=Date.now()+1E3*Q.Ql);a.cache.setItem(b,{value:c,expires:e})}
function kf(a,b){a.j.bu++;try{var c=Lg(a.i.Np,b);if(c)return a.debug&&K.log("[CNF] Override list matches for",b,". Cats ID:",c),c;var d=a.Ej.getItem(b);if(d)return d.Ua;var e=new URL(b);return Rg(a,e.hostname)}catch(f){return K.error("[CNF] Exception getting cats id by url from cache.",f),[Q.Zr]}}
function Rg(a,b){if(a.i.disabled)return[];b=b.toLowerCase();var c=psl.get(b);c||(c=b);if(c==Q.Eb)return[0];a:{var d={".adult":105,".porn":105,".sex":105,".sexy":105,".xxx":105,".dating":116,".date":116,".love":116,".game":118,".games":118,".lgbt":113};for(var e in d)if(b.endsWith(e)){d=d[e];break a}d=null}if(d)return[d];c=a.cache.getItem(c);if(!c)return null;d=null;e=c.value;if(e.Wi){var f=null,g;for(g in e.Wi)b.endsWith(g)&&(!f||g.length>f.length)&&(f=g);f&&(d=e.Wi[f])}d||(d=e.Tc);if(Date.now()>
c.expires){if(a.ga)return null;a.debug&&K.log("[CNF] cache item expired, reloading: "+b);li(a,"http://"+b+"/")}return d}
function li(a,b,c){var d=(new URL(b)).hostname.toLowerCase(),e=psl.get(d);e||(K.warn("[CNF] Null root domain for "+b),e=d);a.l[e]?a.debug&&K.log("[CNF] Reusing existing query for "+b):(a.debug&&K.log("[CNF] Sending new query for "+b),b=mi(a,e,c),b.then(function(){a.debug&&K.log("[CNF] Removing "+e+" from pending queries");delete a.l[e]},function(){a.debug&&K.log("[CNF] Removing "+e+" from pending queries");delete a.l[e]}),a.l[e]=b);return a.l[e]}
function mi(a,b,c){a.j.gd++;var d=Date.now(),e={version:a.v,G:a.i.runtime.getAuthToken(),gt:[b]};a.debug&&K.log("[CNF] Query CC by host. Url=",a.D,", param=",e);e=e.G?md(a.i.http,a.D,"POST",JSON.stringify(Xa(ni,e))):Promise.reject("No auth token");if(c){var f=new Promise(function(g){setTimeout(function(){g(null)},c)});e=Promise.all([e,f])}return e.then(function(g){g=Array.isArray(g)?g[0]?g[0]:g[1]:g;var h=U(gi,JSON.parse(g));a.debug&&K.log("[CNF] Query CC by host response=",h);var l=Date.now()-d;
a.j.Rm.push(l);1E3<a.j.Rm.length&&a.j.Rm.shift();a.debug&&K.log("[CNF] query response received: "+b+", "+g+" "+l+"ms");return oi(a,h,b)},function(g){K.warn("[CNF] CC query of "+b+" failed: "+g);a.j.$t++;return Promise.reject(g)})}
function oi(a,b,c){var d=psl.get(c);d||(K.warn("[CNF] ERROR: can't get root domain for: "+c),d=c);if(null==b||0==b.length||b.pd!=a.v){if(c=Rg(a,c))return c;ki(a,d,{od:d,Tc:[],vh:Q.$r+"s"});return[]}if(null==b.Wk||0==b.Wk.length)return ki(a,d,{od:d,Tc:[],vh:Q.Ql+"s"}),[];d=t(b.Wk);for(b=d.next();!b.done;b=d.next()){b=b.value;var e=psl.get(b.od);e||(e=b.od);e!=b.od&&K.error("[CNF] Root domain names mismatch between cloud and local: "+b.od+" => "+e);b.Tc||(b.Tc=[],b.vh=Q.Ql+"s");ki(a,e,b)}if(a=Rg(a,
c))return a;K.error("[CNF] Category info is not in cache after CC response: "+c);return[]}
function hi(a){var b,c,d;J(function(e){switch(e.h){case 1:b=function(){var f,g,h,l,m,n,q;return J(function(u){if(1==u.h){if(!a.i.runtime.getAuthToken())throw Error("no auth token");f={version:"1.2"};f.G=a.i.runtime.getAuthToken();g=Q.Yb+Te(a.i)+Q.Ir;K.log("[CNF] Getting category ID-name mapping from server");return y(u,md(a.i.http,g,"POST",JSON.stringify(Xa(ni,f))),2)}h=u.j;l=U(gi,JSON.parse(h));if(!l)throw K.warn("[CNF] Failed to create category ID-name mapping: "+h),Error("invalid response");l=
l.Jq;a.h=[];m=t(l);for(n=m.next();!n.done;n=m.next())q=n.value,a.h[q.P]=q.O;a.i.s.catIdNameMap=JSON.stringify(Xa(gi,l));a.i.s["debug.cnf.idNameMapVer"]=a.S;A(u)})},c={};case 2:if(a.i.Yc){e.m(0);break}C(e,4);return y(e,b(),6);case 6:e.m(0);break;case 4:d=H(e);K.warn("[CNF] Error getting cat ID-name mapping: "+d);if("no auth token"==d.message){a.o||(K.warn("[CNF] Wait until user/customer signs in to retry ..."),a.o=!0,a.aa||(c.sh=!1,a.i.H.addListener(function(f){return function(g){var h;return J(function(l){switch(l.h){case 1:if(!a.o||
f.sh){l.m(0);break}K.log("[CNF] Get cat-ID mapping on "+g.type+" event ...");f.sh=!0;C(l,3,4);return y(l,b(),6);case 6:a.o=!1;case 4:va(l);f.sh=!1;wa(l,0);break;case 3:h=H(l),K.warn("[CNF] Error getting cat ID-name mapping: "+h),l.m(4)}})}}(c),["postUserSignedIn","customerSignedIn"]),a.aa=!0));e.m(0);break}return y(e,new Promise(function(f){setTimeout(f,6E4)}),5);case 5:c={sh:c.sh},e.m(2)}})}
function pi(a){var b,c,d;return J(function(e){if(1==e.h){if(!a.i.runtime.getAuthToken())throw Error("no auth token");b={version:"1.0",G:a.i.runtime.getAuthToken(),force:!1};c=Q.Yb+Te(a.i)+"/GetCustomDefinition";a.debug&&K.log("[CNF] Get custom definition.",c);return y(e,md(a.i.http,c,"POST",JSON.stringify(Xa(ni,b))),2)}if(d=e.j)if(d=U(qi,JSON.parse(d)))if(d.error)K.error("[CNF] Error response when getting custom definition.",d.error);else if(d.Nl)return a.debug&&K.log("[CNF] Got custom definition.",
d.Nl),e.return(d.Nl);K.warn("[CNF] Failed to get custom definition.",d);throw Error("invalid response");})}
function ji(a){var b,c,d,e;J(function(f){switch(f.h){case 1:b=3,c=!1;case 2:if(a.i.Yc||a.i.disabled){f.m(0);break}C(f,4);return y(f,pi(a),6);case 6:if(d=f.j)ri(a,d),c=!0,a.i.H.sendMessage({type:"customDefinitionChanged"});F(f,5);break;case 4:e=H(f),K.error("[CNF] Error getting custom definition.",e);case 5:return b=c?3600:Math.min(2*b,300),a.debug&&K.log("[CNF] Re-get custom definition in "+b+" seconds."),y(f,new Promise(function(g){setTimeout(g,1E3*b)}),2)}})}
function ri(a,b){try{a.vd=[];for(var c=t(b.vd.apply),d=c.next();!d.done;d=c.next()){var e=b.vd.definition[d.value];e&&a.vd.push(e)}a.debug&&K.log("[CNF] Parsed classify regex.",a.vd)}catch(f){K.log("[CNF] Parse custom definition error.",f)}}
function ii(a){var b,c,d;J(function(e){if(1==e.h){b=function(){var f,g,h,l,m,n,q,u;return J(function(r){if(1==r.h){if(!a.i.runtime.getAuthToken())throw Error("no auth token");f={version:"1.2",G:a.i.runtime.getAuthToken()};g=Q.Yb+Te(a.i)+Q.Qs;K.log("[CNF] Getting quick start list from server: "+(new Date).toISOString());return y(r,md(a.i.http,g,"POST",JSON.stringify(Xa(ni,f))),2)}h=r.j;l=U(si,JSON.parse(h));if(!l)throw K.warn("[CNF] Failed to get quick start list: "+h),Error("invalid response");if(m=
l.Zq)for(n=t(m),q=n.next();!q.done;q=n.next())u=q.value,u.od&&ki(a,u.od,u);a.i.s.QSLTimestamp=Date.now();A(r)})};if(a.i.s.QSLTimestamp)return e.m(0);C(e,3);return y(e,b(),5)}if(3!=e.h)return F(e,0);c=H(e);K.warn("[CNF] Cannot get QSL: "+c);"no auth token"==c.message?(d=!1,a.ya||a.i.H.addListener(function(f){var g;return J(function(h){if(1==h.h){if(a.i.s.QSLTimestamp||d)return h.m(0);K.log("[CNF] Get QSL on "+f.type+" event ...");d=!0;C(h,3,4);return y(h,b(),4)}if(3!=h.h)return va(h),d=!1,wa(h,0);
g=H(h);K.warn("[CNF] Get QSL error: "+g);return h.m(4)})},["postUserSignedIn","customerSignedIn"])):K.warn("[CNF] Get QSL error: "+c);A(e)})}function jf(a,b){return a.h&&a.h[b]?a.h[b]:(K.warn("[CNF] Category ID "+b+" not found, reload mapping from server"),hi(a),b.toString())}function ti(){S.call(this,{version:"version",G:"auth",gt:"hostlist",force:"force"},"GetCatReqObf")}x(ti,S);var ni=new ti;
function ui(){S.call(this,{pd:"Version",Wk:"DomainCategoryList",O:"Name",An:"Auth",Jq:"CategoryList",P:"CatId",od:"Domain",Tc:"Cats",vh:"Exp",Wi:"Sub"},"GetCatRespObf",!0,!0)}x(ui,S);var gi=new ui;function vi(){S.call(this,{Zq:"QuickStartList",od:"Domain",Wi:"Sub",Tc:"Cats",vh:"Exp",pd:"Version",An:"Auth"},"GetQuickStartListRespObf",!0,!0)}x(vi,S);var si=new vi;
function wi(){S.call(this,{Nl:"customDefinitions",vd:"classifyRegex",definition:"definition",apply:"apply",Kf:"patterns",label:"label",Dj:"distinctCount",cn:"searchEngineOnly",version:"version",error:"error"},"GetCustomDefinitionRespObf",!0,!0)}x(wi,S);var qi=new wi;function xi(a){this.h=a;(this.o="undefined"!=typeof chrome&&chrome.i18n&&chrome.i18n.detectLanguage)&&K.log("Found native support of browser.i18n.detectLanguage")}k=xi.prototype;k.Nj=function(){return["en"]};
k.detectLanguage=function(a){var b=this,c,d,e,f,g,h;return J(function(l){if(1==l.h)return b.o?y(l,new Promise(function(m){chrome.i18n.detectLanguage(a,function(n){m(n)})}),3):l.return(new Promise(function(m){guessLanguage.detect(a,function(n){b.h&&b.h.debug&&K.log("[DTA][Abstract] Guessed language is:",n);m(n)})}));c=l.j;e=-1;f=t(c.languages);for(g=f.next();!g.done;g=f.next())h=g.value,h.percentage>e&&(e=h.percentage,d=h.language);!c.isReliable&&50>e&&(d="unknown");b.h&&b.h.debug&&K.log("[DTA] Chrome guessed language is:",
d,c);return l.return(d)})};k.ud=function(a,b){var c=this,d,e;return J(function(f){if(1==f.h)return d=Date.now(),y(f,c.se(a,b),2);if(e=f.j)e.time=Date.now()-d;return f.return(e)})};
k.sd=function(a){var b=this,c,d,e,f,g,h,l;return J(function(m){if(1==m.h){c=Date.now();d=[];e={results:[]};for(f={ag:0};f.ag<a.length;f={ag:f.ag},f.ag++)g=a[f.ag],h=g.text,l=g.options,d.push(b.se(h,l).catch(function(n){return{error:n}}).then(function(n){return function(q){e.results[n.ag]=q}}(f)));return y(m,Promise.all(d),2)}e.time=Date.now()-c;return m.return(e)})};k.se=function(){return J(function(){throw Error("_classify() not implemented on abstract class");})};
function yi(a){xi.call(this,a);this.l={unknown:0,white:4,adult:105,games:118,gambling:109,lingerie:103,alcohol:112,cult:111,dating:116,drugs:107,illegal:110,parked:47,sexeducation:106,violence:115,weapons:119,lgbt:113,pro_abortion:101,self_harm:120,streaming_download:42,proxy_and_vpn:51}}x(yi,xi);yi.prototype.ud=function(a,b){var c=this,d;return J(function(e){if(1==e.h)return y(e,xi.prototype.ud.call(c,a,b),2);d=e.j;!d.Ua&&d.label&&(d.Ua=d.label.map(function(f){return c.l[f]}));return e.return(d)})};
yi.prototype.sd=function(a,b){var c=this,d,e,f,g;return J(function(h){if(1==h.h)return y(h,xi.prototype.sd.call(c,a,b),2);d=h.j;if(!d.error)for(e=t(d.results),f=e.next();!f.done;f=e.next())g=f.value,!g.Ua&&g.label&&(g.Ua=g.label.map(function(l){return c.l[l]}));return h.return(d)})};function zi(a,b){yi.call(this,b);this.j=["en","zh"];this.i=a;this.v=Q.Yu+Te(this.i)+Q.At}x(zi,yi);zi.prototype.Nj=function(){return this.j};
zi.prototype.sd=function(a,b){var c=this,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D;return J(function(E){if(1==E.h){d=c.v;e=[];if(b.wb&&1<b.wb&&(e.push("ta-seqOnPage="+b.wb),b.url))try{f=new URL(b.url),e.push("ta-site="+f.hostname)}catch(G){}b.If&&e.push("ta-lang="+b.If);0<e.length&&(d+="?"+e.join("&"));g=Date.now();h={version:"1.2",G:c.i.runtime.getAuthToken(),Wu:a,url:b.url,sensitivity:b.sensitivity,context:b.context};l=Math.floor(1E3*Math.random());c.h&&c.h.debug&&K.log("[DTA]["+l+"] CloudTAEngine batch classify request to url ("+
d+"):",h);m=h.G?md(c.i.http,d,"POST",JSON.stringify(Xa(Ai,h))):Promise.reject("No auth token");return y(E,m,2)}n=E.j;n=U(Bi,JSON.parse(n));c.h&&c.h.debug&&K.log("[DTA]["+l+"] CloudTAEngine batch classify response:",n);q={results:[]};if(!n.Error&&n.el)for(u=0;u<n.el.length;u++){r=n.el[u];p=a[u].text;v=void 0;if((w=r.Cn)&&0!=w.length){z=0;for(B=1;B<w.length;B++)w[B].Vi>w[z].Vi&&(z=B);D=[51,119,115,110,113,118,120,121,111,103,106,105,101,109,112,107,116];v={label:[w[z].zh],Ua:[w[z].Hn],lang:a[u].If||
"en",V:w[z].Vi,tj:!0,text:p,Fp:r.Vq,oa:D.includes(w[z].Hn)};r.In&&(v.debug=JSON.stringify(r.In));b.nt&&(v.ry=r.Cn)}else v={error:"Empty categories array!"};q.results.push(v)}else q={error:n.Error||"No TA results received"};q.time=Date.now()-g;return E.return(q)})};
zi.prototype.se=function(a,b){b=void 0===b?{}:b;var c=this,d,e,f,g,h;return J(function(l){switch(l.h){case 1:if(!a||100>a.length)return l.return({label:["unknown"],text:a,oa:!0});if(d=b.lang){l.m(2);break}return y(l,new Promise(function(m){guessLanguage.detect(a,function(n){c.h&&c.h.debug&&K.log("[DTA][Cloud] Guessed language is:",n);m(n)})}),3);case 3:d=l.j;case 2:if(!c.j.includes(d))return l.return({lang:d,text:a,label:["unknown"],oa:!0});e={text:a,lang:b.lang,If:b.If,ji:c.j.includes(b.If)?void 0:
b.ji};C(l,4);return y(l,c.sd([e],b),6);case 6:f=l.j;c.h&&c.h.debug&&K.log("[DTA] CloudTAEngine classify results=",f);if(f.error)return l.return({error:f.error});g=f.results[0];g.time=f.time;return l.return(g);case 4:return h=H(l),l.return({error:String(h)})}})};function Ci(a,b){xi.call(this,b);this.l=a;this.j=void 0}x(Ci,xi);Ci.prototype.sd=function(a,b){var c=this;return J(function(d){return d.return(c.l.sd(a,b))})};
function Di(a,b,c){try{var d=(new URL(c.url)).hostname}catch(e){}a="https://cc."+Q.Eb+"/TranslateStats?gt-js="+a+"&gt-len="+b.length+"&gt-url="+encodeURIComponent(c.url);c.wb&&(a+="&gt-seq="+c.wb);d&&(a+="&gt-host="+d);fetch(a).catch(function(){})}
Ci.prototype.se=function(a,b){b=void 0===b?{}:b;var c=this,d,e,f,g,h;return J(function(l){switch(l.h){case 1:return d="",y(l,c.detectLanguage(a),2);case 2:e=l.j;"unknown"==e&&100>a.length&&(e="en");if(c.l.Nj().includes(e)){l.m(3);break}Di(e,a,b);f=1==b.wb%5&&(!c.j||5E3<=Date.now()-c.j);if(!f){l.m(4);break}return y(l,Ei(e,a),5);case 5:g=l.j,e=g.lang,d=g.ps,c.h&&c.h.debug&&K.log("[DTA][Translation] Detected language is:",e),g.xs&&(c.j=Date.now());case 4:b.If=e,b.ji=a;case 3:return h=d||a,b.lang=d?"en":
e,l.return(c.l.se(h,b))}})};
function Ei(a,b){var c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E;return J(function(G){switch(G.h){case 1:c="";d=!1;"unknown"==a&&(a="");e="https://translate.googleapis.com/translate_a/single?client=gtx&sl="+(a||"auto")+"&tl=en&dt=t&q=";f=[];g=b;for(h=0;1>f.length&&h<b.length;){for(;;){l=Q.Ic?Buffer.from(g).length:(new Blob([g])).size;if(5E3>l)break;g=g.substring(0,Math.floor(5E3*g.length/l)-1)}f.push(g);h+=g.length;g=b.substring(h)}m=t(f);n=m.next();case 2:if(n.done){G.m(4);break}q=n.value;C(G,5);u=e+encodeURIComponent(q);
return y(G,fetch(u),7);case 7:r=G.j;if(200!=r.status)throw Error(r.status+" "+r.statusText);return y(G,r.json(),8);case 8:p=G.j;v=p[0];w=p[2];a||(a=w);z=t(v);for(B=z.next();!B.done;B=z.next())D=B.value,c+=" "+D[0];F(G,3);break;case 5:E=H(G);K.error("translate: "+E);d=!0;G.m(4);break;case 3:n=m.next();G.m(2);break;case 4:return c&&20480<c.length&&(c=c.substr(0,20480)),G.return({lang:a,ps:c,xs:d})}})}
function Fi(a,b){yi.call(this,b);var c=this;this.i=a;this.vd=[{Kf:["\\bYour calculations and results appear here\\b.*\\bsearch for any mathematical expression\\b"],label:"unknown",cn:!0},{Kf:["crisis\\s?text\\s?line.*741741|741741.*crisis\\s?text\\s?line|988.*suicide\\s?and\\s?crisis\\s?lifeline|suicide\\s?and\\s?crisis\\s?lifeline.*988|988.*suicide\\s?&\\s?crisis\\s?lifeline|suicide\\s?&\\s?crisis\\s?lifeline.*988","\\bSAMHSA's National Helpline\\b.*?\\bhttps://www\\.samhsa\\.gov\\b"],label:"self_harm",
cn:!0},{Kf:"(convert|download)\\s+(\\S+\\s+){,2}(videos?\\s+(of|from)\\s+)?(youtube|youtube\\s+playlist|facebook|twitter|vimeo|dailymotion|tiktok|instagram)\\s+(videos?\\s+)?(to|as|in)\\s+(mp4|mp3|wav|ogg) (youtube|youtube\\s+playlist|facebook|twitter|vimeo|dailymotion|tiktok|instagram)\\s+(to\\s+)?(mp4|mp3|wav|ogg)\\s+(downloader|converter|downloaders|converters) (youtube|youtube\\s+playlist|facebook|twitter|vimeo|dailymotion|tiktok|instagram)\\s+to\\s+(mp4|mp3|wav|ogg) (youtube|youtube\\s+playlist|facebook|twitter|vimeo|dailymotion|tiktok|instagram|video|music|live\\s+stream)\\s+downloader (downloader|converter)\\s+for\\s+(youtube|facebook|twitter|vimeo|dailymotion|tiktok|instagram) download\\s+(mp4|mp3|wav|ogg)\\s+from\\s+(youtube|facebook|twitter|vimeo|dailymotion|tiktok|instagram) (downloader|converter)\\s+streaming\\s+videos?\\s+from\\s+(social\\s+web\\s?sites?|many\\s+popular\\s+streaming\\s+sites?|the\\s+web|any\\s+websites?)".split(" "),
label:"streaming_download"},{Kf:["shop\\.rammerhead\\.org.*Rammerhead version.*view Rammerhead changelog","rh :// welcome.*Rammerhead Browser is the new way.*rh://settings","\\bInter\\s?stellar\\b.*Search with .* or enter address","\\butopia\\b.*press any key to hide this from your history","\\butopia dive into the web\\b.*this link will not work"],label:"proxy_and_vpn"},{Kf:["\\bArt Class\\b.*\\bLaunch in about:blank\\b.*/uv/uv\\.config\\.js","\\b(Shuttle (Logo )?URL Or Search|ShuttleAI)\\b.*/uv/uv\\.config\\.js.*/assets/js/proxy\\.js",
"\\bCloak Enable\\b.*\\bAbout:Blank Cloak\\b.*\\bDoge Unblocker\\b.*/uv/uv\\.bundle\\.js","\\bAbyss\\b.*\\bMade by Paxton\\b.*\\bJoin Abyss\\b.*\\bhas not loaded","\\bHomework Help\\b.*\\bThe site that\\b.*everything\\b.*Teacher coming"],label:"proxy_and_vpn"},{Kf:["\\bdildos?\\b","\\b(sex|adult)\\s*toys?\\b","\\b(stimulators?|stimulation|vibrators?)\\b","\\bsex drive\\b","\\blibido\\b"],label:"adult",Dj:2}];Gi(this.vd);this.i.H.addListener(function(){var d;return J(function(e){if(d=c.i.Aa.vd)Gi(d),
c.vd=d;A(e)})},["customDefinitionChanged"])}x(Fi,yi);function Gi(a){a=t(a);for(var b=a.next();!b.done;b=a.next()){b=b.value;b.Zp=[];for(var c=t(b.Kf),d=c.next();!d.done;d=c.next())b.Zp.push(new RegExp(d.value,b.flags?b.flags:"is"));b.Dj||(b.Dj=1)}}
Fi.prototype.se=function(a,b){var c=this,d,e,f,g,h,l,m,n,q,u;return J(function(r){d=a;b.cq&&(d+="\n"+b.cq);e=t(c.vd);for(f=e.next();!f.done;f=e.next()){g=f.value;try{h=d;if(g.cn)if(b&&b.context&&b.context.search)h=h.substring(0,2E3);else continue;l=0;m=t(g.Zp);for(n=m.next();!n.done;n=m.next())if(q=n.value,u=h.match(q))if(c.h&&c.h.debug&&K.log("[DTA][Regex] Match. matches=",u),l++,l>=g.Dj)return c.h&&c.h.debug&&K.log("[DTA][Regex] Match output. item.label=",g.label),"unknown"==g.label?r.return({label:void 0,
text:a,oa:!1}):r.return({label:[g.label],lang:b.lang,text:a,oa:!0,ni:!0})}catch(p){K.error("[DTA] Regex error: "+g.pattern+": "+p)}}return r.return({label:void 0,text:a,oa:!1})})};function Hi(a,b){yi.call(this,b);this.i=a;this.j=new Fi(a,b);this.Gh=new zi(a,b)}x(Hi,yi);Hi.prototype.Nj=function(){return this.Gh.Nj()};
Hi.prototype.sd=function(a,b){var c=this,d,e,f,g,h,l,m,n;return J(function(q){if(1==q.h)return f=Date.now(),g=c.j.sd(a,b).catch(function(u){return{error:u}}).then(function(u){d=u}),h=c.Gh.sd(a,b).catch(function(u){K.error(u);return{error:u}}).then(function(u){e=u}),y(q,Promise.all([g,h]),2);if(d.error)return q.return(e);if(e.error)return q.return(d);l=[];for(m=0;m<d.results.length&&m<e.results.length;m++)!d.results[m].error&&d.results[m].oa?l.push(d.results[m]):l.push(e.results[m]);d.results.length!=
e.results.length&&(K.error("RegexAITAEngine: unequal # of regex and cloud results"),n=d.results.length>e.results.length?d.results:e.results,l=l.concat(n.slice(l.length)));return q.return({time:Date.now()-f,results:l})})};Hi.prototype.se=function(a,b){var c=this,d;return J(function(e){if(1==e.h)return y(e,c.j.ud(a,b),2);d=e.j;return d.oa?e.return(d):e.return(c.Gh.ud(a,b))})};
function Ii(){S.call(this,{version:"version",G:"auth",text:"text",lang:"lang",If:"origLang",ji:"origText",Wu:"textArray",url:"url",sensitivity:"sensitivity",context:"context",search:"search",type:"type",Vl:"docId",pr:"asUserID",className:"className",R:"teacherId",Su:"studentId",timestamp:"timestamp"},"TextReqObf")}x(Ii,S);var Ai=new Ii;
function Ji(){S.call(this,{Error:"Error",Hv:"Category",Cn:"Categories",Rw:"cnnProbs",zh:"Label",Hn:"Id",Vi:"Prob",Mf:"probs",In:"Info",pd:"Version",el:"Results",Mx:"logiProbs",Vq:"ModelVersion",Oy:"tfxUrl",version:"version",error:"error",content:"content",Wf:"userIsOwner"},"TextRespObf")}x(Ji,S);var Bi=new Ji;function Ki(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.dsf.debug"];this.Bk=[118,121];Li(this,Q.Fa);this.cache={};this.i.addListener(function(c,d,e){if(!b.i.disabled&&"dsf"==c.recipient)return b.onMessage(c,d,function(f){b.debug&&K.log("[DSF] On message. msg=",c,", result=",f);e&&e(f)})});this.i.H.addListener(function(c){return b.gg(c)});this.i.setInterval(function(){var c=Date.now(),d;for(d in b.cache)b.cache[d].expires<c&&delete b.cache[d]},3E5)}
function Li(a,b){a.h=b;a.l={120:a.h+"/selfharm-help.html",107:a.h+"/addiction-help.html",108:a.h+"/addiction-help.html",112:a.h+"/addiction-help.html",109:a.h+"/gambling-help.html"};a.j=a.h+"/search.html"}Ki.prototype.gg=function(a){"haparaSubscriptionExpired"===a.type&&Li(this,Q.kf)};Ki.prototype.fd=function(){return{page:this.j,Bk:this.Bk}};
Ki.prototype.onMessage=function(a,b,c){var d=this;if("dsf"==a.recipient){if("ar"==a.type)return Mi(this,a.data).then(function(e){if(e&&0!=e.length){var f=a.data.kc;d.cache[f]={results:e,expires:Date.now()+6E5};c({redirectUrl:d.j+"?q="+f})}else c({redirectUrl:d.l[a.data.qg[0]]})}),!0;"gr"==a.type?(b=this.cache[a.data.kc])?c({results:b.results}):c({}):"usr"==a.type&&(b={timestamp:Date.now(),L:a.data.L,kc:a.data.kc,results:a.data.results.map(function(e){return{url:e.url,title:e.title,Pu:e.ln}})},this.i.I.Sa("searches",
b))}};
function Mi(a,b){var c,d,e,f,g,h,l,m,n,q,u,r;return J(function(p){if(1==p.h){b.kc||(b.kc=Date.now()+"-"+Math.floor(100*Math.random()));c=[];for(d=0;d<b.results.length;d++)e=b.results[d],f=a.i.policy.rb(e.url,void 0,!1),f.ab==Q.ea&&(c.push(e),b.results.splice(d,1),d--);g=a.Bk.includes(b.qg[0]);if(!g||a.i.sa())return p.m(2);h=b.results.map(function(v){return{text:(v.title+" "+v.ln).substring(0,1024)}});l={context:{search:b.kc},nt:!0};return y(p,a.i.Vd.Ek.sd(h,l),3)}if(2!=p.h&&(m=p.j,!m.error))for(n=0;n<
m.results.length;n++)q=m.results[n],u=a.i.policy,r=ef(q.Ua||[],u.sf()),0==r.length&&c.push(b.results[n]);return p.return(c)})};function Ni(a){var b=this;this.i=a;this.jc=new Set([Q.Eb,"accounts.google.com","accounts.youtube.com","login.microsoftonline.com"]);this.i.sa()||this.jc.add("localhost");this.Ek||(this.Ek=new Ci(new Hi(this.i,this),this));this.enable(ge(this.i.runtime,"dynta"));this.i.H.addListener(function(){});this.debug="true"==this.i.s["debug.dta.debug"];this.i.addListener(function(c,d,e){if(!b.i.disabled)return b.onMessage(c,d,e)})}
Ni.prototype.enable=function(a){a?this.enabled=!0:(K.log("TA engine disabled"),this.enabled=!1)};
Ni.prototype.fd=function(a){for(var b=kf(this.i.Aa,a.url)||[],c=[21,121],d=!1,e=t(b),f=e.next();!f.done;f=e.next())if(c.includes(f.value)){d=!0;break}c=this.i.policy.sf();c=[].concat(ca(c));if(-1!=b.indexOf(32))for(e=t([118,121]),f=e.next();!f.done;f=e.next())f=c.indexOf(f.value),-1!=f&&c.splice(f,1);(f=ge(this.i.runtime,"dynta"))&&this.enable(!0);e=[];this.i.policy.mp&&(e=this.i.policy.mp());var g=ge(this.i.runtime,"dynsf");Qg(this.i.Gb,a.url,!1)&&(g=!1,a.url.toLowerCase().startsWith("https://docs.google.com/document/d/")||
(d=!0));return{enabled:f,iq:d,debug:this.debug,jc:Array.from(this.jc),fq:g,Rd:b,da:c,F:this.i.policy.Ib(),du:"true"==ee(this.i.runtime,"dta.noABAnalysis"),kh:e}};
Ni.prototype.onMessage=function(a,b,c){var d=this;if("dynTextAnalysis"==a.recipient)if("getVersion"==a.type)c&&c(this.h);else{if("getOnlineDoc"==a.type){try{var e=Q.Yb+Te(this.i)+"/GetOnlineDoc",f={version:"1.0",G:this.i.runtime.getAuthToken(),type:"google doc",Vl:a.data.Vl,pr:this.i.runtime.va()};this.debug&&K.log("Get online doc request. url=",e,"req=",f);f.G?md(this.i.http,e,"POST",JSON.stringify(Xa(Ai,f))).then(function(g){g=U(Bi,JSON.parse(g));g.error?K.error("Get online doc failed.",g.error):
d.A&&K.log("Get online doc success. userIsOwner=",g.Wf,". content=",g.content.substring(0,200));c(g)}).catch(function(g){K.error("Get online doc failure: "+g);c(void 0)}):(K.warn("No auth token. Cannot get online doc."),c(void 0))}catch(g){K.error("Get online doc exception.",g),c(void 0)}return!0}if("classify"==a.type){a.data.options||(a.data.options={});a.data.options.wb&&(a.data.options.url=a.data.url);a.data.options.sensitivity||(a.data.options.sensitivity=ge(this.i.runtime,"dtaSensi"));if("true"==
ee(this.i.runtime,"clm.collectText")&&Oi)for(e=t(Oi),f=e.next();!f.done;f=e.next())if(f=f.value,f.className){a.data.options.context||(a.data.options.context={});Object.assign(a.data.options.context,{className:f.className,R:f.R,Su:this.i.runtime.va(),timestamp:(new Date).toUTCString()});break}try{Xg(this.i.Gb,a.data.text)}catch(g){K.error("[DTA] Capture screen failed.",g)}this.Ek.ud(a.data.text,a.data.options).then(function(g){if(g&&g.Ua&&g.Ua.includes(120)&&ge(d.i.runtime,"dynab")){var h=tc(a.data.url,
0);h&&h.toLowerCase().endsWith("google.com")?(h="webpage",a.data.url.toLowerCase().startsWith("https://docs.google.com/document/d/")&&(h="googledoc"),Pi(d,a.data,b,h,g)):(!a.data.ai&&b&&b.tab&&b.tab.url&&(a.data.frameUrl=a.data.url,a.data.url=b.tab.url,d.debug&&K.log("Main frame url:",b.tab.url,". Sub frame url:",a.data.frameUrl)),d.i.policy.rb(a.data.url).ab!=Q.ea?Pi(d,a.data,b,"webpage",g):d.debug&&K.log("self-harm url whitelisted, not uploading: "+a.data.url))}d.debug||"en"!=g.lang||delete g.text;
h={hg:g,B:d.fd({url:a.data.url}),Dk:"about:blank"==(b&&b.tab&&b.tab.url)};c(h);!d.i.sa()&&a.data.ai&&"true"==d.i.s["debug.dta.logResults"]&&(h=a.data.options,g={url:h.url,options:{seq:h.wb,sensi:h.sensitivity,lang:h.lang},text:a.data.text,label:g.label,cats:g.Ua,prob:g.V,time:g.time},h=new XMLHttpRequest,h.open("POST","http://localhost:8080/store?url=taResults&append"),h.send(JSON.stringify(g)+"\n"))}).catch(function(g){K.warn("TA failure: "+g);c(void 0)});return!0}}};
function Pi(a,b,c,d,e){var f,g,h,l;J(function(m){f=t(["romeo","juliet","Hamlet","Othello","Shakespeare"]);for(g=f.next();!g.done;g=f.next())if(h=g.value,-1!=b.text.indexOf(h))return a.debug&&K.log('Text contains keyword "'+h+'". Not uploading self-harm flagged event.'),m.return();a.debug&&K.log("uploading self-harm flagged event");l={tc:"self-harm",url:b.url,frameUrl:b.frameUrl,Ba:b.Ba,W:[{name:"text",value:b.text}],Xf:{na:d,V:e.V,ni:e.ni,tj:e.tj,context:b.options&&b.options.context},pb:["Self-harm"],
yb:[{id:4,label:"Self-harm"}]};Qi(a.i.Io,l,c,"googledoc"==d,!1,!0);A(m)})};function kg(){}kg.prototype.sendMessage=function(){throw Error("sendMessage() not implemented on abstract class");};kg.prototype.Tf=function(){throw Error("setListener() not implemented on abstract class");};function lg(a){var b=this;this.channel=a;a.Tf(function(c){b.onMessage(c)});this.j=0;this.h={}}
lg.prototype.sendRequest=function(a,b){b=void 0===b?6E4:b;var c=this,d,e,f;return J(function(g){c.j++;1E6<=c.j&&(c.j=0);d=c.j;e=new Promise(function(h,l){var m={Ma:{ak:Ri,pi:d},request:a};c.h[d]={mj:function(n,q){q?l(q):h(n)}};c.channel.sendMessage(m)});if(b){f=new Promise(function(h,l){setTimeout(function(){delete c.h[d];l(Error("RPC request timed out"))},b)});try{return g.return(Promise.race([e,f]))}catch(h){throw K.error(h.toString()+JSON.stringify(a).substr(0,256)),h;}}else return g.return(e)})};
lg.prototype.onMessage=function(a){if(a.Ma&&a.Ma.ak==Si){var b=this.h[a.Ma.pi];b?(delete this.h[a.Ma.pi],b.mj(a.response,a.Ma.error)):K.warn("Unmatched RPC req ID in response: "+a.Ma.pi+", possible timed out response")}};var Ri=13530980,Si=324209024;function Ti(a,b){var c=this;this.ak=lg.h;this.h=a;a.Tf(function(d){c.onMessage(d)});this.j=b}
Ti.prototype.onMessage=function(a){var b=this,c,d;return J(function(e){if(1==e.h){if(!a.Ma||a.Ma.ak!=Ri)return e.m(0);a.Ma.ak=Si;if(!b.j)return a.Ma.error="No registered RPC handler",b.h.sendMessage({Ma:a.Ma}),e.m(0);C(e,4);return y(e,b.j(a.request),6)}if(4!=e.h)return c=e.j,b.h.sendMessage({Ma:a.Ma,response:c}),F(e,0);d=H(e);a.Ma.error=d;b.h.sendMessage({Ma:a.Ma});A(e)})};function Ui(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.dia.debug"];this.A="true"==this.i.s["debug.dia.verbose"];this.ga=Q.Yb+Te(this.i)+Q.Os;this.j={};this.l=[];this.jc=new Set;this.jc.add(Q.Eb);this.jn=[];this.ug="";this.v=1;this.h={};this.i.setInterval(function(){var c=Date.now(),d;for(d in b.h)3E5<c-b.h.Qr&&delete b.h[d]},6E4);this.i.setInterval(function(){for(var c=b.l.length;0<b.l.length;){var d=b.l[0];if(!b.j[d]||3E5<Date.now()-b.j[d].timestamp)delete b.j[d],b.l.shift();else break}(c-=
b.l.length)&&b.debug&&K.log("removed "+c+" entries from noncacheableReqs")},3E5);this.S=function(c){return b.onCompleted(c)};"true"==this.i.s["debug.dia.devmode"]&&(this.debug=this.tb=!0);this.i.H.addListener(function(c){"policyChanged"==c.type?b.enable(ge(b.i.runtime,"dynia")):"betterCNNModelFound"==c.type&&c.data.km&&b.enabled&&(K.log("switching image model to "+c.data.km),Vi(b))});this.i.addListener(function(c,d,e){if(!b.i.disabled&&"dynImgAnalysis"==c.recipient)return b.onMessage(c,d,function(f){b.debug&&
K.log("[dynImgAnalysis] onMessage. msg=",Fc(c),", result=",f);e&&e(f)})})}k=Ui.prototype;
k.onMessage=function(a,b,c){var d=this;if("dynImgAnalysis"==a.recipient)if("canFetchImage"==a.type)this.j[a.data.url]?(this.debug&&K.log("image content non-cacheable: "+a.data.url),c(!1)):c(!0);else{if("getImageContent"==a.type){if(!Q.wa){c({Fc:void 0});return}a=a.data;Q.Ic?a=fetch(a.url,{mode:"cors"}):(a={version:"1.0",G:this.i.runtime.getAuthToken(),url:a.url,width:a.width,height:a.height},a=a.G?fetch(this.ga,{method:"POST",body:JSON.stringify(Xa(Wi,a))}):Promise.reject("No auth token"));a.then(function(f){var g,
h,l;return J(function(m){switch(m.h){case 1:return Q.Ic?y(m,f.buffer(),4):y(m,f.blob(),5);case 4:h=m.j;g="data:"+(f.headers.get("content-type")||"")+";base64,"+h.toString("base64");m.m(3);break;case 5:return l=m.j,y(m,new Promise(function(n){var q=new FileReader;q.addEventListener("load",function(){n(q.result)});q.readAsDataURL(l)}),6);case 6:g=m.j;case 3:c({Fc:g}),A(m)}})}).catch(function(f){K.error("/GetImageContent: "+f);c({error:f})});return!0}if("analyzeImages"==a.type)return b={ah:a.data.ah,
pk:a.data.pk},Q.features.ra.xc&&!b.ah&&(K.error("Front end shouldn't be asking backend to do local model analysis in current config"),b.ah=!0),Xi(this,a.data.images,b).then(function(f){if(c)try{c(f)}catch(g){}}),!0;if("getFinalResults"==a.type){var e=a.data.pi;if(e){if(this.h[e])return this.h[e].Kr.then(function(f){c(f);delete d.h[e]}),!0;c({error:"Invalid request ID"})}else c({error:"No request ID provided"})}}};
k.fd=function(a,b){if(ge(this.i.runtime,"dynia")){this.enable(!0);var c=this.Ea&&this.Ea.Na()||{};if(!c||!c.inputs)return{enabled:!1};var d="true"==ee(this.i.runtime,"dia.uploadBlurredImg"),e="true"==ee(this.i.runtime,"dia.uploadViolationImgs"),f="true"==ee(this.i.runtime,"dia.blurOnLoad"),g=he(this.i.policy)||{},h=g.setting&&g.setting.Lo;f=f||h;g=g.setting&&g.setting.qe&&"strict"===g.setting.Aq||!1;if(h=Qg(this.i.Gb,a.url,!1))return this.debug&&K.log("[DIA] URL whitelisted. Disable image analysis.",
a.url),{enabled:!1};if(!h&&!a.isMainFrame&&a.referrer&&(h=Qg(this.i.Gb,a.referrer,!1)))return this.debug&&K.log("[DIA] Referer("+a.referrer+") whitelisted. Disable image analysis.",a.url),{enabled:!1};if(!h&&!a.isMainFrame&&a.ancestor&&(h=Qg(this.i.Gb,a.ancestor,!1)))return this.debug&&K.log("[DIA] Ancestor("+a.ancestor+") whitelisted. Disable image analysis.",a.url),{enabled:!1};a=kf(this.i.Aa,a.url);return{enabled:!0,frameId:b&&b.frameId,debug:this.debug,tb:this.tb,dd:c,da:this.i.policy.sf(),F:this.i.policy.Ib(),
Rx:4,Px:10,Zx:4,jc:Array.from(this.jc),jn:f?[]:this.jn,ug:this.ug,tl:!1,po:f,av:d,dv:e,uu:!1,Rd:a||[],sg:g}}return{enabled:!1}};
function Vi(a){var b,c,d,e;J(function(f){switch(f.h){case 1:b=a.i.s["debug.dia.engine"];a.D=a.Se();if("cloud"==b||Q.features.ra.xc){f.m(2);break}return y(f,Vg(a.i.Gb,a.i.s["debug.dia.model"]),3);case 3:c=f.j;if(!a.D){f.m(2);break}d=a;return y(f,Sg(a.i.Gb),5);case 5:d.J=f.j;case 2:if("cloud"!=b&&c){a.aa=a.Ea=c;try{Q.wa||de(a.i.runtime)||(e=a.Ea,setTimeout(function(){e.ih()},1E3*(8+3*Math.random()))),a.Ea.Na().Hh&&"dld"!=b&&(K.log("Enabling cloud assistance for image analysis"),a.o=new Vf(a.i),a.Ea=
a.D&&a.J?new og([a.J,a.Ea,a.o],a.i):new og([a.Ea,a.o],a.i))}catch(g){K.error("[DIA] Create engine error.",g)}}else K.warn("No WebGL support: using cloud engine for image analysis."),a.Ea=new Vf(a.i),a.o=a.Ea;A(f)}})}
k.enable=function(a){if(a)if(!this.enabled){Q.wa||chrome.webRequest.onCompleted.addListener(this.S,{urls:["*://*/*"],types:["image"]},["responseHeaders"]);if(!this.Ea)try{Vi(this)}catch(b){K.error("[DIA] Error loading image model: "+b+", switching to default")}this.enabled=!0}else{if(this.Se()!=this.D)try{Vi(this)}catch(b){K.error("[DIA] Error creating engine while skin changes.",b)}}else this.enabled&&(Q.wa||chrome.webRequest.onCompleted.removeListener(this.S),this.enabled=!1)};
k.onCompleted=function(a){var b="",c=!0;if("GET"==a.method)for(var d=t(a.responseHeaders),e=d.next();!e.done;e=d.next())if(e=e.value,"cache-control"==e.name.toLowerCase()){b+=e.value+" ";c=!0;e=t(e.value.split(","));for(var f=e.next();!f.done;f=e.next())if(f=f.value,f=f.trim(),"public"==f){c=!0;break}else-1!=["no-store","no-cache","max-age=0"].indexOf(f)&&(c=!1)}c?delete this.j[a.url]:(this.A&&K.log("noncacheable: "+b+": "+a.url),this.j[a.url]={timestamp:Date.now(),Kw:b},this.l.push(a.url))};
k.Se=function(){var a=he(this.i.policy)||{},b=a.setting&&a.setting.Lo;a="true"==ee(this.i.runtime,"dia.skinModel")||a.setting&&a.setting.cs;return!(!b||!a)};
function Xi(a,b,c){var d,e;return J(function(f){d=Date.now();e=0;return f.return(new Promise(function(g){if(b&&0!=b.length){for(var h=[],l=[],m=c.pk?"local":c.ah?"cloud":"default",n={re:0};n.re<b.length;n={re:n.re,dg:n.dg},n.re++)n.dg=b[n.re],n.dg&&h.push(a.og(n.dg,m).then(function(q){return function(u){l[q.re]={url:q.dg.url,error:u.error,L:u.L,label:u.label,T:"suggestive"==u.label?103:"explicit"==u.label?105:void 0,V:u.V,time:u.time,Dc:u.Dc,oa:u.oa,Ga:u.Ga};(l[q.re].T||"dld"!=u.L)&&e++}}(n)).catch(function(q){return function(u){l[q.re]=
{url:q.dg.url,error:u.message}}}(n)));Promise.all(h).then(function(){var q,u,r,p,v,w,z,B;return J(function(D){q={images:l,dk:e,time:Date.now()-d};if(c.pk&&"local"==m){u=[];r=[];for(p=0;p<l.length;p++)if(v=l[p],v.error||!v.oa)r[u.length]=p,u.push(b[p]);0<u.length&&(w=a.v++,1E5<a.v&&(a.v=1),q.requestId=w,z=a.h[w]={Qr:Date.now()},B={ah:!0},z.Kr=Xi(a,u,B).then(function(E){if(!E.error){for(var G=0;G<E.images.length;G++)l[r[G]]=E.images[G];q.time=Date.now()-d}return q}).catch(function(){return q}))}g(q);
A(D)})}).catch(function(q){K.error("analyzeImage() promise was rejected, shouldn't have happened: "+q);g({error:"analyzeImage() promise was rejected"})})}else g({error:"no image supplied"})}))})}
k.og=function(a,b){b=void 0===b?"default":b;var c=this,d,e,f;return J(function(g){switch(g.h){case 1:return C(g,2),a.ka||(a.ka={}),a.ka.A=c.A,c.Ga=c.Ga?c.Ga+1:1,a.ka.Ga=c.Ga,a.ka.sensitivity||(a.ka.sensitivity=ge(c.i.runtime,"diaSensi")),c.Se()&&(a.ka.Se=!0),d="default"==b?c.Ea:"cloud"==b?c.o:c.aa,d||(d=c.Ea),a.pf?y(g,d.hc(a.pf,a.ka),5):g.return({L:c.Ea.Na().name,error:"no input image given"});case 5:return e=g.j,c.debug&&K.log("[DIA]["+a.ka.Ga+"] Analyze image result. label="+e.label+", time="+e.time+
"."),e.Ga=a.ka.Ga,g.return(e);case 4:F(g,0);break;case 2:return f=H(g),K.error("[DIA]["+a.ka.Ga+"] Analyze image ("+a.url+") error:",f),K.error(f.stack),g.return({L:c.Ea.Na().name,error:f.message})}})};function Yi(){S.call(this,{version:"version",G:"auth",url:"url",width:"width",height:"height"},"GetImgContReqObf")}x(Yi,S);var Wi=new Yi;function Zi(a){function b(){if(0!=e.N.zi){var f={timestamp:Date.now(),type:"videoStats",pv:e.N,xa:e.i.runtime.env.xa};Xb(e.i.runtime,f);ae(e.i.runtime,f);e.i.I.Sa("misc",f);c()}}function c(){e.N={zi:0};delete e.i.s["debug.dva.stats"]}function d(){S.call(this,{version:"Version",error:"Error",frames:"Frames",timestamp:"Timestamp",image:"Image",Dc:"Cached",result:"Result",label:"Label",V:"Prob",L:"Engine",cw:"ResultFrom"},"VideoAnalObf")}var e=this;this.i=a;this.debug="true"==this.i.s["debug.dva.debug"];
this.tb="true"==this.i.s["debug.dva.devmode"];this.Pc="false"!=this.i.s["debug.dva.useRekog"];this.Kk="true"==this.i.s["debug.dva.serverAssist"];this.D=Q.jm+Te(this.i)+Q.Rs;this.v=Q.Yb+Te(this.i)+"/GetYTVideoUrl";x(d,S);this.o=new d;this.l=function(){S.call(this,{zi:"totalDuration"},"VideoStatsObf")};x(this.l,S);this.j=new this.l;try{(this.N=U(this.j,JSON.parse(this.i.s["debug.dva.stats"])))?b():c()}catch(f){c()}this.i.setInterval(function(){e.i.s["debug.dva.stats"]=JSON.stringify(Xa(e.j,e.N))},6E4);
this.i.setInterval(function(){b()},6E5);this.i.H.addListener(function(){setTimeout(function(){b()},6E4)},["flaggedEventsUploaded"]);this.Pc&&(a=function(){this.N=[]},a.prototype.h=function(f){this.N.push(f);5<this.N.length&&this.N.shift()},a.prototype.Ss=function(){var f={};if(0==this.N.length)return null;for(var g=0,h=t(this.N),l=h.next();!l.done;l=h.next())g+=l.value.Eu;f.ww=g/this.N.length;return f},this.Ao=new a);this.enable(ge(this.i.runtime,"dynva"));this.i.H.addListener(function(f){"betterCNNModelFound"==
f.type&&e.enabled&&f.data.vn&&(K.log("switching video model to "+f.data.vn),$i(e,f.data.vn))});this.i.addListener(function(f,g,h){if(!e.i.disabled&&"dynVideoAnalysis"==f.recipient&&e.enabled)if("analyzeFrame"==f.type){if(h)if(Q.features.ra.xc)K.error("Front end shouldn't be asking backend to do local model analysis in current config"),h({error:"not supported in current config"});else{var l=f.data;aj(e,l).then(function(v){h({Db:l.Db,result:v});Q.wa||e.i.H.sendMessage({type:"videoDiagInfo",data:{kn:"localFrameResult",
tabId:g.tab.id,label:v.label}})});return!0}}else if("getYTVideoUrl"==f.type){var m={version:"1.0",auth:e.i.runtime.getAuthToken(),url:f.data.url};if(m.auth)return md(e.i.http,e.v,"POST",JSON.stringify(m)).then(function(v){try{var w=JSON.parse(v);w.error?h({error:w.error}):h({Gy:w.data.streamUrl})}catch(z){K.error("Invalid getYTVideoUrl JSON response: "+v),h({error:"Invalid JSON response"})}}),!0;h({error:"No auth token"})}else if("analyzeFrameRekog"==f.type){if(h){var n=f.data;try{n.ka||(n.ka={}),
n.ka.sensitivity||(n.ka.sensitivity=ge(e.i.runtime,"dvaSensi")),e.h.hc(n.inputs,n.ka).then(function(v){h({Db:n.Db,result:v});e.Ao.h({Eu:v.time});Q.wa||e.i.H.sendMessage({type:"videoDiagInfo",data:{kn:"cloudFrameResult",tabId:g.tab.id,label:v.label}})})}catch(v){h({Db:f.data.Db,error:v})}return!0}}else if("getServerAssist"==f.type){if(h){var q=f.data,u=Date.now();f=[];try{q.Uf&&f.push("av-host="+encodeURIComponent((new URL(q.Uf)).hostname)),m=e.i.runtime.env,f.push("plat="+m.Oh),f.push("os="+m.platform),
m.browser&&f.push("br="+m.browser),m.uuid&&["3","8"].includes(m.uuid.charAt(m.uuid.length-1))&&(f.push("av-vhost="+(new URL(q.zb)).hostname),f.push("av-turl="+encodeURIComponent(q.Uf)),f.push("av-vurl="+encodeURIComponent(q.zb)))}catch(v){}m=e.D;0<f.length&&(m+="?"+f.join("&"));f=ge(e.i.runtime,"dvaSensi");1<f.length&&(f="veryhigh"==f?"xh":f.substr(0,1));f={version:"1.0",auth:e.i.runtime.getAuthToken(),uuid:e.i.runtime.env.uuid,videoUrl:q.zb,visibleUrl:q.Uf,timestamp:q.timestamp,nFrames:q.ck,interval:q.interval,
sensiString:f,needImage:q.Gp,useFullModel:q.sn};var r=Math.floor(1E3*Math.random()),p=Date.now();e.debug&&K.log("[DVA]["+r+"] Request to url ("+m+"):",f);(f.auth?kd(e.i.http,m,"POST",JSON.stringify(f),6E4,!1):Promise.reject("No auth token")).then(function(v){try{var w=JSON.parse(v),z=U(e.o,w);e.debug&&K.log("[DVA]["+r+"]("+(Date.now()-p)+"ms) Response:",z);if(z.error)h({error:z.error});else{for(var B=t(z.frames),D=B.next();!D.done;D=B.next()){var E=D.value;E.result&&"white"==E.result.label&&(E.result.label=
"ok")}z.time=Date.now()-u;z.L||(z.L=q.sn?"dcm":"dld");h(z)}}catch(G){K.error("Invalid server assist JSON response: "+v),h({error:"Invalid JSON response"})}}).catch(function(v){K.error("Server assist error: "+v);h({error:v.toString()})});return!0}}else"videoStats"==f.type&&(e.N.zi+=f.data.duration)})}
Zi.prototype.fd=function(a,b){if(ge(this.i.runtime,"dynva")){this.enable(!0);var c=this.Ea&&this.Ea.Na()&&this.Ea.Na().inputs||{},d=this.i.policy&&he(this.i.policy)||{},e=d.setting&&d.setting.To;try{var f=new URL(a.url);var g="meet.google.com"==f.hostname||"zoom.us"==f.hostname||f.hostname.endsWith(".zoom.us");var h=Qg(this.i.Gb,a.url,!1);if(h)return this.debug&&K.log("[DVA] URL whitelisted. Disable video analysis. url=",a.url),{enabled:!1};h||a.isMainFrame||!a.referrer||(h=Qg(this.i.Gb,a.referrer,
!1));if(h)return this.debug&&K.log("[DVA] Referer whitelisted. Disable video analysis. url=",a.url,", referer=",a.referrer),{enabled:!1};h||a.isMainFrame||!a.ancestor||(h=Qg(this.i.Gb,a.ancestor,!1));if(h)return this.debug&&K.log("[DVA] Ancestor whitelisted. Disable video analysis. url=",a.url,", ancestor=",a.ancestor),{enabled:!1}}catch(l){K.error("[DVA] Get config of url error.",a.url)}a="true"==ee(this.i.runtime,"dva.blockAllVid");f=(f="true"==ee(this.i.runtime,"dva.useServerAssist"))||this.Kk;
d=d.setting&&d.setting.qe&&"strict"===d.setting.Aq||!1;c={enabled:!g||e,debug:this.debug,tb:this.tb,Pc:this.Pc,Kk:f,da:this.i.policy.sf(),F:this.i.policy.Ib(),sampleRate:this.i.s["debug.dva.srate"]||(tf&&"cpu"==tf.getBackend()?2E3:1E3),ee:this.i.s["debug.dva.maxSrate"]||(tf&&tf.getBackend(),500),Yh:c,So:g&&e,jj:a,sg:d};b&&(c.frameId=b.frameId);this.Pc&&this.h&&(c.Tm=this.h.Na().inputs);return Xa(pb,c)}return{enabled:!1}};
Zi.prototype.enable=function(a){var b=this,c;return J(function(d){if(1==d.h){if(!a)return b.enabled=!1,d.m(0);if(b.enabled)return d.m(0);b.enabled=!0;C(d,4);return y(d,$i(b),6)}if(4!=d.h)return F(d,0);c=H(d);K.error("dynva create engine: "+c);b.enabled=!1;A(d)})};
function $i(a,b){var c,d;return J(function(e){if(1==e.h)return a.Ea||Q.features.ra.xc?e.m(2):y(e,Vg(a.i.Gb,b||a.i.s["debug.dia.model"]),3);if(2!=e.h){c=e.j;if(!c)return K.warn("No WebGL supported: video analyis disabled"),e.return();a.Ea=c;Q.wa||de(a.i.runtime)||setTimeout(function(){a.Ea.ih()},1E3*(30+5*Math.random()))}a.Pc=a.Pc&&(!a.Ea||a.Ea.Na().Hh);a.Pc&&!a.h&&(K.log("Enabling cloud assistance for video analysis"),d={Sr:"/IsVideoFrameSafe"},a.h=new Vf(a.i,d),a.h.cache.h=8);A(e)})}
function aj(a,b){return J(function(c){try{return c.return(a.Ea.hc(b.inputs,b.ka))}catch(d){return K.error("DVA error: "+d),c.return({L:a.Ea.Na().name,error:d})}})};function bj(a,b){xi.call(this,b);this.i=a;this.j=Q.Vt+Te(this.i)+Q.Tq}x(bj,xi);
bj.prototype.se=function(a,b){b=void 0===b?{}:b;var c=this,d,e,f,g,h,l,m,n;return J(function(q){if(1==q.h)return C(q,2),d=c.j,e={version:"1.0",auth:c.i.runtime.getAuthToken(),text:a,context:b.Ec,contextSource:b.Td},c.h&&c.h.debug&&K.log("[DAB] CloudABEngine classify request to url ("+d+"):",e),f=e.auth?md(c.i.http,d,"POST",JSON.stringify(e)):Promise.reject("No auth token"),y(q,f,4);if(2!=q.h)return g=q.j,h=JSON.parse(g),c.h&&c.h.debug&&K.log("[DAB] CloudABEngine classify response:",h),h.Error?l={error:h.Error}:
(l={V:h.Prob,lang:b.lang,label:h.IsCyberBully?"black":"white"},h.IsCyberBully&&(Array.isArray(h.SubCategories)||(h.SubCategories=[{id:-1,label:"Toxic Language"}])),Array.isArray(h.SubCategories)&&(m=h.SubCategories,l.yb=m.map(function(u){-1==u.id&&(u.label="Toxic Language");return u}),l.pb=m.map(function(u){return-1==u.id?"Toxic Language":u.label}))),q.return(l);n=H(q);K.error("AB engine: "+n);return q.return({error:n})})};
function cj(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.dab.debug"];this.enable(ge(this.i.runtime,"dynab"));this.o="die;dead;dying;hang;pill;hypnotic;zolpidem;overdose;overdosing;tylenol;ibuprofen;Acetaminophen;motrin;throw;jump;cut;suicid;sewer slide;commit;death;kill".split(";");this.D="die;dead;dying;hang;pill;hypnotic;zolpidem;overdose;overdosing;tylenol;ibuprofen;Acetaminophen;motrin;throw;jump;cut;suicid;sewer slide;commit;death".split(";");this.J="kill gun shot shooting shoot bomb push punch smash slap abuse smack slay pistol revolver rifle".split(" ");
this.i.addListener(function(c,d,e){if(!b.i.disabled)return b.onMessage(c,d,e)})}cj.prototype.enable=function(a){a?(this.l||(this.l=new Ci(new bj(this.i,this),this)),this.enabled=!0):(K.log("AB engine disabled"),this.enabled=!1)};
cj.prototype.fd=function(a,b){(a=ge(this.i.runtime,"dynab"))&&this.enable(!0);var c=Q.Kg()?(c=this.i.policy.M)&&c.Ei&&c.Ei.tv?c.Ei.tv:!1:!0;var d=Q.Kg()?(d=this.i.policy.M)&&d.Ei&&d.Ei.email?d.Ei.email:!1:!0;return{enabled:a,byWebpage:c,byEmail:d,debug:this.debug,skipDomains:[Q.Eb],frameId:b&&b.frameId}};
cj.prototype.onMessage=function(a,b,c){var d=this;if("dynAntiBullyAnalysis"==a.recipient&&"classify"==a.type){var e=U(hb,a).data,f=e.text,g=e.options||{};"gmail"==g.na||"office365"==g.na?(a=g.context,this.debug&&K.log("New "+g.na+": to: "+a.Of+", "+a.Qe+", "+(a.body||"").substr(0,80)),this.v||(a.Of&&0!=a.Of.length||(this.v=!0,K.error("dynab "+g.na+": recipients not found")),a.Qe||a.body||(this.v=!0,K.error("dynab "+g.na+": subject and body not found")))):"googledoc"==g.na&&this.debug&&K.log("New "+
g.na+", "+f.substr(0,80));var h=function(){var m=[];m.push({name:"text",value:f});for(var n=Object.assign({},g.context),q=t(["bodyHtml"]),u=q.next();!u.done;u=q.next())u=u.value,n[u]&&(m.push({name:u,value:n[u]}),delete n[u]);return{url:e.url,W:m,Ba:e.Ba,Xf:{na:g.na,Wf:g.Wf,context:n}}},l={};"gmail"==g.na?(l.Ec="email",l.Td="gmail"):"office365"==g.na?(l.Ec="email",l.Td="office365"):"googledoc"==g.na?(l.Ec="onlinedoc",l.Td="googledoc"):"googleSearch"==g.na?(l.Ec="search",l.Td="google"):"bingSearch"==
g.na?(l.Ec="search",l.Td="bing"):"dogpileSearch"==g.na?(l.Ec="search",l.Td="dogpile"):"yahooSearch"==g.na?(l.Ec="search",l.Td="yahoo"):"youtubeSearch"==g.na?(l.Ec="search",l.Td="youtube"):"chat"==g.na&&(l.Ec="chat",l.Td=g.hostname);l.wb=g.wb;try{Xg(this.i.Gb,f)}catch(m){K.error("[DAB] Capture screen failed.",m)}this.debug&&K.log("[DAB] Classify.",l,f);this.l.ud(f,l).then(function(m){c(Xa(jb,m));if(m&&"black"==m.label){d.debug&&K.log("dynab: cyberbully detected");var n=h();n.tc="cyberbully";n.pb=m.pb;
n.yb=m.yb;Qi(d,n,b,"googledoc"==g.na,"email"==l.Ec,!1)}});g.ro||"search"==l.Ec||this.i.Vd.Ek.ud(f,l).then(function(m){m&&m.Ua&&m.Ua.includes(120)&&(d.debug&&K.log("dynab: self-harm detected"),m=h(),m.tc="self-harm",m.pb=["Self-harm"],m.yb=[{id:4,label:"Self-harm"}],Qi(d,m,b,"googledoc"==g.na,"email"==l.Ec,!0))});return!0}};
function dj(a,b,c){b=sc(b);a.h||(a.h={},a.i.setInterval(function(){var e=Date.now(),f;for(f in a.h){var g=36E5;f.toLowerCase().startsWith("https://docs.google.com/document/d/")&&(g=864E5);e-a.h[f]>g&&delete a.h[f]}},6E5));if(b){var d=36E5;c?d=5E3:b.toLowerCase().startsWith("https://docs.google.com/document/d/")&&(d=864E5);c=Date.now();if(a.h[b]&&c-a.h[b]<d)return!0}return!1}
function Qi(a,b,c,d,e,f){var g,h,l,m;J(function(n){switch(n.h){case 1:if(dj(a,b.url,e))return a.debug&&K.log("Incident is duplicated. No uploading.",b.url),n.return();g={type:"immdRptUserAct",data:{url:b.url,title:b.Ba}};a.i.H.sendMessage(g);C(n,2);if(12!=Q.platform||!c){n.m(4);break}return y(n,Ng(a.i.ja.Xa),5);case 5:h=n.j,l={name:"screenshot",value:h},b.W.push(l);case 4:F(n,3);break;case 2:m=H(n),K.error("[DAB] onIncident capture SS failed.",m);case 3:var q=a.i.runtime.env;Xb(a.i.runtime,b,!0);
ae(a.i.runtime,b);q.ba&&(b.$j=q.ba.join(", "));q.bc&&(b.bc=q.bc);q=b.Ba+" ";if(b.W)for(var u=t(b.W),r=u.next();!r.done;r=u.next())r=r.value,"text"==r.name&&(q+=r.value+" ");u={};r=ej(a,q,b.pb,b.Xf,d,f,u);a.debug&&K.log("[DAB] Determine risk level. is_text_model="+f+", is_google_doc="+d+", event.subCategories="+b.pb+", tmp_obj.subCategories="+u.pb+", prob="+b.Xf.V+", text="+q.substring(0,100)+".");r&&(K.log("[DAB] Determined risk level is "+r+"."),b.Xf.Xm=r);u.pb&&(K.log("[DAB] Overriding sub categories from "+
JSON.stringify(b.pb)+" to "+JSON.stringify(u.pb)+"."),b.pb=u.pb);u.yb&&(K.log("[DAB] Overriding sub category info from "+JSON.stringify(b.yb)+" to "+JSON.stringify(u.yb)+"."),b.yb=u.yb);if(!b.host)try{var p=new URL(b.url);b.host=p.hostname}catch(v){}b.timestamp=Date.now();fj(a,b);A(n)}})}
function fj(a,b){a.j||(a.j={});var c=sc(b.url);a.j[c]?gj(b.Xf.Xm,a.j[c].Xf.Xm)?(a.debug&&K.log("[DAB] Replacing in delay buffer ("+c+").",b),a.j[c]=b):a.debug&&K.log("[DAB] Already in delay buffer ("+c+"). Drop.",b):(a.debug&&K.log("[DAB] Adding into delay buffer ("+c+").",b),a.j[c]=b,setTimeout(function(d){var e=a.j[d];e&&(delete a.j[d],a.debug&&K.log("[DAB] Reporting incident ("+d+").",e),a.i.I.Sa(Q.cp,[e]),a.h[d]=Date.now())},2E3,c))}
function ej(a,b,c,d,e,f,g){b=b.toLowerCase();if(f){if(d.ni&&d.context&&d.context.search){c=t(a.o);for(f=c.next();!f.done;f=c.next())if(-1!=d.context.search.indexOf(f.value))return"high";g.pb=["General Mental Health Issue and Addiction"];g.yb=[{id:9,label:"General Mental Health Issue and Addiction"}];return"medium"}c=t(a.o);for(f=c.next();!f.done;f=c.next())if(-1!=b.indexOf(f.value)){if(!d.V||.75<=d.V)return"high";if(.65<=d.V)return"medium";break}return"low"}if(!c||0==c.length)return"low";d=t(c);for(f=
d.next();!f.done;f=d.next())if(f=f.value,"Self-harm"==f||"Violence"==f||"Hate"==f)return e?"medium":"high";d=t(a.D);for(f=d.next();!f.done;f=d.next())if(-1!=b.indexOf(f.value))return g.pb=["Self-harm"],g.yb=[{id:4,label:"Self-harm"}],"high";a=t(a.J);for(f=a.next();!f.done;f=a.next())if(-1!=b.indexOf(f.value))return g.pb=["Violence"],g.yb=[{id:3,label:"Violence"}],"high";b=t(c);for(f=b.next();!f.done;f=b.next())if(g=f.value,"Explicit"==g||"Cyberbully"==g||"Abortion"==g||"Drugs"==g)return e?"low":"medium";
e=t(c);for(f=e.next();!f.done;f=e.next())if("Anxiety and depression"==f.value)return"low";K.warn("Unknown subcategory.",c);return"low"}function gj(a,b){return b?a?"high"==a||"low"==b?!0:!1:!1:!0};function hj(a){var b=this;this.i=a;(this.enabled=Q.features.Sl.enabled)?(this.v=Q.jm+Te(this.i)+"/IsImageGame",this.debug="true"==this.i.s["debug.dgm.debug"],this.l="true"==this.i.s["debug.dgim.debug"],"true"==ee(this.i.runtime,"dgm.fb")&&(this.j={Nt:3,ou:30,nu:300}),this.jc=["map.google.com","maps.google.com","docs.google.com"],a=Q.Jd+"dyncc/GMmodel",Q.Hd&&(a+="-enc"),this.modelName="brnn-110920",a+="/"+this.modelName,ij||(ij=new jj(tf,a,this.i.Gb.Yj)),this.model=ij,this.Ph=1E4,this.D={N:[],url:void 0,
timestamp:void 0},a=function(){this.o=Math.floor(10*Math.random());this.h=this.j();this.h>Date.now()&&(this.h-=6E5);this.N={}},a.prototype.j=function(){return 6E5*Math.floor(Date.now()/10/60/1E3)+6E4*this.o},a.prototype.l=function(c){Date.now()>=this.h+6E5&&(this.h=this.j(),this.N={});this.N[c]||(this.N[c]=0);return 10>this.N[c]?(this.N[c]++,!0):!1},this.j&&(this.h={url:void 0,host:void 0,gf:[],W:[]},this.i.setInterval(function(){kj(b)},18E4),this.o=new a),this.i.addListener(function(c,d,e){if(!b.i.disabled&&
"dynGamesAnalysis"==c.recipient)return b.onMessage(c,d,function(f){b.debug&&K.log("[DGM] onMessage and result. msg=",c,", result=",f);e&&e(f)})}),this.i.H.addListener(function(c){"setDebugFlag"==c.type&&"dgim"==c.data.module&&(b.l=c.data.status)})):K.warn("dgm disabled by constants.features")}hj.prototype.onMessage=function(a,b,c){if("dynGamesAnalysis"==a.recipient){if("analyzeImages"==a.type)return lj(this,a.data,b,c),!0;if("inputStats"==a.type)return mj(this,a.data,c),!0}};
hj.prototype.fd=function(a){var b=!1;try{for(var c=new URL(a.url),d=t(this.jc),e=d.next();!e.done;e=d.next()){var f=e.value;if(f==c.hostname||f.endsWith("."+c.hostname)){b=!0;break}}}catch(g){}a=kf(this.i.Aa,a.url)||[];b=(c=this.i.policy.sf())&&c.includes(118)&&!b&&!a.includes(118)&&!a.includes(121)&&!a.includes(21)&&ge(this.i.runtime,"dyngm");return{enabled:this.enabled&&(this.j||b),Dh:b,debug:this.debug,Ph:this.Ph,F:this.i.policy.Ib()}};
function mj(a,b,c){var d,e,f,g,h,l;J(function(m){if(1==m.h){d=b.gf;e=a.D;if(e.url!=b.url||Date.now()-e.timestamp>a.Ph+5E3)e.N=[],e.url=b.url;e.N.push(d);e.timestamp=Date.now();3<e.N.length&&e.N.shift();return 3!=e.N.length?m.m(0):y(m,a.model.hc(e.N),3)}f=m.j;a.debug&&K.log("Game kb/mouse input prob: "+f);g=.95<f;h=a.j&&b.fi<a.j.Nt&&3==Math.floor(b.nl/a.Ph)%6;g||h?(a.debug&&(g?K.log("Game kb/mouse input confirmed"):K.log("Feedback white image")),c({og:!0,context:{input:e.N,V:f}})):c({og:!1});if(a.j&&
!g&&b.nl>=1E3*a.j.ou&&b.nl<1E3*a.j.nu){a.h.url&&a.h.url!=b.url&&kj(a);a.h.url=b.url;try{a.h.host=(new URL(b.url)).hostname}catch(n){a.h.host=void 0}l={input:e.N.slice(),prob:f};a.h.gf.push(l)}A(m)})}
function lj(a,b,c,d){var e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D;J(function(E){switch(E.h){case 1:f=!1;try{if(e=(new URL(b.url)).hostname,g=e.toLowerCase(),"www.youtube.com"==g||"youtube.com"==g)f=!0}catch(G){return d(void 0),E.return()}if(!b.Dh&&a.o&&!a.o.l(e))return E.return();if(b.image){E.m(2);break}if(!(b.position&&c&&c.tab)){E.m(2);break}K.log("[DGM] Using screenshot to get game image ...");h=b.position;l=b;return y(E,Wg(c.tab.id,h.x,h.y,h.width,h.height),4);case 4:l.image=E.j;case 2:if(!b.image)return K.warn("[DGM] Cannot get game image. Image submission aborted. is_youtube=",
f),m="ok",!f&&.985<=b.context.V&&(m="game",a.debug&&K.log("[DGM] Game detected based on high-confidence input model prob: "+b.context.V)),d({label:m,V:0,Dk:"about:blank"==(c&&c.tab&&c.tab.url)}),E.return();a.debug&&K.log("[DGM] Submitting game image for "+e);n=b.image;q=n.substring(n.indexOf(",")+1);u={version:"1.0",auth:a.i.runtime.getAuthToken(),image:q,sensiString:"m"};r=u.auth?md(a.i.http,a.v,"POST",JSON.stringify(u)):Promise.reject("No auth token");return y(E,r,5);case 5:p=E.j;try{w=function(){S.call(this,
{error:"Error",label:"Label",version:"Version",V:"Prob",details:"Details"},"AnalyzeGameImgDataObf")};x(w,S);v=U(new w,JSON.parse(p));v.error&&K.warn("[DGM] Game image submission error: "+v.error);a.debug&&K.log("[DGM] Game image result label: "+v.label);if(v.error)d({error:v.error});else if(d({label:v.label,V:v.V,Dk:"about:blank"==(c&&c.tab&&c.tab.url)}),a.j){if(a.h.url!=b.url){kj(a);a.h.url=b.url;try{a.h.host=(new URL(b.url)).hostname}catch(G){a.h.host=void 0}}z=b.context;B={input:z.input,prob:z.V};
a.h.gf.push(B);D={name:"game-image",Da:v.label+", "+v.V.toString(),value:n};a.h.W.push(D)}a.l&&nj(n)}catch(G){throw"Invalid Cloud games IA JSON response: "+p;}A(E)}})}
function nj(a){try{var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d);for(a=0;a<b.length;a++)e[a]=b.charCodeAt(a);var f=c.split("/")[1],g=new Blob([d],{type:c});Dc("gameImage-"+(new Date).toISOString().replaceAll(":","-")+"."+f,g)}catch(h){K.error("Failed to save image for debug.",h)}}
function kj(a){if(a.h.url){var b=Object.assign({},a.h);b.data=JSON.stringify(b.gf);b.version=a.modelName;delete b.gf;var c={timestamp:Date.now(),type:"GameInputStats",Gs:b};0<b.W.length&&(c.W=b.W,b.W=void 0);a.h={url:void 0,host:void 0,gf:[],W:[]};a.i.I.Sa("misc",c)}}function oj(a,b,c){this.tf=a;this.h=this.ub(b,c)}var ij;oj.prototype.ready=function(){return this.h};
oj.prototype.ub=function(a,b){var c=this,d,e,f,g;return J(function(h){d=[];c.modelName=a.substr(a.lastIndexOf("/")+1);e=b;f={Th:e};c.model=new Yg(c.tf,a,f);d.push(c.model.ready());g=e(a+"/vocabulary.json").then(function(l){var m;return J(function(n){if(1==n.h)return m=c,y(n,l.json(),2);m.o=n.j;c.v=Object.keys(c.o).length;A(n)})}).catch(function(l){return Promise.reject("Error loading game input vocab: "+l)});d.push(g);c.h=Promise.all(d).then(function(){c.j=!0;K.log("Game input stats model "+c.modelName+
" loaded ...")});return h.return(c.h)})};oj.prototype.hc=function(a){var b=this,c,d,e,f,g,h,l,m,n;return J(function(q){if(1==q.h){c=[];d=function(u,r){if("object"==typeof u)for(var p in u)b.o[p]&&r.set(u[p],[b.o[p]]);else b.o[u]&&r.set(u[u],[b.o[u]])};e=t(a);for(f=e.next();!f.done;f=e.next())g=f.value,h=tf.buffer([b.v]),g.key&&d(g.key,h),l=g.key,delete g.key,d(g,h),g.key=l,c.push(h.toTensor());m=tf.stack(c);m=m.reshape([-1,3,b.v]);return y(q,b.model.hc(m),2)}n=q.j;return q.return(n[0])})};
function jj(a,b,c){oj.call(this,a,b,c)}x(jj,oj);
jj.prototype.ub=function(a,b){var c=this,d,e;return J(function(f){switch(f.h){case 1:if(c.l){f.m(2);break}return y(f,b(a+"/idf.json"),3);case 3:return d=f.j,y(f,d.json(),4);case 4:e=f.j,c.l=function(){var g=tf.layers.Layer.call(this,{})||this;g.kt=tf.tensor2d(e,[1,e.length],"float32");return g},x(c.l,tf.layers.Layer),c.l.prototype.call=function(g){return tf.mul(this.kt,tf.log(tf.add(g[0],1)))},ia.Object.defineProperties(c.l,{className:{configurable:!0,enumerable:!0,get:function(){return"IdfTransform"}}}),
tf.serialization.registerClass(c.l);case 2:return f.return(oj.prototype.ub.call(c,a,b))}})};function pj(a){this.i=a;try{this.h=JSON.parse(a.s["debug.act.dailyUsage"]),qj(this)}catch(b){this.reset()}}pj.prototype.reset=function(){this.h={date:this.getDate(Date.now()),categories:{}}};function qj(a){a.h.date!=a.getDate(Date.now())&&a.reset()}pj.prototype.getDate=function(a){return Math.floor(a/24/60/60/1E3)};
function rj(a){function b(){$h.call(this);this.j="PersistQObf";this.l=!0;this.o=!1}var c=this;this.i=a;this.A="true"==this.i.s["debug.act.verbose"];this.debug="true"==this.i.s["debug.act.debug"];this.D="true"==this.i.s["debug.act.noFeedback"];x(b,$h);this.o=new b;this.h={};this.J=new pj(a);this.i.H.addListener(function(d){if("postUserSignedIn"==d.type){d={};Xb(c.i.runtime,d,!0);ae(c.i.runtime,d);c.debug&&K.log("UserActivities postUserSignedIn userObj=",d);for(var e in c.h)Object.assign(c.h[e],d);
c.i.s["act.queue"]=JSON.stringify(Xa(c.o,c.h))}else"immdRptUserAct"==d.type&&sj(c,{startTime:Date.now(),elapsedTime:1E3,url:d.data.url,title:d.data.title,na:"immdRptUserAct",F:c.l},null)});this.v=["static."+Q.Eb,"static.dev."+Q.Eb];if(this.i.s["act.queue"])try{this.h=U(this.o,JSON.parse(this.i.s["act.queue"])),this.i.s["act.exList"]&&(this.j=JSON.parse(this.i.s["act.exList"])),tj(this)}catch(d){delete this.i.s["act.queue"],delete this.i.s["act.exList"]}this.h={};this.j=[];this.i.setInterval(function(){tj(c)},
12E4);this.i.setInterval(function(){c.debug&&K.log("[UserActivities] Check rule name.");uj(c)},6E4);this.i.addListener(function(d){c.i.disabled||"userActs"==d.recipient&&"usageReport"==d.type&&sj(c,d.data,d.Ma)})}rj.prototype.fd=function(){uj(this);return{debug:this.debug,A:this.A,F:this.l}};function uj(a){var b=a.i.policy.Ib();a.debug&&K.log("[UserActivities] Update rule name.",b);b!=a.l&&(a.l=b,vj(a))}
function vj(a){12==Q.platform&&chrome.tabs.query({},function(b){a.debug&&K.log("[UserActivities] Notify frontend of rule name change.",a.l);b=t(b);for(var c=b.next();!c.done;c=b.next())chrome.tabs.sendMessage(c.value.id,{recipient:"userActsFront",type:"ruleNameChange",data:{F:a.l}})})}
function sj(a,b,c){a.A&&K.log("spent "+b.elapsedTime+"ms on "+b.url+", triggered by: "+b.na);var d=b.url,e=a.h[d];if(d.startsWith("chrome")||d.startsWith("about:"))var f=[0];else try{var g=new URL(d),h=Rg(a.i.Aa,g.hostname);h?0==h.length?h=[0]:4==h[0]&&(h=[0]):(K.warn("cat ID not in cache: "+d),h=[0]);f=h}catch(l){f=[0]}e?(e.elapsedTime+=b.elapsedTime,e.title=b.title,b.Fb&&(e.Fb=b.Fb),b.Zc&&(e.Zc=b.Zc),e.Rd=f,b.Be&&(e.Be=!0),b.Ue&&(e.Ue=!0)):(e={url:d.substring(0,1024),startTime:b.startTime,timestamp:b.startTime,
elapsedTime:b.elapsedTime||0,title:b.title,Fb:b.Fb,Zc:b.Zc,Rd:f,F:b.F?b.F:"undefined"},Xb(a.i.runtime,e,!0),ae(a.i.runtime,e),b.X&&(e.X=b.X),b.Be&&(e.Be=!0),b.Ue&&(e.Ue=!0),c&&(e.userAgent=c.userAgent),c=a.i.runtime.env,!0===c.xa&&(e.xa=!0),c.ba&&(e.$j=c.ba.join(", ")),c.bc&&(e.bc=c.bc),a.h[d]=e);if(a.i.La){if(c=Ig(a.i.La))a.h[d].rj=c;if(c=Jg(a.i.La))a.h[d].sj=c}a.i.policy&&a.i.policy.ze&&(c=a.i.policy.ze())&&(a.h[d].bb=c);d=a.J;c=b.Zc?b.Fb:f;b=b.elapsedTime||0;if(c){qj(d);f=d.h.categories;c=t(c);
for(e=c.next();!e.done;e=c.next())e=e.value,f[e]?f[e].time+=b:f[e]={time:b};d.i.s["debug.act.dailyUsage"]=JSON.stringify(d.h)}b=JSON.stringify(Xa(a.o,a.h));1048576>b.length?a.i.s["act.queue"]=b:tj(a)}function Zh(a,b){a.j.push(b);a.i.s["act.exList"]=JSON.stringify(a.j)}
function tj(a){var b=[],c;for(c in a.h){var d=a.h[c];if(!(10>d.elapsedTime||!d.url||d.url.startsWith("chrome")||d.url.startsWith("about:")))if(a.j&&a.j.includes(d.url))a.debug&&K.log("Removed from activities upload: "+d.url);else try{var e=new URL(d.url);if(a.v.includes(e.hostname))a.debug&&K.log("Removed from activities upload: "+d.url);else{d.host=e.hostname;d.domain=psl.get(d.host);d.startTime=(new Date(d.startTime)).toISOString();d.timestamp=d.startTime;d.domain||(d.domain=d.host);var f=void 0,
g=d.Zc&&d.Fb&&0<d.Fb.length&&0!=d.Fb[0]?d.Fb:d.Rd;if(g)try{f=g.map(function(h){return 4==h?"Unclassified":jf(a.i.Aa,h)}).join(",")}catch(h){K.error("failed to get catNames for catID "+g.join(",")+"; err="+h)}delete d.Zc;d.tg=g;d.T=f;"www.youtube.com"==d.host&&(d.uv=e.searchParams.get("v"));b.push(d)}}catch(h){K.error("Invalid URL: "+d.url)}}0<b.length&&(a.debug&&K.log("uploading "+b.length+" user activities"),a.D||a.i.I.Sa("user_activities",b));a.h={};a.j=[];delete a.i.s["act.queue"];delete a.i.s["act.exList"]}
;function wj(a){this.i=a;this.i.addListener(function(b,c,d){if("vendorMisc"==b.recipient&&"unblockUrl"==b.type){var e=b.data;if(qc(e.studentEmail,e.studentOu,e.studentGroups,e.url,e.category)!=e.intchk)return d({error:"Int check fail."}),!1;if(12==Q.platform&&d&&c&&c.tab&&c.tab.id){K.log("[1568] Got unblock url message.",b,c.tab);b=b.data;b.tabId=c.tab.id;var f={type:"unblockUrl",data:b};c=[];b={};e=t(["jbiooalnpjmfldodiaclikfcebmekfmh","hmfjajhcddnpmhkhakkgoibealjcffho","kbohafcopfpigkjdimdcdgenlhkmhbnc",
"aceopacgaepdcelohobicpffbbejnfac"]);for(var g=e.next();!g.done;b={Ok:b.Ok},g=e.next())b.Ok=g.value,g=new Promise(function(h){return function(l,m){chrome.runtime.sendMessage(h.Ok,f,function(n){chrome.runtime.lastError&&!0;n?(K.log("[1568] Got unblock url response from external.",n),l(n)):m()})}}(b)),c.push(g);Promise.any(c).then(function(h){d(h)}).catch(function(){K.error("[1568] Got no unblock url response from external.");d(void 0)});return!0}}})};function xj(a){var b=this;this.i=a;(this.debug="true"===this.i.s["debug.ss.debug"])&&K.log("SafeSearch constructor start");this.v={urls:"*://www.google.com/search?* *://www.bing.com/search?* *://www.dogpile.com/serp?* *://search.yahoo.com/search* *://search.yahoo.com/web?* *://*.search.yahoo.com/search* *://search.yahoo.co.jp/search* *://search.yahoo.co.jp/web?* *://*.search.yahoo.co.jp/search* *://*.wikipedia.org/* *://*.wikibooks.org/* *://web.archive.org/web/* *://twitter.com/search?* *://twitter.com/search-advanced?* *://*.facebook.com/search* *://www.youtube.com/results?search_query=* *://www.google.ac/search?* *://www.google.ad/search?* *://www.google.ae/search?* *://www.google.com.af/search?* *://www.google.com.ag/search?* *://www.google.com.ai/search?* *://www.google.al/search?* *://www.google.am/search?* *://www.google.co.ao/search?* *://www.google.com.ar/search?* *://www.google.as/search?* *://www.google.at/search?* *://www.google.com.au/search?* *://www.google.az/search?* *://www.google.ba/search?* *://www.google.com.bd/search?* *://www.google.be/search?* *://www.google.bf/search?* *://www.google.bg/search?* *://www.google.com.bh/search?* *://www.google.bi/search?* *://www.google.bj/search?* *://www.google.com.bn/search?* *://www.google.com.bo/search?* *://www.google.com.br/search?* *://www.google.bs/search?* *://www.google.bt/search?* *://www.google.co.bw/search?* *://www.google.by/search?* *://www.google.com.bz/search?* *://www.google.ca/search?* *://www.google.com.kh/search?* *://www.google.cc/search?* *://www.google.cd/search?* *://www.google.cf/search?* *://www.google.cat/search?* *://www.google.cg/search?* *://www.google.ch/search?* *://www.google.ci/search?* *://www.google.co.ck/search?* *://www.google.cl/search?* *://www.google.cm/search?* *://www.google.cn/search?* *://www.google.com.co/search?* *://www.google.co.cr/search?* *://www.google.com.cu/search?* *://www.google.cv/search?* *://www.google.com.cy/search?* *://www.google.cz/search?* *://www.google.de/search?* *://www.google.dj/search?* *://www.google.dk/search?* *://www.google.dm/search?* *://www.google.com.do/search?* *://www.google.dz/search?* *://www.google.com.ec/search?* *://www.google.ee/search?* *://www.google.com.eg/search?* *://www.google.es/search?* *://www.google.com.et/search?* *://www.google.fi/search?* *://www.google.com.fj/search?* *://www.google.fm/search?* *://www.google.fr/search?* *://www.google.ga/search?* *://www.google.ge/search?* *://www.google.gf/search?* *://www.google.gg/search?* *://www.google.com.gh/search?* *://www.google.com.gi/search?* *://www.google.gl/search?* *://www.google.gm/search?* *://www.google.gp/search?* *://www.google.gr/search?* *://www.google.com.gt/search?* *://www.google.gy/search?* *://www.google.com.hk/search?* *://www.google.hn/search?* *://www.google.hr/search?* *://www.google.ht/search?* *://www.google.hu/search?* *://www.google.co.id/search?* *://www.google.iq/search?* *://www.google.ie/search?* *://www.google.co.il/search?* *://www.google.im/search?* *://www.google.co.in/search?* *://www.google.io/search?* *://www.google.is/search?* *://www.google.it/search?* *://www.google.je/search?* *://www.google.com.jm/search?* *://www.google.jo/search?* *://www.google.co.jp/search?* *://www.google.co.ke/search?* *://www.google.ki/search?* *://www.google.kg/search?* *://www.google.co.kr/search?* *://www.google.com.kw/search?* *://www.google.kz/search?* *://www.google.la/search?* *://www.google.com.lb/search?* *://www.google.com.lc/search?* *://www.google.li/search?* *://www.google.lk/search?* *://www.google.co.ls/search?* *://www.google.lt/search?* *://www.google.lu/search?* *://www.google.lv/search?* *://www.google.com.ly/search?* *://www.google.co.ma/search?* *://www.google.md/search?* *://www.google.me/search?* *://www.google.mg/search?* *://www.google.mk/search?* *://www.google.ml/search?* *://www.google.com.mm/search?* *://www.google.mn/search?* *://www.google.ms/search?* *://www.google.com.mt/search?* *://www.google.mu/search?* *://www.google.mv/search?* *://www.google.mw/search?* *://www.google.com.mx/search?* *://www.google.com.my/search?* *://www.google.co.mz/search?* *://www.google.com.na/search?* *://www.google.ne/search?* *://www.google.com.nf/search?* *://www.google.com.ng/search?* *://www.google.com.ni/search?* *://www.google.nl/search?* *://www.google.no/search?* *://www.google.com.np/search?* *://www.google.nr/search?* *://www.google.nu/search?* *://www.google.co.nz/search?* *://www.google.com.om/search?* *://www.google.com.pk/search?* *://www.google.com.pa/search?* *://www.google.com.pe/search?* *://www.google.com.ph/search?* *://www.google.pl/search?* *://www.google.com.pg/search?* *://www.google.pn/search?* *://www.google.co.pn/search?* *://www.google.com.pr/search?* *://www.google.ps/search?* *://www.google.pt/search?* *://www.google.com.py/search?* *://www.google.com.qa/search?* *://www.google.ro/search?* *://www.google.rs/search?* *://www.google.ru/search?* *://www.google.rw/search?* *://www.google.com.sa/search?* *://www.google.com.sb/search?* *://www.google.sc/search?* *://www.google.se/search?* *://www.google.com.sg/search?* *://www.google.sh/search?* *://www.google.si/search?* *://www.google.sk/search?* *://www.google.com.sl/search?* *://www.google.sn/search?* *://www.google.sm/search?* *://www.google.so/search?* *://www.google.st/search?* *://www.google.sr/search?* *://www.google.com.sv/search?* *://www.google.td/search?* *://www.google.tg/search?* *://www.google.co.th/search?* *://www.google.com.tj/search?* *://www.google.tk/search?* *://www.google.tl/search?* *://www.google.tm/search?* *://www.google.to/search?* *://www.google.tn/search?* *://www.google.com.tr/search?* *://www.google.tt/search?* *://www.google.com.tw/search?* *://www.google.co.tz/search?* *://www.google.com.ua/search?* *://www.google.co.ug/search?* *://www.google.co.uk/search?* *://www.google.com.uy/search?* *://www.google.co.uz/search?* *://www.google.com.vc/search?* *://www.google.co.ve/search?* *://www.google.vg/search?* *://www.google.co.vi/search?* *://www.google.com.vn/search?* *://www.google.vu/search?* *://www.google.ws/search?* *://www.google.co.za/search?* *://www.google.co.zm/search?* *://www.google.co.zw/search?* *://google.ac/search?* *://google.ad/search?* *://google.ae/search?* *://google.com.af/search?* *://google.com.ag/search?* *://google.com.ai/search?* *://google.al/search?* *://google.am/search?* *://google.co.ao/search?* *://google.com.ar/search?* *://google.as/search?* *://google.at/search?* *://google.com.au/search?* *://google.az/search?* *://google.ba/search?* *://google.com.bd/search?* *://google.be/search?* *://google.bf/search?* *://google.bg/search?* *://google.com.bh/search?* *://google.bi/search?* *://google.bj/search?* *://google.com.bn/search?* *://google.com.bo/search?* *://google.com.br/search?* *://google.bs/search?* *://google.bt/search?* *://google.co.bw/search?* *://google.by/search?* *://google.com.bz/search?* *://google.ca/search?* *://google.com.kh/search?* *://google.cc/search?* *://google.cd/search?* *://google.cf/search?* *://google.cat/search?* *://google.cg/search?* *://google.ch/search?* *://google.ci/search?* *://google.co.ck/search?* *://google.cl/search?* *://google.cm/search?* *://google.cn/search?* *://google.com.co/search?* *://google.co.cr/search?* *://google.com.cu/search?* *://google.cv/search?* *://google.com.cy/search?* *://google.cz/search?* *://google.de/search?* *://google.dj/search?* *://google.dk/search?* *://google.dm/search?* *://google.com.do/search?* *://google.dz/search?* *://google.com.ec/search?* *://google.ee/search?* *://google.com.eg/search?* *://google.es/search?* *://google.com.et/search?* *://google.fi/search?* *://google.com.fj/search?* *://google.fm/search?* *://google.fr/search?* *://google.ga/search?* *://google.ge/search?* *://google.gf/search?* *://google.gg/search?* *://google.com.gh/search?* *://google.com.gi/search?* *://google.gl/search?* *://google.gm/search?* *://google.gp/search?* *://google.gr/search?* *://google.com.gt/search?* *://google.gy/search?* *://google.com.hk/search?* *://google.hn/search?* *://google.hr/search?* *://google.ht/search?* *://google.hu/search?* *://google.co.id/search?* *://google.iq/search?* *://google.ie/search?* *://google.co.il/search?* *://google.im/search?* *://google.co.in/search?* *://google.io/search?* *://google.is/search?* *://google.it/search?* *://google.je/search?* *://google.com.jm/search?* *://google.jo/search?* *://google.co.jp/search?* *://google.co.ke/search?* *://google.ki/search?* *://google.kg/search?* *://google.co.kr/search?* *://google.com.kw/search?* *://google.kz/search?* *://google.la/search?* *://google.com.lb/search?* *://google.com.lc/search?* *://google.li/search?* *://google.lk/search?* *://google.co.ls/search?* *://google.lt/search?* *://google.lu/search?* *://google.lv/search?* *://google.com.ly/search?* *://google.co.ma/search?* *://google.md/search?* *://google.me/search?* *://google.mg/search?* *://google.mk/search?* *://google.ml/search?* *://google.com.mm/search?* *://google.mn/search?* *://google.ms/search?* *://google.com.mt/search?* *://google.mu/search?* *://google.mv/search?* *://google.mw/search?* *://google.com.mx/search?* *://google.com.my/search?* *://google.co.mz/search?* *://google.com.na/search?* *://google.ne/search?* *://google.com.nf/search?* *://google.com.ng/search?* *://google.com.ni/search?* *://google.nl/search?* *://google.no/search?* *://google.com.np/search?* *://google.nr/search?* *://google.nu/search?* *://google.co.nz/search?* *://google.com.om/search?* *://google.com.pk/search?* *://google.com.pa/search?* *://google.com.pe/search?* *://google.com.ph/search?* *://google.pl/search?* *://google.com.pg/search?* *://google.pn/search?* *://google.co.pn/search?* *://google.com.pr/search?* *://google.ps/search?* *://google.pt/search?* *://google.com.py/search?* *://google.com.qa/search?* *://google.ro/search?* *://google.rs/search?* *://google.ru/search?* *://google.rw/search?* *://google.com.sa/search?* *://google.com.sb/search?* *://google.sc/search?* *://google.se/search?* *://google.com.sg/search?* *://google.sh/search?* *://google.si/search?* *://google.sk/search?* *://google.com.sl/search?* *://google.sn/search?* *://google.sm/search?* *://google.so/search?* *://google.st/search?* *://google.sr/search?* *://google.com.sv/search?* *://google.td/search?* *://google.tg/search?* *://google.co.th/search?* *://google.com.tj/search?* *://google.tk/search?* *://google.tl/search?* *://google.tm/search?* *://google.to/search?* *://google.tn/search?* *://google.com.tr/search?* *://google.tt/search?* *://google.com.tw/search?* *://google.co.tz/search?* *://google.com.ua/search?* *://google.co.ug/search?* *://google.co.uk/search?* *://google.com/search?* *://google.com.uy/search?* *://google.co.uz/search?* *://google.com.vc/search?* *://google.co.ve/search?* *://google.vg/search?* *://google.co.vi/search?* *://google.com.vn/search?* *://google.vu/search?* *://google.ws/search?* *://google.co.za/search?* *://google.co.zm/search?* *://google.co.zw/search?*".split(" ")};
this.D=["blocking","requestBody"];this.l=/^(www\.)google\.co(m)?\.[a-z][a-z]$/g;this.o=/^(www\.)google\.[a-z][a-z]$/g;Q.wa||(this.h=function(c){var d=of(b,c.url,c.type,!1);d&&d.redirectUrl?(d={redirectUrl:d.redirectUrl},b.debug&&K.log("seSafeSearchFunc.",c.url,c.type,d),c=d):c=void 0;return c},yj.onBeforeRequest.addListener(this.h,this.v,this.D))}
function nf(a,b){try{var c=new URL(b);return"www.google.com"===c.hostname&&"/search"===c.pathname||c.hostname.endsWith(".youtube.com")&&"/results"===c.pathname&&c.search.startsWith("?search_query=")||c.hostname.endsWith(".facebook.com")&&"/search"===c.pathname||"www.bing.com"===c.hostname&&"/search"===c.pathname||"www.dogpile.com"===c.hostname&&"/serp"===c.pathname||(c.hostname.endsWith("search.yahoo.com")||c.hostname.endsWith("search.yahoo.co.jp"))&&("/search"==c.pathname||"/web"==c.pathname||"/search/"==
c.pathname||"/image/search"==c.pathname||"/video/search"==c.pathname||"/realtime/search"==c.pathname)||c.hostname.endsWith("chiebukuro.yahoo.co.jp")&&"/search/"==c.pathname||c.hostname.endsWith("news.yahoo.co.jp")&&"/search/"==c.pathname||"twitter.com"===c.hostname&&("/search"===c.pathname||"/search-advanced"===c.pathname)||"/search?"===c.pathname&&(c.hostname.match(a.l)||c.hostname.match(a.o))||(c.hostname.endsWith(".wikipedia.org")||c.hostname.endsWith(".wikibooks.org"))&&(c.pathname.startsWith("/wiki/")||
c.pathname.startsWith("/w/index.php?")||c.pathname.startsWith("/wiki/special:search?"))||"web.archive.org"==c.hostname&&c.pathname.startsWith("/web/*/")?!0:!1}catch(d){return!1}}xj.prototype.j=function(a){return Ic(a,this,this.debug)};xj.prototype.Gd=function(a,b){var c=Date.now(),d=b.find(this.j,a);d?K.log("[SS] Fuzzy matched: queryWord="+a+"; target="+d):K.log("[SS] Fuzzy matches "+b.length+" words using "+(Date.now()-c)+"ms.");return d};
function zj(a,b){a=a.trim().toLowerCase();a=Hc(a);a=a.split(" ").sort().join(" ");a=" "+a+" ";return b.find(function(c){return c.startsWith('"')&&c.endsWith('"')?(c=c.substring(1,c.length-1),a==c):a.includes(c)})}function hf(a,b,c){try{if(c&&0!=c.length&&nf(a,b)){var d=Aj(b);if(d){d=decodeURIComponent(d.trim().toLowerCase());var e=zj(d,c);e&&K.log("[SS] queryWord=",d,", match_found=",e);return e}}}catch(f){K.error("[SS] matchSeAllowWords error.",f)}}
function Aj(a){a=new URL(a);var b=new URLSearchParams(a.search.slice(1)),c=a.hostname.toLowerCase();a=a.pathname.toLowerCase();if(c.includes("google"))var d=b.get("q");else c.includes("bing")?d=b.get("q"):c.includes("dogpile")?d=b.get("q"):c.includes("yahoo")?(d=b.get("p"))||(d=b.get("va")):c.includes("twitter")?d=b.get("q"):c.includes("facebook")?(d=b.get("q"),!d&&a.startsWith("/search/str/")&&(b=a.indexOf("/",12),-1<b&&(d=a.substring(12,b)))):c.includes("youtube")?d=b.get("search_query"):c.includes("wikipedia.org")||
c.includes("wikibooks.org")?(a.startsWith("/w/index.php")||a.startsWith("/wiki/special:search")?d=b.get("search"):a.startsWith("/wiki/")&&!a.startsWith("/wiki/File:")&&(d=a.indexOf("#/",6),d=-1==d?a.substring(6):a.substring(6,d)),d&&(d=d.replace(/_/g," "))):"web.archive.org"==c&&a.startsWith("/web/*/")&&(d=a.substring(7));return d}
function of(a,b,c,d){var e={},f=a.i.policy.gm(),g=new URL(b),h=new URLSearchParams(g.search.slice(1)),l=g.hostname.toLowerCase();if(0<f.length){var m=Aj(b);if(m&&(m=decodeURIComponent(m.trim().toLowerCase()),f=a.Gd(m,f)))return d=a.i.policy.uf(b,"",jf(a.i.Aa,Q.Vb),[Q.Vb],!1,"school"),g=Object.assign({},{L:"bl"}),g.context=c,g.policy="school",g.F=a.i.policy.Ib(),g.X="search keyword '"+f+"' is in blocked list",Yh(a.i.I,[2],b,g),a.i.policy.Zg(b,""),e.redirectUrl=d,e.sl=!0,e}f=c=!1;if(void 0===a.i.policy.Rj()||
!0===a.i.policy.Rj())l.includes("google")?d?(f=!0,g.hostname="forcesafesearch.google.com"):h.get("safe")&&"strict"===h.get("safe")||Q.wa||(h.set("safe","strict"),h.set("ssui","on"),c=!0):l.includes("bing")?h.get("adlt")&&"strict"===h.get("adlt")||(h.set("adlt","strict"),c=!0):!l.includes("yahoo")||h.get("vm")&&"r"===h.get("vm")||(h.set("vm","r"),c=!0);c?e.redirectUrl=b.substring(0,b.indexOf("?")+1)+h.toString():f&&(e.Oc=g.toString());e.sl=!1;return e};function Bj(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.bhr.debug"];this.A="true"==this.i.s["debug.bhr.verbose"];this.h=[];this.j=!1;this.i.addListener(function(c,d,e){if(!b.i.disabled&&"filterBackend"==c.recipient)return b.onMessage(c,d,function(f){b.A&&K.log("[filterBackend] onMessage. msg=",c,", result=",f);e&&e(f)})});12==Q.platform&&(chrome.tabs.query({},function(c){for(var d in c)pc(c[d].url)||Cj(b,c[d])}),this.l=function(c){c=c.tabId;var d=b.h.indexOf(c);-1<d&&(b.debug&&K.log("lagged onActivated "+
c),chrome.tabs.reload(c),b.h.splice(d,1));0==b.h.length&&(b.debug&&K.log("lagged tab over."),chrome.tabs.onActivated.removeListener(b.l))},chrome.tabs.onActivated.addListener(this.l))}
function Cj(a,b){var c,d;J(function(e){a.debug&&K.log("lagged check "+b.id+" "+b.url);c=!1;setTimeout(function(f){a.debug&&K.log("lagged page timeout: "+f.id+" "+f.url);c||(a.debug&&K.log("lagged page timeout, reload/track here "+f.id+" "+f.url),1==f.active?chrome.tabs.reload(f.id):a.h.includes(f.id)||a.h.push(f.id))},3E3,b);d={recipient:"filter",type:"contentScriptLoaded",url:b.url};chrome.tabs.sendMessage(b.id,d,function(f){f?a.debug&&K.log("not lagged page: "+f.ok+" "+b.id+" "+b.url):(a.debug&&
K.log("lagged page, reload/track here "+b.id+" "+b.url),1==b.active?chrome.tabs.reload(b.id):a.h.includes(b.id)||a.h.push(b.id));c=!0});A(e)})}
Bj.prototype.onMessage=function(a,b,c){var d=this;if("filterBackend"==a.recipient){if("isBlockingNeeded"==a.type)return this.i.disabled?c&&c({pa:!0}):function(){var h,l;return J(function(m){if(1==m.h)return!a.data.ai&&b&&b.tab&&b.tab.url&&(h=Dj(d,b.tab.url),h.yc)?(c(h),m.return()):y(m,Ej(d,a.data.url,!1,a.data.ai?"main_frame":"sub_frame"),2);l=m.j;c(l);A(m)})}().catch(function(h){c({error:h.toString()})}),!0;if("onBeforeRequest"==a.type){var e=a.data.url;if(e){if(99===Q.za)Fj(this,e).then(function(h){if(h&&
h.redirectUrl)c({redirectUrl:h.redirectUrl});else if(h&&0==h.pa)c({cancel:!0});else{h={};if(d.i.policy.De()){var l=kf(d.i.Aa,e);l&&l.includes(90)&&(h.redirectUrl="about:blank")}c(h)}}).catch(function(h){c({error:h.toString()})});else{if(88==Q.platform){var f=this.i.G.Xh();if(f&&!e.startsWith(Q.Fa)&&!e.startsWith(Q.kf)){c({redirectUrl:f});return}if(e.startsWith(Q.Fa+"/eduSignOut.html")){f=this.i.G.$c+"?message=signOut&idp=";a:switch(this.i.G.i.policy.Gc().method){case "gsuite":var g="google";break a;
case "azure":g="azure";break a;default:g=""}f={redirectUrl:f+g};this.i.G.wi("customer logout from eduSignOut.html",!0);c(f);return}}(function(){var h,l,m,n,q,u,r,p,v;return J(function(w){if(1==w.h){if(h=a.data.Up)if(l=Dj(d,h),l.yc)return m=Gj(d,e)||{},c(m),w.return();n="unsure_frame";a.data.Up||(n="main_frame");return y(w,Ej(d,e,!0,n),2)}if((q=w.j)&&q.redirectUrl)c({redirectUrl:q.redirectUrl});else if(q&&q.Oc)c({proxyUrl:q.Oc});else if(q&&0==q.pa)c({cancel:!0});else{if(d.i.policy.De()&&(u=kf(d.i.Aa,
e))&&u.includes(90)&&(r=!1,h&&(p=$e(d.i.policy,h),p==Q.ea&&(r=!0)),!r))return c({redirectUrl:"about:blank"}),w.return();v=Gj(d,e)||{};c(v)}A(w)})})().catch(function(h){c({error:h.toString()})})}return!0}c({error:"no url provided"})}}};function Dj(a,b){var c=a.i.policy.rb(b);a.A&&K.log("Tab filter decision:",c,", url=",b);return c.ab==Q.ea?{pa:!0,X:c.X,F:c.F,yc:!0}:{yc:!1}}
function Ej(a,b,c,d){var e,f,g,h,l,m,n,q,u,r,p,v,w,z;return J(function(B){if(1==B.h){try{if(e=new URL(b),e.hostname.endsWith("."+Q.Eb))return B.return({pa:!0})}catch(D){}if(b.startsWith("about:"))return B.return({pa:!0});if("chrome"!=a.i.runtime.env.platform&&a.i.G.hb){f=!1;if(g=a.i.G.Ka&&a.i.G.Ka.list)for(h=t(g),l=h.next();!l.done;l=h.next())if(m=l.value,b.startsWith(m)){f=!0;break}if(f)return B.return({pa:!0,X:"site is allowed due to auth in progress"})}n={type:d,url:b};q=mf(a.i.policy,b,c);u=void 0;
q.F||"chrome"!=a.i.runtime.env.platform&&(!a.i.runtime.getAuthToken()||a.i.G.hb)||(K.warn("rule name not set, request recheck: "+b),u=500);a.A&&K.log("Filter decision: "+JSON.stringify(q)+", "+b);r=Hj(a,n,q,u);if(r.pa)return B.return(r);if(r.redirectUrl)return Zh(a.i.te,b),B.return(r);if(r.Oc)return B.return(r);if(q.Xb)return B.return({pa:!0,mi:u});a.debug&&K.log("filter CC query for "+n.url);C(B,6);return y(B,li(a.i.Aa,n.url),8)}if(6!=B.h)return p=mf(a.i.policy,b,c),a.A&&K.log("Filter decision: "+
JSON.stringify(p)+", "+b),u=p.F?void 0:500,v=Hj(a,n,p,u),v.pa?B.return(v):v.redirectUrl?(Zh(a.i.te,b),B.return(v)):v.Oc?B.return(v):B.return({pa:!0,mi:u});w=H(B);z="getCatsFromCloud: "+w+", "+n.url;"No auth token"==w.toString()?K.warn(z):K.error(z);return B.return({pa:!0,X:"site is allowed due to cloud failure"})})}
function Fj(a,b){var c,d,e,f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:try{if(c=new URL(b),c.hostname.endsWith("."+Q.Eb))return r.return({pa:!0})}catch(p){}if(b.startsWith("about:"))return r.return({pa:!0});if(!Q.features.proxy.Dt){r.m(2);break}C(r,3);d=a.i.runtime.env;a.debug&&K.log("classifyUrlFamily, env="+JSON.stringify(d));if(!d||void 0==d.Ng||0!=d.Ng||a.i.G.Qc){r.m(5);break}if(!a.j){r.m(6);break}return y(r,yc(),6);case 6:a.j=!0;e=require("child_process");if("darwin"==process.platform.toLowerCase())return y(r,
Ij(a,e),9);if(!process.platform.toLowerCase().startsWith("win")){r.m(9);break}return y(r,Jj(a,e),9);case 9:return a.j=!1,r.return({pa:!1});case 5:F(r,4);break;case 3:return f=H(r),K.log("failed to child-process: "+f),r.return({pa:!1});case 4:if(a.i.G.hb)return r.return({pa:!1});case 2:g=mf(a.i.policy,b);if(!g.F&&a.i.runtime.getAuthToken()&&!a.i.G.hb)return r.return({pa:!1});h={type:"main_frame",url:b};l=Hj(a,h,g);if(l.pa)return r.return({pa:!0});if(l.redirectUrl)return Zh(a.i.te,b),r.return({redirectUrl:l.redirectUrl});
if(g.Xb&&0!=g.Xb.length){r.m(13);break}a.debug&&K.log("filter CC query for "+h.url);C(r,14);if(a.i.runtime.getAuthToken()){r.m(16);break}return"android"==Q.os?r.return({pa:!0}):y(r,Th(a.i.G),16);case 16:return y(r,li(a.i.Aa,h.url),19);case 19:m=mf(a.i.policy,b);n=Hj(a,h,m);if(n.pa)return r.return({pa:!0});if(n.redirectUrl)return Zh(a.i.te,b),r.return({redirectUrl:n.redirectUrl});F(r,13);break;case 14:return q=H(r),u="getCatsFromCloud: "+q+", "+h.url,"No auth token"==q.toString()?K.warn(u):K.error(u),
r.return({pa:!1});case 13:return r.return({pa:!0})}})}
function Jj(a,b){var c;return J(function(d){try{if((c=b.execSync('tasklist /fi "ImageName eq Deledao.exe" /fo csv 2>NUL').toString())&&c.includes("Deledao.exe"))return a.debug&&K.log("Junior is running, waiting for signing in..."),d.return(!1);a.i.runtime.env.Ha&&a.i.runtime.env.Ha!=Q.qd?(a.debug&&K.log("Junior is not running, start it now..."+process.platform+"; "+JSON.stringify(process.env)),b.exec("Deledao.exe",{cwd:"..\\"},function(e,f,g){if(e||g)return!1})):a.debug&&K.log("Junior is not running, and user has not signed in yet");
return d.return(!0)}catch(e){return K.log("Error launchJuniorOnWin: "+e),d.return(!1)}})}
function Ij(a,b){var c,d;return J(function(e){c='ps -ax | grep "Deledao Junior.app/Contents/MacOS/Chromium" |grep -v grep';try{return b.execSync(c),a.debug&&K.log("1 Junior is running, waiting for signing in..."),e.return(!1)}catch(f){try{return c='ps -ax | grep "/Applications/Deledao Junior.app/Contents/MacOS/Deledao Junior" |grep -v grep',b.execSync(c),a.debug&&K.log("2 Junior is running, waiting for signing in..."),e.return(!1)}catch(g){return K.log("Junior is not running, start it now..."+JSON.stringify(g)),
a.i.runtime.env.Ha!=Q.qd?(d=b.exec("open -a /Applications/Deledao\\ Junior.app --args "))&&d.unref():a.debug&&K.log("Junior is not running, and user has not signed in yet"),e.return(!0)}}})}
function Hj(a,b,c,d){if("proxy"==c.action)return{Oc:c.Oc};if("redirect"==c.action)return{redirectUrl:c.redirectUrl};if("block"==c.action){if(c.ab==Q.Pa)return a.debug&&K.log("filter blocking: blacklist: "+b.url),d={L:"bl",policy:c.la,F:c.F},c.X&&(d.X=c.X),{redirectUrl:Og(a,b,[Q.Vb],d).redirectUrl};if(c.Xb){if(d=c.da||[],0<d.length){a.debug&&K.log("filter blocking: "+d+", "+b.url);var e=a.i.Aa.Ej.getItem(b.url);c={L:"cc",policy:c.la,F:c.F};e&&Object.assign(c,e.details);return{redirectUrl:Og(a,b,d,
c).redirectUrl}}}else K.error("Confused by URL block decision, don't know what to do")}else if(c.ab==Q.ea)return{pa:!0,X:c.X,F:c.F,yc:!0,mi:d};return{}}
function Og(a,b,c,d){a.debug&&K.log("GenBlockedResponse. url=",b.url,", details=",b,", info=",d);if("main_frame"==b.type||"sub_frame"==b.type||"unsure_frame"==b.type){var e=Object.assign({},d);e.context=b.type;for(var f=c.map(function(n){return jf(a.i.Aa,n)}).join(","),g={dynta:"text",dynab:"wellness",dld:"image",dynia:"image",dyngm:"game",rekog:"image",dynva:"video"},h={},l=t(d.L.split(",")),m=l.next();!m.done;m=l.next())m=m.value,g[m]&&(h[g[m]]=1);0<Object.keys(h).length&&(f+=" (detected by real-time "+
Object.keys(h).join(",")+" analysis)");!e.X&&0<f.trim().length&&(e.X="blocked by category: "+f);g=d?d.Ba?d.Ba:"":"";f=a.i.policy.uf(b.url,g,f,c,!0,d.policy);if(a.i.runtime.Lg()||a.i.policy.Sg()||88==Q.platform)return h=!1,"sub_frame"!=b.type&&"unsure_frame"!=b.type||1!=c.length||117!=c[0]||(K.log("[FLT] Social network plugin:",b.url),h=!0),"ad"==d.L||h||(Yh(a.i.I,c,b.url,e),a.i.policy.Zg(b.url,g)),{redirectUrl:f};vh(a.i.G,f).then(function(){}).catch(function(){a.debug&&K.log("filter siteBlockedWithFailedLogin: "+
b.url+", "+c);e.X="site is blocked due to failed login";Yh(a.i.I,c,b.url,e)});return{redirectUrl:b.url}}return"image"==b.type?{redirectUrl:"about: blank"}:{redirectUrl:"data:,"}}
function Gj(a,b){var c;if(c=a.i.Bq)a:{try{if(!0===a.i.Bq.i.policy.Vj()){var d=new URL(b);if("www.youtube.com"===d.hostname||"m.youtube.com"===d.hostname||"youtubei.googleapis.com"===d.hostname||"youtube.googleapis.com"===d.hostname||"www.youtube-nocookie.com"===d.hostname){d.hostname="restrictmoderate.youtube.com";c={Oc:d.toString()};break a}}}catch(e){K.error("Restrict Youtube by DNS error.",b,e)}c=void 0}if((a=c)&&a.Oc)return{proxyUrl:a.Oc}};function Kj(a){var b=this;this.i=a;this.h;this.debug=!1;Lj(this);this.i.setInterval(function(){Lj(b)},36E5)}
function Lj(a){var b,c,d,e,f,g,h,l;J(function(m){switch(m.h){case 1:if(a.i.disabled)return m.return();if(a.i.runtime.getAuthToken()){m.m(2);break}return y(m,new Promise(function(n){function q(){a.i.H.removeListener(q);n()}a.i.H.addListener(q,["postUserSignedIn","customerSignedIn"])}),2);case 2:b=Q.Yb+Te(a.i)+"/GetOverrideList",c=3;case 4:if(a.i.Yc){m.m(5);break}if(a.i.disabled){m.m(5);break}C(m,6);e={version:"1.0",auth:a.i.runtime.getAuthToken()};if(!e.auth)throw"auth token not found";f={method:"POST",
body:JSON.stringify(e)};return y(m,fetch(b,f),8);case 8:return g=m.j,y(m,g.json(),9);case 9:h=m.j;a.debug&&K.log("[GOL] Got override list.",h);d=U(Mj,h);"1.0"==d.pd?(d=JSON.parse(d.Uq),d=U(Mj,d)):(K.warn("Incompatible /GetOverrideList version: "+d.pd+", response ignored"),d=void 0);m.m(5);break;case 6:return l=H(m),K.warn("Error getting override list: "+l),y(m,new Promise(function(n){setTimeout(n,1E3*c)}),10);case 10:c=Math.min(2*c,60);m.m(4);break;case 5:d?d["1.0"]?(K.log("Got override list from server"),
Nj(a,d["1.0"])):K.warn("No compatible version of override list found. "):K.warn("Override list not found in response"),A(m)}})}
function Nj(a,b){a.h={};b=t(b);for(var c=b.next();!c.done;c=b.next()){c=c.value;try{c.url.startsWith("http://")||c.url.startsWith("https://")||(c.url="http://"+c.url);var d=new URL(c.url);c.ev=d;var e=psl.get(d.hostname)||d.hostname;a.h[e]||(a.h[e]=[]);a.h[e].push(c);a.debug&&K.log("[GOL] Add spec into domain ("+e+").",c)}catch(f){K.warn("Error processing "+JSON.stringify(c)+": "+f+", ignored"),K.warn(f.stack)}}}
function Lg(a,b){if(!a.h)return null;try{var c=new URL(b),d=psl.get(c.hostname)||c.hostname;if(!a.h[d])return null;for(var e=t(a.h[d]),f=e.next();!f.done;f=e.next()){var g=f.value;if("exact"==g.Kt){var h=g.url.substr(g.url.indexOf(":")+1),l=b.substr(b.indexOf(":")+1);if(g.ev.hostname==c.hostname&&h==l)return a.debug&&K.log("[GOL] Exact override category of ("+b+") to "+g.tg+"."),g.tg}else if(af(c,g.url))return a.debug&&K.log("[GOL] Smart override category of ("+b+") to "+g.tg+"."),g.tg}return null}catch(m){return K.warn("Error matching against override list: "+
m+": "+b),K.warn(m.stack),null}}
function af(a,b){try{var c=new URL(b);if(c.hostname!=a.hostname&&!a.hostname.endsWith("."+c.hostname))return!1;var d=c.pathname,e=d.endsWith("/")?d:d+"/",f=a.pathname,g=f.endsWith("/")?f:f+"/";if(d!=f&&e!=g&&!f.startsWith(e))return!1;if(c.searchParams)for(var h=t(c.searchParams.keys()),l=h.next();!l.done;l=h.next()){var m=l.value;if(a.searchParams.get(m)!=c.searchParams.get(m))return!1}return!0}catch(n){return K.warn("Error matching URL spec: "+n+", target: "+a.href+", spec: "+b),K.warn(n.stack),
!1}}
function Gf(a,b){try{var c=new URL(b),d=a.hostname,e=c.hostname;e.startsWith("www.")&&(e=e.substring(4));d.startsWith("www.")&&(d=d.substring(4));if(e!==d||c.pathname!==a.pathname&&!("/"==c.pathname&&""==a.pathname||""==c.pathname&&"/"==a.pathname)||0==c.search.length&&0!=a.search.length||0!=c.search.length&&0==a.search.length)return!1;if(c.search&&a.search){var f=Object.fromEntries(c.searchParams),g=Object.fromEntries(a.searchParams);return Object.keys(f).length!==Object.keys(g).length?!1:Object.keys(f).every(function(h){return!!g[h]&&g[h]===
f[h]})}return!0}catch(h){return K.warn("Error exact matching URL spec: "+h+", target: "+a.href+", spec: "+b),K.warn(h.stack),!1}}function Oj(){S.call(this,{pd:"Version",Uq:"List",comment:"comment",url:"url",Kt:"matchAlgo",tg:"catId","1.0":"1.0"},"OverrideListRespObf")}x(Oj,S);var Mj=new Oj;function Pj(a){var b=this;this.i=a;this.debug="true"===this.i.s["debug.dtool.debug"];this.zg=(this.i.sa()||"/hapara"==Q.Mc)&&!this.i.bi();this.i.addListener(function(c,d,e){return b.onMessage(c,d,e)});this.i.H.addListener(function(c){Qj(b,c)},["videoDiagInfo","plantCookies0","trackAds0"]);try{12==Q.platform&&(this.i.Hc()?this.h=chrome.action:this.h=chrome.browserAction,99===Q.za?this.h.setPopup({popup:"debugTool/diagFam.html"}):12===Q.za&&this.h.setPopup({popup:"debugTool/diag.html"}))}catch(c){K.error("In DebugTool, setPopup failed: "+
c),K.error(c.stack)}}function Rj(a,b,c){12==Q.platform&&a.h.setIcon({tabId:c,path:"icons/"+b},function(){setTimeout(function(){a.h.setIcon({tabId:c,path:"icons/128.png"})},100)})}
Pj.prototype.onMessage=function(a,b,c){var d=this;if("debugTool"==a.recipient)if(b=this.i,"getDiagInfo"==a.type)try{var e=b.policy.jp(),f=b.policy.lp(),g=e&&0!=e.length?e:f;this.debug&&K.log("method="+b.policy.Gc().method+"; groups="+e);var h={disabled:b.Zl,zg:this.zg,runtime:{Va:b.runtime.va(),username:b.runtime.env.username,tn:f,groups:e,group:g,ba:b.runtime.env.ba,version:b.runtime.ob(),uuid:b.runtime.env.uuid},policy:{F:b.disabled?"Filter disabled":b.policy.Ib(),vb:Ze(b.policy),qj:b.La&&Sj(),
Zb:b.policy.$b||"Unknown",ct:b.policy.kp(),zf:qf(b.policy),Bh:cf(b.policy),Il:b.policy.Ig()},sc:{N:b.sc.Ao.Ss(),model:b.sc.Ea?b.sc.Ea.Na().version:"none",jf:ge(b.runtime,"dvaSensi")},ra:{hf:ge(b.runtime,"diaSensi")},Vd:{yg:ge(b.runtime,"dtaSensi")},debug:{en:b.s["debug.serverGroup"]||Te(b),gq:b.s["debug.serverGroupConsole"]||(void 0===b.s["debug.serverGroupConsole"]?Q.dn:b.s["debug.serverGroupConsole"])},$g:{sp:b.La&&Sj(),qp:b.La&&b.La.dc&&b.La.dc.isConnected()?"connected":"disconnected",Uu:Oi?Oi.map(function(n){return n.R+
": "+n.mode}).join(", "):"none",Xc:b.La&&b.La.Xc}};12==Q.za?h.G={Lu:!de(b.runtime)&&b.policy.Gc()&&"gsuite"==b.policy.Gc().method,Ht:uh,zd:b.G.zd}:h.G={mode:Sc(this.i)?"active":"anon",qu:this.i.policy.M.pp};c(h)}catch(n){K.error(n),c({})}else if("refreshPolicy"==a.type)Sb(b.policy);else if("switchUser"==a.type)de(b.runtime)||b.G.jd(),c("ok");else{if("runDevCommand"==a.type)return Tj(this,a.data).then(function(n){c(n)}).catch(function(n){c({error:n})}),!0;if("runBatchCommand"==a.type)return Uj(this,
a.data).then(function(n){return(new Promise(function(q){var u,r,p,v,w;return J(function(z){switch(z.h){case 1:u=[],r=t(n),p=r.next();case 2:if(p.done){z.m(4);break}v=p.value;return y(z,Tj(d,v),5);case 5:w=z.j;u.push(w);p=r.next();z.m(2);break;case 4:q(u),A(z)}})})).then(function(q){c({results:q})}).catch(function(q){return Promise.reject(q)})}).catch(function(n){if("object"==typeof n)try{n=n.toString()}catch(q){n=JSON.stringify(n)}c({error:n})}),!0;if("generateDiag"==a.type)try{var l={time:new Date,
auth:b.runtime.getAuthToken(),cname:b.policy.$b||"Unknown",uname:b.runtime.env.username,version:b.runtime.ob(),plan:b.policy.M.pp,rule:b.disabled?"Filter disabled":b.policy.Ib()},m=JSON.stringify({info:l,logs:b.console.Lj()},null,2);c({results:m})}catch(n){c({error:n})}}};
function Uj(a,b){var c,d,e,f;return J(function(g){switch(g.h){case 1:if(a.j){g.m(2);break}return y(g,a.i.Tb.vf(Q.Jd+"debugTool/pubKey.txt"),3);case 3:return c=g.j,d=a,y(g,c.text(),4);case 4:d.j=g.j;case 2:try{if(!KJUR.jws.JWS.verifyJWT(b,a.j,{alg:["RS256"]}))throw"Invalid support command";e=new KJUR.jws.JWS;e.parseJWS(b);f=JSON.parse(e.parsedJWS.payloadS);return g.return(U(tb,f.cmds))}catch(h){throw"Invalid support command";}}})}
function Tj(a,b){var c,d,e,f,g,h;return J(function(l){if("showLogs"==b.cb)return l.return({Bp:a.i.console.Lj(),action:"showLogs"});if("setDebugFlags"==b.cb){c=a.i.console;d={};if(b.Lh){e=[];f=t(b.Lh.split(","));for(g=f.next();!g.done;g=f.next())h=g.value,h=h.trim(),Qb(c,h,!0,!1).error&&e.push(h);0<e.length&&(d.cz="Unknown modules: "+e.join(", "))}b.vm&&(c.i.s["debug.dCon.logAtStart"]=b.Lh||"");return l.return(d)}"logoutCustomer"==b.cb?a.i.G.wi("customer logout from d popup"):"clearLocalStorage"==
b.cb?a.i.s.clear():"unlockDevArea"==b.cb?a.zg=!1:"setServerPath"==b.cb?(b.path&&0!=b.path.length?a.i.s["debug.serverGroup"]=(b.path.startsWith("/")?"":"/")+b.path:delete a.i.s["debug.serverGroup"],b.Kh&&0!=b.Kh.length?a.i.s["debug.serverGroupConsole"]=(b.Kh.startsWith("/")?"":"/")+b.Kh:delete a.i.s["debug.serverGroupConsole"]):"setIAEngine"==b.cb&&(a.i.runtime.ic.ls=b.yg,a.i.runtime.ic.ds=b.hf,a.i.runtime.ic.ms=b.jf);A(l)})}
function Qj(a,b){if("videoDiagInfo"==b.type){var c=b.data;"localFrameResult"==c.kn?Rj(a,"video-l-"+("ok"==c.label?"ok":"bad")+".png",c.tabId):"cloudFrameResult"==c.kn&&Rj(a,"video-c-"+("ok"==c.label?"ok":"explicit"==c.label?"exp":"sug")+".png",c.tabId)}else if("plantCookies0"==b.type||"trackAds0"==b.type)a.debug&&K.log("plantCookies0 type="+b.type+" domain="+b.data.domain+"; tabId="+b.data.tabId),c="plantCookies0"==b.type?{type:"plantCookies",data:{domain:b.data.domain,isBlockCookie:a.i.policy.Df()}}:
{type:"trackAds",data:{domain:b.data.domain,isBlockAds:a.i.policy.De()}},chrome.tabs.sendMessage(b.data.tabId,c,{frameId:0},function(d){d&&12==Q.platform&&(d=""+(Object.keys(d.plantCookieSites).length+Object.keys(d.adSites).length),a.h.setBadgeText({tabId:b.data.tabId,text:d}))})};function Vj(){var a=this;this.ed=[];if(99==Q.platform||88==Q.platform)this.j=nodeMods.worker&&nodeMods.worker.workerData?nodeMods.worker.workerData.wr+"resources/":Tb+"resources/";new Ti(this.h(),function(b){return J(function(c){return c.return(Wj(a,b))})})}
Vj.prototype.h=function(){function a(){}x(a,kg);a.prototype.sendMessage=function(b){12==Q.platform?postMessage(b):(99==Q.platform||88==Q.platform)&&nodeMods.worker.parentPort.postMessage(b)};a.prototype.Tf=function(b){if(12==Q.platform)onmessage=function(c){b(c.data)};else if(99==Q.platform||88==Q.platform)nodeMods.worker.parentPort.on("message",function(c){b(c)})};return new a};
function Wj(a,b){var c,d,e,f,g,h,l,m,n,q;return J(function(u){switch(u.h){case 1:c=b.data;C(u,2);if("isWebGLSupported"==b.type){if(a.l){u.m(17);break}n=a;return y(u,Zf(),18)}if("createEngine"==b.type)return d=new Yf(tf),a.ed.push(d),Q.wa||(a.j=b.data.xr),u.return({ac:a.ed.length-1});if("loadModel"==b.type)return Q.Hd=c.zs,l=a.ed[c.ac],y(u,l.ub(c.vr,c.Jc,function(r){var p,v;return J(function(w){if(1==w.h){p=r.substr(Q.Jd.length);p=a.j+p;if(12!=Q.platform){if(99==Q.platform||88==Q.platform)v=new fetch.Response(nodeMods.fs.readFileSync(p));
return w.m(2)}return y(w,fetch(p),3)}2!=w.h&&(v=w.j);return Q.Hd?w.return(jd(v)):w.return(v)})}),16);if("getEngineInfo"==b.type)return e=a.ed[c.ac],u.return(e.Na());if("warmUpModel"==b.type)return f=a.ed[c.ac],f.ih(),u.return("ok");if("predict"!=b.type)throw K.error("Unknown IAWorker command: "+b.type),Error("Unknown IAWorker command: "+b.type);g=a.ed[c.ac];return 12==Q.platform?y(u,g.Qd(c.inputs,c.ka),15):y(u,g.hc(c.inputs,c.ka),14);case 14:h=u.j;u.m(13);break;case 15:h=u.j;case 13:return u.return(h);
case 16:return m=u.j,u.return(m);case 18:n.l=u.j,K.log("Worker TF backend is "+tf.getBackend());case 17:return u.return(a.l);case 5:F(u,0);break;case 2:throw q=H(u),q.toString();}})}function Xj(){Vj.call(this)}x(Xj,Vj);Xj.prototype.h=function(){function a(){}x(a,kg);a.prototype.sendMessage=function(b){process.send(b)};a.prototype.Tf=function(b){process.on("message",function(c){b(c)})};return new a};
Q.Cg("__dld_iaw",function(a){Q.Jg(a);K=console;"undefined"!=typeof OffscreenCanvas&&(self.document={readyState:"complete",createElement:function(){return new OffscreenCanvas(640,480)}},self.window={screen:{width:640,height:480},atob:function(b){for(var c=[],d=0;d<arguments.length;++d)c[d]=arguments[d];return self.atob.apply(self,ca(c))},crypto:self.crypto});Q.Sj()?importScripts("/backlibs.js"):(importScripts("/lib/tf.min.js"),importScripts("/util/obfuscationUtils.js"),importScripts("/util/common.js"),
importScripts("/util/httpConnection.js"),importScripts("/dyncc/dldCNNModel.js"),importScripts("/dyncc/dynIAEngine.js"),importScripts("/util/RPC.js"),importScripts("/compat/platform.js"),importScripts("/compat/ext/platform.js"));K.log("Image analysis worker starting");new Vj});function Yj(){}k=Yj.prototype;k.ready=function(){return J(function(){throw Error("init() unimplemented");})};k.addListener=function(){throw Error("addListener() unimplemented");};k.ob=function(){throw Error("getVersion() unimplemented");};k.Hc=function(){return!1};k.vf=function(){return J(function(){throw Error("getBundledResource() unimplemented");})};k.Wh=function(){throw Error("getLocalStorage() unimplemented");};function Zj(){}var Va;Zj.prototype.ready=function(){return J(function(a){A(a)})};
function Z(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];Va.cj.apply(Va,ca(b))}Zj.prototype.cj=function(a){for(var b=0;b<arguments.length;++b);throw Error("sendMessage() unimplemented");};function ak(){}x(ak,Yj);k=ak.prototype;k.ready=function(){var a=this;return J(function(b){if(1==b.h){if(!a.Hc())return b.m(0);a.h=new bk;return y(b,a.h.init(),3)}a.s=ck(a.h);A(b)})};k.addListener=function(a){chrome.runtime.onMessage.addListener(a)};k.ob=function(){return chrome.runtime.getManifest().version};k.Hc=function(){return 3<=chrome.runtime.getManifest().manifest_version};k.vf=function(a){a=a.startsWith(Q.Jd)?a.substr(Q.Jd.length):a;a=chrome.runtime.getURL(a);return fetch(a)};
k.Wh=function(){return this.Hc()?this.s:window.localStorage};function dk(){K={log:window.console.log,warn:window.console.warn,error:window.console.error}}x(dk,Zj);dk.prototype.cj=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];chrome.runtime.sendMessage.apply(chrome.runtime,ca(b))};function bk(){}k=bk.prototype;
k.init=function(){var a=this,b;return J(function(c){if(1==c.h)return C(c,2),y(c,(new Promise(function(d,e){chrome.storage.local.get(null,function(f){if(chrome.runtime.lastError)return e(chrome.runtime.lastError);d(f)})})).then(function(d){a.h=d}),4);if(2!=c.h)return F(c,0);b=H(c);K.error("Cached local storage init error.",b);A(c)})};
function ck(a){return new Proxy(a,{get:function(b,c){return c in b?Reflect.get.apply(Reflect,arguments):b.getItem(c)},set:function(b,c,d){c in b?K.error("Cached local storage error. Cannot set own property.",c):b.setItem(c,d);return!0},deleteProperty:function(b,c){b.removeItem(c);return!0}})}k.key=function(a){var b=Object.keys(this.h);if(!(a>=b.length))return b[a]};k.getItem=function(a){return this.h[a]};
k.setItem=function(a,b){try{if(void 0==b)this.removeItem(a);else{"object"==typeof b?(K.error("Cached local storage: key: "+a+", value is an object: "+JSON.stringify(b)),b=JSON.stringify(b)):b=b.toString();this.h[a]=b;var c={};chrome.storage.local.set((c[a]=b,c))}}catch(d){K.error("Cached local storage set item error.",d)}};k.removeItem=function(a){try{delete this.h[a],chrome.storage.local.remove(a)}catch(b){K.error("Cached local storage remove item error.",b)}};
k.clear=function(){try{for(var a=Object.keys(this.h),b=t(a),c=b.next();!c.done;c=b.next())delete this.h[c.value];chrome.storage.local.clear()}catch(d){K.error("Cached local storage clear error.",d)}};ia.Object.defineProperties(bk.prototype,{length:{configurable:!0,enumerable:!0,get:function(){return Object.keys(this.h).length}}});function ek(){fk=new gk}var fk;x(ek,Yj);k=ek.prototype;k.ready=function(){return J(function(a){A(a)})};k.addListener=function(a){fk.addListener(a)};k.ob=function(){return Q.sb};k.vf=function(a){var b,c;return J(function(d){c=a.substr(Q.Jd.length);b=c.endsWith(".json")?"application/json":c.endsWith(".js")?"text/javascript":c.endsWith(".txt")?"text/plain":"application/octet-stream";return d.return(fetch("data:"+b+";base64,"+window.bundledResources[c]))})};k.Wh=function(){return window.localStorage};
function gk(){var a=this;window._dldmsg_onMessage=function(b){hk(a,b)};this.j=[];this.h={};this.Cf=void 0}gk.prototype.addListener=function(a){this.j.push(a)};
function hk(a,b){try{b=JSON.parse(b)}catch(q){K.error("Error decoding message JSON: "+q);K.error(b);return}var c=b.nativecallid,d=b.napaframeid,e=b.id,f=c+"-"+d+"-"+e,g=b.message;g&&"messaging"==g.recipient&&"unitTest"==g.type&&K.warn("back-recv: "+c+" "+d+" "+e+" "+g.num);if((b=b.dinfo)&&a.Cf!=b.Cf){a.Cf=b.Cf;var h={recipient:"runtime",type:"deviceInfo",data:{deviceName:b.name+" ("+b.id+")",ba:[b.Cf]}},l=!1,m=t(a.j);for(b=m.next();!b.done;b=m.next()){b=b.value;if(l)break;b(h,void 0,function(q){q&&
q.ok&&(l=!0)})}l||(a.Cf=void 0)}h=!1;a.h[f]=!0;m=t(a.j);for(b=m.next();!b.done;b=m.next()){b=b.value;try{var n=b(g,void 0,function(q){if(a.h[f]){var u={nativecallid:c,napaframeid:d,id:e,response:q};delete a.h[f];q&&"messaging"==q.recipient&&"unitTest"==q.type&&K.warn("back-send: "+c+" "+d+" "+e+" "+q.num);q=JSON.stringify(u);window.webkit.messageHandlers.PersistentResponse.postMessage(q)}else throw delete a.h[f],Error("callback channel already closed");});h=h||!0===n}catch(q){K.error("Exception inside onMessage(): "+
q),K.error(q.stack)}}!h&&a.h[f]&&(g={nativecallid:c,napaframeid:d,id:e,response:void 0},delete a.h[f],window.webkit.messageHandlers.PersistentResponse.postMessage(JSON.stringify(g)))};function ik(a){this.j={};this.l=this.init();this.debug=a.debug;this.u=a.u}var Tb,Yd,cg,jk,kk,lk,mk;
function nk(a,b){b=void 0===b?"":b;var c,d,e,f,g,h,l,m,n,q;return J(function(u){c=Tb+nodeMods.path.sep+"resources";d=nodeMods.fs.readdirSync(c+b,{withFileTypes:!0});e=t(d);for(f=e.next();!f.done;f=e.next())if(g=f.value,g.isDirectory())nk(a,b+nodeMods.path.sep+g.name);else{h=b+"/"+g.name;h=h.substr(1);try{l=nodeMods.fs.readFileSync(c+nodeMods.path.sep+h),m=h,"\\"==nodeMods.path.sep&&(m=m.replace(/\\/g,"/")),n=nodeMods.crypto.createHash("md5"),q=n.update(l).digest("hex"),a.j[m]={Er:l,hash:q}}catch(r){K.error("Error loading resource "+
h+": "+r)}}A(u)})}
ik.prototype.yf=function(a,b,c){var d=this,e,f,g,h;return J(function(l){e=a.url;d.trace&&K.log("["+d.u+"][ScriptServer]("+c+") Handle http request. url="+e+".");return"/health"==e||"/HealthCheck"==e?(b.statusCode=200,b.statusText="ok",b.write("script server ok: "+Q.sb+"\n"),b.end(),l.m(0)):e.startsWith("/resources/")?(f=e.substr(11),(g=d.j[f])?a.headers["if-none-match"]==g.hash?(b.statusCode=304,b.statusText="Not modified",b.setHeader("access-control-allow-origin","*"),b.setHeader("content-length","0")):
(b.statusCode=200,b.setHeader("access-control-allow-origin","*"),b.setHeader("etag",g.hash),f.endsWith(".js")?(h=88==Q.platform&&Q.sa?300:90,b.setHeader("cache-control","max-age="+h),b.setHeader("content-type","text/javascript")):b.setHeader("cache-control","max-age=2592000"),b.write(g.Er)):(b.statusCode=404,b.statusText="Not found"),b.end(),l.m(0)):d.im?y(l,d.im(a,b,c),0):(K.error("http handler not set up yet"),b.writeHead(404,"Not found"),b.end(),l.m(0))})};
ik.prototype.init=function(){var a=this,b,c,d,e,f,g,h,l,m,n;return J(function(q){switch(q.h){case 1:return y(q,nk(a),2);case 2:b={};c=!1;d=nodeMods.commander;d.crt&&d.key&&(b.key=nodeMods.fs.readFileSync(d.key),b.cert=nodeMods.fs.readFileSync(d.crt),c=!0);e=kk;if(d.port)f=d.port;else if(!d.noReusePort)try{g=nodeMods.fs.readFileSync(e),g=JSON.parse(g),f=g.port,K.log("runtime.info port found: "+f)}catch(u){K.error("Parsing runtime.info: "+u),f=0}h=function(u,r){var p,v;return J(function(w){if(1==w.h)return C(w,
2),p=Math.floor(1E4*Math.random()),y(w,a.yf(u,r,p),4);if(2!=w.h)return w.return(w.j);v=H(w);K.error("[SS] Handle http request error: "+v);r.statusCode=500;r.write(v.toString());r.end();A(w)})};l=function(u){return new Promise(function(r,p){a.h=c?nodeMods.https.createServer(b,h):nodeMods.http.createServer(h);a.h.listen({host:Q.features.proxy.zr?"127.0.0.1":"0.0.0.0",port:u},function(){var v=a.h.address().port;a.o=(c?"https":"http")+"://localhost:"+v;K.log("Server url is "+a.o);e&&nodeMods.fs.writeFileSync(e,
JSON.stringify({pid:process.pid,port:v})+"\n");r()}).on("error",function(v){a.h.close();p(v)})})};C(q,3);return y(q,l(f),5);case 5:Q.features.La.enabled&&(m=new WebSocket.Server({server:a.h,clientTracking:!0,maxPayload:4194304}),m.on("connection",function(u,r){a.zq&&a.zq(u,r)}));F(q,0);break;case 3:if(n=H(q),"EADDRINUSE"==n.code&&d.reusePort)if(K.warn("Port "+f+" already in use ..."),d.port)process.exit(1),q.m(0);else return K.log("Will try a random port ... "),y(q,l(0),0);else K.error("Cannot start server: "+
n),process.exit(1),q.m(0)}})};function ok(a){this.options=a;(this.debug=a.debug)&&nodeMods.fs.writeFileSync(lk,JSON.stringify({pid:process.pid,user:nodeMods.os.userInfo().username}));if(a.Fl)try{this.h=nodeMods.fs.readFileSync(a.Fl)}catch(b){K.error("Error loading CA cert from "+a.Fl+": "+b)}this.connect()}
ok.prototype.connect=function(){var a=this,b,c,d,e,f,g,h,l,m;return J(function(n){switch(n.h){case 1:c=b=2,d={};case 2:C(n,4);e=nodeMods.fs.readFileSync(kk);f=JSON.parse(e);g=f.port;if(!g)throw Error("Script server port not found!");d.Ni="wss://localhost:"+g+"/ss";h=a;return y(n,new Promise(function(q){return function(u,r){var p=new WebSocket(q.Ni,{ca:a.h});p.readyState==WebSocket.OPEN&&u(p);p.on("open",function(){u(p)});p.on("error",function(v){r(v)})}}(d)),6);case 6:h.fa=n.j;K.log("Connected to "+
d.Ni);l=function(q){return J(function(u){if(1==u.h)return q?K.error("WebSocket error: "+q):K.error("WebSocket unexpectedly closed"),a.fa.close(),a.fa=void 0,y(u,new Promise(function(r){setTimeout(r,1E3*b)}),2);a.connect();A(u)})};a.fa.on("error",l);a.fa.on("close",l);a.fa.on("message",function(q){a.onMessage(q)});c=b;n.m(0);break;case 4:return m=H(n),K.error("web socket connect: "+m),y(n,new Promise(function(q){setTimeout(q,1E3*c)}),7);case 7:c=Math.min(2*c,15);case 5:d={Ni:d.Ni},n.m(2)}})};
ok.prototype.onMessage=function(a){var b=this,c,d,e;return J(function(f){switch(f.h){case 1:C(f,2);a=JSON.parse(a);if("takeSs"!=a.type){K.warn(JSON.stringify(a));f.m(4);break}return y(f,nodeMods.screenshot({format:"jpg"}),5);case 5:c=f.j,d=JSON.stringify({type:"ss",data:{image:c.toString("base64"),timestamp:Date.now()}}),b.fa.send(d);case 4:F(f,0);break;case 2:e=H(f),K.error("onMessage: "+e),A(f)}})};
function pk(){K.log("Version: "+Q.sb);for(var a=["unhandledRejection","uncaughtException"],b=t(a),c=b.next();!c.done;c=b.next())process.removeAllListeners(c.value);process.on("uncaughtException",function(d,e){K.error("Uncaught exception: ",d,"origin:",e);d.stack&&K.error(d.stack)});process.on("unhandledRejection",function(d,e){K.error("Unhandled rejection at: ",e,"reason: ",d);d.stack&&K.error(d.stack)});process.on("newListener",function(d,e){a.includes(d)&&setTimeout(function(){K.warn("Removing 3rd-party listener on process."+
d+": "+e);process.removeListener(d,e)},500)});Tb=nodeMods.path.dirname(process.argv[1])+nodeMods.path.sep;K.log("Install path is "+Tb);nodeMods.commander.option("-p, --port <number>","port number",0,parseInt).option("--no-reuse-port","do not attempt to reuse the port in runtime.info").option("--info-file <path>","full pathname of info file, default to runtime.info in the same directory as main.js","").option("--user-session <path>","full pathname of user session file, default to userSession.json in the same directory as main.js",
"").option("--lsdb <path>","full pathname of ls.db file, default to ls.db in the same directory as main.js","").option("--mode <mode>","script, ia, or ss","script").option("--debug","use screenshot agent debug mode").option("--ss-config <path>","full pathname of screenshot config file, default to ssConfig.json in the same directory as main.js","").option("--ca <path>","our own root CA cert to load in screenshot agent").option("--crt <crtFile>","SSL cert file").option("--key <keyFile>","SSL key file").parse(process.argv);
b=nodeMods.commander;Yd=b.userSession||Tb+"userSession.json";K.log("User session file path: "+Yd);mk=b.lsdb||Tb+"ls.db";K.log("Local storage file path: "+mk);lk=b.ssConfig||Tb+"ssConfig.json";K.log("Screenshot config file path: "+lk);kk=b.infoFile||Tb+"runtime.info";K.log("Runtime info file path: "+kk);cg=!0;return"ss"==b.mode?(K.log("Starting as screenshot agent ..."),new ok({debug:b.debug,Fl:b.ca}),!1):"ia"==b.mode?(K.log("Starting as IA process ..."),new Xj,!1):!0};function qk(a,b){this.debug=b.debug;this.u=b.u;this.C=b.C;this.h=a;this.Kc=this.Jn();this.s=this.Eo()}x(qk,Yj);k=qk.prototype;k.ready=function(){return J(function(a){A(a)})};k.Jn=function(){return new rk({debug:this.debug,u:this.u,C:this.C})};k.Eo=function(){return new sk};k.addListener=function(a){this.Kc.addListener(a)};k.ob=function(){return Q.sb};
k.vf=function(a){var b=this,c,d;return J(function(e){if(1==e.h)return c=a.startsWith(Q.Jd)?a.substr(Q.Jd.length):a,c=b.h+c,y(e,new Promise(function(f,g){nodeMods.fs.readFile(c,function(h,l){h?g(h):f(l)})}),2);d=e.j;return e.return(new fetch.Response(d))})};k.Wh=function(){return this.s};k.destroy=function(){delete tk[this.s]};
function uk(a){qk.call(this,Tb+"resources/",a);var b=this;jk.im=function(c,d,e){var f;return J(function(g){if(1==g.h)return C(g,2),y(g,b.Kc.yf(c,d,e),4);if(2!=g.h)return F(g,0);f=H(g);K.error("handleHttpRequest: "+f);K.error("handleHttpRequest: "+f.stack);try{d.statusCode=500,d.write(f.stack),d.write("\n")}catch(h){}finally{d.end()}A(g)})};this.ia=new vk;this.aq=new wk;jk.zq=function(c,d){var e;return J(function(f){try{if(e=new URL(d.url,"https://foo/"),"/tab"==e.pathname)xk(b.ia,c);else if("/ss"==
e.pathname)yk(b.aq,c,d);else throw Error("Not found: "+e.pathname);}catch(g){c.send(JSON.stringify({error:g.toString()})),c.close()}A(f)})}}x(uk,qk);uk.prototype.Eo=function(){return new zk(mk)};uk.prototype.Ad=function(){return this.ia};function rk(a){this.aa=[];this.debug=a.debug;this.u=a.u;this.C=a.C}rk.prototype.addListener=function(a){this.aa.push(a)};
function Ak(a,b,c,d){b.statusCode=200;b.setHeader("content-type","application/json");b.setHeader("access-control-allow-origin","*");c&&b.write(c);b.end();a.trace&&K.log("["+a.u+"]["+a.C+"][ProxyBackend.Messaging]("+d+") Write response. Body="+c+".")}
rk.prototype.yf=function(a,b,c){var d=this,e,f,g,h,l;return J(function(m){switch(m.h){case 1:e=a.url;if("/wrq/onBeforeRequest"==e)return C(m,6),y(m,Bk(a),8);if("/sendMessage"!=e){b.statusCode=404;b.setHeader("access-control-allow-origin","*");b.end();m.m(0);break}return y(m,d.sendMessage(a,b,c),0);case 8:g=m.j;f=JSON.parse(g);d.trace&&K.log("["+d.u+"]["+d.C+"][ProxyBackend.Messaging]("+c+") On before request. Body="+g+".");F(m,7);break;case 6:return h=H(m),K.error("["+d.u+"]["+d.C+"][ProxyBackend.Messaging]("+
c+") onBeforeRequest get request body error: "+h),b.statusCode=400,b.end(),m.return();case 7:return l={recipient:"filterBackend",type:"onBeforeRequest",data:{url:f.url,Up:f.referer}},y(m,d.Nf(a,b,{},l,function(n,q){return q&&q.response},c),0)}})};function Bk(a){return J(function(b){return b.return(new Promise(function(c,d){var e="";a.on("data",function(f){e+=f});a.on("end",function(){c(e)});a.on("error",function(f){d(f)})}))})}
rk.prototype.sendMessage=function(a,b,c){var d=this,e,f,g,h,l;return J(function(m){switch(m.h){case 1:return C(m,2),y(m,Bk(a),4);case 4:g=m.j;e=JSON.parse(g);f=e.relay_debug_req_sn;d.trace&&K.log("["+d.u+"]["+d.C+"][ProxyBackend.Messaging]("+c+")("+f+") Send message. Message="+g+".");F(m,3);break;case 2:return h=H(m),K.error("["+d.u+"]["+d.C+"][ProxyBackend.Messaging]("+c+") sendMessage get request body error: "+h),b.statusCode=400,b.setHeader("access-control-allow-origin","*"),b.end(),m.return();
case 3:if(!(e.message&&"proxy"==e.message.recipient||e.version&&e.version==Q.sb))return Ak(d,b,JSON.stringify({error:"proxy version mismatch: server is "+Q.sb}),c),b=void 0,m.return();l=e.envelope;(e=e.message||{},"messaging"==e.recipient)&&"unitTest"==e.type&&K.warn("back-recv: "+e.num);return y(m,d.Nf(a,b,l,e,void 0,f?f:c),0)}})};
function Ck(a){var b={recipient:"runtime",type:"cloudClientIpChanged"};J(function(c){return 1==c.h?y(c,new Promise(function(d){for(var e=!1,f=t(a.aa),g=f.next();!g.done;g=f.next()){g=g.value;try{1!=g(b,void 0,function(h){d(h)})?d(void 0):e=!0}catch(h){K.error("["+a.u+"]["+a.C+"][ProxyBackend.Messaging] synthesizeSendMessage exception: "+h),K.error(h.stack)}}e||d(void 0)}),2):c.return(c.j)})}
function Dk(a,b){var c=a.wd;a.wd=b;return a.wd!=c?(K.log("["+a.u+"]["+a.C+"][ProxyBackend.Messaging] Set client IP. clientIp="+a.wd+"."),!0):!1}
rk.prototype.Nf=function(a,b,c,d,e,f){var g=this,h,l,m,n,q,u,r,p,v,w;return J(function(z){h=d;l=d.recipient||h.recipient;m=d.type||h.type;"userActs"==l&&"usageReport"==m&&(d.envelope={userAgent:a.headers["user-agent"]});c&&c.clientIp&&Dk(g,c.clientIp)&&Ck(g);c&&(n={tab:{id:c.tabId}});g.trace&&K.log("["+g.u+"]["+g.C+"][ProxyBackend.Messaging]("+f+") Process message. Type="+m+", recipient="+l+", clientIp="+(c&&c.clientIp));q=!1;u=t(g.aa);for(r=u.next();!r.done;r=u.next()){p=r.value;try{v=p(d,n,function(B){if(b)B&&
"messaging"==B.recipient&&"unitTest"==B.type&&K.warn("back-send: "+B.num),B={response:B},e&&(B=e(b,B)),g.trace&&K.log("["+g.u+"]["+g.C+"][ProxyBackend.Messaging]("+f+") Process message response. "+Gc(B)+"."),B=JSON.stringify(B),Ak(g,b,B,f),b=void 0;else throw Error("callback channel already closed");}),q=q||!0===v}catch(B){K.error("["+g.u+"]["+g.C+"][ProxyBackend.Messaging]("+f+") Exception inside onMessage: "+B),K.error(B.stack)}}!q&&b&&(w={response:void 0},e&&(w=e(b,w)),Ak(g,b,JSON.stringify(w),
f),b=void 0);A(z)})};function vk(){this.tabs={};this.j={};this.debug=!1}k=vk.prototype;k.addEventListener=function(a,b){this.j[a]=b};
function xk(a,b){function c(){for(var d=t(Object.keys(a.tabs)),e=d.next();!e.done;e=d.next())if(e=e.value,a.tabs[e].fa==b){(d=a.j.removed)&&d(e);b.close();a.debug&&K.log("[PBTM] Removing tab ("+a.tabs[e].Ld.url+").");delete a.tabs[e];a.h==e&&(a.h=void 0);return}K.warn("Cannot find websocket with close/error in table map")}b.on("message",function(d){try{d=JSON.parse(d);a.debug&&K.log("[PBTM] Received message.",d);var e=d.data;if("tabInfo"==d.type){var f=e.id;if(!f)throw Error("No tab ID in message");
if(!a.tabs[f]){a.tabs[f]={fa:b};var g=a.j.created;if(g)try{g(f)}catch(q){}}a.tabs[f].Ld=e;e.active&&(a.h=f);var h=a.j.updated;h&&h(f,{url:e.url},e)}else if("activated"==d.type){var l=e.id;if(!l)throw Error("No tab ID in message");a.tabs[l]||(a.tabs[l]={fa:b});a.h=l;var m=a.j.activated;m&&m({tabId:l})}else if("proxyFrontendMessage"===d.type){var n=a.j.proxyFrontendMessage;n&&n({Qg:d.Qg})}}catch(q){K.error("handleWs: "+q)}});b.on("error",c);b.on("close",c)}
k.cc=function(){var a=this,b,c,d,e,f;return J(function(g){b=[];c=t(Object.keys(a.tabs));for(d=c.next();!d.done;d=c.next())e=d.value,f=Object.assign({},a.tabs[e].Ld),f.active=a.h==e,b.push(f);return g.return(b)})};k.Vh=function(){var a=this;return J(function(b){return a.h&&a.tabs[a.h]?b.return(a.tabs[a.h].Ld):b.return({id:"unknown",url:"about:blank",title:"unknown"})})};k.remove=function(a){this.Mb(a,{type:"close"})};
k.update=function(a,b){b=void 0===b?{}:b;b.active&&this.Mb(a,{type:"focus"});b.url&&this.Mb(a,{type:"replace",data:{url:b.url}})};k.Mb=function(a,b){this.tabs[a]?(this.debug&&K.log("[PBTM] Sending message to tab ("+this.tabs[a].Ld.url+").",b),this.tabs[a].fa.send(JSON.stringify(b))):K.warn("[PBTM] The tab ID does not exist.",a)};
function Ek(a,b){try{if(a.tabs[a.h].fa.readyState==WebSocket.OPEN)a.Mb(a.h,b);else throw Error("sendToActiveTab: No ws conn found for active tab");}catch(e){K.warn("sendToActiveTab: failed to send to active tab: "+b.type);for(var c=t(Object.keys(a.tabs)),d=c.next();!d.done;d=c.next()){d=d.value;try{if(a.tabs[d].fa.readyState==WebSocket.OPEN){a.Mb(d,b);K.log("sendToActiveTab: sent to non-active tab: "+b.type+", "+d);break}}catch(f){}}}}k.create=function(a){Ek(this,{type:"create",data:a})};
k.alert=function(a){Ek(this,{type:"alert",data:{text:a}})};function sk(){tk[this]={}}k=sk.prototype;k.key=function(a){var b=Object.keys(this);if(!(a>=b.length))return b[a]};k.getItem=function(a){return this[a]};k.setItem=function(a,b){void 0==b?this.removeItem(a):"object"==typeof b?(K.error("Proxy local storage: key: "+a+", value is an object: "+JSON.stringify(b)),this[a]=JSON.stringify(b)):this[a]=b.toString();this.Zi()};k.removeItem=function(a){delete this[a];this.Zi()};
k.clear=function(){for(var a=t(Object.keys(this)),b=a.next();!b.done;b=a.next())delete this[b.value];this.Zi()};k.Zi=function(){};ia.Object.defineProperties(sk.prototype,{length:{configurable:!0,enumerable:!0,get:function(){return Object.keys(this).length}}});var tk={};function Fk(a){tk[this]={};var b=this;a=nodeMods.path.resolve(a);tk[this].path=a;this.Vn();Wc(function(){b.Wn()},1E3)}x(Fk,sk);
Fk.prototype.Vn=function(){var a=tk[this];try{Object.assign(this,JSON.parse(nodeMods.fs.readFileSync(a.path)))}catch(b){K.error("Local storage file "+a.path+" is corrupt"),this.clear()}};Fk.prototype.Wn=function(){var a=tk[this];a.Bj&&nodeMods.fs.writeFile(a.path,JSON.stringify(this),void 0,function(b){b?K.error("Error writing to local storage: "+a.path+": "+b):a.Bj=!1})};Fk.prototype.Zi=function(){tk[this].Bj=!0};function zk(a){Fk.call(this,a)}x(zk,Fk);
zk.prototype.Vn=function(){var a=tk[this];if(!a.Hb){var b=tk[this];b.Hb=Buffer.from("e5edd167afeee293a10f0ace14bd2edff8dd8fc5b2874de696979559e5f0e58f","Hex");b.Sh=Buffer.from("e0c4f4cb7be18117c37baf6c5e435718","hex")}b=t([a.path,a.path+".bak"]);for(var c=b.next();!c.done;c=b.next()){c=c.value;try{var d=nodeMods.fs.readFileSync(c),e=nodeMods.crypto.createDecipheriv("aes-256-cbc",a.Hb,a.Sh),f=e.update(d);f=Buffer.concat([f,e["final"]()]);Object.assign(this,JSON.parse(f));K.log("Local storage data loaded from "+
c);break}catch(g){K.error("Local storage file "+c+" is corrupt: "+g),this.clear()}}};
zk.prototype.Wn=function(){var a=tk[this];if(a.Bj){a.Hb||this.Cx();try{nodeMods.fs.existsSync(a.path)&&nodeMods.fs.renameSync(a.path,a.path+".bak")}catch(d){K.warn("Error renaming ls.db to backup file: "+d)}var b=nodeMods.crypto.createCipheriv("aes-256-cbc",a.Hb,a.Sh),c=b.update(JSON.stringify(this));c=Buffer.concat([c,b["final"]()]);nodeMods.fs.writeFile(a.path,c,void 0,function(d){d?K.error("Error writing to local storage: "+a.path+": "+d):a.Bj=!1})}};function wk(){this.j=new Qc}
function yk(a,b,c){var d,e,f;J(function(g){if(1==g.h)return C(g,2),K.log("Remote SS conn from port: "+c.socket.remotePort),y(g,Gk(c.socket.remotePort),4);if(2!=g.h){d=g.j;K.log("Remote SS pid: "+d);e=nodeMods.fs.readFileSync(lk);e=JSON.parse(e);if(d!=e.pid)throw Error("Pid "+d+" not authorized to connect");a.h&&a.h.close();a.h=b;b.on("message",function(h){a.onMessage(h)});b.on("error",function(h){K.warn("Screenshot agent conn error: "+h);a.h&&a.h.close();a.h=void 0});b.on("close",function(){K.warn("Screenshot agent conn closed");
a.h&&a.h.close();a.h=void 0});return F(g,0)}f=H(g);K.error("handleWs ss: "+f);b.send(JSON.stringify({type:"error",data:{message:f.toString()}}));b.close();A(g)})}wk.prototype.onMessage=function(a){a=JSON.parse(a);"ss"==a.type&&(this.screenshot=a.data,this.j.signal())};
function Hk(a){var b;return J(function(c){if(1==c.h){if(!a.h)throw Error("No connected screenshot agent");a.screenshot=void 0;a.h.send(JSON.stringify({type:"takeSs"}));if(a.screenshot)return c.m(2);b=new Promise(function(d,e){setTimeout(function(){e(Error("timed out"))},800)});return y(c,Promise.race([a.j.wait(),b]),2)}return c.return(a.screenshot)})}
function Gk(a){var b,c,d,e;return J(function(f){if(1==f.h){if("win32"==process.platform)return d='netstat -ano |findstr ESTABLISHED | findstr ":'+a+'.*:[^:]*$"',y(f,new Promise(function(g,h){nodeMods.child_process.execFile("powershell.exe",[d],function(l,m,n){if(l)h(l);else if(m){l=m.split("\r\n");for(m=0;m<l.length;m++)""==l[m].trim()&&(l.splice(m,1),m--);1!=l.length?h("Can't get process id: "+l.length+" lines of filtered netstat output"):g(l[0].split(/ +/)[5])}else n?h("stderr: "+n):h("empty powershell output")}).stdin.end()}),
6);if("darwin"!=process.platform)throw Error("getProcInfoFromSocket() unimplemented for "+process.platform);b="lsof -n -i4TCP:"+a+"| grep ':"+a+"->' | awk '{print $2}'";return y(f,new Promise(function(g,h){nodeMods.child_process.execFile("sh",["-c",b],function(l,m,n){if(l)h(l);else if(m){l=m.split("\n");for(m=0;m<l.length;m++)""==l[m].trim()&&(l.splice(m,1),m--);1!=l.length?h("Can't get process id: "+l.length+" lines of filtered lsof output\n"):g(l[0])}else n?h("stderr: "+n):h("empty lsof output")}).stdin.end()}),
5)}if(6!=f.h){if(c=f.j)return f.return(c);throw Error("No pid found for socket "+a);}if(e=f.j)return f.return(e);throw Error("No pid found for socket "+a);})};function Ik(a){var b=this;this.debug=Q.sa?!1:!0;this.i=a;a.addListener(function(c,d,e){return b.onMessage(c,d,e)});99==Q.za&&Jk(this)}
function Jk(a){var b,c,d,e,f;J(function(g){switch(g.h){case 1:b=Q.oc+"/family/getPubKey",c=5,d={};case 2:return C(g,4),e=d,y(g,ld(a.i.http,b),6);case 6:e.nd=g.j;if(!d.nd)throw Error("no response");d.nd=JSON.parse(d.nd);if(d.nd&&d.nd.error)throw Error(d.nd.error);a.h=d.nd.pubKey;a.h=a.h.trim();a.debug&&K.log("got familyPubKey="+a.h);return y(g,new Promise(function(h){return function(l){setTimeout(l,1E3*(h.nd.maxAge||86400))}}(d)),7);case 7:c=5;F(g,5);break;case 4:return f=H(g),K.error("/fam/getPubKey: "+
f),y(g,new Promise(function(h){setTimeout(h,1E3*c)}),8);case 8:c=Math.min(2*c,120);case 5:d={nd:d.nd},g.m(2)}})}
Ik.prototype.onMessage=function(a,b,c){if("proxy"==a.recipient)if(this.debug&&K.log("proxy got message: "+JSON.stringify(a)),"getProxyUpdates"==a.type){if(c){b=Q.Yb+Te(this.i)+"/updateProxy";var d=a.data;this.i.runtime.getAuthToken()&&(d.auth=this.i.runtime.getAuthToken());d.version&&(d.ver=d.version,delete d.version);a=this.i.runtime.env;a.uuid&&(d.uuid=a.uuid);d.proxytype=99===Q.za?"fam":"edu";0<Object.keys(d).length&&(b+="?"+Object.keys(d).map(function(e){return e+"="+encodeURIComponent(d[e])}).join("&"));
md(this.i.http,b).then(function(e){c(JSON.parse(e))}).catch(function(e){c({error:e.toString()})});return!0}}else"uploadLog"==a.type?(a={timestamp:Date.now(),type:"proxyLog",proxy:a.data},Xb(this.i.runtime,a),this.i.I.Sa("misc",a),c({ok:!0})):99==Q.za&&("getUuid"==a.type?(this.debug&&K.log("api getUuid="+this.i.runtime.env.uuid),c({uuid:this.i.runtime.env.uuid})):"setUserInfo"==a.type?(this.debug&&K.log("api setUserInfo...d_msg="+JSON.stringify(a)),b=void 0,a.data&&a.data.jwt&&(b=a.data.jwt),this.h?
b?KJUR.jws.JWS.verifyJWT(b,this.h,{alg:["RS256"],gracePeriod:3600})?(a=new KJUR.jws.JWS,a.parseJWS(b),a=JSON.parse(a.parsedJWS.payloadS),a.uuid!=this.i.runtime.env.uuid?(K.error("mismatched UUID in user info token"),c({error:"mismatched UUID"})):(this.debug&&K.log("api setUserInfo "+a.userName),this.i.H.sendMessage({type:"familySignInUserFromExt",data:{rd:a.authToken,userName:a.userName,Z:a.userId,oi:a.rememberMe}}),c({ok:!0}))):(K.error("JWT user info no valid: "+b),K.error("JWT user info no valid: key="+
this.h),c({error:"Invalid user info JWT"})):(this.debug&&K.log("api setUserInfo error: null jwt"),c({error:"No jwt"})):(this.debug&&K.log("api setUserInfo error: null familyPubKey"),c({error:"Auth server public key unavailable"}))):"userLogout"==a.type?(this.debug&&K.log("api userLogout: userLogout"),this.i.H.sendMessage({type:"signOutUser"}),c({ok:!0})):"reloadPolicy"==a.type?(this.debug&&K.log("api: reloadPolicy"),this.i.H.sendMessage({type:"reloadPolicy"}),c({ok:!0})):"uploadProxyLog"==a.type?
(this.debug&&K.log("api: uploadProxyLog"),this.i.H.sendMessage({type:"uploadProxyLog"}),c({ok:!0})):"getHomeConf"==a.type?(this.debug&&K.log("api getHomeConf="+this.i.s["home.conf"]),c({homeConf:this.i.s["home.conf"]})):"saveHomeConf"==a.type&&(this.debug&&K.log("api saveHomeConf="+a.data),this.i.s["home.conf"]=a.data,c({ok:!0})))};function Kk(a){ik.call(this,a)}x(Kk,ik);
Kk.prototype.init=function(){var a=this,b,c,d,e;return J(function(f){switch(f.h){case 1:return y(f,ik.prototype.init.call(a),2);case 2:b=nodeMods.commander;if(!b.internalPort){f.m(0);break}c=function(g,h){var l,m;return J(function(n){if(1==n.h){C(n,2);l=Math.floor(1E4*Math.random());if(!a.tp)throw Error("Internal http handler not set");return y(n,a.tp(g,h,l),4)}if(2!=n.h)return F(n,0);m=H(n);K.error("[CloudSS] Internal http handler error: "+m);h.statusCode=500;h.write(m.toString());h.end();A(n)})};
d=b.internalPort;C(f,4);return y(f,new Promise(function(g,h){a.h=nodeMods.http.createServer(c);a.h.listen({host:"0.0.0.0",port:d},function(){var l=a.h.address().port;K.log("Internal port bound at "+l);g()}).on("error",function(l){a.h.close();h(l)})}),6);case 6:F(f,0);break;case 4:e=H(f),"EADDRINUSE"==e.code?K.warn("Internal port "+d+" already in use ..."):K.error("Cannot start internal server: "+e),process.exit(1),A(f)}})};
function Lk(){nodeMods.redis=require("redis");nodeMods.LRU=require("lru-cache");nodeMods.isIpPrivate=require("private-ip");nodeMods.jwt=require("jsonwebtoken");K.log("Cloud proxy version: "+Q.sb);for(var a=["unhandledRejection","uncaughtException"],b=t(a),c=b.next();!c.done;c=b.next())process.removeAllListeners(c.value);process.on("uncaughtException",function(d,e){K.error("Uncaught exception: ",d,"origin:",e);d.stack&&K.error(d.stack)});process.on("unhandledRejection",function(d,e){K.error("Unhandled rejection at: ",
e,"reason: ",d);d.stack&&K.error(d.stack)});process.on("newListener",function(d,e){a.includes(d)&&setTimeout(function(){K.warn("Removing 3rd-party listener on process."+d+": "+e);process.removeListener(d,e)},500)});Tb=nodeMods.path.dirname(process.argv[1])+nodeMods.path.sep;K.log("Install path is "+Tb);nodeMods.commander.option("-p, --port <number>","port number",8888,parseInt).option("--internal-port <number>","internal API port to bind to",0,parseInt).option("--crt <crtFile>","SSL cert file").option("--key <keyFile>",
"SSL key file").option("--jwt-priv-key <keyFile>","private key for signing master tokens","./jwtPrivKey.pem").option("--jwt-pub-key <keyFile>","public key for signing master tokens","./jwtPubKey.pem").option("--public-ip <IP_addr>","public IP address to pass to front end for stickiness. Will NOT be effective behind load balancers").option("--private-addr <IP_addr:port>","private address for message relays in cluster mode").option("--redis <server_name>","Redis server name in cluster mode for message relay").option("--redis-chan <name>",
"Redis channel name to publish relay messages").option("--redis-pac-auth <server_name>","Redis server name for PAC auth assist").usage("\n\nCluster mode options: \n--internal-port\n--private-addr\n--redis\n--redis-chan\n\nPC auth options:\n--redis-pac-auth\n").parse(process.argv);return!0};function Mk(a,b){qk.call(this,Tb+"resources/",b);var c=this;this.Kc.Or=a;jk.im=function(d,e,f){return c.Kc.yf(d,e,f)};jk.tp=function(d,e,f){return Nk(c.Kc,d,e,f)};this.debug=b.debug;this.u=b.u;K.log("["+this.u+"][CloudBackend] Cloud proxy mode.")}x(Mk,qk);
Mk.prototype.Jn=function(){var a=nodeMods.commander,b={ci:{Pm:nodeMods.fs.readFileSync(a.jwtPrivKey,"utf8"),public:nodeMods.fs.readFileSync(a.jwtPubKey,"utf8")},Tp:a.publicIp,debug:this.debug,u:this.u};b.ci.Pm&&b.ci.public||(K.error("["+this.u+"][CloudBackend] Failed to load master token JWT keys, ABORT!"),process.exit(1));if(a.privateAddr&&a.redis){var c=a.privateAddr.split(":");if(2!=c.length)throw Error("Private address must be in IP_addr:port format");b.Cm=c[0];b.Dm=parseInt(c[1]);b.mk=a.redis;
b.Pf=a.redisChan;b.Op=a.redisPacAuth;K.log("["+this.u+"][CloudBackend] Cluster mode local address: "+b.Cm+":"+b.Dm);return new Ok(b)}if(a.privateAddr||a.redis)throw Error("Both private IP and Redis server must be specified for cluster");return new Pk(b)};Mk.prototype.Wh=function(){};
function Pk(a){rk.call(this,a);var b=this;this.options=a;this.debug=a.debug;this.u=a.u;this.j={};a.Op?(this.S=nodeMods.redis.createClient({host:a.Op,port:6379}),this.S.on("error",function(c){K.error("["+b.u+"][CloudBackend.Messaging] Redis client error: "+c)})):K.warn("["+this.u+"][CloudBackend.Messaging] No pac auth redis server specified, pc auth disabled...");this.N={Om:0,active:0};this.Ri();this.l={};Wc(function(){for(var c in b.j)6E5<Date.now()-b.j[c].Ap&&(K.log("["+b.u+"][CloudBackend.Messaging] Removing idle session. sid="+
c+"."),b.Aj(c));K.log("["+b.u+"][CloudBackend.Messaging] Stats: "+JSON.stringify(b.getStats())+".");b.Ri();c=t(Object.keys(b.l));for(var d=c.next();!d.done;d=c.next())d=d.value,K.log("["+b.u+"][CloudBackend.Messaging] BW stats: "+JSON.stringify({sendMessage:{message:d,count:b.l[d].count,bw:b.l[d].ul}}));b.l={}},6E4)}x(Pk,rk);k=Pk.prototype;k.getStats=function(){return{session:{active:this.N.active,peak:this.N.Om}}};k.Ri=function(){};
k.addListener=function(){throw Error("Can't add listener directly on a message dispatcher");};function Qk(a){if(a=a.headers.cookie){a=t(a.split(";"));for(var b=a.next();!b.done;b=a.next())if(b=b.value,b=b.trim(),b=b.split("=",2),"sid"==b[0])return b[1]}}
k.yf=function(a,b,c){var d=this,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R,N,Y,W,X,L,I,P,ha,ma,aa;return J(function(V){switch(V.h){case 1:e=new URL(a.url,"http://foo");if("/auth"==e.pathname){q=Qk(a);if(!(u=q)){V.m(12);break}return y(V,Rk(d,q),13)}if("/echoToken"==e.pathname){f=Qk(a);d.debug&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Echo token request. sCookie="+f+".");b.statusCode=200;b.setHeader("access-control-allow-origin","*");b.write(JSON.stringify({sesToken:f}));b.end();V.m(0);break}return"/wrq/onBeforeRequest"==
e.pathname?(C(V,8),y(V,Bk(a),10)):y(V,rk.prototype.yf.call(d,a,b,c),0);case 10:h=V.j;g=JSON.parse(h);d.trace&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") On before request. x-forwarded-for="+a.headers["x-forwarded-for"]+", remoteAddress="+a.socket.remoteAddress+", body="+h+".");F(V,9);break;case 8:return l=H(V),K.error("["+d.u+"][CloudBackend.Messaging]("+c+") onBeforeRequest get request body error: "+l),b.statusCode=400,b.end(),V.return();case 9:return m={sesToken:g.sesToken,recipient:"filterBackend",
type:"onBeforeRequest",data:{url:g.url}},n={noRecordClientIp:!0},y(V,d.Nf(a,b,n,m,function(na,za){return za&&za.response},c),0);case 13:u=V.j;case 12:r=u||{};p=e.searchParams.get("site")||"https://www.google.com/";v=r.Nb;d.debug&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Handle auth request. sid="+v+", sInfo="+JSON.stringify(r)+", redirectUrl="+p+".");w=!1;if(!v||r.un&&r.un<Date.now()){K.warn("["+d.u+"][CloudBackend.Messaging]("+c+") No sid or expired in auth request. sid="+v+", sInfo="+JSON.stringify(r)+
", url="+e+".");E={};w=!0;G=e.searchParams.get("pc");if(!G||!d.S){V.m(21);break}C(V,22);M="proxy:pc:"+G;return y(V,new Promise(function(na,za){d.S.get(M,function(xa,Sa){xa?za(xa):na(Sa)})}),24)}if(d.j[v]){z=Sk(d,v);V.m(15);break}C(V,17);return y(V,d.Mo(v),19);case 19:z=V.j;F(V,15);break;case 17:return B=H(V),K.warn("["+d.u+"][CloudBackend.Messaging]("+c+") Auth cannot find session. sid="+v+", err="+B),D=r,y(V,d.createSession(a,D,c),20);case 20:v=V.j;z=Sk(d,v);V.m(15);break;case 24:return T=V.j,O=
new Promise(function(na,za){setTimeout(za,100)}),y(V,Promise.race([T,O]),25);case 25:(R=V.j)&&"unknown"!=R?(K.log("pc session "+G+" mapped to "+R),d.S.expire(M,15,function(na){na&&K.error("Redis renew pc: "+na)}),E.kb={G:{Z:R}},w=!1):K.warn("Invalid pc: "+G);F(V,21);break;case 22:N=H(V),K.warn("Cannot get pc info: "+G+", "+N);case 21:return y(V,d.createSession(a,E,c),26);case 26:v=V.j,z=Sk(d,v);case 15:return y(V,Tk(d,z),27);case 27:Y=V.j;if(W=a.headers.host)X=W.indexOf(".pc."),-1!=X&&(W=W.substr(X+
4));L="sid="+Y+(W?"; Domain="+W:"")+"; Path=/; SameSite=None; Secure";I=Object.assign({},z);I.Nr=Math.floor(Date.now()/1E3)+(I.kb&&I.kb.G&&I.kb.G.Z&&I.kb.G.Z!=Q.qd?3600:30);P=p;ha=(-1!=p.indexOf("?")?"&":"?")+"__dld_auth__=";ma=encodeURIComponent;return y(V,Tk(d,I),28);case 28:p=P+(ha+ma(V.j)),d.trace&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Setting cookie for token. masterToken="+JSON.stringify(z)+", scriptToken="+JSON.stringify(I)+"."),d.trace&&K.log("["+d.u+"][CloudBackend.Messaging]("+
c+") Setting cookie. masterCookie="+L+", redirectUrl="+p+"."),w?(b.statusCode=200,b.setHeader("set-cookie",L),b.setHeader("content-type","text/html"),b.setHeader("access-control-allow-origin","*"),aa='\n<html>\n<head><title>Deledao Signin</title></head>\n<body>\n<h1>Deledao Login</h1>\n<h2><a href="'+p+'">Click to continue</a></h2>\n</body>\n</html>\n',b.write(aa)):(b.statusCode=302,b.setHeader("set-cookie",L),b.setHeader("location",p),b.setHeader("access-control-allow-origin","*")),b.end(),A(V)}})};
function Nk(a,b,c,d){var e,f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:e=new URL(b.url,"http://foo");a.trace&&K.log("["+a.u+"][CloudBackend.Messaging]("+d+") Handle internal http request. url="+e+".");if("/health"==e.pathname||"/HealthCheck"==e.pathname){c.statusCode=200;c.statusText="ok";c.write("script server ok: "+Q.sb+", "+(12==Q.za?"edu":"fam")+"\n");c.end();r.m(0);break}if("/createSessionToken"==e.pathname)return n=e.searchParams.get("userId"),q={Nb:n||Cc()},n&&(q.kb={G:{Pj:!0,Z:n}}),
K.log("["+a.u+"][CloudBackend.Messaging]("+d+") Create session token. uid="+n+", masterToken="+JSON.stringify(q)+"."),y(r,Tk(a,q),11);if("/renewSessionToken"==e.pathname){f=e.searchParams.get("token");if(!(g=f)){r.m(8);break}return y(r,Rk(a,f),9)}return y(r,jk.yf(b,c,d),7);case 7:return r.return(r.j);case 9:g=r.j;case 8:h=g;a.debug&&K.log("["+a.u+"][CloudBackend.Messaging]("+d+") Renew session token. Payload="+JSON.stringify(h)+".");if(!f||!h||!h.Nb)return c.statusCode=200,c.write(JSON.stringify({error:"Missing or invalid token"})),
c.end(),r.return();delete h.jt;return y(r,Tk(a,h),10);case 10:l=r.j;m=JSON.stringify({token:l});a.trace&&K.log("["+a.u+"][CloudBackend.Messaging]("+d+") Renew session token. Response="+m+".");c.statusCode=200;c.write(m);c.end();r.m(0);break;case 11:u=r.j,c.statusCode=200,c.write(JSON.stringify({token:u})),c.end(),A(r)}})}
k.Nf=function(a,b,c,d,e,f){var g=this,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G;return J(function(M){switch(M.h){case 1:h=d.sesToken;C(M,2);if(!h)throw Error("No session token found");return y(M,Rk(g,h),4);case 4:l=M.j;if(!l)throw Error("Invalid session token");F(M,3);break;case 2:return m=H(M),K.error("["+g.u+"][CloudBackend.Messaging]("+f+") Invalid session token in message. sesToken="+h+", err="+m+"."),b.statusCode=200,b.setHeader("access-control-allow-origin","*"),b.write(JSON.stringify({error:"reauthenticate: "+
m.message})),b.end(),M.return();case 3:g.trace&&K.log("["+g.u+"][CloudBackend.Messaging]("+f+") Process message. d_envelope="+JSON.stringify(c)+", sInfo="+JSON.stringify(l)+".");if(!c||!c.noRecordClientIp){q=a.headers;if(q["x-forwarded-for"])for(u=q["x-forwarded-for"],u=u.split(",");0<u.length;)if((r=u.shift().trim())&&!nodeMods.isIpPrivate(r)){n=r;break}n||(n=a.socket.remoteAddress);c||(c={});c.clientIp=n;g.trace&&K.log("["+g.u+"][CloudBackend.Messaging]("+f+") Determine IP from message. clientIp="+
n+", x-forwarded-for="+q["x-forwarded-for"]+", remoteAddress="+a.socket.remoteAddress+".")}p=l.Nb;if(v=g.j[p]){M.m(5);break}C(M,6);if(c&&c.noRelay)throw Error("noRelay is set and no local session found");return y(M,g.Wp(a,b,c,d,p,e,f),8);case 8:return M.return();case 6:w=H(M);w.message&&-1!=w.message.indexOf("not implemented")||K.warn("["+g.u+"][CloudBackend.Messaging]("+f+") Relay message failed. sid="+p+", err="+w+".");if(v=g.j[p]){K.error("["+g.u+"][CloudBackend.Messaging]("+f+") Session has already been created. sid="+
p+".");M.m(5);break}K.log("["+g.u+"][CloudBackend.Messaging]("+f+") API restore session. sid="+p+", message="+Gc(d)+".");return y(M,g.createSession(a,l,f),10);case 10:p=M.j,v=g.j[p];case 5:if(!v){K.error("["+g.u+"][CloudBackend.Messaging]("+f+") Session is not available. The message is lost. sid="+p+".");b.statusCode=200;b.setHeader("access-control-allow-origin","*");b.write(JSON.stringify({error:"Session not available."}));b.end();M.m(0);break}B=d;D=d.recipient||B.recipient;E=d.type||B.type;z=D+
"#"+E;(G=g.l[z])||(G=g.l[z]={count:0,ul:0});G.count++;return"proxy"==D?M.return():y(M,v.session.ready(),12);case 12:v.Ap=Date.now(),v.Tb.Kc.Nf(a,b,c,d,function(T,O){if(!(l.kb&&l.kb.G&&l.kb.G.Z)&&v.session.Lg()||6E5<Date.now()-(l.yp||0)){var R=Sk(g,p);T=O;R=Uk(R);R=nodeMods.jwt.sign(R,g.options.ci.Pm,{algorithm:"RS256"});T.sesToken=R}g.options.Tp&&(O.serverIp=g.options.Tp);g.l[z]&&(g.l[z].ul+=JSON.stringify(O).length);e&&(O=e(b,O));return O},f),A(M)}})};
k.createSession=function(a,b,c){b=void 0===b?{}:b;var d=this,e,f,g,h,l,m,n,q,u,r;return J(function(p){if(1==p.h){K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Create session. oldSession="+JSON.stringify(b)+".");e=a.headers;f=b.Nb||Cc();g={debug:d.debug,u:d.u,C:Math.floor(1E4*Math.random()),Ol:c};h=d.j[f]={Tb:new qk(Tb+"resources/",g),Ap:Date.now(),userAgent:e["user-agent"]};if(e["x-forwarded-for"])for(m=e["x-forwarded-for"],m=m.split(",");0<m.length;)if((n=m.shift().trim())&&!nodeMods.isIpPrivate(n)){l=
n;break}l||(l=a.socket.remoteAddress);d.trace&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Determine IP while creating session. clientIp="+l+", x-forwarded-for="+e["x-forwarded-for"]+", remoteAddress="+a.socket.remoteAddress+".");q={userAgent:h.userAgent,wd:l,hi:b.kb,u:d.u,C:g.C,Ol:c};h.session=d.Or(h.Tb,q);u=Rc(h.userAgent);K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Created a new session. sid="+f+", ip="+l+", userAgent="+h.userAgent+", uaInfo.system="+u.system+", uaInfo.browser="+u.browser+
".");r=d.N;r.active++;r.active>r.Om&&(r.Om=r.active);b.Nb&&K.log("["+d.u+"][CloudBackend.Messaging]("+c+") Restoring previous session. oldSession.sid="+b.Nb+", oldSession.ses.auth.userId="+(b.kb&&b.kb.G&&b.kb.G.Z)+".");return y(p,h.session.ready(),2)}K.log("["+d.u+"][CloudBackend.Messaging]("+c+") New session is ready. sid="+f+".");return p.return(f)})};
k.Aj=function(a){if(this.j[a]){K.log("["+this.u+"][CloudBackend.Messaging] Delete session. sid="+a+".");var b=this.j[a];delete this.j[a];b.session.destroy();this.N.active--}};function Sk(a,b){a=a.j[b]||{};return{Nb:b,kb:a.session&&a.session.save()}}function Uk(a){var b=Date.now();a.yp=b;a.un=b+864E5;a.ov="1.0";return Xa(Za,a)}
function Tk(a,b){var c;return J(function(d){if(1==d.h)return b=Uk(b),y(d,new Promise(function(e,f){nodeMods.jwt.sign(b,a.options.ci.Pm,{algorithm:"RS256"},function(g,h){g?f(Error(g)):e(h)})}),2);c=d.j;return d.return(c)})}function Rk(a,b){var c,d;return J(function(e){if(1==e.h)return C(e,2),y(e,new Promise(function(f,g){nodeMods.jwt.verify(b,a.options.ci.public,{algorithm:"RS256"},function(h,l){h?g(h):f(l)})}),4);if(2!=e.h)return c=e.j,d=U(Za,c),e.return(d);H(e);return e.return(void 0)})}
k.Wp=function(){return J(function(){throw Error("relayMessage() not implemented");})};k.Mo=function(){return J(function(){throw Error("discoverMasterToken() not implemented");})};
function Ok(a){Pk.call(this,a);var b=this;if(!a.mk)throw Error("No Redis server defined");this.Pf=a.Pf||(12==Q.za?"cloudproxy":"fam-cloudproxy");K.log("["+this.u+"][CloudBackend.RelayMessaging] Redis server: "+a.mk+", channel: "+this.Pf);this.ga=nodeMods.redis.createClient({host:a.mk,port:6379});this.ga.on("error",function(c){K.error("["+b.u+"][CloudBackend.RelayMessaging] Redis subscriber error: "+c)});this.ga.on("message",function(c,d){b.onMessage(c,d)});this.ga.subscribe(this.Pf);this.J=nodeMods.redis.createClient({host:a.mk,
port:6379});this.J.on("error",function(c){K.error("["+b.u+"][CloudBackend.RelayMessaging] Redis publisher error: "+c)});this.D=Cc();K.log("["+this.u+"][CloudBackend.RelayMessaging] Redis connected. MyId="+this.D+".");this.o=new nodeMods.LRU;this.ya=new Qc}x(Ok,Pk);k=Ok.prototype;
k.getStats=function(){var a={message:{total:this.v.total,relays:this.v.Xp,tokenRelays:this.v.pq,relayFailures:this.v.Vp},redis:{discover:this.h.Bg,discoverFailure:this.h.Ul,invalidate:this.h.Qj,advertise:this.h.mg}},b=this.h.Bg-this.h.Ul;b&&(a.redis.discoverLatency=Math.round(this.h.pn/b));Object.assign(a,Pk.prototype.getStats.call(this));a.session.duplicate=this.h.Oo;a.session.remote=this.o.itemCount;return a};
k.Ri=function(){Pk.prototype.Ri.call(this);this.v={total:0,Xp:0,pq:0,Vp:0};this.h={Bg:0,Ul:0,Qj:0,mg:0,pn:0,Oo:0}};k.mg=function(a){a={type:"advertise",sender:this.D,Mu:[a],Um:this.options.Cm,Vm:this.options.Dm,Gf:Sk(this,a),version:Q.sb};a.Gf.kb&&a.Gf.kb.G&&a.Gf.kb.G.Z&&a.Gf.kb.G.Z!=Q.qd||(a.sq=3E4);this.h.mg++;this.J.publish(this.Pf,JSON.stringify(a))};k.Qj=function(a){this.h.Qj++;this.J.publish(this.Pf,JSON.stringify({type:"invalidate",sender:this.D,Nb:a,Um:this.options.Cm,Vm:this.options.Dm,version:Q.sb}))};
k.createSession=function(a,b,c){var d=this,e;return J(function(f){if(1==f.h)return y(f,Pk.prototype.createSession.call(d,a,b,c),2);e=f.j;d.mg(e);return f.return(e)})};k.Aj=function(a){Pk.prototype.Aj.call(this,a);this.Qj(a)};
k.Bg=function(a){var b=this,c,d,e,f;return J(function(g){switch(g.h){case 1:if(b.o.get(a))return g.return();b.h.Bg++;b.J.publish(b.Pf,JSON.stringify({type:"discover",sender:b.D,Nb:a,version:Q.sb}));c=new Promise(function(h,l){setTimeout(function(){l(Error("timeout: discover"))},50)});d=Date.now();e=new Promise(function(h){return J(function(l){if(1==l.h)return b.o.get(a)?l.m(3):y(l,b.ya.wait(),1);h();A(l)})});C(g,2);return y(g,Promise.race([c,e]),4);case 4:F(g,3);break;case 2:throw f=H(g),b.h.Ul++,
f;case 3:b.h.pn+=Date.now()-d,A(g)}})};k.Mo=function(a){var b=this,c;return J(function(d){if(1==d.h)return y(d,b.Bg(a),2);c=b.o.get(a);if(!c)throw Error("Remote session not found after discover() succeeded");b.v.pq++;return d.return(c.Gf)})};k.Nf=function(a,b,c,d,e,f){var g=this;return J(function(h){return 1==h.h?(g.v.total++,y(h,Pk.prototype.Nf.call(g,a,b,c,d,e,f),2)):h.return(h.j)})};
k.Wp=function(a,b,c,d,e,f,g){var h=this,l,m,n;return J(function(q){switch(q.h){case 1:return C(q,2),h.trace&&K.log("["+h.u+"][CloudBackend.RelayMessaging]("+g+") Relay message for sid("+e+"): "+JSON.stringify(d)+"."),y(q,h.Bg(e),4);case 4:c.noRelay=!0;l={version:Q.sb,envelope:c,message:d,relay_debug_req_sn:g};m=h.o.get(e);if(!m||!m.be||!m.port)throw Error("Incomplete relay info: "+JSON.stringify(m));return y(q,new Promise(function(u,r){var p=JSON.stringify(l),v={hostname:m.be,port:m.port,path:"/sendMessage",
method:a.method,headers:Object.assign({},a.headers)};delete v.headers["content-length"];h.trace&&K.log("["+h.u+"][CloudBackend.RelayMessaging]("+g+") Relaying message for sid("+e+"): "+JSON.stringify(v)+".");v=nodeMods.http.request(v,function(w){b.statusCode=w.statusCode;b.statusMessage=w.statusMessage;for(var z in w.headers)b.setHeader(z,w.headers[z]);var B="";w.on("data",function(D){f?B+=D:b.write(D)});w.on("end",function(){if(f){var D=B;try{var E=JSON.parse(B);E=f(b,E);B=JSON.stringify(E)}catch(G){K.error("["+
h.u+"][CloudBackend.RelayMessaging]("+g+") Relay onBeforeWriteResponse error: "+G)}void 0===B?K.error("["+h.u+"][CloudBackend.RelayMessaging]("+g+") Relay onBeforeWriteResponse got undefined body. Original body=",D,", d_rawResponse=",E):b.write(B)}b.end();u()});w.on("error",function(D){b.end();r(Error("Relay upstream error: "+m.be+": "+m.port+": "+D.message))})});v.on("error",function(w){r(Error("Cannot connect to relay server: "+m.be+":"+m.port+": "+w.message))});v.write(p);v.end()}),5);case 5:h.v.Xp++;
F(q,0);break;case 2:throw n=H(q),h.v.Vp++,n;}})};
k.onMessage=function(a,b){try{var c=JSON.parse(b);if(!c.sender||c.sender!=this.D)if(c.version!=Q.sb)K.warn("["+this.u+"][CloudBackend.RelayMessaging] Ignore message from different version: "+b+".");else if(this.trace&&K.log("["+this.u+"][CloudBackend.RelayMessaging] On Redis message: "+b+"."),"advertise"==c.type){for(var d=t(c.Mu),e=d.next();!e.done;e=d.next()){var f=e.value;if(this.j[f])if(this.D<c.sender)K.warn("["+this.u+"][CloudBackend.RelayMessaging] Duplicate session found for sid("+f+"), giving up my copy."),
this.Aj(f),this.h.Oo++;else{K.warn("["+this.u+"][CloudBackend.RelayMessaging] Duplicate session found for sid("+f+"), telling sender("+c.sender+") to give up.");this.mg(f);continue}var g={be:c.Um,port:c.Vm,Gf:c.Gf};this.o.set(f,g,c.sq||6E4);this.trace&&K.log("["+this.u+"][CloudBackend.RelayMessaging] Setting relay map for sid("+f+"): "+JSON.stringify(g)+". TTL="+(c.sq||6E4)+".")}this.ya.signal()}else if("invalidate"==c.type){var h=this.o.get(c.Nb);h&&h.be==c.Um&&h.port==c.Vm&&(this.o.del(c.Nb),this.trace&&
K.log("["+this.u+"][CloudBackend.RelayMessaging] Deleting relay map for sid("+c.Nb+")."))}else"discover"==c.type&&c.sender!=this.D&&this.j[c.Nb]&&this.mg(c.Nb)}catch(l){K.error("["+this.u+"][CloudBackend.RelayMessaging] Error processing Redis message: "+b+". Error="+l+".")}};function Vk(){var a=this;Wk(this);new Ti(new Xk,function(b){return Yk(a,b)})}function Wk(a){var b;J(function(c){if("undefined"==typeof tf)return K.error("DLD: Cannot find tf"),c.return();if(!Zf())return K.error("DLD: WebGL not supported"),c.return();a.h=new Yf;b=function(d){for(var e=[],f=0;f<arguments.length;++f)e[f]=arguments[f];var g;return J(function(h){if(1==h.h)return y(h,fetch(e[0]),2);g=h.j;return Q.Hd?h.return(jd(g)):h.return(g)})};return c.return(a.h.ub("dyncc/IAmodel-enc",Cg,b))})}
function Yk(a,b){var c;return J(function(d){switch(d.h){case 1:if("cloudUtils"!=b.recipient){d.m(0);break}if("analyzeImage"!=b.type){if("getModelInputs"==b.type)return a.h?d.return(a.h.Na()):d.return({error:"Engine not created yet"});d.m(0);break}if(!a.h)return d.return({error:"Engine not created yet"});c=new Promise(function(e){setTimeout(e,1500)});C(d,5);return y(d,Promise.race([a.h.ready(),c]),7);case 7:F(d,6);break;case 5:return H(d),d.return({error:"Model not ready"});case 6:return d.return(a.h.hc(b.data.pf,
b.data.ka))}})}Q.Cg("__dld_cui",function(a){return J(function(b){Q.Jg(a);Q.ce=!0;K=window.console;new Vk;A(b)})});function Zk(a,b){b=void 0===b?{}:b;this.h=[];this.j=this.init(a,b)}var $k;k=Zk.prototype;
k.init=function(a,b){var c=this,d,e,f;return J(function(g){switch(g.h){case 1:c.Tb=a;c.D=b;c.u=b.u;c.C=b.C;c.disabled=!1;c.cv=!1;try{c.s=a.Wh(),c.I=new Vh(c)}catch(h){K.error("GenUpload init: "+h),K.error(h.stack)}try{c.H=new Ra,c.http=new dd(c),c.v=new Gd(c),c.Do(),K.log("["+c.u+"]["+c.C+"][BrowserSession]("+b.Ol+") Boot logging starts here. Extension version="+c.ob()+".")}catch(h){K.error("MBus, Http, DebugConsole init: "+h),K.error(h.stack)}C(g,2);Ub(c.console,"runtime",c.runtime=new Pd(c));return y(g,
c.runtime.l,4);case 4:F(g,3);break;case 2:d=H(g),K.error("Runtime init: "+d),K.error(d.stack);case 3:try{33===Q.platform&&(c.it=new nd(c))}catch(h){K.error("IAP init: "+h),K.error(h.stack)}try{Q.wa||(yj={onBeforeRequest:new al("onBeforeRequest"),onBeforeSendHeaders:new al("onBeforeSendHeaders"),onHeadersReceived:new al("onHeadersReceived")})}catch(h){K.error("WebRequest init: "+h),K.error(h.stack)}try{Ub(c.console,"ytf",c.Rc=new ai(c))}catch(h){K.error("YTBackend init: "+h),K.error(h.stack)}try{12===
Q.za?c.policy=new Ue(c):c.policy=new sf(c),Ub(c.console,"policy",c.policy),Ub(c.console,"policyv",c.policy)}catch(h){K.error("Policy init: "+h),K.error(h.stack)}c.H.addListener(function(h){"policyDisabled"==h.type?(bl(c,!1,"entitlement expired"),c.Zl=!0):"policyReEnabled"==h.type?(bl(c,!0,"entitlement re-enabled"),c.Zl=!1):"policyLiveDisabled"==h.type?bl(c,!1,"live disabled"):"customerSignedOut"==h.type&&c.disabled&&(K.warn("Extension re-enabled on customer signout"),bl(c,!0,"customer signed out"))},
["policyDisabled","policyReEnabled","policyLiveDisabled","customerSignedOut"]);12==Q.platform&&"chrome"!=c.runtime.env.platform?((e=c.policy.M)&&e.Tl&&bl(c,!1,"non-chromebooks"),c.H.addListener(function(h){"policyChanged"==h.type&&(h=c.policy.M)&&(h=h.Tl,void 0==h&&(h=!1),h!=c.disabled&&bl(c,!h,"non-chromebooks"))},["policyChanged"])):33==Q.platform&&((f=c.policy.M)&&f.Zh&&f.Zh.Rl&&(K.warn("switching to desktop view"),prompt("true","NAPASetDesktopMode")),c.H.addListener(function(h){"policyChanged"==
h.type&&((h=c.policy.M)&&h.Zh&&h.Zh.Rl?(K.warn("switching to desktop view"),prompt("true","NAPASetDesktopMode")):(K.warn("switching to mobile view"),prompt("false","NAPASetDesktopMode")))},["policyChanged"]));try{c.Gb=new Ag(c),Ub(c.console,"dau",c.Gb)}catch(h){K.error("DynAnalUtils init: "+h),K.error(h.stack)}try{if(12==Q.za)switch(Q.platform){case 88:c.G=new Hh(c,b.hi&&b.hi.G);break;case 12:c.G=de(c.runtime)?new Gh(c):new Dh(c);break;default:c.G=new mh(c)}else switch(Q.platform){case 88:c.G=new Uh(c);
break;default:c.G=new Oh(c)}Ub(c.console,"auth",c.G)}catch(h){K.error("AuthBackend init: "+h),K.error(h.stack)}try{Ub(c.console,"cnf",c.Aa=new di(c))}catch(h){K.error("CloudFilter init: "+h),K.error(h.stack)}try{Ub(c.console,"dta",c.Vd=new Ni(c))}catch(h){K.error("DynText init: "+h),K.error(h.stack)}try{c.ra=new Ui(c),Ub(c.console,"dia",c.ra),Ub(c.console,"diav",c.ra)}catch(h){K.error("DynImage init: "+h),K.error(h.stack)}try{Ub(c.console,"dva",c.sc=new Zi(c))}catch(h){K.error("DynVideo init: "+h),
K.error(h.stack)}try{Ub(c.console,"dab",c.Io=new cj(c))}catch(h){K.error("DynAB init: "+h),K.error(h.stack)}try{Ub(c.console,"dgm",c.Sl=new hj(c))}catch(h){K.error("DynGames init: "+h),K.error(h.stack)}try{c.o=new Ki(c)}catch(h){K.error("DynSearch init: "+h),K.error(h.stack)}try{c.te=new rj(c),Ub(c.console,"act",c.te),Ub(c.console,"acv",c.te)}catch(h){K.error("UserActs init: "+h),K.error(h.stack)}if(Q.features.La.enabled){try{c.ja=12==Q.platform?new cl(c):new dl(c),Ub(c.console,"dev",c.ja)}catch(h){K.error("Device control init: "+
h),K.error(h.stack),c.ja={}}try{c.La=new el(c),Ub(c.console,"clm",c.La)}catch(h){K.error("Classroom mgmt init: "+h),K.error(h.stack)}}if(12==Q.platform)try{new wj(c)}catch(h){K.error("VendorMisc create error: "+h)}try{Q.wa||Q.Di||(c.ij=new fl(c),Ub(c.console,"bhr",c.ij),Ub(c.console,"bhv",c.ij),new gl(c))}catch(h){K.error("BHR init: "+h),K.error(h.stack)}try{c.kq=new xj(c)}catch(h){K.error("SafeSearch init: "+h),K.error(h.stack)}try{c.filter=new Bj(c),c.Np=new Kj(c),Q.wa&&Q.Di&&(Ub(c.console,"bhr",
c.filter),Ub(c.console,"bhv",c.filter))}catch(h){K.error("Filter init: "+h),K.error(h.stack)}try{Ub(c.console,"cookie",c.l=new hl(c)),Q.wa||(new il(c,["*://www.google.com/url?*"],["*://www.google.com/search?*"]),new il(c,null,["https://www.bing.com/search?*","https://www.bing.com/images/search?*","https://www.bing.com/news/search?*","https://www.bing.com/shop/search?*","https://www.bing.com/videos/search?*"]),new il(c,null,["https://search.yahoo.com/search*","https://*.search.yahoo.com/search*"]),
new il(c,null,["https://duckduckgo.com/?q=*"]),new il(c,null,["https://www.ecosia.org/search?*","https://www.ecosia.org/images?*","https://www.ecosia.org/news?*","https://www.ecosia.org/videos?*"]),new jl(c)),c.Bq=new kl(c)}catch(h){K.error("Privacy init: "+h),K.error(h.stack)}try{new Pj(c)}catch(h){K.error("DebugTool init: "+h),K.error(h.stack)}99==Q.platform&&(c.proxy=new Ik(c));c.addListener(function(h,l,m){if("backend"==h.recipient)if("getConfig"==h.type){if(m)if(c.disabled)m({});else{var n=h.data,
q={dva:c.sc,cbl:c.l,dgm:c.Sl,act:c.te,dsf:c.o,dta:c.Vd,dia:c.ra,ytf:c.Rc,dab:c.Io,clm:c.La};h={};for(var u in q)try{h[u]=q[u]&&q[u].fd(n,l)}catch(r){K.error("getConfig: "+u+": "+r)}c.policy&&(l=he(c.policy))&&l.setting&&l.setting.wj&&(h.cbp=l.setting.wj);m(h)}}else"getGlobalSettings"==h.type&&m&&(c.disabled?m({}):m(c.policy.M))});A(g)}})};
function bl(a,b,c){K.warn("Extension "+(b?"enabled":"disabled")+", "+(void 0===c?"":c));a.disabled=!b;if(12==Q.platform)for(var d in yj)a.disabled?yj[d].disable():yj[d].enable()}k.Do=function(){K=this.console=12!=Q.platform||this.sa()?new Yb(this):new Nb(this);this.sa()||33!=Q.platform||Fb(K,new Kb(this))};k.addListener=function(a){this.Tb.addListener(a)};k.ob=function(){return this.Tb.ob()};k.Hc=function(){return this.Tb.Hc()};k.vf=function(a){var b=this;return J(function(c){return c.return(b.Tb.vf(a))})};
function Te(a){return void 0===a.s["debug.serverGroup"]?Q.Ku:a.s["debug.serverGroup"]}k.sa=function(){return Q.sa};k.bi=function(){return Q.bi};k.setInterval=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];(b=Wc.apply(null,ca(b)))&&this.h.push(b);return b};k.clearInterval=function(a){var b=this.h.indexOf(a);-1!=b&&this.h.splice(b,1);return Xc(a)};k.destroy=function(){for(this.Yc=!0;0<this.h.length;){var a=this.h.shift();Xc(a)}this.H.destroy()};
function ll(a,b){Zk.call(this,a,b)}x(ll,Zk);k=ll.prototype;k.Do=function(){K=new Db(process.env.GIT_META?{Kp:!0,Lp:!0}:{});Fb(K,new Mb);this.console=new Zb(this)};k.ready=function(){return this.j};
k.init=function(a,b){var c=this;return J(function(d){return 1==d.h?(b.wd&&Dk(a.Kc,b.wd),y(d,Zk.prototype.init.call(c,a,b),2)):3!=d.h?(K.log("["+c.u+"]["+c.C+"][CloudBrowserSession]("+b.Ol+") Init. oldSession="+JSON.stringify(b.hi)+", clientIp="+b.wd+"."),b.wd&&Ck(c.Tb.Kc),b.hi?y(d,c.G.restore(b.hi.G),3):d.m(3)):y(d,c.G.ready(),0)})};k.save=function(){return{G:this.G.save()}};k.Lg=function(){return this.runtime.Lg()};k.destroy=function(){Zk.prototype.destroy.call(this);this.Tb.destroy()};
Q.Cg("__dld_bi",function(a){var b,c,d,e,f;return J(function(g){switch(g.h){case 1:C(g,2);Q.Jg(a);Yc();c={debug:!1,u:Math.floor(1E4*Math.random())};switch(Q.platform){case 12:K=window.console;b=new ak;break;case 33:K=new Db;Ib(K);b=new ek;break;case 99:case 88:return g.m(4);default:throw Error("dld: no supported backend for this platform");}g.m(5);break;case 4:if(!nodeMods.worker.isMainThread)return K=new Db,Fb(K,new Mb),K.log("IA worker thread running"),new Vj,g.return();K=global.console;d=99==Q.platform?
pk():Lk();if(!d){K=new Db;Fb(K,new Mb);g.m(6);break}jk=99==Q.platform?new ik(c):new Kk(c);return y(g,jk.l,7);case 7:b=99==Q.platform?new uk(c):new Mk(function(h,l){return new ll(h,l)},c);case 6:g.m(5);break;case 5:if(!b){g.m(8);break}return y(g,b.ready(),8);case 8:12==Q.platform&&setTimeout(function(){Xe()},3E5);F(g,3);break;case 2:throw e=H(g),f=console||12==Q.platform&&window.console||global.console,f.error("backInit: "+e),f.error(e.stack),e;case 3:if(88!=Q.platform&&b)return $k=new Zk(b),y(g,$k.j,
0);g.m(0)}})});function We(){K.log("checkUpdate");chrome.runtime.requestUpdateCheck(function(a,b){"throttled"==a?K.log("Extension auto update throttled"):"no_update"==a?K.log("No extension update available"):"update_available"==a&&K.log("Extension update available: "+b.version)})}
function Xe(){Ve=!0;var a=chrome.runtime.getManifest();K.log("autoUpdate: Current extension version: "+a.version);chrome.runtime.onUpdateAvailable.addListener(function(){chrome.runtime.reload();K.log("Extension reloaded");Ve=!1});We()}var Ve=!1;function al(a){var b=this;-1==["onBeforeRequest","onBeforeSendHeaders","onHeadersReceived"].indexOf(a)?K.error("centralWebRequestListener: unknown event type: "+a):(this.h=a,this.o=!1,this.enabled=!0,this.j=[],this.l=function(c){if(b.enabled){a:{for(var d,e,f,g=t(b.j),h=g.next();!h.done;h=g.next())if(h=h.value,ml(c,h.filter)){var l=Object.assign({},c);"onBeforeSendHeaders"==b.h?-1!=h.ka.indexOf("requestHeaders")?d&&(l.requestHeaders=d):delete l.requestHeaders:"onHeadersReceived"==b.h&&(-1!=h.ka.indexOf("responseHeaders")?
e&&(l.responseHeaders=e):delete l.responseHeaders);try{var m=Date.now();f=h.mj(l);var n=Date.now()-m;50<n&&K.warn(h.gp+" took "+n+"ms to process "+b.h+": "+c.url)}catch(q){K.error("Exception inside "+b.h+" callback: "+q+", stack: "+q.stack),f=null}f||(f={});if(f.cancel||f.redirectUrl){c=f;break a}if(f.Ou){delete f.Ou;c=f;break a}"onBeforeSendHeaders"==b.h&&f.requestHeaders?d=f.requestHeaders:"onHeadersReceived"==b.h&&f.responseHeaders&&(e=f.responseHeaders)}"onBeforeSendHeaders"==b.h&&d&&!f.requestHeaders?
f.requestHeaders=d:"onHeadersReceived"==b.h&&e&&!f.responseHeaders&&(f.responseHeaders=e);c=f}return c}})}var yj;al.prototype.disable=function(){this.enabled=!1};al.prototype.enable=function(){this.enabled=!0};
al.prototype.addListener=function(a,b,c,d){d=void 0===d?!1:d;a={mj:a,filter:Object.assign({},b),ka:c&&c.slice(0)};try{var e=Error().stack.split("\n")[2],f=e.indexOf(".js"),g=e.lastIndexOf("/",f);-1!=f&&(e=e.substring(g+1,f+3));a.gp=e}catch(h){a.gp="unknown"}c||(a.ka=[]);-1==a.ka.indexOf("blocking")&&K.warn(this.h+" addListener: no blocking spec found. You can register with chrome.webRequest directly");if(a.filter&&a.filter.urls){a:for(c=[],e=/^(\*|http|https|file|ftp):\/\/([^/]+)(\/?.*)$/,f=t(a.filter.urls),
g=f.next();!g.done;g=f.next()){b=g.value;if("<all_urls>"==b){c=[];break a}g=e.exec(b);if(null==g)K.warn("Invalid url spec ignored: "+b);else{""==g[3]&&(g[3]="/");b={};b.scheme=g[1];"*"!=g[2]&&g[2].startsWith("*")?b.hostSuffix=g[2].substr(1):b.host=g[2];b.Je=g[3].split("*");for(g=1;g<b.Je.length-1;g++)""==b.Je[g]&&(b.Je.splice(g,1),g--);2==b.Je.length&&""==b.Je[0]&&""==b.Je[1]&&(b.Je=[""]);c.push(b)}}if(null==c){K.error("Invalid filter url spec, listener not added: "+a.filter.urls);console.trace();
return}a.filter.gk=c}else a.filter.gk=[];d?this.j.unshift(a):this.j.push(a);this.o||(d=/Chrome\/([0-9]+)/.exec(navigator.userAgent)[1],"onBeforeRequest"==this.h?chrome.webRequest.onBeforeRequest.addListener(this.l,{urls:["*://*/*"]},["blocking"]):"onBeforeSendHeaders"==this.h?(a=["blocking","requestHeaders"],72<=d&&a.push("extraHeaders"),chrome.webRequest.onBeforeSendHeaders.addListener(this.l,{urls:["*://*/*"]},a)):"onHeadersReceived"==this.h&&(a=["blocking","responseHeaders"],72<=d&&a.push("extraHeaders"),
chrome.webRequest.onHeadersReceived.addListener(this.l,{urls:["*://*/*"]},a)),this.o=!0)};
al.prototype.removeListener=function(a){for(var b=0;b<this.j.length;b++)if(this.j[b].mj==a)return this.j.splice(b,1),0==this.j.length&&this.o&&("onBeforeRequest"==this.h?chrome.webRequest.onBeforeRequest.removeListener(this.l):"onBeforeSendHeaders"==this.h?chrome.webRequest.onBeforeSendHeaders.removeListener(this.l):"onHeadersReceived"==this.h&&chrome.webRequest.onHeadersReceived.removeListener(this.l),this.o=!1),!0;K.warn(this.h+" removeListener(): can't find the provided listener");console.trace();
return!1};function ml(a,b){if(b.tabId&&a.tabId!=b.tabId||b.types&&0<b.types.length&&-1==b.types.indexOf(a.type))return!1;if(b.gk&&0!=b.gk.length){b=t(b.gk);for(var c=b.next();!c.done;c=b.next())if(nl(a.url,c.value))return!0}else return!0;return!1}
function nl(a,b){try{var c=new URL(a),d=c.protocol.substring(0,c.protocol.length-1);if("*"==b.scheme){if("http"!=d&&"https"!=d)return!1}else if(d!=b.scheme)return!1;if(b.hostSuffix){if(!c.host.endsWith(b.hostSuffix))return!1}else if("*"!=b.host&&b.host!=c.host)return!1;var e=c.pathname+c.search+c.hash,f=b.Je;b=a=0;if(""!=f[0]){if(!e.startsWith(f[0]))return!1}else{if(1==f.length)return!0;a++}for(;a<f.length;a++){if(""==f[a])return!0;b=e.indexOf(f[a],b);if(-1==b)return!1;b+=f[a].length}return b==e.length}catch(g){return!1}}
;function hl(a){var b=this;this.i=a;12==Q.platform&&(this.debug="true"===this.i.s["debug.cookie.debug"],this.gb="cookie: ",this.ga=90,this.Bc=36E3,this.ya=this.qb=!1,this.o={urls:["<all_urls>"]},this.Rb=["blocking","requestHeaders"],this.nc=["blocking","responseHeaders"],this.j=new Map,this.l=this.v=this.D=0,this.h={},this.aa=function(c){var d=c.requestId,e=b.j.get(d);if(void 0===e){if(c=uc(c))e={count:1,domain:c},b.j.set(d,e)}else e.count++},this.J=function(c){return ol(b,c)},this.S=function(c){return pl(b,
c)},ql(this),yj.onBeforeSendHeaders.addListener(this.aa,this.o,this.Rb),yj.onHeadersReceived.addListener(this.J,this.o,this.nc),chrome.cookies.onChanged.addListener(this.S))}hl.prototype.fd=function(){return{enabled:this.i.policy.Df()}};function rl(a,b){if(!b)return!1;var c=!1,d=b;b.startsWith(".")&&(d=b.substring(1));if(b=Rg(a.i.Aa,d))for(b=t(b),d=b.next();!d.done;d=b.next())if(d.value===a.ga){c=!0;break}return c}
function sl(a,b,c){var d=b.requestId,e=a.j.get(d);void 0!==e&&(e.count--,0===e.count?a.j.delete(d):a.debug&&K.log(a.gb+"ref count="+e.count+" requestId="+b.requestId+"; referermap.szie="+a.j.size+"; delLoc="+c))}
function ol(a,b){var c,d=b.responseHeaders.length,e=0;chrome.tabs.get(-1===b.tabId?1E3:b.tabId,function(f){chrome.runtime.lastError?-1!=b.tabId&&a.debug&&K.log(a.gb+"Error getting tab for "+b.tabId+" "+b.url+" error="+chrome.runtime.lastError.message):c=f?f.url:"";0===b.frameId&&b.url===c?(a.debug&&K.log(a.gb+"ignore mainframe request: frameId="+b.frameId+" "+b.url+";  referer="+a.j.get(b.requestId)+" taburl="+c),sl(a,b,0)):b.responseHeaders.forEach(function(g){e++;if("set-cookie"===g.name.toLowerCase()){var h=
{},l=!1,m=!1,n="",q,u,r;h=(h=a.j.get(b.requestId))?h.domain:void 0;var p=(c?tc(c,0):void 0)||h;a.D++;h=g.value.split(";");var v=h[0].split("=");n=v[0].trim();if(""===n)return;for(var w=1;w<h.length;w++)v=h[w].split("="),g=v[0].trim().toLowerCase(),void 0!==v[1]&&(v=v[1].trim().toLowerCase(),"domain"===g?r=v:"max-age"===g?q=v:"expires"===g&&(u=new Date(v)));r=void 0!==r?tc(r,1):tc(b.url,0);if(void 0!==c&&c.startsWith("chrome:"))l=!1;else if(0!=b.frameId&&-1!=b.parentFrameId&&r&&p&&r!=p&&!r.endsWith("."+
p)){l=!0;h=t([["youtube.com","google.com","gmail.com"],"microsoftonline.com microsoft.com office.com office365.com sharepoint.com live.com onenote.com outlook.com".split(" ")]);for(g=h.next();!g.done;g=h.next())if(g=g.value,g.includes(r)&&g.includes(p)){l=!1;break}a.debug&&K.log(a.gb+"domainMismatch: domain="+r)}var z;q?z=q:u&&(z=(u-Date.now())/1E3);z>a.Bc&&(m=!0);q=-1;z&&(q=Math.round(z),z=86400<z?Math.round(z/3600/24)+" days":3600<z?Math.round(z/3600)+" hours":60<z?Math.round(z/60)+" minutes":Math.round(z)+
" seconds");if(!0===l)if(!z&&a.ya||z&&(m||a.qb))if(a.debug&&K.log("3rd plant blocked: domain="+r+"; refdomain="+p+"; expire="+(z||"session")),-1!==b.tabId&&a.i.H.sendMessage({type:"plantCookies0",data:{domain:r,tabId:b.tabId}}),rl(a,r))a.debug&&K.log(a.gb+"ads domain, skip deletion: domain="+r+" "+n+" "+b.url);else{if(a.debug&&K.log(a.gb+"3rd party cookie: reqId="+b.requestId+"  cookiename="+n+" frameId="+b.frameId+" referer="+p+" url="+b.url+" parentFrameId="+b.parentFrameId+" tabId="+b.tabId+" taburl="+
c),l={},l.url=b.url,l.name=n,!0===a.i.policy.Df()?c&&bf(a.i.policy,c)==Q.ea?a.debug&&K.log(a.gb+"blockCookie disabled for the tab. "+c):chrome.cookies.remove(l,function(B){null===B?a.debug&&K.log(a.gb+"failed to delete cookie "+n+" "+B.url):(a.debug&&K.log(a.gb+"deleted 3rd party cookie: "+n+" frameId="+B.frameId+" referer="+p+" url="+B.url+" parentFrameId="+b.parentFrameId+" tabId="+B.tabId+" taburl="+c+" reqId="+B.requestId),a.v++)}):a.debug&&K.log(a.gb+"blockCookie flag is off"),r&&p&&r!==p&&"image"===
b.type&&2E5>JSON.stringify(a.h).length)a.h[r]?11>Object.keys(a.h[r]).length&&!a.h[r][p]&&(a.h[r][p]=q,tl(a),10<=Object.keys(a.h[r]).length&&!a.h[r].uploaded&&(l={timestamp:Date.now(),type:"adDomain",ir:{domain:r,yu:ul(a.h[r])}},a.i.I.Sa("misc",l),a.h[r].uploaded=!0,a.debug&&K.log("upload adDomain "+JSON.stringify(l))),a.debug&&K.log(a.gb+"add one backlink size="+Object.keys(a.h).length+" "+r+" "+p+" "+b.type+" "+b.url)):(l={},l[p]=q,a.h[r]=l,tl(a))}else a.debug&&K.log("3rd plant allowed: domain="+
r+"; refdomain="+p+"; expire="+(z||"session"))}e===d&&sl(a,b,1)})})}
function pl(a,b){if(!1!==a.i.policy.Df()&&!0!==b.removed&&rl(a,tc(b.cookie.domain,1))){var c="http"+(b.cookie.secure?"s":"")+"://"+b.cookie.domain+b.cookie.path;void 0!==b.cookie.expirationDate?chrome.cookies.remove({url:c,name:b.cookie.name},function(d){null===d?a.debug&&K.log(a.gb+"ads failed to delete cookie "+d.name+" "+c):(a.l++,a.debug&&K.log(a.gb+"ads deleted cookie "+d.name+" "+c+"; totalcookies="+a.D+"; rhdelcookies="+a.v+" adsdelcookies="+a.l))}):a.debug&&K.log(a.gb+"ads not delete session cookie "+
b.cookie.name+" "+c)}}function ql(a){chrome.storage.local.remove("backlinkdomains");chrome.storage.local.remove("backlinkvalues");chrome.storage.local.remove("backlinkexpires");chrome.storage.local.get("backlink",function(b){b.tr?(a.h=JSON.parse(b.tr),a.debug&&K.log(a.gb+"load backlink len="+Object.keys(a.h).length)):chrome.storage.local.set({backlink:JSON.stringify(a.h)})})}
function tl(a){chrome.storage.local.set({backlink:JSON.stringify(a.h)});a.debug&&K.log(a.gb+"saveBackLinks: "+JSON.stringify(a.h))}function ul(a){var b="";Object.keys(a).forEach(function(c){b=b+c+" "});return b};function jl(a){this.i=a;vl(this)}
function vl(a){function b(){a.i.policy.pm()&&(K.log("need to clean localStorage per policy"),chrome.browsingData.remove({originTypes:{unprotectedWeb:!0}},{localStorage:!0}))}var c=-1,d=-1;chrome.windows.onCreated.addListener(function(){K.log("windows.onCreated");chrome.windows.getAll({windowTypes:["normal","popup"]},function(e){K.log("windows.onCreated, total windows="+e.length);1===e.length&&(K.log("clean localStorage after first window created"),b())})});chrome.windows.onRemoved.addListener(function(){K.log("windows.onRemoved");chrome.windows.getAll({windowTypes:["normal",
"popup"]},function(e){K.log("windows.onRemoved, total windows="+e.length);0===e.length&&(K.log("clean localStorage after all windows closed"),b())})});chrome.idle.onStateChanged.addListener(function(e){var f=(new Date).getTime();"active"===e?((-1!==c&&18E6<=f-c||-1!==d&&18E6<=f-d)&&b(),d=c=-1):"idle"===e?c=f:"locked"===e&&(d=f)});a.i.setInterval(function(){var e=(new Date).getTime();(-1!==c&&18E6<=e-c||-1!==d&&18E6<=e-d)&&b()},6E4)};function wl(a,b,c){this.i=a;this.v=b;this.h=c;this.enable(!0)}
wl.prototype.enable=function(a){var b=this;a?this.enabled||(this.S=function(c){a:{if(ge(b.i.runtime,"ganon")){var d=c.url;c=d.substring(d.indexOf("?")+1,c.url.length);c=c.split("&");for(d=0;d<c.length;d++){var e=c[d].split("=");if("q"==e[0]||"url"==e[0]){c={redirectUrl:decodeURIComponent(e[1])};break a}}}c=void 0}return c},this.J=function(c){return b.o(c)},this.D=function(c){return b.l(c)},this.v&&0<this.v.length&&yj.onBeforeRequest.addListener(this.S,{urls:this.v},["blocking"]),this.h&&0<this.h.length&&
(yj.onBeforeSendHeaders.addListener(this.J,{urls:this.h},["blocking","requestHeaders"]),yj.onHeadersReceived.addListener(this.D,{urls:this.h},["blocking","responseHeaders"])),this.enabled=!0):this.enabled&&(yj.onBeforeRequest.removeListener(this.S),yj.onBeforeSendHeaders.removeListener(this.J),yj.onHeadersReceived.removeListener(this.D),this.enabled=!1)};
wl.prototype.o=function(a){if(ge(this.i.runtime,"ganon")){for(var b=a.requestHeaders,c=!1,d=0;d<b.length;d++)"cookie"==b[d].name.toLowerCase()&&(b[d].value="",c=!0);if(c)return{requestHeaders:a.requestHeaders}}};wl.prototype.l=function(a){if(ge(this.i.runtime,"ganon")){for(var b=a.responseHeaders,c=0;c<b.length;c++)"set-cookie"==b[c].name.toLowerCase()&&(b[c].value="");return{responseHeaders:a.responseHeaders}}};function il(a,b,c){wl.call(this,a,b,c);this.cookies=[];this.j=void 0}x(il,wl);
il.prototype.o=function(a){if(ge(this.i.runtime,"ganon")){var b=wl.prototype.o.call(this,a);try{var c=new URL(a.url);if(b&&b.requestHeaders&&0<this.cookies.length&&this.j>Date.now()){a=[];for(var d=t(this.cookies),e=d.next();!e.done;e=d.next()){var f=e.value;(f.domain==c.hostname||f.domain.startsWith(".")&&c.hostname.endsWith(f.domain))&&c.pathname.startsWith(f.path)&&a.push(f.cookie)}b.requestHeaders.push({name:"cookie",value:a.join("; ")})}}catch(g){K.error("ganon reqHdrsHook: "+g)}return b}};
il.prototype.l=function(a){if(ge(this.i.runtime,"ganon"))try{if(0==this.cookies.length||this.j<=Date.now()){var b=new URL(a.url);this.cookies=[];for(var c=a.responseHeaders,d=0;d<c.length;d++)if("set-cookie"==c[d].name.toLowerCase()){for(var e=c[d].value.split(";"),f=e.shift().trim(),g=b.hostname,h="/",l=t(e),m=l.next();!m.done;m=l.next()){var n=m.value.trim().split("=",2);"domain"==n[0]?g=n[1]:"path"==n[0]&&(h=n[1])}f&&(this.cookies.push({cookie:f,domain:g,path:h}),this.j=Date.now()+3E5)}}return wl.prototype.l.call(this,
a)}catch(q){K.error("ganon hdrRecvHook: "+q)}};function fl(a){function b(e,f){var g=this;this.i=e;this.debug=void 0===f?!1:f;this.j();this.h={};this.i.setInterval(function(){var h=0,l;for(l in g.h)6E5<Date.now()-g.h[l].time&&(delete g.h[l],h++);g.debug&&h&&K.log("Removed "+h+" orphaned reqs from pending CC reqs")},6E5)}function c(){this.cache={};this.j=void 0}var d=this;this.i=a;this.debug="true"==this.i.s["debug.bhr.debug"];this.A="true"==this.i.s["debug.bhr.verbose"];this.j=this.i.s["debug.bhr.simLatency"];this.v="false"!=this.i.s["debug.bhr.redirectMainFrame"];
this.Ld={};c.prototype.h=function(e,f){var g=Math.floor(Date.now()/1E3/60);this.j!=g&&(this.cache={});this.cache[e]=f;this.j=g};c.prototype.get=function(e){this.j!=Math.floor(Date.now()/1E3/60)&&(this.cache={});return this.cache[e]};c.prototype.flush=function(){this.cache={}};this.o=new c;this.l=new c;b.prototype.j=function(){this.N={Em:0,Zt:0,Yt:0}};this.h=new b(this.i,this.debug);this.j&&K.warn("Simulating server latency: "+this.j+"ms");yj.onBeforeRequest.addListener(function(e){return xl(d,e)},
{urls:["*://*/*"]},["blocking"]);yj.onHeadersReceived.addListener(function(e){var f=d.h.h[e.requestId];delete d.h.h[e.requestId];f&&f.action?(d.debug&&K.log("[BHR] headersReceivedListener taking action. url=",e.url,", action=",JSON.stringify(f.action)),d.h.N.Zt++,e=f.action):e=void 0;return e},{urls:["*://*/*"]},["blocking"]);chrome.webRequest.onBeforeRedirect.addListener(function(e){"main_frame"==e.type&&-1!=e.tabId&&(d.A&&K.log("[BHR] before redirect: tab id: "+e.tabId+", "+e.url+" => "+e.redirectUrl),
d.Ld[e.tabId]=e.redirectUrl)},{urls:["*://*/*"]});chrome.tabs&&chrome.tabs.onUpdated.addListener(function(e,f,g){d.debug&&K.log("[BHR] Tab updated.",e,g.url);d.Ld[e]=g.url});this.i.H.addListener(function(e){"siteBlockedWithFailedLogin"==e.type?(e=e.data.Cw,e.qv.X="site is blocked with failed login",d.debug&&K.log("siteBlockedWithFailedLogin: "+e.url+", "+e.qg),Yh(d.i.I,e.qg,e.url,e.qv)):"gotRemotePolicy"==e.type&&(d.debug&&K.log("Flush AD cache due to remote policy."),d.l.flush())})}
function xl(a,b){if(!a.i.disabled){"main_frame"==b.type&&-1!=b.tabId&&(a.debug&&K.log("[BHR] Tab "+b.tabId+"'s url is",b.url),a.Ld[b.tabId]=b.url);var c=new URL(b.url);if(c.hostname.endsWith("."+Q.Eb))return{cancel:!1};var d=c.hostname.endsWith(".youtube.com")||c.hostname.endsWith(".youtubeeducation.com");if(("chrome"==a.i.runtime.env.platform||99!=Q.za||Sc(a.i)&&!a.i.G.hb)&&-1!=b.tabId){var e=!1;if("main_frame"!==b.type&&(-1!=b.tabId||b.mm))if(a.debug&&d&&c.pathname.startsWith("/embed/")&&K.log("embed youtube"),
"xmlhttprequest"===b.type&&d&&"/watch"===c.pathname)a.debug&&K.log("bypassing tab url whitelist check for youtube XHR. details.type: "+b.type+" hostname: "+c.hostname+" pathname: "+c.pathname);else{if(-1!=b.tabId)var f=a.Ld[b.tabId];else b.mm&&(f=b.mm);if(f){var g=(new URL(f)).hostname.toLowerCase();g="classroom.google.com"==g||"docs.google.com"==g;var h=!1;g&&d&&(h="true"==ee(a.i.runtime,"bhr.procYtInGClm"));h&&g&&d?a.debug&&K.log("No checking tab white list. tab url=",f,". detail url=",b.url):(d=
a.o.get(f),d||(d=a.i.policy.rb(f).ab,a.o.h(f,d)),d==Q.ea&&(e=!0),a.A&&e&&K.log("skipping bw list check as tab is whitelisted: "+b.url.substring(0,40)+" ("+b.type+"), tabUrl: "+f.substr(0,256)))}}var l=!1;"main_frame"!==b.type&&-1!=b.tabId&&(f=a.Ld[b.tabId])&&(d=a.l.get(f),a.A&&K.log("AD tab ("+f+") checkBWResult from cache = "+JSON.stringify(d)),d||(d=$e(a.i.policy,f),a.A&&K.log("AD tab ("+f+") checkBWResult from policy = "+JSON.stringify(d)),a.l.h(f,d)),d==Q.ea&&(l=!0),a.A&&l&&K.log("Tab is AD whitelisted:"+
b.url.substring(0,40)+" ("+b.type+"), tabUrl: "+f.substr(0,256)));f=a.i.policy.rb(b.url);a.A&&K.log("Decision: "+JSON.stringify(f)+", "+b.url);if(!e){d=f.ab;a.A&&K.log("url: "+b.url.substr(0,256)+" type: "+b.type+" BW:"+d);"main_frame"==b.type&&a.o.h(b.url,d);if(d==Q.ea)return{cancel:!1};if(d==Q.Pa)return a.h.N.Em++,a.debug&&K.log("report: blacklist: "+b.url),c={L:"bl",policy:f.la,F:f.F},f.X&&(c.X=f.X),Pg(a,b,[Q.Vb],c)}(g=f.Xb)&&!Array.isArray(g)&&(K.error("bhr cats not an array: "+g+", "+b.url),
g=[g]);g&&-1!=g.indexOf(Q.Pi)&&-1!==b.tabId&&(d={type:"trackAds0",data:{domain:tc(b.url,0),tabId:b.tabId}},a.i.H.sendMessage(d));if(g){a.A&&K.log("CC cache hit: "+b.url+" = "+g);d=f.da||[];if(!e&&0<d.length)return a.A&&K.log("[BHR] Block category "+d+" for "+b.url),a.h.N.Em++,c=a.i.Aa.Ej.getItem(b.url),f={L:"cc",policy:f.la,F:f.F},c&&Object.assign(f,c.details),Pg(a,b,d,f);if("main_frame"!=b.type&&!l&&a.i.policy.De()&&(-1!=g.indexOf(Q.Pi)||c.hostname.endsWith(".youtube.com")&&"/api/stats/watchtime"==
c.pathname))return a.h.N.Em++,a.A&&K.log("[BHR] Block ad synchronously.",b.url),Pg(a,b,[Q.Pi],{L:"ad",policy:f.la,F:f.F,X:"ads is blocked"})}else a.A&&K.log("CC query for "+b.url),a.h.h[b.requestId]={time:Date.now()},li(a.i.Aa,b.url,a.j).then(function(m){yl(a,b,m,e,l)},function(){});return{cancel:!1}}}}
function yl(a,b,c,d,e){var f=a.h.h[b.requestId],g=!f,h=new URL(b.url);a.A&&K.log("CC query result: "+c+", onHeadersReceived seen: "+g+", "+b.url.substring(0,80));var l=a.i.policy.rb(b.url);a.A&&K.log("Decision after CC query: "+JSON.stringify(l)+", "+b.url);var m=l.ab==Q.Pa?[Q.Vb]:l.da||[];if(!d&&0<m.length){a.debug&&K.log("async blocking: "+m+", "+b.url);c={L:m[0]==Q.Pa?"bl":"cc",policy:l.la,F:l.F};l.X&&(c.X=l.X);var n=Pg(a,b,m,c),q=function(){var u=n.redirectUrl;if("main_frame"==b.type&&(a.debug&&
K.log("forcing tab to go to blocking page"),a.v))try{chrome.tabs.update(b.tabId,{url:u})}catch(r){K.warn("failed to redirect tab: "+b.url+r)}};g?(a.h.N.Yt++,q()):(f.action=n,setTimeout(function(){a.h.h[b.requestId]&&(a.debug&&K.log("OHR not triggered after 1 second, block directly"),q())},1E3))}else"main_frame"!=b.type&&!e&&a.i.policy.De()&&(-1!=c.indexOf(Q.Pi)||h.hostname.endsWith(".youtube.com")&&"/api/stats/watchtime"==h.pathname)?(a.debug&&K.log("Blocking AD in async: "+b.url),l=Pg(a,b,m,{L:"ad",
policy:l.la,F:l.F,X:"ads is blocked"}),g?a.h.N.$x++:f.action=l):g||delete a.h.h[b.requestId]}
function Pg(a,b,c,d,e){a.debug&&K.log("[BHR] genBlockedResponse. url="+b.url+", details.tabId="+b.tabId+", details.initiator="+b.mm+", details.type="+b.type+", info="+JSON.stringify(d)+".");if("main_frame"==b.type||"sub_frame"==b.type){var f=Object.assign({},d);f.context=b.type;for(var g=c.map(function(q){return jf(a.i.Aa,q)}).join(","),h={dynta:"text",dynab:"wellness",dld:"image",dynia:"image",dyngm:"game",rekog:"image",dynva:"video"},l={},m=t(d.L.split(",")),n=m.next();!n.done;n=m.next())n=n.value,
h[n]&&(l[h[n]]=1);0<Object.keys(l).length&&(g+=" (detected by real-time "+Object.keys(l).join(",")+" analysis)");!f.X&&0<g.trim().length&&(f.X="blocked by category: "+g);h=d?d.Ba?d.Ba:"":"";(l=d.policy)||"Study Time"!=d.F||(l="parent");e=a.i.policy.uf(b.url,h,g,c,!0,l,e);if(a.i.runtime.Lg()||a.i.policy.Sg()||88==Q.platform)return g=!1,"sub_frame"==b.type&&1==c.length&&117==c[0]&&(K.log("[BHR] Social network plugin:",b.url),g=!0),"ad"==d.L||g||(Yh(a.i.I,c,b.url,f),a.i.policy.Zg(b.url,h)),{redirectUrl:e};
vh(a.i.G,e).then(function(){}).catch(function(){a.debug&&K.log("CSauth siteBlockedWithFailedLogin: "+b.url+", "+c);f.X="site is blocked with failed login";Yh(a.i.I,c,b.url,f)});return{redirectUrl:b.url}}return"image"==b.type?{redirectUrl:"about:blank"}:{redirectUrl:"data:,"}}
function gl(a){var b=this;this.i=a;this.l=Date.now();this.j=0;this.h={};chrome.webRequest.onResponseStarted.addListener(function(c){return b.onResponseStarted(c)},{urls:["*://*/*"]},["responseHeaders"]);this.i.setInterval(function(){18E6<Date.now()-b.l&&(b.Sa(),b.l=Date.now())},6E4)}
gl.prototype.Sa=function(){var a=this;if("true"!=ee(this.i.runtime,"act.bwstats"))this.j=0,this.h={};else if(!(1048576>this.j)){var b=[],c=Object.keys(this.h);c=c.sort(function(m,n){return a.h[n].total-a.h[m].total});var d=0;c=c.slice(0,10);var e={};c=t(c);for(var f=c.next();!f.done;e={af:e.af},f=c.next()){f=f.value;e.af=this.h[f];var g=Object.keys(e.af.types);g=g.sort(function(m){return function(n,q){return m.af.types[q]-m.af.types[n]}}(e));g=g.slice(0,6);g=t(g);for(var h=g.next();!h.done;h=g.next()){h=
h.value;var l=e.af.types[h];if(.01>l/this.j)break;else b.push({timestamp:Date.now(),type:"bwstats",Z:this.i.runtime.env.Va,qo:{host:f,type:h,Dp:l/1024/1024}})}d+=e.af.total;if(.95<=d/this.j)break}0<this.j-d&&b.push({timestamp:Date.now(),type:"bwstats",Z:this.i.runtime.env.Va,qo:{host:"other",type:"misc",Dp:(this.j-d)/1024/1024}});this.i.I.Sa("misc",b);this.j=0;this.h={}}};
gl.prototype.onResponseStarted=function(a){if(!a.ox)try{if(a.responseHeaders){var b=(new URL(a.url)).hostname,c=psl.get(b);c&&(b=c);for(var d,e,f=t(a.responseHeaders),g=f.next();!g.done;g=f.next()){var h=g.value,l=h.name;l=l.toLowerCase();if("content-type"==l){var m=h.value;m=m.split(";")[0];m=m.trim();e=m.split("/")[0]}else"content-length"==l&&(d=parseInt(h.value))}if(d){this.j+=d;this.h[b]?this.h[b].total+=d:this.h[b]={total:d,types:{}};var n=this.h[b].types;e&&(n[e]=n[e]?n[e]+d:d)}}}catch(q){}};function kl(a){var b=this;this.i=a;Q.wa||yj.onBeforeSendHeaders.addListener(function(c){a:{try{if(!0===b.i.policy.Vj()){lf(b.i.Rc,c.url).state!=Q.ea?c.requestHeaders.push({name:"YouTube-Restrict",value:"Moderate"}):K.log("The youtube url is whitelisted. Do not set youtube restrict mode.",c.url);var d={requestHeaders:c.requestHeaders};break a}d={requestHeaders:c.requestHeaders.filter(b.h)};break a}catch(e){K.error("Exception while enabling Youtube safe mode for",c.url,e)}d=void 0}return d},{urls:["*://www.youtube.com/*",
"*://m.youtube.com/*","*://youtubei.googleapis.com/*","*://youtube.googleapis.com/*","*://www.youtube-nocookie.com/*"]},["blocking","requestHeaders"])}kl.prototype.h=function(a){return"youtube-restrict"===a.name.toLowerCase()?!1:!0};var zl;"undefined"!=typeof module?zl=require("ws"):zl=WebSocket;function Al(){this.j={};this.l={};this.o={};this.A=!1;this.u=Math.floor(1E4*Math.random())}function Bl(a){return"("+a.u+") "+a.constructor.name}k=Al.prototype;
k.read=function(){var a=this,b,c,d,e;return J(function(f){e=new Promise(function(g,h){b=function(l){a.A&&K.log(Bl(a),"RtcChannel read message.",l);g(l)};c=function(l){h(l)};d=function(){h("channel closed")};a.on("message",b);a.on("error",c);a.on("close",d)});e.finally(function(){a.removeEventListener("message",b);a.removeEventListener("error",c);a.removeEventListener("close",d)});return f.return(e)})};k.send=function(){return J(function(){throw Error("Not implemented in abstract class");})};
k.on=function(a,b){this.j[a]||(this.j[a]=[]);this.j[a].push(b);if(this.o[a]&&0<this.o[a].length)for(b=this.o[a];0<b.length;){var c=b.shift();this.ha.apply(this,[a].concat(ca(c)))}};k.once=function(a,b){this.l[a]||(this.l[a]=[]);this.l[a].push(b);if(this.o[a]&&0<this.o[a].length)for(K.warn("Channel: "+this.constructor.name+": Delivering queued messages, "+a),b=this.o[a];0<b.length;){var c=b.shift();this.ha.apply(this,[a].concat(ca(c)))}};k.addEventListener=function(a,b){this.on(a,b)};
k.removeEventListener=function(a,b){var c=!1;if(this.j[a]){var d=this.j[a].indexOf(b);-1!=d&&(this.j[a].splice(d,1),c=!0);0==this.j[a].length&&delete this.j[a]}this.l[a]&&(b=this.l[a].indexOf(b),-1!=b&&(this.l[a].splice(b,1),c=!0),0==this.l[a].length&&delete this.l[a]);c||K.warn("RtcChannel: "+this.constructor.name+": attempting to remove non-existing listener")};k.close=function(){return J(function(){throw Error("Not implemented in abstract class");})};
k.ha=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];var e=this,f,g,h,l,m,n;return J(function(q){if(e.j[a]||e.l[a]){if(e.j[a])for(f=t(e.j[a]),g=f.next();!g.done;g=f.next()){h=g.value;try{h.apply(null,ca(c))}catch(u){K.error("Exception while emitting "+a+" event"),K.error(u)}}if(e.l[a])for(l=t(e.l[a]),g=l.next();!g.done;g=l.next()){m=g.value;e.removeEventListener(a,m);try{m.apply(null,ca(c))}catch(u){K.error("Exception while emitting "+a+" event"),K.error(u)}}}else["message",
"error"].includes(a)&&(e.o[a]||(e.o[a]=[]),n=e.o[a],100<=n.length&&(K.warn("Channel: "+Bl(e)+": Too many queued messages, "+a+". Drop oldest message."),n.shift()),n.push(c),e.debug&&K.warn("Channel: "+Bl(e)+": Incoming message queued, "+a+". Currently total "+n.length+" messages."));A(q)})};
function Cl(a){Al.call(this);var b=this;this.fa=a;this.h=new Promise(function(c,d){b.fa.addEventListener("open",function(e){b.A&&K.log("WebSocketChannel open event:",e);c()});b.fa.addEventListener("error",function(e){b.A&&K.log("WebSocketChannel error event:",e);d(e)});b.fa.addEventListener("close",function(e){b.A&&K.log("WebSocketChannel close event:",e);d("ws ch closed.")});b.A&&K.log("WebSocketChannel: this.ws.readyState=",b.fa.readyState);switch(b.fa.readyState){case zl.OPEN:c();break;case zl.CONNECTING:break;
default:d("WebSocket closing or closed"+b.fa.readyState)}});this.fa.addEventListener("message",function(c){c=c.data;try{c=JSON.parse(c),b.A&&K.log(Bl(b),"WebSocketChannel received message:",c)}catch(d){}b.ha("message",c)});this.fa.addEventListener("close",function(){b.A&&K.warn(Bl(b),"WebSocketChannel close event.");b.ha("close")});this.fa.addEventListener("error",function(c){b.A&&K.warn(Bl(b),"WebSocketChannel error event.",c);b.ha("error",c)})}x(Cl,Al);
Cl.prototype.send=function(a,b){b=void 0===b?!1:b;var c=this;return J(function(d){if(1==d.h)return c.A&&K.log(Bl(c),"WebSocketChannel send message.",a,b),b?d.m(2):y(d,c.h,2);if(c.fa.readyState!=zl.OPEN)return K.error("WS data channel state is not open: "+c.fa.readyState+", send ignored"),d.return();"object"==typeof a&&(a=JSON.stringify(a));c.fa.send(a);A(d)})};Cl.prototype.close=function(){this.A&&K.warn(Bl(this),"WebSocketChannel close.");this.fa.close()};
function Dl(){this.h=new El;this.j=new El;this.h.h=this.j;this.j.h=this.h}function El(){Al.call(this);this.closed=!1}x(El,Al);El.prototype.send=function(a){var b=this;return J(function(c){b.closed&&b.ha("error","Pipe already closed, cannot send message");b.h&&b.h.ha("message",a);A(c)})};El.prototype.close=function(){this.closed||(this.ha("close"),this.closed=!0);this.h&&!this.h.closed&&this.h.close()};
function Fl(a){Al.call(this);var b=this;this.channel=a;this.h={};for(var c={},d=t(["message","error","close"]),e=d.next();!e.done;c={Xe:c.Xe},e=d.next())c.Xe=e.value,this.h[c.Xe]=function(f){return function(g){for(var h=[],l=0;l<arguments.length;++l)h[l]=arguments[l];b.A&&K.log(Bl(b),"ProxyChannel event",f.Xe);b.ha.apply(b,[f.Xe].concat(ca(h)))}}(c),a.on(c.Xe,this.h[c.Xe])}x(Fl,Al);
Fl.prototype.send=function(a){var b=this;return J(function(c){return 1==c.h?(b.A&&K.log(Bl(b),"ProxyChannel send message.",a),y(c,b.channel.send(a),2)):c.return(c.j)})};Fl.prototype.stop=function(){this.A&&K.warn(Bl(this),"ProxyChannel stop.");for(var a=t(["message","error","close"]),b=a.next();!b.done;b=a.next())b=b.value,this.channel.removeEventListener(b,this.h[b])};
Fl.prototype.close=function(){var a=this;return J(function(b){if(1==b.h)return a.A&&K.warn(Bl(a),"ProxyChannel close."),y(b,a.channel.close(),2);a.stop();A(b)})};
function Gl(a){Al.call(this);var b=this;this.h=a;this.h.addEventListener("message",function(c){c=c.data;try{c=JSON.parse(c),b.A&&K.log(Bl(b),"RtcPeerDataChannel received message.",c)}catch(d){}b.ha("message",c)});this.h.addEventListener("error",function(c){b.A&&K.warn(Bl(b),"RtcPeerDataChannel error event.",c);b.ha("error",c)});this.h.addEventListener("close",function(){b.A&&K.warn(Bl(b),"RtcPeerDataChannel close event.");b.ha("close")})}x(Gl,Al);
Gl.prototype.send=function(a){var b=this;return J(function(c){b.A&&K.log(Bl(b),"RtcPeerDataChannel send message.",a);if("open"!=b.h.readyState)return K.error("RTC data channel state is not open: "+b.h.readyState+", send ignored"),c.return();"object"==typeof a&&(a=JSON.stringify(a));b.h.send(a);A(c)})};Gl.prototype.close=function(){var a=this;return J(function(b){a.A&&K.warn(Bl(a),"RtcPeerDataChannel close.");a.h.close();A(b)})};
"undefined"!=typeof module&&(module.exports={fw:Al,Yv:Dl,kw:Cl,Yq:Fl,gw:Gl});var Hl,Il;"undefined"!=typeof module?"undefined"==typeof Q?(Hl=require("wrtc").RTCSessionDescription,Il=require("./channel").Yq):(Il=Fl,Hl=void 0):("undefined"!=typeof RTCSessionDescription&&(Hl=RTCSessionDescription),Il=Fl);
function Jl(a,b,c){c=void 0===c?{}:c;var d=Il.call(this,a)||this;d.Ca=b;d.options=c;d.debug=c.debug;d.Ij="";Hl||"undefined"==typeof module||"undefined"==typeof Q||(Hl=nodeMods.wrtc.RTCSessionDescription);d.Y=c.Y?c.Y+": ":"";d.Zj=[];d.nk=[];d.on("message",function(e){d.ii(e)});d.Ca.addEventListener("icecandidate",function(e){if(!d.options.ep&&(d.options.debug&&K.log(d.Y+"send new ICE candidate: "+JSON.stringify(e.candidate)),e.candidate)){d.send({type:"iceCandidate",data:{candidate:JSON.stringify(e.candidate)}});
try{var f=Kl(e.candidate);f&&d.Zj.push(f)}catch(g){K.warn(d.Y+"Cannot parse local candidate: "+JSON.stringify(e.candidate))}}});d.Ca.addEventListener("icecandidateerror",function(e){"connected"!=d.Ca.connectionState&&600!=e.errorCode&&K.error("ice err"+e.errorCode+". url=",e.url,e.errorText,"hostCandidate=",e.hostCandidate)});return d}x(Jl,Il);
function Kl(a){return a.type?{timestamp:Date.now(),address:a.address,protocol:a.protocol,port:a.port,type:a.type}:(a=/^candidate:.+ (\S+) \d+ typ (\S+)/.exec(a.candidate))?{timestamp:Date.now(),address:a[1],type:a[2]}:null}
Jl.prototype.ii=function(a){var b=this,c,d;J(function(e){if("iceCandidate"==a.type){if(b.options.ep)return e.return();b.options.debug&&K.log(b.Y+"remote candidate: "+JSON.stringify(a.data.candidate));"string"!=typeof a.data.candidate&&K.error(b.Y+"iceCandidate not stringified, will not work with obfuscation");b.Ca&&b.Ca.addIceCandidate(JSON.parse(a.data.candidate));try{c=JSON.parse(a.data.candidate),(d=Kl(c))&&b.nk.push(d)}catch(f){K.warn(b.Y+"Cannot parse remote candidate: "+JSON.stringify(a.data.candidate))}}else"error"==
a.type&&b.ha("error",a.data.message);A(e)})};function Ll(a,b){a.Ij+=b;K.warn(b)}
Jl.prototype.connect=function(){var a=this;return J(function(b){a.Jh||(a.Jh=new Promise(function(c,d){a.Ca.addEventListener("connectionstatechange",function(){a.options.debug&&K.log(a.Y+"New conn state: "+a.Ca.connectionState);"connected"==a.Ca.connectionState&&(a.connected=!0,c(a.Ca))});a.Ca.addEventListener("error",function(e){d(e)});a.on("error",function(e){a.debug&&K.warn("RtcPeer channel error.",e);d("object"==typeof e?e:Error(e))});a.on("close",function(){a.debug&&K.warn("RtcPeer channel closed.");
d(Error("channel closed."))})}),a.Jh.catch(function(c){a.debug&&K.warn("RtcPeer connect caught error.",c);a.Ca.close();a.stop()}),a.Jh.then(function(){a.debug&&K.log(a.Y+"Closing signaling session: "+Bl(a));a.close()}),a.Jh.finally(function(){for(var c={},d=t(a.Zj),e=d.next();!e.done;e=d.next())c[e.value.type]=!0;c=Object.keys(c);a.options.debug&&K.log(a.Y+" Local candidate types: "+c.join(", "));0==a.Zj.length?Ll(a,a.Y+" No local candidates. Possible TURN server or firewall problem."):1==c.length&&
"host"==c[0]&&Ll(a,a.Y+" Only host type seen for local candidates. Possible TURN server or firewall problem.");c={};d=t(a.nk);for(e=d.next();!e.done;e=d.next())c[e.value.type]=!0;c=Object.keys(c);a.options.debug&&K.log(a.Y+" Remote candidate types: "+c.join(", "));0==a.nk.length?Ll(a,a.Y+" No remote candidates. Possible TURN server or firewall problem."):1==c.length&&"host"==c[0]&&Ll(a,a.Y+" Only host type seen for remote candidates. Possible TURN server or firewall problem.")}));return b.return(a.Jh)})};
function Ml(a,b,c){a=Jl.call(this,a,b,c)||this;a.mo=!0;return a}x(Ml,Jl);Ml.prototype.ii=function(a){var b=this;J(function(c){b.mo?"offer"==a.type?("string"!=typeof a.data.Jm&&K.error(b.Y+"offer not stringified, will not work with obfuscation"),b.createAnswer(JSON.parse(a.data.Jm))):Jl.prototype.ii.call(b,a):b.mo=!0;A(c)})};
Ml.prototype.createAnswer=function(a){var b=this,c;return J(function(d){if(1==d.h)return b.Ca.setRemoteDescription(new Hl(a)),b.options.debug&&K.log(b.Y+"Remote desc set"),y(d,b.Ca.createAnswer(),2);c=d.j;b.Ca.setLocalDescription(c);b.options.debug&&K.log(b.Y+"Local desc set");b.send({type:"answer",data:{pl:JSON.stringify(c)}});A(d)})};function Nl(a,b,c){return Jl.call(this,a,b,c)||this}x(Nl,Jl);
Nl.prototype.createOffer=function(){var a=this,b;return J(function(c){if(1==c.h)return y(c,a.Ca.createOffer(a.options.gy),2);if(3!=c.h)return b=c.j,a.options.debug&&K.log(a.Y+"Offer created: "+JSON.stringify(b)),y(c,a.Ca.setLocalDescription(b),3);a.options.debug&&K.log(a.Y+"Local description set");return y(c,a.send({type:"offer",data:{Jm:JSON.stringify(b)}}),0)})};
Nl.prototype.ii=function(a){var b=this,c;J(function(d){if(1==d.h){if("answer"!=a.type)return Jl.prototype.ii.call(b,a),d.m(0);"string"!=typeof a.data.pl&&K.error(b.Y+"answer not stringified, will not work with obfuscation");c=new Hl(JSON.parse(a.data.pl));return y(d,b.Ca.setRemoteDescription(c),3)}b.options.debug&&K.log(b.Y+"Remote desc set");A(d)})};"undefined"!=typeof module&&(module.exports={dw:Ml,ew:Nl});function Ol(a,b){b=void 0===b?{}:b;this.i=a;this.options=b;this.debug=b.debug;this.o=0;this.j={};this.l={};this.uuid=Cc()}function Pl(){return J(function(a){A(a)})}k=Ol.prototype;
k.onCommand=function(a){var b=this,c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E;return J(function(G){if(1==G.h){if("ping"==a.type)return b.debug&&K.log("[HC]("+b.uuid+") Got ping. Sending pong. Id=",a.data.id),b.send({type:"pong",data:{id:a.data.id}}),G.m(0);if("newRtc"!=a.type){if("newRtcSignal"==a.type)if(c=a.data&&a.data.id,d=b.j[c])if(a.data.signal&&"wsTeacherConnect"==a.data.signal.type){K.warn("[HC]("+b.uuid+") Teacher connection switch to WS relay: "+a.data.signal.data.caller);if(e=b.l[c])e.Ob("switch to ws relay",
!0),delete b.l[c];f={debug:b.debug,R:a.data.signal.data.caller,Xc:b.options.Xc};new Ql(b.i,d,f)}else a.data.signal&&"rtcTeacherConnect"==a.data.signal.type?(K.log("[HC]("+b.uuid+") RTC teacher connection: "+a.data.signal.data.caller),g=Rl(),d.send({type:"rtcTeacherConnectAck",data:{error:g?"RTC not supported.":void 0}})):d.ha("message",a);else K.error("[HC]("+b.uuid+") Invalid session ID in command: "+JSON.stringify(a));else"newRtcClose"==a.type&&(h=a.data&&a.data.id,(l=b.j[h])?(l.close(),b.debug&&
K.warn(Bl(l),"[HC]("+b.uuid+") Delete active session."),delete b.j[h]):K.error("[HC]("+b.uuid+") Invalid session ID in command: "+JSON.stringify(a)));return G.m(0)}m=b.o;n=a.data.caller;K.log("[HC]("+b.uuid+") Incoming call from "+n);u=(q=b.i.runtime.va())&&(q.includes(".deledao.org")||q.includes("@test-school.deviceadmin.goog")||q.includes("@dldschool.org"));if(!b.i.sa()&&!u&&"true"!=b.i.s["debug.clm.autoConnect"]&&12==Q.platform&&"undefined"!=typeof confirm&&!confirm(n+" wants to connect via RTC"))return b.send({type:"newRtcAck",
data:{error:"Student refused connection"}}),G.return();if(!n)return b.send({type:"newRtcAck",data:{error:"Must supply a teacher ID"}}),G.return();r=new Sl(b.h,m,{debug:b.debug});b.j[m]=r;r.on("close",function(){b.debug&&K.warn(Bl(r),"[HC]("+b.uuid+") Delete active session.");delete b.j[r.D]});return(p=Rl())?G.m(4):y(G,Tl(),5)}4!=G.h&&(v={iceServers:G.j},w=new RTCPeerConnection(v),z=new Ml(r,w,{debug:b.debug,ep:p}),B={debug:b.debug,R:n,rk:z,Xc:b.options.Xc},D=new Ul(b.i,w,B),b.l[m]=D,E=new Promise(function(M,
T){setTimeout(function(){T("RTC answer timed out")},5E3)}),Promise.race([z.connect(),E]).catch(function(){K.error("[HC]("+b.uuid+") RTC teacher connection timed out: "+n);D.Ob("rtc connecting timeout",!0)}).finally(function(){delete b.l[m]}));b.send({type:"newRtcAck",data:{id:m,Z:b.i.runtime.va()}});b.o++;A(G)})};k.send=function(a){var b=this;return J(function(c){if(1==c.h)return b.debug&&K.log("[HC]("+b.uuid+") BaseHomeConnection send message.",a),y(c,Pl(),2);b.h.send(a);A(c)})};
k.close=function(){var a=this;return J(function(b){a.h&&a.h.close();a.h=void 0;A(b)})};k.Kn=function(){return J(function(){throw Error("connect() not implemented on abstract class");})};k.connect=function(){var a=this,b;return J(function(c){if(1==c.h)return b=a,y(c,a.Kn(),2);b.h=c.j;a.h=new Vl(a.h,{debug:a.debug});a.h.on("message",function(d){a.debug&&K.log("[HC]("+a.uuid+") BaseHomeConnection received message.",d);a.onCommand(d)});return c.return(a.h)})};k.isConnected=function(){return void 0!=this.h};
function Sl(a,b,c){Al.call(this);var d=this;this.closed=!1;this.h=a;this.D=b;this.name="TeacherChannel";this.options=c;this.debug=c.debug;this.v={};b={};c=t(["error","close"]);for(var e=c.next();!e.done;b={Ye:b.Ye},e=c.next())b.Ye=e.value,this.v[b.Ye]=function(f){return function(g){for(var h=[],l=0;l<arguments.length;++l)h[l]=arguments[l];d.debug&&K.warn(Bl(d),"TeacherChannel event",f.Ye);d.ha.apply(d,[f.Ye].concat(ca(h)))}}(b),a.on(b.Ye,this.v[b.Ye])}x(Sl,Al);
Sl.prototype.send=function(a){var b=this;return J(function(c){b.h.send({type:"newRtcSignal",data:{id:b.D,signal:a}});A(c)})};Sl.prototype.close=function(){var a=this,b,c,d;return J(function(e){if(!a.closed)for(a.debug&&K.warn(Bl(a),"TeacherChannel close()."),a.closed=!0,a.ha("close"),b=t(["error","close"]),c=b.next();!c.done;c=b.next())d=c.value,a.h.removeEventListener(d,a.v[d]);A(e)})};
Sl.prototype.ha=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];"message"==a?(c=c[0],c.data&&c.data.id==this.D&&Al.prototype.ha.call(this,"message",c.data.signal)):Al.prototype.ha.call.apply(Al.prototype.ha,[this,a].concat(ca(c)))};function Wl(a,b){b=void 0===b?{}:b;Ol.call(this,a,b)}x(Wl,Ol);
Wl.prototype.Kn=function(){var a=this,b,c,d,e,f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:b=Xl?"wss://localhost:8082/WsStudentConnect":"wss://signal."+Oa+"/WsStudentConnect";c=a.i.runtime.env.gh;if(!c)throw Error("user token not available yet");b+="?token="+encodeURIComponent(c);d=new WebSocket(b);e=new Cl(d);C(r,2);f=new Promise(function(p,v){setTimeout(function(){v(Error("wait ws open timeout."))},5E3)});return y(r,Promise.race([e.h,f]),4);case 4:K.log("[HC]("+a.uuid+") WS connected to command server");
F(r,3);break;case 2:throw g=H(r),K.warn("[HC]("+a.uuid+") Wait ws open timeout."),g;case 3:h=3,l=new Vl(e,{debug:a.debug}),m=a.i.runtime;case 5:if(!(0<h)){r.m(6);break}return y(r,new Promise(function(p){setTimeout(p,300)}),7);case 7:return h--,y(r,l.send({type:"auth",data:{Z:m.va(),group:m.env.jb,platform:m.env.platform,uuid:m.env.uuid,version:m.ob(),iu:m.env.xa,Xj:m.env.Xj}}),8);case 8:return n=void 0,q=new Promise(function(p,v){setTimeout(function(){v(Error("auth timed out"))},1E3)}),C(r,9),y(r,
Promise.race([l.read(),q]),11);case 11:n=r.j;F(r,10);break;case 9:if(u=H(r),K.warn("[HC]("+a.uuid+") Awaiting auth ack: "+u),0<h){r.m(5);break}else throw Error("Auth error: did not get auth ack");case 10:if("authAck"==n.type){if(n.data&&n.data.error)throw Error("Auth error: "+n.data.error);K.log("[HC]("+a.uuid+") WS auth ok");r.m(6);break}else K.warn("[HC]("+a.uuid+") authAck expected, but saw "+n.type);r.m(5);break;case 6:return l.stop(),a.ik(),r.return(e)}})};
Wl.prototype.ik=function(){var a=this,b,c,d,e,f;J(function(g){switch(g.h){case 1:b=6E4,c={};case 2:if(a.i.Yc){g.m(0);break}return y(g,new Promise(function(h){setTimeout(h,b)}),4);case 4:if(!a.h){K.warn("[HC]("+a.uuid+") Exit pingloop because dataChan is not available.");g.m(0);break}c.cg=Math.floor(1E3*Math.random());a.debug&&K.log("[HC]("+a.uuid+") WsHomeConnection: ping server with "+c.cg);a.send({type:"ping",data:{id:c.cg}});d=new Promise(function(h,l){setTimeout(function(){l(Error("Wait pong timed out"))},
5E3)});e=new Promise(function(h){return function(l){var m;return J(function(n){if(1==n.h)return y(n,a.h.read(),4);m=n.j;return"pong"==m.type&&(a.debug&&K.log("[HC]("+a.uuid+") WsHomeConnection: got pong with "+h.cg),m.data.id==h.cg)?(l(),n.m(0)):n.m(1)})}}(c));C(g,5);return y(g,Promise.race([e,d]),7);case 7:F(g,6);break;case 5:f=H(g);K.warn("[HC]("+a.uuid+") Command channel ping: "+f);a.h&&a.h.ha("error",{error:Error("Command channel ping failed")});a.close();g.m(0);break;case 6:c={cg:c.cg},g.m(2)}})};
function el(a){var b=this;this.i=a;this.debug="true"==this.i.s["debug.clm.debug"];this.j=new Qc;Yl=new Zl(a);$l=new am(a,this.debug);Ef=new bm(a,this);this.i.H.addListener(function(c){return J(function(d){"policyDisabled"==c.type?b.disconnect():"postUserSignedIn"==c.type||"policyChanged"==c.type?!b.i.disabled&&b.i.runtime.va()&&ge(b.i.runtime,"class")?(b.Go!=b.i.runtime.va()&&b.disconnect(),b.connect()):b.disconnect():"userSignedOut"==c.type&&b.disconnect();A(d)})});this.i.addListener(function(c,
d,e){if("classMgmt"==c.recipient)if("connect"==c.type)b.disconnect(),b.connect();else if("disconnect"==c.type)b.disconnect();else if("raiseHand"==c.type){if(Oi){e=t(Oi);for(var f=e.next();!f.done;f=e.next())f.value.send({type:"raiseHand"})}}else if("getChatHistory"==c.type){if(e){c={};d=[];if(Oi){var g=t(Oi);for(f=g.next();!f.done;f=g.next()){f=f.value;var h=f.lb||f.R;h.includes("@")&&(h=h.substring(0,h.indexOf("@")));c[f.R]=h;d.includes(h)||d.push(h)}}f=cm();g=[];if(h=b.i.ja.oj.pj.all){b.debug&&
K.log("getChatHistory: "+JSON.stringify(h));for(var l=0;l<h.length;l++){var m=h[l],n=m.tid;g.push({tname:c[n]||n,msg:m.msg,time:m.time,"in":m["in"]})}}e({className:f,chats:g,teachers:d})}}else if("chatReply"==c.type){cm();if(c.data.text&&0<c.data.text.trim().length&&(dm(b.i.ja.oj,"teacher",c.data.text,!1),Oi))for(d=t(Oi),f=d.next();!f.done;f=d.next())f.value.sendMessage(c.data.text);e&&e("replied")}else if("chatWindow"==c.type)b.i.ja.um();else if("unblockUrlClass"==c.type){f=c.data;if(qc(f.studentId,
f.studentOu,f.studentGroups,f.url,f.category)!=f.intchk)return e({error:"Int check fail."}),!1;e&&d&&d.tab&&d.tab.id&&(b.debug&&K.log("[1138] Got unblock url message.",c,d.tab),e=em(!0),12==Q.platform?fm(e,d.tab.id,c):99==Q.platform&&fm(e,c.tabId,c))}});this.Xc="https://static."+Oa+"/default/chatReply.html"}el.prototype.fd=function(){return{Xc:this.Xc,Tu:Oi&&0<Oi.length}};
function Sj(){if(Oi){for(var a,b=t(Oi),c=b.next();!c.done;c=b.next())if(c=c.value,"control"==c.mode){a=c;break}else"view"!=c.mode||a||(a=c);if(a)return{className:a.className,Y:a.Y,R:a.R}}}function cm(){var a=Sj();return a?a.className:"None"}function Ig(a){var b=Sj();if(b)return b.R+":"+b.className;if(a.i.policy&&a.i.policy.wf&&a.i.policy.Ig&&(b=a.i.policy.wf(),a=a.i.policy.Ig(),b&&a))return b+":"+a}function Jg(a){var b=Sj();if(b)return b.R;if(a.i.policy&&a.i.policy.wf)return a.i.policy.wf()}
el.prototype.disconnect=function(){this.dc&&(K.log("Closing command server connection"),this.dc.close(),this.Go=this.dc=void 0);this.h=!1;this.j.signal()};function gm(a){return!a.i.disabled&&a.i.runtime.va()&&ge(a.i.runtime,"class")}
el.prototype.connect=function(){var a=this,b,c,d,e,f,g,h,l;return J(function(m){switch(m.h){case 1:if(a.h)return a.debug&&K.warn("Another home connect is in progress."),m.return();if(a.dc&&a.dc.isConnected())return K.log("Already connected to command server, skipping ..."),m.return();b=5E3;a.h=!0;d={};case 2:if(a.i.Yc||!gm(a)){m.m(3);break}a.Go=a.i.runtime.va();C(m,4);e={debug:a.debug,Xc:a.Xc};a.dc=new Wl(a.i,e);f=new Promise(function(n,q){setTimeout(function(){q("WS home connect timed out")},1E4)});
return y(m,Promise.race([a.dc.connect(),f]),6);case 6:c=m.j;d.Zf=a.dc.uuid;K.log("[HC]("+d.Zf+") Connected to command server");a.i.I&&Qd(a.i.I,"Home connection established.");d.th=function(n){return function(){return J(function(q){if(1==q.h)return K.warn("[HC]("+n.Zf+") Reconnecting!"),a.dc?y(q,a.dc.close(),3):q.m(2);2!=q.h&&(a.dc=void 0);!a.h&&gm(a)&&(K.log("Reconnecting to command server ..."),a.connect());A(q)})}}(d);c.on("error",function(n){return function(q){return J(function(u){K.warn("[HC]("+
n.Zf+") data chan error: "+q);n.th();A(u)})}}(d));c.on("close",function(n){return function(){return J(function(q){K.warn("[HC]("+n.Zf+") data chan unexpectedly closed");n.th();a.i.I&&Qd(a.i.I,"Home connection closed.");A(q)})}}(d));a.i.setInterval(function(n){return function(){a.dc&&a.dc.isConnected()||!gm(a)||a.h||(K.error("HomeConn missing during check, force to reconnect"),n.th())}}(d),3E4);m.m(3);break;case 4:return g=H(m),K.error("[HC] Command connection: ",g),c&&c.close(),a.debug&&K.log("Command: random sleep before normal binary backoff for re-connecting"),
h=new Promise(function(n){setTimeout(n,b+5E3*Math.random())}),l=a.j.wait().then(function(){return Promise.reject()}),C(m,7),y(m,Promise.race([h,l]),9);case 9:F(m,8);break;case 7:H(m);K.warn("Command connect() interrupted");m.m(3);break;case 8:b=Math.min(2*b,3E4);case 5:d={Zf:d.Zf,th:d.th};m.m(2);break;case 3:a.h=!1,A(m)}})};var Xl=!1;
function hm(){S.call(this,{cf:"allowAllSites",pl:"answer",Uc:"audioPlaying",Wb:"blockedUrls",caller:"caller",candidate:"candidate",T:"category",className:"className",bb:"classUUID",Mr:"connections",content:"content",credential:"credential",data:"data",details:"details",expiration:"expiration",group:"group",info:"info",enable:"enable",error:"error",ap:"favicon",Bd:"granted",id:"id",idle:"idle",fc:"lockdown",message:"message",mode:"mode",Bm:"msgId",name:"name",dy:"newRtc",ey:"newRtcAck",au:"nMoreTabs",
Jm:"offer",Nm:"operation",password:"password",platform:"platform",reason:"reason",requestId:"requestId",wc:"restrictions",Y:"sessionName",signal:"signal",zk:"snapshotId",Iy:"studentOu",Hy:"studentGroups",tabId:"tabId",kd:"tabNumberLimit",R:"teacherId",lb:"teacherName",text:"text",timestamp:"timestamp",title:"title",rn:"turn",type:"type",url:"url",urls:"urls",user:"user",Z:"userId",gh:"userToken",uuid:"uuid",version:"version",md:"videoPlaying",iu:"offCampus",Xj:"lastSignInTs",image:"image",Qu:"ssTotalCount",
Ru:"ssTotalLength",N:"stats",positionX:"positionX",positionY:"positionY",color:"color",size:"size"},"ClassroomMgmtObf")}x(hm,S);var om=new hm;function Vl(a,b){b=void 0===b?{}:b;Fl.call(this,a);this.name="ClassroomMgmt.ObfChannel";this.options=b;this.debug=b.debug}x(Vl,Fl);Vl.prototype.send=function(a){var b=this,c,d;return J(function(e){if(1==e.h)return b.A&&K.log(Bl(b),"ObfChannel send message.",a),c=Xa(om,a),y(e,Fl.prototype.send.call(b,c),2);d=e.j;return e.return(d)})};
Vl.prototype.ha=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];"message"==a?(c=U(om,c[0]),this.A&&K.log(Bl(this),"ObfChannel received message.",c),Fl.prototype.ha.call(this,"message",c)):Fl.prototype.ha.call.apply(Fl.prototype.ha,[this,a].concat(ca(c)))};
function Zl(a){this.i=a;this.h=Xl?{urls:["turn:localhost?transport=udp","turn:localhost?transport=tcp"],username:"foo",credential:"bar"}:{urls:["turn:turn."+Oa+":3478?transport=udp","turn:turn."+Oa+":443?transport=udp","turns:turn."+Oa+":443?transport=tcp"],username:void 0,credential:void 0};this.expiration=void 0}var Yl;function Tl(){return J(function(a){return a.return(pm())})}
function pm(){var a=Yl,b,c,d,e,f;return J(function(g){switch(g.h){case 1:if(a.h.username&&!(Date.now()>1E3*(a.expiration-3))){g.m(2);break}C(g,3);b=Q.oc+"/GetRtcCredentials";c={version:"1.0",userToken:a.i.runtime.env.gh};return y(g,md(a.i.http,b,"POST",JSON.stringify(c)),5);case 5:d=g.j;e=U(om,JSON.parse(d));if(e.error)throw Error(e.error);a.h.username=e.rn.user;a.h.credential=e.rn.password;a.expiration=e.rn.expiration;F(g,2);break;case 3:f=H(g),K.error("GetRtcCredentials: "+f);case 2:return g.return([a.h])}})}
function am(a,b){this.i=a;this.debug=b;this.h=0}var $l;function qm(a){var b=$l;b.debug&&K.log("[ConnectionConditioner] on tear down.",a);80>a?(b.h++,2==b.h&&(b.j=Date.now()+18E5,b.h=0)):b.h=0}function Rl(){var a=$l,b=!1;"undefined"==typeof RTCPeerConnection?b=!0:"true"==a.i.s["debug.clm.forcewsrelay"]?b=!0:"false"==a.i.s["debug.clm.forcewsrelay"]?b=!1:"true"==ee(a.i.runtime,"clm.forceWsRelay")?b=!0:a.j&&(b=Date.now()<a.j);a.debug&&K.log("[ConnectionConditioner] is force ws relay =",b);return b}
function bm(a,b){this.i=a;this.j=b;try{this.h={};var c=this.i.s["class.history"];if(c)for(var d=JSON.parse(c),e=t(d),f=e.next();!f.done;f=e.next()){var g=U(om,f.value);this.h[g.bb]=g}this.j&&this.j.debug&&K.log("[CH] Read class history. this.classHistoryMap=",JSON.stringify(this.h),", lstore=",c)}catch(h){K.error("[CH] ClassHistory construct error.",h)}}var Ef;function rm(a){var b=Ef;try{a&&(b.h[a]={bb:a,timestamp:Date.now()},Ff(b))}catch(c){K.error("[CH] recordClassHistory error.",c)}}
function Ff(a){var b=[],c;for(c in a.h){var d=Xa(om,a.h[c]);b.push(d)}b=JSON.stringify(b);a.i.s["class.history"]=b;a.j&&a.j.debug&&K.log("[CH] Saved class history. this.classHistoryMap=",JSON.stringify(a.h),", lstore=",b)};function sm(a,b){var c=this;this.i=a;this.options=b;this.R=b.R;this.Pr=Date.now();this.debug=b.debug;this.hk=[];this.S=new Qc;this.id=Cc();this.mode="none";this.ga="true"==ee(this.i.runtime,"clm.recordMsg");Oi||(Oi=[]);Oi.push(this);tm||(tm=function(d){if("classroomViolation"==d.type)for(var e=t(Oi),f=e.next();!f.done;f=e.next())f=f.value,"control"!=f.mode&&"view"!=f.mode||f.send({type:"violation",data:d.data})},this.i.H.addListener(tm),this.i.ja.addEventListener("idleState",function(d){var e;"active"==
d?e=!1:"idle"==d&&(e=!0);if(void 0!=d){d=t(Oi);for(var f=d.next();!f.done;f=d.next())f.value.send({type:"status",data:{idle:e}})}}));um||(um=this.i.setInterval(function(){vm(c)},3E5));(this.Xa=this.i.ja.Xa)&&this.Xa.lm();99==Q.platform&&wm(this)}var Oi,tm,um,xm,ym;function wm(a){a.i.ja.Ad().addEventListener("proxyFrontendMessage",function(b){b=b.Qg;"teacher"===b.recipient&&"getActivePageResponse"===b.type&&zm(a,b.data,a.zk)})}k=sm.prototype;
k.ik=function(){var a=this,b,c,d,e,f,g,h,l;J(function(m){switch(m.h){case 1:b=3E4,c=5E3,d=3,e={};case 2:if(a.i.Yc||!Oi.includes(a)){m.m(0);break}return y(m,new Promise(function(n){setTimeout(n,b)}),4);case 4:if(!a.h){a.debug&&K.log("["+a.id+"][TC] Exit ping loop because connection is torn down.");m.m(0);break}e.$e=Math.floor(1E3*Math.random());e.Qk=Date.now();f=new Promise(function(n,q){setTimeout(function(){q(Error("TC wait pong timed out"))},d*c)});g=new Promise(function(n){return function(q){var u,
r;return J(function(p){if(1==p.h)return y(p,a.h.read(),4);u=p.j;if("pong"!=u.type)return p.m(1);u.data.id==n.$e&&(r=Date.now()-n.Qk,a.debug&&K.log("["+a.id+"][TC] Ping latency=",r,"ms."),a.hk.push(r));return u.data.id>=n.$e&&u.data.id<n.$e+d?(q(),p.m(0)):p.m(1)})}}(e));h=0;case 5:if(!(h<d))return C(m,9),y(m,Promise.race([g,f]),11);a.send({type:"ping",data:{id:e.$e+h}},!0);a.debug&&K.log("["+a.id+"][TC] Send ping. id=",e.$e+h);return y(m,new Promise(function(n){setTimeout(n,c)}),6);case 6:h++;m.m(5);
break;case 11:F(m,10);break;case 9:l=H(m);K.warn("["+a.id+"][TC] Ping: ",l);a.h?a.h.ha("error",{error:Error("Ping failed")}):K.log("["+a.id+"] Exit ping loop because connection is not available anymore.");m.m(0);break;case 10:e={$e:e.$e,Qk:e.Qk},m.m(2)}})};function Am(a){K.log("Teacher "+a.R+" changes from "+a.mode+" mode to view mode");a.mode="view"}
function Bm(a,b){K.log("Teacher "+a.R+" authorized with "+b+" mode");a.mode=b;a.i.H.sendMessage({type:"classConnected",data:{R:a.R,lb:a.lb,className:a.className,mode:a.mode}});try{if("control"==a.mode){a.debug&&K.log("[Teacher] TeacherConnection.previousClassName=",xm,", this.className=",a.className);var c=xm!=a.className;xm=a.className;c&&"true"==ee(a.i.runtime,"clm.restoreTabs")&&(K.log("[Teacher] Saving tabs."),Cm(a.i.ja.Ad()))}}catch(d){K.error("[Teacher] Save tabs error.",d)}vm(a);a.o=new Dm(a.i,
a,{debug:a.debug});setTimeout(function(){a.o.start()},100);setTimeout(function(){a.o.start()},3E3);a.notifications=new Em(a.i,{debug:a.debug,R:a.R});a.fc=a.i.ja.fc;Fm(a.fc);a.send({type:"status",data:{fc:a.fc.locked}});Gm()}
function vm(a){12==Q.platform&&chrome.tabs.query({},function(b){a.debug&&K.log("notify frontend of teacher connect activities: "+Oi.length);b=t(b);for(var c=b.next();!c.done;c=b.next())chrome.tabs.sendMessage(c.value.id,{recipient:"classroom",type:"teacherConnectionChange",data:{Ip:Oi.length}})})}k.Hg=function(){return this.className};
k.Ob=function(a,b,c){var d=this;c=void 0===c?!1:c;try{var e={};b&&(e=this.jk()[0]);e.event=a||"unknown";e.Z=this.i.runtime.va();e.R=this.R;e.className=this.className;this.Jl&&(e.Po=Math.floor((Date.now()-this.Jl)/1E3),qm(e.Po));e.hk=this.hk;this.i.I.Sa("misc",{timestamp:Date.now(),type:"rtcStats",Zm:e,Ck:this.id})}catch(f){K.warn("Upload error while tear down.",f)}this.Xa&&this.Xa.stop(this.id);this.o&&this.o.stop();Hm(this.i.ja.me,0);if(this.fc&&"none"!=this.mode){a=t(Oi);for(b=a.next();!b.done&&
(b=b.value,b==this||"none"==b.mode);b=a.next());K.log("Stopping lockdown on connection close ...");Im(this.fc,{force:!0});a=t(Oi);for(b=a.next();!b.done;b=a.next())b=b.value,b!=this&&b.send({type:"status",data:{fc:!1}})}this.i.H.sendMessage({type:"classDisconnected",data:{R:this.R,lb:this.lb,className:this.className,mode:this.mode}});try{c&&"control"==this.mode&&(xm=ym=void 0,"true"==ee(this.i.runtime,"clm.restoreTabs")&&(K.log("[Teacher] Restoring tabs."),setTimeout(function(){Jm(d.i.ja.Ad())},3E3)))}catch(f){K.error("[Teacher] Restore tabs error.",
f)}c=Oi;a=c.indexOf(this);-1!=a&&c.splice(a,1);Gm();vm(this)};function Gm(){for(var a=[],b=t(Oi),c=b.next();!c.done;c=b.next())c=c.value,"control"!=c.mode&&"view"!=c.mode||a.push({mode:c.mode,R:c.R,lb:c.lb,className:c.className});b=t(Oi);for(c=b.next();!c.done;c=b.next())c=c.value,"control"!=c.mode&&"view"!=c.mode||c.send({type:"status",data:{Mr:a}})}
function em(a){a=void 0===a?!1:a;if(Oi){for(var b=t(Oi),c=b.next();!c.done;c=b.next())if(c=c.value,"control"==c.mode)return c;if(a)for(a=t(Oi),c=a.next();!c.done;c=a.next())if(b=c.value,"view"==b.mode)return b}}
k.onCommand=function(a){var b=this,c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R;return J(function(N){switch(N.h){case 1:b.debug&&K.log("("+b.R+") Teacher command: "+JSON.stringify(a));C(N,2);if("none"!=b.mode&&("view"!=b.mode||"controlRequest"!=a.type)){a:switch(b.mode){case "admin":case "control":var Y=!0;break a;case "view":Y="ping screenshare closeTab message lockdown pushUrl pong controlRequest closeConnection getActivePage annotateScreen".split(" ").includes(a.type);break a;default:Y=!1}if(Y)if("ping"==
a.type)b.send({type:"pong",data:{id:a.data.id}},!0);else if("screenshare"==a.type)a.data.enable?(b.J()?(b.send({type:"screenMode",data:{mode:"screenshot"}},!0),b.Xa.start(b.id,!0,function(W){b.send({type:"screenshot",data:{image:W}})})):b.Xa.start(b.id,!1),setTimeout(function(){var W=b.Xa.hp();"string"==typeof W&&b.send({type:"error",data:{Nm:a.type,message:W}},!0)},3E3)):b.Xa.stop(b.id);else if("closeTab"==a.type)a.data.tabId&&(b.i.ja.Ad().remove(a.data.tabId),12==Q.platform&&(c={R:"",lb:""},b.notifications.create("Oops",
"A tab was closed by your teacher.",c)));else if("message"==a.type)d={R:b.R,lb:b.lb},Km(b.notifications,a.data.text,d);else if("lockdown"==a.type){if(b.fc)for(a.data.enable?b.fc.start(a.data):b.fc.stop(),e=t(Oi),f=e.next();!f.done;f=e.next())g=f.value,g.send({type:"status",data:{fc:a.data.enable}})}else if("pushUrl"==a.type)Lm(b.i.ja,a.data.url);else if("getActivePage"==a.type)h=a.data.zk,Mm(b,h);else if("annotateScreen"==a.type)Nm(b,a.data);else if("requestUnblockResponse"==a.type)Om(b,a);else if("changeSession"==
a.type)l=a.data,l.Y?(b.Y=l.Y,b.i.H.sendMessage({type:"changeClassroomSession",data:{name:l.name,Y:l.Y,eh:b.lb,cf:l.cf,wc:l.wc,Wb:l.Wb,bb:b.bb}}),b.debug&&K.log("[Teacher] TeacherConnection.previousSessionName=",ym,", this.sessionName=",b.Y),m=ym!=b.Y,ym=b.Y,"number"===typeof l.kd&&("control"!=b.mode?K.error("[Teacher] changeSession received from a non-controlling teacher."):(n=m&&"true"==ee(b.i.runtime,"clm.restoreTabs"),Hm(b.i.ja.me,l.kd,n)))):K.error("[Teacher] Missing session name in change session command.",
l);else if("controlResponse"==a.type)if("control"!=b.mode)K.error("webrtc: controlResponse received by a non-controlling teacher");else if(q=a.data,q.requestId==b.id)K.warn("webrtc: requested to transfer control from myself to myself");else{r=t(Oi);for(f=r.next();!f.done;f=r.next())if(p=f.value,p.id==q.requestId){u=p;break}u?Pm(u,q):K.warn("webrtc: connection with control requester "+q.R+" has broken");"control"==q.Bd&&b.Ob("yield control",!1)}else"closeConnection"==a.type?(K.warn("webrtc: received close connection command.",
a.data.reason),b.Ob("Close connection. "+a.data.reason,!1,"On destroy."==a.data.reason)):"Notification"===a.type&&b.i.ja.Ad().Mb(null,{recipient:"modal",type:"showNotification",data:a.data});else b.send({type:"error",data:{Nm:a.type,message:"access denied"}},!0),K.warn("webrtc: op "+a.type+" access denied");N.m(4);break}if("connRequest"==a.type){b.l=a.version;w=a.data;z=w.mode;b.lb=w.lb;b.className=w.className;b.bb=w.bb;rm(b.bb);switch(w.mode){case "control":case "view":(B=b.i.policy.so())?v={reason:B}:
(D=em())&&D.R!=b.R&&(72E5<Date.now()-D.Pr?(K.warn("Previous controller "+D.R+" had the session for too long, auto yielding to "+b.R),D.Ob("pre-emptive takeover",!1)):"1.0"!=b.l?z="view":v={reason:"conflict",details:{R:D.R,lb:D.lb,className:D.className}});break;case "admin":break;default:v={reason:"unknown mode: "+w.mode}}E={type:"connResponse",version:b.l,data:{error:v}};v||"1.0"==b.l||(E.data.Bd=z);b.send(E,!0);v||Bm(b,z);N.m(4);break}if("controlRequest"!=a.type){"reloadPolicy"==a.type?Sb(b.i.policy):
"pong"!=a.type&&b.send({type:"error",data:{Nm:a.type,message:"access denied, must request control first"}},!0);N.m(4);break}G=em();M=a.data;b.lb=M.lb;b.className=M.className;b.bb=M.bb;rm(b.bb);if(!G){b.send({type:"controlResponse",data:{requestId:M.requestId,Bd:M.mode}},!0);Bm(b,M.mode);N.m(4);break}if("1.0"!=b.l){"view"!=M.mode&&(G.send({type:"changeMode",data:{mode:"view"}}),Am(G));b.send({type:"controlResponse",data:{requestId:b.id,Bd:M.mode}},!0);Bm(b,M.mode);N.m(4);break}T=Object.assign({},M);
T.R=b.R;T.requestId=b.id;Qm(G,T);C(N,9);O=new Promise(function(W,X){setTimeout(X,6E4)});return y(N,Promise.race([b.S.wait(),O]),11);case 11:F(N,4,2);break;case 9:H(N,2),K.warn("Failed to receive "+M.mode+" request response from "+G.R+", auto grant to requester "+b.R),"view"!=M.mode&&G.Ob("grant request timeout",!1),b.send({type:"controlResponse",data:{requestId:b.id,Bd:M.mode}},!0),Bm(b,M.mode);case 4:Rm(b,a,!0);F(N,0);break;case 2:R=H(N),K.error("Error processing teacher command: "+R+", "+JSON.stringify(a)),
A(N)}})};function Nm(a,b){K.log("[CLM] Annotate screen. data=",b);12==Q.platform&&chrome.tabs.query({active:!0,currentWindow:!0},function(c){if(c&&(c=c[0])){var d={recipient:"classroom",type:"annotateScreen",data:b};d.data.eh=a.lb;chrome.tabs.sendMessage(c.id,d,{frameId:0},function(){})}})}function Mm(a,b){12==Q.platform?Sm(a,b):99==Q.platform&&(a.zk=b,a.i.ja.Ad().Mb(null,{type:"getActivePage"}))}
function Sm(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(c){c&&(c=c[0])&&chrome.tabs.sendMessage(c.id,{recipient:"DynTA",type:"getActivePage",data:{}},{frameId:0},function(d){d&&zm(a,d,b)})})}function zm(a,b,c){a.send({type:"activePageContent",data:{zk:c,url:b.url,title:b.title,content:b.content}})}
function Om(a,b){var c=b.data.Bm,d=a.j[c];d&&(b={recipient:"UnblockRequestClass",type:"unblockUrlClassResponse",nn:!0,data:b.data},12==Q.platform?chrome.tabs.sendMessage(d,b):99==Q.platform&&a.i.ja.Ad().Mb(d,b),delete a.j[c])}function fm(a,b,c){a.j||(a.j={});a.j[c.data.Bm]=b;a.send({type:"requestUnblock",data:c.data})}k.sendMessage=function(a){this.send({type:"message",data:{text:a}})};
k.send=function(a,b){b=void 0===b?!1:b;this.A&&K.log("("+this.R+") Teacher connection send",a,b);this.h&&("none"!=this.mode||b?(this.h.send(a),Rm(this,a,!1)):K.error("Trying to send msg to teacher before auth: "+a.type))};
function Rm(a,b,c){try{if(a.ga){if(!a.aa||6E4<Date.now()-a.aa){a.aa=Date.now();var d=a.Xa.getStats(),e={type:"stats",N:{Qu:d.Gk,Ru:d.Ai}};a.debug&&K.log("[Teacher] recordStats. msg=",e);Tm(a,e,void 0)}if(!["ping","pong","screenshot","status","tabs"].includes(b.type)){if("changeSession"==b.type){if(b.data.Y==a.D)return;a.D=b.data.Y}Tm(a,b,c)}}}catch(f){K.error("[Teacher] record error.",f)}}
function Tm(a,b,c){b=Xa(om,b);a.trace&&K.log("Record rtc msg=",b,"isInbound=",c);c={timestamp:Date.now(),type:"rtcMsg",message:b,xt:c,Ck:a.id,R:a.R,className:a.className,mode:a.mode,Z:a.i.runtime.va()};a.i.I.Sa("misc",c)}function Qm(a,b){"control"!=a.mode?K.error("webrtc: cannot send request control message to a non-controlling teacher"):a.send({type:"controlRequest",data:b},!0)}
function Pm(a,b){b.requestId!=a.id?K.error("onRequestControlResponse: mismatching requeset ID: "+a.R+" != "+b.R):(a.S.signal(),a.send({type:"controlResponse",data:b},!0),"control"!=b.Bd&&"view"!=b.Bd||Bm(a,b.Bd),b.Bd&&"none"!=b.Bd||a.Ob("grant request denied",!1))}function Dm(a,b,c){this.i=a;this.sender=b;this.options=c;this.debug=c.debug}Dm.prototype.start=function(){this.i.ja.me.subscribe(this)};Dm.prototype.stop=function(){this.i.ja.me.unsubscribe(this)};
Dm.prototype.Yp=function(a){this.sender.send({type:"tabs",data:a})};function Em(a,b){this.i=a;this.options=b;this.debug=b.debug}function Km(a,b,c){c=void 0===c?{}:c;a.create((a.options.R||"teacher")+" says:",b,Object.assign({requireInteraction:!0},c))}Em.prototype.create=function(a,b,c){var d=this.i.ja;d.oj?(cm(),dm(d.oj,c.R,b),d.um()):d.Sf(a,b,c)};
function Ul(a,b,c){sm.call(this,a,c);var d=this;this.Ca=b;this.Xa&&this.Xa.fm().then(function(f){f.forEach(function(g){K.log("Adding display track");"contentHint"in g&&(g.contentHint="text");d.Ca.addTrack(g)})});this.Ca.addEventListener("datachannel",function(f){f=f.channel;f.addEventListener("open",function(){d.Xa&&d.Xa.fn()});K.log("RTC teacher data channel: "+d.R+": "+f.label);d.h=new Vl(new Gl(f));d.h.on("message",function(g){d.A&&K.log("RTC teacher connection dataChan received message.",g);d.onCommand(g)});
d.h.on("error",function(g){K.warn("RTC teacher data channel error: "+g.error);d.Ob("rtc data channel error: "+g.error,!0)})});this.Ca.addEventListener("connectionstatechange",function(){var f,g,h,l;return J(function(m){if(1==m.h){K.log("Teacher connection: "+d.R+": "+d.Ca.connectionState);switch(d.Ca.connectionState){case "disconnected":case "failed":case "closed":d.Ob(d.Ca.connectionState,!1);break;case "connected":return m.m(2)}return m.m(0)}if(4!=m.h)return d.Jl=Date.now(),f=d.jk(),g=f[0],h=f[1],
g.Z=d.i.runtime.va(),g.R=d.R,g.className=d.className,g.event="connected",y(m,Um(d,g,h),4);l={timestamp:Date.now(),type:"rtcStats",Zm:g,Ck:d.id};d.i.I.Sa("misc",l);d.ik();return m.m(0)})});try{if(chrome.privacy){var e=chrome.privacy.network;e.webRTCIPHandlingPolicy&&e.webRTCIPHandlingPolicy.get({},function(f){d.Ym=f.value})}}catch(f){K.error("Get IPHandlingPolicy error.",f)}}x(Ul,sm);
Ul.prototype.jk=function(){var a={},b=0;try{this.options.rk.Ij&&(a.error=this.options.rk.Ij);a.Ym=this.Ym;a.bq=this.J()?"screenshot":"video";a.Co="rtc";navigator&&navigator.userAgent&&(a.userAgent=navigator.userAgent);a.local={to:this.options.rk.Zj};a.remote={to:this.options.rk.nk};var c=this.Ca;if(c.sctp){var d=c.sctp.transport.iceTransport.getSelectedCandidatePair();if(d){var e=d.local;a.local.address=e.address;a.local.type=e.type;b=e.port;K.log("Teacher local: "+e.address+":"+e.port+", "+e.type);
e=d.remote;a.remote.address=e.address;a.remote.type=e.type;K.log("Teacher remote: "+e.address+":"+e.port+", "+e.type);"host"==a.local.type?a.uj=a.remote.type:"host"==a.remote.type?a.uj=a.local.type:a.uj="relay"==a.local.type||"relay"==a.remote.type?"relay":a.local.type+"-"+a.remote.type;K.log("Teacher connection type:",a.uj)}}}catch(f){K.warn("prepareStats() fail.",f)}return[a,b]};
function Um(a,b,c){var d,e;return J(function(f){switch(f.h){case 1:C(f,2);if(!b.local||"relay"!=b.local.type){f.m(4);break}return y(f,a.Ca.getStats(null),5);case 5:(d=f.j)&&d.forEach(function(g){g.relayProtocol&&g.port==c&&(K.log("Local relay protocol:",g.relayProtocol),b.local.zu=g.relayProtocol)});case 4:F(f,0);break;case 2:e=H(f),K.warn("Prepare relay protocol fail.",e),A(f)}})}
Ul.prototype.Ob=function(a,b,c){c=void 0===c?!1:c;this.v||(this.v=!0,this.debug&&K.log("["+this.id+"]("+this.R+") RTC teacher connection tear down. Reason =",a),sm.prototype.Ob.call(this,a,b,c),this.h&&(this.h.close(),this.h=null),this.Ca.close())};Ul.prototype.J=function(){if(de(this.i.runtime)){var a=/Chrome\/([0-9]+)/.exec(navigator.userAgent);if(a)return a=Number(a[1]),this.debug&&K.log("Screen mode by Chrome version:",a),97<=a}this.debug&&K.log("Screen mode is video.");return!1};
function Ql(a,b,c){sm.call(this,a,c);var d=this;this.h=b;this.h.on("message",function(e){d.A&&K.log("WS teacher connection dataChan received message.",e);d.onCommand(e)});this.h.on("error",function(e){K.warn("WS teacher data channel error: "+e.error);d.Ob("ws data channel error: "+e.error,!0)});this.h.on("close",function(){K.warn("WS teacher data channel close.");d.Ob("ws data channel close",!0)});this.Jl=Date.now();a=this.jk()[0];a.Z=this.i.runtime.va();a.R=this.R;a.className=this.className;a.event=
"connected";this.i.I.Sa("misc",{timestamp:Date.now(),type:"rtcStats",Zm:a,Ck:this.id});this.send({type:"wsTeacherConnectAck",data:{}},!0);this.ik()}x(Ql,sm);Ql.prototype.jk=function(){var a={};try{a.bq="screenshot",a.Co="wsrelay",navigator&&navigator.userAgent&&(a.userAgent=navigator.userAgent)}catch(b){K.warn("prepareStats() fail.",b)}return[a,0]};
Ql.prototype.Ob=function(a,b,c){c=void 0===c?!1:c;this.v||(this.v=!0,this.debug&&K.log("["+this.id+"]("+this.R+") WS teacher connection tear down. Reason =",a),sm.prototype.Ob.call(this,a,b,c),this.h&&(this.h.close(),this.h=null))};Ql.prototype.J=function(){return!0};function Vm(a){var b=this;this.i=a;this.debug="true"==a.s["debug.chat.debug"];this.pj={};this.i.setInterval(function(){for(var c=Math.round(Date.now()/1E3)-3E3,d=t(Object.entries(b.pj)),e=d.next();!e.done;e=d.next())if(e=t(e.value),e.next(),(e=e.next().value)&&0<e.length)for(var f=0;f<e.length;f++)e[f].time<c&&(e.splice(f,1),f--)},6E4)}function dm(a,b,c,d){var e=a.pj.all;e||(e=[]);e.push({tid:b,msg:c,time:Date.now()/1E3,"in":void 0===d?!0:d});a.pj.all=e};function Wm(a){this.i=a;this.debug="true"==a.s["debug.dev.debug"];this.h={};this.Kl()}k=Wm.prototype;k.addEventListener=function(a,b){this.h[a]||(this.h[a]=[]);a=this.h[a];-1==a.indexOf(b)&&a.push(b)};k.removeEventListener=function(a,b){this.h[a]&&(a=this.h[a],b=a.indexOf(b),-1!=b&&a.splice(b,1))};
k.ha=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];if(this.h[a]){d=t(this.h[a]);for(var e=d.next();!e.done;e=d.next()){e=e.value;try{e.apply(null,ca(c))}catch(f){K.error("Exception dispatching event "+a+": "+f)}}}};k.Kl=function(){};k.Ad=function(){return this.ia};function Lm(a,b){Xm(a.me);a.ia.create({url:b,active:!0})}k.um=function(){};k.Sf=function(){};function Ym(a){this.options=a;this.debug=a.debug;this.o=void 0;this.j=0;this.h=void 0}k=Ym.prototype;
k.lm=function(){throw Error("initialize() not implemented on abstract class.");};k.getStats=function(){return{Gk:0,Ai:0}};k.fm=function(){return J(function(){throw Error("getMediaTracks() not implemented on abstract class.");})};k.fn=function(){throw Error("setBufferProvider() not implemented on abstract class.");};k.hp=function(){};k.start=function(){return J(function(){throw Error("start() not implemented on abstract class.");})};
k.stop=function(){throw Error("stop() not implemented on abstract class.");};k.nj=function(){return J(function(){throw Error("captureScreen() not implemented on abstract class.");})};
function Zm(a){var b;return J(function(c){if(1==c.h){if(a.h)return a.debug&&K.log("[Dev] tryCapture. Returning active promise."),c.return(a.h);a.h=a.nj();a.h.catch(function(){}).then(function(){a.h=void 0});return y(c,a.h,2)}(b=c.j)?(a.j=Date.now(),a.o=b,a.debug&&K.log("[Dev] tryCapture save SS. sc.length=",b.length,", time=",a.j)):a.debug&&K.log("[Dev] Capture failed.");return c.return(b)})}
function Ng(a){return J(function(b){return 1==b.h?1E3<=Date.now()-a.j?y(b,Zm(a),2):(a.debug&&K.log("[Dev] Skip capture."),b.m(2)):5E3>=Date.now()-a.j?b.return(a.o):b.return(void 0)})}function $m(a,b,c){this.i=a;this.ia=b;this.options=c;this.debug=c.debug;this.de=Q.Fa+Q.Et;this.locked=!1;this.v={}}
$m.prototype.start=function(a){a=void 0===a?{}:a;var b=this;return J(function(c){b.locked||(b.locked=!0,b.D=Wc(function(){b.j()},1E3),b.i.ja.Sf("Uh-oh","The teacher has locked your computer!",{requireInteraction:!1}),Xm(b.i.ja.me),b.ia.create({url:b.de,active:!0}));a.expiration&&(b.expires=Date.now()+1E3*a.expiration,setTimeout(function(){b.stop()},1E3*a.expiration));A(c)})};
function Im(a,b){b=void 0===b?{}:b;var c;J(function(d){if(1==d.h)return a.debug&&K.log("[LockDown] delayStop called. options=",b,", this.delayStopTimerId=",a.h),a.locked?y(d,le(),2):d.return();c=d.j;if("undefined"!=typeof a.h)return d.return();c?(a.debug&&K.log("[LockDown] Internet is ok. Stop."),delete a.h,a.stop(b)):(a.debug&&K.log("[LockDown] Internet is not ok. Retry later."),a.h=setTimeout(function(){delete a.h;Im(a,b)},5E3));A(d)})}
function Fm(a){a.debug&&K.log("[LockDown] resetDelayStop called. this.delayStopTimerId=",a.h);"undefined"!=typeof a.h&&(clearTimeout(a.h),delete a.h)}$m.prototype.stop=function(a){a=void 0===a?{}:a;var b=this;return J(function(c){b.debug&&K.log("[LockDown] stop called.");if(!b.locked||!a.force&&Date.now()<b.expires)return c.return();b.debug&&K.log("[LockDown] locked=false.");b.locked=!1;Xc(b.D);b.i.ja.Sf("Ding ding ding!","Your computer has been unlocked.");b.o();A(c)})};
$m.prototype.j=function(){var a=this,b,c,d,e,f,g,h;J(function(l){if(1==l.h)return a.locked?y(l,a.ia.cc(),3):l.m(0);b=l.j;if(!b)return l.return();a.debug&&K.log("[LockDown] check. tabs=",b);c={};d=t(b);for(e=d.next();!e.done;e=d.next()){f=e.value;if(!f.url)return l.return();f.url==a.de&&(c[f.windowId]=f.id)}g={};h=t(b);for(e=h.next();!e.done;g={mc:g.mc},e=h.next())g.mc=e.value,!g.mc.active||an(a,g.mc.url)||a.v[g.mc.windowId]||(a.debug&&K.log("[LockDown] Tab escaped.",g.mc),c[g.mc.windowId]?(a.debug&&
K.log("[LockDown] Make lock tab active.",c[g.mc.windowId]),a.ia.update(c[g.mc.windowId],{active:!0})):(a.debug&&K.log("[LockDown] Creating new lock tab."),Xm(a.i.ja.me),a.ia.create({url:a.de,active:!0,windowId:g.mc.windowId},function(m){return function(n){a.debug&&K.log("[LockDown] New lock tab created.",n);n.windowId!=m.mc.windowId&&(a.debug&&K.log("[LockDown] Adding skip window.",m.mc.windowId),a.v[m.mc.windowId]=!0)}}(g))));A(l)})};
$m.prototype.o=function(){var a=this,b,c,d,e;J(function(f){if(1==f.h)return y(f,a.ia.cc(),2);b=f.j;c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,e.url==a.de&&a.ia.remove(e.id);A(f)})};function an(a,b){a.debug&&K.log("[LockDown] isSkipUrl.",b);try{var c=new URL(b);if(c.hostname.endsWith("."+Q.Eb)||"https:"!=c.protocol&&"http:"!=c.protocol)return!0}catch(d){K.error("[LockDown] isSkipUrl error.",d)}return!1}
function bn(a,b){var c=this;this.i=a;this.ia=b;this.l=[];this.debug=!1;this.j=[];this.h={};this.ia.cc().then(function(d){d=t(d);for(var e=d.next();!e.done;e=d.next())e=e.value,e.active?c.j.unshift(e.id):c.j.push(e.id),c.h[e.id]={tabId:e.id,ap:e.favIconUrl,title:e.title,url:e.url};cn(c,"init")});this.ia.addEventListener("activated",function(d){c.onActivated(d)});this.ia.addEventListener("removed",function(d,e){c.onRemoved(d,e)});this.ia.addEventListener("replaced",function(d,e){c.onReplaced(d,e)});
this.ia.addEventListener("updated",function(d,e,f){c.onUpdated(d,e,f)});this.ia.addEventListener("created",function(d){c.onCreated(d)});this.i.addListener(function(d,e){"classMgmt"==d.recipient&&"avStatusChange"==d.type&&(e&&e.tab&&e.tab.id?(e=e.tab.id,d=d.data,c.h[e]||(c.h[e]={tabId:e}),Object.assign(c.h[e],{url:d.url,Uc:d.Uc,md:d.md}),d.title&&Object.assign(c.h[e],{title:d.title})):K.error("avStatusChanger: no sender info received"),cn(c,"avStatusChange"))});this.i.setInterval(function(){cn(c,"periodic")},
6E4)}k=bn.prototype;k.onActivated=function(a){var b=this.j.indexOf(a.tabId);-1!=b&&this.j.splice(b,1);this.j.unshift(a.tabId);cn(this,"activated")};k.onRemoved=function(a){var b=this.j.indexOf(a);-1!=b&&this.j.splice(b,1);delete this.h[a];cn(this,"removed")};k.onReplaced=function(a,b){var c=this.j.indexOf(b);-1!=c?this.j.splice(c,1,a):this.j.push(a);this.h[a]=this.h[b];delete this.h[b];cn(this,"replaced")};
k.onUpdated=function(a,b,c){var d=this;if(b.title||b.url||b.favIconUrl)b={tabId:a,ap:c.favIconUrl,title:c.title,url:c.url},this.h[a]&&this.h[a].url==c.url?Object.assign(this.h[a],b):this.h[a]=b,c.active&&(b=this.j.indexOf(a),-1!=b&&this.j.splice(b,1),this.j.unshift(a)),cn(this,"updated");c.url&&c.url.startsWith("file://")&&"true"==ee(this.i.runtime,"dev.blockFileTab")&&setTimeout(function(){try{var e=d.i.policy.uf(c.url,"Local file",jf(d.i.Aa,Q.Vb),[Q.Vb],!1,"school");d.ia.update(a,{url:e})}catch(f){K.log("[Tab] Block file tab error.",
f)}},100)};
k.onCreated=function(a){var b=this,c;return J(function(d){if(1==d.h)return b.debug&&K.warn(" =====> created: ("+a.ly+"):",a),!b.kd||b.o?d.m(0):y(d,b.ia.cc(),3);c=d.j;if(!c)return d.return();b.debug&&K.log("onCreated. tabs=",c);c.length>b.kd&&(K.log("# of tabs ("+c.length+") exceeds limit ("+b.kd+"). Remove newly created tab ("+a.id+")."),b.ia.remove(a.id),b.i.ja.Sf("Uh-oh","Your teacher has set an open tab limit of "+b.kd+". Please close some tabs before opening a new tab.",{requireInteraction:!1}));A(d)})};
function dn(a){var b,c,d,e;J(function(f){if(1==f.h)return a.debug&&K.log("[Tab] closeExtraTabs."),!a.kd||a.o?f.m(0):y(f,a.ia.cc(),3);b=f.j;if(!b)return f.return();c=b.length-a.kd;if(0>=c)return f.return();K.log("[Tab] # of tabs ("+b.length+") exceeds limit ("+a.kd+"). Removing "+c+" tabs.");for(d=a.j.length-1;0<c&&0<=d;)e=a.j[d],a.debug&&K.log("[Tab] Closing extra tab.",a.h[e]),a.ia.remove(e),c--,d--;a.i.ja.Sf("Uh-oh","Your teacher has set an open tab limit of "+a.kd+". Some tabs are closed.",{requireInteraction:!1});
A(f)})}k.subscribe=function(a){-1==this.l.indexOf(a)&&this.l.push(a);cn(this,"subscribe")};k.unsubscribe=function(a){a=this.l.indexOf(a);-1!=a&&this.l.splice(a,1)};function cn(a,b){var c=a.j.map(function(d){return a.h[d]||{}});a.ha({info:c,au:0});a.debug&&(c=a.j.map(function(d){return a.h[d]&&a.h[d].url||""}),K.log("[Tab] Report tabs due to "+b+".",c))}k.init=function(){return J(function(){throw Error("init() not implemented in abstract class");})};
k.ha=function(a){for(var b=t(this.l),c=b.next();!c.done;c=b.next())c.value.Yp(a)};function Hm(a,b,c){a.debug&&K.log("[Tab] Set tab number limit to",b,". close_extra_tabs=",c);a.kd=b;c&&dn(a)}function Xm(a){a.o=!0;setTimeout(function(){a.o=!1},1E3)}function en(){this.l="activated removed replaced updated created proxyFrontendMessage".split(" ");this.j={};for(var a=t(this.l),b=a.next();!b.done;b=a.next())this.j[b.value]=[]}k=en.prototype;
k.addEventListener=function(a,b){if(!this.l.includes(a))throw Error("Unknown event: "+a);a=this.j[a];a.includes(b)||a.push(b)};k.removeEventListener=function(a,b){if(!this.l.includes(a))throw Error("Unknown event: "+a);a=this.j[a];b=a.indexOf(b);-1!=b&&a.splice(b,1)};
k.ha=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];if(!this.l.includes(a))throw Error("Unknown event: "+a);d=t(this.j[a]);for(var e=d.next();!e.done;e=d.next()){e=e.value;try{e.apply(null,ca(c))}catch(f){K.error("Error in TabManager listener: "+f)}}};k.cc=function(){return J(function(){throw Error("getAllTabs() not implemented on abstract class");})};k.Vh=function(){return J(function(){throw Error("getActiveTab() not implemented on abstract class");})};
k.remove=function(){throw Error("remove() not implemented on abstract class");};k.update=function(){throw Error("update() not implemented on abstract class");};k.create=function(){throw Error("create() not implemented on abstract class");};function Cm(a){var b,c,d,e;J(function(f){if(1==f.h)return y(f,a.cc(),2);if(b=f.j){a.h=[];c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,e.url&&-1==a.h.indexOf(e.url)&&a.h.push(e.url);K.log("[Tab] Save tab list.",a.h)}A(f)})}
function Jm(a){var b,c,d,e,f,g,h,l;J(function(m){if(1==m.h)return a.h?y(m,a.cc(),3):m.m(0);if(b=m.j){c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,e.url&&(f=a.h.indexOf(e.url),-1!=f&&(a.h[f]=""));K.log("[Tab] Restore tab list.",a.h);g=t(a.h);for(h=g.next();!h.done;h=g.next())(l=h.value)&&a.create({url:l});a.h=[]}A(m)})}k.Mb=function(){throw Error("sendToTab() not implemented on abstract class");};
function cl(a){Wm.call(this,a);var b=this;this.oj=new Vm(this.i);this.j=-1;chrome.idle.onStateChanged.addListener(function(c){"active"==c&&b.ha("idleState","active")});this.i.setInterval(function(){chrome.idle.queryState(300,function(c){"idle"==c?b.ha("idleState","idle"):"active"==c&&b.ha("idleState","active")})},6E4)}x(cl,Wm);cl.prototype.Kl=function(){this.ia=new fn;this.fc=new $m(this.i,this.ia,{debug:this.debug});this.me=new bn(this.i,this.ia);this.Xa=new gn(this.i,{debug:this.debug})};
cl.prototype.um=function(){var a=this;Xm(this.me);chrome.windows.update(this.j,{focused:!0},function(){chrome.runtime.lastError?chrome.windows.create({url:Q.wo(),type:"popup",focused:!0,width:332,height:504},function(b){a.j=b.id}):chrome.tabs.query({currentWindow:!0,active:!0},function(b){b&&chrome.tabs.reload(b[0].id)})})};
cl.prototype.Sf=function(a,b,c){c=void 0===c?{}:c;var d={iconUrl:"icons/128.png",type:"basic"};Object.assign(d,c);chrome.notifications.create(null,{type:d.type,message:b,title:a,iconUrl:d.iconUrl,requireInteraction:d.requireInteraction})};function fn(){en.apply(this,arguments)}x(fn,en);k=fn.prototype;
k.addEventListener=function(a,b){switch(a){case "activated":chrome.tabs.onActivated.addListener(b);break;case "created":chrome.tabs.onCreated.addListener(b);break;case "replaced":chrome.tabs.onReplaced.addListener(b);break;case "removed":chrome.tabs.onRemoved.addListener(b);break;case "updated":chrome.tabs.onUpdated.addListener(b);break;default:throw Error("Unknown event: "+a);}};
k.removeEventListener=function(a,b){switch(a){case "activated":chrome.tabs.onActivated.removeListener(b);break;case "created":chrome.tabs.onCreated.removeListener(b);break;case "replaced":chrome.tabs.onReplaced.removeListener(b);break;case "removed":chrome.tabs.onRemoved.removeListener(b);break;case "updated":chrome.tabs.onUpdated.removeListener(b);break;default:throw Error("Unknown event: "+a);}};
k.cc=function(){return J(function(a){return 1==a.h?y(a,new Promise(function(b){chrome.tabs.query({},function(c){b(c)})}),2):a.return(a.j)})};k.Vh=function(){return J(function(a){return a.return(new Promise(function(b){chrome.tabs.query({active:!0},function(c){b(c[0])})}))})};
k.remove=function(a){"string"==typeof a&&(a=parseInt(a));chrome.tabs.remove(a);setTimeout(function(){try{chrome.tabs.get(a,function(b){b&&(chrome.tabs.executeScript(a,{code:'document.open();document.write("<h1>This webpage has been closed by your teacher</h1>");document.close();'}),setTimeout(function(){return chrome.tabs.remove(a)},1E3))})}catch(b){K.error("[RTab] failed to follow the tab after remove, error: ",b)}},1E3)};
k.update=function(a,b){"string"==typeof a&&(a=parseInt(a));chrome.tabs.update(a,b)};k.create=function(a,b){chrome.tabs.create(a,b)};k.Mb=function(a,b){a?chrome.tabs.sendMessage(a,b):chrome.tabs.query({active:!0},function(c){c&&c[0]&&(a=c[0].id,chrome.tabs.sendMessage(a,b))})};function gn(a,b){Ym.call(this,b);this.i=a;this.width=1024;this.height=768;this.Ne={};this.N={Gk:0,Ai:0}}x(gn,Ym);k=gn.prototype;
k.lm=function(){if(!this.v){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;this.canvas=a;this.v=a.captureStream()}};k.fm=function(){var a=this;return J(function(b){return b.return(a.v.getTracks())})};k.fn=function(){};k.start=function(a,b,c){var d=this,e;return J(function(f){e=0==Object.keys(d.Ne).length;c||(c=function(){});d.Ne[a]=c;e&&1==Object.keys(d.Ne).length&&hn(d,b);A(f)})};
function hn(a,b){var c;J(function(d){if(1==d.h){if(a.D)return K.warn("[SS] Loop already started. Skip."),d.return();C(d,2,3);a.D=!0;a.debug&&K.log("[SS] Starting screen share... screenshot_mode=",b);return"undefined"!=typeof document?y(d,jn(a,b),3):y(d,kn(a),3)}if(2!=d.h)return va(d),a.D=!1,a.debug&&K.log("[SS] Stopping screen share ..."),wa(d,0);c=H(d);K.error("Canvas video stream: ",c);return d.m(3)})}
function jn(a,b){var c,d,e;return J(function(f){switch(f.h){case 1:c=document.createElement("img"),c.width=a.width,c.height=a.height,d=a.canvas.getContext("2d");case 2:if(!(0<Object.keys(a.Ne).length)){f.m(0);break}return y(f,new Promise(function(g){setTimeout(g,1E3)}),4);case 4:return y(f,Ng(a),5);case 5:if(e=f.j)c.onload=function(){if(b){var g=c;var h=document.createElement("canvas");h.width=a.width;h.height=a.height;h.getContext("2d").drawImage(g,0,0,a.width,a.height);g=h.toDataURL("image/jpeg",
.5);ln(a,g);a.debug&&K.log("[SS] Sending dataUrlFit with length",g.length)}else a.debug&&K.log("[SS] Drawing image."),d.drawImage(c,0,0,a.width,a.height)},c.src=e;f.m(2)}})}function kn(a){var b;return J(function(c){if(1==c.h)return 0<Object.keys(a.Ne).length?y(c,new Promise(function(d){setTimeout(d,1E3)}),4):c.m(0);if(5!=c.h)return y(c,Ng(a),5);b=c.j;ln(a,b);return c.m(1)})}
function ln(a,b){try{b&&(Object.values(a.Ne).forEach(function(c){c(b)}),a.N.Gk++,a.N.Ai+=b.length,a.debug&&K.log("[SS] sendCapture. this.stats=",a.N))}catch(c){K.error("[SS] Send capture error.",c)}}k.getStats=function(){var a=Object.assign({},this.N);this.N.Gk=0;this.N.Ai=0;return a};k.stop=function(a){delete this.Ne[a]};
k.nj=function(){var a=this,b;return J(function(c){b="undefined"!=typeof document?50:5;return c.return(new Promise(function(d){chrome.tabs.captureVisibleTab({quality:b},function(e){if(e)a.debug&&K.log("[Dev] Captured SS length=",e.length),a.l=void 0;else{var f="no dataUrl.";chrome.runtime.lastError&&(f=chrome.runtime.lastError.message,"string"==typeof f&&f.includes("disabled")&&(a.l=f));if(f!=a.J||3E4<Date.now()-a.S)"true"==ee(a.i.runtime,"clm.debugCapture")&&K.error("[Dev] Capture tab error.",f),
a.J=f,a.S=Date.now()}d(e)})}))})};k.hp=function(){return this.l};function dl(a){Wm.call(this,a)}x(dl,Wm);dl.prototype.Kl=function(){this.ia=new mn(this.i);this.fc=new nn(this.i,this.ia,{debug:this.debug});this.me=new bn(this.i,this.ia);this.Xa="win32"==process.platform?new on(this.i,{debug:this.debug}):new pn({debug:this.debug})};dl.prototype.Sf=function(a,b){this.ia.alert("Deledao Classroom\n\n"+a+"\n\n"+b)};function pn(a){Ym.call(this,a);this.enabled=!1;this.width=1024;this.height=768}x(pn,Ym);
k=pn.prototype;k.lm=function(){};k.fm=function(){var a=this,b;return J(function(c){a.l=new nodeMods.wrtc.nonstandard.RTCVideoSource({isScreencast:!0});b=a.l;return c.return([b.createTrack()])})};k.fn=function(){};
k.start=function(){var a=this,b,c,d,e,f,g,h,l;return J(function(m){switch(m.h){case 1:if(a.enabled){m.m(0);break}a.debug&&K.log("starting screen share ...");a.enabled=!0;b=nodeMods.canvas.createCanvas(a.width,a.height);c=b.getContext("2d");case 3:if(!a.enabled){m.m(4);break}C(m,5);return y(m,Ng(a),7);case 7:d=m.j;if(!d){m.m(8);break}return y(m,nodeMods.canvas.loadImage(d),9);case 9:if(e=m.j)c.drawImage(e,0,0,a.width,a.height),f=c.getImageData(0,0,a.width,a.height),g={width:a.width,height:a.height,
data:new Uint8ClampedArray(1.5*a.width*a.height)},nodeMods.wrtc.nonstandard.rgbaToI420(f,g),h=a.l,h.onFrame(g);case 8:F(m,6);break;case 5:l=H(m),K.warn("Error getting screenshot: "+l);case 6:return y(m,new Promise(function(n){setTimeout(n,1E3)}),3);case 4:a.debug&&K.log("stopping screen share ..."),a.enabled=!1,A(m)}})};k.stop=function(){this.enabled=!1};k.nj=function(){var a;return J(function(b){if(1==b.h)return y(b,nodeMods.screenshot({format:"jpg"}),2);a=b.j;return b.return(a)})};
function on(a,b){pn.call(this,b);this.i=a;this.v=a.Tb.aq}x(on,pn);on.prototype.nj=function(){var a=this,b,c,d;return J(function(e){if(1==e.h)return C(e,2),y(e,Hk(a.v),4);if(2!=e.h)return(b=e.j)&&b.image?(c=Buffer.from(b.image,"base64"),e.return(c)):e.return(void 0);d=H(e);K.warn("Failed to get screenshot from agent: "+d);return e.return(void 0)})};
function mn(a){en.call(this);var b=this;this.i=a;this.Md=a.Tb.Ad();a={};for(var c=t(["activated","updated","removed","proxyFrontendMessage"]),d=c.next();!d.done;a={Ii:a.Ii},d=c.next())a.Ii=d.value,this.Md.addEventListener(a.Ii,function(e){return function(f){for(var g=[],h=0;h<arguments.length;++h)g[h]=arguments[h];b.ha.apply(b,[e.Ii].concat(ca(g)))}}(a))}x(mn,en);k=mn.prototype;k.cc=function(){var a=this;return J(function(b){return b.return(a.Md.cc())})};k.Vh=function(){var a=this;return J(function(b){return b.return(a.Md.Vh())})};
k.remove=function(a){this.Md.remove(a)};k.update=function(a,b){this.Md.update(a,b)};k.create=function(a){this.Md.create(a)};k.alert=function(a){this.Md.alert(a)};k.Mb=function(a,b){var c=this;a?this.Md.Mb(a,b):this.Vh().then(function(d){a=d.id;c.Md.Mb(a,b)})};function nn(a,b,c){$m.call(this,a,b,c)}x(nn,$m);nn.prototype.l=function(){this.debug&&K.log.apply(K,["[PLock] "].concat(ca(arguments)))};
nn.prototype.j=function(){var a=this,b,c,d,e;J(function(f){if(1==f.h)return a.locked?y(f,a.ia.cc(),3):f.m(0);b=f.j;if(!b)return f.return();a.l("check. tabs: ",b);c=t(b);for(d=c.next();!d.done;d=c.next()){e=d.value;if(!e.url)return f.return();e.url!==a.de&&e.active&&qn(a,e.id,!0)}A(f)})};
nn.prototype.o=function(){var a=this,b,c,d,e;J(function(f){if(1==f.h)return y(f,a.ia.cc(),2);b=f.j;if(!b)return f.return();a.l("removeLockTabs, tabs: ",b);c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,qn(a,e.id,!1);A(f)})};function qn(a,b,c){a.ia.Md.Mb(b,{type:"setLockDown",data:{de:a.de,lock:c}})};function Ua(){rn=new sn}function tn(a,b){un(a,void 0===b?"info":b)}function vn(a){un(a,"warn")}function Wa(a){un(a,"error")}function sn(){this.buffer=[];this.h=this.l=!1;this.j=[]}var rn;function un(a,b){var c=rn;c.buffer.push({message:a,level:void 0===b?"info":b});2E3<c.buffer.length&&c.buffer.shift();c.h||(setTimeout(function(){c.h=!1;c.flush()},100),c.h=!0)}
sn.prototype.flush=function(){var a=this,b,c;return J(function(d){a.j.push(a.buffer);a.buffer=[];if(!a.l){for(a.l=!0;0<a.j.length;)b=a.j.shift(),c={recipient:"debugConsole",type:"frontEndLog",data:b},Z(Xa(rb,c));a.l=!1}A(d)})};function wn(a,b){var c;"function"==typeof a.getBoundingClientRect?c=a.getBoundingClientRect():c={};c.width&&c.height||(c={width:a.naturalWidth,height:a.naturalHeight});c.width&&c.height||(c={width:a.width,height:a.height});if(299>c.width||299>c.height){var d=Math.max(a.naturalHeight||0,a.height||0);c.width=Math.max(Math.max(a.naturalWidth||0,a.width||0)||0,c.width||0);c.height=Math.max(d||0,c.height||0)}if(b&&"randomCrop"==b.filter&&c.width&&c.height){d=Math.floor(Math.random()*c.width/2+c.width/
2);var e=Math.floor(Math.random()*c.height/2+c.height/2),f=Math.floor(Math.random()*(c.width-d)),g=Math.floor(Math.random()*(c.height-e)),h=document.createElement("CANVAS");h.width=d;h.height=e;h.getContext("2d").drawImage(a,f,g,d,e,0,0,d,e);a=h;c.width=d;c.height=e}f=c.width;h=c.height;g=b.width;d=b.height;g||d?(f>h?(e=g,c=d):(e=d,c=g),e>=f&&c>=h||!g&&!d?(e=f,c=h):(f/=h,g&&d?(g=e/f,g<=d?c=g:e=c*f):g?c=g/f:d&&(e=d*f),e=Math.round(e),c=Math.round(c))):(e=f,c=h);d=e;e=c;b.rc&&b.width&&b.height?(f=b.width,
c=b.height):(f=d,c=e);g=document.createElement("CANVAS");g.setAttribute("width",f);g.setAttribute("height",c);try{var l=g.getContext("2d");if("grayscale"==b.filter||"contrast"==b.filter||"brightness"==b.filter)l.filter=b.filter+"("+b.Uh+"%)";else if("sharpness"==b.filter){var m=URL.createObjectURL(new Blob(['<svg xmlns="http://www.w3.org/2000/svg" version="1.1"><defs><filter id="sharpness"><feConvolveMatrix order="3" kernelMatrix="0 0 0 0 0 0 0 0 0" /></filter></defs></svg>'],{type:"image/svg+xml"}));
l.filter="url("+m+"#sharpness)"}if("rotate"==b.filter){var n=b.Uh;n||(n=Math.round(40*Math.random()+5));l.translate(Math.floor(f/2),Math.floor(c/2));l.rotate(n*Math.PI/180);l.drawImage(a,-Math.round(d/2),-Math.round(e/2),d,e)}else l.drawImage(a,Math.floor((f-d)/2),Math.floor((c-e)/2),d,e);if(b.format&&0!=b.format.length&&"jpg"!=b.format){if("png"==b.format)return g.toDataURL("image/png");if("raster"==b.format){a=f;m=c;var q=b.colorDepth;q=void 0===q?3:q;var u=new Uint8Array(a*m*q);n=b=0;var r=l.getImageData(0,
0,a,m).data;for(l=0;l<m;l++)for(c=0;c<a;c++)q&&3!=q?u[n]=Math.round((r[b]+r[b+1]+r[b+2])/3):(u[n]=r[b],u[n+1]=r[b+1],u[n+2]=r[b+2]),b+=4,n+=q;return Nc(u)}if("canvas"==b.format)return g}else return g.toDataURL("image/jpeg")}catch(p){K.warn("failed to get image/video frame: "+p)}}function xn(a){if("string"!=typeof a)return!1;var b=0,c=a.length/2;a=t(a);for(var d=a.next();!d.done;d=a.next())if("A"==d.value&&(b++,b>c))return!0;return!1}
function yn(a,b){var c={},d=Object.keys(b);if(1>=d.length){if(1==d.length&&(d=d[0],c[d]=wn(a,b[d]),!c[d]))return null}else{a=wn(a,{format:"canvas"});if(!a)return null;d=t(d);for(var e=d.next();!e.done;e=d.next())if(e=e.value,c[e]=wn(a,b[e]),!c[e])return null}return c}function zn(a){return J(function(b){return b.return(new Promise(function(c){var d=new Image;d.onload=function(){c(d)};d.crossOrigin="Anonymous";d.src=a}))})}
function An(a,b){b||(b={});var c=b.Gw||8;if(a instanceof HTMLCanvasElement&&!b.mf)var d=a;else a instanceof HTMLCanvasElement||(d=document.createElement("CANVAS"),d.width=a.width||a.naturalWidth,d.height=a.height||a.naturalHeight),b.mf?d=wn(a,{format:"canvas",width:b.mf[0],height:b.mf[1]}):d.getContext("2d").drawImage(a,0,0,d.width,d.height);if(!d)return null;b=d.width;a=d.height;try{var e=d.getContext("2d").getImageData(0,0,b,a)}catch(l){return null}e=new Uint32Array(e.data.buffer);d=256-256/c;d|=
d<<16|d<<8;var f=Math.round(Math.log(256/c)/Math.log(2));c=new Uint32Array(Math.pow(c,3));for(var g=0;g<b*a;g++){var h=e[g]&d;h=(h&255)>>f|(h&65280)>>2*f|(h&16711680)>>3*f;c[h]++}e=new Float32Array(c.length);for(d=0;d<c.length;d++)e[d]=c[d]/(b*a)*100;return e}function Bn(a,b){if(a.length!=b.length)throw"Wrong histogram dimensions";for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)};function Cn(){var a=this;this.debug=!1;this.frameId=window==window.top?"0":Cc();this.uk=new Dn;this.mq=new En;this.v=[];window==window.top&&window.addEventListener("message",function(b){var c,d,e,f,g;return J(function(h){switch(h.h){case 1:c=b.data;if("__dld_badContent"==c.type)return C(h,8),y(h,Fn(a.uk,c.data),10);if("__dld_sendToTopMBus"!=c.type){h.m(0);break}C(h,5);return y(h,Fn(a.uk,c.data),7);case 7:d=h.j;Gn(a,d.qt);F(h,0);break;case 5:e=H(h);K.error("Send to top mbus error.",e);h.m(0);break;
case 10:f=h.j;Hn(a,f.qg,f.info);F(h,0);break;case 8:g=H(h),K.error("processing iframe bad content: "+g),A(h)}})});In(this);Jn().then(function(){a.debug&&K.log("page DOM loaded");if(Q.features.ra.xc){var b=new Promise(function(d){setTimeout(d,2E3)}),c=function(){};x(c,kg);c.prototype.Tf=function(d){window.addEventListener("message",function(e){window==window.top&&e.origin!=Va.Oe||d(e.data)})};c.prototype.sendMessage=function(d){var e;return J(function(f){if(1==f.h)return window!=window.top?(e=d.request,
d.request={recipient:"mainFrame",type:"relayMessage",data:e},window.top.postMessage(d,"*"),f.m(0)):y(f,b,3);if(!Va.vq)throw Error("Cannot find cloud utils iframe");Va.vq.contentWindow.postMessage(d,Va.Oe);A(f)})};a.Mk=new lg(new c);window==window.top&&(a.J=new Ti(new Xk,function(d){return J(function(e){return 1==e.h?"mainFrame"!=d.recipient||"relayMessage"!=d.type?e.m(0):a.Mk?y(e,a.Mk.sendRequest(d.data),5):e.return({error:"util client not ready yet"}):e.return(e.j)})}))}a.l=document.body;a.h=document.title;
a.o=document.URL;(new MutationObserver(function(d){Kn(a,d)})).observe(document,{childList:!0,subtree:!0,characterData:!0})})}var Ln,Mn;function In(a){a.j={text:"",images:[],Qb:[]}}Cn.prototype.addEventListener=function(a){this.v.push(a)};
function Jn(){if(!Ln){var a=new Promise(function(c){"loading"!=document.readyState&&"uninitialized"!=document.readyState?c():document.addEventListener("DOMContentLoaded",function(){c()})}),b=new Promise(function(c){setTimeout(c,5E3)});Ln=Promise.race([a,b])}return Ln}function Nn(){var a=Mn,b;return J(function(c){if(1==c.h)return C(c,2),y(c,a.Mk.sendRequest({recipient:"cloudUtils",type:"getModelInputs"}),4);if(2!=c.h)return c.return(c.j);b=H(c);return c.return({error:b.toString()})})}
function On(a,b){var c=Mn,d;return J(function(e){if(1==e.h)return C(e,2),y(e,c.Mk.sendRequest({recipient:"cloudUtils",type:"analyzeImage",data:{pf:a,ka:b}}),4);if(2!=e.h)return e.return(e.j);d=H(e);return e.return({error:d.toString()})})}
function Kn(a,b){var c=!1;b=t(b);for(var d=b.next();!d.done;d=b.next())if(d=d.value,"childList"==d.type){0<d.removedNodes.length&&window==window.top&&(document.body.isSameNode(a.l)||(Ta.sendMessage({type:"docBodyChanged"}),a.l=document.body),a.h!=document.title||a.o!=document.URL)&&(Ta.sendMessage({type:"pageUrlTitleChanged"}),a.h=document.title,a.o=document.URL);d=t(d.addedNodes);for(var e=d.next();!e.done;e=d.next())if(e=e.value,1==e.nodeType){for(var f=t(["VIDEO","IMG"]),g=f.next();!g.done;g=f.next()){var h=
g.value;g="VIDEO"==h?a.j.Qb:a.j.images;e.tagName==h&&(g.push(e),c=!0);h=t(e.getElementsByTagName(h));for(var l=h.next();!l.done;l=h.next())g.push(l.value),c=!0}e=a.mq.jg(e);0<e.length&&(a.j.text+=e+" ",c=!0)}else 3==e.nodeType&&(a.j.text+=e.textContent+" ",c=!0)}else"characterData"==d.type&&(a.j.text+=d.target.textContent+" ",c=!0,window==window.top&&a.h!=document.title&&Ta.sendMessage({type:"pageUrlTitleChanged"}));c&&!a.D&&(a.D=!0,setTimeout(function(){var m=Object.assign({},a.j);In(a);a.D=!1;a.debug&&
K.log("discovered "+m.text.length+" bytes of text, "+m.images.length+" image, "+m.Qb.length+" video changes");for(var n=t(a.v),q=n.next();!q.done;q=n.next()){q=q.value;try{q(m)}catch(u){a.debug&&K.error("onContentChanges: "+u)}}},100))}function Pn(a){var b;J(function(c){1==c.h&&(b||(b=window));b.location.replace(a);return y(c,new Promise(function(d){setTimeout(d,3E3)}),2)})}
function Hn(a,b,c,d){var e,f,g,h,l,m;J(function(n){if(1==n.h){if(window==window.top||d)return n.m(2);e={lt:{url:document.URL,title:document.title},qg:b,info:c};return y(n,Qn(a.uk,e),3)}if(2!=n.h)return f=n.j,g={type:"__dld_badContent",data:f},window.top.postMessage(g,"*"),n.return();h=document.URL;l=c.redirectUrl;delete c.redirectUrl;m={recipient:"dynccUtils",type:"badContentsDetected",data:{url:h,Ua:b,info:{Ba:document.title}}};Object.assign(m.data.info,c);Z(null,m,null,function(q){l||(l=q&&q.redirectUrl);
l&&Pn(l)});A(n)})}function Gn(a,b){var c,d,e;J(function(f){if(1==f.h){if(window==window.top)return Ta.sendMessage(b),f.m(0);c={lt:{url:document.URL,title:document.title},qt:b};return y(f,Qn(a.uk,c),3)}d=f.j;e={type:"__dld_sendToTopMBus",data:d};window.top.postMessage(e,"*");A(f)})}
Cn.prototype.hn=function(){var a,b;return J(function(c){a=window==window.top?document.URL:document.referrer;b={recipient:"dynccUtils",type:"simpleWhitelistCheck",data:{url:a}};return c.return(new Promise(function(d){Z(null,b,null,function(e){d(e)})}))})};function Rn(a,b){a={timestamp:Date.now(),url:document.URL,Ba:document.title,tc:a};Object.assign(a,b);Z(null,{recipient:"dynccUtils",type:"flaggedEvent",data:a})}
function Sn(a,b){var c=[];a=t(a);for(var d=a.next();!d.done;d=a.next())d=d.value,b&&-1!=b.indexOf(d)&&c.push(d);return c}function Xk(){}x(Xk,kg);Xk.prototype.Tf=function(a){window.addEventListener("message",function(b){var c=b.data;c.Ma&&(c.Ma.jq=b.source);a(c)})};Xk.prototype.sendMessage=function(a){var b=a.Ma.jq;b||K.error("cloudUtils RPC: cannot find source frame");delete a.Ma.jq;b.postMessage(a,"*")};
function Dn(){var a=this;this.CryptoJS=Tn();Z(null,{recipient:"runtime",type:"getSessionKey"},function(b){a.Hb=b.key})}function Qn(a,b){var c;return J(function(d){c=JSON.stringify(b);return d.return(a.CryptoJS.AES.encrypt(c,a.Hb).toString())})}function Fn(a,b){var c,d;return J(function(e){c=a.CryptoJS.AES.decrypt(b,a.Hb).toString(a.CryptoJS.enc.Utf8);d=JSON.parse(c);return e.return(d)})}
function Tn(){var a=a||function(b,c){function d(){}var e={},f=e.Pg={},g=f.Bn={extend:function(p){d.prototype=this;var v=new d;p&&v.ym(p);v.hasOwnProperty("init")||(v.init=function(){v.Cq.init.apply(this,arguments)});v.init.prototype=v;v.Cq=this;return v},create:function(){var p=this.extend();p.init.apply(p,arguments);return p},init:function(){},ym:function(p){for(var v in p)p.hasOwnProperty(v)&&(this[v]=p[v]);p.hasOwnProperty("toString")&&(this.toString=p.toString)},clone:function(){return this.init.prototype.extend(this)}},
h=f.Yi=g.extend({init:function(p,v){p=this.nb=p||[];this.Oa=v!=c?v:4*p.length},toString:function(p){return(p||m).stringify(this)},concat:function(p){var v=this.nb,w=p.nb,z=this.Oa;p=p.Oa;this.xo();if(z%4)for(var B=0;B<p;B++)v[z+B>>>2]|=(w[B>>>2]>>>24-B%4*8&255)<<24-(z+B)%4*8;else if(65535<w.length)for(B=0;B<p;B+=4)v[z+B>>>2]=w[B>>>2];else v.push.apply(v,w);this.Oa+=p;return this},xo:function(){var p=this.nb,v=this.Oa;p[v>>>2]&=4294967295<<32-v%4*8;p.length=b.ceil(v/4)},clone:function(){var p=g.clone.call(this);
p.nb=this.nb.slice(0);return p},random:function(p){for(var v=[],w=0;w<p;w+=4)v.push(4294967296*b.random()|0);return new h.init(v,p)}}),l=e.enc={},m=l.Sv={stringify:function(p){var v=p.nb;p=p.Oa;for(var w=[],z=0;z<p;z++){var B=v[z>>>2]>>>24-z%4*8&255;w.push((B>>>4).toString(16));w.push((B&15).toString(16))}return w.join("")},parse:function(p){for(var v=p.length,w=[],z=0;z<v;z+=2)w[z>>>3]|=parseInt(p.substr(z,2),16)<<24-z%8*4;return new h.init(w,v/2)}},n=l.Uv={stringify:function(p){var v=p.nb;p=p.Oa;
for(var w=[],z=0;z<p;z++)w.push(String.fromCharCode(v[z>>>2]>>>24-z%4*8&255));return w.join("")},parse:function(p){for(var v=p.length,w=[],z=0;z<v;z++)w[z>>>2]|=(p.charCodeAt(z)&255)<<24-z%4*8;return new h.init(w,v)}},q=l.Utf8={stringify:function(p){try{return decodeURIComponent(escape(n.stringify(p)))}catch(v){throw Error("Malformed UTF-8 data");}},parse:function(p){return n.parse(unescape(encodeURIComponent(p)))}},u=f.Iq=g.extend({reset:function(){this.ig=new h.init;this.ml=0},$i:function(p){"string"==
typeof p&&(p=q.parse(p));this.ig.concat(p);this.ml+=p.Oa},kg:function(p){var v=this.ig,w=v.nb,z=v.Oa,B=this.blockSize,D=z/(4*B);D=p?b.ceil(D):b.max((D|0)-this.bo,0);p=D*B;z=b.min(4*p,z);if(p){for(var E=0;E<p;E+=B)this.Zn(w,E);E=w.splice(0,p);v.Oa-=z}return new h.init(E,z)},clone:function(){var p=g.clone.call(this);p.ig=this.ig.clone();return p},bo:0});f.Sq=u.extend({Ra:g.extend(),init:function(p){this.Ra=this.Ra.extend(p);this.reset()},reset:function(){u.reset.call(this);this.ll()},update:function(p){this.$i(p);
this.kg();return this},qf:function(p){p&&this.$i(p);return this.aj()},blockSize:16,kl:function(p){return function(v,w){return(new p.init(w)).qf(v)}},cr:function(p){return function(v,w){return(new r.Rv.init(p,w)).qf(v)}}});var r=e.ue={};return e}(Math);(function(){var b=a,c=b.Pg.Yi;b.enc.Base64={stringify:function(d){var e=d.nb,f=d.Oa,g=this.ao;d.xo();d=[];for(var h=0;h<f;h+=3)for(var l=(e[h>>>2]>>>24-h%4*8&255)<<16|(e[h+1>>>2]>>>24-(h+1)%4*8&255)<<8|e[h+2>>>2]>>>24-(h+2)%4*8&255,m=0;4>m&&h+.75*m<
f;m++)d.push(g.charAt(l>>>6*(3-m)&63));if(e=g.charAt(64))for(;d.length%4;)d.push(e);return d.join("")},parse:function(d){var e=d.length,f=this.ao,g=f.charAt(64);g&&(g=d.indexOf(g),-1!=g&&(e=g));g=[];for(var h=0,l=0;l<e;l++)l%4&&(g[h>>>2]|=(f.indexOf(d.charAt(l-1))<<l%4*2|f.indexOf(d.charAt(l))>>>6-l%4*2)<<24-h%4*8,h++);return c.create(g,h)},ao:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(b){function c(u,r,p,v,w,z,B){u=u+(r&p|~r&v)+w+B;return(u<<z|u>>>32-z)+r}
function d(u,r,p,v,w,z,B){u=u+(r&v|p&~v)+w+B;return(u<<z|u>>>32-z)+r}function e(u,r,p,v,w,z,B){u=u+(r^p^v)+w+B;return(u<<z|u>>>32-z)+r}function f(u,r,p,v,w,z,B){u=u+(p^(r|~v))+w+B;return(u<<z|u>>>32-z)+r}var g=a,h=g.Pg,l=h.Yi,m=h.Sq;h=g.ue;for(var n=[],q=0;64>q;q++)n[q]=4294967296*b.abs(b.sin(q+1))|0;h=h.Ln=m.extend({ll:function(){this.bj=new l.init([1732584193,4023233417,2562383102,271733878])},Zn:function(u,r){for(var p=0;16>p;p++){var v=r+p,w=u[v];u[v]=(w<<8|w>>>24)&16711935|(w<<24|w>>>8)&4278255360}p=
this.bj.nb;v=u[r+0];w=u[r+1];var z=u[r+2],B=u[r+3],D=u[r+4],E=u[r+5],G=u[r+6],M=u[r+7],T=u[r+8],O=u[r+9],R=u[r+10],N=u[r+11],Y=u[r+12],W=u[r+13],X=u[r+14];u=u[r+15];r=p[0];var L=p[1],I=p[2],P=p[3];r=c(r,L,I,P,v,7,n[0]);P=c(P,r,L,I,w,12,n[1]);I=c(I,P,r,L,z,17,n[2]);L=c(L,I,P,r,B,22,n[3]);r=c(r,L,I,P,D,7,n[4]);P=c(P,r,L,I,E,12,n[5]);I=c(I,P,r,L,G,17,n[6]);L=c(L,I,P,r,M,22,n[7]);r=c(r,L,I,P,T,7,n[8]);P=c(P,r,L,I,O,12,n[9]);I=c(I,P,r,L,R,17,n[10]);L=c(L,I,P,r,N,22,n[11]);r=c(r,L,I,P,Y,7,n[12]);P=c(P,
r,L,I,W,12,n[13]);I=c(I,P,r,L,X,17,n[14]);L=c(L,I,P,r,u,22,n[15]);r=d(r,L,I,P,w,5,n[16]);P=d(P,r,L,I,G,9,n[17]);I=d(I,P,r,L,N,14,n[18]);L=d(L,I,P,r,v,20,n[19]);r=d(r,L,I,P,E,5,n[20]);P=d(P,r,L,I,R,9,n[21]);I=d(I,P,r,L,u,14,n[22]);L=d(L,I,P,r,D,20,n[23]);r=d(r,L,I,P,O,5,n[24]);P=d(P,r,L,I,X,9,n[25]);I=d(I,P,r,L,B,14,n[26]);L=d(L,I,P,r,T,20,n[27]);r=d(r,L,I,P,W,5,n[28]);P=d(P,r,L,I,z,9,n[29]);I=d(I,P,r,L,M,14,n[30]);L=d(L,I,P,r,Y,20,n[31]);r=e(r,L,I,P,E,4,n[32]);P=e(P,r,L,I,T,11,n[33]);I=e(I,P,r,L,
N,16,n[34]);L=e(L,I,P,r,X,23,n[35]);r=e(r,L,I,P,w,4,n[36]);P=e(P,r,L,I,D,11,n[37]);I=e(I,P,r,L,M,16,n[38]);L=e(L,I,P,r,R,23,n[39]);r=e(r,L,I,P,W,4,n[40]);P=e(P,r,L,I,v,11,n[41]);I=e(I,P,r,L,B,16,n[42]);L=e(L,I,P,r,G,23,n[43]);r=e(r,L,I,P,O,4,n[44]);P=e(P,r,L,I,Y,11,n[45]);I=e(I,P,r,L,u,16,n[46]);L=e(L,I,P,r,z,23,n[47]);r=f(r,L,I,P,v,6,n[48]);P=f(P,r,L,I,M,10,n[49]);I=f(I,P,r,L,X,15,n[50]);L=f(L,I,P,r,E,21,n[51]);r=f(r,L,I,P,Y,6,n[52]);P=f(P,r,L,I,B,10,n[53]);I=f(I,P,r,L,R,15,n[54]);L=f(L,I,P,r,w,
21,n[55]);r=f(r,L,I,P,T,6,n[56]);P=f(P,r,L,I,u,10,n[57]);I=f(I,P,r,L,G,15,n[58]);L=f(L,I,P,r,W,21,n[59]);r=f(r,L,I,P,D,6,n[60]);P=f(P,r,L,I,N,10,n[61]);I=f(I,P,r,L,z,15,n[62]);L=f(L,I,P,r,O,21,n[63]);p[0]=p[0]+r|0;p[1]=p[1]+L|0;p[2]=p[2]+I|0;p[3]=p[3]+P|0},aj:function(){var u=this.ig,r=u.nb,p=8*this.ml,v=8*u.Oa;r[v>>>5]|=128<<24-v%32;var w=b.floor(p/4294967296);r[(v+64>>>9<<4)+15]=(w<<8|w>>>24)&16711935|(w<<24|w>>>8)&4278255360;r[(v+64>>>9<<4)+14]=(p<<8|p>>>24)&16711935|(p<<24|p>>>8)&4278255360;u.Oa=
4*(r.length+1);this.kg();u=this.bj;r=u.nb;for(p=0;4>p;p++)v=r[p],r[p]=(v<<8|v>>>24)&16711935|(v<<24|v>>>8)&4278255360;return u},clone:function(){var u=m.clone.call(this);u.bj=this.bj.clone();return u}});g.Ln=m.kl(h);g.Tv=m.cr(h)})(Math);(function(){var b=a,c=b.Pg,d=c.Bn,e=c.Yi;c=b.ue;var f=c.Fn=d.extend({Ra:d.extend({Og:4,Ys:c.Ln,iterations:1}),init:function(g){this.Ra=this.Ra.extend(g)},Bo:function(g,h){var l=this.Ra,m=l.Ys.create(),n=e.create(),q=n.nb,u=l.Og;for(l=l.iterations;q.length<u;){r&&m.update(r);
var r=m.update(g).qf(h);m.reset();for(var p=1;p<l;p++)r=m.qf(r),m.reset();n.concat(r)}n.Oa=4*u;return n}});b.Fn=function(g,h,l){return f.create(l).Bo(g,h)}})();a.Pg.Lq||function(b){function c(w,z,B){var D=this.$n;D?this.$n=b:D=this.eo;for(var E=0;E<B;E++)w[z+E]^=D[E]}var d=a,e=d.Pg,f=e.Bn,g=e.Yi,h=e.Iq,l=d.enc.Base64,m=d.ue.Fn,n=e.Lq=h.extend({Ra:f.extend(),Ml:function(w,z){return this.create(this.jl,w,z)},Ll:function(w,z){return this.create(this.br,w,z)},init:function(w,z,B){this.Ra=this.Ra.extend(B);
this.fo=w;this.er=z;this.reset()},reset:function(){h.reset.call(this);this.ll()},process:function(w){this.$i(w);return this.kg()},qf:function(w){w&&this.$i(w);return this.aj()},Og:4,zp:4,jl:1,br:2,kl:function(w){return{encrypt:function(z,B,D){return("string"==typeof B?v:p).encrypt(w,z,B,D)},decrypt:function(z,B,D){return("string"==typeof B?v:p).decrypt(w,z,B,D)}}}});e.jw=n.extend({aj:function(){return this.kg(!0)},blockSize:1});var q=d.mode={},u=(e.Av=f.extend({Ml:function(w,z){return this.Pq.create(w,
z)},Ll:function(w,z){return this.Nq.create(w,z)},init:function(w,z){this.Xn=w;this.$n=z}})).extend();u.Pq=u.extend({Sp:function(w,z){var B=this.Xn,D=B.blockSize;c.call(this,w,z,D);B.ys(w,z);this.eo=w.slice(z,z+D)}});u.Nq=u.extend({Sp:function(w,z){var B=this.Xn,D=B.blockSize,E=w.slice(z,z+D);B.Xr(w,z);c.call(this,w,z,D);this.eo=E}});q=q.Gv=u;u=(d.Pp={}).Zv={Pp:function(w,z){z=4*z;z-=w.Oa%z;for(var B=z<<24|z<<16|z<<8|z,D=[],E=0;E<z;E+=4)D.push(B);z=g.create(D,z);w.concat(z)},$u:function(w){w.Oa-=w.nb[w.Oa-
1>>>2]&255}};e.Eq=n.extend({Ra:n.Ra.extend({mode:q,padding:u}),reset:function(){n.reset.call(this);var w=this.Ra,z=w.iv;w=w.mode;if(this.fo==this.jl)var B=w.Ml;else B=w.Ll,this.bo=1;this.gr=B.call(w,this,z&&z.nb)},Zn:function(w,z){this.gr.Sp(w,z)},aj:function(){var w=this.Ra.padding;if(this.fo==this.jl){w.Pp(this.ig,this.blockSize);var z=this.kg(!0)}else z=this.kg(!0),w.$u(z);return z},blockSize:4});var r=e.Jv=f.extend({init:function(w){this.ym(w)},toString:function(w){return(w||this.Es).stringify(this)}});
q=(d.format={}).Xq={stringify:function(w){var z=w.Hl;w=w.salt;return(w?g.create([1398893684,1701076831]).concat(w).concat(z):z).toString(l)},parse:function(w){w=l.parse(w);var z=w.nb;if(1398893684==z[0]&&1701076831==z[1]){var B=g.create(z.slice(2,4));z.splice(0,4);w.Oa-=16}return r.create({Hl:w,salt:B})}};var p=e.iw=f.extend({Ra:f.extend({format:q}),encrypt:function(w,z,B,D){D=this.Ra.extend(D);var E=w.Ml(B,D);z=E.qf(z);E=E.Ra;return r.create({Hl:z,key:B,iv:E.iv,algorithm:w,mode:E.mode,padding:E.padding,
blockSize:w.blockSize,Es:D.format})},decrypt:function(w,z,B,D){D=this.Ra.extend(D);z=this.co(z,D.format);return w.Ll(B,D).qf(z.Hl)},co:function(w,z){return"string"==typeof w?z.parse(w,this):w}});d=(d.sm={}).Xq={execute:function(w,z,B,D){D||(D=g.random(8));w=m.create({Og:z+B}).Bo(w,D);B=g.create(w.nb.slice(z),4*B);w.Oa=4*z;return r.create({key:w,iv:B,salt:D})}};var v=e.Wv=p.extend({Ra:p.Ra.extend({sm:d}),encrypt:function(w,z,B,D){D=this.Ra.extend(D);B=D.sm.execute(B,w.Og,w.zp);D.iv=B.iv;w=p.encrypt.call(this,
w,z,B.key,D);w.ym(B);return w},decrypt:function(w,z,B,D){D=this.Ra.extend(D);z=this.co(z,D.format);B=D.sm.execute(B,w.Og,w.zp,z.salt);D.iv=B.iv;return p.decrypt.call(this,w,z,B.key,D)}})}();(function(){for(var b=a,c=b.Pg.Eq,d=b.ue,e=[],f=[],g=[],h=[],l=[],m=[],n=[],q=[],u=[],r=[],p=[],v=0;256>v;v++)p[v]=128>v?v<<1:v<<1^283;var w=0,z=0;for(v=0;256>v;v++){var B=z^z<<1^z<<2^z<<3^z<<4;B=B>>>8^B&255^99;e[w]=B;f[B]=w;var D=p[w],E=p[D],G=p[E],M=257*p[B]^16843008*B;g[w]=M<<24|M>>>8;h[w]=M<<16|M>>>16;l[w]=
M<<8|M>>>24;m[w]=M;M=16843009*G^65537*E^257*D^16843008*w;n[B]=M<<24|M>>>8;q[B]=M<<16|M>>>16;u[B]=M<<8|M>>>24;r[B]=M;w?(w=D^p[p[p[G^D]]],z^=p[p[z]]):w=z=1}var T=[0,1,2,4,8,16,32,64,128,27,54];d=d.AES=c.extend({ll:function(){var O=this.er,R=O.nb,N=O.Oa/4;O=4*((this.hr=N+6)+1);for(var Y=this.fr=[],W=0;W<O;W++)if(W<N)Y[W]=R[W];else{var X=Y[W-1];W%N?6<N&&4==W%N&&(X=e[X>>>24]<<24|e[X>>>16&255]<<16|e[X>>>8&255]<<8|e[X&255]):(X=X<<8|X>>>24,X=e[X>>>24]<<24|e[X>>>16&255]<<16|e[X>>>8&255]<<8|e[X&255],X^=T[W/
N|0]<<24);Y[W]=Y[W-N]^X}R=this.dr=[];for(N=0;N<O;N++)W=O-N,X=N%4?Y[W]:Y[W-4],R[N]=4>N||4>=W?X:n[e[X>>>24]]^q[e[X>>>16&255]]^u[e[X>>>8&255]]^r[e[X&255]]},ys:function(O,R){this.Yn(O,R,this.fr,g,h,l,m,e)},Xr:function(O,R){var N=O[R+1];O[R+1]=O[R+3];O[R+3]=N;this.Yn(O,R,this.dr,n,q,u,r,f);N=O[R+1];O[R+1]=O[R+3];O[R+3]=N},Yn:function(O,R,N,Y,W,X,L,I){for(var P=this.hr,ha=O[R]^N[0],ma=O[R+1]^N[1],aa=O[R+2]^N[2],V=O[R+3]^N[3],na=4,za=1;za<P;za++){var xa=Y[ha>>>24]^W[ma>>>16&255]^X[aa>>>8&255]^L[V&255]^N[na++],
Sa=Y[ma>>>24]^W[aa>>>16&255]^X[V>>>8&255]^L[ha&255]^N[na++],oc=Y[aa>>>24]^W[V>>>16&255]^X[ha>>>8&255]^L[ma&255]^N[na++];V=Y[V>>>24]^W[ha>>>16&255]^X[ma>>>8&255]^L[aa&255]^N[na++];ha=xa;ma=Sa;aa=oc}xa=(I[ha>>>24]<<24|I[ma>>>16&255]<<16|I[aa>>>8&255]<<8|I[V&255])^N[na++];Sa=(I[ma>>>24]<<24|I[aa>>>16&255]<<16|I[V>>>8&255]<<8|I[ha&255])^N[na++];oc=(I[aa>>>24]<<24|I[V>>>16&255]<<16|I[ha>>>8&255]<<8|I[ma&255])^N[na++];V=(I[V>>>24]<<24|I[ha>>>16&255]<<16|I[ma>>>8&255]<<8|I[aa&255])^N[na++];O[R]=xa;O[R+1]=
Sa;O[R+2]=oc;O[R+3]=V},Og:8});b.AES=c.kl(d)})();return a};function Un(a){this.debug=a;this.Ff=!1;this.h={};this.Za={};this.state={};this.Ug=!1;this.l="https://www.google.com"}k=Un.prototype;k.ej=function(a,b){this.Ff?(this.debug&&tn("adding "+a+" to allowed referrer list, referred by: "+b),this.h[a]=!0):Wa("attempting to add referrer while not tracking")};k.lg=function(a){this.Za[a]=!0};k.Tj=function(a){if(!a)return!0;for(var b in this.Za)if(a.startsWith(b))return!0;return!1};
k.rm=function(a){if(!a)return!1;if(this.Tj(a))return!0;try{var b=new URL(a)}catch(e){return!1}for(var c in this.h)try{var d=new URL(c);if(b.hostname==d.hostname&&b.pathname.split("/",2)[1]==d.pathname.split("/",2)[1])return!0}catch(e){}return!1};k.ie=function(a,b){this.state[a]=b};k.getState=function(a){return this.state[a]};
function Vn(a,b){this.B=a;this.debug=this.B.debug;this.v=[Q.Eb,"localhost"];this.J=[Q.Fa+"/homewelcome.html##"];navigator.userAgent.includes("Mobile")||navigator.userAgent.includes("Android");if(b)this.h=b;else if(this.h=new Un(this.debug),a.state)try{Object.assign(this.h,JSON.parse(a.state))}catch(c){Wa("Invalid auth state object received")}this.D=new Qc;this.S=1;this.j=0}k=Vn.prototype;k.Ef=function(){return!1};
k.Bb=function(){var a=this,b,c,d,e;J(function(f){if(!a.B.Ta)return K.error("captive URL undefined"),f.return();if(!a.Ef()){if(document.URL.startsWith(a.B.Ta))Wn(a);else return f.return();return f.m(0)}document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState||a.h.Ug||(a.debug&&tn("reloading because of visibility change: "+document.URL),rn.flush(),window.top.location.reload())},!1);if(document.URL.startsWith(a.B.Ta))return a.yd(),f.m(0);if(!("about:blank"==document.URL||
a.Ff()&&(a.Tj(document.URL)||a.rm(document.referrer)))){c=!1;try{for(b=new URL(document.URL),d=0;d<a.v.length;d++)if(b.hostname.endsWith(a.v[d])&&!a.J.includes(document.URL)){c=!0;break}}catch(g){}c||(a.debug&&(vn("denied auth navigation: "+document.referrer.substr(0,384)+" => "+document.URL.substr(0,384)),rn.flush()),e=a.B.Ta,e=a.B.Ta.includes("?")?e+"&":e+"?",e+="r="+encodeURIComponent(document.URL),e+="&rf="+encodeURIComponent(document.referrer),location.replace(e));return f.m(0)}a.debug&&tn("allowed auth navigation: "+
document.referrer.substr(0,384)+" => "+document.URL.substr(0,384));return document.URL&&"about:blank"!=document.URL?y(f,a.ej(document.URL,document.referrer),0):f.m(0)})};k.yd=function(){};k.rm=function(a){if(!a)return!1;if(this.B.Ta)try{var b=new URL(this.B.Ta);if(-1!=a.indexOf(b.hostname))return!0}catch(c){}return this.h.rm(a)};
k.Zd=function(){if(document.URL.startsWith(this.B.Ta)){try{var a=(new URL(document.URL)).searchParams.get("r");if(!a)throw Error("cannot find r search param");a=decodeURIComponent(a);if(a.startsWith("https://www.google.com/url?"))try{var b=(new URL(a)).searchParams.get("q");b&&(a=decodeURIComponent(b))}catch(e){}else{b=a;if(b.startsWith("file:///private/var/"))try{var c=new URL(b);b=c.searchParams.get("targetUrl");if(!b){var d=c.hash;d&&11<d.length?b=d.substring(11):b=this.l}}catch(e){b=this.l}a=
b}}catch(e){a=this.l}return a}};function Wn(a,b){var c=a.Zd();c&&"about:blank"!=c&&"chrome://newtab/"!=c?window.top.location.replace(c):window.top.location.replace(b||a.l)}function Xn(a){a.B.Fh&&window.top.location.replace(a.B.Fh)}function Yn(a,b,c){return J(function(d){var e=a.h;e.debug&&tn("start tracking referrers: "+c);e.Ff=!0;b&&e.ie("default",b);c&&e.ej(c);return y(d,Zn(a),0)})}
function $n(a){return J(function(b){var c=a.h;c.debug&&tn("stop tracking referrers");c.Ff=!1;c.h={};return y(b,Zn(a),0)})}k.ej=function(a,b){var c=this;return J(function(d){c.h.ej(a,b);return y(d,Zn(c),0)})};k.lg=function(a){var b=this;J(function(c){b.h.lg(a);return y(c,Zn(b),0)})};function ao(a,b){var c;return J(function(d){a.debug&&K.log("addWhitelists="+b);for(c=c=0;c<b.length;c++)a.h.lg(b[c]);return y(d,Zn(a),0)})}k.Tj=function(a){return this.h.Tj(a)};k.Ff=function(){return this.h.Ff};
k.getState=function(a){return this.h.getState(a)};k.ie=function(a,b){var c=this;return J(function(d){c.h.ie(a,b);return y(d,Zn(c),0)})};
function Zn(a){var b,c,d;return J(function(e){switch(e.h){case 1:b=JSON.stringify(a.h),c=a.S++;case 2:if(!(c>a.j&&c!=a.j+1)){if(c!=a.j+1)return K.error("saveState(): my job has been skipped. My ticket: "+c+", finished ticket: "+a.j),e.return();C(e,5,6);return y(e,new Promise(function(f){Z({recipient:"authBackend",type:"saveState",data:{state:b}},function(){f()})}),6)}return y(e,a.D.wait(),2);case 6:va(e);a.j=c;a.D.signal();wa(e,0);break;case 5:d=H(e),K.error("saveState: "+d),e.m(6)}})};function bo(a,b){Vn.call(this,a,b)}x(bo,Vn);function co(){for(var a={},b=t(location.hash.substr(1).split("&")),c=b.next();!c.done;c=b.next())c=c.value.split("=",2),a[c[0]]=decodeURIComponent(c[1]);return a}function eo(a,b){Vn.call(this,a,b);this.o=Q.xi+"/default/googleCallback.html";this.zd=this.B.zd;this.h.lg("https://accounts.google.com/");this.h.lg("https://accounts.youtube.com/")}x(eo,bo);eo.prototype.Ef=function(){return this.B.Ia};
eo.prototype.Bb=function(){var a=this,b,c,d,e,f,g;J(function(h){switch(h.h){case 1:if(!document.URL.startsWith(a.o)){bo.prototype.Bb.call(a);h.m(0);break}return y(h,$n(a),3);case 3:C(h,4);b=co();if(c=b.error)throw Error(c);d=b.id_token;if(!d)throw Error("no ID token found in response");a.debug&&tn("Got g suite id token: "+d);return y(h,new Promise(function(l,m){Z({recipient:"authBackend",type:"gsuiteToken",data:{token:d}},function(n){n.error?(a.debug&&vn("authBackend gsuiteToken callback: "+n.error),
m(n.error)):l()})}),6);case 6:Wn(a);F(h,0);break;case 4:return e=H(h),Wa("G Suite sign-in: "+JSON.stringify(e)),y(h,a.ie("prompt","select_account"),8);case 8:return f=a.B.Ta,-1==f.indexOf("?")&&(f+="?"),y(h,new Promise(function(l){setTimeout(l,1E3)}),9);case 9:g=e instanceof Error?e.toString():"object"==typeof e?JSON.stringify(e):e,f+="&msg="+encodeURIComponent(g)+"&r="+a.Zd(),location.replace(f),A(h)}})};
eo.prototype.Zd=function(){if(document.URL.startsWith(this.o)){var a=co().state||"https://www.google.com";if(a.startsWith("file:///private/var/"))try{var b=decodeURIComponent(a);(a=(new URL(b)).searchParams.get("targetUrl"))||(a="https://www.google.com")}catch(c){a="https://www.google.com"}return a}return bo.prototype.Zd.call(this)};
eo.prototype.yd=function(){var a=this,b,c,d;J(function(e){switch(e.h){case 1:return y(e,Jn(),2);case 2:if(a.B.di)return b={recipient:"authBackend",type:"userSignedOut"},y(e,new Promise(function(f){Z(b,function(){f()})}),7);if(!a.Ff()||"glogout"!=a.getState("gsuite")){e.m(4);break}return y(e,$n(a),4);case 7:return a.B.It?y(e,a.ie("prompt","select_account"),4):y(e,a.ie("gsuite","glogout"),11);case 11:return y(e,Yn(a),12);case 12:window.top.location.replace(a.zd+encodeURIComponent(document.URL));case 4:if(c=
document.getElementById("combogsuite"))K.log("combogsuite button registered."),c.addEventListener("click",function(){var f,g,h;return J(function(l){switch(l.h){case 1:return K.log("combogsuite button clicked."),a.h.Ug=!0,f=a.B.Ka||[],f=f.concat(["https://accounts.google.com/","https://accounts.youtube.com/"]),y(l,ao(a,f),2);case 2:return y(l,a.ie("gsuite","glogin"),3);case 3:return y(l,Yn(a,void 0,a.B.Ta),4);case 4:K.log("combogsuite redirecting to Google sign-in."),g="https://accounts.google.com/o/oauth2/v2/auth?response_type=id_token&client_id="+
Pa+"&scope=openid%20email%20profile&redirect_uri="+encodeURIComponent(a.o)+"&response_mode=fragment&state="+encodeURIComponent(a.Zd())+"&nonce="+Math.floor(1E4*Math.random()),(h=a.getState("prompt"))&&(g+="&prompt="+h),location.replace(g),A(l)}})});a.B.Fh&&(d=document.getElementById("combocancel"))&&(d.style.display="block",d.addEventListener("click",function(){a.debug&&tn("User cancelled login process");Z({recipient:"authBackend",type:"loginCancelled"},function(){Xn(a)})}));A(e)}})};
function fo(a,b){Vn.call(this,a,b);this.o=Q.xi+"/default/azureCallback.html";this.h.lg("https://login.microsoftonline.com/")}x(fo,bo);fo.prototype.Ef=function(){return this.B.Ia};
fo.prototype.Bb=function(){var a=this,b,c,d,e,f,g;J(function(h){switch(h.h){case 1:if(!document.URL.startsWith(a.o)){bo.prototype.Bb.call(a);h.m(0);break}return y(h,$n(a),3);case 3:C(h,4);b=co();if(c=b.error)throw Error(c);d=b.id_token;if(!d)throw Error("no ID token found in response");a.debug&&tn("Got azure id token: "+d);return y(h,new Promise(function(l,m){Z({recipient:"authBackend",type:"azureToken",data:{token:d}},function(n){n.error?(a.debug&&vn("authBackend azure callback: "+n.error),m(n.error)):
l()})}),7);case 7:Wn(a);case 6:F(h,0);break;case 4:return e=H(h),Wa("Azure sign-in: "+e),y(h,a.ie("prompt","login"),8);case 8:f=a.B.Ta,-1==f.indexOf("?")&&(f+="?"),g=e instanceof Error?e.toString():"object"==typeof e?JSON.stringify(e):e,f+="&msg="+encodeURIComponent(g)+"&r="+a.Zd(),location.replace(f),A(h)}})};
fo.prototype.Zd=function(){if(document.URL.startsWith(this.o)){var a=co().state||"https://www.google.com";if(a.startsWith("file:///private/var/"))try{var b=decodeURIComponent(a);(a=(new URL(b)).searchParams.get("targetUrl"))||(a="https://www.google.com")}catch(c){a="https://www.google.com"}return a}return bo.prototype.Zd.call(this)};
fo.prototype.yd=function(){var a=this,b,c;J(function(d){if(1==d.h)return y(d,Jn(),2);if(b=document.getElementById("comboazure"))K.log("comboazure button registered."),b.addEventListener("click",function(){var e,f,g;return J(function(h){switch(h.h){case 1:return K.log("comboazure button clicked."),a.h.Ug=!0,e=a.B.Ka||[],e=e.concat(["https://login.microsoftonline.com/"]),y(h,ao(a,e),2);case 2:return y(h,a.ie("azure","azlogin"),3);case 3:return y(h,Yn(a,void 0,a.B.Ta),4);case 4:K.log("comboazure redirecting to Azure sign-in."),
f="https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?response_type=id_token&client_id="+Qa+"&scope=openid%20email%20profile&redirect_uri="+encodeURIComponent(a.o)+"&response_mode=fragment&state="+encodeURIComponent(a.Zd())+"&nonce="+Math.floor(1E4*Math.random()),(g=a.getState("prompt"))&&(f+="&prompt="+g),location.replace(f),A(h)}})});a.B.Fh&&(c=document.getElementById("combocancel"))&&(c.style.display="block",c.addEventListener("click",function(){a.debug&&tn("User cancelled login process");
Z({recipient:"authBackend",type:"loginCancelled"},function(){Xn(a)})}));A(d)})};function go(a){Vn.call(this,Object.assign(a,{hu:!0}));this.h.Ug=!0}x(go,Vn);go.prototype.Ef=function(){return this.B.Ia};go.prototype.yd=function(){var a=this,b;J(function(c){if(1==c.h)return Vn.prototype.yd.call(a),y(c,Jn(),2);if(b=document.getElementById("custSignInButton"))b.onclick=function(){ho(a)};A(c)})};
function ho(a){var b,c,d;J(function(e){b=document.getElementById("username").value;c=document.getElementById("password").value;d={recipient:"authBackend",type:"custUserPass",data:{user:b,pa:c}};Z(d,function(f){f.error?"notPaidPlatform"===f.error?document.getElementById("errorMsg").innerHTML="The version you registered is a limited version, which can only be used on iPad or iPhone. If you'd like your account be used on all platforms, please login to your parent portal account and convert from there.":
"Cannot find custID. verified: false"===f.error?(document.getElementById("errorMsg").innerHTML="Your account has not been verified",document.getElementById("username").style.display="none",document.getElementById("password").style.display="none",document.getElementById("forgotpass").style.display="none",document.getElementById("custSignInButton").style.display="none",document.getElementById("errorMsg3").style.display="none",document.getElementById("errorMsg4").style.display="none",document.getElementById("errorMsg2").style.display=
"block"):"Cannot find custID. verified: "===f.error?(document.getElementById("errorMsg").innerHTML="Congrats! "+Q.fh+" has offered you a free standard plan of "+Q.fh+" Family for your home devices.",document.getElementById("username").style.display="none",document.getElementById("password").style.display="none",document.getElementById("forgotpass").style.display="none",document.getElementById("errorMsg2").style.display="none",document.getElementById("errorMsg4").style.display="none",document.getElementById("custSignInButton").style.display=
"none",document.getElementById("errorMsg3").style.display="block"):(document.getElementById("errorMsg").innerHTML="Email or password does not match a "+Q.fh+" account",document.getElementById("forgotpass").style.display="none",document.getElementById("errorMsg3").style.display="none",document.getElementById("errorMsg2").style.display="none",document.getElementById("errorMsg4").style.display="block"):Wn(a,Q.hm)});A(e)})}
function io(a){Vn.call(this,Object.assign(a,{hu:!0}));this.Dd=new eo(a,this.h);this.pg=new fo(a,this.h);this.h.Ug=!0}x(io,Vn);io.prototype.Ef=function(){return this.B.Ia};io.prototype.Bb=function(){var a=this;J(function(b){Vn.prototype.Bb.call(a);a.Dd.Bb();a.pg.Bb();A(b)})};io.prototype.yd=function(){var a=this,b;J(function(c){if(1==c.h)return Vn.prototype.yd.call(a),a.Dd.yd(),a.pg.yd(),y(c,Jn(),2);if(b=document.getElementById("custSignInButton"))b.onclick=function(){jo(a)};A(c)})};
function jo(a){var b,c,d;J(function(e){b=document.getElementById("username").value;c=document.getElementById("password").value;d={recipient:"authBackend",type:"custUserPass",data:{user:b,pa:c}};Z(d,function(f){if(f.error){var g=document.getElementById("status");g&&(g.innerHTML=f.error)}else Wn(a)});A(e)})}function ko(a){Vn.call(this,a);this.h.Ug=!0}x(ko,Vn);ko.prototype.Ef=function(){return this.B.Ia};
ko.prototype.yd=function(){var a=this,b,c,d,e,f,g,h,l;J(function(m){if(1==m.h)return y(m,Jn(),2);b=document.getElementById("selectName");c=a.B.Lk;d=[];if(c&&0!==c.length){for(e=0;e<c.length;e++)f=c[e].split(":"),g=f[1],d.push(g),h=f[0],l=document.createElement("option"),l.textContent=h,l.value=h,b.appendChild(l);b.onchange=function(n){document.getElementById("passblock").style.display=d[n.target.selectedIndex-1]?"block":"none"}}else document.getElementById("nouser").style.display="block",document.getElementById("signinform").style.display=
"none";document.getElementById("signin").onclick=function(){lo(a)};A(m)})};function lo(a){var b,c,d,e,f;J(function(g){b=document.getElementById("selectName");c=b.options[b.selectedIndex].value;if(""===c)return alert("Please select a user name"),g.return();d=document.getElementById("password").value;e=document.getElementById("rememberme").checked?!0:!1;f={recipient:"authBackend",type:"homeUser",data:{user:c,password:d,oi:e}};Z(f,function(h){h.error?alert(h.error):Wn(a,Q.hm)});A(g)})}
function mo(a){Vn.call(this,a)}x(mo,Vn);
mo.prototype.G=function(){var a=this,b,c,d,e,f,g;return J(function(h){if(1==h.h)return b=new URL(window.location.href),c=new URLSearchParams(b.search),d=c.get("rem"),e=c.get("token"),y(h,Jn(),2);f=document.getElementById("msg");e=decodeURIComponent(e);g={recipient:"authBackend",type:"jwtToken",data:{token:e}};d&&(g.data.oi=!0);Z(g,function(l){l||(vn("QR code login send message error. Reloading page ..."),location.reload());a.debug&&tn("TokenAuth got auth result "+JSON.stringify(l));l.error?(a.debug&&
K.warn(l.error),f&&(f.innerText=l.error)):(f&&(f.innerText="Successfully logged in as "+l.user),setTimeout(function(){l.rp?Wn(a,l.rp):Wn(a,Q.hm)},2E3))});A(h)})};function no(a){Vn.call(this,a)}x(no,Vn);no.prototype.Ef=function(){return!0};
function oo(){this.Ch=new Promise(function(a){var b,c,d,e,f,g,h,l;return J(function(m){switch(m.h){case 1:(document.URL.startsWith("chrome://")||document.URL==Q.ei+"/diag.html"||document.URL==Q.ei+"/diagFam.html")&&a();if(!document.URL.startsWith(Q.wu())&&!document.URL.startsWith(Q.bs())){m.m(2);break}return y(m,(new mo({debug:!1})).G(),3);case 3:return m.return();case 2:c={};case 4:return c.Pk={recipient:"authBackend",type:"isAuthNeeded",data:{}},y(m,new Promise(function(n){return function(q){Z(n.Pk,
function(u){q(u)})}}(c)),6);case 6:b=m.j;c.Li=100;if(b)if(b.retry)c.Li=1E3*b.retry;else{m.m(5);break}return y(m,new Promise(function(n){return function(q){setTimeout(q,n.Li)}}(c)),7);case 7:c={Pk:c.Pk,Li:c.Li};m.m(4);break;case 5:if(!b.enabled)return a(),m.return();if(!b.Ia||b.zd&&document.URL.startsWith(b.zd)){if(b.df)for(f=t(b.df),g=f.next();!g.done;g=f.next())if(h=g.value,document.URL.startsWith(h))return l={Ta:h},(new Vn(l)).Bb(),m.return();a()}else if("customer"==b.Cc)(new io(b)).Bb();else if("gsuite"==
b.Cc)d=new eo(b),d.Bb();else if("azure-ad"==b.Cc)e=new fo(b),e.Bb();else if("home-customer"==b.Cc)(new go(b)).Bb();else if(b.Cc==Q.Fd)(new ko(b)).Bb();else if("cloudError"==b.Cc)return(new no(b)).Bb(),m.return();A(m)}})});this.Ch.catch(function(a){Wa("Auth promised rejected: "+a+", "+a.stack)});this.debug&&this.Ch.then(function(){K.log("auth is done")})}var po;function qo(){(new Promise(function(){var a,b,c;return J(function(d){if(1==d.h)return y(d,new Promise(function(e){"loading"!=document.readyState?e():document.addEventListener("DOMContentLoaded",function(){e()})}),2);a=new URL(window.location.href);b=new URLSearchParams(decodeURIComponent(a.search));b.has("reason")?ro(b.get("site"),b.get("category"),b.get("cids"),b.get("title"),b.get("reason")):(c=document.getElementById("unblockreq"))&&c.addEventListener("click",function(){var e=new URL(window.location.href),
f=new URLSearchParams(e.search);e=f.get("site");var g=f.get("category"),h=f.get("cids");f=f.get("title");ro(e,g,h,f,document.getElementById("comment").value)});A(d)})})).then(function(){}).catch()}
function ro(a,b,c,d,e){Z(Xa(Bb,{recipient:"policy",type:"homeUnblock",data:{url:a,T:b,Xb:c,Ba:d,reason:e}}),function(f){!f&&12==Q.platform&&chrome.runtime.lastError&&(vn("family unblock send message error. Reloading page ..."+chrome.runtime.lastError.message),location.reload());if(f&&!f.error&&f.ok)alert("Your unblock request has been submitted to your parent. Your parent needs to make a decision. You can continue to visit other web pages for now."),document.getElementById("unblockform").style.display=
"none",document.getElementById("unblockformctl").style.display="block";else{f=new URL(window.location.href);f=new URLSearchParams(decodeURIComponent(f.search));var g=f.get("count");g?g++:g=1;f.set("count",g);3>g&&(f.set("reason",e),window.location.search=f.toString())}})};function so(){var a=this;if(12==Q.platform)try{chrome.runtime.onMessage.addListener(function(e,f,g){if("filter"==e.recipient&&"contentScriptLoaded"==e.type)return g({ok:!0}),!0})}catch(e){K.error("lag detection error: "+e),K.error(e.stack)}Ta.addListener(function(e){var f,g,h;return J(function(l){if(1==l.h){if(window!=window.top)return l.m(0);if("docBodyChanged"!=e.type)return"pageUrlTitleChanged"==e.type&&(location.hostname.endsWith(".youtube.com")||vn("title/url changed, forcing a re-check of url"),
to(a)),l.m(0);vn("doc body change detected: "+document.URL);return y(l,new Promise(function(m){setTimeout(m,1500)}),4)}for(f=0;f<window.frames.length;f++)g=window.frames[f],h={type:"dldRecheckUrl",w:window.innerWidth,Xs:window.innerHeight},g.postMessage(h,"*");A(l)})});var b=Jc();if(window==window.top)po.Ch.then(function(){to(a,b)});else{try{var c=new URL(b);if(["translate.google.com","translate.googleusercontent.com"].includes(c.hostname)){var d=c.searchParams.get("u");d&&to(this,d)}}catch(e){K.error("filter: "+
e+", "+document.URL)}window.addEventListener("message",function(e){e.data&&"dldRecheckUrl"==e.data.type&&.8<window.innerWidth*window.innerHeight/(e.data.w*e.data.Xs)&&to(a,b)})}setInterval(function(){to(a,b)},3E5)}
function to(a,b){var c,d,e,f,g;J(function(h){switch(h.h){case 1:c=b||document.URL;if(!c.startsWith("https://cc.bingj.com/cache.aspx?")){h.m(2);break}return y(h,new Promise(function(l){"loading"!=document.readyState?l():document.addEventListener("DOMContentLoaded",function(){l()})}),3);case 3:if(d=document.getElementsByClassName("banner"))if(e=d[0].getElementsByTagName("a"))c=e[0].href;case 2:return y(h,new Promise(function(l){Z({recipient:"filterBackend",type:"isBlockingNeeded",data:{url:c,ai:window==
window.top}},function(m){l(m)})}),4);case 4:if(f=h.j)f.redirectUrl&&Pn(f.redirectUrl),f.X&&f.yc&&(g={type:"webpageWhitelisted",data:{F:f.F,X:f.X,url:c}},Ta.sendMessage(g)),f.mi&&(K.warn("Filter backend asks to re-check after "+f.mi+"ms"),setTimeout(function(){to(a,document.URL)},f.mi));A(h)}})};function uo(a){this.B=a;Ta.addListener(function(b){"pageUrlTitleChanged"==b.type&&vo()},["pageUrlTitleChanged"]);setInterval(function(){vo()},6E4);vo();this.B.Du&&wo()}
function vo(){var a,b,c,d,e,f,g;J(function(h){switch(h.h){case 1:C(h,2);C(h,4);if(b=xo()){a={src:"url",hh:{ld:b}};h.m(6);break}c=new Promise(function(l,m){setTimeout(function(){m("timeout")},7E3)});d=yo();return y(h,Promise.race([d,c]),7);case 7:a=h.j;case 6:F(h,5,2);break;case 4:e=H(h,2),Wa("ytf dom: "+e),location.pathname.startsWith("/channel/")?(f=location.pathname.substr(9),a={src:"url",hh:{channelId:f}}):"/watch"==location.pathname&&(a={src:"url",hh:{ld:zo()}});case 5:a&&Ao(a);F(h,0);break;case 2:g=
H(h),Wa("ytf dom+api: "+g),A(h)}})}function xo(){try{if("www.google.com"==location.hostname&&location.hash)for(var a=t(location.hash.split("#")[1].split("&")),b=a.next();!b.done;b=a.next()){var c=b.value.split("=");if("vld"==c[0])for(var d=t(c[1].split(",")),e=d.next();!e.done;e=d.next()){var f=e.value.split(":");if("vid"==f[0])return K.log("Google video preview video ID:",f[1]),f[1]}}}catch(g){}}
function zo(){if("/watch"==location.pathname||location.pathname.startsWith("/embed/")){var a=new URL(document.URL);"/watch"==location.pathname?a=a.searchParams.get("v"):a.searchParams.get("videoId")?a=a.searchParams.get("videoId"):(a=location.pathname.substring(7))&&a.endsWith("/")&&(a=a.substring(0,a.length-1))}return a}
function Ao(a){var b,c,d,e,f,g;J(function(h){if(1==h.h){if(!a||!a.hh)return h.return();b=a.hh;c={type:"youtubeMetaData",data:{Qt:b}};Ta.sendMessage(c);return y(h,new Promise(function(l){Z(null,{recipient:"youtubeMetaProcess",type:"checkBlackWhiteList",data:{cu:a.cu,vv:b,url:location.href,source:a.src,title:b.title||document.title,pu:window.location!=window.parent.location?document.referrer:document.location.href}},function(m){l(m)})}),2)}d=h.j;d?d.error&&(e=d.error):e="Empty response from backend";
if(e)throw Error(e);d.data.yn==location.href&&("black"==d.type&&(d.data.ut&&"https://docs.google.com/"!=parentUrl?Pn("about:blank"):Pn(d.data.url)),d.data.qa&&(f={type:"youtubeDecision",data:d},Ta.sendMessage(f),"white"==d.type&&(g={type:"webpageWhitelisted",data:{F:d.data.F,X:d.data.X,url:d.data.yn}},Ta.sendMessage(g))));A(h)})}
function wo(){var a,b,c,d,e;J(function(f){if(1==f.h)return y(f,Jn(),3);if(a=document.getElementById("related"))a.style.display="none";b=document.getElementsByTagName("ytm-item-section-renderer");c=t(b);for(d=c.next();!d.done;d=c.next())if(e=d.value,"related-items"==e.getAttribute("section-identifier")){e.style.display="none";break}return y(f,new Promise(function(g){setTimeout(g,500)}),3)})}
function yo(){var a,b,c,d,e,f,g,h,l,m;return J(function(n){switch(n.h){case 1:return y(n,Jn(),2);case 2:if(location.pathname.startsWith("/channel/"))return a=location.pathname.substr(9),n.return({src:"dom",hh:{channelId:a}});if("/watch"!=location.pathname)return n.return();b={};c=5;case 3:if(!(0<c)){n.m(4);break}d=document.getElementsByTagName("script");e=t(d);for(f=e.next();!f.done;f=e.next())if(g=f.value,"application/ld+json"==g.getAttribute("type")){h=g.innerText&&g.innerText.trim();try{l=JSON.parse(h),
b.title||(b.title=l.name),b.no||(b.no=l.author),b.description||(b.description=l.description),b.T||(b.T=l.genre),b.Ik||(b.Ik=l.embedUrl),b.Jk||(b.Jk=l.thumbnailUrl)}catch(q){}}m=zo();b.ld=m;b.Ik&&-1!=b.Ik.indexOf(m)||b.Jk&&-1!=b.Jk.indexOf(m)?(delete b.Ik,delete b.Jk):b={};if(b.title){n.m(4);break}c--;return y(n,new Promise(function(q){setTimeout(q,1E3)}),3);case 4:return n.return({src:"dom",hh:b})}})};function Bo(a){var b=this;this.B=a;this.debug=this.B.debug;this.A=this.B.A;this.yj={};Jn().then(function(){function c(){b.J=Date.now();b.D&&Co()&&(b.debug&&tn("user interaction detected, leaving idle ..."),b.D=!1,Do(b))}"visible"==document.visibilityState&&Do(b);b.A&&tn(document.URL+" loaded");b.j=document.URL;b.h=document.title;document.addEventListener("visibilitychange",function(){"visible"==document.visibilityState?(b.A&&tn(document.URL+" became visible"),Do(b)):(b.A&&tn(document.URL+" became invisible"),
Eo()?b.A&&tn(document.URL+": video still playing, continue to time"):Fo(b,"invisible"))});Q.wa&&Q.Ic||window.addEventListener("beforeunload",function(){b.A&&tn(document.URL+" unloaded");Fo(b,"unloaded")});window.addEventListener("focus",function(){b.A&&tn(document.URL+" has focus");Do(b)});window.addEventListener("blur",function(){b.A&&tn(document.URL+" lost focus");Eo()?b.A&&tn(document.URL+": video still playing, continue to time"):Fo(b,"blurred")});for(var d=t("mousemove mousedown touchstart click scroll keypress".split(" ")),
e=d.next();!e.done;e=d.next())document.addEventListener(e.value,c)});this.J=this.o=Date.now();setInterval(function(){var c=Date.now();15E3<c-b.o?(b.debug&&tn("computer has waken up from sleep, "+document.URL),b.o>b.v&&(Fo(b,"sleep",{endTime:b.o}),Co()&&Do(b)),b.J=c):(b.l&&5E3<c-b.v&&(Fo(b,"forced report"),(Co()||Eo())&&Do(b)),72E4<c-b.J&&Co()&&!b.D&&(Eo()?b.debug&&tn("video playing, not entering idle, "+document.URL):(b.debug&&tn("computer has gone idle, "+document.URL),Fo(b,"idle"),b.D=!0)));!b.l||
Co()||Eo()||(b.debug&&tn("Not visible and no video playing, stop timing: "+document.URL),Fo(b,"video stopped in inactive tab"));!b.l&&Eo()&&(b.debug&&tn("video unexpectedly playing, start timing: "+document.URL),Do(b));b.o=c},5E3);Ta.addListener(function(c){"taResultAvailable"==c.type?(Go(b),c=c.data,c.url==b.j&&(b.Fb=c.dh.Ua,b.Zc=c.dh.oa,c.dh.debug&&(b.yj.Vd=c.dh.debug))):"imageBlurred"==c.type?(Go(b),c.data.Uf==document.URL&&(b.Be=!0)):"videoBlurred"==c.type?(Go(b),b.Ue=!0):"pageUrlTitleChanged"==
c.type?Go(b):"webpageWhitelisted"==c.type&&c.data.url==document.URL&&(b.F=c.data.F,b.X=c.data.X)});12==Q.platform&&chrome.runtime.onMessage.addListener(function(c,d,e){return b.onMessage(c,d,e)});this.j=document.URL;this.h=document.title}Bo.prototype.onMessage=function(a){"userActsFront"==a.recipient&&"ruleNameChange"==a.type&&(this.debug&&K.log("("+document.URL+") Rule name changed.",this.F,this.B.F,"->",a.data.F),this.F=a.data.F)};function Do(a){a.l||(a.v=Date.now(),a.l=!0)}
function Fo(a,b,c){c=void 0===c?{}:c;if(a.l){c||(c={});var d=Date.now(),e=c.endTime;e||(15E3<d-a.o?(a.debug&&tn("computer has waken up from sleep 2, "+document.URL),e=a.o):e=d);if(e>a.v){b={recipient:"userActs",type:"usageReport",data:{startTime:a.v,elapsedTime:e-a.v,url:c.url||a.j||document.URL,title:c.title||a.h||document.title,Fb:a.Fb,Zc:a.Zc,yj:a.yj,Be:a.Be,Ue:a.Ue,na:b,F:a.F?a.F:a.B.F}};a.X&&(b.data.X=a.X);a.v=void 0;a.l=!1;try{Z(b)}catch(f){"Error: Extension context invalidated."==f.toString()&&
(a.debug&&K.warn("Extension update detected. Reload page"),location.reload())}}}}function Go(a){if(a.j!=document.URL||a.h!=document.title)a.debug&&tn("page URL/title changed to: "+document.URL+", "+document.title),Fo(a,"urlChange",{url:a.j,title:a.h}),a.j=document.URL,a.h=document.title,a.Fb=void 0,a.Zc=void 0,a.Be=void 0,a.Ue=void 0,(Co()||Eo())&&Do(a)}function Co(){return"visible"==document.visibilityState&&document.hasFocus()}
function Eo(){for(var a=t(document.getElementsByTagName("video")),b=a.next();!b.done;b=a.next())if(!b.value.paused)return!0;return!1};function Ho(){this.j=!1;Q.Ic&&-1!=navigator.userAgent.indexOf("Firefox")&&(this.l=!0)}var Io;
function Jo(a){var b;if(a.l){var c=b=document.createElement("div");b.style.maxWidth="160px";b.style.maxHeight="100%";b.style.overflowY="scroll"}else b=document.createElement("iframe");b.style.position="fixed";b.style.top="10px";b.style.left="0px";b.style.zIndex="100000";b.style.paddingLeft="1px";b.style.backgroundColor="white";b.style.border="thin solid #FF0000";b.style.visibility="hidden";a.frame=b;document.body.appendChild(a.frame);if(a.l){var d=document.createElement("style");d.innerHTML='hr { margin: 2px } button { all: initial; font-family: "Arial, sans-serif"; font-size: small; color: black }';
c.appendChild(d)}else c=a.frame.contentDocument.body;a.body=c;d=document.createElement("input");d.type="button";d.value="X";d.style.fontSize="x-small";d.style.position="absolute";d.style.top="0px";d.style.right="0px";d.onclick=function(){b.style.visibility="hidden"};c.appendChild(d);d=a.h=document.createElement("div");d.style.fontFamily="Arial,sans-serif";d.style.fontSize="small";d.style.color="black";c.appendChild(a.h);a.j=!0}
function Ko(a){if(!a.l){var b=a.frame;b.height=a.frame.width=1;b.width=Math.min(a.body.scrollWidth,window.innerWidth);b.height=Math.min(a.body.scrollHeight,window.innerHeight)}}Ho.prototype.show=function(){this.j||Jo(this);this.frame.style.visibility="visible"};Ho.prototype.hide=function(){this.j&&(this.frame.style.visibility="hidden")};function Lo(a){a.show();a.h.hasChildNodes()&&a.h.appendChild(document.createElement("hr"));var b=document.createElement("div");a.h.appendChild(b);return b}
function Mo(){if(window.self===window.top)return Io||(Io=new Ho),Io}
function No(){function a(){this.Jf=document.createElement("div");this.Jf.style.position="relative";var b=this.Bf=document.createElement("img");b.setAttribute("dld-debug","true");this.Jf.appendChild(b);b=this.h=document.createElement("div");b.style.position="absolute";b.style.top="50%";b.style.left="50%";b.style.transform="translate(-50%, -50%)";b.style.color="blue";b.style.textShadow="1px 1px 1px black,-1px -1px 1px white";b.onclick=function(c){c.target.style.backgroundColor="white"==c.target.style.backgroundColor?
"":"white"};this.Jf.appendChild(b)}a.prototype.yk=function(b){this.h.innerHTML=b};a.prototype.gn=function(b){this.h.style.color=b};return new a}
function Oo(a,b){var c;J(function(d){if(1==d.h)return"string"==typeof b&&b.startsWith("data:")?d.m(2):y(d,new Promise(function(e){var f=new Blob([b]),g=new FileReader;g.addEventListener("load",function(){e(g.result)});g.readAsDataURL(f)}),3);2!=d.h&&(b=d.j);c=document.createElement("a");c.setAttribute("href",b);c.setAttribute("download",a);c.style.display="none";document.body.appendChild(c);c.click();document.body.removeChild(c);A(d)})};function Po(a){this.h=a||document}var Qo;
function Ro(){var a=location;if(["google.com","www.google.com","www.google.com.hk","www.google.co.jp","www.google.fr"].includes(location.hostname)&&"/search"==location.pathname)return new So;if(!a.hostname.endsWith("search.yahoo.com")&&!a.hostname.endsWith("search.yahoo.co.jp")||"/search"!=a.pathname&&"/web"!=a.pathname&&"/search/"!=a.pathname&&"/image/search"!=a.pathname&&"/video/search"!=a.pathname&&"/realtime/search"!=a.pathname&&!a.pathname.startsWith("/search;")){if("www.bing.com"===a.hostname&&
"/search"===a.pathname)return new To;if("www.dogpile.com"===a.hostname&&"/serp"===a.pathname)return new Uo;if("www.youtube.com"===a.hostname&&"/results"===a.pathname)return new Vo}else return new Wo}k=Po.prototype;k.xf=function(){throw Error("getEngineName() not implemented");};k.He=function(){throw Error("parseResults() not implemented on base abstract class");};k.$d=function(){throw Error("getSearchTerms() not implemented on base abstract class");};
k.Gg=function(){return J(function(){throw Error("getAddtlResults() not implemented on base abstract class");})};
k.filter=function(a){var b=this,c,d,e,f,g,h;return J(function(l){switch(l.h){case 1:C(l,2);c=0<Sn(a,Qo).length;d=b.He();if(!c){l.m(4);break}C(l,5);return y(l,b.Gg(),7);case 7:(e=l.j)&&(d=d.concat(e));F(l,4,2);break;case 5:f=H(l,2),Wa("Addt'l search results: "+f);case 4:return g={recipient:"dsf",type:"ar",data:{results:d,qg:a,kc:b.$d()}},y(l,new Promise(function(m){Z(null,g,function(n){m(n)})}),8);case 8:return h=l.j,l.return(h);case 2:return H(l),l.return({})}})};
function Wo(a){this.h=a||document}x(Wo,Po);Wo.prototype.xf=function(){return"yahoo"};Wo.prototype.He=function(){return[]};Wo.prototype.$d=function(){try{var a=new URL(this.h.URL),b=a.searchParams.get("p");b||(b=a.searchParams.get("va"));return b}catch(c){}};Wo.prototype.Gg=function(){return J(function(a){return a.return(Promise.resolve([]))})};function Uo(a){this.h=a||document}x(Uo,Po);Uo.prototype.xf=function(){return"dogpile"};Uo.prototype.He=function(){return[]};Uo.prototype.$d=function(){try{return(new URL(this.h.URL)).searchParams.get("q")}catch(a){}};
Uo.prototype.Gg=function(){return J(function(a){return a.return(Promise.resolve([]))})};function To(a){this.h=a||document}x(To,Po);To.prototype.xf=function(){return"bing"};To.prototype.He=function(){return[]};To.prototype.$d=function(){try{return(new URL(this.h.URL)).searchParams.get("q")}catch(a){}};To.prototype.Gg=function(){return J(function(a){return a.return(Promise.resolve([]))})};function Vo(a){this.h=a||document}x(Vo,Po);Vo.prototype.xf=function(){return"youtube"};Vo.prototype.He=function(){return[]};
Vo.prototype.$d=function(){try{return(new URL(this.h.URL)).searchParams.get("search_query")}catch(a){}};Vo.prototype.Gg=function(){return J(function(a){return a.return(Promise.resolve([]))})};function So(a){this.h=a||document}x(So,Po);So.prototype.xf=function(){return"google"};
So.prototype.He=function(){for(var a=[],b=[],c=t(this.h.getElementsByTagName("h3")),d=c.next();!d.done;d=c.next())for(d=d.value.parentElement;d;d=d.parentElement)if("DIV"==d.tagName&&d.classList.contains("g")){b.push(d);break}b=t(b);for(c=b.next();!c.done;c=b.next()){var e=c.value;if("DIV"==e.tagName&&(this.debug&&(e.style.border="solid thick #FF0000"),c={},d=e.getElementsByTagName("A"),!(0>=d.length))){d=d[0];c.url=(new URL(d.getAttribute("href"),location.href)).href;d=d.getBoundingClientRect();
var f=e.getElementsByTagName("H3");if(0<f.length&&(f=f[0],c.title=f.innerText.trim()||c.url.substring(0,80),"images"==c.title.toLowerCase()))continue;e=t(e.getElementsByTagName("DIV"));for(f=e.next();!f.done;f=e.next())if(f=f.value,!(f.getBoundingClientRect().y<=d.y+d.height)){c.summary=f.innerHTML;c.ln=f.innerText;break}c.ln&&a.push(c)}}return a};So.prototype.$d=function(){try{return(new URL(this.h.URL)).searchParams.get("q")}catch(a){}};
So.prototype.Gg=function(){var a=this;return J(function(b){return b.return(new Promise(function(c,d){var e=a.h.createElement("iframe");e.style.position="fixed";e.style.top="10px";e.style.left="10px";e.style.width="400px";e.style.height="300px";e.style.visibility="hidden";e.style.zIndex=-1E4;e.addEventListener("load",function(){var f=(new So(e.contentDocument)).He();a.h.body.removeChild(e);c(f)});e.addEventListener("error",function(f){a.h.body.removeChild(e);d(f.message)});e.src="https://www.google.com/search?q="+
a.$d()+"&start=10";a.h.body.appendChild(e)}))})};function Xo(){var a=this;this.kc=(new URL(document.URL)).searchParams.get("q");document.title+=" - "+this.kc;Jn().then(function(){a.fill()})}
Xo.prototype.fill=function(){var a=this,b,c,d,e,f,g,h,l,m,n,q;return J(function(u){if(1==u.h){b=document.getElementsByClassName("terms");c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,e.innerHTML=decodeURIComponent(a.kc);f={recipient:"dsf",type:"gr",data:{kc:a.kc}};return y(u,new Promise(function(r){Z(null,f,function(p){r(p)})}),2)}if((g=u.j)&&g.results)for(h=document.getElementById("results"),h.innerHTML="",l=t(g.results),m=l.next();!m.done;m=l.next())n=m.value,q='<div class="result">',q+='<div class="titleblock"><a href="'+
n.url+'"><span class="stitle">'+n.title+"</span></a></div>",q+='<div class="summary">'+n.summary+"</div>",q+="</div>\n",h.innerHTML+=q;A(u)})};function Yo(a){var b=this;this.B=a;this.debug=a.debug;this.A=!1;this.qb=new Zo(this.debug);this.nc=this.S=0;this.Bc=this.J=2E3;this.ga=Promise.resolve();this.o="";var c=Jn();c.then(function(){b.debug&&window==window.top&&$o(b)});a.enabled&&(ap(this,a.kh),a=new Promise(function(d){return J(function(e){if(1==e.h)return y(e,new Promise(function(f){setTimeout(f,1E3)}),3);if(4!=e.h)return 200>window.innerWidth||200>window.innerHeight?y(e,new Promise(function(f){setTimeout(f,1E3)}),3):e.m(4);d();A(e)})}),
Promise.all([c,a]).then(function(){try{if("undefined"!==typeof Po){var d=Ro();if(d){var e=d.$d();e=decodeURIComponent(e.replace("+"," "));var f=d.xf();if(window.top==window){var g=d.He();g&&0<g.length&&Z(null,{recipient:"dsf",type:"usr",data:{kc:e,L:f,results:g}})}}}}catch(h){K.error("SearchFilter init error.",h)}b.debug&&K.log((window==window.top?"top: ":"iframe: ")+"dynTA activiated");bp(b);cp(b);In(Mn);Mn.addEventListener(function(h){dp(b,h)})},function(){}),Ta.addListener(function(d){"pageUrlTitleChanged"==
d.type&&(b.debug&&K.log("[DTA] Triggering page url/title changed text analysis."+(b.l?" Reset violation reported flag.":"")),b.J=b.Bc,b.l=!1,bp(b),cp(b))},["pageUrlTitleChanged"]),12==Q.platform&&chrome.runtime.onMessage.addListener(function(d,e,f){return b.onMessage(d,e,f)}))}var ep;Yo.prototype.onMessage=function(a,b,c){"DynTA"==a.recipient&&"getActivePage"==a.type&&window===window.top&&(a=fp(this))&&c(a)};function fp(a){return a.Rb?{url:document.URL,title:document.title,content:a.Rb}:null}
function ap(a,b){try{if(a.v=[],b)for(var c=t(b),d=c.next();!d.done;d=c.next()){var e=d.value;e&&(e.startsWith('"')&&e.endsWith('"')&&(e=e.substring(1,e.length-1)),e&&3<=e.length&&(e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),a.v.push(new RegExp("\\b"+e+"\\b","is"))))}}catch(f){K.error("[DTA] Parse foul word list error.",f)}}function bp(a){a.B.iq||a.v&&0!=a.v.length&&gp(a,document.body)}
function gp(a,b){if(3==b.nodeType){if(a.v){a=t(a.v);for(var c=a.next();!c.done;c=a.next()){var d=b.textContent.match(c.value);if(d){c=b;var e=d.index;d=d[0];var f=c.parentNode,g=document.createElement("span");g.innerText=c.textContent.substring(e,e+d.length);g.innerText="".padEnd(g.innerText.length,"x");g.style.backgroundColor="black";g.style.color="black";g.setAttribute("dldProcessed","true");var h=c.cloneNode();h.textContent=h.textContent.substring(e+d.length);c.textContent=c.textContent.substring(0,
e);f.insertBefore(h,c.nextSibling);f.insertBefore(g,h)}}}}else if(1==b.nodeType&&"true"!=b.getAttribute("dldProcessed")&&!["SCRIPT","STYLE","NOSCRIPT"].includes(b.tagName.toUpperCase()))for(b=t(b.childNodes),c=b.next();!c.done;c=b.next())gp(a,c.value)}
function cp(a){var b,c,d,e,f,g,h,l,m,n,q;J(function(u){switch(u.h){case 1:c=(b=document.URL.toLowerCase().startsWith("https://docs.google.com/document/d/"))?6E4:15E3;a.ga=new Promise(function(r){setTimeout(r,a.J);a.J=Math.min(2*a.J,c)});if(!b){d=hp(a.qb);e=ip(a.qb);0<d.length?a.ud(d,e):(a.D=d,a.debug&&(K.log("The content is too short. Bypass classification."),window==window.top&&(a.j.label.innerHTML="Too short. Skip.")));u.m(0);break}C(u,3);f=document.URL.split("/");g=f[5];if(!g){a.debug&&K.warn("Cannot get google doc document ID.");
u.m(5);break}h={recipient:"dynTextAnalysis",type:"getOnlineDoc",data:{type:"google doc",Vl:g}};return y(u,new Promise(function(r){Z(null,h,null,function(p){r(p)})}),6);case 6:(l=u.j)&&l.content?(a.A&&K.log("Get google doc content. userIsOwner=",l.Wf,". content=",l.content),m=l.content.trim().split(/\s+/,80).length,80>m?("undefined"!==typeof jp&&kp&&!a.B.du&&(n={body:l.content.substring(0,1E3)},a.nc++,lp(l.content,{na:"googledoc",ro:!0,Wf:l.Wf,context:n,wb:a.nc})),100<l.content.length?a.ud(l.content):
(a.D=l.content,a.debug&&(K.log("The content is too short. Bypass classification."),window==window.top&&(a.j.label.innerHTML="Too short. Skip.")))):(a.D=l.content,a.debug&&(K.warn("The content is too long. Bypass classification."),window==window.top&&(a.j.label.innerHTML="Too long. Skip.")))):a.debug&&K.warn("Error getting google doc content.",g,l);case 5:F(u,0);break;case 3:q=H(u),a.debug&&K.warn("Exception getting google doc content.",q),A(u)}})}
function dp(a,b){if(b.text&&0!=b.text.length){a.A&&K.log("Text change:",b.text);if(document.URL.toLowerCase().startsWith("https://docs.google.com/document/d/")){if(b.text.trimStart().startsWith("Saved"))var c=a.ga}else if(a.o+=b.text,a.A&&K.log("this.accumulatedChanges.length=",a.o.length,"this.lastFullTextLength=",a.aa),900<a.o.length||a.aa&&.2<a.o.length/a.aa)c=a.ga;c&&(a.A&&K.log("Accumulated text changes: "+a.o),a.ya||(a.ya=!0,c.then(function(){a.ya=!1;a.debug&&K.log("triggering changed text analysis");
a.o="";bp(a);cp(a)})))}}
function $o(a){if(!a.j){a.j={};a.j.Sb=Lo(Mo());var b=document.createElement("div");a.j.label=b;b.innerHTML=a.B.enabled?"Document loading":"TA disabled";a.j.Sb.appendChild(b);b=document.createElement("button");b.innerHTML="Get text";b.onclick=function(){var c=document.createElement("a");c.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a.D));c.setAttribute("download","pageText.txt");c.style.display="none";document.body.appendChild(c);c.click();document.body.removeChild(c)};a.j.Sb.appendChild(b);
b=document.createElement("button");b.innerHTML="Analyze";b.onclick=function(){cp(a)};a.j.Sb.appendChild(b);Ko(Mo())}}function mp(a,b,c){for(var d=t(["romeo","juliet","Hamlet","Othello","Shakespeare"]),e=d.next();!e.done;e=d.next())if(e=e.value,-1!=b.indexOf(e)&&Array.isArray(c)&&c.includes(120))return a.debug&&K.log('Text contains keyword "'+e+'". Filter out self-harm cat.',c),c.filter(function(f){return 120!=f});return c}
Yo.prototype.ud=function(a,b){var c=this,d,e,f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:return c.S++,c.aa=a.length,y(r,np(c,a,{wb:c.S,cq:b}),2);case 2:d=r.j;if(!d||!d.hg)return r.return();d.B&&(c.B=d.B,ap(c,c.B.kh));d.hg.Ua=mp(c,a,d.hg.Ua);e=d.hg;e.error?(c.hg=void 0,c.D=void 0):(c.hg=e,c.D=e.text,"en"!=e.lang&&(e.ji=a),f={type:"taResultAvailable",data:{url:document.URL,dh:e}},Ta.sendMessage(f));c.debug&&(g="#"+c.S+": ",g+=e.error?e.error:e.label+"("+e.lang+")["+(e.tj?"Cloud":e.ni?"Regex":
"")+"] "+e.time+"ms, "+(void 0!=e.V?e.V.toFixed(2):"-")+", "+(e.text&&e.text.length)+"b",window==window.top?(c.j.label.innerHTML=g,Ko(Mo())):K.log("iframe: "+g));if(!e.oa){r.m(0);break}h=Sn(c.B.da,e.Ua);if(0==h.length){r.m(0);break}if(c.l){c.debug&&K.log("TA violation already reported, skipped");r.m(0);break}c.l=!0;C(r,6);if(window!=window.top||!c.B.fq){r.m(8);break}m=Ro();if(!m){r.m(8);break}return y(r,m.filter(h),10);case 10:n=r.j,n.redirectUrl&&(l=n.redirectUrl);case 8:F(r,7);break;case 6:q=H(r),
K.error("dynsf: "+q);case 7:u={L:"dynta",dh:e,F:c.B.F},l&&(u.es=!0,u.redirectUrl=l),u.W=[{name:"text",Da:document.URL,value:e.text||a}],delete e.text,delete e.ji,Hn(Mn,h,u,d.Dk),A(r)}})};function op(a,b){a.debug&&K.log("[DAB] processABResult. Result=",b);if(b&&"black"==b.label){var c={4:120,3:115,7:101,8:107,2:105,6:115};b.yb&&(b=b.yb.map(function(d){return c[d.id]}),b=Sn(a.B.da,b),0!=b.length&&(a.l?a.debug&&K.log("Bad contents already reported. Skip."):(a.l=!0,Hn(Mn,b,{L:"dynab",F:a.B.F}))))}}
function pp(a,b,c){b&&(a.h||(a.h={}),a.h[b]||(a.h[b]=Date.now(),setTimeout(function(){"undefined"!==typeof jp&&kp&&lp(b,{na:c+"Search",wb:1,context:{search:b}}).then(function(d){op(a,d)})},500)))}
function np(a,b,c){var d,e,f,g;return J(function(h){12288<=b.length&&(b=qp(b));d={recipient:"dynTextAnalysis",type:"classify",data:{text:b,ai:window==window.top,url:document.URL,Ba:document.title,options:c||{}}};d.data.Ba&&d.data.Ba.trim()||(d.data.Ba=location.hostname);window==window.top&&(a.Rb=b,e=Ro())&&(f=e.$d(),f=decodeURIComponent(f.replace("+"," ")),d.data.options.context={search:f},g=e.xf(),pp(a,f,g));return a.B.iq?h.return(Promise.resolve(null)):h.return(new Promise(function(l){Z(null,d,
null,function(m){l(m)})}))})}function En(a){this.debug=a}En.prototype.h=function(){for(var a="",b=t(document.getElementsByTagName("meta")),c=b.next();!c.done;c=b.next())if(c=c.value,"description"==c.getAttribute("name")||"keywords"==c.getAttribute("name"))a+=c.getAttribute("content")+" ";return a};function ip(a){var b=rp(a,document.head),c=rp(a,document.body);b+=c;a.debug&&K.log("[DTA] Extract script.",b);return b}
function hp(a){var b=a.jg(document.body);b=b.replace(/[\n\t ]+/g," ");b=qp(b);b=a.h()+" "+b;a.debug&&K.log("[DTA] Extract text.",b);return b}function rp(a,b){if(1==b.nodeType){if("SCRIPT"==b.tagName){var c=b.getAttribute("src");if(c)return c+"\n"}b=b.childNodes;c="";for(var d=0;d<b.length;d++)c+=rp(a,b[d]);return c}return""}
En.prototype.jg=function(a){if(3==a.nodeType)return a.textContent;if(8!=a.nodeType){if(1==a.nodeType){if(["SCRIPT","STYLE","NOSCRIPT"].includes(a.tagName.toUpperCase())||location.hostname.endsWith(".youtube.com")&&a.hasAttribute("hidden"))return"";var b=a.childNodes,c="";"IMG"==a.tagName?c=(c=a.getAttribute("alt"))?c+" ":"":"INPUT"==a.tagName&&(c=(c=a.getAttribute("placeholder"))?c+" ":"");for(a=0;a<b.length;a++)c+=this.jg(b[a])+" ";return c}2==a.nodeType&&K.warn("ATTR node: "+a)}return""};
function qp(a){if(5E3<a.length){var b=a.length;a=a.substring(0,Math.round(.9*b));a=a.substring(Math.round(.1*b));b=a.lastIndexOf(" ");var c=a.substr(b);2>Math.round((new Blob([c])).size/c.length)&&(a=a.substring(0,b));b=a.indexOf(" ");c=a.substr(0,b);2>Math.round((new Blob([c])).size/c.length)&&(a=a.substring(b+1))}if(12288<=a.length){this.debug&&K.log("Text too long ("+a.length+"b), truncating ...");b=a.substr(0,5120);a=a.substr(-5120);c=b.lastIndexOf(" ");var d=b.substr(c);2>Math.round((new Blob([d])).size/
d.length)&&(b=b.substring(0,c));c=a.indexOf(" ");d=a.substr(0,c);2>Math.round((new Blob([d])).size/d.length)&&(a=a.substring(c+1));a=b+" "+a}return a}function Zo(){En.apply(this,arguments)}x(Zo,En);
Zo.prototype.jg=function(a){return location.hostname.endsWith(".youtube.com")&&("contentContainer"==a.id||"player"==a.id||"player-control-container"==a.id||a.classList&&a.classList.contains("slim-video-metadata-actions")||"masthead"==a.id||"metadata-line"==a.id||"overlays"==a.id||a.tagName&&"ytm-badge-and-byline-renderer"==a.tagName.toLowerCase()||"owner-sub-count"==a.id||a.tagName&&"ytm-slim-owner-renderer"==a.tagName.toLowerCase()||a.tagName&&"ytm-badge-and-byline-renderer"==a.tagName.toLowerCase()||
"player-ads"==a.id||3==a.nodeType&&["show more","transcript","verified","subscribe"].includes(a.textContent&&a.textContent.toLowerCase().trim()||""))?"":En.prototype.jg.call(this,a)};Zo.prototype.h=function(){return location.hostname.endsWith(".youtube.com")?"":En.prototype.h.call(this)};function sp(a){var b=this;this.B=a;this.debug=a.debug;this.frameId=a.frameId||(window.top==window?0:-1);this.dd=a.dd;if(a.Rd)for(var c=t(a.Rd),d=c.next();!d.done;d=c.next()){d=d.value;if(a.jn.includes(d)){a.enabled=!1;a.debug&&K.warn("dynia disabled because of cc match");break}var e=a.ug[d];e&&(a.debug&&K.warn("image sensitivity overriden to "+e+" based on cc cat "+d),this.sensitivity=e)}this.ue=this.qb={St:3,Tt:.33,Rt:.25};this.J={};this.Sm=this.S=this.Fk=0;this.pc={images:[],ed:{},T:void 0};this.dk=
0;this.debug&&this.dd.inputs&&!this.dd.inputs.Ja&&(this.dd.inputs.Ja={format:"jpg",width:160,height:120});c=this.ga=Jn();c.then(function(){b.debug&&(b.h=new tp(b))});if(this.B.enabled){d=new Promise(function(g){setTimeout(g,1500)});this.Uj="youtube.com"==location.hostname||location.hostname.endsWith(".youtube.com");Ta.addListener(function(g){"taResultAvailable"!=g.type&&"pageUrlTitleChanged"==g.type&&(b.debug&&K.log("[DIA] Page url/title changed."+(b.l?" Reset violation reported flag.":"")),b.l=!1)},
["taResultAvailable","pageUrlTitleChanged"]);var f=function(g){this.ra=g};f.prototype.o=function(){var g=this;this.h=Date.now();this.l||(this.l=!0,setTimeout(function(){g.j()},100))};f.prototype.j=function(){var g=this;this.debug&&K.log("[DIA] Frame "+this.frameId+": dynIA activated on scrolling.");var h=Date.now();100>h-this.h?setTimeout(function(){g.j()},this.h+100-h):(this.l=!1,up(this.ra,"scroll stop."))};Promise.all([c,d]).then(function(){var g=new f(b);window.addEventListener("scroll",function(){g.o()},
!0)});this.o=this.v=this.D=0;c.then(function(){Mn.addEventListener(function(g){b.D+=g.text.length;var h=0,l=0;g=t(g.images);for(var m=g.next();!m.done;m=g.next())m=m.value,l+=vp(m).visible,m=m.getBoundingClientRect(),m.width&&m.height&&41<=m.width&&41<=m.height&&h++;b.o+=l;b.v+=h;h=window.innerWidth;l=window.innerHeight;if(900<=b.D||0<b.v||.2<b.o/h/l)b.debug&&K.log("[DIA] Frame "+b.frameId+": dynIA activate on content change, accText: "+b.D+", accImages: "+b.v+", accAreaRatio: "+(b.o/h/l).toFixed(2)),
b.D=0,b.v=0,b.o=0,b.S=0,up(b,"accumulated content change.")});wp(b,document.images)});wp(this,document.images);Promise.all([c,d]).then(function(){xp(b,"page loaded and delay")});(new MutationObserver(function(g){yp(b,g)})).observe(document,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]});a.enabled&&(zp(this),this.debug&&K.log("[DIA] enabled, "+document.URL+", blockYoutubePreview: ",this.B.sg))}else K.log("[DIA] DynIA disabled.")}
function zp(a){if(Array.isArray(a.Nc))for(var b=t(a.Nc),c=b.next();!c.done;c=b.next())c.value.style.filter="blur(30px)";setTimeout(function(){zp(a)},1E3)}
function yp(a,b){try{for(var c=[],d=t(b),e=d.next();!e.done;e=d.next()){var f=e.value;b=function(p){var v=p.parentElement&&p.parentElement.parentElement&&p.parentElement.parentElement.id;this.B.sg&&this.Uj&&("mouseover-overlay"===v&&"thumbnail"===p.id||"thumbnail"===v)?(Array.isArray(this.Nc)||(this.Nc=[]),this.Nc.push(p)):c.push(p)};if("childList"==f.type)for(var g=t(f.addedNodes),h=g.next();!h.done;h=g.next()){var l=h.value;if(1==l.nodeType)for(var m=t(["IMG"]),n=m.next();!n.done;n=m.next()){var q=
n.value;l.tagName==q&&b.apply(a,[l]);for(var u=t(l.getElementsByTagName(q)),r=u.next();!r.done;r=u.next())b.apply(a,[r.value])}}else"attributes"==f.type&&"src"==f.attributeName&&"IMG"==f.target.tagName&&b.apply(a,[f.target])}0<c.length&&wp(a,c)&&up(a,"content blurred.")}catch(p){K.error("[DIA] mutationObserver error.",p)}}function up(a,b){a.aa||(a.aa=setTimeout(function(){delete a.aa;xp(a,b)},500))}
function xp(a,b){a.debug&&K.warn("[DIA] analyzeVisibleImages.",b);b=Ap(a,0);if(a.B.uu){var c=Ap(a,0,{x:0,y:window.innerHeight});a.debug&&c.length&&K.log("[DIA] Frame "+a.frameId+": "+c.length+" look-ahead images need analysis.");b=b.concat(c)}Bp(a,b)}function Bp(a,b){var c;J(function(d){if(!a.B.enabled)return d.return();for(;3<b.length;)c=b.splice(0,3),Cp(a,c);0<b.length&&Cp(a,b);A(d)})}
function Cp(a,b){var c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R;J(function(N){switch(N.h){case 1:c=[];d={};e=t(b);for(f=e.next();!f.done;d={Ji:d.Ji},f=e.next())g=f.value,d.Ji=g.Jb,a.J[g.url]&&"true"==d.Ji.getAttribute("dldAnalyzed")||(c.push(g),d.Ji.setAttribute("dldAnalyzed","true"),a.J[g.url]=!0);a.Fk+=c.length;a.S+=c.length;a.Sm+=c.length;h=[];if(!(0<c.length)){N.m(2);break}return y(N,Dp(a,c.map(function(Y){return Y.Jb})),3);case 3:l=N.j;if(!l||l.error){N.m(2);break}m=[];n=l;if(!n.images){N.m(5);
break}q=0;case 6:if(!(q<n.images.length)){N.m(5);break}u=n.images[q];if(!(u.T&&u.oa||Ep(a,u))){N.m(7);break}C(N,10);r={Ja:{format:"jpg",width:640,height:480}};p=void 0;if(!u.Fc){p=c[q].Jb;N.m(12);break}return y(N,zn(u.Fc),13);case 13:p=N.j;case 12:return y(N,Fp(a,p,r),14);case 14:v=N.j;u.Fc=v.Ja;F(N,11);break;case 10:w=H(N),a.debug&&K.warn("Image resizing for upload failed: "+w),delete u.Fc;case 11:u.Jb=c[q].Jb,m.push(u);case 7:q++;N.m(6);break;case 5:if(a.dk+=l.dk,0<m.length)for(z=t(m),f=z.next();!f.done;f=
z.next())if(B=f.value,Ep(a,B)||a.B.tb)a.pc.T&&105!=B.T||(a.pc.T=B.T),a.pc.ed[B.L]=1,a.pc.images.push(B),h.push(B);case 2:a.debug&&Gp(a.h);if(Hp(a,h))if(a.B.tb)a.ya||(a.ya=!0,alert("This page will be blocked by dynIA"));else if(a.l)a.debug&&K.log("[DIA] Violation already reported. Skip.");else{a.l=!0;D=[];if(a.B.dv)for(E=t(a.pc.images),f=E.next();!f.done;f=E.next())G=f.value,D.push(Object.assign({},G));M={L:"dynia",F:a.B.F,ht:D,W:[]};5<D.length&&D.splice(5,D.length-5);for(T=0;T<D.length;T++)O=D[T],
O.url.startsWith("data:")&&(O.url="dataURL"),delete O.Jb,R={name:"image"+T,Da:O.url,value:O.Fc},M.W.push(R),delete O.Fc;Hn(Mn,[a.pc.T],M)}A(N)}})}function wp(a,b){var c=0,d=0;if(a.B.po&&b){b=t(b);for(var e=b.next();!e.done;e=b.next())e=e.value,a.J[e.src||e.currentSrc]&&"true"==e.getAttribute("dldAnalyzed")?d++:(c++,Ip(e))}return 0<c}function Ip(a){a.style.filter="blur(30px)"}function Ep(a,b){return b.T&&a.B.da.includes(b.T)||"immodest"==b.label}
function Hp(a,b){var c=!1;if(a.pc.images.length>=a.ue.St){for(var d=window.innerWidth,e=window.innerHeight,f=0,g=0,h=t(a.pc.images),l=h.next();!l.done;l=h.next()){var m=l.value;if(m.T){g++;l=0;m=m.Jb.getBoundingClientRect();m={x:window.scrollX,y:m.y};for(var n=t(a.pc.images),q=n.next();!q.done;q=n.next())q=q.value,q.T&&(l+=vp(q.Jb,m).visible);l>f&&(f=l)}}f/(d*e)>=a.ue.Rt?c=!0:g/a.Fk>=a.ue.Tt&&(c=!0)}if(a.B.tb)for(b=t(a.pc.images),l=b.next();!l.done;l=b.next())l.value.Jb.style.border="solid thick #FF0000";
else{d=t(a.pc.images);for(l=d.next();!l.done;l=d.next())e=l.value,Ip(e.Jb),e.Jb.style.pointerEvents="none";0<a.pc.images.length&&Ta.sendMessage({type:"imageBlurred",data:{Uf:window==window.top?document.URL:document.referrer}});if(b&&0<b.length){d=[];e=[];if(a.B.av)for(a=0;a<b.length;a++)f=b[a],g={url:f.Jb.src||f.Jb.currentSrc,T:f.T},g.url.startsWith("data:")&&(g.url="dataURL"),d.push(g),e.push({name:"image-"+a,value:f.Fc});Rn("imageBlurred",{Af:{images:d},W:e})}}return c}
function Jp(a){var b=Array.from(document.images);try{for(var c=t(document.getElementsByTagName("*")),d=c.next();!d.done;d=c.next()){var e=d.value;if(e.shadowRoot){var f=e.shadowRoot.querySelectorAll("img");a.debug&&K.log("[DIA] Adding "+f.length+" images in shadow for analysis");b=b.concat(Array.from(f))}}}catch(g){K.error("Error finding images in shadow DOM.",g)}return b}
function Ap(a,b,c){var d=[],e=Jp(a);e=t(e);for(var f=e.next();!f.done;f=e.next())if(f=f.value,!a.debug||"true"!=f.getAttribute("dld-debug")){var g=f.src||f.currentSrc,h=vp(f,c);1681>h.total?f.style.filter="":a.J[g]&&"true"==f.getAttribute("dldAnalyzed")||0<h.visible&&d.push({Jb:f,url:g,tk:h.total})}d=d.sort(function(l,m){return m.tk-l.tk});0<b&&(d=d.slice(0,b));return d}
function vp(a,b){var c=a.getBoundingClientRect(),d=c.x,e=c.y,f=c.top,g=c.bottom,h=c.left,l=c.right;a=c.width;c=c.height;var m=window.innerWidth,n=window.innerHeight;b&&(f=e-b.y,g=f+c,h=d-b.x,l=h+a);b=c-Math.max(-f,0)-Math.max(g-n,0);b=Math.max(b,0);h=a-Math.max(-h,0)-Math.max(l-m,0);h=Math.max(h,0);return{total:c*a,visible:b*h,height:c,width:a,$y:b,az:h}}
function Kp(a){var b;return J(function(c){if(1==c.h)return Q.features.ra.xc?a.j?c.m(3):y(c,Nn(),4):c.return(a.dd.inputs);if(3!=c.h)if(b=c.j,b.inputs)a.j={},a.dd.inputs&&Object.assign(a.j,a.dd.inputs),Object.assign(a.j,b.inputs);else return c.return(a.dd.inputs);return c.return(a.j)})}
function Fp(a,b,c){var d,e,f,g,h,l,m,n,q,u,r;return J(function(p){switch(p.h){case 1:C(p,2);if(c){p.m(4);break}return y(p,Kp(a),5);case 5:c=p.j;case 4:if(b.complete){p.m(6);break}return y(p,new Promise(function(v){b.addEventListener("load",v)}),6);case 6:if(d=yn(b,c))return p.return(d);e=b.src||b.currentSrc;if(Q.wa){p.m(8);break}return y(p,new Promise(function(v){Z(null,{recipient:"dynImgAnalysis",type:"canFetchImage",data:{url:e}},null,function(w){v(w)})}),9);case 9:if(f=p.j,!f)return p.return(null);
case 8:return C(p,10),y(p,fetch(e,{mode:"cors"}),12);case 12:return h=p.j,y(p,h.blob(),13);case 13:g=p.j;F(p,11,2);break;case 10:return l=H(p,2),y(p,new Promise(function(v,w){Z(null,{recipient:"dynImgAnalysis",type:"getImageContent",data:{url:e,width:640,height:480}},null,function(z){z.error?w("/GetImageContent: "+l):v(z.Fc)})}),14);case 14:return(m=p.j)?y(p,fetch(m),15):p.return(null);case 15:return n=p.j,y(p,n.blob(),16);case 16:g=p.j;case 11:return q=URL.createObjectURL(g),u=document.createElement("IMG"),
y(p,new Promise(function(v,w){u.onload=function(){v()};u.onerror=function(){w("Cannot create image element, most likely CSP img-src issue")};u.src=q}),17);case 17:return p.return(yn(u,c));case 2:return r=H(p),K.error("genEngineInput: "+r+"\n"+r.stack),p.return(null)}})}
function Dp(a,b){var c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R,N,Y,W,X,L,I,P,ha,ma,aa,V,na,za,xa,Sa,oc,im,Ih,Jh,be,$c,Da,ad,jm;return J(function(La){switch(La.h){case 1:c=a.B.po;d=[];if(c)for(e=0;e<b.length;e++)Ip(b[e]),d.push(e);f=[];g=[];for(h={bg:0};h.bg<b.length;h={rh:h.rh,bg:h.bg},h.bg++)h.rh=b[h.bg],l=Fp(a,h.rh).then(function(Ea){return function(la){var vc,wc,bd,km,lm,mm,nm;return J(function(db){switch(db.h){case 1:vc=Ea.rh.src||Ea.rh.currentSrc;la||(la={url:vc});wc={};if(!la.Ja){db.m(2);
break}C(db,3);return y(db,zn(la.Ja),5);case 5:return bd=db.j,bd.width&&bd.height&&(wc.width=bd.width,wc.height=bd.height),km=An(bd,{mf:[160,120]}),lm=wc,y(db,new Promise(function($q){var ar=new Blob([km.buffer]),Kh=new FileReader;Kh.addEventListener("load",function(){$q(Kh.result)});Kh.readAsDataURL(ar)}),6);case 6:lm.Ed=db.j;F(db,2);break;case 3:mm=H(db),K.error("DIA histo: "+mm),delete wc.Ed;case 2:a.sensitivity&&(wc.sensitivity=a.sensitivity),nm={pf:la,ka:wc,url:vc},g[Ea.bg]=nm,a.debug&&a.ga.then(function(){Lp(a.h,
vc,la.Ja||vc,160)}),A(db)}})}}(h)).catch(function(Ea){K.warn(Ea)}),f.push(l);return y(La,Promise.all(f),2);case 2:if(Q.features.ra.xc){T=[];O=[];R=Date.now();for(N={Ze:0};N.Ze<g.length;N={Ze:N.Ze,eg:N.eg},N.Ze++)N.eg=g[N.Ze],Y=On(N.eg.pf,N.eg.ka).then(function(Ea){return function(la){return J(function(vc){la.error&&a.debug&&K.warn("local model: "+la.error);O[Ea.Ze]={url:Ea.eg.url,error:la.error,L:la.L,label:la.label,T:"suggestive"==la.label?103:"explicit"==la.label?105:void 0,V:la.V,time:la.time,
Dc:la.Dc,oa:la.oa};A(vc)})}}(N)).catch(function(Ea){return function(la){a.debug&&K.warn("local model: "+la+"\n"+la.stack);O[Ea.Ze]={url:Ea.eg.url,error:la}}}(N)),T.push(Y);return y(La,Promise.all(T),8)}n={recipient:"dynImgAnalysis",type:"analyzeImages",data:{images:g,pk:a.B.tl}};return y(La,new Promise(function(Ea){Z(null,n,null,function(la){Ea(la)})}),5);case 5:if((m=La.j)&&!m.error)for(q=0;q<d.length;q++)if(u=d[q],r=m.images[u],r.oa&&!Ep(a,r)||r.error&&"string"===typeof r.error&&r.error.includes("415")&&
c)b[u].style.filter="",d.splice(q,1),q--;if(void 0==m.requestId){La.m(4);break}if(!m.error&&a.B.tl&&!c)for(p=0;p<m.images.length;p++)if(v=m.images[p],a.B.tb||Ep(a,v))Ip(b[p]),d.push(p);w={recipient:"dynImgAnalysis",type:"getFinalResults",data:{pi:m.requestId}};return y(La,new Promise(function(Ea){Z(null,w,null,function(la){Ea(la)})}),7);case 7:m=La.j;if(m.error)for(z=t(d),B=z.next();!B.done;B=z.next())D=B.value,b[D].style.filter="";else for(E=t(d),B=E.next();!B.done;B=E.next())if(G=B.value,M=m.images[G],
!Ep(a,M)||a.B.tb)b[G].style.filter="";La.m(4);break;case 8:if(m={images:O,time:Date.now()-R},!m.error)for(W=0;W<d.length;W++)X=d[W],L=m.images[X],L.oa&&!Ep(a,L)&&(b[X].style.filter="",d.splice(W,1),W--);I=[];P=[];for(ha=0;ha<O.length;ha++)if(ma=O[ha],ma.error||!ma.oa)P[I.length]=ha,I.push(g[ha]);if(!(0<I.length)){La.m(9);break}if(a.B.tl&&!c)for(aa=0;aa<I.length;aa++)if(V=P[aa],na=O[V],a.B.tb||Ep(a,na))Ip(b[V]),d.push(V);a.debug&&K.log("frame "+a.frameId+": submitting "+I.length+" images to cloud");
za={recipient:"dynImgAnalysis",type:"analyzeImages",data:{images:I,ah:!0}};return y(La,new Promise(function(Ea){Z(null,za,null,function(la){Ea(la)})}),10);case 10:xa=La.j;if(!xa.error)for(Sa=0;Sa<xa.images.length;Sa++)O[P[Sa]]=xa.images[Sa];if(xa.error)for(oc=t(d),B=oc.next();!B.done;B=oc.next())im=B.value,b[im].style.filter="";else for(Ih=t(d),B=Ih.next();!B.done;B=Ih.next())if(Jh=B.value,be=O[Jh],!Ep(a,be)||a.B.tb||be.error&&"string"===typeof be.error&&be.error.includes("415")&&c)b[Jh].style.filter=
"";case 9:m={images:O,ay:I.length,time:Date.now()-R};case 4:if(!m.error)for($c=0;$c<m.images.length;$c++)Da=m.images[$c],g[$c].pf&&(Da.Fc=g[$c].pf.Ja),a.debug&&(ad="["+Da.Ga+"] "+Da.L+": ",Da.error?ad+=Da.error.substr(0,20):(ad+=Da.label.toUpperCase()+", "+Da.time+"ms",ad+=", "+("number"!=typeof Da.V?Da.V:Da.V?Da.V.toFixed(2):"")+(Da.ki?", "+Da.ki.toFixed(2):""),Da.Dc&&(ad+=", cached")),jm="ok"==Da.label?"green":"red",Mp(a.h,Da.url,ad,jm));return La.return(m)}})}
function tp(a){var b=this;this.ra=a;if(window==window.top){this.Sb=Lo(Mo());a=document.createElement("div");this.Sb.appendChild(a);var c=document.createElement("input");this.o=c;c.type="button";c.value="show image importance";c.onclick=function(){Np(b)};a.appendChild(c);this.Sb.appendChild(document.createElement("hr"));a=this.statusText=document.createElement("div");this.Sb.appendChild(a);a=this.j=document.createElement("div");this.Sb.appendChild(a);this.v={};Ko(Mo());window.addEventListener("message",
function(d){if(!b.h&&d.data&&"ImageDebugPane"==d.data.recipient){var e=d.data.data;"showImage"==d.data.type?Lp(b,e.wm,e.url,e.width):"showResult"==d.data.type&&Mp(b,e.wm,e.text,e.color)}},!1)}else this.h=!0}function Np(a){if(!a.h){var b=Ap(a.ra);Op(a,b,0)}}
function Op(a,b,c){if(!a.h){if(!a.l){var d=a.l=No();d.Bf.width=160;a.o.parentNode.appendChild(d.Jf)}d=b[c];var e=d.Jb;e.scrollIntoView();a.l.Bf.src=e.src;var f=e.style.border;e.style.border="thick solid #FF0000";var g=a.o;a.l.yk(d.Nu?c+": "+d.Nu.toFixed(0)+"*"+d.Ry.toFixed(2)+"*"+d.Lw.toFixed(2)+"="+d.tk.toFixed(0):c+": "+d.tk.toFixed(0));g.onclick=c<b.length-1?function(){e.style.border=f;Op(a,b,c+1)}:function(){g.value="show image importance";g.onclick=function(){Np(a)}}}}
function Gp(a){a.h||(a.statusText.innerHTML=a.ra.Fk+" ("+a.ra.pc.images.length+"/"+a.ra.Sm+") images analyzed")}function Lp(a,b,c,d){if(a.h)window.top.postMessage({recipient:"ImageDebugPane",type:"showImage",data:{wm:b,url:c,width:d}},"*");else{Gp(a);var e=No(),f=e.Bf;f.src=c;f.width=d;f.title=b;a.v[b]=e;a.j.insertBefore(e.Jf,a.j.childNodes[0]);20<a.j.childNodes.length&&a.j.removeChild(a.j.childNodes[a.j.childNodes.length-1]);Ko(Mo())}}
function Mp(a,b,c,d){if(a.h)window.top.postMessage({recipient:"ImageDebugPane",type:"showResult",data:{wm:b,text:c,color:d}},"*");else if(a=a.v[b])(b=a.Bf)&&b.src&&!b.src.startsWith("data:")&&(c="** "+c),a.yk(c),a.gn(d)};function Pp(a){var b=this;this.B=a;this.v={Ot:600};this.frameId=a.frameId;(this.debug=a.debug)&&Qp(this);this.metadata=void 0;this.Uj="youtube.com"==location.hostname||location.hostname.endsWith(".youtube.com");if(window.top==window&&this.Uj)Ta.addListener(function(e){var f,g,h,l,m,n,q,u,r;return J(function(p){if("youtubeDecision"==e.type){if(b.debug&&K.log("[DVA][DynVA] Youtube decision. msg=",e),b.yc=void 0,f=e.data,"white"==f.type&&f.data.yn==document.URL){b.yc=document.URL;if(f.data.qa&&(g=f.data.qa,
h=g.indexOf(" "),-1!=h&&"url"==g.substring(0,h))){l=g.substring(h+1);try{m=new URL(l),"youtube.com"!=m.hostname&&"www.youtube.com"!=m.hostname||"/"!=m.pathname||(b.yc=void 0)}catch(v){}}b.debug&&b.yc&&K.log("[DVA] This video is whitelisted.")}}else"youtubeMetaData"==e.type&&(b.debug&&K.log("[DVA][DynVA] Youtube meta data. msg=",e),n=e.data.Qt,b.metadata=n,q=n.title||document.title,(u=(r=n.no)&&"sports illustrated swimsuit"==r.toLowerCase()?{wp:!0}:{wp:!1},u.wp)?(b.A&&K.warn("[DVA] Video sensitivity overriden to high.",
q),b.sensitivity="high"):(b.A&&K.log("[DVA] Video sensitivity restored to default.",q),b.sensitivity=void 0));A(p)})});else if(this.B.jj&&this.B.da.includes(42)){var c=Jn(),d=Mn.hn().then(function(e){K.log("[DVA] Simple allow list check.",e);if(e)return Promise.reject()});Promise.all([c,d]).then(function(){b.jj()}).catch(function(){})}a.enabled&&(this.init(),Rp(this),this.debug&&K.log("[DVA] enabled, "+document.URL+", blockYoutubePreview: ",this.B.sg))}
function Rp(a){if(Array.isArray(a.Nc))for(var b=t(a.Nc),c=b.next();!c.done;c=b.next())c.value.style.filter="blur(30px)";setTimeout(function(){Rp(a)},1E3)}
Pp.prototype.jj=function(){var a=this,b,c,d,e,f,g;return J(function(h){b=document.getElementsByTagName("video");c=t(b);for(d=c.next();!d.done;d=c.next())e=d.value,a.debug&&K.log("[DVA] Examining video. Duration=",e.duration,", src=",e.src),1200<=e.duration&&(f=e.getBoundingClientRect(),400<f.width||300<f.height?(g={L:"dynva",F:a.B.F},Hn(Mn,[42],g)):(a.debug&&K.log("[DVA] Disabling video "+e.src),e.src=""));return y(h,new Promise(function(l){setTimeout(l,5E3)}),1)})};
Pp.prototype.init=function(){function a(){for(var e=t(document.getElementsByTagName("video")),f=e.next();!f.done;f=e.next())f=f.value,d.A&&K.log("[DVA] Frame ID ("+d.frameId+") has video in DOM: "+(f.src||f.currentSrc||f.id)),c.apply(d,[f])?(Array.isArray(d.Nc)||(d.Nc=[]),d.Nc.push(f)):b(f);Mn.addEventListener(function(g){g=t(g.Qb);for(var h=g.next();!h.done;h=g.next())h=h.value,d.A&&K.log("[DVA] Frame ID ("+d.frameId+") has video: "+(h.src||h.currentSrc||h.id)),c.apply(d,[h])?(Array.isArray(d.Nc)||
(d.Nc=[]),d.Nc.push(h)):b(h)})}function b(e){d.debug&&K.log("[DVA][DynVA] Add video.",e);for(var f=t(d.Qb),g=f.next();!g.done;g=f.next())if(g.value.wq.isSameNode(e))return;d.Qb.push({wq:e});e.addEventListener("play",function(h){Sp(d,h)});e.addEventListener("pause",function(h){d.debug&&K.log("[DVA][DynVA] Video paused. currentTime=",h.target.currentTime,", src=",h.target.src,", currentSrc=",h.target.currentSrc)});e.paused||Sp(d,{target:e})}function c(e){return this.B.sg&&this.Uj&&e&&e.parentElement&&
e.parentElement.parentElement&&"inline-preview-player"===e.parentElement.parentElement.id}var d=this;this.Qb=[];this.o={};this.l={};setInterval(function(){for(var e=document.getElementsByTagName("video"),f=0,g=0;g<d.Qb.length;g++){for(var h=d.Qb[g].wq,l=!1,m=0;m<e.length;m++)if(e[m]==h){l=!0;break}l||(d.Qb.splice(g,1),g--,f++)}f&&d.debug&&K.warn("[DVA][DynVA] Removed "+f+" disappeared video elements.")},6E4);Jn().then(function(){a();if(d.B.So)for(var e=!1,f=t(document.getElementsByTagName("canvas")),
g=f.next();!g.done;g=f.next())g=g.value,e||(fetch("https://cc."+Q.Eb+"/ReportConf?host="+location.hostname,{mode:"no-cors"}).catch(function(){}),e=!0),Tp(d,g)})};
function Up(a){var b,c,d;return J(function(e){switch(e.h){case 1:if(a.j){e.m(2);break}if(!Q.features.ra.xc){b=a.B.Yh;e.m(3);break}return y(e,Nn(),4);case 4:c=e.j,b=c.inputs||{},a.B.Yh=b;case 3:d=Object.assign({},b),a.B.Pc&&Object.assign(d,a.B.Tm),a.debug&&!d.Ja&&(d.Ja={format:"jpg",width:480,height:320}),a.j=d;case 2:return e.return(a.j)}})}function Qp(a){Jn().then(function(){a.h=new Vp})}
function Sp(a,b){var c,d,e,f,g;J(function(h){switch(h.h){case 1:c=b.target;d=c.src||c.currentSrc;a.debug&&K.log("[DVA][DynVA] On play. v.src=",c.src,", v.currentSrc=",c.currentSrc,", v.currentTime=",c.currentTime);(e=c.getAttribute("dld_vid"))?f=a.o[e]:(f=new Wp(d,a.debug),e=f.id,a.o[e]=f,c.setAttribute("dld_vid",e));d!=f.We&&(a.debug&&K.log("[DVA][DynVA] Video source changed. Reset sections."),f.We=d,f.ta=new Xp(a.debug),f.Ce=!1);if(a.yc==document.URL||f&&f.Ce)return h.return();a.A&&K.log("[DVA][DynVA] Video job (#"+
f.id+") started playing at "+c.currentTime+"s: "+(c.currentSrc||c.src));a.debug&&(a.h||Qp(a),Yp(a.h));case 2:if(a.yc==document.URL){h.m(0);break}C(h,4);return y(h,Zp(a,c,f),6);case 6:h.m(0);break;case 4:if(g=H(h),K.error("[DVA] Ignoring DVA error: "+g),c.paused)h.m(0);else return y(h,new Promise(function(l){setTimeout(l,1E3)}),2)}})}
function $p(a,b,c,d){a.debug&&K.log("[DVA][DynVA] Create session control. videoJob=",JSON.stringify(c),", useServerAssist=",d);var e={ta:c.ta,da:a.B.da,tb:a.B.tb,debug:a.debug,sampleRate:a.B.sampleRate,ee:a.B.ee,ve:a.B.Pc};if(d)return c.zb&&(e.zb=c.zb),b=new aq(b,c,e),c=function(f,g){this.j=f;this.h=g},c.prototype.add=function(f,g){if(this.h&&g.result&&"ok"!=g.result.label){var h={};g.inputs&&(h.image="data:image/jpeg;base64,"+g.inputs);var l=g.result;h.text=g.pe.toFixed(1)+"s: "+(g.error?g.error:
l.label.substr(0,3)+", "+("number"!=typeof l.V?l.V:l.V?l.V.toFixed(2):"")+", "+g.time+"ms, "+(l.debug||""));h.ne="dld"==g.L?"red":"yellow";bq(this.h,h)}return this.j.add(f,g)},c.prototype.get=function(f){return this.j.get(f)},c.prototype.dm=function(f){return this.j.dm(f)},b.uc=new c(b.uc,a.debug?a.h:void 0),b;e.Cb=function(f){return a.Cb(f)};return new cq(b,c,e)}
function Zp(a,b,c){var d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R,N,Y,W,X,L,I,P,ha,ma;return J(function(aa){switch(aa.h){case 1:return d=b.src||b.currentSrc,c.Ce=!0,y(aa,Up(a),2);case 2:e=aa.j;a.debug&&K.log("[DVA][DynVA] Analyze video. video.src=",b.src,", video.currentSrc=",b.currentSrc,", videoJob=",JSON.stringify(c),", inputDefs=",e);if((g=Rc(navigator.userAgent))&&"safari"==g.browser&&d.startsWith("blob:"))if(location.hostname.endsWith("youtube.com")&&"/watch"==location.pathname)f=!0;else throw Error("Don't know how to handle blob: video sources");
else h=yn(b,e),f=a.B.Kk||!h;f&&d.startsWith("blob:")&&location.hostname.endsWith("youtube.com")&&"/watch"==location.pathname&&(c.zb=document.URL);a.debug&&f&&K.log("[DVA][DynVA] Using server-assisted video analysis.");l=$p(a,b,c,f);m=0;a.A&&K.log("[DVA] Video analysis started: "+d);n=0;q=b.currentTime;u=b.duration;isNaN(u)&&(u=0);C(aa,3,4);a.debug&&!a.h&&Qp(a);p={};case 6:if(a.yc==document.URL){aa.m(4);break}v=l.session;a.A&&v.Lb!=r&&K.log("[DVA][DynVA] Sample interval changed to "+v.Lb+".");r=v.Lb;
w=b.currentTime;a.debug&&dq(a.h,(f?"A: "+(l.fb-w).toFixed(2)+"s, ":"")+"C: "+v.gd+", "+v.state+", "+v.T+", "+c.Re.toFixed(0)+"s, "+c.ta.toString());p.Oi=f?1E3:v.Lb;return y(aa,new Promise(function(V){return function(na){setTimeout(na,V.Oi)}}(p)),9);case 9:n+=p.Oi/1E3;60<n&&(z={recipient:"dynVideoAnalysis",type:"videoStats",data:{duration:n}},Z(null,z),n=0);if(w<q||3<w-q){a.debug&&K.log("[DVA] Video seeked. newTs=",w,", timestamp=",q);l.stop();l=$p(a,b,c,f);m=0;c.ta.getState(w);q=w;aa.m(8);break}m++;
u||(u=b.duration);isNaN(u)&&(u=0);c.Re>=Math.max(a.v.Ot,.08*u)&&!c.ql&&(a.debug&&K.log("[DVA][DynVA] Max total bad duration exceeded."),B=void 0,"exp"==v.T?B=105:"sug"==v.T&&(B=103),B?a.D?(D={Yy:b,url:document.URL,title:document.title,Ua:[B],We:d},a.D(D)):(c.ql=!0,E={L:"dynva",F:a.B.F,nv:{We:d.startsWith("blob:")?document.URL:d,ta:c.ta.toString()}},Hn(Mn,[B],E)):K.error("[DVA][DynVA] Unkonwn category: "+v.T));if(b.paused||b.currentSrc!=d){a.debug&&K.log("[DVA][DynVA] Stop analysis. videoJob.id=",
c.id,", video.src=",b.src,", video.currentSrc=",b.currentSrc);l.stop();a.debug&&(K.log("[DVA] Analyzed clips: "+c.ta),K.log("[DVA] Total bad duration: "+c.Re+" seconds."),K.log("[DVA] Number of cloud queries: "+v.gd));aa.m(4);break}G=c.ta.getState(w);a.A&&K.log("[DVA] Analyze video loop. newTs=",w,", timestamp=",q,", frameNum=",m,", knownState=",G);M=void 0;if(f)G?l.Hj(G,w):eq(l,w);else{T=void 0;if(!G||a.debug){T=yn(b,e);if(!T){a.debug&&K.warn("[DVA] Failed to get frame, switching to server assist.");
f=!0;l=$p(a,b,c,f);aa.m(8);break}M=T.Ja}if(G)l.Hj(G,w);else{p.ph={};O=t(Object.keys(a.B.Yh));for(R=O.next();!R.done;R=O.next())N=R.value,p.ph[N]=T[N];Y=void 0;p.Gi={Fg:m,Jp:w};a.A&&K.log("[DVA] Request to analyze video. frameNum="+m+", newTs="+w+".");Y=Q.features.ra.xc?new Promise(function(V){return function(na){var za;return J(function(xa){if(1==xa.h)return y(xa,On(V.ph),2);za=xa.j;na({Db:V.Gi,result:za});A(xa)})}}(p)):new Promise(function(V){return function(na){var za={recipient:"dynVideoAnalysis",
type:"analyzeFrame",data:{Db:V.Gi,inputs:V.ph}};Z(null,za,null,function(xa){a.debug&&K.log("[DVA] Analyze frame. msg=",za,", response=",xa);na(xa)})}}(p));Y.then(function(V){fq(a,V,l)})}if(a.debug||a.B.Pc)W={id:m,pe:w,inputs:T},l.uc.add(m,W)}a.debug&&(f?(L=l.uc.get(w))?(I={},L.inputs&&(I.image="data:image/jpeg;base64,"+L.inputs),I.text=L.pe.toFixed(2)+"s: ",I.text+="state: "+(G?G:"unknown")+", ",L.result&&(I.text+="frame: "+L.result.label),I.ne=L.result&&"ok"!=L.result.label?"red":"blue",gq(a.h,I)):
(P={image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEX/TQBcNTh/AAAAAXRSTlPM0jRW/QAAAApJREFUeJxjYgAAAAYAAzY3fKgAAAAASUVORK5CYII=",text:w.toFixed(2)+"s: state: "+(G?G:"unknown")},gq(a.h,P)):(X={image:M},G?(X.text="known: "+G,X.ne="ok"==G?"blue":"red"):X.text="",gq(a.h,X)));q=w;case 8:p={Oi:p.Oi,ph:p.ph,Gi:p.Gi};aa.m(6);break;case 4:va(aa);a.debug&&K.log("[DVA] Video analysis completed. Analyzed duration="+n+"s, video.src=",b.src,", video.currentSrc=",b.currentSrc);
l.stop();b.paused&&(c.Ce=!1);ha={recipient:"dynVideoAnalysis",type:"videoStats",data:{duration:n}};Z(null,ha);wa(aa,0);break;case 3:throw ma=H(aa),ma;}})}
function Tp(a,b){var c,d,e,f,g,h,l;J(function(m){switch(m.h){case 1:(c=b.getAttribute("dld_cid"))?d=a.l[c]:(d=new hq(a.debug),c=d.id,a.l[c]=d,b.setAttribute("dld_cid",c));if(d.Ce)return m.return();d.Ce=!0;e=3E3;f=5;case 2:h=An(b,{mf:[200,150]});if(!h||!g){m.m(4);break}l=Bn(g,h);if(!(l>f)){m.m(4);break}a.debug&&K.log("[DVA] Canvas #"+d.id+" change detected, analyzing.");return y(m,iq(a,b,d),6);case 6:g=void 0;m.m(2);break;case 4:return g=h,y(m,new Promise(function(n){setTimeout(n,e)}),2)}})}
function iq(a,b,c){var d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R,N,Y,W,X;return J(function(L){switch(L.h){case 1:return y(L,Up(a),2);case 2:d=L.j,e=$p(a,b,c),f=0,a.debug&&K.log("[DVA] Canvas #"+c.id+": analysis started."),h=g=0,C(L,3,4),a.debug&&!a.h&&(Qp(a),Yp(a.h)),l=!0,u=5,r={};case 6:if(a.yc==document.URL){L.m(4);break}p=e.session;a.debug&&p.Lb!=m&&K.log("[DVA] Sample interval changed to "+p.Lb);m=p.Lb;v=h;a.debug&&dq(a.h,"V# "+c.id+": "+p.gd+", "+p.state+", "+p.T+", "+c.Re.toFixed(0)+"s, "+
c.ta.toString());r.uh=p.Lb;return y(L,new Promise(function(I){return function(P){setTimeout(P,I.uh)}}(r)),9);case 9:g+=r.uh/1E3;60<g&&(w={recipient:"dynVideoAnalysis",type:"videoStats",data:{duration:g}},Z(null,w),g=0);f++;if((z=An(b,{mf:[200,150]}))&&n)if(B=Bn(n,z),D=Date.now(),B<u)if(!q)q=D;else{if(2E4<=D-q){a.debug&&K.log("[DVA] Canvas #"+c.id+" has been idling, stop analyzing...");L.m(4);break}}else q=void 0;n=z;G=E=void 0;if(G=yn(b,d))!l&&a.debug&&K.warn("[DVA] Got canvas frame ok."),l=!0;else{l&&
a.debug&&K.warn("[DVA] Failed to get canvas, will keep retrying.");l=!1;L.m(8);break}E=G.Ja;r.qh={};M=t(Object.keys(a.B.Yh));for(T=M.next();!T.done;T=M.next())O=T.value,r.qh[O]=G[O];R=void 0;r.Hi={Fg:f,Jp:v};R=Q.features.ra.xc?new Promise(function(I){return function(P){var ha;return J(function(ma){if(1==ma.h)return y(ma,On(I.qh),2);ha=ma.j;P({Db:I.Hi,result:ha});A(ma)})}}(r)):new Promise(function(I){return function(P){Z(null,{recipient:"dynVideoAnalysis",type:"analyzeFrame",data:{Db:I.Hi,inputs:I.qh}},
null,function(ha){P(ha)})}}(r));R.then(function(I){fq(a,I,e)});if(a.debug||a.B.Pc)N={id:f,pe:v,inputs:G},e.uc.add(f,N);a.debug&&(Y={image:E,text:""},gq(a.h,Y));h=v+r.uh/1E3;case 8:r={uh:r.uh,qh:r.qh,Hi:r.Hi};L.m(6);break;case 4:va(L);a.debug&&(K.log("[DVA] Analyzed canvas duration: "+c.ta),K.log("[DVA] Total bad duration: "+c.Re+" seconds"),K.log("[DVA] # of Rs: "+e.session.gd));e.stop();c.Ce=!1;W={recipient:"dynVideoAnalysis",type:"videoStats",data:{duration:g}};Z(null,W);wa(L,0);break;case 3:throw X=
H(L),X;}})}
function fq(a,b,c){var d=b.result,e=b.Db.Jp;a.A&&K.log("[DVA][DynVA] Process frame result. newTs=",e,", result=",d);if(a.debug){if(d.error)var f=d.error;else f=d.label,b.Db.Fg!=c.tm+1&&(f="frame "+(b.Db.Fg-c.tm)+": "+f);gq(a.h,{text:f,ne:d.error||"ok"!=d.label?"red":"blue"});if("ok"!=d.label){f={};var g=c.uc.get(b.Db.Fg);g?(f.image=g.inputs.Ja,f.text=e.toFixed(2)+"s: "+(d.error?d.error:d.label)):f.text="buffered frame not found: "+b.Db.Fg;f.ne="red";bq(a.h,f)}}c.hd({id:b.Db.Fg,timestamp:e,fe:d.label})}
Pp.prototype.Cb=function(a){var b=this,c,d,e,f,g,h,l,m,n,q,u;return J(function(r){switch(r.h){case 1:b.A&&K.log("[DVA][DynVA] Cloud query. frame=",a);c={};d=t(Object.keys(b.B.Tm));for(e=d.next();!e.done;e=d.next())f=e.value,c[f]=a.inputs[f];g={};if(!a.inputs.Ja){r.m(2);break}C(r,3);return y(r,zn(a.inputs.Ja),5);case 5:return h=r.j,h.width&&h.height&&(g.width=h.width,g.height=h.height),l=An(h,{mf:[160,120]}),m=g,y(r,new Promise(function(p){var v=new Blob([l.buffer]),w=new FileReader;w.addEventListener("load",
function(){p(w.result)});w.readAsDataURL(v)}),6);case 6:m.Ed=r.j;F(r,2);break;case 3:H(r),delete g.Ed;case 2:return n={recipient:"dynVideoAnalysis",type:"analyzeFrameRekog",data:{inputs:c,ka:g}},b.sensitivity&&(g.sensitivity=b.sensitivity),y(r,new Promise(function(p){Z(null,n,null,function(v){b.debug&&K.log("[DVA] Analyze frame rekog. msg=",n,", response=",v);p(v?v.result:null)})}),7);case 7:q=r.j;if(!q)return r.return();q.debug=q.Dc?"cached":Math.round(JSON.stringify(c).length/1024)+"kB";b.debug&&
(u={image:a.inputs.Ja,text:a.pe.toFixed(1)+"s: "+q.L+" "+(q.error?q.error:q.label.substr(0,3)+", "+("number"!=typeof q.V?q.V:q.V?q.V.toFixed(2):"")+", "+q.time+"ms, "+q.debug),ne:"yellow"},bq(b.h,u));return r.return(q)}})};
function Vp(){var a=this;window.top===window?window.addEventListener("message",function(b){!a.h&&b.data&&"VideoDebugPane"==b.data.recipient&&("clearBadFramesArea"==b.data.type?Yp(a):"setDebugText"==b.data.type?dq(a,b.data.ma):"setCurrentFrame"==b.data.type?gq(a,b.data.ma):"addBadImage"==b.data.type&&bq(a,b.data.ma))},!1):this.h=!0}
Vp.prototype.init=function(){var a=Mo();this.Sb=Lo(a);this.o=160;a.frame.style.left="";a.frame.style.right="0px";var b=this.j=document.createElement("div");this.Sb.appendChild(b);this.v=b=document.createElement("div");b.innerHTML="Debug text";this.j.appendChild(b);this.currentFrame=No();this.currentFrame.Bf.width=this.o;this.j.appendChild(this.currentFrame.Jf);b=document.createElement("div");b.innerHTML="Bad frames: <br>";this.j.appendChild(b);this.Fe=20;Ko(a)};
function Yp(a){if(a.h)window.top.postMessage({recipient:"VideoDebugPane",type:"clearBadFramesArea"},"*");else{a.Sb||a.init();a.l&&a.j.removeChild(a.l);var b=a.l=document.createElement("div");a.j.appendChild(b);Ko(Mo())}}function dq(a,b){a.h?window.top.postMessage({recipient:"VideoDebugPane",type:"setDebugText",ma:b},"*"):(a.Sb||a.init(),a.v.innerHTML=b,Ko(Mo()))}
function gq(a,b){b?a.h?window.top.postMessage({recipient:"VideoDebugPane",type:"setCurrentFrame",ma:b},"*"):(a.Sb||a.init(),b.image&&(a.currentFrame.Bf.src=b.image),b.text&&a.currentFrame.yk(b.text),b.ne&&a.currentFrame.gn(b.ne),Ko(Mo())):K.warn("[DVA] Debug frame info is empty.")}
function bq(a,b){if(a.h)window.top.postMessage({recipient:"VideoDebugPane",type:"addBadImage",ma:b},"*");else{a.Sb||a.init();var c=No(),d=c.Bf;d.width=a.o;b.image&&(d.src=b.image);b.text&&c.yk(b.text);b.ne&&c.gn(b.ne);b=a.l;for(b.insertBefore(c.Jf,b.childNodes[0]);b.childNodes.length>=a.Fe;)b.removeChild(b.childNodes[b.childNodes.length-1]);Ko(Mo())}}function Xp(a){this.h=[];this.debug=a;this.A&&K.log("[DVA][VideoSections] Construct.")}
Xp.prototype.getState=function(a){for(var b=0;b<this.h.length&&a>=this.h[b].$a;b++)if(a<this.h[b].ua)return this.h[b].state;return null};
Xp.prototype.mark=function(a,b,c){if(a!=b){var d;for(d=0;d<this.h.length;d++){var e=this.h[d];if(e.$a>=b)break;e.$a>a&&e.ua<=b&&(e.state!=c&&K.warn("[DVA] New video state different from existing: "+e.$a+"-"+e.ua+", "+e.state+" => "+a+"-"+b+", "+c),this.h.splice(d,1),d--)}for(d=0;d<this.h.length&&a>=this.h[d].ua;d++);e={$a:a,ua:b,state:c};0==this.h.length?this.h.push(e):(d==this.h.length?this.h.push(e):(a<this.h[d].$a?this.h.splice(d,0,{$a:a,ua:Math.min(this.h[d].$a,b),state:c}):(e=this.h[d],e.state!=
c&&(K.warn("[DVA] New video state different from existing: "+e.$a+"-"+e.ua+", "+e.state+" => "+a+"-"+b+", "+c),b<e.ua&&(this.h.splice(d+1,0,{$a:b,ua:e.ua,state:e.state}),e.ua=b),a>e.$a&&(this.h.splice(d,0,{$a:e.$a,ua:a,state:e.state}),e.$a=a,d++),e.state=c)),d<this.h.length-1?b==this.h[d+1].$a?c==this.h[d+1].state&&(this.h[d].ua=this.h[d+1].ua,this.h.splice(d+1,1)):b>this.h[d+1].$a?(e=this.h[d+1],e.state!=c&&K.warn("[DVA] New video state different from existing: "+e.$a+"-"+e.ua+", "+e.state+" => "+
a+"-"+b+", "+c),this.h[d].ua=b,this.h[d+1].$a=b):this.h[d].ua=b:b>this.h[d].ua&&(this.h[d].ua=b)),0<d&&this.h[d].$a==this.h[d-1].ua&&this.h[d].state==this.h[d-1].state&&(this.h[d-1].ua=this.h[d].ua,this.h.splice(d,1)))}this.A&&K.log("[DVA][VideoSections] Mark. beginTs="+a+", endTs="+b+", state="+c+". this.clips=",JSON.stringify(this.h))};Xp.prototype.toString=function(){for(var a="",b=0;b<this.h.length;b++)a+="<br>"+this.h[b].state+":["+this.h[b].$a.toFixed(1)+"-"+this.h[b].ua.toFixed(1)+"]";return a};
function jq(a,b){this.size=a;this.debug=b;this.buffer=[];this.index={}}
jq.prototype.add=function(a,b){for(this.A&&K.log("[DVA][FrameBuffer] Adding into buffer.",a,b);this.buffer.length>=this.size;){var c=this.buffer.shift();delete this.index[c.id];this.A&&K.log("[DVA][FrameBuffer] Moving out of buffer.",c.id)}b={id:a,frame:b};this.index[a]&&(this.A&&K.log("[DVA][FrameBuffer] Element with same ID already exists. Remove.",a),this.buffer=this.buffer.filter(function(d){return d.id!=a}));this.buffer.push(b);this.index[a]=b;this.buffer.length!=Object.keys(this.index).length&&
K.warn("[DVA] Mismatched buffer size and index size: "+this.buffer.length+", "+Object.keys(this.index).length)};jq.prototype.get=function(a){return(a=this.index[a])?a.frame:null};function kq(a,b){jq.call(this,a,b)}x(kq,jq);
kq.prototype.get=function(a){var b=Object.keys(this.index).map(function(d){return parseFloat(d)}).sort(function(d,e){return d-e}),c;for(c=0;c<b.length&&b[c]<=a;c++);c--;b=0>c||2<a-b[c]?void 0:this.index[b[c]].frame;this.A&&K.log("[DVA][ServerAssistedFrameBuffer] Get. timestamp=",a,", ret=",b,", this.index=",this.index);return b};kq.prototype.dm=function(a){return jq.prototype.get.call(this,a)};
function lq(a){a||(a={});this.B=a;this.debug=a.debug;this.A&&K.log("[DVA][Session] Construct. config=",a);this.ta=a.ta;this.h=a.lq||0;this.T="ok";this.j=[];this.reset()}k=lq.prototype;k.reset=function(a){a=void 0===a?0:a;this.A&&K.log("[DVA][Session] Reset. newStartTs=",a);a&&a>this.h&&(this.h=a);this.Lb=1E3;this.transition=void 0;this.state="ok"};k.addEventListener=function(a){this.j.push(a)};
k.hd=function(a){this.A&&K.log("[DVA][Session] Process frame. absFrame=",a);var b=a.timestamp;if(this.h&&b<this.h)K.warn("[DVA] Frame analysis results out of order. this.lastSeenTs=",this.h);else{if("ok"==this.state){if(this.ta.mark(this.h,b,this.state),mq(this,this.h,b,this.state),"ok"!=a.fe){this.A&&K.log("[DVA] Create transition due to bad frame seen. Enter monitor state at "+a.timestamp+"s.");var c=this.state;this.state="monitor";this.onStateChanged(c,this.state,a);this.transition=this.vj({Id:c,
frame:a},{debug:this.debug})}}else"exp"==this.state||"sug"==this.state?(this.ta.mark(this.h,b,this.state),mq(this,this.h,b,this.state),"ok"==a.fe&&(this.A&&K.log("[DVA] Create transition due to good frame seen. Enter monitor state at "+a.timestamp+"s."),c=this.state,this.state="monitor",this.onStateChanged(c,this.state,a),this.transition=this.vj({Id:c,frame:a},{debug:this.debug}))):"monitor"==this.state&&this.transition.hd(a);this.h=b}};
k.vj=function(a,b){var c=this;return new nq(a,function(d){c.Si(d)},b)};k.stop=function(){this.A&&K.log("[DVA][Session] Stop. this.state=",this.state,", this.lastSeenTs=",this.h);"monitor"==this.state&&this.transition&&(this.transition.xb>this.h?K.warn("[DVA] Transition start timestamp < last seen timestamp: ",this.transition.xb,this.h):this.ta.mark(this.transition.xb,this.h,this.transition.Id));delete this.transition};
function mq(a,b,c,d){a.A&&K.log("[DVA][Session] On new section rated. fromTs=",b,", toTs=",c,", state=",d);a.dispatchEvent({type:"newSectionRated",data:{from:b,oe:c,state:d}})}
k.onStateChanged=function(a,b,c){this.A&&K.log("[DVA][Session] On state changed. oldState=",a,", newState=",b,", absFrame=",c);-1==["exp","sug","ok","monitor"].indexOf(b)&&(K.error("[DVA] Unknown new state: "+b+", forcing it into ok."),this.state="ok");"sug"!=b&&"exp"!=b||"exp"==this.T||(this.T=b);this.dispatchEvent({type:"stateChanged",data:{Id:a,Ge:b,frame:c}})};
k.Si=function(a){this.A&&K.log("[DVA][Session] On transition end. info=",a);if("monitor"!=this.state)this.debug&&K.warn("[DVA] Transition ended too late, session already out of monitor state in "+this.state);else{this.ta.mark(a.transition.xb,a.timestamp,a.Ge);mq(this,a.transition.xb,a.timestamp,a.Ge);var b=this.state;this.state=a.Ge;this.onStateChanged(b,this.state,a.frame);delete this.transition}};
k.dispatchEvent=function(a){for(var b=t(this.j),c=b.next();!c.done;c=b.next()){c=c.value;try{c(a)}catch(d){K.error("[DVA] Error in Session event listener: ",d)}}};
function nq(a,b,c){this.Id=a.Id;this.S=this.xb=a.frame.timestamp;this.v=b;this.ya=!0;this.j=this.Id;"ok"==this.j&&a.frame.fe&&(this.j=a.frame.fe.substr(0,3));this.ma=Object.assign({Fe:4,Rg:5,Ws:.8,ur:.8},c||{});this.debug=c.debug;this.A&&K.log("[DVA][Transition] Construct. info=",a,", params=",c);this.ck=Math.max(this.ma.Rg,this.ma.Fe);this.o=0;this.l=1;this.h=["ok"==this.T?0:1];this.ga=1}
nq.prototype.hd=function(a){this.A&&K.log("[DVA][Transition] Process frame. absFrame=",a);this.S=a.timestamp;this.ga++;"ok"==a.fe?(this.h.unshift(0),this.o++):(this.h.unshift(1),this.l++);this.h.length>this.ma.Rg&&(this.o-=1-this.h[this.ma.Rg]);this.h.length>this.ma.Fe&&(this.l-=this.h[this.ma.Fe]);this.h.length>this.ck&&this.h.pop();this.A&&K.log("[DVA] In transition process frame. rating="+a.fe+", frameResults.length="+this.h.length+", nGood="+this.o+", nBad="+this.l);var b={frame:a,timestamp:a.timestamp,
transition:this};("ok"!=this.Id||this.ya)&&this.l/this.ma.Fe>=this.ma.ur?(this.A&&K.log("[DVA] Transition end. "+this.l+" bad in "+this.ma.Fe+" frames. Enter "+this.j+" state at "+a.timestamp+"s."),b.Ge=this.j,this.v(b)):this.o/this.ma.Rg>=this.ma.Ws&&(this.A&&K.log("[DVA] Transition end. "+this.o+" good in "+this.ma.Rg+" frames. Enter ok state at "+a.timestamp+"s."),b.Ge="ok",this.v(b))};
function oq(a){lq.call(this,a);this.A&&K.log("[DVA][SessionWithCloudValidation] Construct.",a);this.B=Object.assign({sampleRate:1E3,ee:500,Lt:2E3,Ut:3E3,zo:8},this.B);this.Lb=this.B.sampleRate;this.gd=0;this.l=this.o=this.h}x(oq,lq);k=oq.prototype;k.reset=function(){this.A&&K.log("[DVA][SessionWithCloudValidation] Reset.");lq.prototype.reset.call(this);this.Lb=this.B.sampleRate};
k.vj=function(a,b){var c=this;b=void 0===b?{}:b;this.A&&K.log("[DVA][SessionWithCloudValidation] Create transition. info=",a,", params=",b);b.Rg=Math.ceil((this.B.Ut+1)/this.B.ee);b.Fe=Math.ceil((this.B.Lt+1)/this.B.ee);this.B.ve?(b.Cb=function(d){return J(function(e){return e.return(c.Cb(d))})},a=new pq(a,function(d){c.Si(d)},b)):a=lq.prototype.vj.call(this,a,b);this.Lb=this.B.ee;return a};
k.Si=function(a){this.A&&K.log("[DVA][SessionWithCloudValidation] On transition end. info=",a);this.Lb=this.B.sampleRate;lq.prototype.Si.call(this,a)};k.Cb=function(a){var b=this,c;return J(function(d){if(1==d.h)return b.A&&K.log("[DVA][SessionWithCloudValidation] Cloud query.",a),b.o=a.timestamp,y(d,b.B.Cb(a),2);(c=d.j)&&!c.Dc&&b.gd++;return d.return(c)})};
k.hd=function(a){var b=this;this.A&&K.log("[DVA][SessionWithCloudValidation] Process frame.",a);lq.prototype.hd.call(this,a);("exp"==this.state||"sug"==this.state)&&0<this.B.zo&&a.timestamp-Math.max(this.l,this.o)>this.B.zo&&(this.A&&K.log("[DVA] Performing cloud re-check at "+a.timestamp+"s."),this.l=a.timestamp,this.Cb(a).then(function(c){"ok"==c.label&&(c=a.timestamp+qq.yo,b.A&&K.log("[DVA] Entering ok based on cloud re-check result until "+c+"s."),b.ta.mark(a.timestamp,c,"ok"),mq(b,a.timestamp,
c,"ok"),c=b.state,b.state="ok",b.onStateChanged(c,b.state,a),delete b.transition)}))};function rq(a,b,c){nq.call(this,a,b,c);this.A&&K.log("[DVA][TransitionCloudValidation] Construct. info=",a,", params=",c);this.ma=Object.assign(qq,this.ma);this.aa=this.ma.Mt;this.J=0;this.D(a.frame)}x(rq,nq);rq.prototype.hd=function(a){this.A&&K.log("[DVA][TransitionCloudValidation] Process frame. absFrame=",a);nq.prototype.hd.call(this,a);this.D(a)};
rq.prototype.D=function(a){this.A&&K.log("[DVA][TransitionCloudValidation] Do cloud validation if necessary. absFrame=",a);"ok"==this.Id&&"ok"!=a.fe&&0<this.aa&&this.ma.Ds<=this.ga&&this.ve(a)};
rq.prototype.ve=function(a){var b=this,c,d,e;return J(function(f){if(1==f.h)return b.A&&K.log("[DVA][TransitionCloudValidation] Cloud validation. absFrame=",a),b.aa--,b.J++,y(f,b.ma.Cb(a),2);c=f.j;b.J--;if(c.error)return f.return();"ok"==c.label?(d={frame:a,timestamp:b.xb+b.ma.yo,Ge:"ok",transition:b},b.A&&K.log("[DVA] Entering ok state based on cloud result until "+d.timestamp+"s."),b.v(d)):(b.j=c.label.substr(0,3),b.ma.Xu&&(e={frame:a,timestamp:b.S,Ge:b.j,transition:b},b.A&&K.log("[DVA] Entering bad state based on cloud result until "+
e.timestamp+"s."),b.v(e)));A(f)})};var qq={yo:3,Xu:!0,Mt:1,Ds:1};function pq(a,b,c){rq.call(this,a,b,c);this.A&&K.log("[DVA][TransitionCloudBlackValidation] Construct. info=",a,", params=",c);this.ya=!1}x(pq,rq);pq.prototype.D=function(a){this.A&&K.log("[DVA][TransitionCloudBlackValidation] Do cloud validation if necessary. absFrame=",a);"ok"==this.Id&&"ok"!=a.fe&&0>=this.J&&this.ve(a)};
function sq(a,b,c){var d=this;this.B=c;this.debug=c.debug;this.A&&K.log("[DVA][AbstractSessionControl] Construct. videoJob=",b,", config=",c);this.uc=void 0;this.j=a.currentTime;this.tm=0;this.video=a;this.h=new tq(a,this.debug);this.h.restore(this.j);uq(this.h,{ek:function(e){d.ek(e)}});this.o=b}
function vq(a,b){a.A&&K.log("[DVA][AbstractSessionControl] Set session object. session=",b);a.session=b;a.session.addEventListener(function(c){if("stateChanged"==c.type)a.onStateChanged(c.data.Id,c.data.Ge,c.data.frame);else"newSectionRated"==c.type&&a.al(c.data.from,c.data.oe,c.data.state)})}k=sq.prototype;k.onStateChanged=function(a,b,c){this.A&&K.log("[DVA][AbstractSessionControl] On state changed. oldState=",a,", newState=",b,", frame=",c);wq(this,b,c)};
k.al=function(a,b,c){this.A&&K.log("[DVA][AbstractSessionControl] On new section rated. from=",a,", to=",b,", state=",c);"ok"!=c&&-1!=this.B.da.indexOf("sug"==c?103:105)&&(this.o.Re+=b-a)};k.hd=function(a){this.A&&K.log("[DVA][AbstractSessionControl] Process frame. frame=",a);this.j=a.timestamp;this.tm=a.id;this.session.hd(a)};k.Hj=function(a,b){this.A&&K.log("[DVA][AbstractSessionControl] Enter known state. newState=",a,", newTs=",b);wq(this,a,{timestamp:b})};
function wq(a,b,c){a.A&&K.log("[DVA][AbstractSessionControl] Set blur mode. newState=",b,", frame=",c);var d=c.timestamp;if("ok"==b)a.h.restore(d);else if("sug"==b||"exp"==b)b="sug"==b?103:105,a.B.tb||-1!=a.B.da.indexOf(b)?(b={T:b},c.id&&(b.image=a.uc.get(c.id).inputs.Ja),a.h.j||(a.l=d),a=a.h,a.A&&K.log("[DVA][VideoControl] Mitigate. info=",b),c=a.video,a.td=b.T,a.j||(a.o=c.muted,a.l=c.currentTime,a.Vf=b.image,a.h&&a.h.ju&&a.h.ju({xb:a.l,td:a.td,Vf:a.Vf})),a.A&&K.log("[DVA] Blur."),c.style.filter=
"blur(30px)",c.muted=!0,c.onvolumechange=a.v,a.j=!0,Gn(Mn,{type:"videoBlurred",data:{}})):a.h.restore(d)}k.ek=function(a){this.A&&K.log("[DVA][AbstractSessionControl] On video restored. info=",a);xq(this,a)};
function xq(a,b){var c,d,e,f,g,h,l;J(function(m){switch(m.h){case 1:a.A&&K.log("[DVA][AbstractSessionControl] Report blurred event. _info=",b);c=Object.assign({},b);if(void 0===c.xb||c.ua<c.xb)return K.warn("[DVA] Wrong time range in videoBlurred event: "+c.xb+" - "+c.ua),m.return();(d=a.o.We)&&d.startsWith("blob:")&&(d=document.URL);e={Ve:{ta:[{from:c.xb,oe:c.ua,td:c.td}],duration:c.ua-c.xb,We:d}};if(!c.Vf){m.m(2);break}C(m,3);f={format:"jpg",width:640,height:480};return y(m,zn(c.Vf),5);case 5:return g=
m.j,y(m,wn(g,f),6);case 6:h=m.j;e.W=[{name:"frame-"+c.xb.toFixed(1)+"s",Da:d,value:h}];F(m,2);break;case 3:l=H(m),K.error("[DVA] Report blurred event error.",l);case 2:a.A&&K.log("[DVA] Video blurred event from "+c.xb+" to "+c.ua+". cat="+c.td),Rn("videoBlurred",e),A(m)}})}k.stop=function(){this.A&&K.log("[DVA][AbstractSessionControl] Stop.");this.session.stop();this.h.restore(this.j,{ks:!0})};
function cq(a,b,c){sq.call(this,a,b,c);var d=this;this.A&&K.log("[DVA][LiveSessionControl] Construct. videoJob=",b,", config=",c);this.uc=new jq(20,c.debug);vq(this,new oq({ta:c.ta,lq:a.currentTime,debug:c.debug,ve:c.ve,sampleRate:c.sampleRate,ee:c.ee,Cb:function(e){return d.Cb(e)}}))}x(cq,sq);cq.prototype.Cb=function(a){var b=this,c;return J(function(d){b.A&&K.log("[DVA][LiveSessionControl] Cloud query. absFrame=",a);c=b.uc.get(a.id);return d.return(b.B.Cb(c))})};
function aq(a,b,c){sq.call(this,a,b,c);var d=this;this.A&&K.log("[DVA][ServerAssistedSessionControl] Construct. videoJob=",b,", config=",c);this.uc=new kq(40,c.debug);vq(this,new oq({ta:c.ta,lq:a.currentTime,debug:c.debug,ve:c.ve,sampleRate:2E3,Cb:function(e){return J(function(f){return f.return(d.Cb(e))})}}));this.fb=this.j||0;this.gd=0;a=c.zb||a.currentSrc;if(a.startsWith("blob:")&&!document.URL.startsWith("https://www.youtube.com/watch?"))throw Error("Server assist doesn't support blob URLs");
this.A&&K.log("[DVA] Server assisted session control.",a);this.D=new yq(a,c.debug);zq(this,this.j)}x(aq,sq);k=aq.prototype;
k.Cb=function(a){var b=this,c,d,e;return J(function(f){if(1==f.h)return b.A&&K.log("[DVA][ServerAssistedSessionControl] Cloud query. absFrame=",a),b.gd++,y(f,b.D.h(a.id,1,1,b.debug),2);(c=f.j)&&!c.error&&c.frames?(d=c.frames[0],e={id:d.timestamp,pe:d.timestamp,inputs:d.image,result:d.result,time:c.time,L:c.L},b.uc.add(d.timestamp,e),c=d.result):(b.debug&&K.warn("[DVA] C model error: "+(c&&c.error||"no result/frames returned.")),c=void 0);return f.return(c||{label:"ok"})})};k.onStateChanged=function(){};
k.al=function(a,b,c){sq.prototype.al.call(this,a,b,c);this.A&&K.log("[DVA][ServerAssistedSessionControl] On new section rated. from=",a,", to=",b,", state=",c);b>this.fb&&(this.fb=b)};k.Hj=function(a,b){sq.prototype.Hj.call(this,a,b);this.A&&K.log("[DVA][ServerAssistedSessionControl] Enter known state. newState=",a,", newTs=",b);zq(this,b)};
function eq(a,b){a.A&&K.log("[DVA][ServerAssistedSessionControl] Unknown frame seen. timestamp=",b);"monitor"!=a.session.state&&(K.warn("[DVA] Unknown frame status at "+b),wq(a,"ok",{timestamp:b}));zq(a,b)}k.hd=function(){};
function zq(a,b){var c,d,e,f,g,h,l,m,n,q,u,r,p,v,w;J(function(z){switch(z.h){case 1:a.A&&K.log("[DVA][ServerAssistedSessionControl] Analyze ahead. currentTs=",b);if(a.v||b+60-20-.5<a.fb)return z.return();if(a.J)return a.debug&&K.warn("[DVA] Skipping server analysis because of permanent error."),a.fb+=20,z.return();a.v=!0;C(z,2,3);c=!1;d=a.fb;case 5:if(!(60>a.fb-d&&1<a.video.duration-a.fb)){z.m(3);break}e=a.session.Lb;f=e/1E3;g=Math.round(2*(a.fb+f))/2;a.A&&K.log("[DVA] Analyzed ahead loop. ts="+g+
", currentTs="+b+", lastInterval="+e+".");if(h=a.uc.dm(g)){a.A&&K.log("[DVA] Got result from buffer:",h);l={id:h.pe,timestamp:h.pe,fe:h.result.label};sq.prototype.hd.call(a,l);a.fb=h.pe;a.session.Lb!=e&&a.A&&K.log("[DVA][ServerAssistedSessionControl] Sample interval changed to "+a.session.Lb);z.m(5);break}m=Math.floor(Math.min((a.video.duration-a.fb)/f,5));n=Math.min((Math.min(a.video.duration,d+60)-a.fb)/f,30);if(isNaN(n))return K.error("[DVA] Cannot calculate # of frames to get: NaN."),z.return();
n=Math.round(n);n=Math.max(n,m);if(0==n){z.m(3);break}if(a.video.paused)return a.A&&K.log("[DVA] Video already stopped, stop analyzing ahead..."),z.return();if(!c){z.m(7);break}a.debug&&K.warn("[DVA] Server is fetching ahead, wait a bit before sending new request.");return y(z,new Promise(function(B){setTimeout(B,900)}),7);case 7:return a.gd++,a.A&&K.log("[DVA][ServerAssistedSessionControl] Request "+n+" frame results from "+(a.fb+f)+"s to "+(a.fb+f*n)+"s. interval="+f+"s"),y(z,a.D.j(a.fb+f,n,f,a.debug),
9);case 9:q=z.j;if(!q||q.error)return a.debug&&K.warn("[DVA] Light weight model error: "+(q&&q.error)),q&&q.error&&(q.error.includes("video not available")||q.error.includes("video marked unreachable"))&&(a.debug&&K.warn("[DVA] Irrecoverable error encountered. Will not further ask server to analyze."),a.J=!0),a.fb+=5,z.return();u=t(q.frames);for(r=u.next();!r.done;r=u.next())p=r.value,v={id:p.timestamp,pe:p.timestamp,inputs:p.image,result:p.result,time:q.time,Dc:p.Dc,L:q.L},a.uc.add(p.timestamp,v);
c=n!=q.frames.length;if(0==q.frames.length){K.error("[DVA] Server out of frames, abort to avoid infinite loop.");z.m(3);break}z.m(5);break;case 3:va(z);a.v=!1;wa(z,0);break;case 2:w=H(z),K.warn("[DVA] Failed to get L model results for timestamp "+a.fb+". err=",w),z.m(3)}})}function Aq(a){this.zb=a}Aq.prototype.j=function(){return J(function(){throw"Not implemented in abstract class";})};Aq.prototype.h=function(){return J(function(){throw"Not implemented in abstract class";})};
function yq(a,b){this.zb=a;this.debug=b}x(yq,Aq);yq.prototype.j=function(a,b,c,d){var e=this,f,g;return J(function(h){if(1==h.h){if(!e.zb)return h.return({error:"empty video URL"});a=Math.round(2*a)/2;f={recipient:"dynVideoAnalysis",type:"getServerAssist",data:{zb:e.zb,Uf:document.URL,timestamp:a,ck:b,interval:c,Gp:d,sn:!1}};return y(h,new Promise(function(l){Z(null,f,null,function(m){l(m)})}),2)}g=h.j;e.debug&&K.log("[DVA] Get light weight results. req=",f,", resp=",g);return h.return(g)})};
yq.prototype.h=function(a,b,c,d){var e=this,f,g;return J(function(h){if(1==h.h){if(!e.zb)return h.return({error:"empty video URL"});a=Math.round(2*a)/2;f={recipient:"dynVideoAnalysis",type:"getServerAssist",data:{zb:e.zb,Uf:document.URL,timestamp:a,ck:b,interval:c,Gp:d,sn:!0}};return y(h,new Promise(function(l){Z(null,f,null,function(m){l(m)})}),2)}g=h.j;e.debug&&K.log("[DVA] Get full results. req=",f,", resp=",g);return h.return(g)})};
function tq(a,b){this.video=a;this.debug=b;this.A&&K.log("[DVA][VideoControl] Construct.");this.j=!1;this.td=this.l=void 0;this.o=a.muted;this.v=function(c){c.target.muted=!0}}function uq(a,b){a.h=b}
tq.prototype.restore=function(a,b){this.A&&K.log("[DVA][VideoControl] Restore. ts=",a,", options=",b);var c=this.video;b||(b={});this.j&&(this.video.muted=this.o);b.ks||(this.A&&K.log("[DVA] Unblur."),c.style.filter="blur()");this.video.onvolumechange=void 0;this.j&&this.h&&this.h.ek&&this.h.ek({xb:this.l,ua:a,td:this.td,Vf:this.Vf});this.j=!1;this.Vf=this.l=void 0};function Wp(a,b){this.id=Bq++;this.Ce=!1;this.We=a;this.zb=void 0;this.Re=0;this.ta=new Xp(b);this.ql=!1}var Bq=1;
function hq(a){this.id=Cq++;this.Ce=!1;this.Re=0;this.ta=new Xp(a);this.ql=!1}var Cq=1;function jp(a){this.B=a}var kp;
function lp(a,b){var c=kp;b=void 0===b?{}:b;var d,e,f,g;return J(function(h){if(!c.B.enabled)return h.return(Promise.reject("DAB is not enabled."));10240<=a.length&&(c.debug&&K.log("Text too long ("+a.length+"b), truncating ..."),d=a.substr(0,10240),e=d.lastIndexOf(" "),f=d.substr(e),2>Math.round((new Blob([f])).size/f.length)&&(d=d.substring(0,e)),a=d);g={recipient:"dynAntiBullyAnalysis",type:"classify",data:{text:a,options:b,url:document.URL,Ba:document.title}};g.data.Ba&&g.data.Ba.trim()||(g.data.Ba=
location.hostname);return h.return(new Promise(function(l){Z(null,Xa(hb,g),null,function(m){l(U(jb,m))})}))})}function Dq(a){this.B=a;this.debug=a.debug;this.v=0;this.l={};this.h={};this.j={}}
Dq.prototype.onChange=function(a,b){if(a.id&&0!=a.id.trim().length&&Eq(a)){this.debug&&K.log("[Chat] onChange. elem.id=",a.id,", text=",b);b=b.trim();if(0==b.length&&this.l[a.id]&&1<this.l[a.id].length){var c=a.id,d=this.l[a.id];this.debug&&K.log("[Chat] onChatSent. elem_id=",c,", text=",d);c in this.h||(this.h[c]="");c in this.j||(this.j[c]=0);this.h[c]+=d+"\n";this.j[c]++;if(3==this.j[c]){d=this.h[c];this.debug&&K.log("[Chat] analyzeChat. text=",d);var e={body:d.substring(0,1E3)};this.v++;lp(d,
{na:"chat",hostname:location.hostname,context:e,wb:this.v});this.h[c]="";this.j[c]=0}}this.l[a.id]=b}};function Eq(a){if("TEXTAREA"==a.tagName||"DIV"==a.tagName&&"textbox"==a.getAttribute("role"))return!0}
function Fq(a,b){var c={};b=t(b.querySelectorAll("textarea,div"));for(var d=b.next();!d.done;c={Sc:c.Sc},d=b.next())c.Sc=d.value,Eq(c.Sc)&&"yes"!=c.Sc.getAttribute("dld-mark")&&(a.debug&&K.log("[Chat] Register input.",c.Sc),c.Sc.setAttribute("dld-mark","yes"),(new MutationObserver(function(e){return function(f){f=t(f);for(var g=f.next();!g.done;g=f.next());a.onChange(e.Sc,"DIV"==e.Sc.tagName?e.Sc.innerText:e.Sc.innerHTML)}}(c))).observe(c.Sc,{characterData:!0,subtree:!0,childList:!0}))}
Dq.prototype.o=function(a){a=t(a);for(var b=a.next();!b.done;b=a.next())if(b=b.value,"childList"==b.type){b=t(b.addedNodes);for(var c=b.next();!c.done;c=b.next())c=c.value,1==c.nodeType&&Fq(this,c)}};function Gq(a){this.B=a;this.debug=a.debug}function Hq(a){var b=a.getAttribute("aria-label")||"";return"button"==a.getAttribute("role")&&(b.startsWith("Send")||b.startsWith("\u50b3\u9001"))?!0:!1}
function Iq(a,b){b=t(b.getElementsByTagName("div"));for(var c=b.next();!c.done;c=b.next())if(c=c.value,Hq(c)&&"yes"!=c.getAttribute("dld-mark")){a.debug&&(c.style.border="solid thick #FF0000",K.log("[Gmail] Register button.",c.outerHTML));c.setAttribute("dld-mark","yes");c.addEventListener("click",function(d){a.debug&&K.log("[Gmail] onClick. event=",d);var e={};a:{var f=t(document.body.getElementsByTagName("div"));for(var g=f.next();!g.done;g=f.next()){g=g.value;var h=g.getAttribute("aria-label");
if("textbox"==g.getAttribute("role")&&("Message Body"==h||"\u90f5\u4ef6\u5167\u6587"==h)){a.debug&&(g.style.border="solid thick #FF0000");f=Mn.mq.jg(g);f=f.replace(/[\n\t ]+/g," ");a.debug&&K.log("[Gmail] Found body:",f,", bodyHtml:",g.innerHTML);f={body:f,Eh:g.innerHTML};break a}}f=void 0}if(f){e.body=f.body;e.Eh=f.Eh;for(f=d.target.parentElement;f&&f!=document.body&&"presentation"!=f.getAttribute("role");f=f.parentElement);if(f&&f!=document.body){a:{d=t(f.getElementsByTagName("input"));for(g=d.next();!g.done;g=
d.next())if(g=g.value,h=g.getAttribute("aria-label"),"subjectbox"==g.name&&("Subject"==h||"\u4e3b\u65e8"==h)){a.debug&&(g.style.border="solid thick #00FF00");a.debug&&K.log("[Gmail] Found subject:",g.value);d=g.value;break a}d=void 0}e.Qe=d;d=[];f=t(f.getElementsByTagName("input"));for(g=f.next();!g.done;g=f.next())if(g=g.value,"combobox"==g.getAttribute("role")){for(g=g.parentElement;g&&g!=document.body&&"TABLE"!=g.tagName;g=g.parentElement);if(g&&g!=document.body)for(a.debug&&(g.style.border="solid thin #0000FF"),
g=t(g.getElementsByTagName("DIV")),h=g.next();!h.done;h=g.next())if(h=h.value,"option"==h.getAttribute("role")&&(h=h.getAttribute("data-hovercard-id")))d.push(h),a.debug&&K.log("[Gmail] Add recipient:",h)}0==d.length&&d.push("No recipient entered");e.Of=d}a.debug&&K.log("[Gmail] Sending for AB analysis:",e);lp(e.Qe+". "+e.body,{na:"gmail",context:e,wb:1})}});break}}
Gq.prototype.o=function(a){a=t(a);for(var b=a.next();!b.done;b=a.next())if(b=b.value,"childList"==b.type){b=t(b.addedNodes);for(var c=b.next();!c.done;c=b.next())c=c.value,1==c.nodeType&&Iq(this,c)}};function Jq(a){this.B=a;this.debug=a.debug}
Jq.prototype.o=function(a){var b=this;a=t(a);for(var c=a.next();!c.done;c=a.next())if(c=c.value,"childList"==c.type){c=t(c.addedNodes);for(var d=c.next();!d.done;d=c.next())if(d=d.value,1==d.nodeType){d=t(d.getElementsByTagName("button"));for(var e=d.next();!e.done;e=d.next())if(e=e.value,"yes"!=e.getAttribute("dld-mark")&&("Send"==(e.getAttribute("aria-label")||"")||"Send"==(e.getAttribute("name")||"")&&"menuitem"==(e.getAttribute("role")||"")||"Send"==e.innerText&&"menuitem"==(e.getAttribute("role")||
""))){this.debug&&(e.style.border="solid thick #FF0000");e.setAttribute("dld-mark","yes");e.addEventListener("click",function(){for(var f={},g=t(document.body.getElementsByTagName("div")),h=g.next();!h.done;h=g.next())if(h=h.value,"textbox"==h.getAttribute("role")&&"Message body"==h.getAttribute("aria-label")){b.debug&&(h.style.border="solid thick #FF0000");f.body=h.innerText;f.Eh=h.innerHTML;break}g=t(document.body.getElementsByTagName("input"));for(h=g.next();!h.done;h=g.next())if(h=h.value,"Add a subject"==
h.getAttribute("aria-label")){b.debug&&(h.style.border="solid thick #FF0000");f.Qe=h.value;break}g=t(document.body.getElementsByTagName("div"));for(h=g.next();!h.done;h=g.next())if(h=h.value,["To","Cc","Bcc"].includes(h.innerText)){for(h=h.parentElement;h&&h!=document.body&&"Content pane"!=h.getAttribute("aria-label");h=h.parentElement);if(h&&h!=document.body)for(b.debug&&(table.style.border="solid thick #0000FF"),f.Of=[],h=t(h.getElementsByTagName("div")),g=h.next();!g.done;g=h.next())g=g.value,
"listitem"==(g.getAttribute("role")||"")&&(g=g.getAttribute("aria-label"))&&f.Of.push(g);break}lp(f.Qe+". "+f.body,{na:"office365",context:f,wb:1})});break}}}};function Kq(a){var b=this;if(a.enabled){this.B=a;this.debug=a.debug;this.j=!1;this.l=a.Ph||1E4;this.h=[];this.fi=0;this.o=Date.now();var c=!1;this.debug&&K.log("[DGM] Init.",document.URL);Jn().then(function(){var d,e;return J(function(f){c=!0;d=new MutationObserver(function(g){g=t(g);for(var h=g.next();!h.done;h=g.next())if(h=h.value,"childList"==h.type){h=t(h.addedNodes);for(var l=h.next();!l.done;l=h.next())1==l.value.nodeType&&(c=!0)}});e={childList:!0,subtree:!0};d.observe(document,e);A(f)})});
setInterval(function(){if(c){b.debug&&K.log("[DGM] Scan for canvases.");try{for(var d=t(document.body.getElementsByTagName("CANVAS")),e=d.next();!e.done;e=d.next())Lq(b,e.value);for(var f=t(document.body.getElementsByTagName("*")),g=f.next();!g.done;g=f.next()){var h=g.value;if(h.shadowRoot){var l=t(h.shadowRoot.querySelectorAll("CANVAS"));for(e=l.next();!e.done;e=l.next())Lq(b,e.value)}}}catch(m){K.error("Error finding canvases.",m)}c=!1}},3E3)}}
function Lq(a,b){function c(f){this.nm=!0;this.xj[f]++}var d,e;J(function(f){if(a.h.includes(b))return f.return();a.h.push(b);a.debug&&(d=b.getBoundingClientRect(),K.log("[DGM] Found canvas id: "+b.id+", size: "+d.width+"x"+d.height+", pos: "+d.top+","+d.left));if(!a.j){a.xj={key:{},mousedown:0,mousemove:0};window.addEventListener("keydown",function(g){a.nm=!0;var h=a.xj.key;g=g.key;" "==g&&(g="Space");h[g]?h[g]++:h[g]=1});a.j=!0;setInterval(function(){a.nm&&(a.nm=!1,Z(null,{recipient:"dynGamesAnalysis",
type:"inputStats",data:{url:document.URL,gf:a.xj,nl:Date.now()-a.o,fi:a.fi}},null,function(g){g&&g.og&&Mq(a,g.context)}),a.xj={key:{},mousedown:0,mousemove:0})},a.l);try{e=new URL(window.top.location.href),"www.google.com"==e.hostname&&(e.search&&e.search.includes("doodle")||"/search"==e.pathname||e.pathname.startsWith("/doodles/")||e.pathname.startsWith("/logos/doodles/")||e.pathname.includes("/cricket"))&&setInterval(function(){Mq(a,{input:[],V:0})},3E4)}catch(g){}}b.addEventListener("mousedown",
function(){c.apply(a,["mousedown"])});b.addEventListener("mousemove",function(){c.apply(a,["mousemove"])});b.addEventListener("touchstart",function(){c.apply(a,["mousedown"])});b.addEventListener("touchmove",function(){c.apply(a,["mousemove"])});A(f)})}function Mq(a,b){var c,d,e;J(function(f){c=t(a.h);for(d=c.next();!d.done;d=c.next())e=d.value,a.og(e,b);A(f)})}
Kq.prototype.og=function(a,b){var c=this,d,e,f,g,h;return J(function(l){if(1==l.h){if(!c.B.Dh&&3<=c.fi)return l.return(!1);c.fi++;d={width:640,height:480,format:"jpg"};(e=wn(a,d))&&xn(e)&&(c.debug&&K.log("[DGM] The image is all black."),e=void 0);f={recipient:"dynGamesAnalysis",type:"analyzeImages",data:{url:document.URL,image:e,Dh:c.B.Dh,context:b}};e||(K.warn("[DGM] Cannot get canvas image, most likely CORS issue."),f.data.position=a.getBoundingClientRect());return y(l,new Promise(function(m){Z(null,
f,null,function(n){m(n)})}),2)}g=l.j;c.debug&&K.log("[DGM] Got image analysis result.",g);g&&"game"==g.label&&c.B.Dh&&(h={L:"dyngm",F:c.B.F,Vs:{mt:g.V,rt:b.V,st:b.input}},h.W=[{name:"image",value:e}],Hn(Mn,[118],h,g.Dk));A(l)})};function Nq(a){var b=this;this.B=a;12==Q.platform&&chrome.runtime.onMessage.addListener(function(c,d,e){return b.onMessage(c,d,e)});this.h=new Oq;(a.Tu||12!=Q.platform)&&this.h.start()}
Nq.prototype.onMessage=function(a){"classroom"==a.recipient&&("teacherConnectionChange"==a.type?(window==window.top&&window.postMessage({type:"dldTeacherConnectionChange",count:a.data.Ip},"*"),0<a.data.Ip?this.h.start():this.h.stop()):"annotateScreen"==a.type&&window==window.top&&(K.log("[CLM] Annotate screen. data=",a.data),Pq(a.data)))};
function Pq(a){try{var b=Qq(a);b&&setTimeout(function(){document.body.removeChild(b)},12E3);var c=Rq(a);c&&setTimeout(function(){document.body.removeChild(c)},2E3)}catch(d){K.error("[CLM] Annotate screen error.",d)}}
function Rq(a){var b=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,d=document.createElement("div");d.innerText="Teacher "+a.eh+" is annotating";d.style.display="block";d.style.position="fixed";d.style.zIndex="100000";d.style.pointerEvents="none";d.style.top=c*a.positionY[0]+"px";d.style.left=b*a.positionX[0]+"px";d.style.fontSize="1em";d.style.color=a.color.startsWith("rgba(255,255,255")?
"black":a.color;d.style.backgroundColor="white";d.style.borderRadius=".4em";d.style.borderStyle="solid";d.style.borderColor=a.color;d.style.borderWidth=".15em";d.style.padding=".3em .7em .3em .7em";d.style.boxShadow=".3em .3em .3em gray";document.body.appendChild(d);return d}
function Qq(a){var b=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;K.log("[CLM] Window width=",b,", window height=",c);var d=document.createElement("canvas");d.width=b;d.height=c;d.style.display="block";d.style.position="fixed";d.style.zIndex="100000";d.style.width="100%";d.style.height="100%";d.style.top="0px";d.style.left="0px";d.style.bottom="0px";d.style.right="0px";d.style.backgroundColor=
"rgba(0,0,0,0)";d.style.pointerEvents="none";if(d.getContext){var e=d.getContext("2d");e.beginPath();if(1<a.positionX.length){e.moveTo(b*a.positionX[0],c*a.positionY[0]);for(var f=1;f<a.positionX.length;f++)e.lineTo(b*a.positionX[f],c*a.positionY[f]);e.lineWidth=a.size*b;e.lineCap="round";e.lineJoin="round";e.strokeStyle=a.color;e.stroke()}else e.arc(b*a.positionX[0],c*a.positionY[0],a.size*b/2,0,2*Math.PI),e.fillStyle=a.color,e.fill();document.body.appendChild(d);return d}}
function Oq(){var a=this;this.enabled=!1;this.frameId=Mn.frameId;this.interval=3E3;this.h={};window==window.top&&(this.md=this.Uc=!1,window.addEventListener("message",function(b){(b=b.data)&&"dldAvMonitor"==b.recipient&&"avStatusChange"==b.type&&b.data.frameId&&(b=b.data,b.Uc||b.md?a.h[b.frameId]=b:delete a.h[b.frameId],Sq(a))}))}
Oq.prototype.start=function(){var a=this,b,c,d,e,f,g,h,l,m;return J(function(n){if(1==n.h){if(a.enabled)return n.m(0);a.enabled=!0;c=b=!1;a.url=void 0}if(!a.enabled)return n.m(0);e=d=!1;f=t(document.getElementsByTagName("audio"));for(g=f.next();!g.done;g=f.next())if(h=g.value,!h.paused){d=!0;break}l=t(document.getElementsByTagName("video"));for(g=l.next();!g.done;g=l.next())if(m=g.value,!m.paused){e=!0;break}if(a.url!=document.URL||b!=d||c!=e)b=d,c=e,Tq(a,b,c);a.url=document.URL;return y(n,new Promise(function(q){setTimeout(q,
a.interval)}),3)})};Oq.prototype.stop=function(){this.enabled=!1;window==window.top&&(this.md=this.Uc=!1)};function Tq(a,b,c){b={frameId:a.frameId,Uc:b,md:c,expiration:Date.now()+a.interval};window!=window.top?window.top.postMessage({recipient:"dldAvMonitor",type:"avStatusChange",data:b},"*"):(a.h[a.frameId]=b,Sq(a))}
function Sq(a){if(window==window.top){for(var b=Date.now(),c=!1,d=!1,e=t(Object.keys(a.h)),f=e.next();!f.done;f=e.next()){f=f.value;var g=a.h[f];g.expiration<b?delete a.h[f]:(c=c||g.Uc,d=d||g.md)}if(a.url!=document.URL||a.Uc!=c||a.md!=d)a.Uc=c,a.md=d,Z(null,{recipient:"classMgmt",type:"avStatusChange",data:{title:document.title,url:document.URL,Uc:a.Uc,md:a.md}})}};function Uq(a){var b=this;new Promise(function(){var c,d,e,f,g,h,l,m,n,q,u,r,p,v,w,z,B,D,E,G,M,T,O,R,N,Y,W,X,L,I,P,ha,ma;return J(function(aa){switch(aa.h){case 1:return C(aa,2),y(aa,new Promise(function(V){"loading"!=document.readyState?V():document.addEventListener("DOMContentLoaded",function(){V()})}),4);case 4:d=0;case 5:if(!(3>d)||c){if(!c)throw Error("Get chat unsuccessful.");if(c){f=c.className;g=c.chats;h=c.teachers;l=["#F4C524","#F05542","#2D78D3","#5ACAFA"];if(g&&0<g.length){m=document.createDocumentFragment();
for(n=0;n<g.length;n++)q=g[n],u=document.createElement("div"),r=q.msg,p=q.tname,v=Math.round(Date.now()/1E3)-q.time,w=void 0,z=document.createElement("div"),z.className="sendTime",z.textContent=60>v?"Now":Math.round(v/60)+" mins ago",B=p.split(/[\s.]+/).map(function(V){return V[0]}).join("").toUpperCase(),q["in"]?(w="left",D=document.createElement("div"),D.className="tname",D.textContent=p,E=document.createElement("div"),E.className="brif",E.textContent=B,E.style.background=l[h.indexOf(p)%4],G=document.createElement("div"),
G.className="fromMsg",G.textContent=r,M=document.createElement("div"),M.appendChild(E),M.appendChild(G),u.appendChild(D),u.appendChild(M),u.appendChild(z),r=q.tname+": "+r,w="item left"):(w="right",T=document.createElement("div"),T.className="toMsg",T.textContent=r,u.appendChild(T),u.appendChild(z)),u.className=w,m.appendChild(u);O=document.getElementById("chats");O.appendChild(m);O.scrollTop=O.scrollHeight}f&&(document.getElementById("className").innerText=f);h&&(document.getElementById("member").innerText=
1<h.length?h.length+" Members":h.length+" Member");R=new Date;N=R.toString();Y=N.substring(0,N.indexOf(" ",14));document.getElementById("classdate").innerHTML=Y}(W=document.getElementById("text"))&&W.addEventListener("keyup",function(V){"Enter"!=V.key&&13!=V.keyCode||b.sendMessage(W)});if(X=document.getElementById("send"))X.onclick=function(){b.sendMessage(W)};if(L=document.getElementById("cancel"))L.onclick=function(){W.value=""};(I=document.getElementsByClassName("sendform"))&&0<I.length&&a&&(I[0].style.display=
"none");F(aa,0);break}C(aa,8);return y(aa,new Promise(function(V){Z({recipient:"classMgmt",type:"getChatHistory"},function(na){V(na)})}),10);case 10:c=aa.j;F(aa,9,2);break;case 8:e=H(aa,2),K.error("Exception while getting chat history. "+e);case 9:if(c){aa.m(6);break}return y(aa,new Promise(function(V){setTimeout(V,500)}),6);case 6:d++;aa.m(5);break;case 2:P=H(aa),ha=document.getElementById("chats"),ma=document.createTextNode("Load msg error: "+P),ha.appendChild(ma),A(aa)}})})}
Uq.prototype.sendMessage=function(a){Z({recipient:"classMgmt",type:"chatReply",data:{text:a.value}},function(){window.location.reload()})};function Vq(){K.log("[BPF] Loaded.");Ta.addListener(function(a){"blockingPageFront"===a.recipient&&"blockingGuidelineChanged"===a.type&&(a=new URL(window.location.href),a=(new URLSearchParams(a.search)).get("site"),K.log("[BPF] Blocking guideline changed. Redirecting to",a),location.replace(a))},["blockingGuidelineChanged"])}
function Wq(){new Promise(function(){var a,b,c,d;return J(function(e){if(1==e.h)return C(e,2),y(e,new Promise(function(f){"loading"!=document.readyState?f():document.addEventListener("DOMContentLoaded",function(){f()})}),4);if(2!=e.h){K.log("[1568] UnblockRequest loaded.");a=new URL(window.location.href.replace(/#/g,"%23"));b=new URLSearchParams(a.search);c=document.getElementById("unblockreq");if(!c)return e.return();c.onclick=function(){var f=b.get("uburl");if(null!==f&&""!==f){var g={recipient:"vendorMisc",
type:"unblockUrl",data:{studentEmail:b.get("uid"),studentOu:b.get("ou"),studentGroups:b.get("groups"),url:b.get("site"),category:b.get("category"),intchk:b.get("intchk")}};Z(g,function(h){K.log("[1568] Got unblock response.",h);if(h&&h.error){var l=document.getElementById("responseMessage");l&&(l.innerText=h.error,c.disabled=!0)}else h&&h.handover?K.log("[1568] Handovered for requesting to unblock."):(h={student_email:b.get("uid"),student_ou:b.get("ou"),student_groups:b.get("groups"),url:b.get("site"),
category:b.get("category")},h=encodeURIComponent(btoa(JSON.stringify(h))),h=f+"?token="+h,window.open(h,"_blank")||window.open(h,"_self"))})}};return F(e,0)}d=H(e);K.error("[1568] UnblockRequest error.",d);A(e)})})}
function Xq(){new Promise(function(){var a,b,c,d,e;return J(function(f){if(1==f.h)return C(f,2),y(f,new Promise(function(g){"loading"!=document.readyState?g():document.addEventListener("DOMContentLoaded",function(){g()})}),4);if(2!=f.h)return K.log("[1138] UnblockRequestClass loaded."),a=new URL(window.location.href),b=new URLSearchParams(a.search),c=document.getElementById("unblockreq"),d=document.getElementById("responseMessage"),c&&d&&(c.onclick=function(){var g=b.get("site"),h="school"==b.get("pgroup")?
"policy":"session",l=Math.floor(1E6*Math.random());g&&(Ta.addListener(function(m){"UnblockRequestClass"===m.recipient&&"unblockUrlClassResponse"===m.type&&(K.log("[1138] Got unblock response.",m),m.data.Bm==l&&(d.innerText=m.data.message))},["unblockUrlClassResponse"]),g={recipient:"classMgmt",type:"unblockUrlClass",data:{msgId:l,url:g,mode:h,studentId:b.get("uid"),studentOu:b.get("ou"),studentGroups:b.get("groups"),category:b.get("category"),intchk:b.get("intchk")}},99==Q.platform&&(g.tabId=Va.tabId),
K.log("[1138] Send unblock message.",g),Z(g,function(m){K.log("[1138] Got unblock response.",m);m&&m.error?d.innerText=m.error:d.innerText="The request has been sent. You will be notified when the teacher makes a decision."}),c.disabled=!0)}),F(f,0);e=H(f);K.error("[1138] UnblockRequestClass error.",e);A(f)})})};function Yq(){var a=this;12==Q.platform&&chrome.runtime.onMessage.addListener(function(b,c,d){return a.onMessage(b,c,d)})}Yq.prototype.onMessage=function(a){"modal"===a.recipient&&"showNotification"===a.type&&Zq(a.data.text)};function br(){var a=document.getElementById("dld-notification");a&&a.remove()}
function Zq(a){br();document.body.insertAdjacentHTML("beforebegin",'<div id="dld-notification" style="width: 100%;position: fixed;height: 100%;z-index: 2147483645;">\n    <div style="opacity: 50%;background-color: black;width: 100%;height: 100%;z-index: 2147483646;position: fixed;"></div>\n    <div style="width: 400px;min-height: 160px;top: calc(50% - 100px);left: calc(50% - 200px);position: fixed;background-color: white;border-radius: 16px;box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.35);font-family: Montserrat;font-weight: 500;padding: 30px 30px;display: flex;justify-content: center;z-index: 2147483647;align-items: center;flex-wrap: wrap;">\n      <div style="text-align: left;height: 65%;display: flex;align-items: center;flex: 0 0 100%;justify-content: center;">\n        <p style="font-size: 14px;line-height: 21px;margin-bottom: 0px;color:black;">'+a+
'</p>\n      </div>\n        \n      <div style="height: 25%;margin-top: 10px;">\n        <button id="dld-notification-btn-ok" role="button" style="width: 62px;height: 41px;border-radius: 100px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;padding: .375rem .75rem;font-size: 1rem;line-height: 1.5;transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;color: #fff;background-color: #007bff;border-color: #007bff;cursor:pointer;">\n          OK\n        </button>\n      </div>\n    </div>\n    </div>');
document.getElementById("dld-notification").style.height=window.outerHeight+"px";document.getElementById("dld-notification-btn-ok").onclick=function(){document.getElementById("dld-notification").remove()}};function cr(){var a={plantCookieSites:{},adSites:{},isBlockCookie:!0,isBlockAds:!0};window.self===window.top&&chrome.runtime.onMessage.addListener(function(b,c,d){"plantCookies"==b.type&&(a.plantCookieSites[b.data.domain]=b.data,a.isBlockCookie=b.data.isBlockCookie,d&&d(a));"trackAds"==b.type?(a.adSites[b.data.domain]=b.data,a.isBlockAds=b.data.isBlockAds,d&&d(a)):"getCookieStats"==b.type&&d&&d(a)})};function dr(){for(var a=t(document.getElementsByTagName("A")),b=a.next();!b.done;b=a.next())b=b.value,b.getAttribute("ping")&&b.removeAttribute("ping")};function er(){this.init()}
er.prototype.init=function(){var a=this;Z(null,{recipient:"debugTool",type:"getDiagInfo"},null,function(b){if(b&&b.disabled){var c=document.getElementById("prodArea");c&&(c.style.display="none");if(c=document.getElementById("extDisabled"))c.style.display="block"}else if(b){b.policy.Zb&&b.policy.Zb&&(document.getElementById("custName")?document.getElementById("custName").innerHTML=b.policy.Zb:document.getElementById("cust")&&(document.getElementById("cust").style.display="none"));!b.runtime.group||
b.runtime.groups||b.runtime.tn||(b.runtime.groups=b.runtime.group);if(b.runtime.groups){var d=document.getElementById("groupName");if(d){var e=b.runtime.groups;"object"==typeof e&&3<e.length?(d.innerHTML=e.slice(0,3).toString()+'<br><a id="showall" href="#">Show all</a>',document.getElementById("showall").onclick=function(){d.innerHTML=e}):d.innerHTML=b.runtime.groups}}else document.getElementById("group")&&(document.getElementById("group").style.display="none");document.getElementById("ouName")&&
(document.getElementById("ouName").innerHTML=b.runtime.tn);document.getElementById("userOuDiv")&&!b.runtime.tn&&(document.getElementById("userOuDiv").style.display="none");document.getElementById("ruleName")&&(document.getElementById("ruleName").innerHTML=b.policy.F||"Default Rule");document.getElementById("userName")&&(document.getElementById("userName").innerHTML=b.runtime.Va);if((b.policy.qj||b.policy.Il)&&document.getElementById("classroom")){document.getElementById("classroom").style.display=
"table-row";if(c=document.getElementById("session"))c.style.display="table-row";if(b.policy.qj){if(c=document.getElementById("className"))c.innerHTML=b.policy.qj.className;if(c=document.getElementById("sessionName"))c.innerHTML=b.policy.qj.Y}else b.policy.Il&&(c=document.getElementById("className"))&&(c.innerHTML=b.policy.Il)}document.getElementById("ipAddrs")&&(c=b.runtime.ba,document.getElementById("ipAddrs").innerHTML=c?c.join(", "):"");(c=document.getElementById("raiseHandButton"))&&b.$g.sp&&
(c.style.display="block",c.onclick=function(){Z(null,{recipient:"classMgmt",type:"raiseHand"});window.close()});(c=document.getElementById("sendMsgButton"))&&b.$g.sp&&b.policy.Bh&&(c.style.display="block",c.onclick=function(){if(12==Q.platform){var q={recipient:"classMgmt",type:"chatWindow",data:{}};new Promise(function(u){Z(null,q,function(){window.close();u()})})}else window.open(b.$g.Xc,"_blank","width=350,height=200,menubar=no,resizable=no,toolbar=no,status=no"),window.close()});c=b.sc.model;
document.getElementById("dvaModel")&&(document.getElementById("dvaModel").innerHTML=c.substr(0,10));c=b.sc.N;document.getElementById("dvaCloud")&&(document.getElementById("dvaCloud").innerHTML=c&&c.avgResponseTime?800>=c.avgResponseTime?"good":1500>=c.avgResponseTime?"fair":"poor":"unknown");if(c=document.getElementById("homeUserLogout"))c.onclick=function(){var q;return J(function(u){if(1==u.h)return q={recipient:"debugTool",type:"switchUser",data:{}},y(u,new Promise(function(r){Z(null,q,function(){r()})}),
2);window.close();A(u)})};if(c=document.getElementById("logoutGoogleButton"))c.style.display=b.G.Lu?"inline":"none",c.onclick=function(){var q,u;return J(function(r){if(1==r.h)return q=b.G.Ht,u={recipient:"debugTool",type:"switchUser",data:{}},y(r,new Promise(function(p){Z(null,u,function(){p()})}),2);q?window.close():window.open(b.G.zd+(b.policy.zf||"about:blank"));A(r)})};document.getElementById("version")&&(document.getElementById("version").innerHTML=b.runtime.version);document.getElementById("policyVersion")&&
document.getElementById("policyVer")&&b.policy.vb&&(document.getElementById("policyVer").style.display="table-row",document.getElementById("policyVersion").innerHTML=b.policy.vb);document.getElementById("uuid")&&(document.getElementById("uuid").innerHTML=b.runtime.uuid);document.getElementById("serverPath")&&(document.getElementById("serverPath").value=b.debug.en);document.getElementById("serverConsolePath")&&(document.getElementById("serverConsolePath").value=b.debug.gq);document.getElementById("webrtc")&&
(c=document.getElementById("rtcStatus"),c.innerHTML=b.$g.qp,c=document.getElementById("rtcConnect"),"connected"==b.$g.qp&&(c.innerHTML="Disconnect"),c.onclick=function(q){Z({recipient:"classMgmt",type:"Connect"==q.target.innerHTML?"connect":"disconnect"})},c=document.getElementById("rtcTeacher"),c.innerHTML=b.$g.Uu);var f=["dcmTaLowRadio","dcmTaMedRadio","dcmTaHighRadio"],g=["dcmIaLowRadio","dcmIaMedRadio","dcmIaHighRadio","dcmIaVeryHighRadio"],h=["dcmVaLowRadio","dcmVaMedRadio","dcmVaHighRadio",
"dcmVaVeryHighRadio"];c=function(){for(var q,u,r,p=t(f),v=p.next();!v.done;v=p.next())if((v=document.getElementById(v.value))&&v.checked){q=v.value;break}p=t(g);for(v=p.next();!v.done;v=p.next())if((v=document.getElementById(v.value))&&v.checked){u=v.value;break}p=t(h);for(v=p.next();!v.done;v=p.next())if((v=document.getElementById(v.value))&&v.checked){r=v.value;break}Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setIAEngine",yg:q,hf:u,jf:r}})};for(var l=t(f),m=l.next();!m.done;m=
l.next())if(m=document.getElementById(m.value))m.value==b.Vd.yg&&(m.checked=!0),m.onchange=c;l=t(g);for(m=l.next();!m.done;m=l.next())if(m=document.getElementById(m.value))m.value==b.ra.hf&&(m.checked=!0),m.onchange=c;l=t(h);for(m=l.next();!m.done;m=l.next())if(m=document.getElementById(m.value))m.value==b.sc.jf&&(m.checked=!0),m.onchange=c;document.getElementById("refreshPolicyButton")&&(document.getElementById("refreshPolicyButton").onclick=function(){Z(null,{recipient:"debugTool",type:"refreshPolicy"});
window.close()});(c=document.getElementById("gendiagButton"))&&99===Q.za&&!Q.sa&&(c.style.display="inline",c.onclick=function(){Z(null,{recipient:"debugTool",type:"generateDiag"},function(q){q.error?alert(q.error):chrome.downloads.download({url:"data:text/plain;base64,"+btoa(q.results),filename:"diag.txt",conflictAction:"overwrite"})})});var n=document.getElementById("supportCmdButton");n&&(n.onclick=function(q){if("enter"===n.getAttribute("d-support-cmd-status"))q.target.innerHTML="Send command",
n.setAttribute("d-support-cmd-status","send"),document.getElementById("supportCmdArea").style.display="block";else try{var u={recipient:"debugTool",type:"runBatchCommand",data:document.getElementById("supportCmd").value};document.getElementById("supportCmd").value="";Z(null,u,null,function(r){if(r.error)a.je(r.error);else{var p="";r=t(r.results);for(var v=r.next();!v.done;v=r.next())if(v=v.value)p+=(v.error||v.warning||v.info||"Ok")+"; ","showLogs"==v.action&&a.vi(v);a.je(p);a.init()}})}catch(r){a.je("Invalid command: "+
r)}});b.zg||(document.getElementById("devArea")&&(document.getElementById("devArea").style.display="block"),document.getElementById("uuiddiv")&&(document.getElementById("uuiddiv").style.display="table-row"),2<=b.G.op&&document.getElementById("video")&&(document.getElementById("video").style.display="table-row"),document.getElementById("ip")&&(document.getElementById("ip").style.display="table-row"));document.getElementById("debugButton")&&(document.getElementById("debugButton").onclick=function(){return fr(a)});
document.getElementById("showLogsButton")&&(document.getElementById("showLogsButton").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"showLogs"}},null,function(q){a.vi(q)})});document.getElementById("serverPathButton")&&(document.getElementById("serverPathButton").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setServerPath",path:document.getElementById("serverPath").value,Kh:document.getElementById("serverConsolePath").value}});alert("Restart the extension for this change to take effect")});
document.getElementById("logout")&&(document.getElementById("logout").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"logoutCustomer"}});window.close()});document.getElementById("clearLS")&&(document.getElementById("clearLS").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"clearLocalStorage"}});window.close()});Q.wa||chrome.tabs.query({active:!0,currentWindow:!0},function(q){(q=q[0])&&chrome.tabs.sendMessage(q.id,{type:"getCookieStats"},
function(u){if(u){var r=Object.keys(u.plantCookieSites),p=Object.keys(u.adSites);if(0<r.length+p.length){var v="";if(u.isBlockCookie&&u.isBlockAds){v=r.concat(p.filter(function(z){return 0>r.indexOf(z)}));var w='<span>We blocked </span><span style="color:rgba(235,73,83,1);">'+v.length+" site(s)</span><span> that attempted to track you and/or display ads on this page:</span>";v=w+'<div style="margin-top:10px;color:#6F6F6F;">'+v.sort(function(z,B){return z<B?-1:1}).join("<br>")+"</div>"}else 0<r.length&&
(w=u.isBlockCookie?'<span>We blocked </span><span style="color:rgba(235,73,83,1);">'+r.length+" site(s)</span><span> that attempted to track you on this page:</span>":'<span style="color:rgba(235,73,83,1);">'+r.length+" site(s)</span><span> are tracking you on this page:</span>",v=w+'<div style="margin-top:10px;color:#6F6F6F;">'+r.sort(function(z,B){return z<B?-1:1}).join("<br>")+"</div>"),0<p.length&&(w=u.isBlockAds?'<span>We blocked </span><span style="color:rgba(235,73,83,1);">'+p.length+" site(s)</span><span> that attempted to display ads and probably track you on this page:</span>":
'<span style="color:rgba(235,73,83,1);">'+p.length+" site(s)</span><span> are displaying ads and probably tracking you on this page:</span>",v=(""==v?"":v+"<br>")+w+'<div style="margin-top:10px;color:#6F6F6F;">'+p.sort(function(z,B){return z<B?-1:1}).join("<br>")+"</div>");w=document.getElementById("trackArea");w.style.display="block";w.innerHTML='<div style="margin-top:10px;margin-bottom:10px;text-align:center;font-family:sans-serif CondensedBlack;font-size: 16px;color: rgba(72,157,252,1);letter-spacing: 0.1px;">We Protect Your Privacy</div>'+
v}}})})}})};function fr(a){var b=!1;document.getElementById("logAtRestart")&&(b=document.getElementById("logAtRestart").checked);var c="";document.getElementById("debugModules")&&(c=document.getElementById("debugModules").value);Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setDebugFlags",vm:b,Lh:c}},null,function(d){a.je(d.error||d.warning||d.info||"Ok")})}
er.prototype.vi=function(a){if(!a.error){var b=window.open("").document;b.write("<html><head><title>"+Q.fh+" logs</title></head>");b.write("<body><font size='+1'><pre>");a=t(a.Bp);for(var c=a.next();!c.done;c=a.next()){c=c.value;var d=void 0;c.includes(" WARN ")?d="orange":c.includes(" ERROR ")&&(d="red");d&&b.write("<font color="+d+">");b.write(c+"\n");d&&b.write("</font>")}b.write("</pre></font></body></html>")}};
er.prototype.je=function(a){document.getElementById("statusBar")&&(document.getElementById("statusBar").innerHTML=a)};function gr(a){Q.Jg(a);Q.ce=!0;Va=new dk;K=window.console;document.addEventListener("DOMContentLoaded",function(){new er;var b=navigator.language||navigator.h;"zh-TW"!==b&&(b="en");var c="d-trans-"+b;document.querySelectorAll("["+c+"]").forEach(function(d){d.innerHTML=d.getAttribute(c)})})}Q.Sj()||"undefined"==typeof chrome?Q.Cg("__dld_popupEdu",gr):gr();function hr(){this.init()}
hr.prototype.init=function(){var a=this;Z(null,{recipient:"debugTool",type:"getDiagInfo"},null,function(b){if(b&&b.disabled){if(b=document.getElementById("prodArea"))b.style.display="none";if(b=document.getElementById("extDisabled"))b.style.display="block"}else if(b){var c=b.G.mode;if("active"!=c)document.getElementById("cust")&&(document.getElementById("cust").style.display="none"),document.getElementById("user")&&(document.getElementById("user").style.display="none"),document.getElementById("group")&&(document.getElementById("group").style.display=
"none"),document.getElementById("rule")&&(document.getElementById("rule").style.display="none"),document.getElementById("ip")&&(document.getElementById("ip").style.display="none"),document.getElementById("video")&&(document.getElementById("video").style.display="none"),document.getElementById("uuiddiv")&&(document.getElementById("uuiddiv").style.display="none"),document.getElementById("refreshPolicyButton")&&(document.getElementById("refreshPolicyButton").style.display="none"),document.getElementById("supportCmdButton")&&
(document.getElementById("supportCmdButton").style.display="none"),document.getElementById("sensitivity")&&(document.getElementById("sensitivity").style.display="none"),document.getElementById("logoutGoogleButton")&&(document.getElementById("logoutGoogleButton").style.display="none"),document.getElementById("homeUserLogout")&&(document.getElementById("homeUserLogout").style.display="none"),document.getElementById("brmode")&&document.getElementById("homeMode")&&(document.getElementById("brmode").style.display=
"none",document.getElementById("homeMode").innerHTML="anon"==c?"Not signed in":"Subscription expired");else if(b.policy.Zb?document.getElementById("custName")&&(document.getElementById("custName").innerHTML=b.policy.Zb):document.getElementById("cust")&&(document.getElementById("cust").style.display="none"),document.getElementById("group")&&(document.getElementById("group").style.display="none"),document.getElementById("ruleName")&&(document.getElementById("ruleName").innerHTML=b.policy.F||"Default Rule"),
document.getElementById("brmode")&&(document.getElementById("brmode").style.display="table-row"),document.getElementById("homeMode").innerHTML=b.G.qu,document.getElementById("userName")&&(document.getElementById("userName").innerHTML=b.runtime.username),1<b.policy.ct&&document.getElementById("homeUserLogout")&&(document.getElementById("homeUserLogout").style.display="inline"),document.getElementById("refreshPolicyButton")&&(document.getElementById("refreshPolicyButton").onclick=function(){Z(null,
{recipient:"debugTool",type:"refreshPolicy"});window.close()}),c=document.getElementById("homeUserLogout"))c.onclick=function(){var n;return J(function(q){if(1==q.h)return n={recipient:"debugTool",type:"switchUser",data:{}},y(q,new Promise(function(u){Z(null,n,function(){u()})}),2);window.close();A(q)})};document.getElementById("version")&&(document.getElementById("version").innerHTML=b.runtime.version);var d=document.getElementById("myModal");c=document.querySelectorAll(".modalClose");for(var e=
0;e<c.length;e++)c[e].onclick=function(){d.style.display="none";document.getElementById("entSupCmd").style.display="none";document.getElementById("cmdStatus").style.display="none"};if(c=document.getElementById("supportCmdButton")){var f=document.getElementById("entSupCmd");c.onclick=function(){d.style.display="block";f.style.display="block";document.getElementById("supportCmd").value=""};document.getElementById("supCmdSend").onclick=function(){var n;return J(function(q){try{n={recipient:"debugTool",
type:"runBatchCommand",data:document.getElementById("supportCmd").value},Z(null,n,null,function(u){f.style.display="none";if(u.error)a.je(u.error);else{var r="";u=t(u.results);for(var p=u.next();!p.done;p=u.next())if(p=p.value)r&&(r+="; "),r+=p.error||p.warning||p.info||"Support command has been sent successfully","showLogs"==p.action&&a.vi(p);a.je(r);a.init()}})}catch(u){a.je("Invalid command: "+u)}A(q)})}}(c=document.getElementById("gendiagButton"))&&99===Q.za&&!Q.sa&&(c.style.display="inline",
c.onclick=function(){Z(null,{recipient:"debugTool",type:"generateDiag"},function(n){n.error?alert(n.error):chrome.downloads.download({url:"data:text/plain;base64,"+btoa(n.results),filename:"diag.txt",conflictAction:"overwrite"})})});(c=document.getElementById("uploadProxyLogButton"))&&99===Q.za&&12===Q.platform&&(c.style.display="inline",c.onclick=function(){Z(null,{recipient:"authUtil",type:"uploadProxyLog"},null,function(){window.close()})});if(!b.zg){document.getElementById("devArea")&&(document.getElementById("devArea").style.display=
"block");document.getElementById("uuiddiv")&&(document.getElementById("uuiddiv").style.display="table-row",document.getElementById("uuid")&&(document.getElementById("uuid").innerHTML=b.runtime.uuid));2<=b.G.op&&document.getElementById("video")&&(document.getElementById("video").style.display="table-row",c=b.sc.model,document.getElementById("dvaModel")&&(document.getElementById("dvaModel").innerHTML=c.substr(0,10)),c=b.sc.N,document.getElementById("dvaCloud")&&(document.getElementById("dvaCloud").innerHTML=
c&&c.avgResponseTime?800>=c.avgResponseTime?"good":1500>=c.avgResponseTime?"fair":"poor":"unknown"));document.getElementById("ip")&&(document.getElementById("ip").style.display="table-row",document.getElementById("ipAddrs")&&(c=b.runtime.ba,document.getElementById("ipAddrs").innerHTML=c?c.join(", "):""));document.getElementById("serverPath")&&(document.getElementById("serverPath").value=b.debug.en);document.getElementById("serverConsolePath")&&(document.getElementById("serverConsolePath").value=b.debug.gq);
var g=["dcmTaLowRadio","dcmTaMedRadio","dcmTaHighRadio"],h=["dcmIaLowRadio","dcmIaMedRadio","dcmIaHighRadio","dcmIaVeryHighRadio"],l=["dcmVaLowRadio","dcmVaMedRadio","dcmVaHighRadio","dcmVaVeryHighRadio"];c=function(){for(var n,q,u,r=t(g),p=r.next();!p.done;p=r.next())if((p=document.getElementById(p.value))&&p.checked){n=p.value;break}r=t(h);for(p=r.next();!p.done;p=r.next())if((p=document.getElementById(p.value))&&p.checked){q=p.value;break}r=t(l);for(p=r.next();!p.done;p=r.next())if((p=document.getElementById(p.value))&&
p.checked){u=p.value;break}Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setIAEngine",yg:n,hf:q,jf:u}})};var m=t(g);for(e=m.next();!e.done;e=m.next())if(e=document.getElementById(e.value))e.value==b.Vd.yg&&(e.checked=!0),e.onchange=c;m=t(h);for(e=m.next();!e.done;e=m.next())if(e=document.getElementById(e.value))e.value==b.ra.hf&&(e.checked=!0),e.onchange=c;m=t(l);for(e=m.next();!e.done;e=m.next())if(e=document.getElementById(e.value))e.value==b.sc.jf&&(e.checked=!0),e.onchange=c;document.getElementById("debugButton")&&
(document.getElementById("debugButton").onclick=function(){return ir(a)});document.getElementById("showLogsButton")&&(document.getElementById("showLogsButton").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"showLogs"}},null,function(n){a.vi(n)})});document.getElementById("serverPathButton")&&(document.getElementById("serverPathButton").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setServerPath",path:document.getElementById("serverPath").value,
Kh:document.getElementById("serverConsolePath").value}});alert("Restart the extension for this change to take effect")});document.getElementById("logout")&&(document.getElementById("logout").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"logoutCustomer"}});window.close()});document.getElementById("clearLS")&&(document.getElementById("clearLS").onclick=function(){Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"clearLocalStorage"}});window.close()})}Q.wa||
chrome.tabs.query({active:!0,currentWindow:!0},function(n){(n=n[0])&&chrome.tabs.sendMessage(n.id,{type:"getCookieStats"},function(q){if(q){var u=Object.keys(q.plantCookieSites),r=Object.keys(q.adSites);if(0<u.length+r.length){var p="";if(q.isBlockCookie&&q.isBlockAds){var v=u.concat(r.filter(function(w){return 0>u.indexOf(w)}));p=v.sort(function(w,z){return w<z?-1:1}).map(function(w){return"<li>"+w+"</li>"});v="<p>We blocked <span>"+v.length+" sites(s)</span> that attempted to track you and/or display ads on this page:-</p>";
p=v+"<ul>"+p.join("")+"</ul>"}else 0<u.length&&(v=q.isBlockCookie?"<p>We blocked <span>"+u.length+" sites(s)</span> that attempted to track you on this page:-</p>":"<p><span>"+u.length+" sites(s)</span> are tracking you on this page:-</p>",p=u.sort(function(w,z){return w<z?-1:1}).map(function(w){return"<li>"+w+"</li>"}),p=v+"<ul>"+p.join("")+"</ul>"),0<r.length&&(v=q.isBlockAds?"<p>We blocked <span>"+r.length+" sites(s)</span> that attempted to display ads and probably track you on this page:-</p>":
"<p><span>"+r.length+" sites(s)</span> are displaying ads and probably tracking you on this page:-</p>",q=r.sort(function(w,z){return w<z?-1:1}).map(function(w){return"<li>"+w+"</li>"}),p=(""==p?"":p+"<br>")+(v+"<ul>"+q.join("")+"</ul>"));v=document.getElementById("protectPrivacy");v.style.display="block";v.innerHTML="\t<h3>We Protect Your Privacy</h3>"+p}}})})}})};
function ir(a){var b=!1;document.getElementById("logAtRestart")&&(b=document.getElementById("logAtRestart").checked);var c="";document.getElementById("debugModules")&&(c=document.getElementById("debugModules").value);Z(null,{recipient:"debugTool",type:"runDevCommand",data:{cb:"setDebugFlags",vm:b,Lh:c}},null,function(d){a.je(d.error||d.warning||d.info||"Debug flags have been set")})}
hr.prototype.vi=function(a){if(!a.error){var b=window.open("").document;b.write("<html><head><title>"+Q.fh+" logs</title></head>");b.write("<body><font size='+1'><pre>");a=t(a.Bp);for(var c=a.next();!c.done;c=a.next()){c=c.value;var d=void 0;c.includes(" WARN ")?d="orange":c.includes(" ERROR ")&&(d="red");d&&b.write("<font color="+d+">");b.write(c+"\n");d&&b.write("</font>")}b.write("</pre></font></body></html>")}};
hr.prototype.je=function(a){document.getElementById("entSupCmd").style.display="none";document.getElementById("cmdResp").innerText=a;document.getElementById("cmdStatus").style.display="block"};function jr(a){Q.Jg(a);Q.ce=!0;Va=new dk;K=window.console;document.addEventListener("DOMContentLoaded",function(){new hr})}Q.Sj()||"undefined"==typeof chrome?Q.Cg("__dld_popupFam",jr):jr();function kr(){lr=new mr;K={log:tn,warn:vn,error:Wa}}var lr;x(kr,Zj);kr.prototype.cj=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];c=b.shift();if(0<b.length)for(c||(c=b.shift());0<b.length;){var d=b.shift();if("function"==typeof d)break;else d=void 0}c&&lr.sendMessage(c,d)};function mr(){var a=this;window._dldmsg_callback=function(b){nr(a,b)};window.addEventListener("message",function(b){or(a,b)});this.j={};this.o=0;pr(this)}
function pr(a){var b=prompt("NAPAInit","NAPAInit");if(b){try{var c=JSON.parse(b);"object"==typeof c?(a.h=c.nativeid,a.D={id:c.id,name:c.name,Cf:c.ip}):a.h=b}catch(d){a.h=b}a.h&&(a.frameId||(a.frameId=prompt("NAPAInitFrame","NAPAInitFrame")),a.l||(a.l=window.webkit.messageHandlers[a.h]))}}
mr.prototype.sendMessage=function(a,b){var c=this,d,e,f;return J(function(g){switch(g.h){case 1:d=c.o++,1E5<c.o&&(c.o=0),c.j[d]=b,e=10;case 2:if(c.h&&c.frameId&&c.l){g.m(3);break}return y(g,new Promise(function(h){setTimeout(h,100)}),4);case 4:e--;if(0>=e)throw Error("sendMsg: cannot get message handler");pr(c);g.m(2);break;case 3:f={nativecallid:c.h,napaframeid:c.frameId,id:d,dinfo:c.D,message:a},c.l.postMessage(JSON.stringify(f)),a&&"messaging"==a.recipient&&"unitTest"==a.type&&K.warn("front-send: "+
c.h+" "+c.frameId+" "+d+" "+a.num),A(g)}})};
function nr(a,b){var c,d,e,f,g,h;J(function(l){switch(l.h){case 1:try{b=JSON.parse(b)}catch(m){return K.error("Invalid JSON message response: "+m),l.return()}if(b.nativecallid!=a.h||b.response&&1==b.response.consoleResponse)return l.return();(c=b.response)&&"messaging"==c.recipient&&"unitTest"==c.type&&K.warn("front-recv: "+b.nativecallid+" "+b.napaframeid+" "+b.id+" "+c.num);if(b.napaframeid==a.frameId){qr(a,b);l.m(0);break}if(!(0<window.frames.length)){l.m(0);break}C(l,4);if(a.Hb){l.m(6);break}return y(l,
rr(a),6);case 6:return d=JSON.stringify(b),d=Oc(d),y(l,crypto.subtle.encrypt({name:"AES-CBC",iv:a.Sh},a.Hb,d),8);case 8:return d=l.j,d=Nc(d),y(l,crypto.subtle.digest("SHA-1",Oc(b.napaframeid)),9);case 9:e=l.j;e=Nc(e);f={recipient:"deledao",frame:e,data:d};for(g=0;g<window.frames.length;g++)window.frames[g].postMessage(f,"*");F(l,0);break;case 4:h=H(l),K.error("Failed to broadcast message: "+h),A(l)}})}
function rr(a){var b,c;return J(function(d){if(1==d.h)return b="2F1C59F6AD0100FB150EC1DB34EB9181",c=a,y(d,crypto.subtle.importKey("raw",Pc("3AA500E5CD06B2F2F69E0F1F1DB47B3B6A374A89C31F1A63788E55FD4717C142"),{name:"AES-CBC"},!1,["encrypt","decrypt"]),2);c.Hb=d.j;a.Sh=Pc(b);A(d)})}
function or(a,b){var c,d,e,f,g,h;J(function(l){switch(l.h){case 1:c=b.data;if("deledao"!=c.recipient){l.m(0);break}if(a.v){l.m(3);break}return y(l,crypto.subtle.digest("SHA-1",Oc(a.frameId)),4);case 4:d=l.j,a.v=Nc(d);case 3:if(c.frame!=a.v){if(0<window.frames.length)for(e=0;e<window.frames.length;e++)window.frames[e].postMessage(c,"*");l.m(0);break}C(l,6);if(a.Hb){l.m(8);break}return y(l,rr(a),8);case 8:return f=Mc(c.data),y(l,crypto.subtle.decrypt({name:"AES-CBC",iv:a.Sh},a.Hb,f),10);case 10:f=l.j;
for(var m=new Uint8Array(f),n="",q=0;q<m.byteLength;q++)n+=String.fromCharCode(m[q]);f=n;f=JSON.parse(f);f.napaframeid!=a.frameId?K.warn("Frame IDs don't match in envelope and payload, attack suspected"):((g=f.response)&&"messaging"==g.recipient&&"unitTest"==g.type&&K.warn("iframe-recv: "+f.nativecallid+" "+f.napaframeid+" "+f.id+" "+g.fy),qr(a,f));F(l,0);break;case 6:h=H(l),K.error("Error decrypting broadcast message: "+h),A(l)}})}
function qr(a,b){var c=b.id;if(c in a.j){if(a.j[c])try{a.j[c](b.response)}catch(d){K.error("Exception inside processCallback: "+d),K.error(d.stack)}delete a.j[c]}else K.warn("Unmatched response: "+JSON.stringify(b))};function sr(){this.tabId=Cc();this.j=this.init()}x(sr,Zj);sr.prototype.ready=function(){var a=this;return J(function(b){return y(b,a.j,0)})};
sr.prototype.init=function(){var a=this,b,c,d,e,f,g,h,l,m;return J(function(n){switch(n.h){case 1:K=window.console;-1!=navigator.userAgent.indexOf("Trident/")&&(Q.Km=!0);a.Oe=tr("server");a.Oe||K.error("dld fatal: cannot find server URL");if(document.URL.startsWith("https://docs.google.com/")&&document.URL.includes("/mobilepresent?"))throw K.log("Bypass due to google slides presentation."),b=Error("Proxy scripts disabled due to google slides presentation."),b.name="WarningOnly",b;if(12!=Q.za){n.m(2);
break}C(n,3,4);c=document.createElement("iframe");c.width=c.height=1;c.src="https://static."+Oa+Q.Mc+"/proxyUtil.html";document.body||(f=document.createElement("body"),d=document.body=f);document.body.appendChild(c);g=new Promise(function(q){window.addEventListener("message",function(u){var r=u.data;u.origin=="https://static."+Oa&&r&&"__dldExtensionDiscovery"==r.type&&q(r.data&&r.data.extFound)})});h=new Promise(function(q,u){setTimeout(function(){u(Error("extension discovery timeout"))},2E3)});return y(n,
Promise.race([g,h]),6);case 6:e=n.j;case 4:va(n);c&&document.body.removeChild(c);d&&d.remove();wa(n,5);break;case 3:l=H(n);K.warn("Deledao proxy: "+l+". Assuming extension is not present.");n.m(4);break;case 5:if(e)throw m=Error("Deledao extension detected. Proxy scripts disabled."),m.name="WarningOnly",m;case 2:a.Kc=a.h(),window==window.top&&Q.features.ra.xc&&Jn().then(function(){var q=document.createElement("iframe");q.width=q.height=1;q.src=a.Oe+"/resources/cloudUtils.html";q.setAttribute("name",
ur);document.body.appendChild(q);a.vq=q}),window!=window.top||Q.sa&&"www.deledao.com"!=location.hostname||Jn().then(function(){var q=document.createElement("img");q.src=a.Oe+"/resources/icon.png";q.width=q.height="16";q.style.position="fixed";q.style.top="0px";q.style.right="0px";q.style.height=q.style.width="16px";q.style.zIndex="100000";q.onclick=function(){window.open((Q.sa?Q.zm:Q.ei)+"/diag.html","_blank")};document.body.appendChild(q)}),A(n)}})};
function tr(a){if(document.currentScript)return document.currentScript.getAttribute(a);for(var b=t(document.scripts),c=b.next();!c.done;c=b.next())if(c=c.value,"__dld-frontend__"==c.id)return c.getAttribute(a)}sr.prototype.h=function(){return new vr(this.Oe,this.tabId)};
sr.prototype.cj=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];c=b.shift();if(0<b.length)for(c||(c=b.shift());0<b.length;){var d=b.shift();if("function"==typeof d)break;else d=void 0}c&&this.Kc.sendMessage(c,d)};
function vr(a,b){this.l=a+"/sendMessage";this.tabId=b;this.h=void 0;if(window.dldSysFetch)var c=window.dldSysFetch;else K.error("dldSysFetch not found. Using window.fetch instead"),c=window.fetch;this.fetch=function(d){for(var e=[],f=0;f<arguments.length;++f)e[f]=arguments[f];return c.apply(null,ca(e))}}
vr.prototype.sendMessage=function(a,b){var c=this,d,e,f,g,h;return J(function(l){switch(l.h){case 1:return a&&"messaging"==a.recipient&&"unitTest"==a.type&&K.warn("front-send: "+a.num),d={method:"POST",body:JSON.stringify({version:Q.sb,envelope:{tabId:c.tabId},message:a})},C(l,2),Q.Km?y(l,new Promise(function(m,n){var q=new XMLHttpRequest;q.open("POST",c.l);q.onload=function(){200!=q.status?n(q.statusText||"sendMessage: "+q.status):m(q.responseText)};q.onerror=function(u){n("sendMessage error: "+
u)};q.ontimeout=function(){n("sendMessage timeout")};q.send(d.body)}),6):y(l,c.fetch(c.l,d),7);case 6:f=l.j;e=JSON.parse(f);l.m(5);break;case 7:return g=l.j,y(l,g.json(),8);case 8:e=l.j;case 5:F(l,3);break;case 2:throw h=H(l),wr(c),h;case 3:c.j(e,b),A(l)}})};
vr.prototype.j=function(a,b){if(a){if(a.error)throw K.error("sendMessage: "+a.error),a=a.error,a.startsWith("proxy version mismatch:")&&wr(this),Error(a);a=a.response;this.h=void 0}a&&"messaging"==a.recipient&&"unitTest"==a.type&&K.warn("front-recv: "+a.num);b&&b(a)};function wr(a){var b=Date.now();a.h?(b-=a.h,6E4<b?(a.h=void 0,location.reload()):K.error("dld: will attempt to reconnect in "+Math.round((6E4-b)/1E3)+" seconds")):a.h=b}
function xr(){var a=Va.Oe,b=this;this.id=Va.tabId;try{var c=new URL(a);c.protocol="wss:";c.pathname="/tab";this.j=c.toString()}catch(d){K.error("TabManager: "+d);return}this.connect();Jn().then(function(){yr(b,"domLoaded")});window.addEventListener("focus",function(){b.fa.send(JSON.stringify({type:"activated",data:{id:b.id}}))});Ta.addListener(function(d){"pageUrlTitleChanged"==d.type&&yr(b,"urlChanged")},["pageUrlTitleChanged"]);setInterval(function(){yr(b,"timer")},6E4)}
xr.prototype.connect=function(){var a=this,b,c;return J(function(d){switch(d.h){case 1:if(a.h)return d.return();a.h=!0;C(d,2,3);b=1E3;case 5:return C(d,7),a.fa=new WebSocket(a.j),y(d,new Promise(function(e,f){a.fa.onopen=function(){"loading"!=document.readyState&&yr(a,"wsopen");e()};a.fa.onerror=function(){return J(function(g){if(1==g.h)return a.fa.close(),y(g,new Promise(function(h){setTimeout(h,500)}),2);f();A(g)})}}),9);case 9:a.fa.onclose=function(){return J(function(e){if(1==e.h)return K.error("ws disconnected, reconnecting ..."),
y(e,new Promise(function(f){setTimeout(f,500)}),2);a.connect();A(e)})};a.fa.onmessage=function(e){a.onMessage(e)};d.m(3);break;case 7:return H(d,2),K.warn("cannot connect to ws, retry after "+b+"ms"),y(d,new Promise(function(e){setTimeout(e,b)}),10);case 10:b=Math.min(2*b,2E4);d.m(5);break;case 3:va(d);a.h=!1;wa(d,0);break;case 2:c=H(d),K.error("ws connect unexpected error: "+c),d.m(3)}})};
function yr(a,b){if(1!=a.fa.readyState)K.warn("Cannot send tab info: web socket not open yet");else{for(var c,d=t(document.getElementsByTagName("link")),e=d.next();!e.done;e=d.next())if(e=e.value,"icon"==e.getAttribute("rel")){c=e.getAttribute("href");break}try{c||(c=(new URL("/favicon.ico",document.URL)).href)}catch(f){}a.fa.send(JSON.stringify({type:"tabInfo",data:{id:a.id,url:document.URL,title:document.title,active:document.hasFocus(),favIconUrl:c,Sy:b}}))}}
xr.prototype.onMessage=function(a){var b=this;return J(function(c){if(1==c.h){a=JSON.parse(a.data);if("close"!=a.type){if("focus"==a.type)window.focus();else if("replace"==a.type)location.replace(a.data.url);else if("create"==a.type)window.open(a.data.url,"_blank")||window.open(a.data.url,"_self");else if("alert"==a.type)alert(a.data.text);else if("setLockDown"===a.type)zr(a.data);else if("showNotification"===a.type)Ar(b,a.data);else if("getActivePage"===a.type)try{b.fa.send(JSON.stringify({type:"proxyFrontendMessage",
Qg:{recipient:"teacher",type:"getActivePageResponse",data:fp(ep)}}))}catch(d){K.error("Unable to get active page data, error: ",d)}else a.nn&&Ta.sendMessage(a);return c.m(0)}window.close();document.open();document.write("<h1>This webpage has been closed by your teacher</h1>");document.close();return y(c,new Promise(function(d){setTimeout(d,2E3)}),3)}location.replace("about:blank");A(c)})};function zr(a){a.lock?window.open(a.de,"_self"):a.de===window.location.href&&history.back()}
function Ar(a,b){a.l||(a.l=new Yq);Zq(b.text)};function Br(){sr.apply(this,arguments)}x(Br,sr);Br.prototype.init=function(){var a=this;return J(function(b){if(1==b.h)return y(b,sr.prototype.init.call(a),2);window==window.top&&Jn().then(function(){try{var c=new URL(document.URL);if(c.searchParams){var d=c.searchParams.get("__dld_auth__");d&&d==tr("sid")&&(c.searchParams.delete("__dld_auth__"),history.replaceState(null,null,c.href))}}catch(e){}});["iphone","ipad"].includes(Rc(navigator.userAgent).system)&&(K={log:tn,warn:vn,error:Wa});A(b)})};
Br.prototype.h=function(){return new Cr(this.Oe,tr("sid"))};var ur="__dld_utils";function Cr(a,b){vr.call(this,a);this.debug=!Q.sa;this.o=a+"/auth";this.ui=b;this.debug&&K.log("[CloudFrontend.Messaging] Constructor. document.URL="+document.URL+", authUrl="+this.o+", sesToken="+b+".");this.ui||(K.warn("No session token found in tag. Forcing login ..."),Dr(this))}x(Cr,vr);function Dr(a){a=a.o+"?site="+encodeURIComponent(document.URL);location.replace(a)}
Cr.prototype.sendMessage=function(a,b){var c=this,d;return J(function(e){if(1==e.h){if(!c.ui)throw c.v||(c.v=!0,K.error("[CloudFrontend.Messaging] No session token found in script tag.")),Error("No session token");C(e,2);a.sesToken=c.ui;c.trace&&K.log("[CloudFrontend.Messaging] Send message.",JSON.stringify(a));return y(e,vr.prototype.sendMessage.call(c,a,b),4)}if(2!=e.h)return F(e,0);d=H(e);K.error("[CloudFrontend.Messaging] Send message error: "+d);A(e)})};
Cr.prototype.j=function(a,b){var c=a.error;c&&c.startsWith("reauthenticate: ")?(this.debug&&K.log("[CloudFrontend.Messaging] Reauthenticate by response. err="+c+"."),Dr(this)):(a.sesToken&&(this.ui=a.sesToken),this.trace&&K.log("[CloudFrontend.Messaging] Process response.",JSON.stringify(a)),vr.prototype.j.call(this,a,b))};function Er(a){a&&a.ng?!0===a.ng.Bh&&new Uq(a.ng.lr):new Uq}
Q.Cg("__dld_fi",function(a){var b,c,d,e,f,g,h,l,m,n,q,u;return J(function(r){if(1==r.h){C(r,2);Q.Jg(a);Q.ce=!0;switch(Q.platform){case 12:Va=new dk;break;case 33:Va=new kr;break;case 99:Va=new sr;break;case 88:Va=new Br;break;default:throw Error("dld: No supported frontend for this platform");}return y(r,Va.ready(),4)}if(2!=r.h){new Ua;Q.sa?K.log("frontInit begin."):K.log("frontInit begin.",document.URL);Ta=new Ra;12==Q.platform&&chrome.runtime.onMessage.addListener(function(p){p.nn&&Ta.sendMessage(p)});
Q.features.La.enabled&&99==Q.platform&&window==window.top&&new xr;88==Q.platform&&(c=function(){var p,v,w,z,B,D;return J(function(E){switch(E.h){case 1:return p=!1,v=void 0,C(E,4),y(E,ne(),6);case 6:v=E.j;if(b)if(v.length!=b.length)p=!0;else for(w=t(v),z=w.next();!z.done;z=w.next()){if(B=z.value,-1==b.indexOf(B)){p=!0;break}}else p=!0;b=v;F(E,5);break;case 4:H(E),b=[];case 5:return p&&(D={recipient:"runtime",type:"deviceInfo",data:{ba:b,userAgent:navigator.userAgent}},Z(null,D)),y(E,new Promise(function(G){setTimeout(G,
3E5)}),1)}})},c());window==window.top&&(po=new oo);d=new Promise(function(p){Z(null,{recipient:"backend",type:"getConfig",data:{url:document.URL,isMainFrame:window==window.top,referrer:document.referrer,ancestor:document.location.ancestorOrigins&&document.location.ancestorOrigins[0]}},null,function(v){p(v)})});e=new Promise(function(p){Z(null,{recipient:"backend",type:"getGlobalSettings"},null,function(v){p(v)})});try{new so}catch(p){K.error("Filter: "+p),K.error(p.stack)}try{Mn=new Cn}catch(p){K.error("DynUtils: "+
p),K.error(p.stack)}f=window==window.top?po.Ch:Jn();g=new Promise(function(p,v){setTimeout(function(){v(Error("page load or auth timed out"))},1E4)});Promise.race([f,g]).catch(function(p){Wa("all frames init: "+p+", top frame: "+(window==window.top)+", url: "+location.href)});(Tc(location.hostname)||Uc())&&Jn().then(function(){try{d.then(function(p){new uo(p.ytf)})}catch(p){K.error("YT error: "+p),K.error(p.stack)}});f.then(function(){try{d.then(function(p){if(p=p.dta){try{for(var v=(new URL(document.URL)).hostname,
w=t(p.jc),z=w.next();!z.done;z=w.next()){var B=z.value;if(v==B||v.endsWith("."+B)){p.enabled=!1;break}}}catch(D){}ep=new Yo(p)}})}catch(p){K.error("DynTA error: "+p),K.error(p.stack)}if(!Q.Km){try{d.then(function(p){if(p=p.dia){try{for(var v=(new URL(document.URL)).hostname,w=t(p.jc),z=w.next();!z.done;z=w.next())if(v.endsWith("."+z.value)){p.enabled=!1;break}if(p.ug){v={};for(var B=t(p.ug.split(";")),D=B.next();!D.done;D=B.next()){var E=D.value.split("=");v[E[0]]=E[1]}p.ug=v}}catch(G){}new sp(p)}})}catch(p){K.error("DynIA error: "+
p),K.error(p.stack)}try{d.then(function(p){if(p=p.dva)p=U(pb,p),p.enabled&&new Pp(p)})}catch(p){K.error("DynVA error: "+p),K.error(p.stack)}try{d.then(function(p){if(p=p.dab){p=U(nb,p);try{for(var v=(new URL(document.URL)).hostname,w=t(p.jc),z=w.next();!z.done;z=w.next())if(v.endsWith("."+z.value)){p.enabled=!1;break}}catch(D){}if("undefined"!==typeof jp&&(kp=new jp(p),p.enabled&&p.Dr)){var B=null;window==window.top&&document.URL.startsWith("https://mail.google.com/")?B=new Gq(p):window==window.top&&
(document.URL.startsWith("https://outlook.office.com/mail")||document.URL.startsWith("https://outlook.live.com/mail"))?B=new Jq(p):B=new Dq(p);B&&(new MutationObserver(function(D){B.o(D)})).observe(document,{childList:!0,subtree:!0})}}})}catch(p){K.error("DynAB error: "+p),K.error(p.stack)}if(Q.features.La.enabled)try{d.then(function(p){(p=p.clm)&&new Nq(p)})}catch(p){K.error("Classroom error: "+p),K.error(p.stack)}}try{d.then(function(p){(p=p.cbl)&&p.enabled&&new dr})}catch(p){K.error("Privacy error: "+
p),K.error(p.stack)}});try{d.then(function(p){if(p=p.dgm){try{for(var v=(new URL(document.URL)).hostname,w=t(p.jc),z=w.next();!z.done;z=w.next()){var B=z.value;if(v==B||v.endsWith("."+B)){p.enabled=!1;break}}if(document.URL.startsWith("https://google.com/maps/")||document.URL.startsWith("https://www.google.com/maps/"))p.enabled=!1}catch(D){}p.enabled&&new Kq(p)}})}catch(p){K.error("DynGames error: "+p),K.error(p.stack)}if(window===window.top){try{if(location.href===Q.wo()&&e.then(function(p){Er(p)}).catch(function(p){K.log("err: ",
p);Er()}),location.href.toLowerCase().startsWith(Q.Fa+"/homeblock.html")&&new qo,d.then(function(p){if(window.location.href.startsWith(Q.Fa+Q.rl)||window.location.href.startsWith(Q.kf+Q.rl)||p&&p.cbp&&window.location.href.startsWith(p.cbp))K.log("initUnblockRequest"),p=new URL(window.location.href),"true"===(new URLSearchParams(p.search)).get("liveClass")?new Xq:new Wq,new Vq;try{new Yq}catch(v){K.error("Initialize html modal error: ",v),K.error(v.stack)}}),Q.wa&&(h=Q.zm+"/diag.html",l=Q.zm+"/diagFam.html",
m=Q.ei+"/diag.html",n=Q.ei+"/diagFam.html",document.URL==h||document.URL==l||document.URL==m||document.URL==n))Q.sa||(document.URL==h?window.location.replace(m):document.URL==l&&window.location.replace(n)),Jn().then(function(){99===Q.za?new hr:new er})}catch(p){K.error("CScripts error: "+p),K.error(p.stack)}try{d.then(function(p){(p=p.act)&&new Bo(p)})}catch(p){K.error("UserActs error: "+p),K.error(p.stack)}po.Ch.then(function(){try{d.then(function(p){if(p=p.dsf)document.URL.startsWith(p.page)&&new Xo,
Qo=p.Bk})}catch(p){K.error("D Discover error: "+p),K.error(p.stack)}if(!Q.Km){if(!Q.wa)try{chrome.runtime.onMessage.addListener(function(p){"debugFrame"==p.recipient&&"downloadObject"==p.type&&Oo(p.data.name,p.data.object)})}catch(p){K.error("DF download error: "+p),K.error(p.stack)}if(!Q.wa)try{new cr}catch(p){K.error("CookeieStats error: "+p),K.error(p.stack)}}})}return F(r,0)}q=H(r);"WarningOnly"==q.name?K.warn(q.message):(u=window.console,u.error("Error during front end load: "+q),u.error(q.stack),
console!=u&&(K.error("Error during front end load: "+q),K.error(q.stack)));A(r)})});}).call(this);
